import{d as D,a as j,p as A,I as T,D as J,x as f,H as z,n as R,u as q,i as l,c as s,S as w,M as o,J as d,F as v,g as k,f as c,h as B,j as G,t as u}from"./index-BRgDPfrs.js";const K=(r=1)=>()=>{var t=Math.sin(r++)*1e4;return t-Math.floor(t)},P=K();function Q(r,t=P){return Math.floor(t()*r)}function S(r){return r[Q(r.length)]}var C=u("<div class=chesstree>"),y=u("<div class=lines>"),E=u("<div class=line>"),U=u("<span class=index>"),V=u("<div>"),X=u("<span class=nag>"),Y=u("<div class=inline>"),Z=u("<span class=collapsed> ..<!> ");const I=r=>{let t=[];for(let e of r)t.length===0?t.push([e]):t.push([...t[t.length-1],e]);return t};class x{static set_for_saving(t){let e=new x;return e.paths=t,e}_paths;get paths(){return this._paths[0]()}set paths(t){this._paths[1](t)}constructor(){this._paths=j([],{equals:!1})}get clone(){let t=new x;return t.paths=this.paths.slice(0),t}get_for_saving(){return this.paths}merge_dup(t){t.paths.forEach(e=>A(()=>this.add_path(e)))}replace_all(t){this.paths=t.paths.slice(0)}add_path(t){let e=this.paths;e.find(a=>a.join("")===t.join(""))||(e.push(t),this.paths=e)}remove_path(t){this.paths=this.paths.filter(e=>e.join("")!==t.join(""))}clear(){this.paths=[]}}class H{constructor(t,e){this.initial_fen=t,this._cursor_path=j([],{equals:!1}),this._tree=j(e),this._hidden_paths=new x,this._revealed_paths=j([],{equals:!1}),this._failed_paths=j([],{equals:!1}),this._solved_paths=new x}static make=(t,e=t?.before_fen||T)=>new H(e,t);_tree;_cursor_path;_hidden_paths;_revealed_paths;_failed_paths;_solved_paths;get cursor_after_color(){let t=this.cursor_path;return J(this.tree?.get_at(t)?.after_fen??T)}get is_cursor_path_at_a_leaf(){let t=this.cursor_path;return this.failed_paths.find(e=>e.join("")===t.join(""))?!1:this.tree?.get_children(t)?.length===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.paths}get initial_color(){return this.tree?.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let a=e.after_fen,h=e.uci;return[a,h]}}collect_branch_sums(t){if(!this.tree)return[];let e=[],a=this.tree.root,h=a.length>1;for(let n of t){let i=a.find(m=>m.data.uci===n);if(!i)return;h&&(e.push(i.data),h=!1),i.children.filter(m=>!this.failed_paths.some(W=>W.join("")===m.data.path.join(""))).length>1&&(h=!0),a=i.children}return e}clear_failed_paths(){f(()=>{this.failed_paths.forEach(t=>{this.tree?.delete_at(t)}),this.failed_paths=[]})}try_set_cursor_path(t){return this.hidden_paths.find(a=>t.join("").startsWith(a.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let t=S(this.tree.all_leaves.map(h=>h.path)),e=S(I(t).slice(1,-1));this.solved_paths.paths.find(h=>h.join("")===e.join(""))&&(e=S(I(t).slice(1,-1))),this.cursor_path=e;let a=this.tree.get_children(e);this._hidden_paths.clear(),a?.forEach(h=>this._hidden_paths.add_path(h.path))}reveal_hidden_paths=()=>{f(()=>{this.hidden_paths.forEach(t=>{this.revealed_paths.push(t)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})};add_and_reveal_uci(t){this.revealed_paths.push(this.add_uci(t)),this.revealed_paths=this.revealed_paths}reveal_one_random=()=>{if(!this.tree)return!1;const t=this.tree?._traverse_path(this.cursor_path)?.children??this.tree.root,e=rt(t);return e?(f(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this.cursor_path=e.data.path}),!0):!1};try_next_uci_fail=t=>{if(!this.tree)return!1;const e=this.tree?._traverse_path(this.cursor_path),a=this.tree?._traverse_path(this.cursor_path)?.children??this.tree.root,h=a.find(n=>n.data.uci===t)??a.find(n=>ht(n.data)===t);if(h)return this.failed_paths.find(i=>i.join("")===h.data.path.join(""))?(this.cursor_path=h.data.path,!1):(f(()=>{this._hidden_paths.remove_path(h.data.path),h.children.forEach(i=>this._hidden_paths.add_path(i.data.path)),this._solved_paths.add_path(h.data.path),this.cursor_path=h.data.path}),!0);if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.add_failed_path([...e?.data.path??[],t]),!1};add_failed_path(t){let e=this.failed_paths;e=e.filter(a=>a.join("")!==t.join("")),e.push(t),this.failed_paths=e}on_wheel=t=>{let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let a=this.tree;if(a){let h;e.length===0?h=a.root:h=a._traverse_path(e)?.children;let n=h?.map(i=>i.data.path).find(i=>!this.hidden_paths?.some(p=>i.join("").startsWith(p.join(""))));n&&this.try_set_cursor_path(n)}}};add_uci(t){let e=this.tree,a=this.cursor_path;return e?e.append_uci(t,a):e=z.make(this.initial_fen,[[t]]),a=[...a,t],f(()=>{this.tree=e,this.cursor_path=a}),a}drop_failed_paths(){return f(()=>{let t=this.failed_paths;t.forEach(a=>this.tree?.delete_at(a));let e=this.cursor_path;for(;e.length>0&&!this.tree?.get_at(e);)e.pop();return this.cursor_path=e,this.failed_paths=[],t})}get can_navigate_next(){let t=this.cursor_path,e=this.tree;if(e){let a;return t.length===0?a=e.root:a=e._traverse_path(t)?.children,a?.map(n=>n.data.path).find(n=>!this.hidden_paths?.some(i=>n.join("").startsWith(i.join(""))))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_first(){let t=I(this.cursor_path).reverse().slice(1),e=(t.find(a=>(this.tree.get_children(a.slice(0,-1))?.length??0)>1)||t[t.length-1])??[];this.try_set_cursor_path(e)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){let t=this.cursor_path,e=this.tree;if(e){let a;t.length===0?a=e.root:a=e._traverse_path(t)?.children;let h=a?.map(n=>n.data.path).find(n=>!this.hidden_paths?.some(i=>n.join("").startsWith(i.join(""))));h&&this.try_set_cursor_path(h)}}navigate_last(){let t=this.cursor_path,e=this.tree;if(e){let a;t.length===0?a=e.root:a=e._traverse_path(t)?.children;let h=a?.map(n=>n.data.path).find(n=>!this.hidden_paths?.some(i=>n.join("").startsWith(i.join(""))));if(h){let n=e._traverse_path(h);for(;n.children.length===1&&!this.hidden_paths?.some(i=>n.children[0].data.path.join("").startsWith(i.join("")));)n=n.children[0];h=n.data.path,this.try_set_cursor_path(h)}}}get can_navigate_up(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const h=e._traverse_path(a.slice(0,-1))?.children??e.root;if(h&&h.length>1)return h?.findIndex(i=>i.data.path.join("")===a.join(""))-1>=0;a=a.slice(0,-1)}}return!1}get can_navigate_down(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const h=e._traverse_path(a.slice(0,-1))?.children??e.root;if(h&&h.length>1)return h?.findIndex(i=>i.data.path.join("")===a.join(""))+1<h.length;a=a.slice(0,-1)}}}navigate_up(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const h=e._traverse_path(a.slice(0,-1))?.children??e.root;if(h&&h.length>1){let n=h?.findIndex(i=>i.data.path.join("")===a.join(""))-1;this.cursor_path=h[n].data.path;break}a=a.slice(0,-1)}}}navigate_down(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const h=e._traverse_path(a.slice(0,-1))?.children??e.root;if(h&&h.length>1){let n=h?.findIndex(i=>i.data.path.join("")===a.join(""))+1;this.cursor_path=h[n].data.path;break}a=a.slice(0,-1)}}}}const st=r=>{let t;return R(()=>{let e=r.lala.cursor_path,a=t.parentElement;if(!a)return;const h=t.querySelector(".on_path_end");if(!h){a.scrollTop=e.length>0?99999:0;return}let n=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:n})}),(()=>{var e=C();return q(a=>t=a,e),l(e,s(w,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>s(b,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return a().root}})})),e})()},b=r=>s(k,{get children(){return[s(o,{get when(){return r.lines.length===1},get children(){return[s($,d({get data(){return r.lines[0].data}},r)),s(b,d(r,{get lines(){return r.lines[0].children}}))]}}),s(o,{get when(){return r.lines.length>1},get children(){var t=y();return l(t,s(v,{get each(){return r.lines},children:e=>(()=>{var a=E();return l(a,s($,d({get data(){return e.data}},r)),null),l(a,s(k,{get children(){return[s(o,{get when(){return e.children.length===1},get children(){return s(b,d(r,{get lines(){return e.children}}))}}),s(o,{get when(){return e.children.length>1},get children(){var h=y();return l(h,s(v,{get each(){return e.children},children:n=>(()=>{var i=E();return l(i,s(b,d(r,{lines:[n],show_index:!0}))),i})()})),h}})]}}),null),a})()})),t}})]}}),$=r=>{let t=["","good","mistake","best","blunder","interesting","dubious"],e=`${Math.ceil(r.data.ply/2)}.`;r.data.ply%2===0&&(e+="..");let a=c(()=>r.cursor_path.join("").startsWith(r.data.path.join(""))),h=c(()=>r.cursor_path.join("")===r.data.path.join("")),n=c(()=>r.data.path.join("")),i=c(()=>r.hidden_paths.find(_=>_.join("")===n())),p=c(()=>r.hidden_paths.find(_=>n().startsWith(_.join("")))),m=c(()=>r.revealed_paths.find(_=>_.join("")===n())),W=c(()=>r.failed_paths.find(_=>_.join("")===n())),L=c(()=>r.solved_paths.find(_=>_.join("")===n())),N=c(()=>t[r.data.nags?.[0]??0]),F=c(()=>["move",N(),h()?"on_path_end":a()?"on_path":"",i()?"on_hidden_path_start":p()?"on_hidden_path":"",m()?"on_revealed_path":"",W()?"on_failed_path":"",L()?"on_solved_path":"",r.collapsed?"collapsed":""].join(" "));return(()=>{var _=V();return _.$$click=()=>r.on_set_path(r.data.path),l(_,s(w,{get when(){return r.show_index||r.data.ply&1},get children(){var M=U();return l(M,e),M}}),null),l(_,()=>r.data.san,null),l(_,s(tt,{get nags(){return r.data.nags??[]}}),null),B(()=>G(_,F())),_})()};let O=["","!","?","!!","??","!?","?!"];O[22]="⨀";const tt=r=>[" ",(()=>{var t=X();return l(t,()=>O[r.nags[0]]),t})()," "],it=r=>{let t;return R(()=>{let e=r.lala.cursor_path,a=t.parentElement;if(!a)return;const h=t.querySelector(".on_path_end");if(!h){a.scrollTop=e.length>0?99999:0;return}let n=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:n})}),(()=>{var e=C();return q(a=>t=a,e),l(e,s(w,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>s(k,{get children(){return[s(o,{get when(){return a().root.length===1},get children(){return s(g,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return a().root}})}}),s(o,{get when(){return a().root.length>1},get children(){var h=y();return l(h,s(v,{get each(){return a().root},children:n=>(()=>{var i=E();return l(i,s(g,{on_set_path:p=>r.lala.try_set_cursor_path(p),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},lines:[n]})),i})()})),h}})]}})})),e})()},et=r=>{let t=0;for(;r!==void 0;)if(r.children.length>1||(r=r.children[0],t++>5))return!1;return!0},g=r=>{let t=r.hide_data;return r.hide_data=void 0,s(v,{get each(){return r.lines},children:e=>[s(w,{when:!t,get children(){return s($,d({get data(){return e.data}},r))}}),s(k,{get children(){return[s(o,{get when(){return e.children.length===1},get children(){return s(g,d(r,{get lines(){return e.children},show_index:!1}))}}),s(o,{get when(){return c(()=>e.children.length===2)()&&et(e.children[1])},get children(){return[s($,d({get data(){return e.children[0].data}},r,{show_index:!1})),(()=>{var a=Y();return l(a,s(g,d(r,{get lines(){return[e.children[1]]},show_index:!0}))),a})(),s(g,d(r,{get lines(){return[e.children[0]]},hide_data:!0}))]}}),s(o,{get when(){return e.children.length>1},get children(){var a=y();return l(a,s(v,{get each(){return e.children},children:h=>(()=>{var n=E();return l(n,s(w,{get when(){return r.cursor_path.join("").startsWith(h.data.path.join(""))},get fallback(){return s(at,d(r,{lines:[h],show_index:!0}))},get children(){return s(g,d(r,{lines:[h],show_index:!0}))}})),n})()})),a}})]}})]})},at=r=>s(v,{get each(){return r.lines},children:t=>[s($,d({get data(){return t.data}},r,{collapsed:!0})),(()=>{var e=Z(),a=e.firstChild,h=a.nextSibling;return h.nextSibling,l(e,()=>t.length,h),l(e,()=>t.nb_first_variations,null),e})()]});function rt(r){const t=r.map((n,i)=>1/(i+r.length)),e=t.reduce((n,i)=>n+i,0),a=Math.random()*e;let h=0;for(let n=0;n<r.length;n++)if(h+=t[n],a<h)return r[n]}const ht=r=>{let t=r.uci.slice(0,2),e=r.uci[3];if(r.san==="O-O")return t+"g"+e;if(r.san==="O-O-O")return t+"c"+e};D(["click"]);export{it as C,H as T,x as a,st as b,S as c,O as t};
