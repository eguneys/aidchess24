import{a as B,f as ie,w as Ce,q as pn,m as re,u as hn,t as mn}from"./index-Cgd939wz.js";import{C as Pe,p as Se,d as gn,m as vn,e as bn,g as wn,I as Te}from"./chess_pgn_logic-B_wJ-b6P.js";class Ee{static init=()=>new Ee;get position(){return this._position[0]()}set position(n){this._position[1](n)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(n){this._promotion[1](n)}get add_uci(){return this._add_uci[0]()}set add_uci(n){this._add_uci[1](n)}get last_move(){return this._last_move[0]()}set last_move(n){this._last_move[1](n)}_add_uci;_promotion;_position;m_fen;m_dests;m_color;_last_move;constructor(){this._on_wheel=B(void 0,{equals:!1}),this._last_move=B(void 0,{equals:!1}),this._add_uci=B(void 0,{equals:!1}),this._promotion=B(void 0,{equals:!1}),this._position=B(Pe.fromSetup(Se(Te).unwrap()).unwrap(),{equals:!1}),this.m_dests=ie(()=>gn(this.position)),this.m_fen=ie(()=>vn(this.position.toSetup())),this.m_color=ie(()=>this.position.turn)}_on_wheel;set_on_wheel=n=>{this._on_wheel[1](n)};get on_wheel(){return this._on_wheel[0]()}on_set_fen_uci=(n,o)=>{Ce(()=>{this.add_uci=void 0,this.last_move=o,this.position=Pe.fromSetup(Se(n).unwrap()).unwrap()})};reset_move_after=()=>{this.position=this.position};on_move_after=(n,o)=>{let i=this.position.board.get(bn(n)),r=n+o;i.role==="pawn"&&(o[1]==="8"&&this.turnColor==="white"||o[1]==="1"&&this.turnColor==="black")&&(r+="q"),this.position.play(wn(r)),Ce(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=o),this.add_uci=r})};get fen_uci(){let n=this.fen,o=this.last_move;return[n,o]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}}const yn=["white","black"],U=["a","b","c","d","e","f","g","h"],X=["1","2","3","4","5","6","7","8"],kn=[...X].reverse(),pe=Array.prototype.concat(...U.map(e=>X.map(n=>e+n))),P=e=>pe[8*e[0]+e[1]],g=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Ne=pe.map(g);function Cn(e){let n;const o=()=>(n===void 0&&(n=e()),n);return o.clear=()=>{n=void 0},o}const Pn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const n=performance.now()-e;return e=void 0,n}}},he=e=>e==="white"?"black":"white",F=(e,n)=>{const o=e[0]-n[0],i=e[1]-n[1];return o*o+i*i},ae=(e,n)=>e.role===n.role&&e.color===n.color,V=e=>(n,o)=>[(o?n[0]:7-n[0])*e.width/8,(o?7-n[1]:n[1])*e.height/8],D=(e,n)=>{e.style.transform=`translate(${n[0]}px,${n[1]}px)`},We=(e,n,o=1)=>{e.style.transform=`translate(${n[0]}px,${n[1]}px) scale(${o})`},me=(e,n)=>{e.style.visibility=n?"visible":"hidden"},L=e=>{var n;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((n=e.targetTouches)===null||n===void 0)&&n[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Le=e=>e.button===2,O=(e,n)=>{const o=document.createElement(e);return n&&(o.className=n),o};function He(e,n,o){const i=g(e);return n||(i[0]=7-i[0],i[1]=7-i[1]),[o.left+o.width*i[0]/8+o.width/16,o.top+o.height*(7-i[1])/8+o.height/16]}const W=(e,n)=>Math.abs(e-n),Sn=e=>(n,o,i,r)=>W(n,i)<2&&(e==="white"?r===o+1||o<=1&&r===o+2&&n===i:r===o-1||o>=6&&r===o-2&&n===i),ze=(e,n,o,i)=>{const r=W(e,o),t=W(n,i);return r===1&&t===2||r===2&&t===1},Re=(e,n,o,i)=>W(e,o)===W(n,i),Be=(e,n,o,i)=>e===o||n===i,Ie=(e,n,o,i)=>Re(e,n,o,i)||Be(e,n,o,i),_n=(e,n,o)=>(i,r,t,l)=>W(i,t)<2&&W(r,l)<2||o&&r===l&&r===(e==="white"?0:7)&&(i===4&&(t===2&&n.includes(0)||t===6&&n.includes(7))||n.includes(t));function Mn(e,n){const o=n==="white"?"1":"8",i=[];for(const[r,t]of e)r[1]===o&&t.color===n&&t.role==="rook"&&i.push(g(r)[0]);return i}function je(e,n,o){const i=e.get(n);if(!i)return[];const r=g(n),t=i.role,l=t==="pawn"?Sn(i.color):t==="knight"?ze:t==="bishop"?Re:t==="rook"?Be:t==="queen"?Ie:_n(i.color,Mn(e,i.color),o);return Ne.filter(s=>(r[0]!==s[0]||r[1]!==s[1])&&l(r[0],r[1],s[0],s[1])).map(P)}function y(e,...n){e&&setTimeout(()=>e(...n),1)}function xn(e){e.orientation=he(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function qn(e,n){for(const[o,i]of n)i?e.pieces.set(o,i):e.pieces.delete(o)}function An(e,n){if(e.check=void 0,n===!0&&(n=e.turnColor),n)for(const[o,i]of e.pieces)i.role==="king"&&i.color===n&&(e.check=o)}function Dn(e,n,o,i){E(e),e.premovable.current=[n,o],y(e.premovable.events.set,n,o,i)}function T(e){e.premovable.current&&(e.premovable.current=void 0,y(e.premovable.events.unset))}function $n(e,n,o){T(e),e.predroppable.current={role:n,key:o},y(e.predroppable.events.set,n,o)}function E(e){const n=e.predroppable;n.current&&(n.current=void 0,y(n.events.unset))}function On(e,n,o){if(!e.autoCastle)return!1;const i=e.pieces.get(n);if(!i||i.role!=="king")return!1;const r=g(n),t=g(o);if(r[1]!==0&&r[1]!==7||r[1]!==t[1])return!1;r[0]===4&&!e.pieces.has(o)&&(t[0]===6?o=P([7,t[1]]):t[0]===2&&(o=P([0,t[1]])));const l=e.pieces.get(o);return!l||l.color!==i.color||l.role!=="rook"?!1:(e.pieces.delete(n),e.pieces.delete(o),r[0]<t[0]?(e.pieces.set(P([6,t[1]]),i),e.pieces.set(P([5,t[1]]),l)):(e.pieces.set(P([2,t[1]]),i),e.pieces.set(P([3,t[1]]),l)),!0)}function Fe(e,n,o){const i=e.pieces.get(n),r=e.pieces.get(o);if(n===o||!i)return!1;const t=r&&r.color!==i.color?r:void 0;return o===e.selected&&S(e),y(e.events.move,n,o,t),On(e,n,o)||(e.pieces.set(o,i),e.pieces.delete(n)),e.lastMove=[n,o],e.check=void 0,y(e.events.change),t||!0}function ge(e,n,o,i){if(e.pieces.has(o))if(i)e.pieces.delete(o);else return!1;return y(e.events.dropNewPiece,n,o),e.pieces.set(o,n),e.lastMove=[o],e.check=void 0,y(e.events.change),e.movable.dests=void 0,e.turnColor=he(e.turnColor),!0}function Ve(e,n,o){const i=Fe(e,n,o);return i&&(e.movable.dests=void 0,e.turnColor=he(e.turnColor),e.animation.current=void 0),i}function Ze(e,n,o){if(ve(e,n,o)){const i=Ve(e,n,o);if(i){const r=e.hold.stop();S(e);const t={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(t.captured=i),y(e.movable.events.after,n,o,t),!0}}else if(Tn(e,n,o))return Dn(e,n,o,{ctrlKey:e.stats.ctrlKey}),S(e),!0;return S(e),!1}function Ge(e,n,o,i){const r=e.pieces.get(n);r&&(Kn(e,n,o)||i)?(e.pieces.delete(n),ge(e,r,o,i),y(e.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&En(e,n,o)?$n(e,r.role,o):(T(e),E(e)),e.pieces.delete(n),S(e)}function de(e,n,o){if(y(e.events.select,n),e.selected){if(e.selected===n&&!e.draggable.enabled){S(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==n&&Ze(e,e.selected,n)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Xe(e,n)||be(e,n))&&(Ue(e,n),e.hold.start())}function Ue(e,n){e.selected=n,be(e,n)?e.premovable.customDests||(e.premovable.dests=je(e.pieces,n,e.premovable.castle)):e.premovable.dests=void 0}function S(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Xe(e,n){const o=e.pieces.get(n);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}const ve=(e,n,o)=>{var i,r;return n!==o&&Xe(e,n)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(n))===null||r===void 0)&&r.includes(o)))};function Kn(e,n,o){const i=e.pieces.get(n);return!!i&&(n===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function be(e,n){const o=e.pieces.get(n);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function Tn(e,n,o){var i,r;const t=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(n))!==null&&r!==void 0?r:je(e.pieces,n,e.premovable.castle);return n!==o&&be(e,n)&&t.includes(o)}function En(e,n,o){const i=e.pieces.get(n),r=e.pieces.get(o);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function Nn(e,n){const o=e.pieces.get(n);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function Wn(e){const n=e.premovable.current;if(!n)return!1;const o=n[0],i=n[1];let r=!1;if(ve(e,o,i)){const t=Ve(e,o,i);if(t){const l={premove:!0};t!==!0&&(l.captured=t),y(e.movable.events.after,o,i,l),r=!0}}return T(e),r}function Ln(e,n){const o=e.predroppable.current;let i=!1;if(!o)return!1;if(n(o)){const r={role:o.role,color:e.movable.color};ge(e,r,o.key)&&(y(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),i=!0)}return E(e),i}function we(e){T(e),E(e),S(e)}function _e(e){e.movable.color=e.movable.dests=e.animation.current=void 0,we(e)}function H(e,n,o){let i=Math.floor(8*(e[0]-o.left)/o.width);n||(i=7-i);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return n||(r=7-r),i>=0&&i<8&&r>=0&&r<8?P([i,r]):void 0}function Hn(e,n,o,i){const r=g(e),t=Ne.filter(c=>Ie(r[0],r[1],c[0],c[1])||ze(r[0],r[1],c[0],c[1])),s=t.map(c=>He(P(c),o,i)).map(c=>F(n,c)),[,a]=s.reduce((c,u,d)=>c[0]<u?c:[u,d],[s[0],0]);return P(t[a])}const k=e=>e.orientation==="white",Ye="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",zn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Rn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Qe(e){e==="start"&&(e=Ye);const n=new Map;let o=7,i=0;for(const r of e)switch(r){case" ":case"[":return n;case"/":if(--o,o<0)return n;i=0;break;case"~":{const t=n.get(P([i-1,o]));t&&(t.promoted=!0);break}default:{const t=r.charCodeAt(0);if(t<57)i+=t-48;else{const l=r.toLowerCase();n.set(P([i,o]),{role:zn[l],color:r===l?"black":"white"}),++i}}}return n}function Bn(e){return kn.map(n=>U.map(o=>{const i=e.get(o+n);if(i){let r=Rn[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,n=>n.length.toString())}function Je(e,n){n.animation&&(ye(e.animation,n.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function en(e,n){var o,i,r;if(!((o=n.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((i=n.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),ye(e,n),n.fen&&(e.pieces=Qe(n.fen),e.drawable.shapes=((r=n.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in n&&An(e,n.check||!1),"lastMove"in n&&!n.lastMove?e.lastMove=void 0:n.lastMove&&(e.lastMove=n.lastMove),e.selected&&Ue(e,e.selected),Je(e,n),!e.movable.rookCastle&&e.movable.dests){const t=e.movable.color==="white"?"1":"8",l="e"+t,s=e.movable.dests.get(l),a=e.pieces.get(l);if(!s||!a||a.role!=="king")return;e.movable.dests.set(l,s.filter(c=>!(c==="a"+t&&s.includes("c"+t))&&!(c==="h"+t&&s.includes("g"+t))))}}function ye(e,n){for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&Me(e[o])&&Me(n[o])?ye(e[o],n[o]):e[o]=n[o])}function Me(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return n===Object.prototype||n===null}const N=(e,n)=>n.animation.enabled?Fn(e,n):K(e,n);function K(e,n){const o=e(n);return n.dom.redraw(),o}const te=(e,n)=>({key:e,pos:g(e),piece:n}),In=(e,n)=>n.sort((o,i)=>F(e.pos,o.pos)-F(e.pos,i.pos))[0];function jn(e,n){const o=new Map,i=[],r=new Map,t=[],l=[],s=new Map;let a,c,u;for(const[d,m]of e)s.set(d,te(d,m));for(const d of pe)a=n.pieces.get(d),c=s.get(d),a?c?ae(a,c.piece)||(t.push(c),l.push(te(d,a))):l.push(te(d,a)):c&&t.push(c);for(const d of l)c=In(d,t.filter(m=>ae(d.piece,m.piece))),c&&(u=[c.pos[0]-d.pos[0],c.pos[1]-d.pos[1]],o.set(d.key,u.concat(u)),i.push(c.key));for(const d of t)i.includes(d.key)||r.set(d.key,d.piece);return{anims:o,fadings:r}}function nn(e,n){const o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(n-o.start)*o.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=Vn(i);for(const t of o.plan.anims.values())t[2]=t[0]*r,t[3]=t[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((t=performance.now())=>nn(e,t))}}function Fn(e,n){const o=new Map(n.pieces),i=e(n),r=jn(o,n);if(r.anims.size||r.fadings.size){const t=n.animation.current&&n.animation.current.start;n.animation.current={start:performance.now(),frequency:1/n.animation.duration,plan:r},t||nn(n,performance.now())}else n.dom.redraw();return i}const Vn=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Zn=["green","red","blue","yellow"];function Gn(e,n){if(n.touches&&n.touches.length>1)return;n.stopPropagation(),n.preventDefault(),n.ctrlKey?S(e):we(e);const o=L(n),i=H(o,k(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:o,brush:Qn(n),snapToValidMove:e.drawable.defaultSnapToValidMove},on(e))}function on(e){requestAnimationFrame(()=>{const n=e.drawable.current;if(n){const o=H(n.pos,k(e),e.dom.bounds());o||(n.snapToValidMove=!1);const i=n.snapToValidMove?Hn(n.orig,n.pos,k(e),e.dom.bounds()):o;i!==n.mouseSq&&(n.mouseSq=i,n.dest=i!==n.orig?i:void 0,e.dom.redrawNow()),on(e)}})}function Un(e,n){e.drawable.current&&(e.drawable.current.pos=L(n))}function Xn(e){const n=e.drawable.current;n&&(n.mouseSq&&Jn(e.drawable,n),rn(e))}function rn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Yn(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),tn(e.drawable))}function Qn(e){var n;const o=(e.shiftKey||e.ctrlKey)&&Le(e),i=e.altKey||e.metaKey||((n=e.getModifierState)===null||n===void 0?void 0:n.call(e,"AltGraph"));return Zn[(o?1:0)+(i?2:0)]}function Jn(e,n){const o=r=>r.orig===n.orig&&r.dest===n.dest,i=e.shapes.find(o);i&&(e.shapes=e.shapes.filter(r=>!o(r))),(!i||i.brush!==n.brush)&&e.shapes.push({orig:n.orig,dest:n.dest,brush:n.brush}),tn(e)}function tn(e){e.onChange&&e.onChange(e.shapes)}function eo(e,n){if(!(e.trustAllEvents||n.isTrusted)||n.buttons!==void 0&&n.buttons>1||n.touches&&n.touches.length>1)return;const o=e.dom.bounds(),i=L(n),r=H(i,k(e),o);if(!r)return;const t=e.pieces.get(r),l=e.selected;if(!l&&e.drawable.enabled&&(e.drawable.eraseOnClick||!t||t.color!==e.turnColor)&&Yn(e),n.cancelable!==!1&&(!n.touches||e.blockTouchScroll||t||l||no(e,i)))n.preventDefault();else if(n.touches)return;const s=!!e.premovable.current,a=!!e.predroppable.current;e.stats.ctrlKey=n.ctrlKey,e.selected&&ve(e,e.selected,r)?N(d=>de(d,r),e):de(e,r);const c=e.selected===r,u=cn(e,r);if(t&&u&&c&&Nn(e,r)){e.draggable.current={orig:r,piece:t,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:l,originTarget:n.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className=`ghost ${t.color} ${t.role}`,D(d,V(o)(g(r),k(e))),me(d,!0)),ke(e)}else s&&T(e),a&&E(e);e.dom.redraw()}function no(e,n){const o=k(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const t of e.pieces.keys()){const l=He(t,o,i);if(F(l,n)<=r)return!0}return!1}function oo(e,n,o,i){const r="a0";e.pieces.set(r,n),e.dom.redraw();const t=L(o);e.draggable.current={orig:r,piece:n,origPos:t,pos:t,started:!0,element:()=>cn(e,r),originTarget:o.target,newPiece:!0,force:!!i,keyHasChanged:!1},ke(e)}function ke(e){requestAnimationFrame(()=>{var n;const o=e.draggable.current;if(!o)return;!((n=e.animation.current)===null||n===void 0)&&n.plan.anims.has(o.orig)&&(e.animation.current=void 0);const i=e.pieces.get(o.orig);if(!i||!ae(i,o.piece))Y(e);else if(!o.started&&F(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){const t=o.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),o.element=t}const r=e.dom.bounds();D(o.element,[o.pos[0]-r.left-r.width/16,o.pos[1]-r.top-r.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==H(o.pos,k(e),r))}ke(e)})}function io(e,n){e.draggable.current&&(!n.touches||n.touches.length<2)&&(e.draggable.current.pos=L(n))}function ro(e,n){const o=e.draggable.current;if(!o)return;if(n.type==="touchend"&&n.cancelable!==!1&&n.preventDefault(),n.type==="touchend"&&o.originTarget!==n.target&&!o.newPiece){e.draggable.current=void 0;return}T(e),E(e);const i=L(n)||o.pos,r=H(i,k(e),e.dom.bounds());r&&o.started&&o.orig!==r?o.newPiece?Ge(e,o.orig,r,o.force):(e.stats.ctrlKey=n.ctrlKey,Ze(e,o.orig,r)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(o.orig),y(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===r||!r)?S(e):e.selectable.enabled||S(e),ln(e),e.draggable.current=void 0,e.dom.redraw()}function Y(e){const n=e.draggable.current;n&&(n.newPiece&&e.pieces.delete(n.orig),e.draggable.current=void 0,S(e),ln(e),e.dom.redraw())}function ln(e){const n=e.dom.elements;n.ghost&&me(n.ghost,!1)}function cn(e,n){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===n&&o.tagName==="PIECE")return o;o=o.nextSibling}}function to(e,n){e.exploding={stage:1,keys:n},e.dom.redraw(),setTimeout(()=>{xe(e,2),setTimeout(()=>xe(e,void 0),120)},120)}function xe(e,n){e.exploding&&(n?e.exploding.stage=n:e.exploding=void 0,e.dom.redraw())}function lo(e,n){function o(){xn(e),n()}return{set(i){i.orientation&&i.orientation!==e.orientation&&o(),Je(e,i),(i.fen?N:K)(r=>en(r,i),e)},state:e,getFen:()=>Bn(e.pieces),toggleOrientation:o,setPieces(i){N(r=>qn(r,i),e)},selectSquare(i,r){i?N(t=>de(t,i,r),e):e.selected&&(S(e),e.dom.redraw())},move(i,r){N(t=>Fe(t,i,r),e)},newPiece(i,r){N(t=>ge(t,i,r),e)},playPremove(){if(e.premovable.current){if(N(Wn,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=Ln(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){K(T,e)},cancelPredrop(){K(E,e)},cancelMove(){K(i=>{we(i),Y(i)},e)},stop(){K(i=>{_e(i),Y(i)},e)},explode(i){to(e,i)},setAutoShapes(i){K(r=>r.drawable.autoShapes=i,e)},setShapes(i){K(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return H(i,k(e),e.dom.bounds())},redrawAll:n,dragNewPiece(i,r,t){oo(e,i,r,t)},destroy(){_e(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function co(){return{pieces:Qe(Ye),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Pn()}}const qe={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function so(){const e=b("defs"),n=w(b("filter"),{id:"cg-filter-blur"});return n.appendChild(w(b("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(n),e}function ao(e,n,o){var i;const r=e.drawable,t=r.current,l=t&&t.mouseSq?t:void 0,s=new Map,a=e.dom.bounds(),c=r.autoShapes.filter(p=>!p.piece);for(const p of r.shapes.concat(c).concat(l?[l]:[])){if(!p.dest)continue;const h=(i=s.get(p.dest))!==null&&i!==void 0?i:new Set,f=ee(J(g(p.orig),e.orientation),a),M=ee(J(g(p.dest),e.orientation),a);h.add(fe(f,M)),s.set(p.dest,h)}const u=r.shapes.concat(c).map(p=>({shape:p,current:!1,hash:Ae(p,ue(p.dest,s),!1,a)}));l&&u.push({shape:l,current:!0,hash:Ae(l,ue(l.dest,s),!0,a)});const d=u.map(p=>p.hash).join(";");if(d===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=d;const m=n.querySelector("defs");uo(r,u,m),fo(u,n.querySelector("g"),o.querySelector("g"),p=>mo(e,p,r.brushes,s,a))}function uo(e,n,o){var i;const r=new Map;let t;for(const a of n.filter(c=>c.shape.dest&&c.shape.brush))t=sn(e.brushes[a.shape.brush],a.shape.modifiers),!((i=a.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(Q(t).key,Q(t)),r.set(t.key,t);const l=new Set;let s=o.firstElementChild;for(;s;)l.add(s.getAttribute("cgKey")),s=s.nextElementSibling;for(const[a,c]of r.entries())l.has(a)||o.appendChild(bo(c))}function fo(e,n,o,i){const r=new Map;for(const t of e)r.set(t.hash,!1);for(const t of[n,o]){const l=[];let s=t.firstElementChild,a;for(;s;)a=s.getAttribute("cgHash"),r.has(a)?r.set(a,!0):l.push(s),s=s.nextElementSibling;for(const c of l)t.removeChild(c)}for(const t of e.filter(l=>!r.get(l.hash)))for(const l of i(t))l.isCustom?o.appendChild(l.el):n.appendChild(l.el)}function Ae({orig:e,dest:n,brush:o,piece:i,modifiers:r,customSvg:t,label:l},s,a,c){var u,d;return[c.width,c.height,a,e,n,o,s&&"-",i&&po(i),r&&ho(r),t&&`custom-${De(t.html)},${(d=(u=t.center)===null||u===void 0?void 0:u[0])!==null&&d!==void 0?d:"o"}`,l&&`label-${De(l.text)}`].filter(m=>m).join(",")}function po(e){return[e.color,e.role,e.scale].filter(n=>n).join(",")}function ho(e){return[e.lineWidth,e.hilite&&"*"].filter(n=>n).join(",")}function De(e){let n=0;for(let o=0;o<e.length;o++)n=(n<<5)-n+e.charCodeAt(o)>>>0;return n.toString()}function mo(e,{shape:n,current:o,hash:i},r,t,l){var s,a;const c=ee(J(g(n.orig),e.orientation),l),u=n.dest?ee(J(g(n.dest),e.orientation),l):c,d=n.brush&&sn(r[n.brush],n.modifiers),m=t.get(n.dest),p=[];if(d){const h=w(b("g"),{cgHash:i});p.push({el:h}),c[0]!==u[0]||c[1]!==u[1]?h.appendChild(vo(n,d,c,u,o,ue(n.dest,t))):h.appendChild(go(r[n.brush],c,o,l))}if(n.label){const h=n.label;(s=h.fill)!==null&&s!==void 0||(h.fill=n.brush&&r[n.brush].color);const f=n.brush?void 0:"tr";p.push({el:wo(h,i,c,u,m,f),isCustom:!0})}if(n.customSvg){const h=(a=n.customSvg.center)!==null&&a!==void 0?a:"orig",[f,M]=h==="label"?dn(c,u,m).map(C=>C-.5):h==="dest"?u:c,_=w(b("g"),{transform:`translate(${f},${M})`,cgHash:i});_.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${n.customSvg.html}</svg>`,p.push({el:_,isCustom:!0})}return p}function go(e,n,o,i){const r=yo(),t=(i.width+i.height)/(4*Math.max(i.width,i.height));return w(b("circle"),{stroke:e.color,"stroke-width":r[o?0:1],fill:"none",opacity:an(e,o),cx:n[0],cy:n[1],r:t-r[1]/2})}function Q(e){return["#ffffff","#fff","white"].includes(e.color)?qe.hilitePrimary:qe.hiliteWhite}function vo(e,n,o,i,r,t){var l;function s(u){var d;const m=Co(t&&!r),p=i[0]-o[0],h=i[1]-o[1],f=Math.atan2(h,p),M=Math.cos(f)*m,_=Math.sin(f)*m;return w(b("line"),{stroke:u?Q(n).color:n.color,"stroke-width":ko(n,r)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?Q(n).key:n.key})`,opacity:!((d=e.modifiers)===null||d===void 0)&&d.hilite?1:an(n,r),x1:o[0],y1:o[1],x2:i[0]-M,y2:i[1]-_})}if(!(!((l=e.modifiers)===null||l===void 0)&&l.hilite))return s(!1);const a=b("g"),c=w(b("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(Po(o,i)),c.appendChild(s(!0)),a.appendChild(c),a.appendChild(s(!1)),a}function bo(e){const n=w(b("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return n.appendChild(w(b("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),n.setAttribute("cgKey",e.key),n}function wo(e,n,o,i,r,t){var l;const a=.4*.75**e.text.length,c=dn(o,i,r),u=t==="tr"?.4:0,d=w(b("g"),{transform:`translate(${c[0]+u},${c[1]-u})`,cgHash:n});d.appendChild(w(b("circle"),{r:.4/2,"fill-opacity":t?1:.8,"stroke-opacity":t?1:.7,"stroke-width":.03,fill:(l=e.fill)!==null&&l!==void 0?l:"#666",stroke:"white"}));const m=w(b("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,d.appendChild(m),d}function J(e,n){return n==="white"?e:[7-e[0],7-e[1]]}function ue(e,n){return(e&&n.has(e)&&n.get(e).size>1)===!0}function b(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function w(e,n){for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&e.setAttribute(o,n[o]);return e}function sn(e,n){return n?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(n.lineWidth||e.lineWidth),key:[e.key,n.lineWidth].filter(o=>o).join("")}:e}function yo(){return[3/64,4/64]}function ko(e,n){return(e.lineWidth||10)*(n?.85:1)/64}function an(e,n){return(e.opacity||1)*(n?.9:1)}function Co(e){return(e?20:10)/64}function ee(e,n){const o=Math.min(1,n.width/n.height),i=Math.min(1,n.height/n.width);return[(e[0]-3.5)*o,(3.5-e[1])*i]}function Po(e,n){const o={from:[Math.floor(Math.min(e[0],n[0])),Math.floor(Math.min(e[1],n[1]))],to:[Math.ceil(Math.max(e[0],n[0])),Math.ceil(Math.max(e[1],n[1]))]};return w(b("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}function fe(e,n,o=!0){const i=Math.atan2(n[1]-e[1],n[0]-e[0])+Math.PI;return o?(Math.round(i*8/Math.PI)+16)%16:i}function So(e,n){return Math.sqrt([e[0]-n[0],e[1]-n[1]].reduce((o,i)=>o+i*i,0))}function dn(e,n,o){let i=So(e,n);const r=fe(e,n,!1);if(o&&(i-=33/64,o.size>1)){i-=10/64;const t=fe(e,n);(o.has((t+1)%16)||o.has((t+15)%16))&&t&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(t=>t+.5)}function _o(e,n){e.innerHTML="",e.classList.add("cg-wrap");for(const a of yn)e.classList.toggle("orientation-"+a,n.orientation===a);e.classList.toggle("manipulable",!n.viewOnly);const o=O("cg-container");e.appendChild(o);const i=O("cg-board");o.appendChild(i);let r,t,l;if(n.drawable.visible&&(r=w(b("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(so()),r.appendChild(b("g")),t=w(b("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),t.appendChild(b("g")),l=O("cg-auto-pieces"),o.appendChild(r),o.appendChild(t),o.appendChild(l)),n.coordinates){const a=n.orientation==="black"?" black":"",c=n.ranksPosition==="left"?" left":"";if(n.coordinatesOnSquares){const u=n.orientation==="white"?d=>d+1:d=>8-d;U.forEach((d,m)=>o.appendChild(le(X.map(p=>d+p),"squares rank"+u(m)+a+c)))}else o.appendChild(le(X,"ranks"+a+c)),o.appendChild(le(U,"files"+a))}let s;return n.draggable.enabled&&n.draggable.showGhost&&(s=O("piece","ghost"),me(s,!1),o.appendChild(s)),{board:i,container:o,wrap:e,ghost:s,svg:r,customSvg:t,autoPieces:l}}function le(e,n){const o=O("coords",n);let i;for(const r of e)i=O("coord"),i.textContent=r,o.appendChild(i);return o}function Mo(e,n){if(!e.dropmode.active)return;T(e),E(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const i=L(n),r=i&&H(i,k(e),e.dom.bounds());r&&Ge(e,"a0",r)}e.dom.redraw()}function xo(e,n){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(n).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=Ao(e);o.addEventListener("touchstart",i,{passive:!1}),o.addEventListener("mousedown",i,{passive:!1})}function qo(e,n){const o=[];if("ResizeObserver"in window||o.push(I(document.body,"chessground.resize",n)),!e.viewOnly){const i=$e(e,io,Un),r=$e(e,ro,Xn);for(const l of["touchmove","mousemove"])o.push(I(document,l,i));for(const l of["touchend","mouseup"])o.push(I(document,l,r));const t=()=>e.dom.bounds.clear();o.push(I(document,"scroll",t,{capture:!0,passive:!0})),o.push(I(window,"resize",t,{passive:!0}))}return()=>o.forEach(i=>i())}function I(e,n,o,i){return e.addEventListener(n,o,i),()=>e.removeEventListener(n,o,i)}const Ao=e=>n=>{e.draggable.current?Y(e):e.drawable.current?rn(e):n.shiftKey||Le(n)?e.drawable.enabled&&Gn(e,n):e.viewOnly||(e.dropmode.active?Mo(e,n):eo(e,n))},$e=(e,n,o)=>i=>{e.drawable.current?e.drawable.enabled&&o(e,i):e.viewOnly||n(e,i)};function Do(e){const n=k(e),o=V(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,t=e.animation.current,l=t?t.plan.anims:new Map,s=t?t.plan.fadings:new Map,a=e.draggable.current,c=Oo(e),u=new Set,d=new Set,m=new Map,p=new Map;let h,f,M,_,C,z,ne,x,oe,Z;for(f=i.firstChild;f;){if(h=f.cgKey,un(f))if(M=r.get(h),C=l.get(h),z=s.get(h),_=f.cgPiece,f.cgDragging&&(!a||a.orig!==h)&&(f.classList.remove("dragging"),D(f,o(g(h),n)),f.cgDragging=!1),!z&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),M){if(C&&f.cgAnimating&&_===j(M)){const v=g(h);v[0]+=C[2],v[1]+=C[3],f.classList.add("anim"),D(f,o(v,n))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),D(f,o(g(h),n)),e.addPieceZIndex&&(f.style.zIndex=ce(g(h),n)));_===j(M)&&(!z||!f.cgFading)?u.add(h):z&&_===j(z)?(f.classList.add("fading"),f.cgFading=!0):se(m,_,f)}else se(m,_,f);else if(fn(f)){const v=f.className;c.get(h)===v?d.add(h):se(p,v,f)}f=f.nextSibling}for(const[v,R]of c)if(!d.has(v)){oe=p.get(R),Z=oe&&oe.pop();const q=o(g(v),n);if(Z)Z.cgKey=v,D(Z,q);else{const A=O("square",R);A.cgKey=v,D(A,q),i.insertBefore(A,i.firstChild)}}for(const[v,R]of r)if(C=l.get(v),!u.has(v))if(ne=m.get(j(R)),x=ne&&ne.pop(),x){x.cgKey=v,x.cgFading&&(x.classList.remove("fading"),x.cgFading=!1);const q=g(v);e.addPieceZIndex&&(x.style.zIndex=ce(q,n)),C&&(x.cgAnimating=!0,x.classList.add("anim"),q[0]+=C[2],q[1]+=C[3]),D(x,o(q,n))}else{const q=j(R),A=O("piece",q),G=g(v);A.cgPiece=q,A.cgKey=v,C&&(A.cgAnimating=!0,G[0]+=C[2],G[1]+=C[3]),D(A,o(G,n)),e.addPieceZIndex&&(A.style.zIndex=ce(G,n)),i.appendChild(A)}for(const v of m.values())Ke(e,v);for(const v of p.values())Ke(e,v)}function $o(e){const n=k(e),o=V(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(un(i)&&!i.cgAnimating||fn(i))&&D(i,o(g(i.cgKey),n)),i=i.nextSibling}function Oe(e){var n,o;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,t=i.height/i.width,l=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,s=l*t;r.style.width=l+"px",r.style.height=s+"px",e.dom.bounds.clear(),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-width",l+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("---cg-height",s+"px")}const un=e=>e.tagName==="PIECE",fn=e=>e.tagName==="SQUARE";function Ke(e,n){for(const o of n)e.dom.elements.board.removeChild(o)}function ce(e,n){const i=e[1];return`${n?10-i:3+i}`}const j=e=>`${e.color} ${e.role}`;function Oo(e){var n,o,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const s of e.lastMove)$(r,s,"last-move");if(e.check&&e.highlight.check&&$(r,e.check,"check"),e.selected&&($(r,e.selected,"selected"),e.movable.showDests)){const s=(n=e.movable.dests)===null||n===void 0?void 0:n.get(e.selected);if(s)for(const c of s)$(r,c,"move-dest"+(e.pieces.has(c)?" oc":""));const a=(i=(o=e.premovable.customDests)===null||o===void 0?void 0:o.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(a)for(const c of a)$(r,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const t=e.premovable.current;if(t)for(const s of t)$(r,s,"current-premove");else e.predroppable.current&&$(r,e.predroppable.current.key,"current-premove");const l=e.exploding;if(l)for(const s of l.keys)$(r,s,"exploding"+l.stage);return e.highlight.custom&&e.highlight.custom.forEach((s,a)=>{$(r,a,s)}),r}function $(e,n,o){const i=e.get(n);i?e.set(n,`${i} ${o}`):e.set(n,o)}function se(e,n,o){const i=e.get(n);i?i.push(o):e.set(n,[o])}function Ko(e,n,o){const i=new Map,r=[];for(const s of e)i.set(s.hash,!1);let t=n.firstElementChild,l;for(;t;)l=t.getAttribute("cgHash"),i.has(l)?i.set(l,!0):r.push(t),t=t.nextElementSibling;for(const s of r)n.removeChild(s);for(const s of e)i.get(s.hash)||n.appendChild(o(s))}function To(e,n){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:Wo(r),current:!1}));Ko(i,n,r=>No(e,r,e.dom.bounds()))}function Eo(e){var n;const o=k(e),i=V(e.dom.bounds());let r=(n=e.dom.elements.autoPieces)===null||n===void 0?void 0:n.firstChild;for(;r;)We(r,i(g(r.cgKey),o),r.cgScale),r=r.nextSibling}function No(e,{shape:n,hash:o},i){var r,t,l;const s=n.orig,a=(r=n.piece)===null||r===void 0?void 0:r.role,c=(t=n.piece)===null||t===void 0?void 0:t.color,u=(l=n.piece)===null||l===void 0?void 0:l.scale,d=O("piece",`${a} ${c}`);return d.setAttribute("cgHash",o),d.cgKey=s,d.cgScale=u,We(d,V(i)(g(s),k(e)),u),d}const Wo=e=>{var n,o,i;return[e.orig,(n=e.piece)===null||n===void 0?void 0:n.role,(o=e.piece)===null||o===void 0?void 0:o.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function Lo(e,n){const o=co();en(o,n||{});function i(){const r="dom"in o?o.dom.unbind:void 0,t=_o(e,o),l=Cn(()=>t.board.getBoundingClientRect()),s=u=>{Do(c),t.autoPieces&&To(c,t.autoPieces),!u&&t.svg&&ao(c,t.svg,t.customSvg)},a=()=>{Oe(c),$o(c),t.autoPieces&&Eo(c)},c=o;return c.dom={elements:t,bounds:l,redraw:Ho(s),redrawNow:s,unbind:r},c.drawable.prevSvgHash="",Oe(c),s(!1),xo(c,a),r||(c.dom.unbind=qo(c,a)),c.events.insert&&c.events.insert(t),c}return lo(i(),i)}function Ho(e){let n=!1;return()=>{n||(n=!0,requestAnimationFrame(()=>{e(),n=!1}))}}var zo=mn('<div class="is2d chessboard">');const Io=e=>{let n,o;return pn(()=>{let i=e.color,r=e.dests,t={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:e.onMoveAfter}}};o=Lo(n,t)}),re(()=>{let i,r;e.fen_uci?[i,r]=e.fen_uci:i=Te;let t=[];r&&(t.push(r.slice(0,2)),t.push(r.slice(2,4)));let l=e.movable?e.color:void 0;o.set({fen:i,lastMove:t,turnColor:e.color,movable:{color:l,dests:e.dests}})}),re(()=>{let i=e.orientation??"white";o.set({orientation:i})}),re(()=>{let i=e.doPromotion;if(i){let r=o.state.pieces.get(i);o.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),(()=>{var i=zo();return hn(r=>n=r,i),i})()};export{Io as C,Ee as S,he as o};
