var oe=Object.defineProperty;var ie=(o,t,e)=>t in o?oe(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var O=(o,t,e)=>(ie(o,typeof t!="symbol"?t+"":t,e),e);import{h as ne,j as ce,i as d,c as p,S as _e,k as j,b as u,l as $,m as A,o as T,n as K,p as he,q as de,f as R,g as me,F as Q,s as L,M as D,r as pe,e as ue,v as ve,d as ge,t as i}from"./index-P72p3OdZ.js";/* empty css                   */import{S as $e}from"./studyrepo-CPyy3LQB.js";import{S as fe,C as be}from"./Shalala-D-bXqfRk.js";import{T as we,a as F,C as Se}from"./Chesstree2-DLgdXuAQ.js";import{I as ke,M as ye}from"./chess_pgn_logic-BSdhjn1D.js";import{S as Ce,O as U}from"./SessionStore-BnkHOHa-.js";import"./index-C8nsK8PM.js";function xe(o){let t=0;return e=>{t+=e.deltaY*(e.deltaMode?40:1),Math.abs(t)>=4?(o(e,!0),t=0):o(e,!1)}}var Me=i("<div class=progress><div class=bar></div><h3>"),Pe=i("<div class=repertoire-wrap>"),Ee=i("<small> Click on variations to expand. "),Te=i("<small> Your goal is to guess every move correctly to fill up the progress bar. "),Re=i("<h2>Select a Practice Option"),Le=i("<button><span> Play all Moves "),Ae=i("<button><span> Play as Match "),Ie=i("<h2>Play as Match"),Ne=i("<small> Try to guess the moves for <!>."),Oe=i("<small> AI will play the next move, picking a random variation. "),De=i("<small> Moves will be hidden once the game is started. "),je=i("<div class=in_mode><button><span> Rematch </span></button><button class=end2><span> End Practice "),Fe=i("<h2>Play all moves"),Ye=i("<small>Try to guess the moves for both sides."),qe=i("<small>Moves will be hidden once you start."),Be=i("<div class=in_mode><button><span> Clear </span></button><button class=end2><span> End Practice "),Ge=i("<div class=repertoire><div class=list-wrap><h1 class=header>Repertoire</h1><div class=list><div><h3 class=title></h3></div><ul></ul></div></div><div class=board-wrap></div><div class=eval-gauge></div><div class=replay-wrap><div class=replay-header><div class=title><h5>Slav Defense</h5><h4></h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools></div></div></div><div class=under><br><br><br>"),He=i("<li><div><h3></h3> "),Ke=i('<div class=line><span class="fill white"></span><span class="fill black">');const Qe=["#afacc6","#0d2b45","#203c56","#544e68","#8d697a","#d08159"],Ue=o=>Qe[Math.floor((1-o/10)*6)];class We{constructor(){O(this,"_mode");O(this,"_match_color");this._mode=j(void 0,{equals:!1}),this._match_color=j("white")}get mode(){return this._mode[0]()}set mode(t){this._mode[1](t)}get match_color(){return this._match_color[0]()}set match_color(t){this._match_color[1](t)}flip_match_color(){this.match_color=this.match_color==="white"?"black":"white"}}const W=o=>(()=>{var t=Me(),e=t.firstChild,s=e.nextSibling;return d(s,()=>`%${o.width}`),R(l=>L(e,`width: ${o.width}%`,l)),t})();class ze{constructor(t){this.chapters=t}get progress(){let t=this.chapters.length;return this.chapters.map(e=>Math.round(e.progress/t)).reduce((e,s)=>e+s)}}class k{constructor(t,e,s,l){this.study_id=t,this.i_chapter=e,this.score_tree=s,this.solved_paths=l}static load_from_store(t,e){let s=new U(t.id,e);return k.make(t.id,e,t.chapters[e].pgn.tree,F.set_for_saving(s.solved_paths))}static save_paths_to_store(t){let e=new U(t.study_id,t.i_chapter);e.solved_paths=t.solved_paths.get_for_saving(),e.practice_progress=t.progress}static make(t,e,s,l=new F){return new k(t,e,ye.make(s),l)}get progress(){return Math.floor(this.solved_paths.expand_paths.map(t=>{var e;return((e=this.score_tree.get_at(t))==null?void 0:e.score)??0}).reduce((t,e)=>t+e,0)*100)}get progress_map(){let t=A(()=>this.score_tree.progress_paths);const e=A(()=>t.map(s=>[s.filter(l=>l.length%2===1).map(l=>this.score_tree.get_at(l).score).reduce((l,f)=>l+f,0),s.filter(l=>l.length%2===0).map(l=>this.score_tree.get_at(l).score).reduce((l,f)=>l+f,0)]));return t.map((s,l)=>{let f=s[0],w=s[s.length-1],y=e[l][0],C=e[l][1],m=u(()=>this.solved_paths.expand_paths),S=u(()=>m().filter(_=>s.some(g=>g.join("")===_.join("")))),x=u(()=>S().filter(_=>_.length%2===1).map(_=>this.score_tree.get_at(_).score).reduce((_,g)=>_+g,0)),M=u(()=>S().filter(_=>_.length%2===0).map(_=>this.score_tree.get_at(_).score).reduce((_,g)=>_+g,0));return{color:Ue(f.length/20+w.length/10),total:y*2,black:u(()=>M()/C),white:u(()=>x()/y),path:w}}).reverse()}merge_and_save_stats(t){this.solved_paths.merge_dup(t.solved_paths),k.save_paths_to_store(this)}}const ot=()=>{const o=ne(),[t]=ce(o.id,$e.read_study);return(()=>{var e=Pe();return d(e,p(_e,{get when(){return!t.loading},fallback:"Loading...",get children(){return p(Je,{get study(){return t()}})}})),e})()},Je=o=>{const t=()=>o.study;let e=new We,s=new fe;const[l,f]=j(Ce.i_chapter??0);let w=u(()=>{const r=t();return new ze(r.chapters.map((n,b)=>k.load_from_store(r,b)))}),y=u(()=>w().chapters[l()]);const C=u(()=>t().chapters[l()]),m=u(()=>{e.mode;let r=C();return we.make(r.pgn.tree.clone)});$(()=>{m().solved_paths.replace_all(y().solved_paths)});const S=u(()=>{let r=m().tree;return A(()=>k.make(t().name,l(),r,new F))});$(()=>{A(()=>S()).solved_paths.replace_all(m().solved_paths)}),$(T(()=>[S(),y()],(r,n)=>{if(n){let[b,I]=n;I.merge_and_save_stats(b)}})),$(()=>{let{mode:r,match_color:n}=e;r==="match"&&n==="black"&&setTimeout(()=>{m().reveal_one_random()},400)}),$(T(()=>s.add_uci,r=>{if(!r)return;m().try_next_uci_fail(r)&&e.mode==="match"&&setTimeout(()=>{m().reveal_one_random()},400)})),$(T(()=>m().fen_last_move,r=>{if(r){let[n,b]=r;s.on_set_fen_uci(n,b)}else s.on_set_fen_uci(ke)})),$(T(()=>s.on_wheel,r=>{r&&m().on_wheel(r)}));const x=r=>{r.key==="f"&&e.flip_match_color()};document.addEventListener("keypress",x),K(()=>{document.removeEventListener("keypress",x)});const M=xe(r=>{const n=r.target;n.tagName!=="PIECE"&&n.tagName!=="SQUARE"&&n.tagName!=="CG-BOARD"||(r.preventDefault(),s.set_on_wheel(Math.sign(r.deltaY)))});$(()=>{e.match_color=t().orientation??"white"});const _=u(()=>S().progress_map);let g;return he(()=>{g.addEventListener("wheel",M,{passive:!1})}),K(()=>{g.removeEventListener("wheel",M)}),(()=>{var r=Ge(),n=r.firstChild,b=n.firstChild,I=b.nextSibling,N=I.firstChild,z=N.firstChild,J=N.nextSibling,Y=n.nextSibling,q=Y.nextSibling,V=q.nextSibling,B=V.firstChild,G=B.firstChild,X=G.firstChild,Z=X.nextSibling,ee=G.nextSibling,te=ee.firstChild,re=B.nextSibling,H=re.firstChild,se=H.nextSibling;return de(a=>g=a,r),d(z,()=>t().name),d(N,p(W,{get width(){return w().progress}}),null),d(J,p(Q,{get each(){return t().chapters},children:(a,c)=>(()=>{var h=He(),P=h.firstChild,v=P.firstChild;return v.nextSibling,h.$$click=()=>f(c()),d(v,()=>a.name),d(P,p(W,{get width(){var E;return((E=w())==null?void 0:E.chapters[c()].progress)??0}}),null),R(()=>me(h,c()===l()?"active":"")),h})()})),d(Y,p(be,{get orientation(){return e.match_color},get movable(){return e.mode!==void 0},get doPromotion(){return s.promotion},get onMoveAfter(){return s.on_move_after},get fen_uci(){return s.fen_uci},get color(){return s.turnColor},get dests(){return s.dests}})),d(q,p(Q,{get each(){return _()},children:a=>(()=>{var c=Ke(),h=c.firstChild,P=h.nextSibling;return c.$$click=v=>m().try_set_cursor_path(a.path),R(v=>{var E=`background: ${a.color}; height: ${Math.round(a.total*100)}%`,le=`height: ${Math.round(a.white()*100)}%`,ae=`height: ${Math.round(a.black()*100)}%`;return v.e=L(c,E,v.e),v.t=L(h,le,v.t),v.a=L(P,ae,v.a),v},{e:void 0,t:void 0,a:void 0}),c})()})),d(Z,()=>C().name),d(H,p(Se,{get lala(){return m()}})),d(se,p(ue,{get children(){return[p(D,{get when(){return e.mode===void 0},get children(){return[Ee(),Te(),Re(),(()=>{var a=Le();return a.$$click=()=>e.mode="moves",a})(),(()=>{var a=Ae();return a.$$click=()=>e.mode="match",a})()]}}),p(D,{get when(){return e.mode==="match"},get children(){return[Ie(),(()=>{var a=Ne(),c=a.firstChild,h=c.nextSibling;return h.nextSibling,d(a,()=>e.match_color,h),a})(),Oe(),De(),(()=>{var a=je(),c=a.firstChild,h=c.nextSibling;return c.$$click=()=>{pe(()=>{e.mode="match",e.flip_match_color()})},h.$$click=()=>e.mode=void 0,a})()]}}),p(D,{get when(){return e.mode==="moves"},get children(){return[Fe(),Ye(),qe(),(()=>{var a=Be(),c=a.firstChild,h=c.nextSibling;return c.$$click=()=>{e.mode="moves"},h.$$click=()=>e.mode=void 0,a})()]}})]}})),R(()=>ve(te,"href",C().site)),r})()};ge(["click"]);export{ot as default};
