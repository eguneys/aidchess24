import{_ as G,H as U,c as k,g as h,J as K,a as w,m as H,K as Q,L as A,N as R,O as D,Q as X,T as Y,x as L,r as J,n as v,b as Z,t as E,I as P,U as ee,V as te,d as ne,C as j,i as C,S as F,j as re,k as se,F as ae,W as le,X as oe,o as ie,B as ce,Y as ue,Z as _e,q as x,D as de,u as fe}from"./index-Bw0_5AmP.js";import{C as pe}from"./chessground-doaUGlzw.js";import{s as me}from"./scroll-DnAhRpRC.js";async function ge(t){const u=await ye(t);function r(n){return u.transaction(t.store,n).objectStore(t.store)}function l(n){return new Promise((a,_)=>{const s=n();s.onsuccess=g=>a(g.target.result),s.onerror=g=>_(g.target.result)})}return{list:()=>l(()=>r("readonly").getAllKeys()),get:n=>l(()=>r("readonly").get(n)),getMany:n=>l(()=>r("readonly").getAll(n)),put:(n,a)=>l(()=>r("readwrite").put(a,n)),count:n=>l(()=>r("readonly").count(n)),remove:n=>l(()=>r("readwrite").delete(n)),clear:()=>l(()=>r("readwrite").clear()),cursor:(n,a)=>l(()=>r("readonly").openCursor(n,a)).then(_=>_??void 0),txn:n=>u.transaction(t.store,n)}}async function ye(t){const u=t?.db||`${t.store}--db`;return new Promise((r,l)=>{const n=window.indexedDB.open(u,t?.version??1);n.onsuccess=a=>r(a.target.result),n.onerror=a=>l(a.target.error??"IndexedDB Unavailable"),n.onupgradeneeded=a=>{const _=a.target.result,s=a.target.transaction,g=_.objectStoreNames.contains(t.store)?s.objectStore(t.store):_.createObjectStore(t.store);t.upgrade?.(a,g)}})}async function he(t){let u;await ve({on_received:a,on_status(o){o&&(o.download&&t.on_downloaded_nb(o.download),o.error&&t.on_engine_failed(o.error))},on_connected(o){u=o}}),r("uci");function r(o){u?.(o)}function l(o){g=o,p(),m()}function n(){return!!s&&!s.stop_requested}function a(o){const c=o.trim().split(/\s+/g);if(c[0]==="uciok")r("ucinewgame"),r("isready");else if(c[0]==="readyok")m();else if(!(c[0]==="id"&&c[1]==="name"))if(c[0]==="bestmove"){s&&f&&s.emit(f),s=void 0,m();return}else if(s&&!s.stop_requested&&c[0]==="info"){let b=0,N,S=1,B,I,$=!1,M,T=[];for(let y=1;y<c.length;y++)switch(c[y]){case"depth":b=parseInt(c[++y]);break;case"nodes":N=parseInt(c[++y]);break;case"multipv":S=parseInt(c[++y]);break;case"time":B=parseInt(c[++y]);break;case"score":$=c[++y]==="mate",M=parseInt(c[++y]),(c[y+1]==="lowerbound"||c[y+1]==="upperbound")&&(I=c[++y]);break;case"pv":T=c.slice(++y),y=c.length;break}if($&&!M||(_<S&&(_=S),!U(N)||!U(B)||!U($)||!U(M)))return;const q=s.ply%2===1?-M:M;if(I&&S===1)return;const V={moves:T,cp:$?void 0:q,mate:$?q:void 0,depth:b};S===1?f={fen:s.current_fen,depth:b,nodes:N,millis:B,cp:$?void 0:q,mate:$?q:void 0,pvs:[V]}:f&&(f.pvs.push(V),f.depth=Math.min(f.depth,b)),S===_&&f&&(s.emit(f),b>=40&&p())}else o&&!["Stockfish","id","option","info"].includes(c[0])&&console.warn(`SF: ${o}`)}let _=0,s,g,f;function m(){if(!s&&(s=g,g=void 0,s)){f=void 0,_=1,d("Threads",s.threads),d("Hash",s.hash_size||16),d("MultiPV",Math.max(1,s.multi_pv)),e&&e!==s.game_id&&r("ucinewgame"),e=s.game_id,r(["position fen",s.initial_fen,"moves",s.moves].join(" "));const[o,c]=Object.entries(s.search)[0];r(`go ${o} ${c}`)}}let i=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function d(o,c){c=c.toString(),i.get(o)!==c&&(r(`setoption name ${o} value ${c}`),i.set(o,c))}function p(){s&&!s.stop_requested&&(s.stop_requested=!0,r("stop"))}let e;return{start(o){l(o)},stop(){l()},destroy(){r("quit")},get state(){return n()?"computing":"idle"}}}async function ve(t){const u=i=>{t.on_status(i)},r=i=>{t.on_received(i)},l=i=>{t.on_connected(i)};let n=await G(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),a=await new Promise((i,d)=>{n.default({wasmMemory:we(2560),onError:p=>d(new Error(p)),locateFile:p=>`stockfish/${p}`}).then(i).catch(d)}),_=await ge({store:".aidchess.nnue"}).catch(()=>{}),s=[];for(let i=0;;i++){let d=a.getRecommendedNnue(i);if(!d||s.includes(d))break;s.push(d)}(await f(s)).forEach((i,d)=>a.setNnueBuffer(i,d)),a.onError=m(),a.listen=i=>r(i),l(i=>a.uci(i));async function f(i){return Promise.all(i.map(async d=>{let p=await _?.get(d).catch(()=>{});if(p&&p.byteLength>128*1024)return p;const e=new XMLHttpRequest;e.open("get",`stockfish/nnue/${d}`,!0),e.responseType="arraybuffer",e.onprogress=c=>u({download:{bytes:c.loaded,total:c.total}});const o=await new Promise((c,b)=>{e.onerror=()=>b(new Error(`fetch '${d}' failed: ${e.status}`)),e.onload=()=>{e.status/100===2?c(new Uint8Array(e.response)):b(new Error(`fetch '${d}' failed: ${e.status}`))},e.send()});return u(),_?.put(d,o).catch(()=>console.warn("IDB store failed")),o}))}function m(){return i=>{if(i.startsWith("BAD_NNUE")&&_){const d=Math.max(0,Number(i.slice(9))),p=a.getRecommendedNnue(d);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${p} from IDB`),_.remove(p)},2e3)}else u({error:i})}}}const we=(t,u=32767)=>{let r=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:t,maximum:u})}catch(l){if(u<=t||!(l instanceof RangeError))throw l;u=Math.max(t,Math.ceil(u-u/r)),r=r===4?3:4}},O=K();function be(t){let u=async function(){let[r,l]=w(void 0),[n,a]=w(void 0),[_]=H(()=>he({on_downloaded_nb(s){l(s)},on_engine_failed(s){a(s)}}));return{get download_nb(){return r()},get engine_failed(){return n()},get state(){let s=_();return _.loading||!s?"loading":s.state},async get_best_move(s,g,f,m,i){let d=c=>{},p=_();if(!p)return;let e=Math.max(1,navigator.hardwareConcurrency-2);return p.start({threads:e,hash_size:16,game_id:s,stop_requested:!1,path:[],search:{depth:i},multi_pv:m,ply:f,threatMode:!1,initial_fen:g,current_fen:g,moves:[],emit:Q(200,function(c){c.depth===i&&d(c)})}),new Promise(c=>{d=c})}}};return k(O.Provider,{get value(){return u()},get children(){return h(()=>t.children)}})}var ke=E('<div class="is2d chessboard">');function $e(){let[t,u]=w(A.fromSetup(R(P).unwrap()).unwrap(),{equals:!1}),[r,l]=w(void 0),[n,a]=w(void 0),_=h(()=>D(t().toSetup())),s=h(()=>t().turn),g=h(()=>X(t()));const f=m=>{let i=t(),d=ee(m),p=te(i,d);i.play(d),L(()=>{l([m,p]),a([m,p]),u(i),m.length})};return{play_orig_key(m,i){let d=t(),p=s(),e=d.board.get(Y(m)),o=m+i;e.role==="pawn"&&(i[1]==="8"&&p==="white"||i[1]==="1"&&p==="black")&&(o+="q"),f(o)},play_uci:f,set_fen_last_move(m,i){L(()=>{u(A.fromSetup(R(m).unwrap()).unwrap()),l(i)})},get dests(){return g()},get fen_last_move(){let m=_(),i=r();return i?[m,i]:void 0},get fen(){return _()},get last_move(){return r()},get add_last_move(){return n()},get check(){return t().isCheck()},get isEnd(){return t().isEnd()}}}function Se(t){let u,r;return J(()=>{let l=t.color,n=t.play_uci.dests,a={fen:t.play_uci.fen,check:t.play_uci.check,premovable:{enabled:!1},movable:{color:l,free:!1,dests:n,events:{after:t.play_uci.play_orig_key}}};r=pe(u,a)}),v(()=>{let l,n;if(!t.play_uci.fen_last_move)l=P;else{let s;[l,[n,s]]=t.play_uci.fen_last_move}let a=[];n&&(a.push(n.slice(0,2)),a.push(n.slice(2,4)));let _=t.movable?t.color:void 0;r.set({fen:l,lastMove:a,turnColor:t.color,movable:{color:_,dests:t.play_uci.dests}})}),v(()=>{let l=t.orientation??"white";r.set({orientation:l})}),v(()=>{let l=t.play_uci.check;r.set({check:l})}),v(()=>{t.shapes?r.setAutoShapes(t.shapes):r.setAutoShapes([])}),(()=>{var l=ke();return Z(n=>u=n,l),l})()}var xe=E("<div class=replay-single><div class=moves>"),Ce=E("<span class=index>"),Ee=E("<span>");function z(t,u,r){let l=le(u,r),n=oe(l),a=D(u.toSetup());u.play(l);let _=D(u.toSetup());return{ply:t,before_fen:a,fen:_,uci:n,san:r}}function W(t,u=P,r=0){let l=[],n=A.fromSetup(R(u).unwrap()).unwrap();for(let a of t)l.push(z(++r,n,a));return l}function Me(t=P,u=[]){let[r,l]=w(W(u,t));const n=h(()=>{let e=r();return e[e.length-1]});let[a,_]=w(n()?.ply??0);const s=h(()=>{let e=a();return r().find(c=>c.ply===e)});let g=h(j(r,e=>e.san)),f=h(j(r,e=>e.ply)),m=h(()=>{let e=g(),o=f();return e.map((c,b)=>`${o[b]} ${c}`)});const i=e=>{_(e)},d=()=>{let e=a()-1;return f().find(o=>o===e)},p=()=>{let e=a()+1;return f().find(o=>o===e)};return{initial_fen:t,get plies(){return f()},get sans(){return g()},get ply_sans(){return m()},get ply_step(){return s()},get last_step(){return n()},goto_ply:i,get_prev_ply:d,get_next_ply:p,goto_prev_ply_if_can(){let e=d();e!==void 0&&i(e),a()===1&&_(0)},goto_next_ply_if_can(){let e=p();e!==void 0&&i(e)},play_san(e){let o=n();if(!o){l(W([e]));return}let c=A.fromSetup(R(o.fen).unwrap()).unwrap();l([...r(),z(o.ply+1,c,e)]),_(o.ply+1)},get is_on_last_ply(){return a()===(n()?.ply??0)}}}function Pe(t){const u=h(j(()=>t.play_replay.ply_sans,n=>{let[a,_]=n.split(" ");return{ply:parseInt(a),san:_}})),r=n=>{t.play_replay.goto_ply(n)},l=h(()=>t.play_replay.ply_step?.ply);return(()=>{var n=xe(),a=n.firstChild;return C(a,k(ae,{get each(){return u()},children:_=>[k(F,{get when(){return _.ply%2===1},get children(){var s=Ce();return C(s,()=>Math.ceil(_.ply/2)),s}}),(()=>{var s=Ee();return s.$$click=()=>r(_.ply),C(s,()=>_.san),re(()=>se(s,"move"+(_.ply===l()?" active":""))),s})()]})),n})()}ne(["click"]);var Ne=E("<span class=info>Loading <!>%"),qe=E("<div class=builder><div class=board-wrap></div><div class=replay-wrap>");const Fe=()=>k(be,{get children(){return k(Ue,{})}});function Ue(){let[t]=H(()=>fe(O));const u=h(()=>{let r=t()?.download_nb;if(r)return Math.ceil(r.bytes/r.total*100)});return k(F,{get when(){return t()},children:r=>k(F,{get when(){return r().state==="loading"},get fallback(){return k(Re,{get s(){return r()}})},get children(){return[(()=>{var l=Ne(),n=l.firstChild,a=n.nextSibling;return a.nextSibling,C(l,()=>u()??"--",a),l})()," "]}})})}function Ae(t){let u=`${Math.random()}`,[r,l]=w("white",{equals:!1}),n=6,a=8,[_,s]=w(!1);v(x(()=>t.get_fen_ply_and_play,f=>{if(!f)return;let[m,i]=f;if(de(m)===r()){if(_())return;s(!0),t.s.get_best_move(u,m,i,n,a).then(p=>{s(!1),p&&g(p)})}}));const g=f=>{let m=f.pvs[0].moves[0];t.on_play_uci(m)};return{get engine_color(){return r()},reset_game(f){L(()=>{l(f)})}}}function Re(t){const u=ie();u.setVolume(.2);let[r,l]=ce([],"builder.current.sans");const n=Me(P,r());let a=$e(),[_,s]=w(void 0),g=Ae({on_play_uci(e){a.play_uci(e)},get get_fen_ply_and_play(){return _()},s:t.s});const[f,m]=w("white");g.reset_game(ue(f())),v(()=>{console.log(a.last_move)}),v(x(()=>a.add_last_move,e=>{e&&n.play_san(e[1])})),v(x(()=>n.sans,l)),v(x(()=>n.last_step,e=>{e&&s([e.fen,e.ply])})),v(x(()=>n.ply_step,e=>{e?a.set_fen_last_move(e.fen,[e.uci,e.san]):a.set_fen_last_move(n.initial_fen)})),v(x(()=>n.ply_step,(e,o)=>{e&&(!o||o.ply===e.ply-1)&&u.move(e)}));const i=me(e=>{const o=e.target;o.tagName!=="PIECE"&&o.tagName!=="SQUARE"&&o.tagName!=="CG-BOARD"||(e.preventDefault(),d(Math.sign(e.deltaY)))}),d=e=>{e>0?n.goto_next_ply_if_can():n.goto_prev_ply_if_can()},p=()=>!a.isEnd&&n.is_on_last_ply;return(()=>{var e=qe(),o=e.firstChild,c=o.nextSibling;return _e(e,"wheel",i),C(o,k(Se,{get color(){return f()},get movable(){return p()},play_uci:a})),C(c,k(Pe,{play_replay:n})),e})()}export{Fe as default};
