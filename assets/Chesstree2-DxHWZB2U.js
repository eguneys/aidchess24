var O=Object.defineProperty;var H=(e,t,a)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var _=(e,t,a)=>(H(e,typeof t!="symbol"?t+"":t,a),a);import{d as I,l as y,q as M,i as o,c as s,S as $,r as c,e as C,M as w,F as v,f as L,g as N,t as p,k as f,n as F}from"./index-DigfKJAO.js";import"./Shalala-B52gRouf.js";import{I as A,M as D}from"./chess_pgn_logic-AUo9Luh0.js";var E=p("<div class=chesstree>"),R=p("<div class=lines>"),W=p("<div class=line>"),P=p("<span class=index>"),z=p("<div>"),B=p("<span class=collapsed> ..<!> ");const j=class j{constructor(t,a){_(this,"_tree");_(this,"_cursor_path");_(this,"_hidden_paths");_(this,"_revealed_paths");_(this,"_failed_paths");_(this,"_solved_paths");_(this,"reveal_hidden_paths",()=>{this.revealed_paths=this.hidden_paths,this.hidden_paths=[]});_(this,"reveal_one_random",()=>{var r,h;if(!this.tree)return!1;const t=((h=(r=this.tree)==null?void 0:r._traverse_path(this.cursor_path))==null?void 0:h.children)??[this.tree.root],a=J(t);if(a){let n=this.hidden_paths;n=n.filter(d=>d.join("")!==a.data.path.join(""));let i=a.children.map(d=>d.data.path);return n.push(...i),this.hidden_paths=n,this.cursor_path=a.data.path,!0}return!1});_(this,"try_next_uci_fail",t=>{var n,i,d;if(!this.tree)return!1;const a=((n=this.tree)==null?void 0:n._traverse_path(this.cursor_path))??this.tree.root,r=((d=(i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))==null?void 0:d.children)??[this.tree.root],h=r.find(u=>u.data.uci===t)??r.find(u=>K(u.data)===t);if(h){let u=this.hidden_paths;u=u.filter(g=>g.join("")!==h.data.path.join(""));let S=h.children.map(g=>g.data.path);u.push(...S),this.hidden_paths=u;let m=this.solved_paths;return m.push(r[0].data.path),this.solved_paths=m,this.cursor_path=h.data.path,!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.failed_paths.push([...a.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});_(this,"on_wheel",t=>{var r,h;let a=this.cursor_path;if(t<0)a.length>0&&this.try_set_cursor_path(a.slice(0,-1));else{let n=this.tree;if(n){let i;a.length===0?i=[n.root]:i=(r=n._traverse_path(a))==null?void 0:r.children;let d=(h=i==null?void 0:i[0])==null?void 0:h.data.path;d&&this.try_set_cursor_path(d)}}});this.initial_fen=t,this._cursor_path=f([],{equals:!1}),this._tree=f(a),this._hidden_paths=f([],{equals:!1}),this._revealed_paths=f([],{equals:!1}),this._failed_paths=f([],{equals:!1}),this._solved_paths=f([],{equals:!1})}get solved_paths(){return this._solved_paths[0]()}set solved_paths(t){this._solved_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get hidden_paths(){return this._hidden_paths[0]()}set hidden_paths(t){this._hidden_paths[1](t)}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}try_set_cursor_path(t){return this.hidden_paths.find(r=>t.join("").startsWith(r.join("")))?!1:(this.cursor_path=t,!0)}get fen_last_move(){let t=this.tree;if(t){let a=t.get_at(this.cursor_path);if(!a)return;let r=a.after_fen,h=a.uci;return[r,h]}}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let a=this.tree,r=this.cursor_path;a?a.append_uci(t,r):a=D.make(this.initial_fen,[t]),r=[...r,t],F(()=>{this.tree=a,this.cursor_path=r})}};_(j,"make",(t,a=(t==null?void 0:t.root.data.before_fen)||A)=>new j(a,t));let q=j;const Y=e=>{let t;return y(()=>{let a=e.lala.cursor_path,r=t.parentElement;if(!r)return;const h=t.querySelector(".on_path_end");if(!h){r.scrollTop=a.length>0?99999:0;return}let n=h.offsetTop-r.offsetHeight/2+h.offsetHeight;r.scrollTo({behavior:"smooth",top:n})}),(()=>{var a=E();return M(r=>t=r,a),o(a,s($,{get when(){return e.lala.tree},get fallback(){return[]},children:r=>s(x,{on_set_path:h=>e.lala.try_set_cursor_path(h),get cursor_path(){return e.lala.cursor_path},get hidden_paths(){return e.lala.hidden_paths},get revealed_paths(){return e.lala.revealed_paths},get solved_paths(){return e.lala.solved_paths},get failed_paths(){return e.lala.failed_paths},get lines(){return[r().root]}})})),a})()},x=e=>s(v,{get each(){return e.lines},children:t=>[s(k,c({get data(){return t.data}},e)),s(C,{get children(){return[s(w,{get when(){return t.children.length===1},get children(){return s(x,c(e,{get lines(){return t.children}}))}}),s(w,{get when(){return t.children.length>1},get children(){var a=R();return o(a,s(v,{get each(){return t.children},children:r=>(()=>{var h=W();return o(h,s(x,c(e,{lines:[r],show_index:!0}))),h})()})),a}})]}})]}),k=e=>{let t=`${Math.ceil(e.data.ply/2)}.`;e.data.ply%2===0&&(t+="..");let a=()=>e.cursor_path.join("").startsWith(e.data.path.join("")),r=()=>e.cursor_path.join("")===e.data.path.join(""),h=e.data.path.join(""),n=()=>e.hidden_paths.find(l=>l.join("")===h),i=()=>e.hidden_paths.find(l=>h.startsWith(l.join(""))),d=()=>e.revealed_paths.find(l=>l.join("")===h),u=()=>e.revealed_paths.find(l=>h.startsWith(l.join(""))),S=()=>e.failed_paths.find(l=>l.join("")===h),m=()=>e.solved_paths.find(l=>l.join("")===h),g=()=>["move",r()?"on_path_end":a()?"on_path":"",n()?"on_hidden_path_start":i()?"on_hidden_path":"",d()?"on_revealed_path_start":u()?"on_revealed_path":"",S()?"on_failed_path":"",m()?"on_solved_path":"",e.collapsed?"collapsed":""].join(" ");return(()=>{var l=z();return l.$$click=()=>e.on_set_path(e.data.path),o(l,s($,{get when(){return e.show_index||e.data.ply&1},get children(){var T=P();return o(T,t),T}}),null),o(l,()=>e.data.san,null),L(()=>N(l,g())),l})()},Z=e=>{let t;return y(()=>{let a=e.lala.cursor_path,r=t.parentElement;if(!r)return;const h=t.querySelector(".on_path_end");if(!h){r.scrollTop=a.length>0?99999:0;return}let n=h.offsetTop-r.offsetHeight/2+h.offsetHeight;r.scrollTo({behavior:"smooth",top:n})}),(()=>{var a=E();return M(r=>t=r,a),o(a,s($,{get when(){return e.lala.tree},get fallback(){return[]},children:r=>s(b,{on_set_path:h=>e.lala.try_set_cursor_path(h),get cursor_path(){return e.lala.cursor_path},get hidden_paths(){return e.lala.hidden_paths},get revealed_paths(){return e.lala.revealed_paths},get solved_paths(){return e.lala.solved_paths},get failed_paths(){return e.lala.failed_paths},get lines(){return[r().root]}})})),a})()},b=e=>s(v,{get each(){return e.lines},children:t=>[s(k,c({get data(){return t.data}},e)),s(C,{get children(){return[s(w,{get when(){return t.children.length===1},get children(){return s(b,c(e,{get lines(){return t.children},show_index:!1}))}}),s(w,{get when(){return t.children.length>1},get children(){var a=R();return o(a,s(v,{get each(){return t.children},children:r=>(()=>{var h=W();return o(h,s($,{get when(){return e.cursor_path.join("").startsWith(r.data.path.join(""))},get fallback(){return s(G,c(e,{lines:[r],show_index:!0}))},get children(){return s(b,c(e,{lines:[r],show_index:!0}))}})),h})()})),a}})]}})]}),G=e=>s(v,{get each(){return e.lines},children:t=>[s(k,c({get data(){return t.data}},e,{collapsed:!0})),(()=>{var a=B(),r=a.firstChild,h=r.nextSibling;return h.nextSibling,o(a,()=>t.length,h),o(a,()=>t.nb_first_variations,null),a})()]});function J(e){let t=e.length*(e.length+1)/2,a=Math.floor(Math.random()*t)+1,r=0;for(let h=0;h<e.length;h++)if(r+=e.length-h,a<=r)return e[h]}const K=e=>{let t=e.uci.slice(0,2),a=e.uci[3];if(e.san==="O-O")return t+"g"+a;if(e.san==="O-O-O")return t+"c"+a};I(["click"]);export{Z as C,q as T,Y as a};
