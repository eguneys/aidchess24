var P=Object.defineProperty;var H=(a,t,e)=>t in a?P(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var u=(a,t,e)=>(H(a,typeof t!="symbol"?t+"":t,e),e);import{d as F,l as j,n as B,i as d,c as n,S as b,o as E,e as G,M as A,F as I,f as N,g as Q,t as c,k as v,p as U,h as V,j as Y,b as W,q as C,s as J,m as K}from"./index-BstVnhix.js";/* empty css                   */import{S as X}from"./studyrepo-2D8u9VwK.js";import{S as Z,C as tt}from"./Shalala-Cg4LLOgJ.js";import{I as et,M as at}from"./chess_pgn_logic-DOr4Eb6a.js";var st=c("<div class=chesstree>"),rt=c("<div class=lines>"),lt=c("<div class=line>"),ht=c("<span class=index>"),it=c("<div>");const S=class S{constructor(t,e){u(this,"_tree");u(this,"_cursor_path");u(this,"_hidden_paths");u(this,"_revealed_paths");u(this,"_failed_paths");u(this,"_solved_paths");u(this,"reveal_hidden_paths",()=>{this.revealed_paths=this.hidden_paths,this.hidden_paths=[]});u(this,"try_next_uci_fail",t=>{var h,_;const e=(h=this.tree)==null?void 0:h._traverse_path(this.cursor_path);if(!e)return;const s=e.children;if(((_=s[0])==null?void 0:_.data.uci)===t){let o=this.hidden_paths;o=o.filter(p=>p.join("")!==s[0].data.path.join(""));let $=s[0].children.map(p=>p.data.path);o.push(...$),this.hidden_paths=o;let m=this.solved_paths;m.push(s[0].data.path),this.solved_paths=m,this.cursor_path=s[0].data.path}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}this.add_uci(t),this.failed_paths.push([...e.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100)}});u(this,"on_wheel",t=>{var s;let e=this.cursor_path;if(t<0)e.length>1&&this.try_set_cursor_path(e.slice(0,-1));else{let h=this.tree;if(h){let o=(s=h._traverse_path(e).children[0])==null?void 0:s.data.path;o&&this.try_set_cursor_path(o)}}});this.initial_fen=t,this._cursor_path=v([],{equals:!1}),this._tree=v(e),this._hidden_paths=v([],{equals:!1}),this._revealed_paths=v([],{equals:!1}),this._failed_paths=v([],{equals:!1}),this._solved_paths=v([],{equals:!1})}get solved_paths(){return this._solved_paths[0]()}set solved_paths(t){this._solved_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get hidden_paths(){return this._hidden_paths[0]()}set hidden_paths(t){this._hidden_paths[1](t)}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}try_set_cursor_path(t){return this.hidden_paths.find(s=>t.join("").startsWith(s.join("")))?!1:(this.cursor_path=t,!0)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path),s=e.after_fen,h=e.uci;return[s,h]}}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let e=this.tree,s=this.cursor_path;e?e.append_uci(t,s):e=at.make(this.initial_fen,[t]),s=[...s,t],U(()=>{this.tree=e,this.cursor_path=s})}};u(S,"make",(t,e=(t==null?void 0:t.root.data.before_fen)||et)=>new S(e,t));let R=S;const nt=a=>{let t;return j(()=>{let e=a.lala.cursor_path,s=t.parentElement;if(!s)return;const h=t.querySelector(".on_path_end");if(!h){s.scrollTop=e.length>0?99999:0;return}let _=h.offsetTop-s.offsetHeight/2+h.offsetHeight;s.scrollTo({behavior:"smooth",top:_})}),(()=>{var e=st();return B(s=>t=s,e),d(e,n(b,{get when(){return a.lala.tree},get fallback(){return[]},children:s=>n(M,{on_set_path:h=>a.lala.try_set_cursor_path(h),get cursor_path(){return a.lala.cursor_path},get hidden_paths(){return a.lala.hidden_paths},get revealed_paths(){return a.lala.revealed_paths},get solved_paths(){return a.lala.solved_paths},get failed_paths(){return a.lala.failed_paths},get lines(){return[s().root]}})})),e})()},M=a=>n(I,{get each(){return a.lines},children:t=>[n(_t,E({get data(){return t.data}},a)),n(G,{get children(){return[n(A,{get when(){return t.children.length===1},get children(){return n(M,E(a,{get lines(){return t.children}}))}}),n(A,{get when(){return t.children.length>1},get children(){var e=rt();return d(e,n(I,{get each(){return t.children},children:s=>(()=>{var h=lt();return d(h,n(M,E(a,{lines:[s],show_index:!0}))),h})()})),e}})]}})]}),_t=a=>{let t=`${Math.ceil(a.data.ply/2)}.`;a.data.ply%2===0&&(t+="..");let e=()=>a.cursor_path.join("").startsWith(a.data.path.join("")),s=()=>a.cursor_path.join("")===a.data.path.join(""),h=a.data.path.join(""),_=()=>a.hidden_paths.find(l=>l.join("")===h),o=()=>a.hidden_paths.find(l=>h.startsWith(l.join(""))),$=()=>a.revealed_paths.find(l=>l.join("")===h),m=()=>a.revealed_paths.find(l=>h.startsWith(l.join(""))),p=()=>a.failed_paths.find(l=>l.join("")===h),r=()=>a.solved_paths.find(l=>l.join("")===h),i=()=>["move",s()?"on_path_end":e()?"on_path":"",_()?"on_hidden_path_start":o()?"on_hidden_path":"",$()?"on_revealed_path_start":m()?"on_revealed_path":"",p()?"on_failed_path":"",r()?"on_solved_path":""].join(" ");return(()=>{var l=it();return l.$$click=()=>a.on_set_path(a.data.path),d(l,n(b,{get when(){return a.show_index||a.data.ply&1},get children(){var f=ht();return d(f,t),f}}),null),d(l,()=>a.data.san,null),N(()=>Q(l,i())),l})()};F(["click"]);var dt=c("<div class=progress><div class=bar></div><h3>"),ot=c("<div class=list-wrap><h1 class=header>Tactics</h1><div class=list><div><h3 class=title></h3></div><div><p>Current Run"),ct=c("<div class=repertoire>"),ut=c("<div class=board-wrap>"),pt=c("<h3>Puzzle solved."),ft=c("<button>Next Puzzle"),vt=c("<div class=replay-wrap><div class=replay-header><div class=title><h5></h5><h4>3/50</h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools>"),mt=c("<h3>Find the best line!"),gt=c("<button>View Solution");const k=class k{constructor(t,e){u(this,"attempt");this.puzzle=t,this.solution=e,this.attempt=R.make(e)}};u(k,"make",(t,e)=>new k(t,e));let q=k;const z=a=>(()=>{var t=dt(),e=t.firstChild,s=e.nextSibling;return d(s,()=>`${a.width}/${a.nb}`),N(h=>K(e,`width: ${a.width/a.nb*100}%`,h)),t})(),St=()=>{const a=V(),[t]=Y(a.id,X.read_study),[e,s]=v(0),h=W(()=>{var r;return(r=t())==null?void 0:r.chapters[e()]});let _=new Z,o=W(C(h,r=>{if(r){let i=q.make(r.pgn.puzzle,r.pgn.tree);return i.attempt.cursor_path=i.attempt.tree.root.data.path,i.attempt.hidden_paths=i.attempt.tree.root.children.map(l=>l.data.path),i}}));j(C(()=>_.add_uci,r=>{var i;r&&((i=o())==null||i.attempt.try_next_uci_fail(r))})),j(C(()=>{var r;return(r=o())==null?void 0:r.attempt.fen_last_move},r=>{if(r){let[i,l]=r;_.on_set_fen_uci(i,l)}})),j(C(()=>_.on_wheel,r=>{var i;r&&((i=o())==null||i.attempt.on_wheel(r))}));const $=()=>{s(e()+1)},m=()=>{var r;(r=o())==null||r.attempt.reveal_hidden_paths()},p=r=>{const i=r.target;i.tagName!=="PIECE"&&i.tagName!=="SQUARE"&&i.tagName!=="CG-BOARD"||(r.preventDefault(),_.set_on_wheel(Math.sign(r.deltaY)))};return(()=>{var r=ct();return r.addEventListener("wheel",p),d(r,n(b,{get when(){return!t.loading},fallback:"Loading...",get children(){var i=ot(),l=i.firstChild,f=l.nextSibling,g=f.firstChild,x=g.firstChild,y=g.nextSibling;return y.firstChild,d(x,()=>t().name),d(g,n(z,{width:3,nb:10}),null),d(y,n(z,{width:3,nb:50}),null),i}}),null),d(r,n(b,{get when(){return o()},children:i=>[(()=>{var l=ut();return d(l,n(tt,{get movable(){return!i().attempt.is_revealed},get doPromotion(){return _.promotion},get onMoveAfter(){return _.on_move_after},get fen_uci(){return _.fen_uci},get color(){return _.turnColor},get dests(){return _.dests}})),l})(),(()=>{var l=vt(),f=l.firstChild,g=f.firstChild,x=g.firstChild,y=g.nextSibling,L=y.firstChild,D=f.nextSibling,T=D.firstChild,O=T.nextSibling;return d(x,()=>t().name),d(T,n(nt,{get lala(){return i().attempt}})),d(O,n(b,{get when(){return i().attempt.is_revealed},get fallback(){return[mt(),(()=>{var w=gt();return w.$$click=m,w})()]},get children(){return[pt(),(()=>{var w=ft();return w.$$click=$,w})()]}})),N(()=>J(L,"href",`https://lichess.org/training/${i().puzzle}`)),l})()]}),null),r})()};F(["click"]);export{St as default};
