import{_ as It,H as Ee,a as M,m as ut,c as b,g as E,J as Bt,K as Wt,I as ee,L as ge,N as me,O as Ot,Q as Ut,x as de,r as Pe,n as B,b as he,t as S,T as tt,U as nt,V as Oe,W as _t,X as ft,Y as Ft,Z as zt,$ as Ht,d as He,C as Ue,q as Y,i as k,S as F,j as ue,k as Z,F as pt,M as K,h as Ge,v as $e,a0 as Gt,p as Vt,a1 as rt,a2 as be,a3 as Yt,u as ht,D as Ae,B as ce,o as Kt,a4 as lt,a5 as it}from"./index-CZL4b7iT.js";import{C as Qt}from"./chessground-lU4YbH_i.js";import{s as Xt}from"./scroll-DnAhRpRC.js";import{a as Jt}from"./random-BMCilaBQ.js";import{a as Zt}from"./annotationShapes-DeMXn7Uo.js";async function en(e){const n=await tn(e);function l(s){return n.transaction(e.store,s).objectStore(e.store)}function p(s){return new Promise((c,i)=>{const r=s();r.onsuccess=a=>c(a.target.result),r.onerror=a=>i(a.target.result)})}return{list:()=>p(()=>l("readonly").getAllKeys()),get:s=>p(()=>l("readonly").get(s)),getMany:s=>p(()=>l("readonly").getAll(s)),put:(s,c)=>p(()=>l("readwrite").put(c,s)),count:s=>p(()=>l("readonly").count(s)),remove:s=>p(()=>l("readwrite").delete(s)),clear:()=>p(()=>l("readwrite").clear()),cursor:(s,c)=>p(()=>l("readonly").openCursor(s,c)).then(i=>i??void 0),txn:s=>n.transaction(e.store,s)}}async function tn(e){const n=e?.db||`${e.store}--db`;return new Promise((l,p)=>{const s=window.indexedDB.open(n,e?.version??1);s.onsuccess=c=>l(c.target.result),s.onerror=c=>p(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const i=c.target.result,r=c.target.transaction,a=i.objectStoreNames.contains(e.store)?r.objectStore(e.store):i.createObjectStore(e.store);e.upgrade?.(c,a)}})}async function nn(e){let n;await rn({on_received:c,on_status(m){m&&(m.download&&e.on_downloaded_nb(m.download),m.error&&e.on_engine_failed(m.error))},on_connected(m){n=m}}),l("uci");function l(m){n?.(m)}function p(m){a=m,u()}function s(){return!!r&&!r.stop_requested&&!r.swap_requested}function c(m){const y=m.trim().split(/\s+/g);if(y[0]==="uciok")l("ucinewgame"),l("isready");else if(y[0]==="readyok")_();else if(!(y[0]==="id"&&y[1]==="name"))if(y[0]==="bestmove"){r&&h&&r.emit(h),r=void 0,_();return}else if(r&&!r.swap_requested&&!r.stop_requested&&y[0]==="info"){let v=0,$,x=1,A,T,N=!1,z,Q=[];for(let P=1;P<y.length;P++)switch(y[P]){case"depth":v=parseInt(y[++P]);break;case"nodes":$=parseInt(y[++P]);break;case"multipv":x=parseInt(y[++P]);break;case"time":A=parseInt(y[++P]);break;case"score":N=y[++P]==="mate",z=parseInt(y[++P]),(y[P+1]==="lowerbound"||y[P+1]==="upperbound")&&(T=y[++P]);break;case"pv":Q=y.slice(++P),P=y.length;break}if(N&&!z||(i<x&&(i=x),!Ee($)||!Ee(A)||!Ee(N)||!Ee(z)))return;const W=r.ply%2===1?-z:z;if(T&&x===1)return;const ne={moves:Q,cp:N?void 0:W,mate:N?W:void 0,depth:v};x===1?h={fen:r.current_fen,depth:v,nodes:$,millis:A,cp:N?void 0:W,mate:N?W:void 0,pvs:[ne]}:h&&(h.pvs.push(ne),h.depth=Math.min(h.depth,v)),x===i&&h&&(r.on_pvs(h),v>=40&&o())}else m&&!["Stockfish","id","option","info"].includes(y[0])&&console.warn(`SF: ${m}`)}let i=0,r,a,h;function _(){if(!r&&(r=a,a=void 0,r)){h=void 0,i=1,t("Threads",r.threads),t("Hash",r.hash_size||16),t("MultiPV",Math.max(1,r.multi_pv)),f&&f!==r.game_id&&l("ucinewgame"),f=r.game_id,l(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[m,y]=Object.entries(r.search)[0];l(`go ${m} ${y}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function t(m,y){y=y.toString(),d.get(m)!==y&&(l(`setoption name ${m} value ${y}`),d.set(m,y))}function o(){r&&!r.stop_requested&&(r.stop_requested=!0,l("stop"))}function u(){r&&!r.swap_requested&&(r.swap_requested=!0,l("stop")),l("isready")}let f;return{start(m){p(m)},stop(){p()},destroy(){l("quit")},get state(){return s()?"computing":"idle"}}}async function rn(e){const n=d=>{e.on_status(d)},l=d=>{e.on_received(d)},p=d=>{e.on_connected(d)};let s=await It(()=>import("./sf17-79-Kk0KEig0.js"),[]),c=await new Promise((d,t)=>{s.default({wasmMemory:ln(2560),onError:o=>t(new Error(o)),locateFile:o=>`stockfish/${o}`}).then(d).catch(t)}),i=await en({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let d=0;;d++){let t=c.getRecommendedNnue(d);if(!t||r.includes(t))break;r.push(t)}(await h(r)).forEach((d,t)=>c.setNnueBuffer(d,t)),c.onError=_(),c.listen=d=>l(d),p(d=>c.uci(d));async function h(d){return Promise.all(d.map(async t=>{let o=await i?.get(t).catch(()=>{});if(o&&o.byteLength>128*1024)return o;const u=new XMLHttpRequest;u.open("get",`stockfish/nnue/${t}`,!0),u.responseType="arraybuffer",u.onprogress=m=>n({download:{bytes:m.loaded,total:m.total}});const f=await new Promise((m,y)=>{u.onerror=()=>y(new Error(`fetch '${t}' failed: ${u.status}`)),u.onload=()=>{u.status/100===2?m(new Uint8Array(u.response)):y(new Error(`fetch '${t}' failed: ${u.status}`))},u.send()});return n(),i?.put(t,f).catch(()=>console.warn("IDB store failed")),f}))}function _(){return d=>{if(d.startsWith("BAD_NNUE")&&i){const t=Math.max(0,Number(d.slice(9))),o=c.getRecommendedNnue(t);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${o} from IDB`),i.remove(o)},2e3)}else n({error:d})}}}const ln=(e,n=32767)=>{let l=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:n})}catch(p){if(n<=e||!(p instanceof RangeError))throw p;n=Math.max(e,Math.ceil(n-n/l)),l=l===4?3:4}},Ve=Bt();function an(e){let[n,l]=M(void 0),[p,s]=M(void 0),[c]=ut(()=>nn({on_downloaded_nb(_){l(_)},on_engine_failed(_){s(_)}}));function i(_,d,t,o,u,f,m,y){let v=c();if(!v)return f(),()=>{};let $=Math.max(1,navigator.hardwareConcurrency-2);v.start({threads:$,hash_size:256,game_id:_,stop_requested:!1,swap_requested:!1,path:[],search:{depth:u},multi_pv:o,ply:t,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(A){y(A)},on_pvs:Wt(200,function(A){m(A)})})}let r={};function a(_,d,t,o,u,f,m,y){let v=[d,o,u].join("$$"),x=(()=>{let T=u===8?[20,8]:[20],N=o===1?[6,1]:[6];return T.flatMap(z=>N.map(Q=>[d,Q,z].join("$$")))})().find(T=>r[T]);x?y(r[x]):i(_,d,t,o,u,f,m,A);function A(T){r[v]=T,y(T)}}let h={get download_nb(){return n()},get engine_failed(){return p()},get state(){let _=c();return c.loading||!_?"loading":_.state},best_move_with_cache:a,stop(){c()?.stop()}};return b(Ve.Provider,{value:h,get children(){return E(()=>e.children)}})}const je={equals:!1};function se(e,n,l){let p=!1,s=!0;const[c,i]=M(void 0,je),r=E(o=>p?e(o):(s=!c(),o),n,je);let[a,h]=M(void 0,je),_;return[()=>(p=!0,s&&(s=i()),_=r(),p=!1,h(),_),()=>{if(a(),_)return _}]}var sn=S('<div class="is2d chessboard">');function on(){let[e,n]=M(ee),[l,p]=M(void 0),[s,c]=M(void 0),i=E(()=>ge.fromSetup(me(e()).unwrap()).unwrap()),r=E(()=>i().turn),a=E(()=>Ot(i()));const h=d=>{let t=i(),o=tt(d),u=nt(t,o);t.play(o),de(()=>{p([d,u]),c([d,u]),n(Oe(t.toSetup())),d.length})},_=d=>{if(!d){p(void 0);return}let t=nt(i(),tt(d));p([d,t])};return{play_orig_key(d,t){let o=i(),u=r(),f=o.board.get(Ut(d)),m=d+t;f.role==="pawn"&&(t[1]==="8"&&u==="white"||t[1]==="1"&&u==="black")&&(m+="q"),h(m)},play_uci:h,set_fen_and_last_move(d,t){de(()=>{_(t),n(d)})},set_fen(d){n(d)},set_last_move(d){_(d)},get dests(){return a()},get fen(){return e()},get last_move(){return l()},get on_last_move_added(){return s()},get check(){return i().isCheck()}}}function cn(e){let n,l;return Pe(()=>{let p=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:p,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};l=Qt(n,c)}),B(()=>{let p;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;p=[s.slice(0,2),s.slice(2,4)]}l.set({lastMove:p,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),B(()=>{l.setAutoShapes(e.shapes??[])}),(()=>{var p=sn();return he(s=>n=s,p),p})()}function gt(e,n,l,p){let s=_t(n,l),c=ft(s),i=Oe(n.toSetup());n.play(s);let r=Oe(n.toSetup());return{path:p.length===0?c:`${p} ${c}`,ply:e,before_fen:i,fen:r,uci:c,san:l}}function mt(e,n,l){let p=n[n.length-1];return l||(l=ge.fromSetup(me(p?.fen??ee).unwrap()).unwrap()),[...n,gt((p?.ply??0)+1,l,e,p?.path??"")]}function at(e,n=ee){let l=[],p=ge.fromSetup(me(n).unwrap()).unwrap();for(let s of e)l=mt(s,l,p);return l}function De(e,n){return[...e,...n]}function dn(e){let n=2,l=0,p=e[0];for(;n<=e.length-1&&l<2;)p===e[n]&&(l+=1),n+=2;return l===2}function Ne(e){return un(e)^_n(e)^fn(e)^pn(e)}function un(e){let n=0;return Ft.forEach(l=>{let p=e.board[l],s=hn[l];zt.forEach(c=>{let i=e.board[c],r=s[c];for(let a of p.intersect(i))n^=r[a]})}),n}function _n(e){return e.turn==="white"?gn:0}function fn(e){let n=0;return e.castles.rook.white.a!==void 0&&(n^=Me.white[0]),e.castles.rook.white.h!==void 0&&(n^=Me.white[1]),e.castles.rook.black.a!==void 0&&(n^=Me.black[0]),e.castles.rook.black.h!==void 0&&(n^=Me.black[1]),n}function pn(e){return e.epSquare!==void 0?mn[Ht(e.epSquare)]:0}let hn={black:{pawn:Array(2637767806,720845184,1155203408,2618685246,1971536997,848342074,263957791,3896152207,226391645,436746274,2516964848,3491888988,1086189917,18044180,1572111136,597658413,97624494,1738507407,1950989311,2098318769,2194108574,4079062812,856979699,1270058469,2858720366,2378012835,2278688587,435406673,3031118064,2063925420,3376753832,615148625,1285502018,346460119,2803604355,55085973,1669016372,164740250,896886403,1935551383,410153072,533441746,3541084098,3214426080,2675233103,1374411850,1552073989,4244110986,844343081,2356462440,3116133511,2129956651,299173332,1701379241,1306570996,2530644806,1122123979,1831591130,1116211970,1594837592,972591349,2479207924,1675376029,3960916618),knight:Array(1447259295,4021046128,3139524504,1173487682,2467266804,4284945151,2925674454,3710671816,2129465869,587093076,3373793513,2156648078,3737413652,468575139,1129551363,2861996892,2826449619,1704209531,3738359347,569410928,3021312909,2444777957,282063667,682545472,3318488457,1447622272,757420137,2613420942,4012836163,2938127093,1208226490,2935205706,430957978,1381578755,4109399782,288855589,3169178148,2644780093,107966643,1304747544,1359190711,3229237120,3027167685,3011615298,564135827,770797430,1983662611,4153656423,3609759233,3727911466,200708787,744508026,1213261630,3485747185,2958861301,2598470344,2767997908,3881113485,1773764017,4189435844,4234838742,2624081078,2395569449,1728307101),bishop:Array(2140891889,1482849818,751922730,3546542069,216179596,444615341,2424254530,1344234989,929188581,2507911009,980166547,3566535507,143525013,4181962471,1815842366,911175674,3591335374,1452686093,385158879,4011414929,1448477120,3971299641,3133647265,3007628400,1708345684,3031964479,3022128657,118850112,2048127371,3158349745,1505327237,2568424029,1866609495,844703982,3504617058,1448882679,821387540,3631471417,2077838877,3352949096,2491080787,3368630402,983299419,3651215291,265429091,3019003608,2955948456,903690197,3925215275,3959093811,2455088053,3115011301,1765081558,3324795129,3443871631,3152559950,3699649406,3129545774,2747044893,3925243406,164095314,2234471571,2164784335,159995093),rook:Array(3661248027,3705503008,914567990,3462935583,2878378006,1133857586,3023618742,282908558,3686955701,2604456805,3061545110,3218002352,2836503392,536836808,2886925079,2936593041,453815187,3042568989,3279635891,3282689058,4088968807,2680453086,1731693966,1842894553,2736377365,121205621,2324595870,3784465521,1958759409,1306150933,2636541290,1950415745,322077955,3602873262,1211684447,504701736,2407799203,1925743434,3617596327,2498480299,2680229135,3731399221,2756509305,2635957500,1372762539,802677945,1707760534,3714687192,1615679922,1940556374,445390489,2864974375,1984806574,513390958,744398315,982749166,652663695,1184061125,3363191899,1064069880,2138882964,2616926846,2298715513,2414381911),queen:Array(2065276,410498334,2726640512,2570984935,3008987264,623860175,3527183895,467272850,568376656,990477018,2366955227,4183621538,946958343,3395758993,1690887473,605184237,275515833,2142902612,2021972412,105373677,1666662384,1338566998,498685668,3101233780,2733370951,3656512268,4025308119,778896067,2846510368,3058428120,1892379383,2565895844,3213117192,2495816991,1040203361,3106252493,1639829808,3213709576,604681594,4236730699,4009938384,2701667332,2182473079,3550198211,657991062,1640976276,460041378,1972323596,2510248061,2959337826,1625877874,2070189957,4245163299,2358312347,275739390,2037777210,2766930226,1933485829,3034118011,2653025529,2641780289,3540781195,1569993599,441337890),king:Array(588133437,1139638106,982032635,562514827,467575086,1405117894,3813285157,3601878331,1586505598,738488098,2970334297,1068097019,235518094,283685722,2666392744,3569817788,2169728352,2444571896,3967907832,420376911,3046293305,2311278792,2885955184,3030078181,4212469731,1046900335,995380926,3892683234,615726237,3880203074,176180504,1474506861,1256707747,764236850,3521530334,2318567964,128167623,2220129756,2567608573,441446694,4143447316,817912603,2368091832,1187643061,3438021235,1318922279,434876457,1180291767,2520707785,1962430872,1510954061,57831539,3354831405,891783098,2555636406,2881342935,3473267445,1238029452,2051805420,3655936674,330209165,1929681327,1313566811,4283920930)},white:{pawn:Array(1398143232,133930885,1351827834,2076951437,435980918,1668970368,2185864314,2041407829,346864372,4047877822,3669961416,616810829,3144558884,216165387,2761740594,3919406634,669429112,2234904640,1421079802,1924213810,4002762044,2592451728,1890340057,4189625662,2276713138,2741429688,2924122950,421576781,2277442246,153237420,4278711886,2380848297,2618700582,3018992701,957243316,1543415220,504378001,2591337657,1333852064,1661259930,561112646,1536910315,1349168372,411152329,1694697476,3755185459,4019355068,2066937809,3120395808,94890149,3045629038,1249184265,3477490924,4114113436,1014604031,3991324799,2040431088,2253613964,2547464012,2722521980,71289574,2450408597,1894451515,1939968537),knight:Array(3309827454,2028172868,4271523049,146617804,2467685867,2483428231,3743260573,1002067894,3535252974,4154611160,3623154244,3646679180,862933752,2806008282,2734037942,1328176304,2278785213,381286368,2074232908,4087773386,967884669,4239349185,419231360,1275421624,1088456595,2365565249,1758083333,2048846183,2635948261,940630937,839474029,902477345,2836079689,2007115168,1363041891,1130479818,3644959908,1385135238,1386975934,2635987502,1915744629,487743653,2049219159,69242857,1511066720,215590039,1459430344,676103291,83799035,1949179493,2593534694,2283504289,1349412676,2954378677,249149717,1578231917,4135085182,461755528,3669622373,219487622,2825233742,2479105382,2582097898,1221328648),bishop:Array(599199451,3274759746,1192619331,2832721114,91404660,3044880024,3906596030,803516785,288455592,2143232492,388352703,2521731420,1043041227,3195290851,4166724431,1228226538,500177583,533367442,4236023256,413575568,3435884549,1004255532,2859513268,3914086821,3080761716,3571165255,773372954,769693293,3116440923,1687629160,2489486648,3686847158,3530767427,2121652637,1827477891,2549918411,2071415163,2236083679,2040110303,3489536313,2190878435,2465915458,1675766804,3329799896,1483966600,159505618,2674227354,2683539437,3833196123,3891433165,1455453349,1430583255,2067726741,303380021,2136024795,2054591852,1029141665,2317027384,2068461795,2499875684,1302894490,1002663431,1560941298,2141002286),rook:Array(2694745228,4202576185,3602305260,3756663274,3061587876,3390977925,486312941,3515712841,1322319486,3839619171,392296762,1401523788,1934485528,645968162,696971825,2038689491,1723966113,2652365974,3988018407,1354171594,1287854075,1723106141,563845090,639520332,534957223,3612364282,3109494688,500957989,3477030536,4109750364,951472732,922095147,3946156928,2622281253,2936811901,630086272,2340986210,4107355543,3560210278,3868847493,611513888,3265390517,2874106961,1668707698,2778598353,292356118,754567370,185141877,2884558258,1492107531,3336927864,782994598,346133860,2080909533,3612065399,2151962287,3957975594,52533817,1232633839,2716413964,1531307298,3030137657,3561556693,313061910),queen:Array(1878946792,3724105660,1691411102,148741087,142506469,3811107376,472209891,1913386482,2960608550,1145005292,1091751784,3625186042,1712140887,1504455800,3896940088,2478191531,3233871270,3404865229,1462204167,1349259705,3627860584,1244251718,3979211282,3043187861,581894202,1390895705,2599134010,2488233440,1816641224,1792034756,2779893723,2084952115,1351806869,2469979804,1163545420,1795352113,1796715044,3521170642,3725363621,1342594643,2618386938,2028859350,1841905045,4002935891,850071259,979915719,830889197,1744763229,522919199,3063822504,2861636095,4097602344,4215946617,894485042,924809191,1811585710,3439653887,3810997538,2677100683,77233985,4239834691,148802076,2409138150,3048474397),king:Array(1438004300,3093439067,3401620219,3673745794,3053321309,822915968,3900685126,553823814,4166295066,128359165,3300989119,4193552686,452189154,4122259632,2519387887,74333898,4032631446,2521268686,2620314688,1378755571,394133753,734399075,573292462,1214417373,2110224475,2331215665,531326186,3839443603,2644531398,616620850,590349237,3582377217,1582708616,2126148205,173450736,3616831144,2655785577,401600069,496349349,2479612086,1710903074,3589924952,3266682943,1496318498,3459221058,2091479615,663040899,3323704225,353318429,2674540957,1688550857,338551967,204689992,178008789,3871613304,1911672356,4055679954,3878217928,2533095482,2174833823,1604814460,1452830254,2441027029,3524103304)}},gn=4174784170,Me={black:Array(2776523577,519497435),white:Array(836181454,4049974663)},mn=Array(1892447193,3793382197,3838936,479846099,3476112862,3504620154,2009473484,1738755500);var vn=S("<div class=replay-single><div class=moves></div><div class=sharpness><span class=label>Sharpness:</span> "),yn=S("<span class=index>"),bn=S("<span><span class=san>"),wn=S('<span class="word safe">Safe <small>(+5 moves maintains eval)'),$n=S('<span class="word playable">Playable <small>(3-4 moves maintains eval)'),kn=S('<span class="word sharp">Sharp <small>(2 moves maintains eval)'),xn=S('<span class="word critical">Critical <small>(Only 1 move maintains eval)'),st=S("<span class=eval>"),ot=S("<span class=loading>."),Sn=S("<span class=judgement>");function pe(e){return ge.fromSetup(me(e).unwrap()).unwrap()}function Cn(){let[e,n]=M([]),[l,p]=M([]);const s=E(()=>{let v=l();return v[v.length-1]});let[c,i]=M(s()?.ply??0);const r=E(()=>{let v=c();return l().find(x=>x.ply===v)});let a=E(Ue(l,v=>v.san)),h=E(Ue(l,v=>v.ply)),_=E(()=>{let v=a(),$=h();return v.map((x,A)=>`${$[A]} ${x}`)});const d=v=>{i(v)},t=()=>{let v=c()-1;return h().find($=>$===v)},o=()=>{let v=c()+1;return h().find($=>$===v)},u=E(()=>dn(e())),f=E(()=>{let v=s();return v?pe(v.fen).isStalemate():!1}),m=E(()=>{let v=s();return v?pe(v.fen).isCheckmate():!1}),y=E(()=>{let v=s();return v?pe(v.fen).isInsufficientMaterial():!1});return{set_sans(v){p(at(v)),i(v.length);let $=l();n($.reduce((x,A)=>De([Ne(pe(A.fen))],x),[]))},get steps(){return l()},get steps_up_to_ply(){return l().slice(0,c())},get plies(){return h()},get sans(){return a()},get ply_sans(){return _()},get ply_step(){return r()},get last_step(){return s()},get ply(){return c()},goto_ply:d,get_prev_ply:t,get_next_ply:o,goto_prev_ply_if_can(){let v=t();v!==void 0&&d(v),c()===1&&i(0)},goto_next_ply_if_can(){let v=o();v!==void 0&&d(v)},play_san(v){let $=s();if(!$){p(at([v]));let A=l();n(A.reduce((T,N)=>De([Ne(pe(N.fen))],T),[])),i(s().ply);return}let x=l();p(mt(v,x)),$=s(),n(De([Ne(pe($.fen))],e())),i($.ply)},get is_on_last_ply(){return c()===(s()?.ply??0)},get is_threefold(){return u()},get is_checkmate(){return m()},get is_stalemate(){return f()},get is_insufficient(){return y()}}}function En(e){const n=E(Ue(()=>e.play_replay.ply_sans,i=>{let[r,a]=i.split(" ");return{ply:parseInt(r),san:a}})),l=i=>{e.play_replay.goto_ply(i)},p=E(()=>e.play_replay.ply_step?.ply);B(Y(()=>e.play_replay.steps,i=>e.steps_stockfish.set_steps(i)));let s;const c=i=>{let r=e.steps_stockfish.steps_with_stockfish[i];if(!r)return"";let a=r.d20pv6[1](),h=r.d20pv1[1](),_=r.d8pv6[1](),d=r.d8pv1[1]();if(a)return(a.judgement??"")+" d20pv6";if(h)return(h.judgement??"")+" d20pv1";if(_)return(_.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return B(()=>{if(n().length<7)return;let r=s.parentElement,a;if(e.play_replay.ply<3)a=0;else if(e.play_replay.is_on_last_ply)a=99999;else{let h=r.querySelector(".active");h&&(a=h.offsetTop-s.offsetHeight/2+h.offsetHeight/2)}a!==void 0&&(s.scrollTop=a)}),(()=>{var i=vn(),r=i.firstChild,a=r.nextSibling,h=a.firstChild;return h.nextSibling,he(_=>s=_,r),k(r,b(pt,{get each(){return n()},children:(_,d)=>[b(F,{get when(){return _.ply%2===1},get children(){var t=yn();return k(t,()=>Math.ceil(_.ply/2)),t}}),(()=>{var t=bn(),o=t.firstChild;return t.$$click=()=>l(_.ply),t.$$contextmenu=u=>{u.preventDefault(),e.on_context_menu(u,_.ply)},k(o,()=>_.san),k(t,b(F,{get when(){return e.steps_stockfish.steps_with_stockfish[d()]},children:u=>b(An,{get ss(){return u()}})}),null),ue(()=>Z(t,"move "+c(d())+(_.ply===p()?" active":""))),t})()]})),k(a,b(Mn,{get sharpness(){return e.last_step_sharpness}}),null),i})()}function Mn(e){return b(Ge,{get children(){return[b(K,{get when(){return e.sharpness===void 0},children:"..."}),b(K,{get when(){return e.sharpness&&e.sharpness>=5},get children(){return wn()}}),b(K,{get when(){return e.sharpness===3||e.sharpness===4},get children(){return $n()}}),b(K,{get when(){return e.sharpness===2},get children(){return kn()}}),b(K,{get when(){return e.sharpness===1},get children(){return xn()}})]}})}function An(e){return b(Ge,{get fallback(){return b(we,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[b(K,{get when(){return e.ss.d20pv6[1]()},children:n=>b(we,{get step(){return n()}})}),b(K,{get when(){return e.ss.d20pv1[1]()},children:n=>b(we,{get step(){return n()}})}),b(K,{get when(){return e.ss.d8pv6[1]()},children:n=>b(we,{get step(){return n()}})}),b(K,{get when(){return e.ss.d8pv1[1]()},children:n=>b(we,{get step(){return n()}})})]}})}const vt=e=>e==="top"?"!":e==="ok"?"✓":e==="inaccuracy"?"?!":e==="mistake"?"?":"??";function we(e){const n=()=>e.step.search?.cp,l=()=>e.step.judgement,p=()=>e.step.progress?.depth;return(()=>{var s=st();return k(s,b(F,{get when(){return n()!==void 0},get fallback(){return(()=>{var c=ot();return c.firstChild,k(c,p,null),c})()},get children(){var c=st();return k(c,()=>Pn(n())),c}}),null),k(s,b(F,{get when(){return l()},get fallback(){return ot()},children:c=>(()=>{var i=Sn();return k(i,()=>vt(c())),i})()}),null),s})()}function Pn(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}He(["contextmenu","click"]);var Ie=Symbol("fallback");function ct(e){for(const n of e)n.dispose()}function yt(e,n,l,p={}){const s=new Map;return $e(()=>ct(s.values())),()=>{const i=e()||[];return i[Gt],Vt(()=>{if(!i.length)return ct(s.values()),s.clear(),p.fallback?[rt(d=>(s.set(Ie,{dispose:d}),p.fallback()))]:[];const r=new Array(i.length),a=s.get(Ie);if(!s.size||a){a?.dispose(),s.delete(Ie);for(let _=0;_<i.length;_++){const d=i[_],t=n(d,_);c(r,d,_,t)}return r}const h=new Set(s.keys());for(let _=0;_<i.length;_++){const d=i[_],t=n(d,_);h.delete(t);const o=s.get(t);o?(r[_]=o.mapped,o.setIndex?.(_),o.setItem(()=>d)):c(r,d,_,t)}for(const _ of h)s.get(_)?.dispose(),s.delete(_);return r})};function c(i,r,a,h){rt(_=>{const[d,t]=M(r),o={setItem:t,dispose:_};if(l.length>1){const[u,f]=M(a);o.setIndex=f,o.mapped=l(d,u)}else o.mapped=l(d);s.set(h,o),i[a]=o.mapped})}}function Ln(e){const{by:n}=e;return E(yt(()=>e.each,typeof n=="function"?n:l=>l[n],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var Rn=S("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),bt=S("<span class=index>"),Tn=S("<div class=fbt>"),qn=S("<div class=lines>"),jn=S("<div class=line>"),Dn=S("<span class=collapsed>..<!> "),Nn=S("<div>");function In(e){return Yt(e).map(n=>{let l=n.headers.get("Event"),p=n.headers.get("Site"),s=n.headers.get("White"),c=n.headers.get("Black"),i=n.headers.get("Chapter"),r=n.headers.get("Orientation"),a=n.headers.get("FEN"),h=a??ee,_=ge.fromSetup(me(h).unwrap()).unwrap(),d=wt();n.moves.children.forEach(o=>{t(o,_,"")});function t(o,u,f){let m=o.data.san,y=_t(u,m),v=u.clone();v.play(y);let $=ft(y),x=o.data.nags;d.add_child_san(f,m).set_nags(x??[]);let A=f.length===0?$:`${f} ${$}`;o.children.forEach(T=>{t(T,v,A)})}return{event:l,site:p,white:s,black:c,chapter:i,fen:a,orientation:r,tree:d}})}function wt(){let[e,n]=M([]);const l=i=>p(i)?.[1],p=i=>{if(i==="")return;let r=i.split(" "),a=0,h,_=e();for(;;){let d=r.slice(0,a+1).join(" "),t=_.find(o=>o.path===d);if(!t)return;if(a++,a===r.length)return[h,t];h=t,_=t.children}};function s(i,r=!1){let a=i.ply,h=a%2===1||r?Math.ceil(a/2)+(a%2===1?".":"..."):"",_=a%2===1?"":" ";return`${h} ${i.san}${i.comments?" { "+i.comments+" }":""}${_}`}function c(i,r=!1){let a="";return i.length===0||(i.length===1?(a+=s(i[0].step,r),a+=c(i[0].children,!1)):(a+=s(i[0].step,!1).trimEnd(),a+=" "+i.slice(1).map(h=>`(${c([h],!0).trimEnd()})`).join(" "),a+=" "+c(i[0].children,!0))),a}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(i){if(i.length===0)return[];let r=i[0],a=this.add_child_san("",r),h=[a];return i.slice(1).forEach(_=>{a=a.add_child_san(_),h.push(a)}),h},add_child_san(i,r){if(i===""){let h=e(),_=h.find(o=>o.san===r);if(_)return _;let d=ge.fromSetup(me(ee).unwrap()).unwrap(),t=$t(0,d,r,"");return n([...h,t]),t}let a=l(i);if(a)return a.add_child_san(r)},remove_child_at_path(i){let r=p(i);if(r){if(!r[0]){let a=e(),h=a.indexOf(r[1]);return a.splice(h,1),n([...a]),r[1]}return r[0].remove_child(r[1]),r[1]}},find_at_path:l,find_parent_and_child_at_path:p,siblings_of(i){let r=p(i)?.[0];if(r)return r.children;if(i.split(" ").length===1)return e()},previous_branch_points(i){let r=[],a=e(),h=a.length>1;for(let _ of i.split(" ")){let d=a.find(t=>t.step.uci===_);if(!d)return;h&&(r.push(d),h=!1),d.children.length>1&&(h=!0),a=d.children}return r}}}function $t(e,n,l,p){let[s,c]=M([]),[i,r]=M([]);n=n.clone();let a=gt(e,n,l,p),h=()=>_()?.length??0,_=()=>d()?.children,d=()=>{let o=s();if(o.length!==0)return o.length===1?o[0].first_node_with_variations:t},t={get nags(){return i()},set_nags:r,get path(){return a.path},get ply(){return a.ply},get san(){return a.san},step:a,get children(){return s()},remove_child(o){let u=s(),f=u.indexOf(o);if(f!==-1)return u.splice(f,1),c([...u]),o},add_child_san(o){let u=s(),f=u.find(y=>y.san===o);if(f)return f;let m=$t(e+1,n,o,a.path);return c([...u,m]),m},remove_child_san(o){let u=s(),f=u.findIndex(y=>y.step.san!==o);if(f===-1)return;let m=u.splice(f,1)[0];return c([...u]),m},get nb_first_variations(){return h()},get first_node_with_variations(){return d()},get length(){let o=s();if(o.length>1)return 1;if(o.length===0)return 0;let u=1,f=o[0];for(;f?.children.length===1;)u++,f=f.children[0];return u}};return t}function Bn(e){let n=wt();e&&(n=In(e)[0].tree);let[l,p]=M(""),s=[];B(Y(l,t=>{n.previous_branch_points(t)?.map(o=>{s.includes(o.path)||(n.siblings_of(o.path)?.forEach(u=>{s=s.filter(f=>f!==u.path)}),s.push(o.path))})}));const c=t=>{p(t)},i=()=>{let t=l();if(t!=="")return t.split(" ").slice(0,-1).join(" ")},r=()=>{let t=l(),o=n.find_at_path(t)?.children??n.root;return o.length===1?o[0].path:o.find(u=>s.includes(u.path))?.path??o[0]?.path},a=()=>{let t=n.find_parent_and_child_at_path(l());if(!t)return;let o=t;if(!o[0])return"";if(o[0].children.length>1)return o[0].path;for(;!(!o[0]||o[0].children.length>1);){let u=n.find_parent_and_child_at_path(o[0].path);if(!u)break;o=u}return o[1].path},h=()=>{let t=n.find_at_path(l());if(!t)return n.root.find(u=>s.includes(u.path))?.path??n.root[0]?.path;let o=t;if(o.children.length>1)return o.children.find(u=>s.includes(u.path))?.path??o.children[0]?.path;for(;o.children.length===1;)o=o.children[0];return o.path},_=()=>{let t=n.find_parent_and_child_at_path(l());if(!t)return;let o=t[0]?.children??[];if(!t[0])o=n.root;else if(t[0].children.length===1)for(;;){if(t=n.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){o=n.root;break}if(t[0].children.length>1){o=t[0].children;break}}let u=o.indexOf(t[1]),f=o[u-1];if(f)return f.path},d=()=>{let t=n.find_parent_and_child_at_path(l());if(!t)return;let o=t[0]?.children??[];if(!t[0])o=n.root;else if(t[0].children.length===1)for(;;){if(t=n.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){o=n.root;break}if(t[0].children.length>1){o=t[0].children;break}}let u=o.indexOf(t[1]),f=o[u+1];if(f)return f.path};return{steps:n,get cursor_path(){return l()},set cursor_path(t){p(t)},get cursor_path_step(){return n.find_at_path(l())?.step},goto_path:c,get_prev_path:i,get_next_path:r,goto_prev_if_can(){let t=i();t!==void 0&&c(t)},goto_next_if_can(){let t=r();t!==void 0&&c(t)},get_first_path:a,get_last_path:h,get_up_path:_,get_down_path:d,goto_up_if_can(){let t=_();t!==void 0&&c(t)},goto_down_if_can(){let t=d();t!==void 0&&c(t)},goto_last_if_can(){let t=h();t!==void 0&&c(t)},goto_first_if_can(){let t=a();t!==void 0&&c(t)},get previous_branch_points_at_cursor_path(){return n.previous_branch_points(l())??[]}}}function Wn(e){const n=e.play_replay.steps;let l;B(()=>{let s=e.play_replay.cursor_path,c=l.parentElement;if(!c)return;const i=l.querySelector(".on-path-end");if(!i){c.scrollTop=s.length>0?99999:0;return}let r=i.offsetTop-c.offsetHeight/2+i.offsetHeight;c.scrollTo({behavior:"smooth",top:r})});const p=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return Pe(()=>{document.addEventListener("keydown",p),$e(()=>{document.removeEventListener("keydown",p)})}),(()=>{var s=Rn(),c=s.firstChild,i=c.firstChild,r=c.nextSibling,a=r.firstChild,h=a.nextSibling,_=r.nextSibling,d=_.firstChild,t=d.nextSibling,o=t.nextSibling,u=o.nextSibling;return he(f=>l=f,i),k(i,b(Fe,{get nodes(){return n.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:f=>e.play_replay.cursor_path=f,on_context_menu:(f,m)=>e.on_context_menu?.(f,m)})),a.$$click=()=>e.play_replay.goto_up_if_can(),h.$$click=()=>e.play_replay.goto_down_if_can(),k(r,b(pt,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:f=>(()=>{var m=Tn();return m.$$click=()=>e.play_replay.cursor_path=f.path,k(m,b(F,{get when(){return f.ply&1},get children(){var y=bt();return k(y,()=>ze(f.ply)),y}}),null),k(m,()=>f.san,null),m})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),t.$$click=()=>e.play_replay.goto_prev_if_can(),o.$$click=()=>e.play_replay.goto_next_if_can(),u.$$click=()=>e.play_replay.goto_last_if_can(),ue(f=>{var m=e.play_replay.get_up_path()===void 0,y="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),v=e.play_replay.get_down_path()===void 0,$="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),x=e.play_replay.get_first_path()===void 0,A="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),T=e.play_replay.get_prev_path()===void 0,N="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),z=e.play_replay.get_next_path()===void 0,Q="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),ae=e.play_replay.get_last_path()===void 0,W="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return m!==f.e&&(a.disabled=f.e=m),y!==f.t&&Z(a,f.t=y),v!==f.a&&(h.disabled=f.a=v),$!==f.o&&Z(h,f.o=$),x!==f.i&&(d.disabled=f.i=x),A!==f.n&&Z(d,f.n=A),T!==f.s&&(t.disabled=f.s=T),N!==f.h&&Z(t,f.h=N),z!==f.r&&(o.disabled=f.r=z),Q!==f.d&&Z(o,f.d=Q),ae!==f.l&&(u.disabled=f.l=ae),W!==f.u&&Z(u,f.u=W),f},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function Fe(e){return[b(F,{get when(){return e.nodes.length===1},get children(){return[b(Be,be(e,{get node(){return e.nodes[0]}})),b(Fe,be(e,{get nodes(){return e.nodes[0].children}}))]}}),b(F,{get when(){return e.nodes.length>1},get children(){var n=qn();return k(n,b(Ln,{get each(){return e.nodes},by:"path",children:l=>(()=>{var p=jn();return k(p,b(F,{get when(){return e.cursor_path.startsWith(l().path)},get fallback(){return[b(Be,be(e,{get node(){return l()},show_index:!0,collapsed:!0})),(()=>{var s=Dn(),c=s.firstChild,i=c.nextSibling;return i.nextSibling,k(s,()=>l().length,i),k(s,()=>l().nb_first_variations,null),s})()]},get children(){return[b(Be,be(e,{get node(){return l()},show_index:!0})),b(Fe,be(e,{get nodes(){return l().children}}))]}})),p})()})),n}})]}function Be(e){let n=E(()=>e.node.ply%2===0||e.show_index),l=E(()=>e.node.ply%2===0?".":"...");const p=E(()=>e.node.path),s=E(()=>e.cursor_path.startsWith(p())),c=E(()=>p()===e.cursor_path),i=E(()=>{let r=["move"];return e.collapsed&&r.push("collapsed"),s()&&r.push("on-path"),c()&&r.push("on-path-end"),r.join(" ")});return(()=>{var r=Nn();return r.$$click=()=>{e.on_set_cursor(e.node.path)},r.$$contextmenu=a=>{a.preventDefault(),e.on_context_menu(a,e.node.path)},k(r,b(F,{get when(){return n()},get children(){var a=bt();return k(a,()=>Math.floor(e.node.ply/2)+1,null),k(a,l,null),a}}),null),k(r,()=>e.node.san,null),ue(()=>Z(r,i())),r})()}const ze=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");He(["click","contextmenu"]);const On=(e,n)=>e==="white"?n:-n,kt=e=>2/(1+Math.exp(-.00368208*e))-1,Un=e=>kt(Math.min(Math.max(-1e3,e),1e3)),Fn=e=>{const l=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return kt(l)},zn=e=>typeof e.mate<"u"?Fn(e.mate):Un(e.cp),dt=(e,n)=>On(e,zn(n)),Hn=(e,n,l)=>(dt(e,n)-dt(e,l))/2,Gn=(e,n,l)=>Hn(e,n,l),ie=8;function Vn(){let e=ht(Ve);function n(u,f,m,y,v,$,x){e.best_move_with_cache(a(),u,f,m,y,v,$,x)}let l,p=[];function s(u,f,m,y){let[v,$]=M(void 0),[x,A]=M(void 0),[T,N]=M(void 0),z={get loading(){return v()},get depth_eval(){return x()},get best_eval(){return T()},cancel:ae},Q={cancel:ae,fen:u,ply:f,depth:m,multi_pv:y,set_loading:$,set_depth_eval:A,set_best_eval:N};function ae(){let W=p.indexOf(Q);W!==-1&&p.splice(W,1),l===Q&&(console.trace("working cancel"),l=void 0,e.stop()),c()}return p.push(Q),c(),z}function c(){if(l||(l=p.pop(),!l))return;const u=f=>{l?.set_best_eval(f),l=void 0,c()};n(l.fen,l.ply,l.multi_pv,l.depth,l.set_loading,l.set_depth_eval,u)}function i(u,f,m){let y=s(u.before_fen,u.ply-1,f,m),v=s(u.fen,u.ply,f,m);function $(x,A,T){let N=Gn(x,A,T);return N<.02?"top":N<.03?"ok":N<.05?"inaccuracy":N<.12?"mistake":"blunder"}return E(()=>($e(()=>{v.cancel(),y.cancel()}),{...u,get before_search(){return y.best_eval},get search(){return v.best_eval},get judgement(){let x=y.best_eval,A=v.best_eval;if(x&&A)return $(Ae(u.before_fen),x,A)},get progress(){return v?.depth_eval}}))}function r(u){let[f,m]=M(se(()=>i(u,ie,6)())),[y,v]=M(se(()=>i(u,ie,1)())),[$,x]=M(se(()=>i(u,20,6)())),[A,T]=M(se(()=>i(u,20,1)()));return{step:u,get d8pv6(){return f()},get d8pv1(){return y()},get d20pv6(){return $()},get d20pv1(){return A()},clear(){m(se(()=>i(u,ie,6)())),x(se(()=>i(u,20,6)())),v(se(()=>i(u,ie,1)())),T(se(()=>i(u,20,1)()))}}}let[a,h]=M(""),[_,d]=M([]),t=yt(_,u=>[u.fen,u.uci].join("$$"),u=>r(u())),o=r({before_fen:ee,fen:ee,path:"",ply:0,san:"",uci:""});return{set_game_id:h,set_steps:d,get steps_with_stockfish(){return t()},get initial_step(){return o}}}var Yn=S('<div class=info><h2>Repertoire Builder</h2><p>Play against the engine. Select your difficulty with skill setting. Engine always selects among the top 6 moves.</p><p>Game ends when the evaluation drops below -2 for the player.</p><p>You will see the latest evaluation and the accuracy of the moves in the move replay.</p><p>You can save your played lines for building up your repertoire, and practice against later.</p><p>You can tell the engine to stick to playing a specific line you have already played.</p><p>Right click on the moves to open settings for that move. Switch between "Match" and "Repertoire" tabs.</p><p>The goal is to find the top moves only, and play as long as you can, and repeat as much as possible.</p><small> We recommend selecting the "Third" skill level for starters. Thus it will make some sub optimal moves, well suited for about 1800 lichess rated player. Later you can select "Top" option for GM level opening preparation.</small><p class=right>Have fun!'),Kn=S("<div class=welcome>"),Qn=S(`<div class="start info"><button class=button>New Game</button><div class=hide-box><label for=hide>Don't show this again</label><input id=hide type=checkbox>`),Xn=S("<p class=loading><span class=info>Loading Engine <!>%"),Jn=S("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth </label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),Zn=S("<span class=result>Game Over"),er=S("<small class=drop>Evaluation Dropped Below -2"),tr=S("<span class=result>Checkmate"),nr=S("<small class=drop>Victory is <span class=victory>"),rr=S("<span class=result>Stalemate"),We=S("<small class=drop>Game is a draw"),lr=S("<span class=result>3 Fold Repetition"),ir=S("<span class=result>Insufficient Material"),ar=S("<div class=result-wrap>"),sr=S("<div class=tools-wrap><button class=rematch>Rematch</button><button><i>"),or=S("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=header><div class=tabs-wrap><div>Match</div><div>Repertoire</div></div><i data-icon=>"),cr=S("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=delete data-icon=>Delete move"),dr=S("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=save data-icon=>Save this line</a><a class=analyze data-icon=>Analyze on lichess");const yr=()=>b(an,{get children(){return b(_r,{})}});function ur(){return Yn()}function _r(){let[e]=ut(()=>ht(Ve));const n=E(()=>{if(e()?.state==="idle")return;let i=e()?.download_nb;if(i)return Math.ceil(i.bytes/(i.total===0?70*1024*1024:i.total)*100)}),[l,p]=ce(!1,"builder.show_welcome_page"),[s,c]=M(!l());return b(F,{get when(){return e()},children:i=>b(F,{get when(){return i().state==="loading"||s()},get fallback(){return b(fr,{on_welcome_page:()=>c(!0)})},get children(){var r=Kn();return k(r,b(ur,{}),null),k(r,b(F,{get when(){return n()},get fallback(){return(()=>{var a=Qn(),h=a.firstChild,_=h.nextSibling,d=_.firstChild,t=d.nextSibling;return h.$$click=()=>c(!1),t.addEventListener("change",o=>p(o.currentTarget.checked)),ue(()=>t.checked=l()),a})()},children:a=>(()=>{var h=Xn(),_=h.firstChild,d=_.firstChild,t=d.nextSibling;return t.nextSibling,k(_,a,t),h})()}),null),r}})})}function fr(e){const n=Kt();n.setVolume(.2);let[l,p]=ce([],"builder.current.sans");const[s,c]=M(ie);let i="";const r=Vn(),a=Cn();let h=on();const[_,d]=ce("white","builder.player_color"),t=E(()=>lt(_())),o=E(()=>{let g=a.ply;return r.steps_with_stockfish.find(j=>j.step.ply===g)}),u=E(()=>{let g=r.steps_with_stockfish;return g[g.length-1]});function f(g){return s()===ie?g.d8pv6:g.d20pv6}function m(g){return s()===ie?g.d8pv1[0]():g.d20pv1[0]()}const[y,v]=M(1);de(()=>{r.set_game_id(i),a.set_sans(l()),$()});function $(){clearTimeout(y()),v(setTimeout(()=>{v(void 0)},710))}B(()=>{if(y()!==void 0||W()!==void 0)return;let w=u();if(!w)if(t()==="white")w=r.initial_step;else return;if(Ae(w.step.fen)===t()){let q=Rt();if(q&&q.startsWith(w.step.path)){let L=q.slice(w.step.path.length).trim().split(" ")[0];if(L){h.play_uci(L);return}}let U=f(w)[0]();B(Y(()=>U.search,L=>{if(!L)return;let G=L.cp,J=L.pvs,C=L.pvs.filter(D=>Math.abs(D.cp-G)<=10),R=L.pvs.filter(D=>Math.abs(D.cp-G)<=30),I=L.pvs.filter(D=>Math.abs(D.cp-G)<=60),V=L.pvs.filter(D=>Math.abs(D.cp-G)<=100),te=L.pvs.filter(D=>Math.abs(D.cp-G)<200),H=C.filter(D=>D.cp<150),X=R.filter(D=>D.cp<150),fe=I.filter(D=>D.cp<150),Se=V.filter(D=>D.cp<150),Te=te.filter(D=>D.cp<150);function oe(D){return D.find(qe=>qe.length>0)}let le;switch(_e()){case"A":le=oe([H,C,J]);break;case"B":le=oe([X,H,C,R,J]);break;case"C":le=oe([fe,X,H,C,R,I,J]);break;case"D":le=oe([Se,fe,X,H,C,R,I,V,J]);break;case"E":le=oe([Te,Se,fe,X,H,C,R,I,V,te,J]);break}h.play_uci(Jt(le).moves[0])}))}}),B(Y(()=>h.on_last_move_added,g=>{g&&de(()=>{$(),a.play_san(g[1])})})),B(Y(()=>a.sans,p)),B(Y(()=>a.ply_step,g=>{h.set_fen_and_last_move(g?.fen??ee,g?.uci)})),B(Y(()=>a.ply_step,(g,w)=>{g&&(!w||w.ply===g.ply-1)&&n.move(g)}));const x=Xt(g=>{const w=g.target;w.tagName!=="PIECE"&&w.tagName!=="SQUARE"&&w.tagName!=="CG-BOARD"||(g.preventDefault(),A(Math.sign(g.deltaY)))}),A=g=>{g>0?(re()==="match"&&a.goto_next_ply_if_can(),re()==="repertoire"&&P.goto_next_if_can()):(re()==="match"&&a.goto_prev_ply_if_can(),re()==="repertoire"&&P.goto_prev_if_can())},T=(g=_())=>{de(()=>{d(g),p([]),a.set_sans(l()),h.set_fen_and_last_move(ee),ne(void 0),$()})};B(Y(s,()=>{r.steps_with_stockfish.forEach(w=>{de(()=>{w.clear(),m(w)})});let g=u();g&&f(g)[0]()})),B(Y(u,g=>{if(!g)return;let w=m(g);B(Y(()=>w.search,j=>{let q=j?.cp;q&&(_()==="white"&&q<-200||_()==="black"&&q>200)&&ne("drop")}))})),B(()=>{let g=a.is_checkmate,w=a.is_stalemate,j=a.is_threefold,q=a.is_insufficient;g&&ne("checkmate"),w&&ne("stalemate"),j&&ne("threefold"),q&&ne("insufficient")});let[N,z]=ce("","builder.current.cursor_path"),[Q,ae]=ce(void 0,"builder.current.pgn");const[W,ne]=M(void 0),P=Bn(Q());P.cursor_path=N(),B(Y(()=>P.cursor_path,g=>{z(g)})),B(Y(()=>P.cursor_path_step,g=>{g?h.set_fen_and_last_move(g.fen,g.uci):h.set_fen_and_last_move(ee)}));const xt=g=>{de(()=>{ye(void 0),g&&a.goto_ply(g);let j=a.steps_up_to_ply.map(L=>L.san),q=P.steps.add_sans_at_root(j),U=q[q.length-1]?.path;U&&(Le("repertoire"),P.cursor_path=U,ae(P.steps.as_pgn))})},[re,Le]=M("match");B(Y(re,g=>{let w=g==="repertoire"?P.cursor_path_step:a.ply_step;w?h.set_fen_and_last_move(w.fen,w.uci):h.set_fen_and_last_move(ee)}));let Re,ke;const St=(g,w)=>{P.cursor_path=w,ve(P.steps.find_at_path(w));let j=g.clientX,q=g.clientY,U=ke.getBoundingClientRect(),L=Re.getBoundingClientRect();j-=L.left,q-=L.top,j=Math.min(j,document.body.clientWidth-U.width-L.left-20);let G=`${q}px`,J=`${j}px`;ke.style.top=G,ke.style.left=J};let xe;const Ct=(g,w)=>{a.goto_ply(w),ye(a.ply_step);let j=g.clientX,q=g.clientY,U=xe.getBoundingClientRect(),L=Re.getBoundingClientRect();j-=L.left,q-=L.top,j=Math.min(j,document.body.clientWidth-U.width-L.left-20);let G=`${q}px`,J=`${j}px`;xe.style.top=G,xe.style.left=J};Pe(()=>{const g=()=>{ve(void 0),ye(void 0)};document.addEventListener("click",g),$e(()=>{document.removeEventListener("click",g)})});const[Et,ve]=M(void 0),[Mt,ye]=M(void 0),At=g=>{P.steps.remove_child_at_path(g),ve(void 0)},Ye=g=>{c(g)},Pt=E(()=>a.is_on_last_ply&&W()===void 0);Pe(()=>{const g=w=>{w.key==="f"&&d(lt(_()))};document.addEventListener("keypress",g),$e(()=>{document.removeEventListener("keypress",g)})});const[_e,Lt]=ce("C","builder.skill"),[Rt,Tt]=ce(void 0,"builder.stick-line"),Ke=g=>{Tt(g),ve(void 0),ye(void 0)},qt=E(()=>{let g=o();if(!g)return;let w=f(g)[0]();return w?E(Y(()=>w.search,q=>{if(!q)return;let U=q.cp;return q.pvs.filter(L=>Math.abs(U-L.cp)<45).length}))():void 0}),jt=g=>{let w=g.fen;window.open(`https://lichess.org/analysis?fen=${w}`,"_blank"),ye(void 0),ve(void 0)},Dt=E(()=>{let g=o();if(!g)return;if(Ae(g.step.fen)===t()){let{uci:j,san:q}=g.step,U=m(g);return E(()=>{if(!U.judgement)return;let G=vt(U.judgement);return Zt(j,q,G)})()}});return(()=>{var g=or(),w=g.firstChild,j=w.nextSibling,q=j.firstChild,U=q.firstChild,L=U.firstChild,G=L.nextSibling,J=U.nextSibling;return it(g,"wheel",x),he(C=>Re=C,g),k(w,b(cn,{get shapes(){return Dt()},get orientation(){return _()},get color(){return _()},get movable(){return Pt()},play_uci:h})),L.$$click=()=>Le("match"),G.$$click=()=>Le("repertoire"),it(J,"click",e.on_welcome_page,!0),k(j,b(F,{get when(){return re()==="match"},get children(){return[(()=>{var C=Jn(),R=C.firstChild,I=R.firstChild,V=I.nextSibling,te=V.firstChild,H=te.nextSibling,X=H.nextSibling,fe=X.nextSibling,Se=fe.nextSibling,Te=R.nextSibling,oe=Te.firstChild,le=oe.firstChild,Ce=le.firstChild,D=Ce.nextSibling;D.firstChild;var qe=le.nextSibling,Nt=qe.firstChild;return V.addEventListener("change",O=>Lt(O.currentTarget.value)),Ce.addEventListener("change",O=>{O.target.checked&&Ye(ie)}),Ce.checked=!0,k(D,ie,null),Nt.addEventListener("change",O=>{O.target.checked&&Ye(20)}),ue(O=>{var Qe=_e()==="A",Xe=_e()==="B",Je=_e()==="C",Ze=_e()==="D",et=_e()==="E";return Qe!==O.e&&(te.selected=O.e=Qe),Xe!==O.t&&(H.selected=O.t=Xe),Je!==O.a&&(X.selected=O.a=Je),Ze!==O.o&&(fe.selected=O.o=Ze),et!==O.i&&(Se.selected=O.i=et),O},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),C})(),b(En,{play_replay:a,steps_stockfish:r,get last_step_sharpness(){return qt()},on_context_menu:Ct}),(()=>{var C=ar();return k(C,b(Ge,{get children(){return[b(K,{get when(){return W()==="drop"},get children(){return[Zn(),er()]}}),b(K,{get when(){return W()==="checkmate"},get children(){return[tr(),(()=>{var R=nr(),I=R.firstChild,V=I.nextSibling;return k(V,()=>Ae(a.last_step.before_fen)),R})()]}}),b(K,{get when(){return W()==="stalemate"},get children(){return[rr(),We()]}}),b(K,{get when(){return W()==="threefold"},get children(){return[lr(),We()]}}),b(K,{get when(){return W()==="insufficient"},get children(){return[ir(),We()]}})]}})),C})(),(()=>{var C=sr(),R=C.firstChild,I=R.nextSibling;return R.$$click=()=>T(),I.$$click=()=>T(t()),ue(()=>Z(I,`color ${t()}`)),C})()]}}),null),k(j,b(F,{get when(){return re()==="repertoire"},get children(){return b(Wn,{play_replay:P,on_context_menu:St})}}),null),k(g,b(F,{get when(){return Et()},children:C=>(()=>{var R=cr(),I=R.firstChild,V=I.nextSibling,te=V.nextSibling;return he(H=>ke=H,R),R.$$click=H=>{H.preventDefault(),H.stopImmediatePropagation()},k(I,()=>ze(C().ply),null),k(I,()=>C().san,null),V.$$click=()=>Ke(C().path),te.$$click=()=>At(C().path),R})()}),null),k(g,b(F,{get when(){return Mt()},children:C=>(()=>{var R=dr(),I=R.firstChild,V=I.nextSibling,te=V.nextSibling,H=te.nextSibling;return he(X=>xe=X,R),R.$$click=X=>{X.preventDefault(),X.stopImmediatePropagation()},k(I,()=>ze(C().ply),null),k(I,()=>C().san,null),V.$$click=()=>Ke(C().path),te.$$click=()=>xt(C().ply),H.$$click=()=>jt(C()),R})()}),null),ue(C=>{var R="tab"+(re()==="match"?" active":""),I="tab"+(re()==="repertoire"?" active":"");return R!==C.e&&Z(L,C.e=R),I!==C.t&&Z(G,C.t=I),C},{e:void 0,t:void 0}),g})()}He(["click"]);export{yr as default};
