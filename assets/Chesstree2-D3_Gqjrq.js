import{d as D,a as j,p as A,n as T,q as z,I as R,D as B,x as f,a7 as G,b as C,i as l,c as n,S as w,M as u,a2 as d,F as v,h as b,g as c,j as J,k as K,t as p}from"./index-CZL4b7iT.js";import{a as S}from"./random-BMCilaBQ.js";var M=p("<div class=chesstree>"),y=p("<div class=lines>"),W=p("<div class=line>"),P=p("<span class=index>"),Q=p("<div>"),U=p("<span class=nag>"),V=p("<div class=inline>"),X=p("<span class=collapsed> ..<!> ");const I=r=>{let e=[];for(let t of r)e.length===0?e.push([t]):e.push([...e[e.length-1],t]);return e};class x{static set_for_saving(e){let t=new x;return t.paths=e,t}_paths;get paths(){return this._paths[0]()}set paths(e){this._paths[1](e)}constructor(){this._paths=j([],{equals:!1})}get clone(){let e=new x;return e.paths=this.paths.slice(0),e}get_for_saving(){return this.paths}merge_dup(e){e.paths.forEach(t=>A(()=>this.add_path(t)))}replace_all(e){this.paths=e.paths.slice(0)}add_path(e){let t=this.paths;t.find(a=>a.join("")===e.join(""))||(t.push(e),this.paths=t)}remove_path(e){this.paths=this.paths.filter(t=>t.join("")!==e.join(""))}clear(){this.paths=[]}}class O{constructor(e,t){this.initial_fen=e,this._cursor_path=j([],{equals:!1}),this._tree=j(t),this._hidden_paths=new x,this._revealed_paths=j([],{equals:!1}),this._failed_paths=j([],{equals:!1}),this._solved_paths=new x,T(z(()=>this.cursor_path,a=>{const h=this.tree;h&&h.collect_branch_sums(a)?.map(s=>{this.wheel_sticky_paths.includes(s.path.join(""))||(h.siblings_of(s.path)?.forEach(i=>{this.wheel_sticky_paths=this.wheel_sticky_paths.filter(o=>o!==i.data.path.join(""))}),this.wheel_sticky_paths.push(s.path.join("")))})}))}static make=(e,t=e?.before_fen||R)=>new O(t,e);_tree;_cursor_path;_hidden_paths;_revealed_paths;_failed_paths;_solved_paths;get cursor_after_color(){let e=this.cursor_path;return B(this.tree?.get_at(e)?.after_fen??R)}get is_cursor_path_at_a_leaf(){let e=this.cursor_path;return this.failed_paths.find(t=>t.join("")===e.join(""))?!1:this.tree?.get_children(e)?.length===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(e){this._revealed_paths[1](e)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(e){this._failed_paths[1](e)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.paths}get initial_color(){return this.tree?.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(e){this._cursor_path[1](e)}set tree(e){this._tree[1](e)}get fen_last_move(){let e=this.tree;if(e){let t=e.get_at(this.cursor_path);if(!t)return;let a=t.after_fen,h=t.uci;return[a,h]}}collect_branch_sums(e){if(!this.tree)return[];let t=[],a=this.tree.root,h=a.length>1;for(let s of e){let i=a.find(m=>m.data.uci===s);if(!i)return;h&&(t.push(i.data),h=!1),i.children.filter(m=>!this.failed_paths.some(E=>E.join("")===m.data.path.join(""))).length>1&&(h=!0),a=i.children}return t}clear_failed_paths(){f(()=>{this.failed_paths.forEach(e=>{this.tree?.delete_at(e)}),this.failed_paths=[]})}try_set_cursor_path(e){return this.hidden_paths.find(a=>e.join("").startsWith(a.join("")))?!1:(this.cursor_path=e,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let e=S(this.tree.all_leaves.map(h=>h.path)),t=S(I(e).slice(1,-1));this.solved_paths.paths.find(h=>h.join("")===t.join(""))&&(t=S(I(e).slice(1,-1))),this.cursor_path=t;let a=this.tree.get_children(t);this._hidden_paths.clear(),a?.forEach(h=>this._hidden_paths.add_path(h.path))}reveal_hidden_paths=()=>{f(()=>{this.hidden_paths.forEach(e=>{this.revealed_paths.push(e)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})};add_and_reveal_uci(e){this.revealed_paths.push(this.add_uci(e)),this.revealed_paths=this.revealed_paths}reveal_one_random=()=>{if(!this.tree)return!1;const e=this.tree?._traverse_path(this.cursor_path)?.children??this.tree.root,t=et(e);return t?(f(()=>{this._hidden_paths.remove_path(t.data.path),t.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this.cursor_path=t.data.path}),!0):!1};try_next_uci_fail=e=>{if(!this.tree)return!1;const t=this.tree?._traverse_path(this.cursor_path),a=this.tree?._traverse_path(this.cursor_path)?.children??this.tree.root,h=a.find(s=>s.data.uci===e)??a.find(s=>at(s.data)===e);if(h)return this.failed_paths.find(i=>i.join("")===h.data.path.join(""))?(this.cursor_path=h.data.path,!1):(f(()=>{this._hidden_paths.remove_path(h.data.path),h.children.forEach(i=>this._hidden_paths.add_path(i.data.path)),this._solved_paths.add_path(h.data.path),this.cursor_path=h.data.path}),!0);if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(e),this.add_failed_path([...t?.data.path??[],e]),!1};add_failed_path(e){let t=this.failed_paths;t=t.filter(a=>a.join("")!==e.join("")),t.push(e),this.failed_paths=t}wheel_sticky_paths=[];on_wheel=e=>{let t=this.cursor_path;if(e<0)t.length>0&&this.try_set_cursor_path(t.slice(0,-1));else{let a=this.tree;if(a){let h;t.length===0?h=a.root:h=a._traverse_path(t)?.children;let s=h?.map(i=>i.data.path).filter(i=>!this.hidden_paths?.some(o=>i.join("").startsWith(o.join(""))));if(s&&s.length>0){let i=s.find(o=>this.wheel_sticky_paths.includes(o.join("")))??s[0];this.try_set_cursor_path(i)}}}};add_uci(e){let t=this.tree,a=this.cursor_path;return t?t.append_uci(e,a):t=G.make(this.initial_fen,[[e]]),a=[...a,e],f(()=>{this.tree=t,this.cursor_path=a}),a}drop_failed_paths(){return f(()=>{let e=this.failed_paths;e.forEach(a=>this.tree?.delete_at(a));let t=this.cursor_path;for(;t.length>0&&!this.tree?.get_at(t);)t.pop();return this.cursor_path=t,this.failed_paths=[],e})}get can_navigate_next(){let e=this.cursor_path,t=this.tree;if(t){let a;return e.length===0?a=t.root:a=t._traverse_path(e)?.children,a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))))!==void 0}return!1}get can_navigate_prev(){if(this.cursor_path.length>0)return!this.hidden_paths?.some(e=>this.cursor_path.join("").startsWith(e.join("")))}navigate_first(){let e=I(this.cursor_path).reverse().slice(1),t=(e.find(a=>(this.tree.get_children(a.slice(0,-1))?.length??0)>1)||e[e.length-1])??[];this.try_set_cursor_path(t)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){let e=this.cursor_path,t=this.tree;if(t){let a;e.length===0?a=t.root:a=t._traverse_path(e)?.children;let h=a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))));h&&this.try_set_cursor_path(h)}}navigate_last(){let e=this.cursor_path,t=this.tree;if(t){let a;e.length===0?a=t.root:a=t._traverse_path(e)?.children;let h=a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))));if(h){let s=t._traverse_path(h);for(;s.children.length===1&&!this.hidden_paths?.some(i=>s.children[0].data.path.join("").startsWith(i.join("")));)s=s.children[0];h=s.data.path,this.try_set_cursor_path(h)}}}get can_navigate_up(){let e=this.cursor_path,t=this.tree;if(t){let a=e;for(;a.length>0;){const h=t._traverse_path(a.slice(0,-1))?.children??t.root;if(h&&h.length>1){if(this.hidden_paths?.some(i=>h[0].data.path.join("").startsWith(i.join(""))))break;return h?.findIndex(i=>i.data.path.join("")===a.join(""))-1>=0}a=a.slice(0,-1)}}return!1}get can_navigate_down(){let e=this.cursor_path,t=this.tree;if(t){let a=e;for(;a.length>0;){const h=t._traverse_path(a.slice(0,-1))?.children??t.root;if(h&&h.length>1){if(this.hidden_paths?.some(i=>h[0].data.path.join("").startsWith(i.join(""))))break;return h?.findIndex(i=>i.data.path.join("")===a.join(""))+1<h.length}a=a.slice(0,-1)}}}navigate_up(){let e=this.cursor_path,t=this.tree;if(t){let a=e;for(;a.length>0;){const h=t._traverse_path(a.slice(0,-1))?.children??t.root;if(h&&h.length>1){let s=h?.findIndex(i=>i.data.path.join("")===a.join(""))-1;this.cursor_path=h[s].data.path;break}a=a.slice(0,-1)}}}navigate_down(){let e=this.cursor_path,t=this.tree;if(t){let a=e;for(;a.length>0;){const h=t._traverse_path(a.slice(0,-1))?.children??t.root;if(h&&h.length>1){let s=h?.findIndex(i=>i.data.path.join("")===a.join(""))+1;this.cursor_path=h[s].data.path;break}a=a.slice(0,-1)}}}}const st=r=>{let e;return T(()=>{let t=r.lala.cursor_path,a=e.parentElement;if(!a)return;const h=e.querySelector(".on_path_end");if(!h){a.scrollTop=t.length>0?99999:0;return}let s=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var t=M();return C(a=>e=a,t),l(t,n(w,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>n(k,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return a().root}})})),t})()},k=r=>n(b,{get children(){return[n(u,{get when(){return r.lines.length===1},get children(){return[n($,d({get data(){return r.lines[0].data}},r)),n(k,d(r,{get lines(){return r.lines[0].children}}))]}}),n(u,{get when(){return r.lines.length>1},get children(){var e=y();return l(e,n(v,{get each(){return r.lines},children:t=>(()=>{var a=W();return l(a,n($,d({get data(){return t.data}},r)),null),l(a,n(b,{get children(){return[n(u,{get when(){return t.children.length===1},get children(){return n(k,d(r,{get lines(){return t.children}}))}}),n(u,{get when(){return t.children.length>1},get children(){var h=y();return l(h,n(v,{get each(){return t.children},children:s=>(()=>{var i=W();return l(i,n(k,d(r,{lines:[s],show_index:!0}))),i})()})),h}})]}}),null),a})()})),e}})]}}),$=r=>{let e=["","good","mistake","best","blunder","interesting","dubious"],t=`${Math.ceil(r.data.ply/2)}.`;r.data.ply%2===0&&(t+="..");let a=c(()=>r.cursor_path.join("").startsWith(r.data.path.join(""))),h=c(()=>r.cursor_path.join("")===r.data.path.join("")),s=c(()=>r.data.path.join("")),i=c(()=>r.hidden_paths.find(_=>_.join("")===s())),o=c(()=>r.hidden_paths.find(_=>s().startsWith(_.join("")))),m=c(()=>r.revealed_paths.find(_=>_.join("")===s())),E=c(()=>r.failed_paths.find(_=>_.join("")===s())),L=c(()=>r.solved_paths.find(_=>_.join("")===s())),N=c(()=>e[r.data.nags?.[0]??0]),F=c(()=>["move",N(),h()?"on_path_end":a()?"on_path":"",i()?"on_hidden_path_start":o()?"on_hidden_path":"",m()?"on_revealed_path":"",E()?"on_failed_path":"",L()?"on_solved_path":"",r.collapsed?"collapsed":""].join(" "));return(()=>{var _=Q();return _.$$click=()=>r.on_set_path(r.data.path),l(_,n(w,{get when(){return r.show_index||r.data.ply&1},get children(){var q=P();return l(q,t),q}}),null),l(_,()=>r.data.san,null),l(_,n(Y,{get nags(){return r.data.nags??[]}}),null),J(()=>K(_,F())),_})()};let H=["","!","?","!!","??","!?","?!"];H[22]="⨀";const Y=r=>[" ",(()=>{var e=U();return l(e,()=>H[r.nags[0]]),e})()," "],it=r=>{let e;return T(()=>{let t=r.lala.cursor_path,a=e.parentElement;if(!a)return;const h=e.querySelector(".on_path_end");if(!h){a.scrollTop=t.length>0?99999:0;return}let s=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var t=M();return C(a=>e=a,t),l(t,n(w,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>n(b,{get children(){return[n(u,{get when(){return a().root.length===1},get children(){return n(g,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return a().root}})}}),n(u,{get when(){return a().root.length>1},get children(){var h=y();return l(h,n(v,{get each(){return a().root},children:s=>(()=>{var i=W();return l(i,n(g,{on_set_path:o=>r.lala.try_set_cursor_path(o),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},lines:[s]})),i})()})),h}})]}})})),t})()},Z=r=>{let e=0;for(;r!==void 0;)if(r.children.length>1||(r=r.children[0],e++>5))return!1;return!0},g=r=>{let e=r.hide_data;return r.hide_data=void 0,n(v,{get each(){return r.lines},children:t=>[n(w,{when:!e,get children(){return n($,d({get data(){return t.data}},r))}}),n(b,{get children(){return[n(u,{get when(){return t.children.length===1},get children(){return n(g,d(r,{get lines(){return t.children},show_index:!1}))}}),n(u,{get when(){return c(()=>t.children.length===2)()&&Z(t.children[1])},get children(){return[n($,d({get data(){return t.children[0].data}},r,{show_index:!1})),(()=>{var a=V();return l(a,n(g,d(r,{get lines(){return[t.children[1]]},show_index:!0}))),a})(),n(g,d(r,{get lines(){return[t.children[0]]},hide_data:!0}))]}}),n(u,{get when(){return t.children.length>1},get children(){var a=y();return l(a,n(v,{get each(){return t.children},children:h=>(()=>{var s=W();return l(s,n(w,{get when(){return r.cursor_path.join("").startsWith(h.data.path.join(""))},get fallback(){return n(tt,d(r,{lines:[h],show_index:!0}))},get children(){return n(g,d(r,{lines:[h],show_index:!0}))}})),s})()})),a}})]}})]})},tt=r=>n(v,{get each(){return r.lines},children:e=>[n($,d({get data(){return e.data}},r,{collapsed:!0})),(()=>{var t=X(),a=t.firstChild,h=a.nextSibling;return h.nextSibling,l(t,()=>e.length,h),l(t,()=>e.nb_first_variations,null),t})()]});function et(r){const e=r.map((s,i)=>1/(i+r.length)),t=e.reduce((s,i)=>s+i,0),a=Math.random()*t;let h=0;for(let s=0;s<r.length;s++)if(h+=e[s],a<h)return r[s]}const at=r=>{let e=r.uci.slice(0,2),t=r.uci[3];if(r.san==="O-O")return e+"g"+t;if(r.san==="O-O-O")return e+"c"+t};D(["click"]);export{it as C,O as T,x as a,st as b,H as t};
