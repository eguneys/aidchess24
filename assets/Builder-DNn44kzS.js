import{_ as ut,H as de,a as b,m as Oe,c as y,g as M,J as _t,K as ft,I as Z,L as se,N as oe,O as pt,Q as ht,x as ue,r as _e,n as I,b as le,t as j,T as Ne,U as Re,V as be,W as Fe,X as He,d as ke,C as $e,q as K,i as $,S as O,j as ie,k as Q,F as ze,M as ce,h as gt,v as ae,$ as vt,p as mt,Y as qe,Z as ne,a0 as yt,u as Ke,D as Ve,o as bt,B as ge,a1 as Te,a2 as $t}from"./index-BOZXQONt.js";import{C as wt}from"./chessground-lU4YbH_i.js";import{s as kt}from"./scroll-DnAhRpRC.js";import{a as xt}from"./random-BMCilaBQ.js";async function St(e){const i=await Ct(e);function a(s){return i.transaction(e.store,s).objectStore(e.store)}function u(s){return new Promise((c,l)=>{const r=s();r.onsuccess=o=>c(o.target.result),r.onerror=o=>l(o.target.result)})}return{list:()=>u(()=>a("readonly").getAllKeys()),get:s=>u(()=>a("readonly").get(s)),getMany:s=>u(()=>a("readonly").getAll(s)),put:(s,c)=>u(()=>a("readwrite").put(c,s)),count:s=>u(()=>a("readonly").count(s)),remove:s=>u(()=>a("readwrite").delete(s)),clear:()=>u(()=>a("readwrite").clear()),cursor:(s,c)=>u(()=>a("readonly").openCursor(s,c)).then(l=>l??void 0),txn:s=>i.transaction(e.store,s)}}async function Ct(e){const i=e?.db||`${e.store}--db`;return new Promise((a,u)=>{const s=window.indexedDB.open(i,e?.version??1);s.onsuccess=c=>a(c.target.result),s.onerror=c=>u(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const l=c.target.result,r=c.target.transaction,o=l.objectStoreNames.contains(e.store)?r.objectStore(e.store):l.createObjectStore(e.store);e.upgrade?.(c,o)}})}async function Et(e){let i;await Mt({on_received:c,on_status(g){g&&(g.download&&e.on_downloaded_nb(g.download),g.error&&e.on_engine_failed(g.error))},on_connected(g){i=g}}),a("uci");function a(g){i?.(g)}function u(g){o=g,p()}function s(){return!!r&&!r.stop_requested&&!r.swap_requested}function c(g){const v=g.trim().split(/\s+/g);if(v[0]==="uciok")a("ucinewgame"),a("isready");else if(v[0]==="readyok")f();else if(!(v[0]==="id"&&v[1]==="name"))if(v[0]==="bestmove"){r&&h&&r.emit(h),r=void 0,f();return}else if(r&&!r.swap_requested&&!r.stop_requested&&v[0]==="info"){let k=0,C,x=1,P,L,T=!1,S,V=[];for(let R=1;R<v.length;R++)switch(v[R]){case"depth":k=parseInt(v[++R]);break;case"nodes":C=parseInt(v[++R]);break;case"multipv":x=parseInt(v[++R]);break;case"time":P=parseInt(v[++R]);break;case"score":T=v[++R]==="mate",S=parseInt(v[++R]),(v[R+1]==="lowerbound"||v[R+1]==="upperbound")&&(L=v[++R]);break;case"pv":V=v.slice(++R),R=v.length;break}if(T&&!S||(l<x&&(l=x),!de(C)||!de(P)||!de(T)||!de(S)))return;const G=r.ply%2===1?-S:S;if(L&&x===1)return;const te={moves:V,cp:T?void 0:G,mate:T?G:void 0,depth:k};x===1?h={fen:r.current_fen,depth:k,nodes:C,millis:P,cp:T?void 0:G,mate:T?G:void 0,pvs:[te]}:h&&(h.pvs.push(te),h.depth=Math.min(h.depth,k)),x===l&&h&&(r.on_pvs(h),k>=40&&n())}else g&&!["Stockfish","id","option","info"].includes(v[0])&&console.warn(`SF: ${g}`)}let l=0,r,o,h;function f(){if(!r&&(r=o,o=void 0,r)){h=void 0,l=1,t("Threads",r.threads),t("Hash",r.hash_size||16),t("MultiPV",Math.max(1,r.multi_pv)),_&&_!==r.game_id&&a("ucinewgame"),_=r.game_id,a(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[g,v]=Object.entries(r.search)[0];a(`go ${g} ${v}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function t(g,v){v=v.toString(),d.get(g)!==v&&(a(`setoption name ${g} value ${v}`),d.set(g,v))}function n(){r&&!r.stop_requested&&(r.stop_requested=!0,a("stop"))}function p(){r&&!r.swap_requested&&(r.swap_requested=!0,a("stop")),a("isready")}let _;return{start(g){u(g)},stop(){u()},destroy(){a("quit")},get state(){return s()?"computing":"idle"}}}async function Mt(e){const i=d=>{e.on_status(d)},a=d=>{e.on_received(d)},u=d=>{e.on_connected(d)};let s=await ut(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),c=await new Promise((d,t)=>{s.default({wasmMemory:Lt(2560),onError:n=>t(new Error(n)),locateFile:n=>`stockfish/${n}`}).then(d).catch(t)}),l=await St({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let d=0;;d++){let t=c.getRecommendedNnue(d);if(!t||r.includes(t))break;r.push(t)}(await h(r)).forEach((d,t)=>c.setNnueBuffer(d,t)),c.onError=f(),c.listen=d=>a(d),u(d=>c.uci(d));async function h(d){return Promise.all(d.map(async t=>{let n=await l?.get(t).catch(()=>{});if(n&&n.byteLength>128*1024)return n;const p=new XMLHttpRequest;p.open("get",`stockfish/nnue/${t}`,!0),p.responseType="arraybuffer",p.onprogress=g=>i({download:{bytes:g.loaded,total:g.total}});const _=await new Promise((g,v)=>{p.onerror=()=>v(new Error(`fetch '${t}' failed: ${p.status}`)),p.onload=()=>{p.status/100===2?g(new Uint8Array(p.response)):v(new Error(`fetch '${t}' failed: ${p.status}`))},p.send()});return i(),l?.put(t,_).catch(()=>console.warn("IDB store failed")),_}))}function f(){return d=>{if(d.startsWith("BAD_NNUE")&&l){const t=Math.max(0,Number(d.slice(9))),n=c.getRecommendedNnue(t);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${n} from IDB`),l.remove(n)},2e3)}else i({error:d})}}}const Lt=(e,i=32767)=>{let a=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:i})}catch(u){if(i<=e||!(u instanceof RangeError))throw u;i=Math.max(e,Math.ceil(i-i/a)),a=a===4?3:4}},xe=_t();function Pt(e){let[i,a]=b(void 0),[u,s]=b(void 0),[c]=Oe(()=>Et({on_downloaded_nb(f){a(f)},on_engine_failed(f){s(f)}}));function l(f,d,t,n,p,_,g,v){let k=c();if(!k)return _(),()=>{};let C=Math.max(1,navigator.hardwareConcurrency-2);k.start({threads:C,hash_size:256,game_id:f,stop_requested:!1,swap_requested:!1,path:[],search:{depth:p},multi_pv:n,ply:t,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(P){v(P)},on_pvs:ft(200,function(P){g(P)})})}let r={};function o(f,d,t,n,p,_,g,v){let k=[d,n,p].join("$$"),x=(()=>{let L=p===8?[20,8]:[20],T=n===1?[6,1]:[6];return L.flatMap(S=>T.map(V=>[d,V,S].join("$$")))})().find(L=>r[L]);x?v(r[x]):l(f,d,t,n,p,_,g,P);function P(L){r[k]=L,v(L)}}let h={get download_nb(){return i()},get engine_failed(){return u()},get state(){let f=c();return c.loading||!f?"loading":f.state},best_move_with_cache:o,stop(){c()?.stop()}};return y(xe.Provider,{value:h,get children(){return M(()=>e.children)}})}const ve={equals:!1};function J(e,i,a){let u=!1,s=!0;const[c,l]=b(void 0,ve),r=M(n=>u?e(n):(s=!c(),n),i,ve);let[o,h]=b(void 0,ve),f;return[()=>(u=!0,s&&(s=l()),f=r(),u=!1,h(),f),()=>{if(o(),f)return f}]}var At=j('<div class="is2d chessboard">');function jt(){let[e,i]=b(Z),[a,u]=b(void 0),[s,c]=b(void 0),l=M(()=>se.fromSetup(oe(e()).unwrap()).unwrap()),r=M(()=>l().turn),o=M(()=>pt(l()));const h=d=>{let t=l(),n=Ne(d),p=Re(t,n);t.play(n),ue(()=>{u([d,p]),c([d,p]),i(be(t.toSetup())),d.length})},f=d=>{if(!d){u(void 0);return}let t=Re(l(),Ne(d));u([d,t])};return{play_orig_key(d,t){let n=l(),p=r(),_=n.board.get(ht(d)),g=d+t;_.role==="pawn"&&(t[1]==="8"&&p==="white"||t[1]==="1"&&p==="black")&&(g+="q"),h(g)},play_uci:h,set_fen_and_last_move(d,t){ue(()=>{f(t),i(d)})},set_fen(d){i(d)},set_last_move(d){f(d)},get dests(){return o()},get fen(){return e()},get last_move(){return a()},get on_last_move_added(){return s()},get check(){return l().isCheck()},get isEnd(){return l().isEnd()}}}function Nt(e){let i,a;return _e(()=>{let u=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:u,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};a=wt(i,c)}),I(()=>{let u;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;u=[s.slice(0,2),s.slice(2,4)]}a.set({lastMove:u,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),I(()=>{a.setAutoShapes(e.shapes??[])}),(()=>{var u=At();return le(s=>i=s,u),u})()}function Ge(e,i,a,u){let s=Fe(i,a),c=He(s),l=be(i.toSetup());i.play(s);let r=be(i.toSetup());return{path:u.length===0?c:`${u} ${c}`,ply:e,before_fen:l,fen:r,uci:c,san:a}}function Qe(e,i,a){let u=i[i.length-1];return a||(a=se.fromSetup(oe(u?.fen??Z).unwrap()).unwrap()),[...i,Ge((u?.ply??0)+1,a,e,u?.path??"")]}function De(e,i=Z){let a=[],u=se.fromSetup(oe(i).unwrap()).unwrap();for(let s of e)a=Qe(s,a,u);return a}var Rt=j("<div class=replay-single><div class=moves>"),qt=j("<span class=index>"),Tt=j("<span><span class=san>"),Ie=j("<span class=eval>"),Be=j("<span class=loading>."),Dt=j("<span class=judgement>");function It(){let[e,i]=b([]);const a=M(()=>{let t=e();return t[t.length-1]});let[u,s]=b(a()?.ply??0);const c=M(()=>{let t=u();return e().find(p=>p.ply===t)});let l=M($e(e,t=>t.san)),r=M($e(e,t=>t.ply)),o=M(()=>{let t=l(),n=r();return t.map((p,_)=>`${n[_]} ${p}`)});const h=t=>{s(t)},f=()=>{let t=u()-1;return r().find(n=>n===t)},d=()=>{let t=u()+1;return r().find(n=>n===t)};return{set_sans(t){i(De(t)),s(t.length)},get steps(){return e()},get steps_up_to_ply(){return e().slice(0,u())},get plies(){return r()},get sans(){return l()},get ply_sans(){return o()},get ply_step(){return c()},get last_step(){return a()},get ply(){return u()},goto_ply:h,get_prev_ply:f,get_next_ply:d,goto_prev_ply_if_can(){let t=f();t!==void 0&&h(t),u()===1&&s(0)},goto_next_ply_if_can(){let t=d();t!==void 0&&h(t)},play_san(t){let n=a();if(!n){i(De([t]));return}let p=e();i(Qe(t,p)),s(n.ply+1)},get is_on_last_ply(){return u()===(a()?.ply??0)}}}function Bt(e){const i=M($e(()=>e.play_replay.ply_sans,l=>{let[r,o]=l.split(" ");return{ply:parseInt(r),san:o}})),a=l=>{e.play_replay.goto_ply(l)},u=M(()=>e.play_replay.ply_step?.ply);I(K(()=>e.play_replay.steps,l=>e.steps_stockfish.set_steps(l)));let s;const c=l=>{let r=e.steps_stockfish.steps_with_stockfish[l];if(!r)return"";let o=r.d20pv6[1](),h=r.d20pv1[1](),f=r.d8pv6[1](),d=r.d8pv1[1]();if(o)return(o.judgement??"")+" d20pv6";if(h)return(h.judgement??"")+" d20pv1";if(f)return(f.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return I(K(i,l=>{if(l.length<7)return;let r=s.parentElement,o;if(e.play_replay.ply<3)o=0;else if(e.play_replay.is_on_last_ply)o=99999;else{let h=r.querySelector(".active");h&&(o=h.offsetTop-s.offsetHeight/2+h.offsetHeight/2)}o!==void 0&&r.scrollTo({behavior:"smooth",top:o})})),(()=>{var l=Rt(),r=l.firstChild;return le(o=>s=o,r),$(r,y(ze,{get each(){return i()},children:(o,h)=>[y(O,{get when(){return o.ply%2===1},get children(){var f=qt();return $(f,()=>Math.ceil(o.ply/2)),f}}),(()=>{var f=Tt(),d=f.firstChild;return f.$$click=()=>a(o.ply),$(d,()=>o.san),$(f,y(O,{get when(){return e.steps_stockfish.steps_with_stockfish[h()]},children:t=>y(Ut,{get ss(){return t()}})}),null),ie(()=>Q(f,"move "+c(h())+(o.ply===u()?" active":""))),f})()]})),l})()}function Ut(e){return y(gt,{get fallback(){return y(re,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[y(ce,{get when(){return e.ss.d20pv6[1]()},children:i=>y(re,{get step(){return i()}})}),y(ce,{get when(){return e.ss.d20pv1[1]()},children:i=>y(re,{get step(){return i()}})}),y(ce,{get when(){return e.ss.d8pv6[1]()},children:i=>y(re,{get step(){return i()}})}),y(ce,{get when(){return e.ss.d8pv1[1]()},children:i=>y(re,{get step(){return i()}})})]}})}function re(e){const i=()=>e.step.search?.cp,a=()=>e.step.judgement,u=c=>c==="good"?"✓":c==="inaccuracy"?"?!":c==="mistake"?"?":"??",s=()=>e.step.progress?.depth;return(()=>{var c=Ie();return $(c,y(O,{get when(){return i()!==void 0},get fallback(){return(()=>{var l=Be();return l.firstChild,$(l,s,null),l})()},get children(){var l=Ie();return $(l,()=>Wt(i())),l}}),null),$(c,y(O,{get when(){return a()},get fallback(){return Be()},children:l=>(()=>{var r=Dt();return $(r,()=>u(l())),r})()}),null),c})()}function Wt(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}ke(["click"]);var me=Symbol("fallback");function Ue(e){for(const i of e)i.dispose()}function Xe(e,i,a,u={}){const s=new Map;return ae(()=>Ue(s.values())),()=>{const l=e()||[];return l[vt],mt(()=>{if(!l.length)return Ue(s.values()),s.clear(),u.fallback?[qe(d=>(s.set(me,{dispose:d}),u.fallback()))]:[];const r=new Array(l.length),o=s.get(me);if(!s.size||o){o?.dispose(),s.delete(me);for(let f=0;f<l.length;f++){const d=l[f],t=i(d,f);c(r,d,f,t)}return r}const h=new Set(s.keys());for(let f=0;f<l.length;f++){const d=l[f],t=i(d,f);h.delete(t);const n=s.get(t);n?(r[f]=n.mapped,n.setIndex?.(f),n.setItem(()=>d)):c(r,d,f,t)}for(const f of h)s.get(f)?.dispose(),s.delete(f);return r})};function c(l,r,o,h){qe(f=>{const[d,t]=b(r),n={setItem:t,dispose:f};if(a.length>1){const[p,_]=b(o);n.setIndex=_,n.mapped=a(d,p)}else n.mapped=a(d);s.set(h,n),l[o]=n.mapped})}}function Ot(e){const{by:i}=e;return M(Xe(()=>e.each,typeof i=="function"?i:a=>a[i],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var Ft=j("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),Ye=j("<span class=index>"),Ht=j("<div class=fbt>"),zt=j("<div class=lines>"),Kt=j("<div class=line>"),Vt=j("<span class=collapsed>..<!> "),Gt=j("<div>");function Qt(e){return yt(e).map(i=>{let a=i.headers.get("Event"),u=i.headers.get("Site"),s=i.headers.get("White"),c=i.headers.get("Black"),l=i.headers.get("Chapter"),r=i.headers.get("Orientation"),o=i.headers.get("FEN"),h=o??Z,f=se.fromSetup(oe(h).unwrap()).unwrap(),d=Je();i.moves.children.forEach(n=>{t(n,f,"")});function t(n,p,_){let g=n.data.san,v=Fe(p,g),k=p.clone();k.play(v);let C=He(v),x=n.data.nags;d.add_child_san(_,g).set_nags(x??[]);let P=_.length===0?C:`${_} ${C}`;n.children.forEach(L=>{t(L,k,P)})}return{event:a,site:u,white:s,black:c,chapter:l,fen:o,orientation:r,tree:d}})}function Je(){let[e,i]=b([]);const a=l=>u(l)?.[1],u=l=>{if(l==="")return;let r=l.split(" "),o=0,h,f=e();for(;;){let d=r.slice(0,o+1).join(" "),t=f.find(n=>n.path===d);if(!t)return;if(o++,o===r.length)return[h,t];h=t,f=t.children}};function s(l,r=!1){let o=l.ply,h=o%2===1||r?Math.ceil(o/2)+(o%2===1?".":"..."):"",f=o%2===1?"":" ";return`${h} ${l.san}${l.comments?" { "+l.comments+" }":""}${f}`}function c(l,r=!1){let o="";return l.length===0||(l.length===1?(o+=s(l[0].step,r),o+=c(l[0].children,!1)):(o+=s(l[0].step,!1).trimEnd(),o+=" "+l.slice(1).map(h=>`(${c([h],!0).trimEnd()})`).join(" "),o+=" "+c(l[0].children,!0))),o}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(l){if(l.length===0)return[];let r=l[0],o=this.add_child_san("",r),h=[o];return l.slice(1).forEach(f=>{o=o.add_child_san(f),h.push(o)}),h},add_child_san(l,r){if(l===""){let h=e(),f=h.find(n=>n.san===r);if(f)return f;let d=se.fromSetup(oe(Z).unwrap()).unwrap(),t=Ze(0,d,r,"");return i([...h,t]),t}let o=a(l);if(o)return o.add_child_san(r)},remove_child_at_path(l){let r=u(l);if(r){if(!r[0]){let o=e(),h=o.indexOf(r[1]);return o.splice(h,1),i([...o]),r[1]}return r[0].remove_child(r[1]),r[1]}},find_at_path:a,find_parent_and_child_at_path:u,siblings_of(l){let r=u(l)?.[0];if(r)return r.children;if(l.split(" ").length===1)return e()},previous_branch_points(l){let r=[],o=e(),h=o.length>1;for(let f of l.split(" ")){let d=o.find(t=>t.step.uci===f);if(!d)return;h&&(r.push(d),h=!1),d.children.length>1&&(h=!0),o=d.children}return r}}}function Ze(e,i,a,u){let[s,c]=b([]),[l,r]=b([]);i=i.clone();let o=Ge(e,i,a,u),h=()=>f()?.length??0,f=()=>d()?.children,d=()=>{let n=s();if(n.length!==0)return n.length===1?n[0].first_node_with_variations:t},t={get nags(){return l()},set_nags:r,get path(){return o.path},get ply(){return o.ply},get san(){return o.san},step:o,get children(){return s()},remove_child(n){let p=s(),_=p.indexOf(n);if(_!==-1)return p.splice(_,1),c([...p]),n},add_child_san(n){let p=s(),_=p.find(v=>v.san===n);if(_)return _;let g=Ze(e+1,i,n,o.path);return c([...p,g]),g},remove_child_san(n){let p=s(),_=p.findIndex(v=>v.step.san!==n);if(_===-1)return;let g=p.splice(_,1)[0];return c([...p]),g},get nb_first_variations(){return h()},get first_node_with_variations(){return d()},get length(){let n=s();if(n.length>1)return 1;if(n.length===0)return 0;let p=1,_=n[0];for(;_?.children.length===1;)p++,_=_.children[0];return p}};return t}function Xt(e){let i=Je();e&&(i=Qt(e)[0].tree);let[a,u]=b(""),s=[];I(K(a,t=>{i.previous_branch_points(t)?.map(n=>{s.includes(n.path)||(i.siblings_of(n.path)?.forEach(p=>{s=s.filter(_=>_!==p.path)}),s.push(n.path))})}));const c=t=>{u(t)},l=()=>{let t=a();if(t!=="")return t.split(" ").slice(0,-1).join(" ")},r=()=>{let t=a(),n=i.find_at_path(t)?.children??i.root;return n.length===1?n[0].path:n.find(p=>s.includes(p.path))?.path??n[0]?.path},o=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t;if(!n[0])return"";if(n[0].children.length>1)return n[0].path;for(;!(!n[0]||n[0].children.length>1);){let p=i.find_parent_and_child_at_path(n[0].path);if(!p)break;n=p}return n[1].path},h=()=>{let t=i.find_at_path(a());if(!t)return i.root.find(p=>s.includes(p.path))?.path??i.root[0]?.path;let n=t;if(n.children.length>1)return n.children.find(p=>s.includes(p.path))?.path??n.children[0]?.path;for(;n.children.length===1;)n=n.children[0];return n.path},f=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=i.root;else if(t[0].children.length===1)for(;;){if(t=i.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=i.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p-1];if(_)return _.path},d=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=i.root;else if(t[0].children.length===1)for(;;){if(t=i.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=i.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p+1];if(_)return _.path};return{steps:i,get cursor_path(){return a()},set cursor_path(t){u(t)},get cursor_path_step(){return i.find_at_path(a())?.step},goto_path:c,get_prev_path:l,get_next_path:r,goto_prev_if_can(){let t=l();t!==void 0&&c(t)},goto_next_if_can(){let t=r();t!==void 0&&c(t)},get_first_path:o,get_last_path:h,get_up_path:f,get_down_path:d,goto_up_if_can(){let t=f();t!==void 0&&c(t)},goto_down_if_can(){let t=d();t!==void 0&&c(t)},goto_last_if_can(){let t=h();t!==void 0&&c(t)},goto_first_if_can(){let t=o();t!==void 0&&c(t)},get previous_branch_points_at_cursor_path(){return i.previous_branch_points(a())??[]}}}function Yt(e){const i=e.play_replay.steps;let a;I(()=>{let s=e.play_replay.cursor_path,c=a.parentElement;if(!c)return;const l=a.querySelector(".on-path-end");if(!l){c.scrollTop=s.length>0?99999:0;return}let r=l.offsetTop-c.offsetHeight/2+l.offsetHeight;c.scrollTo({behavior:"smooth",top:r})});const u=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return _e(()=>{document.addEventListener("keydown",u),ae(()=>{document.removeEventListener("keydown",u)})}),(()=>{var s=Ft(),c=s.firstChild,l=c.firstChild,r=c.nextSibling,o=r.firstChild,h=o.nextSibling,f=r.nextSibling,d=f.firstChild,t=d.nextSibling,n=t.nextSibling,p=n.nextSibling;return le(_=>a=_,l),$(l,y(we,{get nodes(){return i.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:_=>e.play_replay.cursor_path=_,on_context_menu:(_,g)=>e.on_context_menu?.(_,g)})),o.$$click=()=>e.play_replay.goto_up_if_can(),h.$$click=()=>e.play_replay.goto_down_if_can(),$(r,y(ze,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:_=>(()=>{var g=Ht();return g.$$click=()=>e.play_replay.cursor_path=_.path,$(g,y(O,{get when(){return _.ply&1},get children(){var v=Ye();return $(v,()=>et(_.ply)),v}}),null),$(g,()=>_.san,null),g})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),t.$$click=()=>e.play_replay.goto_prev_if_can(),n.$$click=()=>e.play_replay.goto_next_if_can(),p.$$click=()=>e.play_replay.goto_last_if_can(),ie(_=>{var g=e.play_replay.get_up_path()===void 0,v="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),k=e.play_replay.get_down_path()===void 0,C="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),x=e.play_replay.get_first_path()===void 0,P="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),L=e.play_replay.get_prev_path()===void 0,T="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),S=e.play_replay.get_next_path()===void 0,V="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),B=e.play_replay.get_last_path()===void 0,G="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return g!==_.e&&(o.disabled=_.e=g),v!==_.t&&Q(o,_.t=v),k!==_.a&&(h.disabled=_.a=k),C!==_.o&&Q(h,_.o=C),x!==_.i&&(d.disabled=_.i=x),P!==_.n&&Q(d,_.n=P),L!==_.s&&(t.disabled=_.s=L),T!==_.h&&Q(t,_.h=T),S!==_.r&&(n.disabled=_.r=S),V!==_.d&&Q(n,_.d=V),B!==_.l&&(p.disabled=_.l=B),G!==_.u&&Q(p,_.u=G),_},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function we(e){return[y(O,{get when(){return e.nodes.length===1},get children(){return[y(ye,ne(e,{get node(){return e.nodes[0]}})),y(we,ne(e,{get nodes(){return e.nodes[0].children}}))]}}),y(O,{get when(){return e.nodes.length>1},get children(){var i=zt();return $(i,y(Ot,{get each(){return e.nodes},by:"path",children:a=>(()=>{var u=Kt();return $(u,y(O,{get when(){return e.cursor_path.startsWith(a().path)},get fallback(){return[y(ye,ne(e,{get node(){return a()},show_index:!0,collapsed:!0})),(()=>{var s=Vt(),c=s.firstChild,l=c.nextSibling;return l.nextSibling,$(s,()=>a().length,l),$(s,()=>a().nb_first_variations,null),s})()]},get children(){return[y(ye,ne(e,{get node(){return a()},show_index:!0})),y(we,ne(e,{get nodes(){return a().children}}))]}})),u})()})),i}})]}function ye(e){let i=M(()=>e.node.ply%2===0||e.show_index),a=M(()=>e.node.ply%2===0?".":"...");const u=M(()=>e.node.path),s=M(()=>e.cursor_path.startsWith(u())),c=M(()=>u()===e.cursor_path),l=M(()=>{let r=["move"];return e.collapsed&&r.push("collapsed"),s()&&r.push("on-path"),c()&&r.push("on-path-end"),r.join(" ")});return(()=>{var r=Gt();return r.$$click=()=>{e.on_set_cursor(e.node.path)},r.$$contextmenu=o=>{o.preventDefault(),e.on_context_menu(o,e.node.path)},$(r,y(O,{get when(){return i()},get children(){var o=Ye();return $(o,()=>Math.floor(e.node.ply/2)+1,null),$(o,a,null),o}}),null),$(r,()=>e.node.san,null),ie(()=>Q(r,l())),r})()}const et=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");ke(["click","contextmenu"]);const Jt=(e,i)=>e==="white"?i:-i,tt=e=>2/(1+Math.exp(-.00368208*e))-1,Zt=e=>tt(Math.min(Math.max(-1e3,e),1e3)),en=e=>{const a=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return tt(a)},tn=e=>typeof e.mate<"u"?en(e.mate):Zt(e.cp),We=(e,i)=>Jt(e,tn(i)),nn=(e,i,a)=>(We(e,i)-We(e,a))/2,rn=(e,i,a)=>nn(e,i,a);function ln(){let e=Ke(xe);function i(n,p,_,g,v,k,C){e.best_move_with_cache(o(),n,p,_,g,v,k,C)}let a,u=[];function s(n,p,_,g){let[v,k]=b(void 0),[C,x]=b(void 0),[P,L]=b(void 0),T={get loading(){return v()},get depth_eval(){return C()},get best_eval(){return P()},cancel:V},S={cancel:V,fen:n,ply:p,depth:_,multi_pv:g,set_loading:k,set_depth_eval:x,set_best_eval:L};function V(){let B=u.indexOf(S);B!==-1&&u.splice(B,1),a===S&&(console.trace("working cancel"),a=void 0,e.stop()),c()}return u.push(S),c(),T}function c(){if(a||(a=u.pop(),!a))return;const n=p=>{a?.set_best_eval(p),a=void 0,c()};i(a.fen,a.ply,a.multi_pv,a.depth,a.set_loading,a.set_depth_eval,n)}function l(n,p,_){let g=s(n.before_fen,n.ply-1,p,_),v=s(n.fen,n.ply,p,_);function k(C,x,P){let L=rn(C,x,P);return L<.03?"good":L<.05?"inaccuracy":L<.12?"mistake":"blunder"}return M(()=>(ae(()=>{v.cancel(),g.cancel()}),{...n,get before_search(){return g.best_eval},get search(){return n.fen,v.best_eval?.fen,v.best_eval},get judgement(){let C=g.best_eval,x=v.best_eval;if(C&&x)return k(Ve(n.before_fen),C,x)},get progress(){return v?.depth_eval}}))}function r(n){let[p,_]=b(J(()=>l(n,8,6)())),[g,v]=b(J(()=>l(n,8,1)())),[k,C]=b(J(()=>l(n,20,6)())),[x,P]=b(J(()=>l(n,20,1)()));return{step:n,get d8pv6(){return p()},get d8pv1(){return g()},get d20pv6(){return k()},get d20pv1(){return x()},clear(){_(J(()=>l(n,8,6)())),C(J(()=>l(n,20,6)())),v(J(()=>l(n,8,1)())),P(J(()=>l(n,20,1)()))}}}let[o,h]=b(""),[f,d]=b([]),t=Xe(f,n=>[n.fen,n.uci].join("$$"),n=>r(n()));return{set_game_id:h,set_steps:d,get steps_with_stockfish(){return t()}}}var an=j("<div class=loading><span class=info>Loading <!>%"),sn=j("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth 8</label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),on=j("<span class=result>Game Over"),dn=j("<small class=drop>Evaluation Dropped Below -2"),cn=j("<div class=result-wrap>"),un=j("<div class=tools-wrap><button class=save>Save Line</button><button class=rematch>Rematch"),_n=j("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tabs-wrap><div>Match</div><div>Repertoire"),fn=j("<div class=context-menu><div class=title></div><a class=delete data-icon=>Delete move");const bn=()=>y(Pt,{get children(){return y(pn,{})}});function pn(){let[e]=Oe(()=>Ke(xe));const i=M(()=>{let a=e()?.download_nb;if(a)return Math.ceil(a.bytes/(a.total===0?70*1024*1024:a.total)*100)});return y(O,{get when(){return e()},children:a=>y(O,{get when(){return a().state==="loading"},get fallback(){return y(hn,{})},get children(){var u=an(),s=u.firstChild,c=s.firstChild,l=c.nextSibling;return l.nextSibling,$(s,()=>i()??"--",l),u}})})}function hn(){const e=bt();e.setVolume(.2);let[i,a]=ge([],"builder.current.sans");const[u,s]=b(8);let c="";const l=ln(),r=It();let o=jt();const[h,f]=b("white"),d=M(()=>Te(h())),t=M(()=>{let m=l.steps_with_stockfish;return m[m.length-1]});function n(m){return u()===8?m.d8pv6:m.d20pv6}function p(m){return u()===8?m.d8pv1[0]():m.d20pv1[0]()}I(K(t,m=>{if(!m)return;if(Ve(m.step.fen)===d()){let U=n(m)[0]();I(K(()=>U.search,q=>{if(!q)return;let H=q.cp,F=q.pvs.filter(E=>Math.abs(E.cp-H)<=10),w=q.pvs.filter(E=>Math.abs(E.cp-H)<=30),N=q.pvs.filter(E=>Math.abs(E.cp-H)<=60),W=q.pvs.filter(E=>Math.abs(E.cp-H)<=100),X=q.pvs.filter(E=>Math.abs(E.cp-H)<200);F=F.filter(E=>E.cp<150),w=w.filter(E=>E.cp<150),N=N.filter(E=>E.cp<150),W=W.filter(E=>E.cp<150),X=X.filter(E=>E.cp<150),console.log(X,q);function z(E){return E.find(he=>he.length>0)}let Y;switch(ee()){case"A":Y=z([F]);break;case"B":Y=z([w,F]);break;case"C":Y=z([N,w,F]);break;case"D":Y=z([W,N,w,F]);break;case"E":Y=z([X,W,N,w,F]);break}o.play_uci(xt(Y).moves[0])}))}})),I(K(()=>o.on_last_move_added,m=>{m&&r.play_san(m[1])})),I(K(()=>r.sans,a)),I(K(()=>r.ply_step,m=>{o.set_fen_and_last_move(m?.fen??Z,m?.uci)})),I(K(()=>r.ply_step,(m,A)=>{m&&(!A||A.ply===m.ply-1)&&e.move(m)}));const _=kt(m=>{const A=m.target;A.tagName!=="PIECE"&&A.tagName!=="SQUARE"&&A.tagName!=="CG-BOARD"||(m.preventDefault(),g(Math.sign(m.deltaY)))}),g=m=>{m>0?(B()==="match"&&r.goto_next_ply_if_can(),B()==="repertoire"&&S.goto_next_if_can()):(B()==="match"&&r.goto_prev_ply_if_can(),B()==="repertoire"&&S.goto_prev_if_can())};l.set_game_id(c),r.set_sans(i());const v=()=>{a([]),r.set_sans(i()),o.set_fen_and_last_move(Z),T(void 0)};I(K(u,()=>{l.steps_with_stockfish.forEach(A=>{ue(()=>{A.clear(),p(A)})});let m=t();m&&n(m)[0]()})),I(K(t,m=>{if(!m)return;let A=p(m);I(K(()=>A.search,U=>{let q=U?.cp;q&&q<-200&&T("drop")}))}));let[k,C]=ge("","builder.current.cursor_path"),[x,P]=ge(void 0,"builder.current.pgn");const[L,T]=b(void 0),S=Xt(x());S.cursor_path=k(),I(K(()=>S.cursor_path,m=>{C(m)}));const V=()=>{ue(()=>{let A=r.steps_up_to_ply.map(H=>H.san),U=S.steps.add_sans_at_root(A),q=U[U.length-1]?.path;q&&(G("repertoire"),S.cursor_path=q,P(S.steps.as_pgn))})},[B,G]=b("match");let te,R;const nt=(m,A)=>{S.cursor_path=A,fe(S.steps.find_at_path(A));let U=m.clientX,q=m.clientY,H=R.getBoundingClientRect(),F=te.getBoundingClientRect();U-=F.left,q-=F.top,U=Math.min(U,document.body.clientWidth-H.width-F.left-20);let w=`${q}px`,N=`${U}px`;R.style.top=w,R.style.left=N};_e(()=>{const m=()=>{fe(void 0)};document.addEventListener("click",m),ae(()=>{document.removeEventListener("click",m)})});const[rt,fe]=b(void 0),lt=m=>{S.steps.remove_child_at_path(m),fe(void 0)},Se=m=>{s(m)},it=M(()=>!o.isEnd&&r.is_on_last_ply&&L()===void 0);_e(()=>{const m=A=>{A.key==="f"&&f(Te(h()))};document.addEventListener("keypress",m),ae(()=>{document.removeEventListener("keypress",m)})});const[ee,at]=b("A");return(()=>{var m=_n(),A=m.firstChild,U=A.nextSibling,q=U.firstChild,H=q.firstChild,F=H.nextSibling;return $t(m,"wheel",_),le(w=>te=w,m),$(A,y(Nt,{get orientation(){return h()},get color(){return h()},get movable(){return it()},play_uci:o})),H.$$click=()=>G("match"),F.$$click=()=>G("repertoire"),$(U,y(O,{get when(){return B()==="match"},get children(){return[(()=>{var w=sn(),N=w.firstChild,W=N.firstChild,X=W.nextSibling,z=X.firstChild,Y=z.nextSibling,pe=Y.nextSibling,E=pe.nextSibling,he=E.nextSibling,st=N.nextSibling,ot=st.firstChild,Ce=ot.firstChild,Ee=Ce.firstChild,dt=Ce.nextSibling,ct=dt.firstChild;return X.addEventListener("change",D=>at(D.currentTarget.value)),Ee.addEventListener("change",D=>{D.target.checked&&Se(8)}),Ee.checked=!0,ct.addEventListener("change",D=>{D.target.checked&&Se(20)}),ie(D=>{var Me=ee()==="A",Le=ee()==="B",Pe=ee()==="C",Ae=ee()==="D",je=ee()==="E";return Me!==D.e&&(z.selected=D.e=Me),Le!==D.t&&(Y.selected=D.t=Le),Pe!==D.a&&(pe.selected=D.a=Pe),Ae!==D.o&&(E.selected=D.o=Ae),je!==D.i&&(he.selected=D.i=je),D},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),w})(),y(Bt,{play_replay:r,steps_stockfish:l}),(()=>{var w=cn();return $(w,y(O,{get when(){return L()==="drop"},get children(){return[on(),dn()]}})),w})(),(()=>{var w=un(),N=w.firstChild,W=N.nextSibling;return N.$$click=V,W.$$click=v,w})()]}}),null),$(U,y(O,{get when(){return B()==="repertoire"},get children(){return y(Yt,{play_replay:S,on_context_menu:nt})}}),null),$(m,y(O,{get when(){return rt()},children:w=>(()=>{var N=fn(),W=N.firstChild,X=W.nextSibling;return le(z=>R=z,N),N.$$click=z=>{z.preventDefault(),z.stopImmediatePropagation()},$(W,()=>et(w().ply),null),$(W,()=>w().san,null),X.$$click=()=>lt(w().path),N})()}),null),ie(w=>{var N="tab"+(B()==="match"?" active":""),W="tab"+(B()==="repertoire"?" active":"");return N!==w.e&&Q(H,w.e=N),W!==w.t&&Q(F,w.t=W),w},{e:void 0,t:void 0}),m})()}ke(["click"]);export{bn as default};
