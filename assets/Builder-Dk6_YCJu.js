import{_ as Qe,H as le,a as $,m as Le,c as y,g as C,J as Xe,K as Ye,I as V,L as te,N as ne,O as Je,Q as Ze,x as ie,r as se,n as q,b as Z,t as j,T as $e,U as we,V as he,W as je,X as Ne,d as me,C as ge,q as W,i as b,S as T,j as oe,k as F,F as Re,M as ae,h as et,v as ee,$ as tt,p as nt,Y as ke,Z as Y,a0 as rt,u as qe,D as Ae,o as lt,B as ue,a1 as xe,a2 as at}from"./index-TJK2L0qU.js";import{C as it}from"./chessground-lU4YbH_i.js";import{s as st}from"./scroll-DnAhRpRC.js";async function ot(e){const a=await dt(e);function i(s){return a.transaction(e.store,s).objectStore(e.store)}function u(s){return new Promise((c,l)=>{const r=s();r.onsuccess=o=>c(o.target.result),r.onerror=o=>l(o.target.result)})}return{list:()=>u(()=>i("readonly").getAllKeys()),get:s=>u(()=>i("readonly").get(s)),getMany:s=>u(()=>i("readonly").getAll(s)),put:(s,c)=>u(()=>i("readwrite").put(c,s)),count:s=>u(()=>i("readonly").count(s)),remove:s=>u(()=>i("readwrite").delete(s)),clear:()=>u(()=>i("readwrite").clear()),cursor:(s,c)=>u(()=>i("readonly").openCursor(s,c)).then(l=>l??void 0),txn:s=>a.transaction(e.store,s)}}async function dt(e){const a=e?.db||`${e.store}--db`;return new Promise((i,u)=>{const s=window.indexedDB.open(a,e?.version??1);s.onsuccess=c=>i(c.target.result),s.onerror=c=>u(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const l=c.target.result,r=c.target.transaction,o=l.objectStoreNames.contains(e.store)?r.objectStore(e.store):l.createObjectStore(e.store);e.upgrade?.(c,o)}})}async function ct(e){let a;await ut({on_received:c,on_status(g){g&&(g.download&&e.on_downloaded_nb(g.download),g.error&&e.on_engine_failed(g.error))},on_connected(g){a=g}}),i("uci");function i(g){a?.(g)}function u(g){o=g,p()}function s(){return!!r&&!r.stop_requested&&!r.swap_requested}function c(g){const v=g.trim().split(/\s+/g);if(v[0]==="uciok")i("ucinewgame"),i("isready");else if(v[0]==="readyok")f();else if(!(v[0]==="id"&&v[1]==="name"))if(v[0]==="bestmove"){r&&h&&r.emit(h),r=void 0,f();return}else if(r&&!r.swap_requested&&!r.stop_requested&&v[0]==="info"){let w=0,S,k=1,M,E,R=!1,x,B=[];for(let N=1;N<v.length;N++)switch(v[N]){case"depth":w=parseInt(v[++N]);break;case"nodes":S=parseInt(v[++N]);break;case"multipv":k=parseInt(v[++N]);break;case"time":M=parseInt(v[++N]);break;case"score":R=v[++N]==="mate",x=parseInt(v[++N]),(v[N+1]==="lowerbound"||v[N+1]==="upperbound")&&(E=v[++N]);break;case"pv":B=v.slice(++N),N=v.length;break}if(R&&!x||(l<k&&(l=k),!le(S)||!le(M)||!le(R)||!le(x)))return;const O=r.ply%2===1?-x:x;if(E&&k===1)return;const X={moves:B,cp:R?void 0:O,mate:R?O:void 0,depth:w};k===1?h={fen:r.current_fen,depth:w,nodes:S,millis:M,cp:R?void 0:O,mate:R?O:void 0,pvs:[X]}:h&&(h.pvs.push(X),h.depth=Math.min(h.depth,w)),k===l&&h&&(r.on_pvs(h),w>=40&&n())}else g&&!["Stockfish","id","option","info"].includes(v[0])&&console.warn(`SF: ${g}`)}let l=0,r,o,h;function f(){if(!r&&(r=o,o=void 0,r)){h=void 0,l=1,t("Threads",r.threads),t("Hash",r.hash_size||16),t("MultiPV",Math.max(1,r.multi_pv)),_&&_!==r.game_id&&i("ucinewgame"),_=r.game_id,i(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[g,v]=Object.entries(r.search)[0];i(`go ${g} ${v}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function t(g,v){v=v.toString(),d.get(g)!==v&&(i(`setoption name ${g} value ${v}`),d.set(g,v))}function n(){r&&!r.stop_requested&&(r.stop_requested=!0,i("stop"))}function p(){r&&!r.swap_requested&&(r.swap_requested=!0,i("stop")),i("isready")}let _;return{start(g){u(g)},stop(){u()},destroy(){i("quit")},get state(){return s()?"computing":"idle"}}}async function ut(e){const a=d=>{e.on_status(d)},i=d=>{e.on_received(d)},u=d=>{e.on_connected(d)};let s=await Qe(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),c=await new Promise((d,t)=>{s.default({wasmMemory:_t(2560),onError:n=>t(new Error(n)),locateFile:n=>`stockfish/${n}`}).then(d).catch(t)}),l=await ot({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let d=0;;d++){let t=c.getRecommendedNnue(d);if(!t||r.includes(t))break;r.push(t)}(await h(r)).forEach((d,t)=>c.setNnueBuffer(d,t)),c.onError=f(),c.listen=d=>i(d),u(d=>c.uci(d));async function h(d){return Promise.all(d.map(async t=>{let n=await l?.get(t).catch(()=>{});if(n&&n.byteLength>128*1024)return n;const p=new XMLHttpRequest;p.open("get",`stockfish/nnue/${t}`,!0),p.responseType="arraybuffer",p.onprogress=g=>a({download:{bytes:g.loaded,total:g.total}});const _=await new Promise((g,v)=>{p.onerror=()=>v(new Error(`fetch '${t}' failed: ${p.status}`)),p.onload=()=>{p.status/100===2?g(new Uint8Array(p.response)):v(new Error(`fetch '${t}' failed: ${p.status}`))},p.send()});return a(),l?.put(t,_).catch(()=>console.warn("IDB store failed")),_}))}function f(){return d=>{if(d.startsWith("BAD_NNUE")&&l){const t=Math.max(0,Number(d.slice(9))),n=c.getRecommendedNnue(t);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${n} from IDB`),l.remove(n)},2e3)}else a({error:d})}}}const _t=(e,a=32767)=>{let i=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:a})}catch(u){if(a<=e||!(u instanceof RangeError))throw u;a=Math.max(e,Math.ceil(a-a/i)),i=i===4?3:4}},ye=Xe();function ft(e){let[a,i]=$(void 0),[u,s]=$(void 0),[c]=Le(()=>ct({on_downloaded_nb(f){i(f)},on_engine_failed(f){s(f)}}));function l(f,d,t,n,p,_,g,v){let w=c();if(!w)return _(),()=>{};let S=Math.max(1,navigator.hardwareConcurrency-2);w.start({threads:S,hash_size:256,game_id:f,stop_requested:!1,swap_requested:!1,path:[],search:{depth:p},multi_pv:n,ply:t,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(M){v(M)},on_pvs:Ye(200,function(M){g(M)})})}let r={};function o(f,d,t,n,p,_,g,v){let w=[d,n,p].join("$$"),k=(()=>{let E=p===8?[20,8]:[20],R=n===1?[6,1]:[1];return E.flatMap(x=>R.map(B=>[d,B,x].join("$$")))})().find(E=>r[E]);k?v(r[k]):l(f,d,t,n,p,_,g,M);function M(E){r[w]=E,v(E)}}let h={get download_nb(){return a()},get engine_failed(){return u()},get state(){let f=c();return c.loading||!f?"loading":f.state},best_move_with_cache:o,stop(){c()?.stop()}};return y(ye.Provider,{value:h,get children(){return C(()=>e.children)}})}const _e={equals:!1};function K(e,a,i){let u=!1,s=!0;const[c,l]=$(void 0,_e),r=C(n=>u?e(n):(s=!c(),n),a,_e);let[o,h]=$(void 0,_e),f;return[()=>(u=!0,s&&(s=l()),f=r(),u=!1,h(),f),()=>{if(o(),f)return f}]}var pt=j('<div class="is2d chessboard">');function ht(){let[e,a]=$(V),[i,u]=$(void 0),[s,c]=$(void 0),l=C(()=>te.fromSetup(ne(e()).unwrap()).unwrap()),r=C(()=>l().turn),o=C(()=>Je(l()));const h=d=>{let t=l(),n=$e(d),p=we(t,n);t.play(n),ie(()=>{u([d,p]),c([d,p]),a(he(t.toSetup())),d.length})},f=d=>{if(!d){u(void 0);return}let t=we(l(),$e(d));u([d,t])};return{play_orig_key(d,t){let n=l(),p=r(),_=n.board.get(Ze(d)),g=d+t;_.role==="pawn"&&(t[1]==="8"&&p==="white"||t[1]==="1"&&p==="black")&&(g+="q"),h(g)},play_uci:h,set_fen_and_last_move(d,t){ie(()=>{f(t),a(d)})},set_fen(d){a(d)},set_last_move(d){f(d)},get dests(){return o()},get fen(){return e()},get last_move(){return i()},get on_last_move_added(){return s()},get check(){return l().isCheck()},get isEnd(){return l().isEnd()}}}function gt(e){let a,i;return se(()=>{let u=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:u,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};i=it(a,c)}),q(()=>{let u;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;u=[s.slice(0,2),s.slice(2,4)]}i.set({lastMove:u,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),q(()=>{i.setAutoShapes(e.shapes??[])}),(()=>{var u=pt();return Z(s=>a=s,u),u})()}function Ie(e,a,i,u){let s=je(a,i),c=Ne(s),l=he(a.toSetup());a.play(s);let r=he(a.toSetup());return{path:u.length===0?c:`${u} ${c}`,ply:e,before_fen:l,fen:r,uci:c,san:i}}function Te(e,a,i){let u=a[a.length-1];return i||(i=te.fromSetup(ne(u?.fen??V).unwrap()).unwrap()),[...a,Ie((u?.ply??0)+1,i,e,u?.path??"")]}function Se(e,a=V){let i=[],u=te.fromSetup(ne(a).unwrap()).unwrap();for(let s of e)i=Te(s,i,u);return i}var vt=j("<div class=replay-single><div class=moves>"),mt=j("<span class=index>"),yt=j("<span><span class=san>"),Ce=j("<span class=eval>"),Ee=j("<span class=loading>."),bt=j("<span class=judgement>");function $t(){let[e,a]=$([]);const i=C(()=>{let t=e();return t[t.length-1]});let[u,s]=$(i()?.ply??0);const c=C(()=>{let t=u();return e().find(p=>p.ply===t)});let l=C(ge(e,t=>t.san)),r=C(ge(e,t=>t.ply)),o=C(()=>{let t=l(),n=r();return t.map((p,_)=>`${n[_]} ${p}`)});const h=t=>{s(t)},f=()=>{let t=u()-1;return r().find(n=>n===t)},d=()=>{let t=u()+1;return r().find(n=>n===t)};return{set_sans(t){a(Se(t)),s(t.length)},get steps(){return e()},get steps_up_to_ply(){return e().slice(0,u())},get plies(){return r()},get sans(){return l()},get ply_sans(){return o()},get ply_step(){return c()},get last_step(){return i()},get ply(){return u()},goto_ply:h,get_prev_ply:f,get_next_ply:d,goto_prev_ply_if_can(){let t=f();t!==void 0&&h(t),u()===1&&s(0)},goto_next_ply_if_can(){let t=d();t!==void 0&&h(t)},play_san(t){let n=i();if(!n){a(Se([t]));return}let p=e();a(Te(t,p)),s(n.ply+1)},get is_on_last_ply(){return u()===(i()?.ply??0)}}}function wt(e){const a=C(ge(()=>e.play_replay.ply_sans,l=>{let[r,o]=l.split(" ");return{ply:parseInt(r),san:o}})),i=l=>{e.play_replay.goto_ply(l)},u=C(()=>e.play_replay.ply_step?.ply);q(W(()=>e.play_replay.steps,l=>e.steps_stockfish.set_steps(l)));let s;const c=l=>{let r=e.steps_stockfish.steps_with_stockfish[l];if(!r)return"";let o=r.d20pv6[1](),h=r.d20pv1[1](),f=r.d8pv6[1](),d=r.d8pv1[1]();if(o)return(o.judgement??"")+" d20pv6";if(h)return(h.judgement??"")+" d20pv1";if(f)return(f.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return q(W(a,l=>{if(l.length<7)return;let r=s.parentElement,o;if(e.play_replay.ply<3)o=0;else if(e.play_replay.is_on_last_ply)o=99999;else{let h=r.querySelector(".active");h&&(o=h.offsetTop-s.offsetHeight/2+h.offsetHeight/2)}o!==void 0&&r.scrollTo({behavior:"smooth",top:o})})),(()=>{var l=vt(),r=l.firstChild;return Z(o=>s=o,r),b(r,y(Re,{get each(){return a()},children:(o,h)=>[y(T,{get when(){return o.ply%2===1},get children(){var f=mt();return b(f,()=>Math.ceil(o.ply/2)),f}}),(()=>{var f=yt(),d=f.firstChild;return f.$$click=()=>i(o.ply),b(d,()=>o.san),b(f,y(T,{get when(){return e.steps_stockfish.steps_with_stockfish[h()]},children:t=>y(kt,{get ss(){return t()}})}),null),oe(()=>F(f,"move "+c(h())+(o.ply===u()?" active":""))),f})()]})),l})()}function kt(e){return y(et,{get fallback(){return y(J,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[y(ae,{get when(){return e.ss.d20pv6[1]()},children:a=>y(J,{get step(){return a()}})}),y(ae,{get when(){return e.ss.d20pv1[1]()},children:a=>y(J,{get step(){return a()}})}),y(ae,{get when(){return e.ss.d8pv6[1]()},children:a=>y(J,{get step(){return a()}})}),y(ae,{get when(){return e.ss.d8pv1[1]()},children:a=>y(J,{get step(){return a()}})})]}})}function J(e){const a=()=>e.step.search?.cp,i=()=>e.step.judgement,u=c=>c==="good"?"✓":c==="inaccuracy"?"?!":c==="mistake"?"?":"??",s=()=>e.step.progress?.depth;return(()=>{var c=Ce();return b(c,y(T,{get when(){return a()!==void 0},get fallback(){return(()=>{var l=Ee();return l.firstChild,b(l,s,null),l})()},get children(){var l=Ce();return b(l,()=>xt(a())),l}}),null),b(c,y(T,{get when(){return i()},get fallback(){return Ee()},children:l=>(()=>{var r=bt();return b(r,()=>u(l())),r})()}),null),c})()}function xt(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}me(["click"]);var fe=Symbol("fallback");function Me(e){for(const a of e)a.dispose()}function De(e,a,i,u={}){const s=new Map;return ee(()=>Me(s.values())),()=>{const l=e()||[];return l[tt],nt(()=>{if(!l.length)return Me(s.values()),s.clear(),u.fallback?[ke(d=>(s.set(fe,{dispose:d}),u.fallback()))]:[];const r=new Array(l.length),o=s.get(fe);if(!s.size||o){o?.dispose(),s.delete(fe);for(let f=0;f<l.length;f++){const d=l[f],t=a(d,f);c(r,d,f,t)}return r}const h=new Set(s.keys());for(let f=0;f<l.length;f++){const d=l[f],t=a(d,f);h.delete(t);const n=s.get(t);n?(r[f]=n.mapped,n.setIndex?.(f),n.setItem(()=>d)):c(r,d,f,t)}for(const f of h)s.get(f)?.dispose(),s.delete(f);return r})};function c(l,r,o,h){ke(f=>{const[d,t]=$(r),n={setItem:t,dispose:f};if(i.length>1){const[p,_]=$(o);n.setIndex=_,n.mapped=i(d,p)}else n.mapped=i(d);s.set(h,n),l[o]=n.mapped})}}function St(e){const{by:a}=e;return C(De(()=>e.each,typeof a=="function"?a:i=>i[a],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var Ct=j("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),Ue=j("<span class=index>"),Et=j("<div class=fbt>"),Mt=j("<div class=lines>"),Pt=j("<div class=line>"),Lt=j("<span class=collapsed>..<!> "),jt=j("<div>");function Nt(e){return rt(e).map(a=>{let i=a.headers.get("Event"),u=a.headers.get("Site"),s=a.headers.get("White"),c=a.headers.get("Black"),l=a.headers.get("Chapter"),r=a.headers.get("Orientation"),o=a.headers.get("FEN"),h=o??V,f=te.fromSetup(ne(h).unwrap()).unwrap(),d=We();a.moves.children.forEach(n=>{t(n,f,"")});function t(n,p,_){let g=n.data.san,v=je(p,g),w=p.clone();w.play(v);let S=Ne(v),k=n.data.nags;d.add_child_san(_,g).set_nags(k??[]);let M=_.length===0?S:`${_} ${S}`;n.children.forEach(E=>{t(E,w,M)})}return{event:i,site:u,white:s,black:c,chapter:l,fen:o,orientation:r,tree:d}})}function We(){let[e,a]=$([]);const i=l=>u(l)?.[1],u=l=>{if(l==="")return;let r=l.split(" "),o=0,h,f=e();for(;;){let d=r.slice(0,o+1).join(" "),t=f.find(n=>n.path===d);if(!t)return;if(o++,o===r.length)return[h,t];h=t,f=t.children}};function s(l,r=!1){let o=l.ply,h=o%2===1||r?Math.ceil(o/2)+(o%2===1?".":"..."):"",f=o%2===1?"":" ";return`${h} ${l.san}${l.comments?" { "+l.comments+" }":""}${f}`}function c(l,r=!1){let o="";return l.length===0||(l.length===1?(o+=s(l[0].step,r),o+=c(l[0].children,!1)):(o+=s(l[0].step,!1).trimEnd(),o+=" "+l.slice(1).map(h=>`(${c([h],!0).trimEnd()})`).join(" "),o+=" "+c(l[0].children,!0))),o}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(l){if(l.length===0)return[];let r=l[0],o=this.add_child_san("",r),h=[o];return l.slice(1).forEach(f=>{o=o.add_child_san(f),h.push(o)}),h},add_child_san(l,r){if(l===""){let h=e(),f=h.find(n=>n.san===r);if(f)return f;let d=te.fromSetup(ne(V).unwrap()).unwrap(),t=Be(0,d,r,"");return a([...h,t]),t}let o=i(l);if(o)return o.add_child_san(r)},remove_child_at_path(l){let r=u(l);if(r){if(!r[0]){let o=e(),h=o.indexOf(r[1]);return o.splice(h,1),a([...o]),r[1]}return r[0].remove_child(r[1]),r[1]}},find_at_path:i,find_parent_and_child_at_path:u,siblings_of(l){let r=u(l)?.[0];if(r)return r.children;if(l.split(" ").length===1)return e()},previous_branch_points(l){let r=[],o=e(),h=o.length>1;for(let f of l.split(" ")){let d=o.find(t=>t.step.uci===f);if(!d)return;h&&(r.push(d),h=!1),d.children.length>1&&(h=!0),o=d.children}return r}}}function Be(e,a,i,u){let[s,c]=$([]),[l,r]=$([]);a=a.clone();let o=Ie(e,a,i,u),h=()=>f()?.length??0,f=()=>d()?.children,d=()=>{let n=s();if(n.length!==0)return n.length===1?n[0].first_node_with_variations:t},t={get nags(){return l()},set_nags:r,get path(){return o.path},get ply(){return o.ply},get san(){return o.san},step:o,get children(){return s()},remove_child(n){let p=s(),_=p.indexOf(n);if(_!==-1)return p.splice(_,1),c([...p]),n},add_child_san(n){let p=s(),_=p.find(v=>v.san===n);if(_)return _;let g=Be(e+1,a,n,o.path);return c([...p,g]),g},remove_child_san(n){let p=s(),_=p.findIndex(v=>v.step.san!==n);if(_===-1)return;let g=p.splice(_,1)[0];return c([...p]),g},get nb_first_variations(){return h()},get first_node_with_variations(){return d()},get length(){let n=s();if(n.length>1)return 1;if(n.length===0)return 0;let p=1,_=n[0];for(;_?.children.length===1;)p++,_=_.children[0];return p}};return t}function Rt(e){let a=We();e&&(a=Nt(e)[0].tree);let[i,u]=$(""),s=[];q(W(i,t=>{a.previous_branch_points(t)?.map(n=>{s.includes(n.path)||(a.siblings_of(n.path)?.forEach(p=>{s=s.filter(_=>_!==p.path)}),s.push(n.path))})}));const c=t=>{u(t)},l=()=>{let t=i();if(t!=="")return t.split(" ").slice(0,-1).join(" ")},r=()=>{let t=i(),n=a.find_at_path(t)?.children??a.root;return n.length===1?n[0].path:n.find(p=>s.includes(p.path))?.path??n[0]?.path},o=()=>{let t=a.find_parent_and_child_at_path(i());if(!t)return;let n=t;if(!n[0])return"";if(n[0].children.length>1)return n[0].path;for(;!(!n[0]||n[0].children.length>1);){let p=a.find_parent_and_child_at_path(n[0].path);if(!p)break;n=p}return n[1].path},h=()=>{let t=a.find_at_path(i());if(!t)return a.root.find(p=>s.includes(p.path))?.path??a.root[0]?.path;let n=t;if(n.children.length>1)return n.children.find(p=>s.includes(p.path))?.path??n.children[0]?.path;for(;n.children.length===1;)n=n.children[0];return n.path},f=()=>{let t=a.find_parent_and_child_at_path(i());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=a.root;else if(t[0].children.length===1)for(;;){if(t=a.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=a.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p-1];if(_)return _.path},d=()=>{let t=a.find_parent_and_child_at_path(i());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=a.root;else if(t[0].children.length===1)for(;;){if(t=a.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=a.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p+1];if(_)return _.path};return{steps:a,get cursor_path(){return i()},set cursor_path(t){u(t)},get cursor_path_step(){return a.find_at_path(i())?.step},goto_path:c,get_prev_path:l,get_next_path:r,goto_prev_if_can(){let t=l();t!==void 0&&c(t)},goto_next_if_can(){let t=r();t!==void 0&&c(t)},get_first_path:o,get_last_path:h,get_up_path:f,get_down_path:d,goto_up_if_can(){let t=f();t!==void 0&&c(t)},goto_down_if_can(){let t=d();t!==void 0&&c(t)},goto_last_if_can(){let t=h();t!==void 0&&c(t)},goto_first_if_can(){let t=o();t!==void 0&&c(t)},get previous_branch_points_at_cursor_path(){return a.previous_branch_points(i())??[]}}}function qt(e){const a=e.play_replay.steps;let i;q(()=>{let s=e.play_replay.cursor_path,c=i.parentElement;if(!c)return;const l=i.querySelector(".on-path-end");if(!l){c.scrollTop=s.length>0?99999:0;return}let r=l.offsetTop-c.offsetHeight/2+l.offsetHeight;c.scrollTo({behavior:"smooth",top:r})});const u=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return se(()=>{document.addEventListener("keydown",u),ee(()=>{document.removeEventListener("keydown",u)})}),(()=>{var s=Ct(),c=s.firstChild,l=c.firstChild,r=c.nextSibling,o=r.firstChild,h=o.nextSibling,f=r.nextSibling,d=f.firstChild,t=d.nextSibling,n=t.nextSibling,p=n.nextSibling;return Z(_=>i=_,l),b(l,y(ve,{get nodes(){return a.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:_=>e.play_replay.cursor_path=_,on_context_menu:(_,g)=>e.on_context_menu?.(_,g)})),o.$$click=()=>e.play_replay.goto_up_if_can(),h.$$click=()=>e.play_replay.goto_down_if_can(),b(r,y(Re,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:_=>(()=>{var g=Et();return g.$$click=()=>e.play_replay.cursor_path=_.path,b(g,y(T,{get when(){return _.ply&1},get children(){var v=Ue();return b(v,()=>Oe(_.ply)),v}}),null),b(g,()=>_.san,null),g})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),t.$$click=()=>e.play_replay.goto_prev_if_can(),n.$$click=()=>e.play_replay.goto_next_if_can(),p.$$click=()=>e.play_replay.goto_last_if_can(),oe(_=>{var g=e.play_replay.get_up_path()===void 0,v="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),w=e.play_replay.get_down_path()===void 0,S="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),k=e.play_replay.get_first_path()===void 0,M="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),E=e.play_replay.get_prev_path()===void 0,R="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),x=e.play_replay.get_next_path()===void 0,B="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),A=e.play_replay.get_last_path()===void 0,O="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return g!==_.e&&(o.disabled=_.e=g),v!==_.t&&F(o,_.t=v),w!==_.a&&(h.disabled=_.a=w),S!==_.o&&F(h,_.o=S),k!==_.i&&(d.disabled=_.i=k),M!==_.n&&F(d,_.n=M),E!==_.s&&(t.disabled=_.s=E),R!==_.h&&F(t,_.h=R),x!==_.r&&(n.disabled=_.r=x),B!==_.d&&F(n,_.d=B),A!==_.l&&(p.disabled=_.l=A),O!==_.u&&F(p,_.u=O),_},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function ve(e){return[y(T,{get when(){return e.nodes.length===1},get children(){return[y(pe,Y(e,{get node(){return e.nodes[0]}})),y(ve,Y(e,{get nodes(){return e.nodes[0].children}}))]}}),y(T,{get when(){return e.nodes.length>1},get children(){var a=Mt();return b(a,y(St,{get each(){return e.nodes},by:"path",children:i=>(()=>{var u=Pt();return b(u,y(T,{get when(){return e.cursor_path.startsWith(i().path)},get fallback(){return[y(pe,Y(e,{get node(){return i()},show_index:!0,collapsed:!0})),(()=>{var s=Lt(),c=s.firstChild,l=c.nextSibling;return l.nextSibling,b(s,()=>i().length,l),b(s,()=>i().nb_first_variations,null),s})()]},get children(){return[y(pe,Y(e,{get node(){return i()},show_index:!0})),y(ve,Y(e,{get nodes(){return i().children}}))]}})),u})()})),a}})]}function pe(e){let a=C(()=>e.node.ply%2===0||e.show_index),i=C(()=>e.node.ply%2===0?".":"...");const u=C(()=>e.node.path),s=C(()=>e.cursor_path.startsWith(u())),c=C(()=>u()===e.cursor_path),l=C(()=>{let r=["move"];return e.collapsed&&r.push("collapsed"),s()&&r.push("on-path"),c()&&r.push("on-path-end"),r.join(" ")});return(()=>{var r=jt();return r.$$click=()=>{e.on_set_cursor(e.node.path)},r.$$contextmenu=o=>{o.preventDefault(),e.on_context_menu(o,e.node.path)},b(r,y(T,{get when(){return a()},get children(){var o=Ue();return b(o,()=>Math.floor(e.node.ply/2)+1,null),b(o,i,null),o}}),null),b(r,()=>e.node.san,null),oe(()=>F(r,l())),r})()}const Oe=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");me(["click","contextmenu"]);const At=(e,a)=>e==="white"?a:-a,He=e=>2/(1+Math.exp(-.00368208*e))-1,It=e=>He(Math.min(Math.max(-1e3,e),1e3)),Tt=e=>{const i=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return He(i)},Dt=e=>typeof e.mate<"u"?Tt(e.mate):It(e.cp),Pe=(e,a)=>At(e,Dt(a)),Ut=(e,a,i)=>(Pe(e,a)-Pe(e,i))/2,Wt=(e,a,i)=>Ut(e,a,i);function Bt(){let e=qe(ye);function a(n,p,_,g,v,w,S){e.best_move_with_cache(o(),n,p,_,g,v,w,S)}let i,u=[];function s(n,p,_,g){let[v,w]=$(void 0),[S,k]=$(void 0),[M,E]=$(void 0),R={get loading(){return v()},get depth_eval(){return S()},get best_eval(){return M()},cancel:B},x={cancel:B,fen:n,ply:p,depth:_,multi_pv:g,set_loading:w,set_depth_eval:k,set_best_eval:E};function B(){let A=u.indexOf(x);A!==-1&&u.splice(A,1),i===x&&(console.trace("working cancel"),i=void 0,e.stop()),c()}return u.push(x),c(),R}function c(){if(i||(i=u.pop(),!i))return;const n=p=>{i?.set_best_eval(p),i=void 0,c()};a(i.fen,i.ply,i.multi_pv,i.depth,i.set_loading,i.set_depth_eval,n)}function l(n,p,_){let g=s(n.before_fen,n.ply-1,p,_),v=s(n.fen,n.ply,p,_);function w(S,k,M){let E=Wt(S,k,M);return E<.03?"good":E<.05?"inaccuracy":E<.12?"mistake":"blunder"}return C(()=>(ee(()=>{v.cancel(),g.cancel()}),{...n,get before_search(){return g.best_eval},get search(){return n.fen,v.best_eval?.fen,v.best_eval},get judgement(){let S=g.best_eval,k=v.best_eval;if(S&&k)return w(Ae(n.before_fen),S,k)},get progress(){return v?.depth_eval}}))}function r(n){let[p,_]=$(K(()=>l(n,8,6)())),[g,v]=$(K(()=>l(n,8,1)())),[w,S]=$(K(()=>l(n,20,6)())),[k,M]=$(K(()=>l(n,20,1)()));return{step:n,get d8pv6(){return p()},get d8pv1(){return g()},get d20pv6(){return w()},get d20pv1(){return k()},clear(){_(K(()=>l(n,8,6)())),S(K(()=>l(n,20,6)())),v(K(()=>l(n,8,1)())),M(K(()=>l(n,20,1)()))}}}let[o,h]=$(""),[f,d]=$([]),t=De(f,n=>[n.fen,n.uci].join("$$"),n=>r(n()));return{set_game_id:h,set_steps:d,get steps_with_stockfish(){return t()}}}var Ot=j("<div class=loading><span class=info>Loading <!>%"),Ht=j("<div class=engine-wrap><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth 8</label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),Ft=j("<span class=result>Game Over"),zt=j("<small class=drop>Evaluation Dropped Below -2"),Kt=j("<div class=result-wrap>"),Vt=j("<div class=tools-wrap><button class=save>Save Line</button><button class=rematch>Rematch"),Gt=j("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tabs-wrap><div>Match</div><div>Repertoire"),Qt=j("<div class=context-menu><div class=title></div><a class=delete data-icon=>Delete move");const tn=()=>y(ft,{get children(){return y(Xt,{})}});function Xt(){let[e]=Le(()=>qe(ye));const a=C(()=>{let i=e()?.download_nb;if(i)return Math.ceil(i.bytes/(i.total===0?70*1024*1024:i.total)*100)});return y(T,{get when(){return e()},children:i=>y(T,{get when(){return i().state==="loading"},get fallback(){return y(Yt,{})},get children(){var u=Ot(),s=u.firstChild,c=s.firstChild,l=c.nextSibling;return l.nextSibling,b(s,()=>a()??"--",l),u}})})}function Yt(){const e=lt();e.setVolume(.2);let[a,i]=ue([],"builder.current.sans");const[u,s]=$(8);let c="";const l=Bt(),r=$t();let o=ht();const[h,f]=$("white"),d=C(()=>xe(h())),t=C(()=>{let m=l.steps_with_stockfish;return m[m.length-1]});function n(m){return u()===8?m.d8pv6:m.d20pv6}function p(m){return u()===8?m.d8pv1[0]():m.d20pv1[0]()}q(W(t,m=>{if(!m)return;if(Ae(m.step.fen)===d()){let I=n(m)[0]();q(W(()=>I.search,U=>{if(!U)return;let z=U.pvs;o.play_uci(z[0].moves[0])}))}})),q(W(()=>o.on_last_move_added,m=>{m&&r.play_san(m[1])})),q(W(()=>r.sans,i)),q(W(()=>r.ply_step,m=>{o.set_fen_and_last_move(m?.fen??V,m?.uci)})),q(W(()=>r.ply_step,(m,P)=>{m&&(!P||P.ply===m.ply-1)&&e.move(m)}));const _=st(m=>{const P=m.target;P.tagName!=="PIECE"&&P.tagName!=="SQUARE"&&P.tagName!=="CG-BOARD"||(m.preventDefault(),g(Math.sign(m.deltaY)))}),g=m=>{m>0?(A()==="match"&&r.goto_next_ply_if_can(),A()==="repertoire"&&x.goto_next_if_can()):(A()==="match"&&r.goto_prev_ply_if_can(),A()==="repertoire"&&x.goto_prev_if_can())};l.set_game_id(c),r.set_sans(a());const v=()=>{i([]),r.set_sans(a()),o.set_fen_and_last_move(V),R(void 0)};q(W(u,()=>{l.steps_with_stockfish.forEach(P=>{ie(()=>{P.clear(),p(P)})});let m=t();m&&n(m)[0]()})),q(W(t,m=>{if(!m)return;let P=p(m);q(W(()=>P.search,I=>{let U=I?.cp;U&&U<-200&&R("drop")}))}));let[w,S]=ue("","builder.current.cursor_path"),[k,M]=ue(void 0,"builder.current.pgn");const[E,R]=$(void 0),x=Rt(k());x.cursor_path=w(),q(W(()=>x.cursor_path,m=>{S(m)}));const B=()=>{ie(()=>{let P=r.steps_up_to_ply.map(z=>z.san),I=x.steps.add_sans_at_root(P),U=I[I.length-1]?.path;U&&(O("repertoire"),x.cursor_path=U,M(x.steps.as_pgn))})},[A,O]=$("match");let X,N;const Fe=(m,P)=>{x.cursor_path=P,de(x.steps.find_at_path(P));let I=m.clientX,U=m.clientY,z=N.getBoundingClientRect(),G=X.getBoundingClientRect();I-=G.left,U-=G.top,I=Math.min(I,document.body.clientWidth-z.width-G.left-20);let L=`${U}px`,D=`${I}px`;N.style.top=L,N.style.left=D};se(()=>{const m=()=>{de(void 0)};document.addEventListener("click",m),ee(()=>{document.removeEventListener("click",m)})});const[ze,de]=$(void 0),Ke=m=>{x.steps.remove_child_at_path(m),de(void 0)},be=m=>{s(m)},Ve=C(()=>!o.isEnd&&r.is_on_last_ply&&E()===void 0);return se(()=>{const m=P=>{P.key==="f"&&f(xe(h()))};document.addEventListener("keypress",m),ee(()=>{document.removeEventListener("keypress",m)})}),(()=>{var m=Gt(),P=m.firstChild,I=P.nextSibling,U=I.firstChild,z=U.firstChild,G=z.nextSibling;return at(m,"wheel",_),Z(L=>X=L,m),b(P,y(gt,{get orientation(){return h()},get color(){return h()},get movable(){return Ve()},play_uci:o})),z.$$click=()=>O("match"),G.$$click=()=>O("repertoire"),b(I,y(T,{get when(){return A()==="match"},get children(){return[(()=>{var L=Ht(),D=L.firstChild,H=D.firstChild,re=H.firstChild,Q=H.nextSibling,Ge=Q.firstChild;return re.addEventListener("change",ce=>{ce.target.checked&&be(8)}),re.checked=!0,Ge.addEventListener("change",ce=>{ce.target.checked&&be(20)}),L})(),y(wt,{play_replay:r,steps_stockfish:l}),(()=>{var L=Kt();return b(L,y(T,{get when(){return E()==="drop"},get children(){return[Ft(),zt()]}})),L})(),(()=>{var L=Vt(),D=L.firstChild,H=D.nextSibling;return D.$$click=B,H.$$click=v,L})()]}}),null),b(I,y(T,{get when(){return A()==="repertoire"},get children(){return y(qt,{play_replay:x,on_context_menu:Fe})}}),null),b(m,y(T,{get when(){return ze()},children:L=>(()=>{var D=Qt(),H=D.firstChild,re=H.nextSibling;return Z(Q=>N=Q,D),D.$$click=Q=>{Q.preventDefault(),Q.stopImmediatePropagation()},b(H,()=>Oe(L().ply),null),b(H,()=>L().san,null),re.$$click=()=>Ke(L().path),D})()}),null),oe(L=>{var D="tab"+(A()==="match"?" active":""),H="tab"+(A()==="repertoire"?" active":"");return D!==L.e&&F(z,L.e=D),H!==L.t&&F(G,L.t=H),L},{e:void 0,t:void 0}),m})()}me(["click"]);export{tn as default};
