import{m as _n,C as Ct,P as Se,n as gt,o as Q,p as J,I as X,q as $,r as ge,v as fn,R as pt,w as ze,x as Le,y as Ve,z as F,B as mt,D as Ye,E as gn,G as nt,t as h,i as u,e as B,f as Z,d as Me,H as Ze,J as Te,K as pn,L as mn,N as Je,O as q,Q as vn,b as L,T as bn,U as it,j as qe,V as St,c,W as Ce,F as $e,X as xt,Y as ke,Z as kn,_ as Ie,$ as Ae,a0 as Re,a1 as $n,a2 as wn,a3 as yn,k as E,l as Et,g as re,a4 as Cn,a5 as Xe,a6 as pe,a7 as et,a8 as Lt,a9 as Sn,u as xn,aa as Ot,ab as qt,ac as En,ad as Ln,ae as We,af as Bt,ag as Nt,ah as Pt,ai as Tt,aj as On,ak as st,al as qn,am as Bn,s as Nn,an as Pn,ao as Tn}from"./index-BXnrJJ4u.js";import{o as vt,C as Rn,e as bt,d as In,a as Rt,P as It,b as At,n as zt}from"./random-hAcrWrPC.js";const An=e=>_n(e);class zn extends Se{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=gt.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():gt.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?Q.err(new J(X.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?Q.err(new J(X.Variant)):Q.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,i;const s=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?$.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?$.backranks().complement():$.empty());if(t=t||this.ctx(),ge(t.king)&&t.checkers.nonEmpty()){const a=t.checkers.singleSquare();return ge(a)?s.intersect(fn(a,t.king)):$.empty()}else return s}}class Mn extends Se{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()>2)return Q.err(new J(X.Kings));const t=this.board.kingOf(F(this.turn));return ge(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Q.err(new J(X.OppositeCheck)):$.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0):Q.err(new J(X.Kings))}kingAttackers(t,n,i){const s=this.board.pieces(n,"king");return s.isEmpty()||Ve(t).intersects(s)?$.empty():super.kingAttackers(t,n,i)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(const i of Ve(t).intersect(this.board.occupied).diff(this.board.pawn)){const s=this.board.take(i);s?.role==="rook"&&this.castles.discardRook(i),s?.role==="king"&&this.castles.discardColor(s.color)}}hasInsufficientMaterial(t){if(this.board.pieces(F(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[F(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects($.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects($.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects($.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects($.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let i=$.empty();for(const s of Ye(this,t,n)){const a=this.clone();a.play({from:t,to:s});const o=a.board.kingOf(this.turn);ge(o)&&(!ge(a.board.kingOf(a.turn))||a.kingAttackers(o,a.turn,a.board.occupied).isEmpty())&&(i=i.with(s))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").isEmpty())return{winner:F(n)}}}class Un extends Se{constructor(){super("antichess")}reset(){super.reset(),this.castles=Le.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Q.err(new J(X.Empty)):$.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0)}kingAttackers(t,n,i){return $.empty()}ctx(){const t=super.ctx();if(ge(this.epSquare)&&gn(F(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const n=this.board[F(this.turn)];for(const i of this.board[this.turn])if(Ye(this,i,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();const i=Ye(this,t,n),s=this.board[F(this.turn)];return i.intersect(n.mustCapture?ge(this.epSquare)&&this.board.getRole(t)==="pawn"?s.with(this.epSquare):s:$.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[F(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[t].intersects($.lightSquares()),i=this.board[t].intersects($.darkSquares()),s=this.board[F(t)].isDisjoint($.lightSquares()),a=this.board[F(t)].isDisjoint($.darkSquares());return n&&s||i&&a}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects($.lightSquares())!==this.board.black.intersects($.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Gn extends Se{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects($.center())}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").intersects($.center()))return{winner:n}}}class Kn extends Se{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=pt.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||pt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const n of ze)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Dn=()=>{const e=nt.empty();return e.occupied=new $(65535,0),e.promoted=$.empty(),e.white=new $(61680,0),e.black=new $(3855,0),e.pawn=$.empty(),e.knight=new $(6168,0),e.bishop=new $(9252,0),e.rook=new $(16962,0),e.queen=new $(129,0),e.king=new $(33024,0),e};class Wn extends Se{constructor(){super("racingkings")}reset(){this.board=Dn(),this.pockets=void 0,this.turn="white",this.castles=Le.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?Q.err(new J(X.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let i=$.empty();for(const s of super.dests(t,n)){const a={from:t,to:s},o=this.clone();o.play(a),o.isCheck()||(i=i.with(s))}return i}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=$.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(ge(i)){const s=this.board.occupied.without(i);for(const a of Ve(i).intersect(t).diff(this.board.black))if(this.kingAttackers(a,"white",s).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const n=$.fromRank(7),i=this.board.pieces("black","king").intersects(n),s=this.board.pieces("white","king").intersects(n);return i&&!s?{winner:"black"}:s&&!i?{winner:"white"}:{winner:void 0}}}const Qn=()=>{const e=nt.empty();return e.occupied=new $(4294967295,4294901862),e.promoted=$.empty(),e.white=new $(4294967295,102),e.black=new $(0,4294901760),e.pawn=new $(4294967295,16711782),e.knight=new $(0,1107296256),e.bishop=new $(0,603979776),e.rook=new $(0,2164260864),e.queen=new $(0,134217728),e.king=new $(0,268435456),e};class Fn extends Se{constructor(){super("horde")}reset(){this.board=Qn(),this.pockets=void 0,this.turn="white",this.castles=Le.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()!==1)return Q.err(new J(X.Kings));const t=this.board.kingOf(F(this.turn));if(ge(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return Q.err(new J(X.OppositeCheck));for(const n of ze){const i=this.board.pieces(n,"king").isEmpty()?$.backrank(F(n)):$.backranks();if(this.board.pieces(n,"pawn").intersects(i))return Q.err(new J(X.PawnsOnBackrank))}return Q.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const n=v=>v==="light"?"dark":"light",i=v=>v==="light"?$.lightSquares():$.darkSquares(),s=v=>{const g=this.board.pieces(v,"bishop");return g.intersects($.darkSquares())&&g.intersects($.lightSquares())},a=mt.fromBoard(this.board,t),o=v=>i(v).intersect(this.board.pieces(t,"bishop")).size(),d=o("light")>=1?"light":"dark",l=a.pawn+a.knight+a.rook+a.queen+Math.min(o("dark"),2)+Math.min(o("light"),2),r=mt.fromBoard(this.board,F(t)),m=v=>i(v).intersect(this.board.pieces(F(t),"bishop")).size(),b=r.size(),C=v=>b-v;if(l===0)return!0;if(l>=4||(a.pawn>=1||a.queen>=1)&&l>=2||a.rook>=1&&l>=2&&!(l===2&&a.rook===1&&a.bishop===1&&C(m(d))===1))return!1;if(l===1){if(b===1)return!0;if(a.queen===1)return!(r.pawn>=1||r.rook>=1||m("light")>=2||m("dark")>=2);if(a.pawn===1){const v=this.board.pieces(t,"pawn").last(),g=this.clone();g.board.set(v,{color:t,role:"queen"});const k=this.clone();return k.board.set(v,{color:t,role:"knight"}),g.hasInsufficientMaterial(t)&&k.hasInsufficientMaterial(t)}else{if(a.rook===1)return!(r.pawn>=2||r.rook>=1&&r.pawn>=1||r.rook>=1&&r.knight>=1||r.pawn>=1&&r.knight>=1);if(a.bishop===1)return!(m(n(d))>=2||m(n(d))>=1&&r.pawn>=1||r.pawn>=2);if(a.knight===1)return!(b>=4&&(r.knight>=2||r.pawn>=2||r.rook>=1&&r.knight>=1||r.rook>=1&&r.bishop>=1||r.knight>=1&&r.bishop>=1||r.rook>=1&&r.pawn>=1||r.knight>=1&&r.pawn>=1||r.bishop>=1&&r.pawn>=1||s(F(t))&&r.pawn>=1)&&(m("dark")<2||C(m("dark"))>=3)&&(m("light")<2||C(m("light"))>=3))}}else{if(l===2)return b===1?!0:a.knight===2?r.pawn+r.bishop+r.knight<1:s(t)?!(r.pawn>=1||r.bishop>=1||r.knight>=1&&r.rook+r.queen>=1):a.bishop>=1&&a.knight>=1?!(r.pawn>=1||m(n(d))>=1||C(m(d))>=3):!(r.pawn>=1&&m(n(d))>=1||r.pawn>=1&&r.knight>=1||m(n(d))>=1&&r.knight>=1||m(n(d))>=2||r.knight>=2||r.pawn>=2);if(l===3)return a.knight===2&&a.bishop===1||a.knight===3||s(t)?!1:b===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const Hn=(e,t)=>{switch(e){case"chess":return Ct.fromSetup(t);case"antichess":return Un.fromSetup(t);case"atomic":return Mn.fromSetup(t);case"horde":return Fn.fromSetup(t);case"racingkings":return Wn.fromSetup(t);case"kingofthehill":return Gn.fromSetup(t);case"3check":return Kn.fromSetup(t);case"crazyhouse":return zn.fromSetup(t)}},jn=(e=rt)=>({headers:e(),moves:new Mt});class Mt{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const n=t.children[0];yield n,t=n}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class Vn extends Mt{constructor(t){super(),this.data=t}}const Yn=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Zn=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,rt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),kt="\uFEFF",Qe=e=>/^\s*$/.test(e),Fe=e=>e.startsWith("%");class Jn extends Error{}class Xn{constructor(t,n=rt,i=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=jn(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Jn("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let i=0;for(;;){const s=t.indexOf(`
`,i);if(s===-1)break;const a=s>i&&t[s-1]==="\r"?s-1:s;this.consumeBudget(s-i),this.lineBuf.push(t.slice(i,a)),i=s+1,this.handleLine()}this.consumeBudget(t.length-i),this.lineBuf.push(t.slice(i)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(kt)&&(n=n.slice(kt.length)),this.state=1;case 1:if(Qe(n)||Fe(n))return;this.found=!0,this.state=2;case 2:{if(Fe(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(s,a,o)=>(this.consumeBudget(200),this.handleHeader(a,o.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,t=!1,""));if(Qe(n))return;this.state=3}case 3:{if(t){if(Fe(n))return;if(Qe(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let s;for(;s=i.exec(n);){const a=this.stack[this.stack.length-1];let o=s[0];if(o===";")return;if(o.startsWith("$"))this.handleNag(parseInt(o.slice(1),10));else if(o==="!")this.handleNag(1);else if(o==="?")this.handleNag(2);else if(o==="!!")this.handleNag(3);else if(o==="??")this.handleNag(4);else if(o==="!?")this.handleNag(5);else if(o==="?!")this.handleNag(6);else if(o==="1-0"||o==="1–0"||o==="1—0"||o==="0-1"||o==="0–1"||o==="0—1"||o==="1/2-1/2"||o==="1/2–1/2"||o==="1/2—1/2"||o==="*")this.stack.length===1&&o!=="*"&&this.handleHeader("Result",o);else if(o==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(o===")")this.stack.length>1&&this.stack.pop();else if(o==="{"){const d=i.lastIndex,l=n[d]===" "?d+1:d;n=n.slice(l),this.state=4;continue e}else this.consumeBudget(100),o.startsWith("O")||o.startsWith("0")||o.startsWith("o")?o=o.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(o==="Z0"||o==="0000"||o==="@@@@")&&(o="--"),a.node&&(a.parent=a.node),a.node=new Vn({san:o,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const s=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,s)),this.handleComment(),n=n.slice(i),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?Yn(Zn(n)):n)}handleNag(t){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],s=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((t=i.node.data).comments||(t.comments=[]),i.node.data.comments.push(s)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(s)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(s))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const ei=(e,t=rt)=>{const n=[];return new Xn(i=>n.push(i),t,NaN).parse(e),n};var ti=h("<div class=modal-mask><dialog open><div class=close-button-anchor><button class=close-button data-icon=></button></div><div class=scrollable><div>");function He(e){return(()=>{var t=ti(),n=t.firstChild,i=n.firstChild,s=i.firstChild,a=i.nextSibling,o=a.firstChild;return t.$$click=()=>e.on_close(),n.$$click=d=>{d.stopPropagation()},s.$$click=()=>e.on_close(),u(o,()=>e.children),B(()=>Z(o,"dialog-content "+e.klass)),t})()}Me(["click"]);const tt="ABCDEFGHIJKLMNOP".split(""),$t=e=>tt[e];function wt(e){return Je(e.toSetup())}function ni(e){return ei(e).map(t=>{let n=t.headers.get("Event"),i=t.headers.get("Site"),s=t.headers.get("White"),a=t.headers.get("Black"),o=t.headers.get("Chapter"),d=t.headers.get("Orientation"),l=t.headers.get("FEN"),r=l??Te,m=Ct.fromSetup(Ze(r).unwrap()).unwrap(),b={},C={},v={};t.moves.children.forEach(k=>{g(k,m,0,"")});function g(k,_,p,S){let w=k.data.san,R=pn(_,w),I=_.clone();I.play(R);let K=mn(R),z=k.data.nags,D=b[S];D||(D=[],b[S]=D);let N=S.length===0?K:`${S} ${K}`;D.push({path:N,ply:p+1,before_fen:wt(_),fen:wt(I),uci:K,san:w}),z&&(v[N]=z),k.children.forEach(y=>{g(y,I,p+1,N)})}return{event:n,site:i,white:s,black:a,chapter:o,fen:l,orientation:d,flat_steps:b,flat_nags:v,flat_comments:C}})}var ii=h(`<div class="editor is2d"><div class=board-wrap></div><div class=tools-wrap><div class=metadata><div class=color><select><option value=white>White's Turn</option><option value=black>Black's Turn</option></select></div><div class=castling><strong>Castling</strong><div><label><input type=checkbox>White O-O</label><label><input type=checkbox>O-O-O</label></div><div><label><input type=checkbox>Black O-O</label><label><input type=checkbox>O-O-O</label></div></div><div class=enpassant><label for=enpassant-select>En passant</label><select id=enpassant-select><option value selected></option></select></div></div><div class=actions><button>Starting Position</button><button>Clear Board`),si=h("<option>"),ri=h('<div class="is2d chessboard"> '),ai=h("<div>"),oi=h("<div><div><div>");function li(e){const t=m=>[...m].reduce((b,C)=>{const v=parseInt(C);return b+(v>=1?"x".repeat(v):C)},""),n=(m,b,C,v)=>{let g;for(;(g=b.exec(m))!=null;)v.add(g.index+C)},i=new Set,[s,a]=e.split(" "),o=s.split("/"),d=t(o[a==="w"?3:4]);n(d,/pP/g,a==="w"?0:1,i),n(d,/Pp/g,a==="w"?1:0,i);const[l,r]=i.size>=1?[t(o[a==="w"?1:6]),t(o[a==="w"?2:5])]:[null,null];return Array.from(i).filter(m=>l[m]==="x"&&r[m]==="x").map(m=>String.fromCharCode(97+m)+(a==="w"?"6":"3"))}const ci=e=>{const t=()=>Te,[n,i]=q(Te),[s,a]=q("white"),[o,d]=q(),l=["K","Q","k","q"],[r,m]=vn({Q:!1,K:!1,k:!1,q:!1}),b=L(()=>{let y="",x=r;return l.forEach(W=>{x[W]&&(y+=W)}),y}),C=L(()=>{let y=t(),x=n()??y;const W=Ze(x).unwrap(ie=>ie.board,ie=>nt.empty()),ae=s(),oe=bn(W,b()).unwrap();let me=o()?it(o()):void 0;return{board:W,turn:ae,castlingRights:oe,epSquare:me,pockets:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:0}}),v=L(()=>Je(C())),g=L(()=>Hn("chess",C()).unwrap(y=>Je(y.toSetup()),y=>{})),k=L(()=>li(v()));qe(()=>{e.on_change_fen(g())});const _=y=>{ke(()=>{a(y.turn),d(y.epSquare?An(y.epSquare):void 0);let x=Le.fromSetup(y);m("Q",x.rook.white.a!==void 0),m("K",x.rook.white.h!==void 0),m("q",x.rook.black.a!==void 0),m("k",x.rook.black.h!==void 0)})},p=y=>{Ze(y).unwrap(x=>(ke(()=>{i(y),_(x)}),!0),x=>!1)};p(e.initial_fen);const[S,w]=q("pointer"),R=St(S),[I,K]=q(),z=(y,x)=>{if(w(y),y!=="pointer"){if(y!=="trash"){let[W,ae]=y.split(" ");K([W,ae,x])}}},D=L(()=>{let y,x;switch(S()){case"pointer":x="pointer";break;case"trash":y="/cursors/trash.cur";break;default:y=`/cursors/${S().split(" ").join("-")}.cur`}if(x)return{cursor:x};if(y)return{cursor:`url('${y}'), default`}}),N=()=>{let[y,x]=S().split(" ");w(`${vt(y)} ${x}`)};return(()=>{var y=ii(),x=y.firstChild,W=x.nextSibling,ae=W.firstChild,oe=ae.firstChild,me=oe.firstChild,ie=me.firstChild,O=ie.nextSibling,M=oe.nextSibling,le=M.firstChild,te=le.nextSibling,de=te.firstChild,ve=de.firstChild,ne=de.nextSibling,ue=ne.firstChild,be=te.nextSibling,he=be.firstChild,ce=he.firstChild,xe=he.nextSibling,we=xe.firstChild,Ue=M.nextSibling,Ge=Ue.firstChild,Ee=Ge.nextSibling;Ee.firstChild;var Ke=ae.nextSibling,Be=Ke.firstChild,De=Be.nextSibling;return u(y,c(yt,{klass:"spare-top",get color(){return vt(e.orientation)},on_spare:z,is_selected:R}),x),u(x,c(di,{on_set_spare:w,on_toggle_spare:N,get spare(){return S()},get orientation(){return e.orientation},on_change_fen:i,get drag_new_piece(){return I()},get fen(){return n()}})),u(y,c(yt,{klass:"spare-bottom",get color(){return e.orientation},on_spare:z,is_selected:R}),W),Ce(me,"change",A=>a(A.target.value)),ve.addEventListener("change",A=>m("K",A.target.checked)),ue.addEventListener("change",A=>m("Q",A.target.checked)),ce.addEventListener("change",A=>m("k",A.target.checked)),we.addEventListener("change",A=>m("q",A.target.checked)),Ee.addEventListener("change",A=>d(A.target.value)),u(Ee,c($e,{get each(){return k()},children:A=>(()=>{var ye=si();return ye.value=A,u(ye,A),ye})()}),null),Be.$$click=()=>p(Te),De.$$click=()=>p(wn),B(A=>{var ye=D(),Ne=s()==="white",Pe=s()==="black";return A.e=xt(y,ye,A.e),Ne!==A.t&&(ie.selected=A.t=Ne),Pe!==A.a&&(O.selected=A.a=Pe),A},{e:void 0,t:void 0,a:void 0}),B(()=>ve.checked=r.K),B(()=>ue.checked=r.Q),B(()=>ce.checked=r.k),B(()=>we.checked=r.q),y})()};function di(e){const t=()=>{e.on_change_fen(i.getFen())};let n,i;return Ie(()=>{let s={fen:e.fen,orientation:e.orientation,autoCastle:!1,movable:{free:!0,color:"both"},draggable:{showGhost:!0,deleteOnDropOff:!0},premovable:{enabled:!1},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:t}};i=Rn(n,s);const a=l=>{let r=e.spare;r!=="pointer"&&l.preventDefault();const m=bt(l);if(!m)return;let b=i.getKeyAtDomPos(m);if(b){if(r==="trash")o(b);else if(r!=="pointer"){const C=i.state.pieces.get(b);let[v,g]=r.split(" "),k={color:v,role:g};C&&C.color===k.color&&C.role===k.role?o(b):(i.setPieces(new Map([[b,k]])),t())}}},o=l=>{i.setPieces(new Map([[l,void 0]])),t()},d=l=>{let r=e.spare;r!=="pointer"&&l.preventDefault(),r!=="pointer"&&(i.state.drawable.current=void 0,i.state.drawable.shapes=[],l.type==="contextmenu"&&r!=="trash"&&(i.cancelMove(),e.on_toggle_spare()))};n.addEventListener("mousedown",a),n.addEventListener("contextmenu",d),Ae(()=>{n.removeEventListener("mousedown",a),n.removeEventListener("contextmenu",d)})}),qe(()=>{i.set({fen:e.fen})}),qe(()=>{i.set({orientation:e.orientation})}),qe(()=>{let s=e.drag_new_piece;s&&(In(i.state,{color:s[0],role:s[1]},s[2],!0),document.addEventListener("mouseup",a=>{const o=bt(a);o&&i.getKeyAtDomPos(o)&&e.on_set_spare("pointer")},{once:!0}))}),(()=>{var s=ri();return Re(a=>n=a,s),s})()}const yt=e=>{const t=e.is_selected;return(()=>{var n=ai();return u(n,c(je,{onClick:i=>e.on_spare("pointer",i),klass:"pointer",spare:"pointer",get selected(){return t("pointer")},get color(){return e.color}}),null),u(n,c($e,{each:kn,children:i=>c(je,{onClick:s=>e.on_spare(`${e.color} ${i}`,s),klass:"",get spare(){return`${e.color} ${i}`},get selected(){return t(`${e.color} ${i}`)},get color(){return e.color}})}),null),u(n,c(je,{onClick:i=>e.on_spare("trash",i),klass:"trash",spare:"trash",get selected(){return t("trash")},get color(){return e.color}}),null),B(()=>Z(n,"spare "+e.klass+" "+e.color)),n})()},je=e=>(()=>{var t=oi(),n=t.firstChild,i=n.firstChild;return Ce(t,"mousedown",e.onClick,!0),B(s=>{var a="no-square "+e.klass,o=!!e.selected,d="piece "+e.spare,l={[e.color]:!0};return a!==s.e&&Z(t,s.e=a),o!==s.t&&t.classList.toggle("selected",s.t=o),d!==s.a&&Z(i,s.a=d),s.o=$n(i,l,s.o),s},{e:void 0,t:void 0,a:void 0,o:void 0}),t})();Me(["click","mousedown"]);var ui=h("<h2>Edit Opening"),hi=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Opening Name"minlength=3>'),_i=h("<div class=section><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),at=h("<div class=filler>"),Ut=h('<div class="group buttons"><span class=split></span><button class=delete>Delete <i data-icon=>'),fi=h("<h2>Edit Chapter"),Gt=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Section Name"minlength=3>'),gi=h("<div class=group><div class=editor-wrap>"),pi=h("<div class=tabs-wrap><div class=tabs><div class=tab>Empty</div><div class=tab>Editor</div></div><div class=content>"),Kt=h("<div class=section><div class=group><label for=order>Set Order</label><select name=order id=order></select></div><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),mi=h('<div class="group buttons"><button class=delete>Delete <i data-icon=></i></button><span class=split></span><button class=create>Save Changes'),Dt=h("<option>"),vi=h("<h2>Edit Section"),bi=h("<div class=tabs><div>Empty</div><div>Import Lichess Study"),ki=h('<div class=group><label for=name>Import a Study from Lichess</label><input name=name id=name type=text placeholder="Lichess Study URL">'),$i=h("<div class=content>"),wi=h("<button class=import>Import<i data-icon=>"),yi=h("<button class=loading disabled>Loading ...");function Ci(e){const t=(o,d)=>{o==="Escape"&&(d.value=e.study.name)},n=o=>{let d=o.value;d.length<3&&(d="New Chapter",o.value=d),e.on_update_study({id:e.study.id,name:d})},i=()=>{e.on_delete_study()},s=o=>{e.on_update_study({id:e.study.id,orientation:o})},a=L(()=>e.study.orientation);return[ui(),(()=>{var o=hi(),d=o.firstChild,l=d.nextSibling;return l.addEventListener("change",r=>n(r.currentTarget)),l.$$keydown=r=>t(r.key,r.currentTarget),B(()=>l.value=e.study.name),o})(),(()=>{var o=_i(),d=o.firstChild,l=d.firstChild,r=l.nextSibling,m=r.firstChild,b=m.nextSibling;return r.addEventListener("change",C=>s(C.currentTarget.value)),B(C=>{var v=a()==="white",g=a()==="black";return v!==C.e&&(m.selected=C.e=v),g!==C.t&&(b.selected=C.t=g),C},{e:void 0,t:void 0}),o})(),at(),(()=>{var o=Ut(),d=o.firstChild,l=d.nextSibling;return l.$$click=i,o})()]}function Si(e){const t=(g,k)=>{g==="Escape"&&(k.value=e.chapter.name)},n=g=>{let k=g.value;k.length<3&&(k="New Chapter",g.value=k),e.on_edit_chapter({id:e.chapter.id,name:k})},i=g=>{let k=parseInt(g);e.on_order_chapter(k)},s=()=>{e.on_delete_chapter()},a=()=>{let g=l();g&&e.fen!==g&&e.on_change_root_fen(g)},o=g=>{e.on_edit_chapter({id:e.chapter.id,orientation:g})},d=L(()=>e.chapter.orientation),[l,r]=q(),[m,b]=q("editor"),C=St(m),v=L(()=>l()??e.fen);return[fi(),(()=>{var g=Gt(),k=g.firstChild,_=k.nextSibling;return _.addEventListener("change",p=>n(p.currentTarget)),_.$$keydown=p=>t(p.key,p.currentTarget),B(()=>_.value=e.chapter.name),g})(),(()=>{var g=pi(),k=g.firstChild,_=k.firstChild,p=_.nextSibling,S=k.nextSibling;return _.$$click=()=>b("empty"),p.$$click=()=>b("editor"),u(S,c(E,{get when(){return m()==="editor"},get children(){var w=gi(),R=w.firstChild;return u(R,c(ci,{get initial_fen(){return v()},on_change_fen:r,get orientation(){return e.chapter.orientation??"white"}})),w}}),null),u(S,c(E,{get when(){return m()==="empty"},get children(){return[]}}),null),B(w=>{var R=!!C("empty"),I=!!C("editor");return R!==w.e&&_.classList.toggle("active",w.e=R),I!==w.t&&p.classList.toggle("active",w.t=I),w},{e:void 0,t:void 0}),g})(),(()=>{var g=Kt(),k=g.firstChild,_=k.firstChild,p=_.nextSibling,S=k.nextSibling,w=S.firstChild,R=w.nextSibling,I=R.firstChild,K=I.nextSibling;return p.addEventListener("change",z=>i(z.currentTarget.value)),u(p,c($e,{get each(){return[...Array(e.nb_chapters).keys()]},children:(z,D)=>(()=>{var N=Dt();return u(N,()=>D()+1),B(()=>N.selected=e.i_chapter===D()),B(()=>N.value=D()),N})()})),R.addEventListener("change",z=>o(z.currentTarget.value)),B(z=>{var D=d()==="white",N=d()==="black";return D!==z.e&&(I.selected=z.e=D),N!==z.t&&(K.selected=z.t=N),z},{e:void 0,t:void 0}),g})(),at(),(()=>{var g=mi(),k=g.firstChild,_=k.nextSibling,p=_.nextSibling;return k.$$click=s,p.$$click=a,B(()=>p.disabled=v()===void 0),g})()]}function xi(e){const t=(_,p)=>{_==="Escape"&&(p.value=e.section.name)},n=_=>{let p=_.value;p.length<3&&(p="New Section",_.value=p),e.on_edit_section({id:e.section.id,name:p})},i=_=>{let p=tt.indexOf(_);e.on_order_section(p)},s=()=>{e.on_delete_section()},[a,o]=q("lichess"),[d,l]=q(""),r=L(()=>{let _=d().match(/\/study\/([a-zA-Z0-9]{8})\/?$/);return _?`https://lichess.org/api/study/${_[1]}.pgn`:void 0}),m=async _=>await fetch(_).then(p=>p.text()).then(p=>ni(p)),[b]=yn(r,m),C=async()=>{let _=b();_&&e.on_import_pgns(_,e.section.name)},v=L(()=>r()===void 0),g=_=>{e.on_edit_section({id:e.section.id,orientation:_})},k=L(()=>e.section.orientation);return[vi(),(()=>{var _=Gt(),p=_.firstChild,S=p.nextSibling;return S.addEventListener("change",w=>n(w.currentTarget)),S.$$keydown=w=>t(w.key,w.currentTarget),B(()=>S.value=e.section.name),_})(),(()=>{var _=bi(),p=_.firstChild,S=p.nextSibling;return p.$$click=()=>o("empty"),S.$$click=()=>o("lichess"),B(w=>{var R="tab "+(a()==="empty"?"active":""),I="tab "+(a()==="lichess"?"active":"");return R!==w.e&&Z(p,w.e=R),I!==w.t&&Z(S,w.t=I),w},{e:void 0,t:void 0}),_})(),(()=>{var _=$i();return u(_,c(E,{get when(){return a()==="lichess"},get children(){var p=ki(),S=p.firstChild,w=S.nextSibling;return w.addEventListener("change",R=>l(R.target.value)),w.$$keyup=R=>l(R.currentTarget.value),B(()=>Z(w,v()?"error":"success")),p}}),null),u(_,c(E,{get when(){return a()==="empty"},get children(){return[]}}),null),_})(),(()=>{var _=Kt(),p=_.firstChild,S=p.firstChild,w=S.nextSibling,R=p.nextSibling,I=R.firstChild,K=I.nextSibling,z=K.firstChild,D=z.nextSibling;return w.addEventListener("change",N=>i(N.currentTarget.value)),u(w,c($e,{get each(){return tt.slice(0,e.nb_sections)},children:(N,y)=>(()=>{var x=Dt();return x.value=N,u(x,N),B(()=>x.selected=e.i_section===y()),x})()})),K.addEventListener("change",N=>g(N.currentTarget.value)),B(N=>{var y=k()==="white",x=k()==="black";return y!==N.e&&(z.selected=N.e=y),x!==N.t&&(D.selected=N.t=x),N},{e:void 0,t:void 0}),_})(),at(),(()=>{var _=Ut(),p=_.firstChild,S=p.nextSibling;return u(_,c(E,{get when(){return a()==="lichess"},get children(){return c(Et,{get fallback(){return yi()},get children(){var w=wi();return w.$$click=C,B(()=>w.disabled=b()===void 0),w}})}}),S),S.$$click=s,_})()]}Me(["keydown","click","keyup"]);var Wt=h('<main class="openings-show study"><div class=details-wrap></div><div class=board-wrap></div><div class=replay-wrap><div class=header></div></div><div class=sections-wrap></div><div class=tools-wrap>'),Qt=h('<button class="feature practice"><i data-icon=>'),Ei=h("<a class=analyze data-icon=>Analyze on lichess"),Li=h("<a class=copy-line data-icon=>Copy variation PGN"),Oi=h('<a class="annotate has-sub-menu"data-icon=><i class=glyph-icon></i>Annotate Glyph'),qi=h("<a class=delete data-icon=>Delete after this move"),Bi=h("<div class=context-sub-menu>"),Ni=h("<a><i>"),Pi=h("<h4>Take Quiz"),Ti=h("<h4>Play Deathmatch"),Ri=h("<h4>Practice with the Computer"),Ii=h("<div class=practice-feature><div class=tabs><div>Practice</div></div><div>"),Ai=h("<span>Your turn."),zi=h("<div class=info-wrap><div class=status></div><div class=info><p>Computer will follow the lines in the opening.</p><p>Moves will be hidden."),Mi=h('<div class="rematch-buttons buttons"><button class=end>End</button><button class=rematch>Rematch</button><button><i>'),Ui=h("<span>..."),Ft=h("<span>1 of 15"),Ht=h("<button class=retake>Re-take"),Gi=h("<p>You are given 15 random positions from the opening. Play the correct moves."),jt=h("<div class=info-wrap><div class=status></div><div class=info>"),Ki=h("<div class=quiz-history>"),Vt=h("<button class=start>Start"),Yt=h('<div class="quiz-buttons buttons">'),Di=h("<div class=quiz-item>"),Wi=h("<p>You will play the moves from the opening. If you go out of book, game ends."),Qi=h("<i data-icon=>"),Fi=h("<button class=new><i data-icon=></i><span>New Section"),Hi=h("<div class=sections-list><div class=header><span class=title></span><div class=tools></div></div><div class=list><div class=tools>"),ot=h("<i data-icon=>"),ji=h("<button class=new><i data-icon=></i><span>New Chapter"),Vi=h('<div class="section active"><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis></span></div></div><div class=chapters-list><div class=list></div><div class=tools>'),Yi=h("<div><div class=title><span class=nth>."),Zi=h("<div class=section><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis>"),Ji=h("<div class=no-sections>No Sections yet."),Xi=h("<div class=no-chapters>No Chapters yet."),es=h("<div class=loading-chapters>Loading Chapters."),ts=h("<div class=tabs><div><i data-icon=></i></div><div><i data-icon=>"),ns=h("<div class=settings><div class=group><label for=editable>Disable Edits</label><input id=editable type=checkbox>"),is=h("<div class=export><button>Copy PGN</button><button></button><button disabled>Export to Lichess Study"),ss=h("<div class=fen><h4>FEN"),rs=h("<div class=content>"),as=h("<div class=copy-input-text><input type=text readonly>"),os=h("<span class=copied><i data-icon=>"),ls=h("<span><i data-icon=>"),cs=h("<div class=loading>Loading");const Os=()=>{const[e,{load_study:t}]=re();let n=Cn();return Xe(()=>t(n.id)),c(us,pe(()=>ds(e,n.id)))};function ds(e,t){let n=L(()=>e.studies[t]),i=L(()=>{let d=n()?.sections;return n()?.section_ids.map(l=>d.find(r=>r.id===l))}),s=L(()=>{let d=n(),l=d?.selected_section_id;if(l)return d?.sections.find(r=>r.id===l)}),a=L(()=>{let d=s();if(d)return d.chapter_ids.map(l=>e.chapters.list.find(r=>r.id===l)).filter(Boolean)}),o=L(()=>{let l=s()?.selected_chapter_id;if(l)return a()?.find(r=>r.id===l)});return{get study(){return n()},get selected_section(){return s()},get selected_chapter(){return o()},get sections(){return i()},get chapters(){return a()}}}function us(e){const[,{reset_replay_tree:t,load_replay_tree:n,load_chapter:i,load_chapters:s}]=re(),[a,o]=q("show"),[,d]=st();Xe(et(L(()=>e.selected_section?.id),r=>r&&d(()=>s(r)))),Xe(et(L(()=>e.selected_chapter?.id),r=>{d(r?()=>{i(r),n(r)}:()=>{t()})}));const l=r=>({...e,study:r});return c(Et,{get fallback(){return c(Ss,{})},get children(){return c(E,{get when(){return e.study},children:r=>[c(E,{get when(){return a()==="show"},get children(){return c(hs,pe(()=>l(r()),{on_feature_practice:()=>o("practice")}))}}),c(E,{get when(){return a()==="practice"},get children(){return c(_s,pe(()=>l(r()),{on_feature_practice_off:()=>o("show")}))}})]})}})}function hs(e){const[t,{goto_path:n,goto_path_if_can:i,delete_at_and_after_path:s,tree_step_node_set_nags:a,add_child_san_to_current_path:o,chapter_as_export_pgn:d,set_write_enabled_replay_tree:l}]=re();l(!e.study.is_edits_disabled);let r=Lt(t),[m,b]=q(),[C,v]=q(!1),[g,k]=q(!1),[_,p]=q(!1),[S,w]=q(!1);const R=L(()=>{let f=m();if(f)return Sn(t.replay_tree.steps_tree,f)});Ie(()=>{const f=()=>{b(void 0)};document.addEventListener("click",f),Ae(()=>{document.removeEventListener("click",f)})});let I,K;const z=(f,P)=>{n(P),b(P);let U=f.clientX,V=f.clientY,H=K.getBoundingClientRect(),j=I.getBoundingClientRect();U-=j.left,V-=j.top,U=Math.min(U,document.body.clientWidth-H.width-j.left-20);let ee=`${V}px`,se=`${U}px`;K.style.top=ee,K.style.left=se},D=f=>{let P=f.fen;window.open(`https://lichess.org/analysis?fen=${P}`,"_blank"),b(void 0)},[,N]=st(),y=async f=>{N(()=>{s(f)}),b(void 0)};let x;const W=f=>{clearTimeout(x),x=void 0,f===!1?x=setTimeout(()=>{v(!1)},150):x=setTimeout(()=>{v(!0)},100)},ae=async(f,P)=>{await a(f,[qn(P)]),clearTimeout(x),v(!1)};let oe,[me,ie]=q(void 0);const O=L(()=>{let f=me();if(K===void 0||f===void 0)return"";let P=oe.getBoundingClientRect(),U=f.getBoundingClientRect(),V=K.getBoundingClientRect(),H=P.top,j=V.left-U.width,ee=I.getBoundingClientRect();return j-=ee.left,H-=ee.top,`top: ${H}px; left: ${j}px;`}),M=f=>{i(f)};let le=L(()=>{let f=r.step_at_cursor_path;if(!f)return[];let P=f.nags?.[0];return P?Rt(f.step.uci,f.step.san,Tt(P)):[]});const te=L(()=>e.selected_chapter?.name??"[detached]"),de=L(()=>m()!==void 0||g()||_()!==void 0||S()!==void 0);let[,{create_section:ve,create_chapter:ne}]=re();const ue=async(f,P)=>{let U=_()?e.selected_section:void 0;p(!1);let V=e.study.name,H={};A({id:e.study.id,is_edits_disabled:!0});for(let G of f){let T=G.event,[Y,_e,fe]=T.split(":");fe||(fe=_e,_e=P),H[_e]===void 0&&(H[_e]=[]),H[_e].push([fe,G]),V=Y}await ct({id:e.study.id,name:V});let j=Object.keys(H)[0];U&&await lt(e.study.id,{id:U.id,name:j});let ee,se=U;for(j of Object.keys(H)){U||(U=await ve(e.study.id,j));let G=H[j];for(let[T,Y]of G)ee=await ne(e.study.id,U.id,T,Y);se=U,U=void 0}se&&ee&&(A({id:e.study.id,selected_section_id:se.id}),Ee(e.study.id,{id:se.id,selected_chapter_id:ee.id}))},be=()=>{},he=async()=>{let f=await d(e.study.name,e.selected_section.name,e.selected_chapter);navigator.clipboard.writeText(f)},ce=f=>{let P=On(t.replay_tree.steps_tree,f);navigator.clipboard.writeText(P),b(void 0)},xe=f=>{f>0?i(r.get_next_path):i(r.get_prev_path)},we=L(()=>!e.study.is_edits_disabled),Ue=f=>e.sections.indexOf(f),Ge=f=>e.chapters.indexOf(f),[,{update_section:Ee,delete_section:Ke,update_chapter:Be,delete_chapter:De,update_study:A,delete_study:ye,order_sections:Ne,order_chapters:Pe,change_root_fen:en}]=re(),lt=Ee,tn=(f,P)=>{Ke(f,P),p(!1)},nn=(f,P,U)=>{U.orientation&&dt(void 0),Be(f,P,U)},sn=f=>{ke(()=>{De(e.study.id,e.selected_section.id,f),w(!1)})},ct=A,rn=xn(),an=async f=>{await ye(f),rn("/openings")},on=(f,P)=>{Ne(f.study_id,f.id,P)},ln=(f,P)=>{Pe(e.study.id,f.section_id,f.id,P)},cn=async f=>{await en(e.selected_chapter.id,f),w(!1)},dn=async(f,P)=>{let V=Bt(r.fen),H=V.turn,j=V.board.get(it(f)),ee=f+P;j.role==="pawn"&&(P[1]==="8"&&H==="white"||P[1]==="1"&&H==="black")&&(ee+="q");let se=Nt(ee),G=Pt(V,se),T=await o(G);n(T.step.path)},[un,dt]=q(),ut=L(()=>un()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),ht=f=>{f.key==="f"&&dt(F(ut()))};return Ie(()=>{document.addEventListener("keydown",ht),Ae(()=>{document.removeEventListener("keydown",ht)})}),(()=>{var f=Wt(),P=f.firstChild,U=P.nextSibling,V=U.nextSibling,H=V.firstChild,j=V.nextSibling,ee=j.nextSibling,se=I;return typeof se=="function"?Re(se,f):I=f,u(P,c(Jt,pe(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),Ce(U,"wheel",zt(xe)),u(U,c(It,{get orientation(){return ut()},get shapes(){return le()},get movable(){return we()},get color(){return Ot(r.fen)},get fen(){return r.fen},get last_move(){return r.last_move},play_orig_key:dn})),u(H,te),u(V,c(qt,{handle_goto_path:M,get replay_tree(){return t.replay_tree},get lose_focus(){return de()},on_context_menu:z,get features(){return(()=>{var G=Qt();return Ce(G,"click",e.on_feature_practice,!0),G})()}}),null),u(j,c(Zt,pe(e,{get is_edits_disabled(){return e.study.is_edits_disabled},on_edit_study:()=>k(!0),on_edit_section:()=>p(!0),on_edit_chapter:()=>w(!0)}))),u(ee,c(ys,pe(e,{get fen(){return r.fen},on_export_lichess:be,on_copy_pgn:he}))),u(f,c(E,{get when(){return _()},get children(){return c(He,{klass:"edit-section",on_close:()=>p(!1),get children(){return c(xi,{get section(){return e.selected_section},get i_section(){return Ue(e.selected_section)},get nb_sections(){return e.sections.length},on_delete_section:()=>tn(e.study.id,e.selected_section.id),on_edit_section:G=>lt(e.study.id,G),on_order_section:G=>on(e.selected_section,G),on_import_pgns:ue})}})}}),null),u(f,c(E,{get when(){return S()},get children(){return c(He,{klass:"edit-chapter",on_close:()=>w(!1),get children(){return c(Si,{get fen(){return r.initial_fen},get nb_chapters(){return e.chapters.length},get chapter(){return e.selected_chapter},get i_chapter(){return Ge(e.selected_chapter)},on_edit_chapter:G=>nn(e.study.id,e.selected_chapter.section_id,G),on_delete_chapter:()=>sn(e.selected_chapter.id),on_order_chapter:G=>ln(e.selected_chapter,G),on_change_root_fen:cn})}})}}),null),u(f,c(E,{get when(){return g()},get children(){return c(He,{klass:"edit-study",on_close:()=>k(!1),get children(){return c(Ci,{get study(){return e.study},on_delete_study:()=>an(e.study.id),on_update_study:ct})}})}}),null),u(f,c(E,{get when(){return R()},children:G=>[c(En,{get step(){return G().step},ref(T){var Y=K;typeof Y=="function"?Y(T):K=T},get children(){return[(()=>{var T=Ei();return T.$$click=()=>D(G().step),T})(),(()=>{var T=Li();return T.$$click=()=>ce(G().step.path),T})(),c(E,{get when(){return!e.study.is_edits_disabled},get children(){return[(()=>{var T=Oi();T.addEventListener("mouseenter",()=>W(!0)),T.addEventListener("mouseleave",()=>W(!1));var Y=oe;return typeof Y=="function"?Re(Y,T):oe=T,T})(),(()=>{var T=qi();return T.$$click=()=>y(G().step.path),T})()]}})]}}),c(E,{get when(){return C()},get children(){var T=Bi();return Re(Y=>setTimeout(()=>ie(Y)),T),T.addEventListener("mouseenter",()=>W(!0)),T.addEventListener("mouseleave",()=>W(!1)),u(T,c($e,{each:Ln,children:(Y,_e)=>(()=>{var fe=Ni(),hn=fe.firstChild;return fe.$$click=()=>ae(G(),Y),u(fe,()=>We[_e()],null),B(Oe=>{var _t="annotate glyph "+We[_e()],ft=`glyph-icon ${We[_e()]}`;return _t!==Oe.e&&Z(fe,Oe.e=_t),ft!==Oe.t&&Z(hn,Oe.t=ft),Oe},{e:void 0,t:void 0}),fe})()})),B(Y=>xt(T,O(),Y)),T}})]}),null),f})()}function _s(e){const[t,{goto_path:n,goto_path_force:i,goto_path_if_can:s,set_hide_after_path:a,add_child_san_to_success_or_error_path_no_save:o,set_write_enabled_replay_tree:d}]=re();d(!1);let l=Lt(t);const[r,m]=q("practice"),b=O=>{O>0?s(l.get_next_path):s(l.get_prev_path)},[C,v]=q(),g=L(()=>C()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),k=O=>{O.key==="f"&&ke(()=>{v(F(g())),z(void 0),ie()})};Ie(()=>{document.addEventListener("keydown",k),Ae(()=>{document.removeEventListener("keydown",k)})});let _=L(()=>{let O=l.step_at_cursor_path;if(!O)return[];let M=O.nags?.[0];return M?Rt(O.step.uci,O.step.san,Tt(M)):[]});const p=async(O,M)=>{let te=Bt(l.fen),de=te.turn,ve=te.board.get(it(O)),ne=O+M;ve.role==="pawn"&&(M[1]==="8"&&de==="white"||M[1]==="1"&&de==="black")&&(ne+="q");let ue=Nt(ne),be=Pt(te,ue);ae(be)},S=L(()=>e.selected_chapter?.name??"[detached]"),w=O=>{s(O)},[R,I]=q(),[K,z]=q(),[D,N]=q(!1),y=L(()=>R()===void 0&&D()),x=L(()=>K()??g()),W=L(()=>[]),ae=async O=>{r()==="practice"&&oe(O)},oe=async O=>{let M=await o(O);M&&(M[0]==="error"?(i(M[1].step.path),I(setTimeout(()=>{ke(()=>{n(Tn(M[1].step.path)),I(void 0)})},600))):(ke(()=>{i(M[1].step.path),a(M[1].step.path)}),ie()))},me=O=>{O!==void 0&&(z(O),a(void 0),i(""),ie())},ie=()=>{if(x()!==l.turn){let O=Pn(t.replay_tree.steps_tree,t.replay_tree.cursor_path);if(O=O.filter(le=>!t.replay_tree.error_paths.includes(le.step.path)),!O||O.length===0)return;let M=At(O);I(setTimeout(()=>{ke(()=>{i(M.step.path),a(M.step.path),I(void 0)})},500))}};return(()=>{var O=Wt(),M=O.firstChild,le=M.nextSibling,te=le.nextSibling,de=te.firstChild,ve=te.nextSibling;return u(M,c(Jt,pe(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),Ce(le,"wheel",zt(b)),u(le,c(It,{get orientation(){return x()},get shapes(){return _()},get movable(){return y()},get color(){return Ot(l.fen)},get fen(){return l.fen},get last_move(){return l.last_move},play_orig_key:p})),u(de,S),u(te,c(qt,{handle_goto_path:w,get replay_tree(){return t.replay_tree},lose_focus:!1,on_context_menu:()=>{},get features(){return(()=>{var ne=Qt();return Ce(ne,"click",e.on_feature_practice_off,!0),ne})()},get feature_content(){return(()=>{var ne=Ii(),ue=ne.firstChild,be=ue.firstChild,he=ue.nextSibling;return be.$$click=()=>m("practice"),u(he,c(E,{get when(){return r()==="quiz"},get children(){return[Pi(),c(ps,{get nodes(){return W()}})]}}),null),u(he,c(E,{get when(){return r()==="deathmatch"},get children(){return[Ti(),c(ms,{})]}}),null),u(he,c(E,{get when(){return r()==="practice"},get children(){return[Ri(),c(fs,{get movable(){return y()},on_rematch:me,get color(){return x()},set_movable:N})]}}),null),B(ce=>{var xe="feature tab"+(r()==="practice"?" active":""),we="content "+r();return xe!==ce.e&&Z(be,ce.e=xe),we!==ce.t&&Z(he,ce.t=we),ce},{e:void 0,t:void 0}),ne})()}}),null),u(ve,c(Zt,pe(e,{is_edits_disabled:!0}))),O})()}function fs(e){const[t,{goto_path:n,reload_replay_tree_with_cursor_path:i}]=re(),[,s]=st(),a=l=>{if(l===void 0){s(()=>{i(t.replay_tree.cursor_path)});return}ke(()=>{s(()=>{i(""),e.on_rematch(l)})})},o=L(()=>e.color),d=L(()=>F(o()));return e.set_movable(!0),n(""),[(()=>{var l=zi(),r=l.firstChild;return u(r,c(E,{get when(){return e.movable},get fallback(){return Ui()},get children(){return Ai()}})),l})(),(()=>{var l=Mi(),r=l.firstChild,m=r.nextSibling,b=m.nextSibling;return r.$$click=()=>a(),m.$$click=()=>a(o()),b.$$click=()=>a(d()),B(()=>Z(b,`color ${d()}`)),l})()]}function gs(e){let[t,n]=q(void 0);return{step:e,get is_solved(){return t()},set is_solved(i){n(i)}}}function ps(e){let[t,n]=q([...Array(15).keys()]);const[i,s]=q("info");let o=L(Bn(t,()=>gs(At(e.nodes))));return[(()=>{var d=jt(),l=d.firstChild,r=l.nextSibling;return u(l,c(E,{get when(){return i()==="info"},children:"Press start"}),null),u(l,c(E,{get when(){return i()==="in-progress"},get children(){return Ft()}}),null),u(l,c(E,{get when(){return i()==="end"},get children(){return Ht()}}),null),u(r,c(E,{get when(){return i()==="info"},get children(){return Gi()}})),d})(),(()=>{var d=Ki();return u(d,c($e,{get each(){return o()},children:(l,r)=>(()=>{var m=Di();return u(m,()=>r()+1),m})()})),d})(),(()=>{var d=Yt();return u(d,c(E,{get when(){return i()==="info"},get children(){return Vt()}})),d})()]}function ms(){const[e,t]=q("info");return[(()=>{var n=jt(),i=n.firstChild,s=i.nextSibling;return u(i,c(E,{get when(){return e()==="info"},children:"Press start"}),null),u(i,c(E,{get when(){return e()==="in-progress"},get children(){return Ft()}}),null),u(i,c(E,{get when(){return e()==="end"},get children(){return Ht()}}),null),u(s,c(E,{get when(){return e()==="info"},get children(){return Wi()}})),n})(),(()=>{var n=Yt();return u(n,c(E,{get when(){return e()==="info"},get children(){return Vt()}})),n})()]}function Zt(e){let[,{create_section:t,update_study:n}]=re();const i=async()=>{let a=await t(e.study.id);await s(a.id),e.on_edit_section?.()},s=a=>n({id:e.study.id,selected_section_id:a});return(()=>{var a=Hi(),o=a.firstChild,d=o.firstChild,l=d.nextSibling,r=o.nextSibling,m=r.firstChild;return u(d,()=>e.study.name),u(l,c(E,{get when(){return!e.is_edits_disabled},get children(){var b=Qi();return b.$$click=()=>e.on_edit_study?.(),b}})),u(r,c($e,{get each(){return e.sections},get fallback(){return c($s,{})},children:(b,C)=>c(E,{get when(){return b===e.selected_section},get fallback(){return c(ks,{get is_edits_disabled(){return e.is_edits_disabled},section:b,get nth(){return $t(C())},on_selected:()=>s(b.id),on_edit:()=>e.on_edit_section?.()})},get children(){return c(vs,pe(e,{section:b,get is_edits_disabled(){return e.is_edits_disabled},get nth(){return $t(C())},get on_edit(){return e.on_edit_section},get on_edit_chapter(){return e.on_edit_chapter}}))}})}),m),u(m,c(E,{get when(){return!e.is_edits_disabled},get children(){var b=Fi();return b.$$click=i,b}})),a})()}function vs(e){let[,{create_chapter:t,update_section:n}]=re();const i=async()=>{let a=await t(e.study.id,e.section.id);await s(a.id),e.on_edit_chapter?.()},s=async a=>n(e.study.id,{id:e.section.id,selected_chapter_id:a});return(()=>{var a=Vi(),o=a.firstChild,d=o.firstChild,l=d.firstChild,r=l.nextSibling,m=o.nextSibling,b=m.firstChild,C=b.nextSibling;return u(l,()=>e.nth),u(r,()=>e.section?.name),u(o,c(E,{get when(){return!e.is_edits_disabled},get children(){var v=ot();return v.$$click=()=>e.on_edit?.(),v}}),null),u(b,c($e,{get each(){return e.chapters},get fallback(){return c(ws,{})},children:(v,g)=>c(bs,{get is_edits_disabled(){return e.is_edits_disabled},chapter:v,get nth(){return`${e.nth}${g()+1}`},get selected(){return e.selected_chapter===v},on_selected:()=>s(v.id),on_edit:()=>e.on_edit_chapter?.()})})),u(C,c(E,{get when(){return!e.is_edits_disabled},get children(){var v=ji();return v.$$click=()=>i(),v}})),B(()=>Nn(r,"title",e.section?.name)),a})()}function bs(e){const t=L(()=>e.selected?" active":"");return(()=>{var n=Yi(),i=n.firstChild,s=i.firstChild,a=s.firstChild;return n.$$click=()=>e.on_selected(),u(s,()=>e.nth,a),u(i,()=>e.chapter.name,null),u(n,c(E,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),B(()=>Z(n,"chapter"+t())),n})()}function ks(e){return(()=>{var t=Zi(),n=t.firstChild,i=n.firstChild,s=i.firstChild,a=s.nextSibling;return n.$$click=()=>e.on_selected(),u(s,()=>e.nth),u(a,()=>e.section.name),u(n,c(E,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),t})()}function $s(){return Ji()}function ws(){return Xi()}function qs(){return es()}function Jt(e){return[]}function ys(e){const[,{update_study:t}]=re(),[n,i]=q("share"),[s,a]=q(!0,{equals:!1}),o=()=>{a(!0),e.on_copy_pgn()},d=e.study.is_edits_disabled,l=v=>t({id:e.study.id,is_edits_disabled:v}),[r,m]=q(!1),[,{study_as_export_pgn:b}]=re(),C=async()=>{m(!0);let v=await b(e.study.id);m(!1),xs(v,`${e.study.name}.pgn`)};return[(()=>{var v=ts(),g=v.firstChild,k=g.nextSibling;return g.$$click=()=>i("settings"),k.$$click=()=>i("share"),B(_=>{var p="tab"+(n()==="settings"?" active":""),S="tab"+(n()==="share"?" active":"");return p!==_.e&&Z(g,_.e=p),S!==_.t&&Z(k,_.t=S),_},{e:void 0,t:void 0}),v})(),(()=>{var v=rs();return u(v,c(E,{get when(){return n()==="settings"},get children(){var g=ns(),k=g.firstChild,_=k.firstChild,p=_.nextSibling;return p.addEventListener("change",S=>l(S.currentTarget.checked)),p.checked=d,g}}),null),u(v,c(E,{get when(){return n()==="share"},get children(){return[(()=>{var g=is(),k=g.firstChild,_=k.firstChild,p=k.nextSibling,S=p.nextSibling;return k.$$click=o,u(k,c(Xt,{get on_copy(){return s()}}),_),p.$$click=C,u(p,c(E,{get when(){return r()},get fallback(){return"Export as PGN"},children:"Loading..."})),Ce(S,"click",e.on_export_lichess,!0),B(()=>p.disabled=r()),g})(),(()=>{var g=ss();return g.firstChild,u(g,c(Cs,{get value(){return e.fen}}),null),g})()]}}),null),v})()]}function Cs(e){const[t,n]=q(!0,{equals:!1}),i=()=>{navigator.clipboard.writeText(e.value),n(!0)};return(()=>{var s=as(),a=s.firstChild;return s.$$click=i,u(s,c(Xt,{get on_copy(){return t()}}),null),B(()=>a.value=e.value),s})()}function Xt(e){qe(et(()=>e.on_copy,()=>{n(!0),setTimeout(()=>n(!1),1e3)},{defer:!0}));const[t,n]=q(!1);return c(E,{get when(){return t()},get fallback(){return ls()},get children(){return os()}})}function Ss(){return cs()}function xs(e,t){const n=new Blob([e],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(n),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}Me(["click"]);export{bs as ChapterComponent,qs as LoadingChapters,ws as NoChapters,$s as NoSections,Os as default};
