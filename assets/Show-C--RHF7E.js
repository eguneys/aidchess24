import{m as gn,C as Ct,P as Se,n as gt,o as Q,p as J,I as X,q as k,r as ge,v as pn,R as pt,w as ze,x as Le,y as Ve,z as j,B as mt,D as Ye,E as mn,G as nt,t as f,i as h,e as T,f as Z,d as Me,H as Ze,J as Te,K as vn,L as bn,N as Je,O as P,Q as kn,b as E,T as $n,U as it,j as Ne,V as St,c,W as $e,F as we,X as xt,Y as ke,Z as wn,_ as Ie,$ as Ae,a0 as Re,a1 as yn,a2 as Cn,a3 as Sn,k as x,l as Et,g as ce,a4 as xn,a5 as Xe,a6 as pe,a7 as et,a8 as Lt,a9 as En,u as Ln,aa as Ot,ab as qt,ac as On,ad as qn,ae as We,af as Bt,ag as Nt,ah as Pt,ai as Tt,aj as Bn,ak as st,al as Nn,am as Pn,s as Tn,an as Rn,ao as In}from"./index-Kg10kyHr.js";import{o as vt,C as An,e as bt,d as zn,a as Rt,P as It,b as At,n as zt}from"./random-CAuo1AIA.js";const Mn=e=>gn(e);class Un extends Se{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=gt.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():gt.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?Q.err(new J(X.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?Q.err(new J(X.Variant)):Q.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,i;const r=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?k.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?k.backranks().complement():k.empty());if(t=t||this.ctx(),ge(t.king)&&t.checkers.nonEmpty()){const a=t.checkers.singleSquare();return ge(a)?r.intersect(pn(a,t.king)):k.empty()}else return r}}class Gn extends Se{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()>2)return Q.err(new J(X.Kings));const t=this.board.kingOf(j(this.turn));return ge(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Q.err(new J(X.OppositeCheck)):k.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0):Q.err(new J(X.Kings))}kingAttackers(t,n,i){const r=this.board.pieces(n,"king");return r.isEmpty()||Ve(t).intersects(r)?k.empty():super.kingAttackers(t,n,i)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(const i of Ve(t).intersect(this.board.occupied).diff(this.board.pawn)){const r=this.board.take(i);r?.role==="rook"&&this.castles.discardRook(i),r?.role==="king"&&this.castles.discardColor(r.color)}}hasInsufficientMaterial(t){if(this.board.pieces(j(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[j(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(k.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(k.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let i=k.empty();for(const r of Ye(this,t,n)){const a=this.clone();a.play({from:t,to:r});const o=a.board.kingOf(this.turn);ge(o)&&(!ge(a.board.kingOf(a.turn))||a.kingAttackers(o,a.turn,a.board.occupied).isEmpty())&&(i=i.with(r))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").isEmpty())return{winner:j(n)}}}class Kn extends Se{constructor(){super("antichess")}reset(){super.reset(),this.castles=Le.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Q.err(new J(X.Empty)):k.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0)}kingAttackers(t,n,i){return k.empty()}ctx(){const t=super.ctx();if(ge(this.epSquare)&&mn(j(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const n=this.board[j(this.turn)];for(const i of this.board[this.turn])if(Ye(this,i,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();const i=Ye(this,t,n),r=this.board[j(this.turn)];return i.intersect(n.mustCapture?ge(this.epSquare)&&this.board.getRole(t)==="pawn"?r.with(this.epSquare):r:k.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[j(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[t].intersects(k.lightSquares()),i=this.board[t].intersects(k.darkSquares()),r=this.board[j(t)].isDisjoint(k.lightSquares()),a=this.board[j(t)].isDisjoint(k.darkSquares());return n&&r||i&&a}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(k.lightSquares())!==this.board.black.intersects(k.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Dn extends Se{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(k.center())}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").intersects(k.center()))return{winner:n}}}class Wn extends Se{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=pt.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||pt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const n of ze)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Qn=()=>{const e=nt.empty();return e.occupied=new k(65535,0),e.promoted=k.empty(),e.white=new k(61680,0),e.black=new k(3855,0),e.pawn=k.empty(),e.knight=new k(6168,0),e.bishop=new k(9252,0),e.rook=new k(16962,0),e.queen=new k(129,0),e.king=new k(33024,0),e};class jn extends Se{constructor(){super("racingkings")}reset(){this.board=Qn(),this.pockets=void 0,this.turn="white",this.castles=Le.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?Q.err(new J(X.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let i=k.empty();for(const r of super.dests(t,n)){const a={from:t,to:r},o=this.clone();o.play(a),o.isCheck()||(i=i.with(r))}return i}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=k.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(ge(i)){const r=this.board.occupied.without(i);for(const a of Ve(i).intersect(t).diff(this.board.black))if(this.kingAttackers(a,"white",r).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const n=k.fromRank(7),i=this.board.pieces("black","king").intersects(n),r=this.board.pieces("white","king").intersects(n);return i&&!r?{winner:"black"}:r&&!i?{winner:"white"}:{winner:void 0}}}const Fn=()=>{const e=nt.empty();return e.occupied=new k(4294967295,4294901862),e.promoted=k.empty(),e.white=new k(4294967295,102),e.black=new k(0,4294901760),e.pawn=new k(4294967295,16711782),e.knight=new k(0,1107296256),e.bishop=new k(0,603979776),e.rook=new k(0,2164260864),e.queen=new k(0,134217728),e.king=new k(0,268435456),e};class Hn extends Se{constructor(){super("horde")}reset(){this.board=Fn(),this.pockets=void 0,this.turn="white",this.castles=Le.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()!==1)return Q.err(new J(X.Kings));const t=this.board.kingOf(j(this.turn));if(ge(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return Q.err(new J(X.OppositeCheck));for(const n of ze){const i=this.board.pieces(n,"king").isEmpty()?k.backrank(j(n)):k.backranks();if(this.board.pieces(n,"pawn").intersects(i))return Q.err(new J(X.PawnsOnBackrank))}return Q.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const n=m=>m==="light"?"dark":"light",i=m=>m==="light"?k.lightSquares():k.darkSquares(),r=m=>{const p=this.board.pieces(m,"bishop");return p.intersects(k.darkSquares())&&p.intersects(k.lightSquares())},a=mt.fromBoard(this.board,t),o=m=>i(m).intersect(this.board.pieces(t,"bishop")).size(),d=o("light")>=1?"light":"dark",l=a.pawn+a.knight+a.rook+a.queen+Math.min(o("dark"),2)+Math.min(o("light"),2),s=mt.fromBoard(this.board,j(t)),u=m=>i(m).intersect(this.board.pieces(j(t),"bishop")).size(),g=s.size(),$=m=>g-m;if(l===0)return!0;if(l>=4||(a.pawn>=1||a.queen>=1)&&l>=2||a.rook>=1&&l>=2&&!(l===2&&a.rook===1&&a.bishop===1&&$(u(d))===1))return!1;if(l===1){if(g===1)return!0;if(a.queen===1)return!(s.pawn>=1||s.rook>=1||u("light")>=2||u("dark")>=2);if(a.pawn===1){const m=this.board.pieces(t,"pawn").last(),p=this.clone();p.board.set(m,{color:t,role:"queen"});const C=this.clone();return C.board.set(m,{color:t,role:"knight"}),p.hasInsufficientMaterial(t)&&C.hasInsufficientMaterial(t)}else{if(a.rook===1)return!(s.pawn>=2||s.rook>=1&&s.pawn>=1||s.rook>=1&&s.knight>=1||s.pawn>=1&&s.knight>=1);if(a.bishop===1)return!(u(n(d))>=2||u(n(d))>=1&&s.pawn>=1||s.pawn>=2);if(a.knight===1)return!(g>=4&&(s.knight>=2||s.pawn>=2||s.rook>=1&&s.knight>=1||s.rook>=1&&s.bishop>=1||s.knight>=1&&s.bishop>=1||s.rook>=1&&s.pawn>=1||s.knight>=1&&s.pawn>=1||s.bishop>=1&&s.pawn>=1||r(j(t))&&s.pawn>=1)&&(u("dark")<2||$(u("dark"))>=3)&&(u("light")<2||$(u("light"))>=3))}}else{if(l===2)return g===1?!0:a.knight===2?s.pawn+s.bishop+s.knight<1:r(t)?!(s.pawn>=1||s.bishop>=1||s.knight>=1&&s.rook+s.queen>=1):a.bishop>=1&&a.knight>=1?!(s.pawn>=1||u(n(d))>=1||$(u(d))>=3):!(s.pawn>=1&&u(n(d))>=1||s.pawn>=1&&s.knight>=1||u(n(d))>=1&&s.knight>=1||u(n(d))>=2||s.knight>=2||s.pawn>=2);if(l===3)return a.knight===2&&a.bishop===1||a.knight===3||r(t)?!1:g===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const Vn=(e,t)=>{switch(e){case"chess":return Ct.fromSetup(t);case"antichess":return Kn.fromSetup(t);case"atomic":return Gn.fromSetup(t);case"horde":return Hn.fromSetup(t);case"racingkings":return jn.fromSetup(t);case"kingofthehill":return Dn.fromSetup(t);case"3check":return Wn.fromSetup(t);case"crazyhouse":return Un.fromSetup(t)}},Yn=(e=rt)=>({headers:e(),moves:new Mt});class Mt{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const n=t.children[0];yield n,t=n}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class Zn extends Mt{constructor(t){super(),this.data=t}}const Jn=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Xn=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,rt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),kt="\uFEFF",Qe=e=>/^\s*$/.test(e),je=e=>e.startsWith("%");class ei extends Error{}class ti{constructor(t,n=rt,i=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Yn(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new ei("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let i=0;for(;;){const r=t.indexOf(`
`,i);if(r===-1)break;const a=r>i&&t[r-1]==="\r"?r-1:r;this.consumeBudget(r-i),this.lineBuf.push(t.slice(i,a)),i=r+1,this.handleLine()}this.consumeBudget(t.length-i),this.lineBuf.push(t.slice(i)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(kt)&&(n=n.slice(kt.length)),this.state=1;case 1:if(Qe(n)||je(n))return;this.found=!0,this.state=2;case 2:{if(je(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(r,a,o)=>(this.consumeBudget(200),this.handleHeader(a,o.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,t=!1,""));if(Qe(n))return;this.state=3}case 3:{if(t){if(je(n))return;if(Qe(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let r;for(;r=i.exec(n);){const a=this.stack[this.stack.length-1];let o=r[0];if(o===";")return;if(o.startsWith("$"))this.handleNag(parseInt(o.slice(1),10));else if(o==="!")this.handleNag(1);else if(o==="?")this.handleNag(2);else if(o==="!!")this.handleNag(3);else if(o==="??")this.handleNag(4);else if(o==="!?")this.handleNag(5);else if(o==="?!")this.handleNag(6);else if(o==="1-0"||o==="1–0"||o==="1—0"||o==="0-1"||o==="0–1"||o==="0—1"||o==="1/2-1/2"||o==="1/2–1/2"||o==="1/2—1/2"||o==="*")this.stack.length===1&&o!=="*"&&this.handleHeader("Result",o);else if(o==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(o===")")this.stack.length>1&&this.stack.pop();else if(o==="{"){const d=i.lastIndex,l=n[d]===" "?d+1:d;n=n.slice(l),this.state=4;continue e}else this.consumeBudget(100),o.startsWith("O")||o.startsWith("0")||o.startsWith("o")?o=o.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(o==="Z0"||o==="0000"||o==="@@@@")&&(o="--"),a.node&&(a.parent=a.node),a.node=new Zn({san:o,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const r=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,r)),this.handleComment(),n=n.slice(i),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?Jn(Xn(n)):n)}handleNag(t){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],r=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((t=i.node.data).comments||(t.comments=[]),i.node.data.comments.push(r)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(r)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(r))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const ni=(e,t=rt)=>{const n=[];return new ti(i=>n.push(i),t,NaN).parse(e),n};var ii=f("<div class=modal-mask><dialog open><div class=close-button-anchor><button class=close-button data-icon=></button></div><div class=scrollable><div>");function Fe(e){return(()=>{var t=ii(),n=t.firstChild,i=n.firstChild,r=i.firstChild,a=i.nextSibling,o=a.firstChild;return t.$$click=()=>e.on_close(),n.$$click=d=>{d.stopPropagation()},r.$$click=()=>e.on_close(),h(o,()=>e.children),T(()=>Z(o,"dialog-content "+e.klass)),t})()}Me(["click"]);const tt="ABCDEFGHIJKLMNOP".split(""),$t=e=>tt[e];function wt(e){return Je(e.toSetup())}function si(e){return ni(e).map(t=>{let n=t.headers.get("Event"),i=t.headers.get("Site"),r=t.headers.get("White"),a=t.headers.get("Black"),o=t.headers.get("Chapter"),d=t.headers.get("Orientation"),l=t.headers.get("FEN"),s=l??Te,u=Ct.fromSetup(Ze(s).unwrap()).unwrap(),g={},$={},m={};t.moves.children.forEach(C=>{p(C,u,0,"")});function p(C,v,b,O){let w=C.data.san,I=vn(v,w),A=v.clone();A.play(I);let K=bn(I),z=C.data.nags,D=g[O];D||(D=[],g[O]=D);let B=O.length===0?K:`${O} ${K}`;D.push({path:B,ply:b+1,before_fen:wt(v),fen:wt(A),uci:K,san:w}),z&&(m[B]=z),C.children.forEach(y=>{p(y,A,b+1,B)})}return{event:n,site:i,white:r,black:a,chapter:o,fen:l,orientation:d,flat_steps:g,flat_nags:m,flat_comments:$}})}var ri=f(`<div class="editor is2d"><div class=board-wrap></div><div class=tools-wrap><div class=metadata><div class=color><select><option value=white>White's Turn</option><option value=black>Black's Turn</option></select></div><div class=castling><strong>Castling</strong><div><label><input type=checkbox>White O-O</label><label><input type=checkbox>O-O-O</label></div><div><label><input type=checkbox>Black O-O</label><label><input type=checkbox>O-O-O</label></div></div><div class=enpassant><label for=enpassant-select>En passant</label><select id=enpassant-select><option value selected></option></select></div></div><div class=actions><button>Starting Position</button><button>Clear Board`),ai=f("<option>"),oi=f('<div class="is2d chessboard"> '),li=f("<div>"),ci=f("<div><div><div>");function di(e){const t=u=>[...u].reduce((g,$)=>{const m=parseInt($);return g+(m>=1?"x".repeat(m):$)},""),n=(u,g,$,m)=>{let p;for(;(p=g.exec(u))!=null;)m.add(p.index+$)},i=new Set,[r,a]=e.split(" "),o=r.split("/"),d=t(o[a==="w"?3:4]);n(d,/pP/g,a==="w"?0:1,i),n(d,/Pp/g,a==="w"?1:0,i);const[l,s]=i.size>=1?[t(o[a==="w"?1:6]),t(o[a==="w"?2:5])]:[null,null];return Array.from(i).filter(u=>l[u]==="x"&&s[u]==="x").map(u=>String.fromCharCode(97+u)+(a==="w"?"6":"3"))}const ui=e=>{const t=()=>Te,[n,i]=P(Te),[r,a]=P("white"),[o,d]=P(),l=["K","Q","k","q"],[s,u]=kn({Q:!1,K:!1,k:!1,q:!1}),g=E(()=>{let y="",S=s;return l.forEach(W=>{S[W]&&(y+=W)}),y}),$=E(()=>{let y=t(),S=n()??y;const W=Ze(S).unwrap(ie=>ie.board,ie=>nt.empty()),re=r(),ae=$n(W,g()).unwrap();let me=o()?it(o()):void 0;return{board:W,turn:re,castlingRights:ae,epSquare:me,pockets:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:0}}),m=E(()=>Je($())),p=E(()=>Vn("chess",$()).unwrap(y=>Je(y.toSetup()),y=>{})),C=E(()=>di(m()));Ne(()=>{e.on_change_fen(p())});const v=y=>{ke(()=>{a(y.turn),d(y.epSquare?Mn(y.epSquare):void 0);let S=Le.fromSetup(y);u("Q",S.rook.white.a!==void 0),u("K",S.rook.white.h!==void 0),u("q",S.rook.black.a!==void 0),u("k",S.rook.black.h!==void 0)})},b=y=>{Ze(y).unwrap(S=>(ke(()=>{i(y),v(S)}),!0),S=>!1)};b(e.initial_fen);const[O,w]=P("pointer"),I=St(O),[A,K]=P(),z=(y,S)=>{if(w(y),y!=="pointer"){if(y!=="trash"){let[W,re]=y.split(" ");K([W,re,S])}}},D=E(()=>{let y,S;switch(O()){case"pointer":S="pointer";break;case"trash":y="/cursors/trash.cur";break;default:y=`/cursors/${O().split(" ").join("-")}.cur`}if(S)return{cursor:S};if(y)return{cursor:`url('${y}'), default`}}),B=()=>{let[y,S]=O().split(" ");w(`${vt(y)} ${S}`)};return(()=>{var y=ri(),S=y.firstChild,W=S.nextSibling,re=W.firstChild,ae=re.firstChild,me=ae.firstChild,ie=me.firstChild,q=ie.nextSibling,M=ae.nextSibling,oe=M.firstChild,te=oe.nextSibling,de=te.firstChild,ve=de.firstChild,ne=de.nextSibling,ue=ne.firstChild,be=te.nextSibling,he=be.firstChild,le=he.firstChild,xe=he.nextSibling,ye=xe.firstChild,Ue=M.nextSibling,Ge=Ue.firstChild,Oe=Ge.nextSibling;Oe.firstChild;var Ke=re.nextSibling,qe=Ke.firstChild,De=qe.nextSibling;return h(y,c(yt,{klass:"spare-top",get color(){return vt(e.orientation)},on_spare:z,is_selected:I}),S),h(S,c(hi,{on_set_spare:w,on_toggle_spare:B,get spare(){return O()},get orientation(){return e.orientation},on_change_fen:i,get drag_new_piece(){return A()},get fen(){return n()}})),h(y,c(yt,{klass:"spare-bottom",get color(){return e.orientation},on_spare:z,is_selected:I}),W),$e(me,"change",U=>a(U.target.value)),ve.addEventListener("change",U=>u("K",U.target.checked)),ue.addEventListener("change",U=>u("Q",U.target.checked)),le.addEventListener("change",U=>u("k",U.target.checked)),ye.addEventListener("change",U=>u("q",U.target.checked)),Oe.addEventListener("change",U=>d(U.target.value)),h(Oe,c(we,{get each(){return C()},children:U=>(()=>{var Ce=ai();return Ce.value=U,h(Ce,U),Ce})()}),null),qe.$$click=()=>b(Te),De.$$click=()=>b(Cn),T(U=>{var Ce=D(),Ee=r()==="white",Pe=r()==="black";return U.e=xt(y,Ce,U.e),Ee!==U.t&&(ie.selected=U.t=Ee),Pe!==U.a&&(q.selected=U.a=Pe),U},{e:void 0,t:void 0,a:void 0}),T(()=>ve.checked=s.K),T(()=>ue.checked=s.Q),T(()=>le.checked=s.k),T(()=>ye.checked=s.q),y})()};function hi(e){const t=()=>{e.on_change_fen(i.getFen())};let n,i;return Ie(()=>{let r={fen:e.fen,orientation:e.orientation,autoCastle:!1,movable:{free:!0,color:"both"},draggable:{showGhost:!0,deleteOnDropOff:!0},premovable:{enabled:!1},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:t}};i=An(n,r);const a=l=>{let s=e.spare;s!=="pointer"&&l.preventDefault();const u=bt(l);if(!u)return;let g=i.getKeyAtDomPos(u);if(g){if(s==="trash")o(g);else if(s!=="pointer"){const $=i.state.pieces.get(g);let[m,p]=s.split(" "),C={color:m,role:p};$&&$.color===C.color&&$.role===C.role?o(g):(i.setPieces(new Map([[g,C]])),t())}}},o=l=>{i.setPieces(new Map([[l,void 0]])),t()},d=l=>{let s=e.spare;s!=="pointer"&&l.preventDefault(),s!=="pointer"&&(i.state.drawable.current=void 0,i.state.drawable.shapes=[],l.type==="contextmenu"&&s!=="trash"&&(i.cancelMove(),e.on_toggle_spare()))};n.addEventListener("mousedown",a),n.addEventListener("contextmenu",d),Ae(()=>{n.removeEventListener("mousedown",a),n.removeEventListener("contextmenu",d)})}),Ne(()=>{i.set({fen:e.fen})}),Ne(()=>{i.set({orientation:e.orientation})}),Ne(()=>{let r=e.drag_new_piece;r&&(zn(i.state,{color:r[0],role:r[1]},r[2],!0),document.addEventListener("mouseup",a=>{const o=bt(a);o&&i.getKeyAtDomPos(o)&&e.on_set_spare("pointer")},{once:!0}))}),(()=>{var r=oi();return Re(a=>n=a,r),r})()}const yt=e=>{const t=e.is_selected;return(()=>{var n=li();return h(n,c(He,{onClick:i=>e.on_spare("pointer",i),klass:"pointer",spare:"pointer",get selected(){return t("pointer")},get color(){return e.color}}),null),h(n,c(we,{each:wn,children:i=>c(He,{onClick:r=>e.on_spare(`${e.color} ${i}`,r),klass:"",get spare(){return`${e.color} ${i}`},get selected(){return t(`${e.color} ${i}`)},get color(){return e.color}})}),null),h(n,c(He,{onClick:i=>e.on_spare("trash",i),klass:"trash",spare:"trash",get selected(){return t("trash")},get color(){return e.color}}),null),T(()=>Z(n,"spare "+e.klass+" "+e.color)),n})()},He=e=>(()=>{var t=ci(),n=t.firstChild,i=n.firstChild;return $e(t,"mousedown",e.onClick,!0),T(r=>{var a="no-square "+e.klass,o=!!e.selected,d="piece "+e.spare,l={[e.color]:!0};return a!==r.e&&Z(t,r.e=a),o!==r.t&&t.classList.toggle("selected",r.t=o),d!==r.a&&Z(i,r.a=d),r.o=yn(i,l,r.o),r},{e:void 0,t:void 0,a:void 0,o:void 0}),t})();Me(["click","mousedown"]);var _i=f("<h2>Edit Opening"),fi=f('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Opening Name"minlength=3>'),gi=f("<div class=section><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),at=f("<div class=filler>"),Ut=f('<div class="group buttons"><span class=split></span><button class=delete>Delete <i data-icon=>'),pi=f("<h2>Edit Chapter"),Gt=f('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Section Name"minlength=3>'),mi=f("<div class=group><div class=editor-wrap>"),vi=f("<div class=tabs-wrap><div class=tabs><div class=tab>Empty</div><div class=tab>Editor</div></div><div class=content>"),Kt=f("<div class=section><div class=group><label for=order>Set Order</label><select name=order id=order></select></div><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),bi=f('<div class="group buttons"><button class=delete>Delete <i data-icon=></i></button><span class=split></span><button class=create>Save Changes'),Dt=f("<option>"),ki=f("<h2>Edit Section"),$i=f("<div class=tabs><div>Empty</div><div>Import Lichess Study"),wi=f('<div class=group><label for=name>Import a Study from Lichess</label><input name=name id=name type=text placeholder="Lichess Study URL">'),yi=f("<div class=content>"),Ci=f("<button class=import>Import<i data-icon=>"),Si=f("<button class=loading disabled>Loading ...");function xi(e){const t=(o,d)=>{o==="Escape"&&(d.value=e.study.name)},n=o=>{let d=o.value;d.length<3&&(d="New Chapter",o.value=d),e.on_update_study({id:e.study.id,name:d})},i=()=>{e.on_delete_study()},r=o=>{e.on_update_study({id:e.study.id,orientation:o})},a=E(()=>e.study.orientation);return[_i(),(()=>{var o=fi(),d=o.firstChild,l=d.nextSibling;return l.addEventListener("change",s=>n(s.currentTarget)),l.$$keydown=s=>t(s.key,s.currentTarget),T(()=>l.value=e.study.name),o})(),(()=>{var o=gi(),d=o.firstChild,l=d.firstChild,s=l.nextSibling,u=s.firstChild,g=u.nextSibling;return s.addEventListener("change",$=>r($.currentTarget.value)),T($=>{var m=a()==="white",p=a()==="black";return m!==$.e&&(u.selected=$.e=m),p!==$.t&&(g.selected=$.t=p),$},{e:void 0,t:void 0}),o})(),at(),(()=>{var o=Ut(),d=o.firstChild,l=d.nextSibling;return l.$$click=i,o})()]}function Ei(e){const t=(p,C)=>{p==="Escape"&&(C.value=e.chapter.name)},n=p=>{let C=p.value;C.length<3&&(C="New Chapter",p.value=C),e.on_edit_chapter({id:e.chapter.id,name:C})},i=p=>{let C=parseInt(p);e.on_order_chapter(C)},r=()=>{e.on_delete_chapter()},a=()=>{let p=l();p&&e.fen!==p&&e.on_change_root_fen(p)},o=p=>{e.on_edit_chapter({id:e.chapter.id,orientation:p})},d=E(()=>e.chapter.orientation),[l,s]=P(),[u,g]=P("editor"),$=St(u),m=E(()=>l()??e.fen);return[pi(),(()=>{var p=Gt(),C=p.firstChild,v=C.nextSibling;return v.addEventListener("change",b=>n(b.currentTarget)),v.$$keydown=b=>t(b.key,b.currentTarget),T(()=>v.value=e.chapter.name),p})(),(()=>{var p=vi(),C=p.firstChild,v=C.firstChild,b=v.nextSibling,O=C.nextSibling;return v.$$click=()=>g("empty"),b.$$click=()=>g("editor"),h(O,c(x,{get when(){return u()==="editor"},get children(){var w=mi(),I=w.firstChild;return h(I,c(ui,{get initial_fen(){return m()},on_change_fen:s,get orientation(){return e.chapter.orientation??"white"}})),w}}),null),h(O,c(x,{get when(){return u()==="empty"},get children(){return[]}}),null),T(w=>{var I=!!$("empty"),A=!!$("editor");return I!==w.e&&v.classList.toggle("active",w.e=I),A!==w.t&&b.classList.toggle("active",w.t=A),w},{e:void 0,t:void 0}),p})(),(()=>{var p=Kt(),C=p.firstChild,v=C.firstChild,b=v.nextSibling,O=C.nextSibling,w=O.firstChild,I=w.nextSibling,A=I.firstChild,K=A.nextSibling;return b.addEventListener("change",z=>i(z.currentTarget.value)),h(b,c(we,{get each(){return[...Array(e.nb_chapters).keys()]},children:(z,D)=>(()=>{var B=Dt();return h(B,()=>D()+1),T(()=>B.selected=e.i_chapter===D()),T(()=>B.value=D()),B})()})),I.addEventListener("change",z=>o(z.currentTarget.value)),T(z=>{var D=d()==="white",B=d()==="black";return D!==z.e&&(A.selected=z.e=D),B!==z.t&&(K.selected=z.t=B),z},{e:void 0,t:void 0}),p})(),at(),(()=>{var p=bi(),C=p.firstChild,v=C.nextSibling,b=v.nextSibling;return C.$$click=r,b.$$click=a,T(()=>b.disabled=m()===void 0),p})()]}function Li(e){const t=(v,b)=>{v==="Escape"&&(b.value=e.section.name)},n=v=>{let b=v.value;b.length<3&&(b="New Section",v.value=b),e.on_edit_section({id:e.section.id,name:b})},i=v=>{let b=tt.indexOf(v);e.on_order_section(b)},r=()=>{e.on_delete_section()},[a,o]=P("lichess"),[d,l]=P(""),s=E(()=>{let v=d().match(/\/study\/([a-zA-Z0-9]{8})\/?$/);return v?`https://lichess.org/api/study/${v[1]}.pgn`:void 0}),u=async v=>await fetch(v).then(b=>b.text()).then(b=>si(b)),[g]=Sn(s,u),$=async()=>{let v=g();v&&e.on_import_pgns(v,e.section.name)},m=E(()=>s()===void 0),p=v=>{e.on_edit_section({id:e.section.id,orientation:v})},C=E(()=>e.section.orientation);return[ki(),(()=>{var v=Gt(),b=v.firstChild,O=b.nextSibling;return O.addEventListener("change",w=>n(w.currentTarget)),O.$$keydown=w=>t(w.key,w.currentTarget),T(()=>O.value=e.section.name),v})(),(()=>{var v=$i(),b=v.firstChild,O=b.nextSibling;return b.$$click=()=>o("empty"),O.$$click=()=>o("lichess"),T(w=>{var I="tab "+(a()==="empty"?"active":""),A="tab "+(a()==="lichess"?"active":"");return I!==w.e&&Z(b,w.e=I),A!==w.t&&Z(O,w.t=A),w},{e:void 0,t:void 0}),v})(),(()=>{var v=yi();return h(v,c(x,{get when(){return a()==="lichess"},get children(){var b=wi(),O=b.firstChild,w=O.nextSibling;return w.addEventListener("change",I=>l(I.target.value)),w.$$keyup=I=>l(I.currentTarget.value),T(()=>Z(w,m()?"error":"success")),b}}),null),h(v,c(x,{get when(){return a()==="empty"},get children(){return[]}}),null),v})(),(()=>{var v=Kt(),b=v.firstChild,O=b.firstChild,w=O.nextSibling,I=b.nextSibling,A=I.firstChild,K=A.nextSibling,z=K.firstChild,D=z.nextSibling;return w.addEventListener("change",B=>i(B.currentTarget.value)),h(w,c(we,{get each(){return tt.slice(0,e.nb_sections)},children:(B,y)=>(()=>{var S=Dt();return S.value=B,h(S,B),T(()=>S.selected=e.i_section===y()),S})()})),K.addEventListener("change",B=>p(B.currentTarget.value)),T(B=>{var y=C()==="white",S=C()==="black";return y!==B.e&&(z.selected=B.e=y),S!==B.t&&(D.selected=B.t=S),B},{e:void 0,t:void 0}),v})(),at(),(()=>{var v=Ut(),b=v.firstChild,O=b.nextSibling;return h(v,c(x,{get when(){return a()==="lichess"},get children(){return c(Et,{get fallback(){return Si()},get children(){var w=Ci();return w.$$click=$,T(()=>w.disabled=g()===void 0),w}})}}),O),O.$$click=r,v})()]}Me(["keydown","click","keyup"]);var Wt=f('<main class="openings-show study"><div class=details-wrap></div><div class=board-wrap></div><div class=replay-wrap><div class=header></div></div><div class=sections-wrap></div><div class=tools-wrap>'),Qt=f('<button class="feature practice"><i data-icon=>'),Oi=f("<a class=analyze data-icon=>Analyze on lichess"),qi=f("<a class=copy-line data-icon=>Copy variation PGN"),Bi=f('<a class="annotate has-sub-menu"data-icon=><i class=glyph-icon></i>Annotate Glyph'),Ni=f("<a class=delete data-icon=>Delete after this move"),Pi=f("<div class=context-sub-menu>"),Ti=f("<a><i>"),Ri=f("<h4>Take Quiz"),Ii=f("<h4>Play Deathmatch"),Ai=f("<h4>Practice with the Computer"),zi=f("<div class=practice-feature><div class=tabs><div>Practice</div></div><div>"),Mi=f("<span>Your turn."),Ui=f("<div class=info-wrap><div class=status></div><div class=info><p>Computer will follow the lines in the opening.</p><p>Moves will be hidden."),Gi=f('<div class="rematch-buttons buttons"><button class=end>End</button><button class=rematch>Rematch</button><button><i>'),Ki=f("<span>..."),jt=f("<span>1 of 15"),Ft=f("<button class=retake>Re-take"),Di=f("<p>You are given 15 random positions from the opening. Play the correct moves."),Ht=f("<div class=info-wrap><div class=status></div><div class=info>"),Wi=f("<div class=quiz-history>"),Vt=f("<button class=start>Start"),Yt=f('<div class="quiz-buttons buttons">'),Qi=f("<div class=quiz-item>"),ji=f("<p>You will play the moves from the opening. If you go out of book, game ends."),Fi=f("<i data-icon=>"),Hi=f("<button class=new><i data-icon=></i><span>New Section"),Vi=f("<div class=sections-list><div class=header><span class=title></span><div class=tools></div></div><div class=list><div class=tools>"),ot=f("<i data-icon=>"),Yi=f("<button class=new><i data-icon=></i><span>New Chapter"),Zi=f('<div class="section active"><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis></span></div></div><div class=chapters-list><div class=list></div><div class=tools>'),Ji=f("<div><div class=title><span class=nth>."),Xi=f("<div class=section><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis>"),es=f("<div class=no-sections>No Sections yet."),ts=f("<div class=no-chapters>No Chapters yet."),ns=f("<div class=loading-chapters>Loading Chapters."),is=f("<div class=tabs><div><i data-icon=></i></div><div><i data-icon=>"),ss=f("<div class=settings><div class=group><label for=editable>Disable Edits</label><input id=editable type=checkbox>"),rs=f("<div class=export><button>Copy PGN</button><button>Export as PGN</button><button>Export to Lichess Study"),as=f("<div class=fen><h4>FEN"),os=f("<div class=content>"),ls=f("<div class=copy-input-text><input type=text readonly>"),cs=f("<span class=copied><i data-icon=>"),ds=f("<span><i data-icon=>"),us=f("<div class=loading>Loading");const Bs=()=>{const[e,{load_study:t}]=ce();let n=xn();return Xe(()=>t(n.id)),c(_s,pe(()=>hs(e,n.id)))};function hs(e,t){let n=E(()=>e.studies[t]),i=E(()=>{let d=n()?.sections;return n()?.section_ids.map(l=>d.find(s=>s.id===l))}),r=E(()=>{let d=n(),l=d?.selected_section_id;if(l)return d?.sections.find(s=>s.id===l)}),a=E(()=>{let d=r();if(d)return d.chapter_ids.map(l=>e.chapters.list.find(s=>s.id===l)).filter(Boolean)}),o=E(()=>{let l=r()?.selected_chapter_id;if(l)return a()?.find(s=>s.id===l)});return{get study(){return n()},get selected_section(){return r()},get selected_chapter(){return o()},get sections(){return i()},get chapters(){return a()}}}function _s(e){const[,{reset_replay_tree:t,load_replay_tree:n,load_chapter:i,load_chapters:r}]=ce(),[a,o]=P("show"),[,d]=st();Xe(et(E(()=>e.selected_section?.id),s=>s&&d(()=>r(s)))),Xe(et(E(()=>e.selected_chapter?.id),s=>{d(s?()=>{i(s),n(s)}:()=>{t()})}));const l=s=>({...e,study:s});return c(Et,{get fallback(){return c(Es,{})},get children(){return c(x,{get when(){return e.study},children:s=>[c(x,{get when(){return a()==="show"},get children(){return c(fs,pe(()=>l(s()),{on_feature_practice:()=>o("practice")}))}}),c(x,{get when(){return a()==="practice"},get children(){return c(gs,pe(()=>l(s()),{on_feature_practice_off:()=>o("show")}))}})]})}})}function fs(e){const[t,{goto_path:n,goto_path_if_can:i,delete_at_and_after_path:r,tree_step_node_set_nags:a,add_child_san_to_current_path:o,chapter_as_export_pgn:d,set_write_enabled_replay_tree:l}]=ce();l(!e.study.is_edits_disabled);let s=Lt(t),[u,g]=P(),[$,m]=P(!1),[p,C]=P(!1),[v,b]=P(!1),[O,w]=P(!1);const I=E(()=>{let _=u();if(_)return En(t.replay_tree.steps_tree,_)});Ie(()=>{const _=()=>{g(void 0)};document.addEventListener("click",_),Ae(()=>{document.removeEventListener("click",_)})});let A,K;const z=(_,L)=>{n(L),g(L);let R=_.clientX,F=_.clientY,H=K.getBoundingClientRect(),V=A.getBoundingClientRect();R-=V.left,F-=V.top,R=Math.min(R,document.body.clientWidth-H.width-V.left-20);let ee=`${F}px`,se=`${R}px`;K.style.top=ee,K.style.left=se},D=_=>{let L=_.fen;window.open(`https://lichess.org/analysis?fen=${L}`,"_blank"),g(void 0)},[,B]=st(),y=async _=>{B(()=>{r(_)}),g(void 0)};let S;const W=_=>{clearTimeout(S),S=void 0,_===!1?S=setTimeout(()=>{m(!1)},150):S=setTimeout(()=>{m(!0)},100)},re=async(_,L)=>{await a(_,[Nn(L)]),clearTimeout(S),m(!1)};let ae,[me,ie]=P(void 0);const q=E(()=>{let _=me();if(K===void 0||_===void 0)return"";let L=ae.getBoundingClientRect(),R=_.getBoundingClientRect(),F=K.getBoundingClientRect(),H=L.top,V=F.left-R.width,ee=A.getBoundingClientRect();return V-=ee.left,H-=ee.top,`top: ${H}px; left: ${V}px;`}),M=_=>{i(_)};let oe=E(()=>{let _=s.step_at_cursor_path;if(!_)return[];let L=_.nags?.[0];return L?Rt(_.step.uci,_.step.san,Tt(L)):[]});const te=E(()=>e.selected_chapter?.name??"[detached]"),de=E(()=>u()!==void 0||p()||v()!==void 0||O()!==void 0);let[,{create_section:ve,create_chapter:ne}]=ce();const ue=async(_,L)=>{let R=v()?e.selected_section:void 0;b(!1);let F=e.study.name,H={};Ee({id:e.study.id,is_edits_disabled:!0});for(let G of _){let N=G.event,[Y,_e,fe]=N.split(":");fe||(fe=_e,_e=L),H[_e]===void 0&&(H[_e]=[]),H[_e].push([fe,G]),F=Y}await ct({id:e.study.id,name:F});let V=Object.keys(H)[0];R&&await lt(e.study.id,{id:R.id,name:V});let ee,se=R;for(V of Object.keys(H)){R||(R=await ve(e.study.id,V));let G=H[V];for(let[N,Y]of G)ee=await ne(e.study.id,R.id,N,Y);se=R,R=void 0}se&&ee&&(Ee({id:e.study.id,selected_section_id:se.id}),qe(e.study.id,{id:se.id,selected_chapter_id:ee.id}))},be=()=>{};async function he(){return await Promise.all(e.sections.map(L=>Promise.all(L.chapter_ids.map(R=>t.chapters.list.find(F=>F.id===R)).map(R=>d(e.study.name,L.name,R))).then(R=>R.join(`

`)))).then(L=>L.join(`


`))}const le=async()=>{let _=await he();Ls(_,`${e.study.name}.pgn`)},xe=async()=>{let _=await d(e.study.name,e.selected_section.name,e.selected_chapter);navigator.clipboard.writeText(_)},ye=_=>{let L=Bn(t.replay_tree.steps_tree,_);navigator.clipboard.writeText(L),g(void 0)},Ue=_=>{_>0?i(s.get_next_path):i(s.get_prev_path)},Ge=E(()=>!e.study.is_edits_disabled),Oe=_=>e.sections.indexOf(_),Ke=_=>e.chapters.indexOf(_),[,{update_section:qe,delete_section:De,update_chapter:U,delete_chapter:Ce,update_study:Ee,delete_study:Pe,order_sections:en,order_chapters:tn,change_root_fen:nn}]=ce(),lt=qe,sn=(_,L)=>{De(_,L),b(!1)},rn=(_,L,R)=>{R.orientation&&dt(void 0),U(_,L,R)},an=_=>{ke(()=>{Ce(e.study.id,e.selected_section.id,_),w(!1)})},ct=Ee,on=Ln(),ln=async _=>{await Pe(_),on("/openings")},cn=(_,L)=>{en(_.study_id,_.id,L)},dn=(_,L)=>{tn(e.study.id,_.section_id,_.id,L)},un=async _=>{await nn(e.selected_chapter.id,_),w(!1)},hn=async(_,L)=>{let F=Bt(s.fen),H=F.turn,V=F.board.get(it(_)),ee=_+L;V.role==="pawn"&&(L[1]==="8"&&H==="white"||L[1]==="1"&&H==="black")&&(ee+="q");let se=Nt(ee),G=Pt(F,se),N=await o(G);n(N.step.path)},[_n,dt]=P(),ut=E(()=>_n()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),ht=_=>{_.key==="f"&&dt(j(ut()))};return Ie(()=>{document.addEventListener("keydown",ht),Ae(()=>{document.removeEventListener("keydown",ht)})}),(()=>{var _=Wt(),L=_.firstChild,R=L.nextSibling,F=R.nextSibling,H=F.firstChild,V=F.nextSibling,ee=V.nextSibling,se=A;return typeof se=="function"?Re(se,_):A=_,h(L,c(Jt,pe(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),$e(R,"wheel",zt(Ue)),h(R,c(It,{get orientation(){return ut()},get shapes(){return oe()},get movable(){return Ge()},get color(){return Ot(s.fen)},get fen(){return s.fen},get last_move(){return s.last_move},play_orig_key:hn})),h(H,te),h(F,c(qt,{handle_goto_path:M,get replay_tree(){return t.replay_tree},get lose_focus(){return de()},on_context_menu:z,get features(){return(()=>{var G=Qt();return $e(G,"click",e.on_feature_practice,!0),G})()}}),null),h(V,c(Zt,pe(e,{get is_edits_disabled(){return e.study.is_edits_disabled},on_edit_study:()=>C(!0),on_edit_section:()=>b(!0),on_edit_chapter:()=>w(!0)}))),h(ee,c(Ss,pe(e,{get fen(){return s.fen},on_export_lichess:be,on_export_pgn:le,on_copy_pgn:xe}))),h(_,c(x,{get when(){return v()},get children(){return c(Fe,{klass:"edit-section",on_close:()=>b(!1),get children(){return c(Li,{get section(){return e.selected_section},get i_section(){return Oe(e.selected_section)},get nb_sections(){return e.sections.length},on_delete_section:()=>sn(e.study.id,e.selected_section.id),on_edit_section:G=>lt(e.study.id,G),on_order_section:G=>cn(e.selected_section,G),on_import_pgns:ue})}})}}),null),h(_,c(x,{get when(){return O()},get children(){return c(Fe,{klass:"edit-chapter",on_close:()=>w(!1),get children(){return c(Ei,{get fen(){return s.initial_fen},get nb_chapters(){return e.chapters.length},get chapter(){return e.selected_chapter},get i_chapter(){return Ke(e.selected_chapter)},on_edit_chapter:G=>rn(e.study.id,e.selected_chapter.section_id,G),on_delete_chapter:()=>an(e.selected_chapter.id),on_order_chapter:G=>dn(e.selected_chapter,G),on_change_root_fen:un})}})}}),null),h(_,c(x,{get when(){return p()},get children(){return c(Fe,{klass:"edit-study",on_close:()=>C(!1),get children(){return c(xi,{get study(){return e.study},on_delete_study:()=>ln(e.study.id),on_update_study:ct})}})}}),null),h(_,c(x,{get when(){return I()},children:G=>[c(On,{get step(){return G().step},ref(N){var Y=K;typeof Y=="function"?Y(N):K=N},get children(){return[(()=>{var N=Oi();return N.$$click=()=>D(G().step),N})(),(()=>{var N=qi();return N.$$click=()=>ye(G().step.path),N})(),c(x,{get when(){return!e.study.is_edits_disabled},get children(){return[(()=>{var N=Bi();N.addEventListener("mouseenter",()=>W(!0)),N.addEventListener("mouseleave",()=>W(!1));var Y=ae;return typeof Y=="function"?Re(Y,N):ae=N,N})(),(()=>{var N=Ni();return N.$$click=()=>y(G().step.path),N})()]}})]}}),c(x,{get when(){return $()},get children(){var N=Pi();return Re(Y=>setTimeout(()=>ie(Y)),N),N.addEventListener("mouseenter",()=>W(!0)),N.addEventListener("mouseleave",()=>W(!1)),h(N,c(we,{each:qn,children:(Y,_e)=>(()=>{var fe=Ti(),fn=fe.firstChild;return fe.$$click=()=>re(G(),Y),h(fe,()=>We[_e()],null),T(Be=>{var _t="annotate glyph "+We[_e()],ft=`glyph-icon ${We[_e()]}`;return _t!==Be.e&&Z(fe,Be.e=_t),ft!==Be.t&&Z(fn,Be.t=ft),Be},{e:void 0,t:void 0}),fe})()})),T(Y=>xt(N,q(),Y)),N}})]}),null),_})()}function gs(e){const[t,{goto_path:n,goto_path_force:i,goto_path_if_can:r,set_hide_after_path:a,add_child_san_to_success_or_error_path_no_save:o,set_write_enabled_replay_tree:d}]=ce();d(!1);let l=Lt(t);const[s,u]=P("practice"),g=q=>{q>0?r(l.get_next_path):r(l.get_prev_path)},[$,m]=P(),p=E(()=>$()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),C=q=>{q.key==="f"&&ke(()=>{m(j(p())),z(void 0),ie()})};Ie(()=>{document.addEventListener("keydown",C),Ae(()=>{document.removeEventListener("keydown",C)})});let v=E(()=>{let q=l.step_at_cursor_path;if(!q)return[];let M=q.nags?.[0];return M?Rt(q.step.uci,q.step.san,Tt(M)):[]});const b=async(q,M)=>{let te=Bt(l.fen),de=te.turn,ve=te.board.get(it(q)),ne=q+M;ve.role==="pawn"&&(M[1]==="8"&&de==="white"||M[1]==="1"&&de==="black")&&(ne+="q");let ue=Nt(ne),be=Pt(te,ue);re(be)},O=E(()=>e.selected_chapter?.name??"[detached]"),w=q=>{r(q)},[I,A]=P(),[K,z]=P(),[D,B]=P(!1),y=E(()=>I()===void 0&&D()),S=E(()=>K()??p()),W=E(()=>[]),re=async q=>{s()==="practice"&&ae(q)},ae=async q=>{let M=await o(q);M&&(M[0]==="error"?(i(M[1].step.path),A(setTimeout(()=>{ke(()=>{n(In(M[1].step.path)),A(void 0)})},600))):(ke(()=>{i(M[1].step.path),a(M[1].step.path)}),ie()))},me=q=>{q!==void 0&&(z(q),a(void 0),i(""),ie())},ie=()=>{if(S()!==l.turn){let q=Rn(t.replay_tree.steps_tree,t.replay_tree.cursor_path);if(q=q.filter(oe=>!t.replay_tree.error_paths.includes(oe.step.path)),!q||q.length===0)return;let M=At(q);A(setTimeout(()=>{ke(()=>{i(M.step.path),a(M.step.path),A(void 0)})},500))}};return(()=>{var q=Wt(),M=q.firstChild,oe=M.nextSibling,te=oe.nextSibling,de=te.firstChild,ve=te.nextSibling;return h(M,c(Jt,pe(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),$e(oe,"wheel",zt(g)),h(oe,c(It,{get orientation(){return S()},get shapes(){return v()},get movable(){return y()},get color(){return Ot(l.fen)},get fen(){return l.fen},get last_move(){return l.last_move},play_orig_key:b})),h(de,O),h(te,c(qt,{handle_goto_path:w,get replay_tree(){return t.replay_tree},lose_focus:!1,on_context_menu:()=>{},get features(){return(()=>{var ne=Qt();return $e(ne,"click",e.on_feature_practice_off,!0),ne})()},get feature_content(){return(()=>{var ne=zi(),ue=ne.firstChild,be=ue.firstChild,he=ue.nextSibling;return be.$$click=()=>u("practice"),h(he,c(x,{get when(){return s()==="quiz"},get children(){return[Ri(),c(vs,{get nodes(){return W()}})]}}),null),h(he,c(x,{get when(){return s()==="deathmatch"},get children(){return[Ii(),c(bs,{})]}}),null),h(he,c(x,{get when(){return s()==="practice"},get children(){return[Ai(),c(ps,{get movable(){return y()},on_rematch:me,get color(){return S()},set_movable:B})]}}),null),T(le=>{var xe="feature tab"+(s()==="practice"?" active":""),ye="content "+s();return xe!==le.e&&Z(be,le.e=xe),ye!==le.t&&Z(he,le.t=ye),le},{e:void 0,t:void 0}),ne})()}}),null),h(ve,c(Zt,pe(e,{is_edits_disabled:!0}))),q})()}function ps(e){const[t,{goto_path:n,reload_replay_tree_with_cursor_path:i}]=ce(),[,r]=st(),a=l=>{if(l===void 0){r(()=>{i(t.replay_tree.cursor_path)});return}ke(()=>{r(()=>{i(""),e.on_rematch(l)})})},o=E(()=>e.color),d=E(()=>j(o()));return e.set_movable(!0),n(""),[(()=>{var l=Ui(),s=l.firstChild;return h(s,c(x,{get when(){return e.movable},get fallback(){return Ki()},get children(){return Mi()}})),l})(),(()=>{var l=Gi(),s=l.firstChild,u=s.nextSibling,g=u.nextSibling;return s.$$click=()=>a(),u.$$click=()=>a(o()),g.$$click=()=>a(d()),T(()=>Z(g,`color ${d()}`)),l})()]}function ms(e){let[t,n]=P(void 0);return{step:e,get is_solved(){return t()},set is_solved(i){n(i)}}}function vs(e){let[t,n]=P([...Array(15).keys()]);const[i,r]=P("info");let o=E(Pn(t,()=>ms(At(e.nodes))));return[(()=>{var d=Ht(),l=d.firstChild,s=l.nextSibling;return h(l,c(x,{get when(){return i()==="info"},children:"Press start"}),null),h(l,c(x,{get when(){return i()==="in-progress"},get children(){return jt()}}),null),h(l,c(x,{get when(){return i()==="end"},get children(){return Ft()}}),null),h(s,c(x,{get when(){return i()==="info"},get children(){return Di()}})),d})(),(()=>{var d=Wi();return h(d,c(we,{get each(){return o()},children:(l,s)=>(()=>{var u=Qi();return h(u,()=>s()+1),u})()})),d})(),(()=>{var d=Yt();return h(d,c(x,{get when(){return i()==="info"},get children(){return Vt()}})),d})()]}function bs(){const[e,t]=P("info");return[(()=>{var n=Ht(),i=n.firstChild,r=i.nextSibling;return h(i,c(x,{get when(){return e()==="info"},children:"Press start"}),null),h(i,c(x,{get when(){return e()==="in-progress"},get children(){return jt()}}),null),h(i,c(x,{get when(){return e()==="end"},get children(){return Ft()}}),null),h(r,c(x,{get when(){return e()==="info"},get children(){return ji()}})),n})(),(()=>{var n=Yt();return h(n,c(x,{get when(){return e()==="info"},get children(){return Vt()}})),n})()]}function Zt(e){let[,{create_section:t,update_study:n}]=ce();const i=async()=>{let a=await t(e.study.id);await r(a.id),e.on_edit_section?.()},r=a=>n({id:e.study.id,selected_section_id:a});return(()=>{var a=Vi(),o=a.firstChild,d=o.firstChild,l=d.nextSibling,s=o.nextSibling,u=s.firstChild;return h(d,()=>e.study.name),h(l,c(x,{get when(){return!e.is_edits_disabled},get children(){var g=Fi();return g.$$click=()=>e.on_edit_study?.(),g}})),h(s,c(we,{get each(){return e.sections},get fallback(){return c(ys,{})},children:(g,$)=>c(x,{get when(){return g===e.selected_section},get fallback(){return c(ws,{get is_edits_disabled(){return e.is_edits_disabled},section:g,get nth(){return $t($())},on_selected:()=>r(g.id),on_edit:()=>e.on_edit_section?.()})},get children(){return c(ks,pe(e,{section:g,get is_edits_disabled(){return e.is_edits_disabled},get nth(){return $t($())},get on_edit(){return e.on_edit_section},get on_edit_chapter(){return e.on_edit_chapter}}))}})}),u),h(u,c(x,{get when(){return!e.is_edits_disabled},get children(){var g=Hi();return g.$$click=i,g}})),a})()}function ks(e){let[,{create_chapter:t,update_section:n}]=ce();const i=async()=>{let a=await t(e.study.id,e.section.id);await r(a.id),e.on_edit_chapter?.()},r=async a=>n(e.study.id,{id:e.section.id,selected_chapter_id:a});return(()=>{var a=Zi(),o=a.firstChild,d=o.firstChild,l=d.firstChild,s=l.nextSibling,u=o.nextSibling,g=u.firstChild,$=g.nextSibling;return h(l,()=>e.nth),h(s,()=>e.section?.name),h(o,c(x,{get when(){return!e.is_edits_disabled},get children(){var m=ot();return m.$$click=()=>e.on_edit?.(),m}}),null),h(g,c(we,{get each(){return e.chapters},get fallback(){return c(Cs,{})},children:(m,p)=>c($s,{get is_edits_disabled(){return e.is_edits_disabled},chapter:m,get nth(){return`${e.nth}${p()+1}`},get selected(){return e.selected_chapter===m},on_selected:()=>r(m.id),on_edit:()=>e.on_edit_chapter?.()})})),h($,c(x,{get when(){return!e.is_edits_disabled},get children(){var m=Yi();return m.$$click=()=>i(),m}})),T(()=>Tn(s,"title",e.section?.name)),a})()}function $s(e){const t=E(()=>e.selected?" active":"");return(()=>{var n=Ji(),i=n.firstChild,r=i.firstChild,a=r.firstChild;return n.$$click=()=>e.on_selected(),h(r,()=>e.nth,a),h(i,()=>e.chapter.name,null),h(n,c(x,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),T(()=>Z(n,"chapter"+t())),n})()}function ws(e){return(()=>{var t=Xi(),n=t.firstChild,i=n.firstChild,r=i.firstChild,a=r.nextSibling;return n.$$click=()=>e.on_selected(),h(r,()=>e.nth),h(a,()=>e.section.name),h(n,c(x,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),t})()}function ys(){return es()}function Cs(){return ts()}function Ns(){return ns()}function Jt(e){return[]}function Ss(e){const[,{update_study:t}]=ce(),[n,i]=P("share"),[r,a]=P(!0,{equals:!1}),o=()=>{a(!0),e.on_copy_pgn()},d=e.study.is_edits_disabled,l=s=>t({id:e.study.id,is_edits_disabled:s});return[(()=>{var s=is(),u=s.firstChild,g=u.nextSibling;return u.$$click=()=>i("settings"),g.$$click=()=>i("share"),T($=>{var m="tab"+(n()==="settings"?" active":""),p="tab"+(n()==="share"?" active":"");return m!==$.e&&Z(u,$.e=m),p!==$.t&&Z(g,$.t=p),$},{e:void 0,t:void 0}),s})(),(()=>{var s=os();return h(s,c(x,{get when(){return n()==="settings"},get children(){var u=ss(),g=u.firstChild,$=g.firstChild,m=$.nextSibling;return m.addEventListener("change",p=>l(p.currentTarget.checked)),m.checked=d,u}}),null),h(s,c(x,{get when(){return n()==="share"},get children(){return[(()=>{var u=rs(),g=u.firstChild,$=g.firstChild,m=g.nextSibling,p=m.nextSibling;return g.$$click=o,h(g,c(Xt,{get on_copy(){return r()}}),$),$e(m,"click",e.on_export_pgn,!0),$e(p,"click",e.on_export_lichess,!0),u})(),(()=>{var u=as();return u.firstChild,h(u,c(xs,{get value(){return e.fen}}),null),u})()]}}),null),s})()]}function xs(e){const[t,n]=P(!0,{equals:!1}),i=()=>{navigator.clipboard.writeText(e.value),n(!0)};return(()=>{var r=ls(),a=r.firstChild;return r.$$click=i,h(r,c(Xt,{get on_copy(){return t()}}),null),T(()=>a.value=e.value),r})()}function Xt(e){Ne(et(()=>e.on_copy,()=>{n(!0),setTimeout(()=>n(!1),1e3)},{defer:!0}));const[t,n]=P(!1);return c(x,{get when(){return t()},get fallback(){return ds()},get children(){return cs()}})}function Es(){return us()}function Ls(e,t){const n=new Blob([e],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(n),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}Me(["click"]);export{$s as ChapterComponent,Ns as LoadingChapters,Cs as NoChapters,ys as NoSections,Bs as default};
