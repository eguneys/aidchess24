var hn=Object.defineProperty;var un=(e,t,n)=>t in e?hn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ae=(e,t,n)=>(un(e,typeof t!="symbol"?t+"":t,n),n);import{o as dn,l as fn,n as pn,t as Et,i as st,c as ct,k as mn,b as Re}from"./index-QB6fjEOh.js";const Mt=["a","b","c","d","e","f","g","h"],gn=["1","2","3","4","5","6","7","8"],Z=["white","black"],z=["pawn","knight","bishop","rook","queen","king"],wn=["a","h"],De=e=>"role"in e,p=e=>e!==void 0,M=e=>e==="white"?"black":"white",ue=e=>e>>3,H=e=>e&7,Ne=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,At=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Ke(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function me(e){if(e.length===2)return Ne(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const $e=e=>Mt[H(e)]+gn[ue(e)],bn=e=>{if(e[1]==="@"&&e.length===4){const t=Ke(e[0]),n=me(e.slice(2));if(t&&p(n))return{role:t,to:n}}else if(e.length===4||e.length===5){const t=me(e.slice(0,2)),n=me(e.slice(2,4));let i;if(e.length===5&&(i=Ke(e[4]),!i))return;if(p(t)&&p(n))return{from:t,to:n,promotion:i}}},Ve=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,Ue=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61;class Rt{unwrap(t,n){const i=this._chain(r=>m.ok(t?t(r):r),r=>n?m.ok(n(r)):m.err(r));if(i.isErr)throw i.error;return i.value}map(t,n){return this._chain(i=>m.ok(t(i)),i=>m.err(n?n(i):i))}chain(t,n){return this._chain(t,n||(i=>m.err(i)))}}class kn extends Rt{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,n){return t(this.value)}}class vn extends Rt{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,n){return n(this.error)}}var m;(function(e){e.ok=function(t){return new kn(t)},e.err=function(t){return new vn(t||new Error)},e.all=function(t){if(Array.isArray(t)){const r=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;r.push(s.value)}return e.ok(r)}const n={},i=Object.keys(t);for(let r=0;r<i.length;r++){const o=t[i[r]];if(o.isErr)return o;n[i[r]]=o.value}return e.ok(n)}})(m||(m={}));const lt=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),_e=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),at=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,_e(e));class l{constructor(t,n){this.lo=t|0,this.hi=n|0}static fromSquare(t){return t>=32?new l(0,1<<t-32):new l(1<<t,0)}static fromRank(t){return new l(255,0).shl64(8*t)}static fromFile(t){return new l(16843009<<t,16843009<<t)}static empty(){return new l(0,0)}static full(){return new l(4294967295,4294967295)}static corners(){return new l(129,2164260864)}static center(){return new l(402653184,24)}static backranks(){return new l(255,4278190080)}static backrank(t){return t==="white"?new l(255,0):new l(0,4278190080)}static lightSquares(){return new l(1437226410,1437226410)}static darkSquares(){return new l(2857740885,2857740885)}complement(){return new l(~this.lo,~this.hi)}xor(t){return new l(this.lo^t.lo,this.hi^t.hi)}union(t){return new l(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new l(this.lo&t.lo,this.hi&t.hi)}diff(t){return new l(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?l.empty():t>=32?new l(this.hi>>>t-32,0):t>0?new l(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?l.empty():t>=32?new l(0,this.lo<<t-32):t>0?new l(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new l(_e(this.hi),_e(this.lo))}rbit64(){return new l(at(this.hi),at(this.lo))}minus64(t){const n=this.lo-t.lo,i=(n&t.lo&1)+(t.lo>>>1)+(n>>>1)>>>31;return new l(n,this.hi-(t.hi+i))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return lt(this.lo)+lt(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,n){return n?this.with(t):this.without(t)}with(t){return t>=32?new l(this.lo,this.hi|1<<t-32):new l(this.lo|1<<t,this.hi)}without(t){return t>=32?new l(this.lo,this.hi&~(1<<t-32)):new l(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new l(this.lo,this.hi^1<<t-32):new l(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new l(this.lo&this.lo-1,this.hi):new l(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,n=this.hi;for(;t!==0;){const i=31-Math.clz32(t&-t);t^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let t=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;t!==0;){const i=31-Math.clz32(t);t^=1<<i,yield i}}}class ie{constructor(){}static default(){const t=new ie;return t.reset(),t}reset(){this.occupied=new l(65535,4294901760),this.promoted=l.empty(),this.white=new l(65535,0),this.black=new l(0,4294901760),this.pawn=new l(65280,16711680),this.knight=new l(66,1107296256),this.bishop=new l(36,603979776),this.rook=new l(129,2164260864),this.queen=new l(8,134217728),this.king=new l(16,268435456)}static empty(){const t=new ie;return t.clear(),t}clear(){this.occupied=l.empty(),this.promoted=l.empty();for(const t of Z)this[t]=l.empty();for(const t of z)this[t]=l.empty()}clone(){const t=new ie;t.occupied=this.occupied,t.promoted=this.promoted;for(const n of Z)t[n]=this[n];for(const n of z)t[n]=this[n];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const n of z)if(this[n].has(t))return n}get(t){const n=this.getColor(t);if(!n)return;const i=this.getRole(t),r=this.promoted.has(t);return{color:n,role:i,promoted:r}}take(t){const n=this.get(t);return n&&(this.occupied=this.occupied.without(t),this[n.color]=this[n.color].without(t),this[n.role]=this[n.role].without(t),n.promoted&&(this.promoted=this.promoted.without(t))),n}set(t,n){const i=this.take(t);return this.occupied=this.occupied.with(t),this[n.color]=this[n.color].with(t),this[n.role]=this[n.role].with(t),n.promoted&&(this.promoted=this.promoted.with(t)),i}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,n){return this[t].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class I{constructor(){}static empty(){const t=new I;for(const n of z)t[n]=0;return t}static fromBoard(t,n){const i=new I;for(const r of z)i[r]=t.pieces(n,r).size();return i}clone(){const t=new I;for(const n of z)t[n]=this[n];return t}equals(t){return z.every(n=>this[n]===t[n])}add(t){const n=new I;for(const i of z)n[i]=this[i]+t[i];return n}nonEmpty(){return z.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class te{constructor(t,n){this.white=t,this.black=n}static empty(){return new te(I.empty(),I.empty())}static fromBoard(t){return new te(I.fromBoard(t,"white"),I.fromBoard(t,"black"))}clone(){return new te(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new te(this.white.add(t.white),this.black.add(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class le{constructor(t,n){this.white=t,this.black=n}static default(){return new le(3,3)}clone(){return new le(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}const yn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Cn=yn+" w KQkq -",Pn=Cn+" 0 1";var y;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(y||(y={}));class E extends Error{}const En=(e,t,n)=>{let i=e.indexOf(t);for(;n-- >0&&i!==-1;)i=e.indexOf(t,i+t.length);return i},ne=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,St=e=>{const t=Ke(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},Se=e=>{const t=ie.empty();let n=7,i=0;for(let r=0;r<e.length;r++){const o=e[r];if(o==="/"&&i===8)i=0,n--;else{const s=parseInt(o,10);if(s>0)i+=s;else{if(i>=8||n<0)return m.err(new E(y.Board));const c=i+n*8,h=St(o);if(!h)return m.err(new E(y.Board));e[r+1]==="~"&&(h.promoted=!0,r++),t.set(c,h),i++}}}return n!==0||i!==8?m.err(new E(y.Board)):m.ok(t)},ht=e=>{if(e.length>64)return m.err(new E(y.Pockets));const t=te.empty();for(const n of e){const i=St(n);if(!i)return m.err(new E(y.Pockets));t[i.color][i.role]++}return m.ok(t)},Mn=(e,t)=>{let n=l.empty();if(t==="-")return m.ok(n);for(const i of t){const r=i.toLowerCase(),o=i===r?"black":"white",s=o==="white"?0:7;if("a"<=r&&r<="h")n=n.with(Ne(r.charCodeAt(0)-97,s));else if(r==="k"||r==="q"){const c=e[o].intersect(l.backrank(o)).intersect(e.rook.union(e.king)),h=r==="k"?c.last():c.first();n=n.with(p(h)&&e.rook.has(h)?h:Ne(r==="k"?7:0,s))}else return m.err(new E(y.Castling))}return Z.some(i=>l.backrank(i).intersect(n).size()>2)?m.err(new E(y.Castling)):m.ok(n)},ut=e=>{const t=e.split("+");if(t.length===3&&t[0]===""){const n=ne(t[1]),i=ne(t[2]);return!p(n)||n>3||!p(i)||i>3?m.err(new E(y.RemainingChecks)):m.ok(new le(3-n,3-i))}else if(t.length===2){const n=ne(t[0]),i=ne(t[1]);return!p(n)||n>3||!p(i)||i>3?m.err(new E(y.RemainingChecks)):m.ok(new le(n,i))}else return m.err(new E(y.RemainingChecks))},An=e=>{const t=e.split(/[\s_]+/),n=t.shift();let i,r=m.ok(void 0);if(n.endsWith("]")){const c=n.indexOf("[");if(c===-1)return m.err(new E(y.Fen));i=Se(n.slice(0,c)),r=ht(n.slice(c+1,-1))}else{const c=En(n,"/",7);c===-1?i=Se(n):(i=Se(n.slice(0,c)),r=ht(n.slice(c+1)))}let o;const s=t.shift();if(!p(s)||s==="w")o="white";else if(s==="b")o="black";else return m.err(new E(y.Turn));return i.chain(c=>{const h=t.shift(),a=p(h)?Mn(c,h):m.ok(l.empty()),d=t.shift();let u;if(p(d)&&d!=="-"&&(u=me(d),!p(u)))return m.err(new E(y.EpSquare));let b=t.shift(),g;p(b)&&b.includes("+")&&(g=ut(b),b=t.shift());const w=p(b)?ne(b):0;if(!p(w))return m.err(new E(y.Halfmoves));const f=t.shift(),O=p(f)?ne(f):1;if(!p(O))return m.err(new E(y.Fullmoves));const R=t.shift();let P=m.ok(void 0);if(p(R)){if(p(g))return m.err(new E(y.RemainingChecks));P=ut(R)}else p(g)&&(P=g);return t.length>0?m.err(new E(y.Fen)):r.chain(V=>a.chain(re=>P.map(T=>({board:c,pockets:V,turn:o,castlingRights:re,remainingChecks:T,epSquare:u,halfmoves:w,fullmoves:Math.max(1,O)}))))})},Rn=e=>{let t=At(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},Sn=e=>{let t="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const o=r+i*8,s=e.get(o);s?(n>0&&(t+=n,n=0),t+=Rn(s)):n++,r===7&&(n>0&&(t+=n,n=0),i!==0&&(t+="/"))}return t},dt=e=>z.map(t=>At(t).repeat(e[t])).join(""),xn=e=>dt(e.white).toUpperCase()+dt(e.black),On=(e,t)=>{let n="";for(const i of Z){const r=l.backrank(i);let o=e.kingOf(i);p(o)&&!r.has(o)&&(o=void 0);const s=e.pieces(i,"rook").intersect(r);for(const c of t.intersect(r).reversed())if(c===s.first()&&p(o)&&c<o)n+=i==="white"?"Q":"q";else if(c===s.last()&&p(o)&&o<c)n+=i==="white"?"K":"k";else{const h=Mt[H(c)];n+=i==="white"?h.toUpperCase():h}}return n||"-"},Tn=e=>`${e.white}+${e.black}`,Dn=(e,t)=>[Sn(e.board)+(e.pockets?`[${xn(e.pockets)}]`:""),e.turn[0],On(e.board,e.castlingRights),p(e.epSquare)?$e(e.epSquare):"-",...e.remainingChecks?[Tn(e.remainingChecks)]:[],...t!=null&&t.epd?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" "),ge=(e,t)=>{let n=l.empty();for(const i of t){const r=e+i;0<=r&&r<64&&Math.abs(H(e)-H(r))<=2&&(n=n.with(r))}return n},q=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},Nn=q(e=>ge(e,[-9,-8,-7,-1,1,7,8,9])),Kn=q(e=>ge(e,[-17,-15,-10,-6,6,10,15,17])),$n={white:q(e=>ge(e,[7,9])),black:q(e=>ge(e,[-7,-9]))},xt=e=>Nn[e],Ot=e=>Kn[e],Ee=(e,t)=>$n[e][t],ze=q(e=>l.fromFile(H(e)).without(e)),Le=q(e=>l.fromRank(ue(e)).without(e)),Ie=q(e=>{const t=new l(134480385,2151686160),n=8*(ue(e)-H(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),Be=q(e=>{const t=new l(270549120,16909320),n=8*(ue(e)+H(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),We=(e,t,n)=>{let i=n.intersect(t),r=i.bswap64();return i=i.minus64(e),r=r.minus64(e.bswap64()),i.xor(r.bswap64()).intersect(t)},_n=(e,t)=>We(l.fromSquare(e),ze[e],t),zn=(e,t)=>{const n=Le[e];let i=t.intersect(n),r=i.rbit64();return i=i.minus64(l.fromSquare(e)),r=r.minus64(l.fromSquare(63-e)),i.xor(r.rbit64()).intersect(n)},we=(e,t)=>{const n=l.fromSquare(e);return We(n,Ie[e],t).xor(We(n,Be[e],t))},be=(e,t)=>_n(e,t).xor(zn(e,t)),Ln=(e,t)=>we(e,t).xor(be(e,t)),Tt=(e,t)=>{const n=l.fromSquare(t);return Le[e].intersects(n)?Le[e].with(e):Be[e].intersects(n)?Be[e].with(e):Ie[e].intersects(n)?Ie[e].with(e):ze[e].intersects(n)?ze[e].with(e):l.empty()},ae=(e,t)=>Tt(e,t).intersect(l.full().shl64(e).xor(l.full().shl64(t))).withoutFirst();var F;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(F||(F={}));class ee extends Error{}const In=(e,t,n,i)=>n[t].intersect(be(e,i).intersect(n.rooksAndQueens()).union(we(e,i).intersect(n.bishopsAndQueens())).union(Ot(e).intersect(n.knight)).union(xt(e).intersect(n.king)).union(Ee(M(t),e).intersect(n.pawn)));class Q{constructor(){}static default(){const t=new Q;return t.castlingRights=l.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new l(14,0),h:new l(96,0)},black:{a:new l(0,234881024),h:new l(0,1610612736)}},t}static empty(){const t=new Q;return t.castlingRights=l.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:l.empty(),h:l.empty()},black:{a:l.empty(),h:l.empty()}},t}clone(){const t=new Q;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,n,i,r){const o=Ve(t,n),s=Ue(t,n);this.castlingRights=this.castlingRights.with(r),this.rook[t][n]=r,this.path[t][n]=ae(r,s).with(s).union(ae(i,o).with(o)).without(i).without(r)}static fromSetup(t){const n=Q.empty(),i=t.castlingRights.intersect(t.board.rook);for(const r of Z){const o=l.backrank(r),s=t.board.kingOf(r);if(!p(s)||!o.has(s))continue;const c=i.intersect(t.board[r]).intersect(o),h=c.first();p(h)&&h<s&&n.add(r,"a",s,h);const a=c.last();p(a)&&s<a&&n.add(r,"h",s,a)}return n}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const n of Z)for(const i of wn)this.rook[n][i]===t&&(this.rook[n][i]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(l.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Bn{constructor(t){this.rules=t}reset(){this.board=ie.default(),this.pockets=void 0,this.turn="white",this.castles=Q.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=l.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=Q.fromSetup(t),this.epSquare=Fn(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,n,i){return In(t,n,this.board,i)}playCaptureAt(t,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[M(n.color)][n.promoted?"pawn":n.role]++}ctx(){const t=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!p(n))return{king:n,blockers:l.empty(),checkers:l.empty(),variantEnd:t,mustCapture:!1};const i=be(n,l.empty()).intersect(this.board.rooksAndQueens()).union(we(n,l.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[M(this.turn)]);let r=l.empty();for(const s of i){const c=ae(n,s).intersect(this.board.occupied);c.moreThanOne()||(r=r.union(c))}const o=this.kingAttackers(n,M(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,n;const i=new this.constructor;return i.board=this.board.clone(),i.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(){if(this.board.occupied.isEmpty())return m.err(new ee(F.Empty));if(this.board.king.size()!==2)return m.err(new ee(F.Kings));if(!p(this.board.kingOf(this.turn)))return m.err(new ee(F.Kings));const t=this.board.kingOf(M(this.turn));return p(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?m.err(new ee(F.OppositeCheck)):l.backranks().intersects(this.board.pawn)?m.err(new ee(F.PawnsOnBackrank)):m.ok(void 0):m.err(new ee(F.Kings))}dropDests(t){return l.empty()}dests(t,n){if(n=n||this.ctx(),n.variantEnd)return l.empty();const i=this.board.get(t);if(!i||i.color!==this.turn)return l.empty();let r,o;if(i.role==="pawn"){r=Ee(this.turn,t).intersect(this.board[M(this.turn)]);const s=this.turn==="white"?8:-8,c=t+s;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const h=this.turn==="white"?t<16:t>=48,a=c+s;h&&!this.board.occupied.has(a)&&(r=r.with(a))}p(this.epSquare)&&qn(this,t,n)&&(o=l.fromSquare(this.epSquare))}else i.role==="bishop"?r=we(t,this.board.occupied):i.role==="knight"?r=Ot(t):i.role==="rook"?r=be(t,this.board.occupied):i.role==="queen"?r=Ln(t,this.board.occupied):r=xt(t);if(r=r.diff(this.board[this.turn]),p(n.king)){if(i.role==="king"){const s=this.board.occupied.without(t);for(const c of r)this.kingAttackers(c,M(this.turn),s).nonEmpty()&&(r=r.without(c));return r.union(ft(this,"a",n)).union(ft(this,"h",n))}if(n.checkers.nonEmpty()){const s=n.checkers.singleSquare();if(!p(s))return l.empty();r=r.intersect(ae(s,n.king).with(s))}n.blockers.has(t)&&(r=r.intersect(Tt(t,n.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[M(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(l.darkSquares())||!this.board.bishop.intersects(l.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,n;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Hn(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Z.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,n){if(De(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&l.backranks().has(t.to)?!1:this.dropDests(n).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&l.backranks().has(t.to)))return!1;const i=this.dests(t.from,n);return i.has(t.to)||i.has(jn(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return p(t)&&this.kingAttackers(t,M(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const n=this.variantOutcome(t);return n||(t=t||this.ctx(),this.isCheckmate(t)?{winner:M(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const n=new Map;if(t.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,t));return n}play(t){const n=this.turn,i=this.epSquare,r=Dt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=M(n),De(t))this.board.set(t.to,{role:t.role,color:n}),this.pockets&&this.pockets[n][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===i&&(s=this.board.take(t.to+(n==="white"?-8:8)));const c=t.from-t.to;Math.abs(c)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(r){const c=this.castles.rook[n][r];if(p(c)){const h=this.board.take(c);this.board.set(Ve(n,r),o),h&&this.board.set(Ue(n,r),h)}}this.castles.discardColor(n)}if(!r){const c=this.board.set(t.to,o)||s;c&&this.playCaptureAt(t.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class Wn extends Bn{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}}const Fn=(e,t)=>{if(!p(t))return;const n=e.turn==="white"?5:2,i=e.turn==="white"?8:-8;if(ue(t)!==n||e.board.occupied.has(t+i))return;const r=t-i;if(!(!e.board.pawn.has(r)||!e.board[M(e.turn)].has(r)))return t},Hn=e=>{if(!p(e.epSquare))return;const t=e.ctx(),i=e.board.pieces(e.turn,"pawn").intersect(Ee(M(e.turn),e.epSquare));for(const r of i)if(e.dests(r,t).has(e.epSquare))return e.epSquare},qn=(e,t,n)=>{if(!p(e.epSquare)||!Ee(e.turn,t).has(e.epSquare))return!1;if(!p(n.king))return!0;const i=e.turn==="white"?8:-8,r=e.epSquare-i;return e.kingAttackers(n.king,M(e.turn),e.board.occupied.toggle(t).toggle(r).with(e.epSquare)).without(r).isEmpty()},ft=(e,t,n)=>{if(!p(n.king)||n.checkers.nonEmpty())return l.empty();const i=e.castles.rook[e.turn][t];if(!p(i)||e.castles.path[e.turn][t].intersects(e.board.occupied))return l.empty();const r=Ve(e.turn,t),o=ae(n.king,r),s=e.board.occupied.without(n.king);for(const a of o)if(e.kingAttackers(a,M(e.turn),s).nonEmpty())return l.empty();const c=Ue(e.turn,t),h=e.board.occupied.toggle(n.king).toggle(i).toggle(c);return e.kingAttackers(r,M(e.turn),h).nonEmpty()?l.empty():l.fromSquare(i)},Dt=(e,t)=>{if(De(t))return;const n=t.to-t.from;if(!(Math.abs(n)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return n>0?"h":"a"},jn=(e,t)=>{const n=Dt(e,t);if(!n)return t;const i=e.castles.rook[e.turn][n];return{from:t.from,to:p(i)?i:t.to}},Gn=["white","black"],Qe=["a","b","c","d","e","f","g","h"],Ze=["1","2","3","4","5","6","7","8"],Vn=[...Ze].reverse(),Ye=Array.prototype.concat(...Qe.map(e=>Ze.map(t=>e+t))),D=e=>Ye[8*e[0]+e[1]],k=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Nt=Ye.map(k);function Un(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const Qn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Xe=e=>e==="white"?"black":"white",he=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},Fe=(e,t)=>e.role===t.role&&e.color===t.color,de=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],_=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Kt=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},Je=(e,t)=>{e.style.visibility=t?"visible":"hidden"},X=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},$t=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},B=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function _t(e,t,n){const i=k(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const Y=(e,t)=>Math.abs(e-t),Zn=e=>(t,n,i,r)=>Y(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),zt=(e,t,n,i)=>{const r=Y(e,n),o=Y(t,i);return r===1&&o===2||r===2&&o===1},Lt=(e,t,n,i)=>Y(e,n)===Y(t,i),It=(e,t,n,i)=>e===n||t===i,Bt=(e,t,n,i)=>Lt(e,t,n,i)||It(e,t,n,i),Yn=(e,t,n)=>(i,r,o,s)=>Y(i,o)<2&&Y(r,s)<2||n&&r===s&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function Xn(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(k(r)[0]);return i}function Wt(e,t,n){const i=e.get(t);if(!i)return[];const r=k(t),o=i.role,s=o==="pawn"?Zn(i.color):o==="knight"?zt:o==="bishop"?Lt:o==="rook"?It:o==="queen"?Bt:Yn(i.color,Xn(e,i.color),n);return Nt.filter(c=>(r[0]!==c[0]||r[1]!==c[1])&&s(r[0],r[1],c[0],c[1])).map(D)}function S(e,...t){e&&setTimeout(()=>e(...t),1)}function Jn(e){e.orientation=Xe(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function ei(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function ti(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function ni(e,t,n,i){G(e),e.premovable.current=[t,n],S(e.premovable.events.set,t,n,i)}function j(e){e.premovable.current&&(e.premovable.current=void 0,S(e.premovable.events.unset))}function ii(e,t,n){j(e),e.predroppable.current={role:t,key:n},S(e.predroppable.events.set,t,n)}function G(e){const t=e.predroppable;t.current&&(t.current=void 0,S(t.events.unset))}function ri(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=k(t),o=k(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=D([7,o[1]]):o[0]===2&&(n=D([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(D([6,o[1]]),i),e.pieces.set(D([5,o[1]]),s)):(e.pieces.set(D([2,o[1]]),i),e.pieces.set(D([3,o[1]]),s)),!0)}function Ft(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&N(e),S(e.events.move,t,n,o),ri(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,S(e.events.change),o||!0}function et(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return S(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,S(e.events.change),e.movable.dests=void 0,e.turnColor=Xe(e.turnColor),!0}function Ht(e,t,n){const i=Ft(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=Xe(e.turnColor),e.animation.current=void 0),i}function qt(e,t,n){if(tt(e,t,n)){const i=Ht(e,t,n);if(i){const r=e.hold.stop();N(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),S(e.movable.events.after,t,n,o),!0}}else if(si(e,t,n))return ni(e,t,n,{ctrlKey:e.stats.ctrlKey}),N(e),!0;return N(e),!1}function jt(e,t,n,i){const r=e.pieces.get(t);r&&(oi(e,t,n)||i)?(e.pieces.delete(t),et(e,r,n,i),S(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&ci(e,t,n)?ii(e,r.role,n):(j(e),G(e)),e.pieces.delete(t),N(e)}function He(e,t,n){if(S(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){N(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&qt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Vt(e,t)||nt(e,t))&&(Gt(e,t),e.hold.start())}function Gt(e,t){e.selected=t,nt(e,t)?e.premovable.customDests||(e.premovable.dests=Wt(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function N(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Vt(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const tt=(e,t,n)=>{var i,r;return t!==n&&Vt(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function oi(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function nt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function si(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:Wt(e.pieces,t,e.premovable.castle);return t!==n&&nt(e,t)&&o.includes(n)}function ci(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function li(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function ai(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(tt(e,n,i)){const o=Ht(e,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),S(e.movable.events.after,n,i,s),r=!0}}return j(e),r}function hi(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};et(e,r,n.key)&&(S(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return G(e),i}function it(e){j(e),G(e),N(e)}function pt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,it(e)}function J(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?D([i,r]):void 0}function ui(e,t,n,i){const r=k(e),o=Nt.filter(a=>Bt(r[0],r[1],a[0],a[1])||zt(r[0],r[1],a[0],a[1])),c=o.map(a=>_t(D(a),n,i)).map(a=>he(t,a)),[,h]=c.reduce((a,d,u)=>a[0]<d?a:[d,u],[c[0],0]);return D(o[h])}const x=e=>e.orientation==="white",Ut="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",di={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},fi={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Qt(e){e==="start"&&(e=Ut);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(D([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();t.set(D([i,n]),{role:di[s],color:r===s?"black":"white"}),++i}}}return t}function pi(e){return Vn.map(t=>Qe.map(n=>{const i=e.get(n+t);if(i){let r=fi[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Zt(e,t){t.animation&&(rt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Yt(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),rt(e,t),t.fen&&(e.pieces=Qt(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&ti(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Gt(e,e.selected),Zt(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,c=e.movable.dests.get(s),h=e.pieces.get(s);if(!c||!h||h.role!=="king")return;e.movable.dests.set(s,c.filter(a=>!(a==="a"+o&&c.includes("c"+o))&&!(a==="h"+o&&c.includes("g"+o))))}}function rt(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&mt(e[n])&&mt(t[n])?rt(e[n],t[n]):e[n]=t[n])}function mt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const U=(e,t)=>t.animation.enabled?wi(e,t):W(e,t);function W(e,t){const n=e(t);return t.dom.redraw(),n}const xe=(e,t)=>({key:e,pos:k(e),piece:t}),mi=(e,t)=>t.sort((n,i)=>he(e.pos,n.pos)-he(e.pos,i.pos))[0];function gi(e,t){const n=new Map,i=[],r=new Map,o=[],s=[],c=new Map;let h,a,d;for(const[u,b]of e)c.set(u,xe(u,b));for(const u of Ye)h=t.pieces.get(u),a=c.get(u),h?a?Fe(h,a.piece)||(o.push(a),s.push(xe(u,h))):s.push(xe(u,h)):a&&o.push(a);for(const u of s)a=mi(u,o.filter(b=>Fe(u.piece,b.piece))),a&&(d=[a.pos[0]-u.pos[0],a.pos[1]-u.pos[1]],n.set(u.key,d.concat(d)),i.push(a.key));for(const u of o)i.includes(u.key)||r.set(u.key,u.piece);return{anims:n,fadings:r}}function Xt(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=bi(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Xt(e,o))}}function wi(e,t){const n=new Map(t.pieces),i=e(t),r=gi(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||Xt(t,performance.now())}else t.dom.redraw();return i}const bi=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,ki=["green","red","blue","yellow"];function vi(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?N(e):it(e);const n=X(t),i=J(n,x(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:Ei(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Jt(e))}function Jt(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=J(t.pos,x(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?ui(t.orig,t.pos,x(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),Jt(e)}})}function yi(e,t){e.drawable.current&&(e.drawable.current.pos=X(t))}function Ci(e){const t=e.drawable.current;t&&(t.mouseSq&&Mi(e.drawable,t),en(e))}function en(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Pi(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),tn(e.drawable))}function Ei(e){var t;const n=(e.shiftKey||e.ctrlKey)&&$t(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return ki[(n?1:0)+(i?2:0)]}function Mi(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),tn(e)}function tn(e){e.onChange&&e.onChange(e.shapes)}function Ai(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=X(t),r=J(i,x(e),n);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Pi(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Ri(e,i)))t.preventDefault();else if(t.touches)return;const c=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&tt(e,e.selected,r)?U(u=>He(u,r),e):He(e,r);const a=e.selected===r,d=rn(e,r);if(o&&d&&a&&li(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:d,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},d.cgDragging=!0,d.classList.add("dragging");const u=e.dom.elements.ghost;u&&(u.className=`ghost ${o.color} ${o.role}`,_(u,de(n)(k(r),x(e))),Je(u,!0)),ot(e)}else c&&j(e),h&&G(e);e.dom.redraw()}function Ri(e,t){const n=x(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const s=_t(o,n,i);if(he(s,t)<=r)return!0}return!1}function Si(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=X(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>rn(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},ot(e)}function ot(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!Fe(i,n.piece))ke(e);else if(!n.started&&he(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();_(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==J(n.pos,x(e),r))}ot(e)})}function xi(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=X(t))}function Oi(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}j(e),G(e);const i=X(t)||n.pos,r=J(i,x(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?jt(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,qt(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),S(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?N(e):e.selectable.enabled||N(e),nn(e),e.draggable.current=void 0,e.dom.redraw()}function ke(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,N(e),nn(e),e.dom.redraw())}function nn(e){const t=e.dom.elements;t.ghost&&Je(t.ghost,!1)}function rn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Ti(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{gt(e,2),setTimeout(()=>gt(e,void 0),120)},120)}function gt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Di(e,t){function n(){Jn(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),Zt(e,i),(i.fen?U:W)(r=>Yt(r,i),e)},state:e,getFen:()=>pi(e.pieces),toggleOrientation:n,setPieces(i){U(r=>ei(r,i),e)},selectSquare(i,r){i?U(o=>He(o,i,r),e):e.selected&&(N(e),e.dom.redraw())},move(i,r){U(o=>Ft(o,i,r),e)},newPiece(i,r){U(o=>et(o,i,r),e)},playPremove(){if(e.premovable.current){if(U(ai,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=hi(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){W(j,e)},cancelPredrop(){W(G,e)},cancelMove(){W(i=>{it(i),ke(i)},e)},stop(){W(i=>{pt(i),ke(i)},e)},explode(i){Ti(e,i)},setAutoShapes(i){W(r=>r.drawable.autoShapes=i,e)},setShapes(i){W(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return J(i,x(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){Si(e,i,r,o)},destroy(){pt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ni(){return{pieces:Qt(Ut),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Qn()}}const wt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Ki(){const e=C("defs"),t=A(C("filter"),{id:"cg-filter-blur"});return t.appendChild(A(C("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function $i(e,t,n){var i;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,c=new Map,h=e.dom.bounds(),a=r.autoShapes.filter(g=>!g.piece);for(const g of r.shapes.concat(a).concat(s?[s]:[])){if(!g.dest)continue;const w=(i=c.get(g.dest))!==null&&i!==void 0?i:new Set,f=Ce(ye(k(g.orig),e.orientation),h),O=Ce(ye(k(g.dest),e.orientation),h);w.add(je(f,O)),c.set(g.dest,w)}const d=r.shapes.concat(a).map(g=>({shape:g,current:!1,hash:bt(g,qe(g.dest,c),!1,h)}));s&&d.push({shape:s,current:!0,hash:bt(s,qe(s.dest,c),!0,h)});const u=d.map(g=>g.hash).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const b=t.querySelector("defs");_i(r,d,b),zi(d,t.querySelector("g"),n.querySelector("g"),g=>Bi(e,g,r.brushes,c,h))}function _i(e,t,n){var i;const r=new Map;let o;for(const h of t.filter(a=>a.shape.dest&&a.shape.brush))o=on(e.brushes[h.shape.brush],h.shape.modifiers),!((i=h.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(ve(o).key,ve(o)),r.set(o.key,o);const s=new Set;let c=n.firstElementChild;for(;c;)s.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(const[h,a]of r.entries())s.has(h)||n.appendChild(Hi(a))}function zi(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const s=[];let c=o.firstElementChild,h;for(;c;)h=c.getAttribute("cgHash"),r.has(h)?r.set(h,!0):s.push(c),c=c.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function bt({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:s},c,h,a){var d,u;return[a.width,a.height,h,e,t,n,c&&"-",i&&Li(i),r&&Ii(r),o&&`custom-${kt(o.html)},${(u=(d=o.center)===null||d===void 0?void 0:d[0])!==null&&u!==void 0?u:"o"}`,s&&`label-${kt(s.text)}`].filter(b=>b).join(",")}function Li(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Ii(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function kt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function Bi(e,{shape:t,current:n,hash:i},r,o,s){var c,h;const a=Ce(ye(k(t.orig),e.orientation),s),d=t.dest?Ce(ye(k(t.dest),e.orientation),s):a,u=t.brush&&on(r[t.brush],t.modifiers),b=o.get(t.dest),g=[];if(u){const w=A(C("g"),{cgHash:i});g.push({el:w}),a[0]!==d[0]||a[1]!==d[1]?w.appendChild(Fi(t,u,a,d,n,qe(t.dest,o))):w.appendChild(Wi(r[t.brush],a,n,s))}if(t.label){const w=t.label;(c=w.fill)!==null&&c!==void 0||(w.fill=t.brush&&r[t.brush].color);const f=t.brush?void 0:"tr";g.push({el:qi(w,i,a,d,b,f),isCustom:!0})}if(t.customSvg){const w=(h=t.customSvg.center)!==null&&h!==void 0?h:"orig",[f,O]=w==="label"?cn(a,d,b).map(P=>P-.5):w==="dest"?d:a,R=A(C("g"),{transform:`translate(${f},${O})`,cgHash:i});R.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,g.push({el:R,isCustom:!0})}return g}function Wi(e,t,n,i){const r=ji(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return A(C("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:sn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function ve(e){return["#ffffff","#fff","white"].includes(e.color)?wt.hilitePrimary:wt.hiliteWhite}function Fi(e,t,n,i,r,o){var s;function c(d){var u;const b=Vi(o&&!r),g=i[0]-n[0],w=i[1]-n[1],f=Math.atan2(w,g),O=Math.cos(f)*b,R=Math.sin(f)*b;return A(C("line"),{stroke:d?ve(t).color:t.color,"stroke-width":Gi(t,r)+(d?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${d?ve(t).key:t.key})`,opacity:!((u=e.modifiers)===null||u===void 0)&&u.hilite?1:sn(t,r),x1:n[0],y1:n[1],x2:i[0]-O,y2:i[1]-R})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return c(!1);const h=C("g"),a=A(C("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(Ui(n,i)),a.appendChild(c(!0)),h.appendChild(a),h.appendChild(c(!1)),h}function Hi(e){const t=A(C("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(A(C("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function qi(e,t,n,i,r,o){var s;const h=.4*.75**e.text.length,a=cn(n,i,r),d=o==="tr"?.4:0,u=A(C("g"),{transform:`translate(${a[0]+d},${a[1]-d})`,cgHash:t});u.appendChild(A(C("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const b=A(C("text"),{"font-size":h,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return b.innerHTML=e.text,u.appendChild(b),u}function ye(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function qe(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function C(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function A(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function on(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function ji(){return[3/64,4/64]}function Gi(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function sn(e,t){return(e.opacity||1)*(t?.9:1)}function Vi(e){return(e?20:10)/64}function Ce(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function Ui(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return A(C("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function je(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function Qi(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function cn(e,t,n){let i=Qi(e,t);const r=je(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=je(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function Zi(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const h of Gn)e.classList.toggle("orientation-"+h,t.orientation===h);e.classList.toggle("manipulable",!t.viewOnly);const n=B("cg-container");e.appendChild(n);const i=B("cg-board");n.appendChild(i);let r,o,s;if(t.drawable.visible&&(r=A(C("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(Ki()),r.appendChild(C("g")),o=A(C("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(C("g")),s=B("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),t.coordinates){const h=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";n.appendChild(vt(Ze,"ranks"+h+a)),n.appendChild(vt(Qe,"files"+h))}let c;return t.draggable.enabled&&t.draggable.showGhost&&(c=B("piece","ghost"),Je(c,!1),n.appendChild(c)),{board:i,container:n,wrap:e,ghost:c,svg:r,customSvg:o,autoPieces:s}}function vt(e,t){const n=B("coords",t);let i;for(const r of e)i=B("coord"),i.textContent=r,n.appendChild(i);return n}function Yi(e,t){if(!e.dropmode.active)return;j(e),G(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=X(t),r=i&&J(i,x(e),e.dom.bounds());r&&jt(e,"a0",r)}e.dom.redraw()}function Xi(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=er(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function Ji(e,t){const n=[];if("ResizeObserver"in window||n.push(se(document.body,"chessground.resize",t)),!e.viewOnly){const i=yt(e,xi,yi),r=yt(e,Oi,Ci);for(const s of["touchmove","mousemove"])n.push(se(document,s,i));for(const s of["touchend","mouseup"])n.push(se(document,s,r));const o=()=>e.dom.bounds.clear();n.push(se(document,"scroll",o,{capture:!0,passive:!0})),n.push(se(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function se(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const er=e=>t=>{e.draggable.current?ke(e):e.drawable.current?en(e):t.shiftKey||$t(t)?e.drawable.enabled&&vi(e,t):e.viewOnly||(e.dropmode.active?Yi(e,t):Ai(e,t))},yt=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function tr(e){const t=x(e),n=de(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,c=o?o.plan.fadings:new Map,h=e.draggable.current,a=ir(e),d=new Set,u=new Set,b=new Map,g=new Map;let w,f,O,R,P,V,re,T,Me,fe;for(f=i.firstChild;f;){if(w=f.cgKey,ln(f))if(O=r.get(w),P=s.get(w),V=c.get(w),R=f.cgPiece,f.cgDragging&&(!h||h.orig!==w)&&(f.classList.remove("dragging"),_(f,n(k(w),t)),f.cgDragging=!1),!V&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),O){if(P&&f.cgAnimating&&R===ce(O)){const v=k(w);v[0]+=P[2],v[1]+=P[3],f.classList.add("anim"),_(f,n(v,t))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),_(f,n(k(w),t)),e.addPieceZIndex&&(f.style.zIndex=Oe(k(w),t)));R===ce(O)&&(!V||!f.cgFading)?d.add(w):V&&R===ce(V)?(f.classList.add("fading"),f.cgFading=!0):Te(b,R,f)}else Te(b,R,f);else if(an(f)){const v=f.className;a.get(w)===v?u.add(w):Te(g,v,f)}f=f.nextSibling}for(const[v,oe]of a)if(!u.has(v)){Me=g.get(oe),fe=Me&&Me.pop();const K=n(k(v),t);if(fe)fe.cgKey=v,_(fe,K);else{const $=B("square",oe);$.cgKey=v,_($,K),i.insertBefore($,i.firstChild)}}for(const[v,oe]of r)if(P=s.get(v),!d.has(v))if(re=b.get(ce(oe)),T=re&&re.pop(),T){T.cgKey=v,T.cgFading&&(T.classList.remove("fading"),T.cgFading=!1);const K=k(v);e.addPieceZIndex&&(T.style.zIndex=Oe(K,t)),P&&(T.cgAnimating=!0,T.classList.add("anim"),K[0]+=P[2],K[1]+=P[3]),_(T,n(K,t))}else{const K=ce(oe),$=B("piece",K),pe=k(v);$.cgPiece=K,$.cgKey=v,P&&($.cgAnimating=!0,pe[0]+=P[2],pe[1]+=P[3]),_($,n(pe,t)),e.addPieceZIndex&&($.style.zIndex=Oe(pe,t)),i.appendChild($)}for(const v of b.values())Pt(e,v);for(const v of g.values())Pt(e,v)}function nr(e){const t=x(e),n=de(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(ln(i)&&!i.cgAnimating||an(i))&&_(i,n(k(i.cgKey),t)),i=i.nextSibling}function Ct(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=s*o;r.style.width=s+"px",r.style.height=c+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",c+"px")}const ln=e=>e.tagName==="PIECE",an=e=>e.tagName==="SQUARE";function Pt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Oe(e,t){const i=e[1];return`${t?10-i:3+i}`}const ce=e=>`${e.color} ${e.role}`;function ir(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const c of e.lastMove)L(r,c,"last-move");if(e.check&&e.highlight.check&&L(r,e.check,"check"),e.selected&&(L(r,e.selected,"selected"),e.movable.showDests)){const c=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(c)for(const a of c)L(r,a,"move-dest"+(e.pieces.has(a)?" oc":""));const h=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(h)for(const a of h)L(r,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const c of o)L(r,c,"current-premove");else e.predroppable.current&&L(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const c of s.keys)L(r,c,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((c,h)=>{L(r,h,c)}),r}function L(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function Te(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function rr(e,t,n){const i=new Map,r=[];for(const c of e)i.set(c.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const c of r)t.removeChild(c);for(const c of e)i.get(c.hash)||t.appendChild(n(c))}function or(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:lr(r),current:!1}));rr(i,t,r=>cr(e,r,e.dom.bounds()))}function sr(e){var t;const n=x(e),i=de(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)Kt(r,i(k(r.cgKey),n),r.cgScale),r=r.nextSibling}function cr(e,{shape:t,hash:n},i){var r,o,s;const c=t.orig,h=(r=t.piece)===null||r===void 0?void 0:r.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,d=(s=t.piece)===null||s===void 0?void 0:s.scale,u=B("piece",`${h} ${a}`);return u.setAttribute("cgHash",n),u.cgKey=c,u.cgScale=d,Kt(u,de(i)(k(c),x(e)),d),u}const lr=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function ar(e,t){const n=Ni();Yt(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=Zi(e,n),s=Un(()=>o.board.getBoundingClientRect()),c=d=>{tr(a),o.autoPieces&&or(a,o.autoPieces),!d&&o.svg&&$i(a,o.svg,o.customSvg)},h=()=>{Ct(a),nr(a),o.autoPieces&&sr(a)},a=n;return a.dom={elements:o,bounds:s,redraw:hr(c),redrawNow:c,unbind:r},a.drawable.prevSvgHash="",Ct(a),c(!1),Xi(a,h),r||(a.dom.unbind=Ji(a,h)),a.events.insert&&a.events.insert(o),a}return Di(i(),i)}function hr(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}const ur=Et('<div class="is2d chessboard">'),dr=e=>{let t,n;return dn(()=>{let i=e.color,r=e.dests,o={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:e.onMoveAfter}}};n=ar(t,o)}),fn(()=>{n.set({movable:{color:e.color,dests:e.dests}})}),(()=>{const i=ur();return pn(r=>t=r,i),i})()},fr=()=>"Chesstree",pr=(e,t)=>{const n=new Map,i=e.ctx();for(const[r,o]of e.allDests(i))if(o.nonEmpty()){const s=Array.from(o,$e);!(t!=null&&t.chess960)&&r===i.king&&H(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set($e(r),s)}return n},mr=Et("<div class=shalala><div class=chessboard-wrap></div><div class=chesstree-wrap>"),Pe=class Pe{constructor(){Ae(this,"on_move_after",(t,n)=>{let i=t+n;this.position.play(bn(i)),this.position=this.position});this._position=mn(Wn.fromSetup(An(Pn).unwrap()).unwrap(),{equals:!1}),this.m_dests=Re(()=>pr(this.position)),this.m_fen=Re(()=>Dn(this.position.toSetup())),this.m_color=Re(()=>this.position.turn)}get position(){return this._position[0]()}set position(t){this._position[1](t)}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};Ae(Pe,"init",()=>new Pe);let Ge=Pe;const br=()=>{let e=Ge.init();return(()=>{const t=mr(),n=t.firstChild,i=n.nextSibling;return st(n,ct(dr,{get onMoveAfter(){return e.on_move_after},get color(){return e.m_color()},get dests(){return e.dests}})),st(i,ct(fr,{})),t})()};export{br as default};
