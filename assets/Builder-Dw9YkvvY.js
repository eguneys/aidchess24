import{_ as Yt,H as Ae,a as E,m as bt,c as b,g as S,J as Kt,K as Qt,I as te,L as ve,N as ye,O as Xt,Q as Jt,x as oe,r as Re,n as O,b as ge,t as k,T as ct,U as dt,V as ze,W as wt,X as $t,Y as Zt,Z as en,$ as tn,d as Ke,C as Ge,q as F,i as $,S as z,j as ce,k as J,F as kt,M as H,h as Qe,v as me,a0 as nn,p as rn,a1 as ut,a2 as $e,a3 as ln,u as xt,D as xe,B as ue,o as an,a4 as _t,a5 as ft}from"./index-ZQxjbgW0.js";import{C as sn}from"./chessground-lU4YbH_i.js";import{s as on}from"./scroll-DnAhRpRC.js";import{a as cn}from"./random-BMCilaBQ.js";import{a as dn}from"./annotationShapes-B9asiTBx.js";async function un(e){const t=await _n(e);function i(a){return t.transaction(e.store,a).objectStore(e.store)}function f(a){return new Promise((c,l)=>{const n=a();n.onsuccess=s=>c(s.target.result),n.onerror=s=>l(s.target.result)})}return{list:()=>f(()=>i("readonly").getAllKeys()),get:a=>f(()=>i("readonly").get(a)),getMany:a=>f(()=>i("readonly").getAll(a)),put:(a,c)=>f(()=>i("readwrite").put(c,a)),count:a=>f(()=>i("readonly").count(a)),remove:a=>f(()=>i("readwrite").delete(a)),clear:()=>f(()=>i("readwrite").clear()),cursor:(a,c)=>f(()=>i("readonly").openCursor(a,c)).then(l=>l??void 0),txn:a=>t.transaction(e.store,a)}}async function _n(e){const t=e?.db||`${e.store}--db`;return new Promise((i,f)=>{const a=window.indexedDB.open(t,e?.version??1);a.onsuccess=c=>i(c.target.result),a.onerror=c=>f(c.target.error??"IndexedDB Unavailable"),a.onupgradeneeded=c=>{const l=c.target.result,n=c.target.transaction,s=l.objectStoreNames.contains(e.store)?n.objectStore(e.store):l.createObjectStore(e.store);e.upgrade?.(c,s)}})}async function fn(e){let t;await pn({on_received:c,on_status(v){v&&(v.download&&e.on_downloaded_nb(v.download),v.error&&e.on_engine_failed(v.error))},on_connected(v){t=v}}),i("uci");function i(v){t?.(v)}function f(v){s=v,_()}function a(){return!!n&&!n.stop_requested&&!n.swap_requested}function c(v){const y=v.trim().split(/\s+/g);if(y[0]==="uciok")i("ucinewgame"),i("isready");else if(y[0]==="readyok")h();else if(!(y[0]==="id"&&y[1]==="name"))if(y[0]==="bestmove"){n&&g&&n.emit(g),n=void 0,h();return}else if(n&&!n.swap_requested&&!n.stop_requested&&y[0]==="info"){let m=0,x,M=1,A,D,I=!1,G,Q=[];for(let P=1;P<y.length;P++)switch(y[P]){case"depth":m=parseInt(y[++P]);break;case"nodes":x=parseInt(y[++P]);break;case"multipv":M=parseInt(y[++P]);break;case"time":A=parseInt(y[++P]);break;case"score":I=y[++P]==="mate",G=parseInt(y[++P]),(y[P+1]==="lowerbound"||y[P+1]==="upperbound")&&(D=y[++P]);break;case"pv":Q=y.slice(++P),P=y.length;break}if(I&&!G||(l<M&&(l=M),!Ae(x)||!Ae(A)||!Ae(I)||!Ae(G)))return;const B=n.ply%2===1?-G:G;if(D&&M===1)return;const Z={moves:Q,cp:I?void 0:B,mate:I?B:void 0,depth:m};M===1?g={fen:n.current_fen,depth:m,nodes:x,millis:A,cp:I?void 0:B,mate:I?B:void 0,pvs:[Z]}:g&&(g.pvs.push(Z),g.depth=Math.min(g.depth,m)),M===l&&g&&(n.on_pvs(g),m>=40&&o())}else v&&!["Stockfish","id","option","info"].includes(y[0])&&console.warn(`SF: ${v}`)}let l=0,n,s,g;function h(){if(!n&&(n=s,s=void 0,n)){g=void 0,l=1,r("Threads",n.threads),r("Hash",n.hash_size||16),r("MultiPV",Math.max(1,n.multi_pv)),u&&u!==n.game_id&&i("ucinewgame"),u=n.game_id,i(["position fen",n.initial_fen,"moves",n.moves].join(" "));const[v,y]=Object.entries(n.search)[0];i(`go ${v} ${y}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function r(v,y){y=y.toString(),d.get(v)!==y&&(i(`setoption name ${v} value ${y}`),d.set(v,y))}function o(){n&&!n.stop_requested&&(n.stop_requested=!0,i("stop"))}function _(){n&&!n.swap_requested&&(n.swap_requested=!0,i("stop")),i("isready")}let u;return{start(v){f(v)},stop(){f()},destroy(){i("quit")},get state(){return a()?"computing":"idle"}}}async function pn(e){const t=d=>{e.on_status(d)},i=d=>{e.on_received(d)},f=d=>{e.on_connected(d)};let a=await Yt(()=>import("./sf17-79-Kk0KEig0.js"),[]),c=await new Promise((d,r)=>{a.default({wasmMemory:hn(2560),onError:o=>r(new Error(o)),locateFile:o=>`stockfish/${o}`}).then(d).catch(r)}),l=await un({store:".aidchess.nnue"}).catch(()=>{}),n=[];for(let d=0;;d++){let r=c.getRecommendedNnue(d);if(!r||n.includes(r))break;n.push(r)}(await g(n)).forEach((d,r)=>c.setNnueBuffer(d,r)),c.onError=h(),c.listen=d=>i(d),f(d=>c.uci(d));async function g(d){return Promise.all(d.map(async r=>{let o=await l?.get(r).catch(()=>{});if(o&&o.byteLength>128*1024)return o;const _=new XMLHttpRequest;_.open("get",`stockfish/nnue/${r}`,!0),_.responseType="arraybuffer",_.onprogress=v=>t({download:{bytes:v.loaded,total:v.total}});const u=await new Promise((v,y)=>{_.onerror=()=>y(new Error(`fetch '${r}' failed: ${_.status}`)),_.onload=()=>{_.status/100===2?v(new Uint8Array(_.response)):y(new Error(`fetch '${r}' failed: ${_.status}`))},_.send()});return t(),l?.put(r,u).catch(()=>console.warn("IDB store failed")),u}))}function h(){return d=>{if(d.startsWith("BAD_NNUE")&&l){const r=Math.max(0,Number(d.slice(9))),o=c.getRecommendedNnue(r);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${o} from IDB`),l.remove(o)},2e3)}else t({error:d})}}}const hn=(e,t=32767)=>{let i=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:t})}catch(f){if(t<=e||!(f instanceof RangeError))throw f;t=Math.max(e,Math.ceil(t-t/i)),i=i===4?3:4}},Xe=Kt();function gn(e){let[t,i]=E(void 0),[f,a]=E(void 0),[c]=bt(()=>fn({on_downloaded_nb(h){i(h)},on_engine_failed(h){a(h)}}));function l(h,d,r,o,_,u,v,y){let m=c();if(!m)return u(),()=>{};let x=Math.max(1,navigator.hardwareConcurrency-2);m.start({threads:x,hash_size:256,game_id:h,stop_requested:!1,swap_requested:!1,path:[],search:{depth:_},multi_pv:o,ply:r,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(A){y(A)},on_pvs:Qt(200,function(A){v(A)})})}let n={};function s(h,d,r,o,_,u,v,y){let m=[d,o,_].join("$$"),M=(()=>{let D=_===8?[20,8]:[20],I=o===1?[6,1]:[6];return D.flatMap(G=>I.map(Q=>[d,Q,G].join("$$")))})().find(D=>n[D]);M?y(n[M]):l(h,d,r,o,_,u,v,A);function A(D){n[m]=D,y(D)}}let g={get download_nb(){return t()},get engine_failed(){return f()},get state(){let h=c();return c.loading||!h?"loading":h.state},best_move_with_cache:s,stop(){c()?.stop()}};return b(Xe.Provider,{value:g,get children(){return S(()=>e.children)}})}const Ne={equals:!1};function se(e,t,i){let f=!1,a=!0;const[c,l]=E(void 0,Ne),n=S(o=>f?e(o):(a=!c(),o),t,Ne);let[s,g]=E(void 0,Ne),h;return[()=>(f=!0,a&&(a=l()),h=n(),f=!1,g(),h),()=>{if(s(),h)return h}]}var mn=k('<div class="is2d chessboard">');function vn(){let[e,t]=E(te),[i,f]=E(void 0),[a,c]=E(void 0),l=S(()=>ve.fromSetup(ye(e()).unwrap()).unwrap()),n=S(()=>l().turn),s=S(()=>Xt(l()));const g=d=>{let r=l(),o=ct(d),_=dt(r,o);r.play(o),oe(()=>{f([d,_]),c([d,_]),t(ze(r.toSetup())),d.length})},h=d=>{if(!d){f(void 0);return}let r=dt(l(),ct(d));f([d,r])};return{play_orig_key(d,r){let o=l(),_=n(),u=o.board.get(Jt(d)),v=d+r;u.role==="pawn"&&(r[1]==="8"&&_==="white"||r[1]==="1"&&_==="black")&&(v+="q"),g(v)},play_uci:g,set_fen_and_last_move(d,r){oe(()=>{h(r),t(d)})},set_fen(d){t(d)},set_last_move(d){h(d)},get dests(){return s()},get fen(){return e()},get last_move(){return i()},get on_last_move_added(){return a()},get check(){return l().isCheck()}}}function yn(e){let t,i;return Re(()=>{let f=e.color,a=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:f,free:!1,dests:a,events:{after:e.play_uci.play_orig_key}}};i=sn(t,c)}),O(()=>{let f;if(e.play_uci.last_move){let[a]=e.play_uci.last_move;f=[a.slice(0,2),a.slice(2,4)]}i.set({lastMove:f,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),O(()=>{i.setAutoShapes(e.shapes??[])}),(()=>{var f=mn();return ge(a=>t=a,f),f})()}function St(e,t,i,f){let a=wt(t,i),c=$t(a),l=ze(t.toSetup());t.play(a);let n=ze(t.toSetup());return{path:f.length===0?c:`${f} ${c}`,ply:e,before_fen:l,fen:n,uci:c,san:i}}function Ct(e,t,i){let f=t[t.length-1];return i||(i=ve.fromSetup(ye(f?.fen??te).unwrap()).unwrap()),[...t,St((f?.ply??0)+1,i,e,f?.path??"")]}function pt(e,t=te){let i=[],f=ve.fromSetup(ye(t).unwrap()).unwrap();for(let a of e)i=Ct(a,i,f);return i}function Oe(e,t){return[...e,...t]}function bn(e){let t=2,i=0,f=e[0];for(;t<=e.length-1&&i<2;)f===e[t]&&(i+=1),t+=2;return i===2}function Be(e){return wn(e)^$n(e)^kn(e)^xn(e)}function wn(e){let t=0;return Zt.forEach(i=>{let f=e.board[i],a=Sn[i];en.forEach(c=>{let l=e.board[c],n=a[c];for(let s of f.intersect(l))t^=n[s]})}),t}function $n(e){return e.turn==="white"?Cn:0}function kn(e){let t=0;return e.castles.rook.white.a!==void 0&&(t^=Pe.white[0]),e.castles.rook.white.h!==void 0&&(t^=Pe.white[1]),e.castles.rook.black.a!==void 0&&(t^=Pe.black[0]),e.castles.rook.black.h!==void 0&&(t^=Pe.black[1]),t}function xn(e){return e.epSquare!==void 0?Mn[tn(e.epSquare)]:0}let Sn={black:{pawn:Array(2637767806,720845184,1155203408,2618685246,1971536997,848342074,263957791,3896152207,226391645,436746274,2516964848,3491888988,1086189917,18044180,1572111136,597658413,97624494,1738507407,1950989311,2098318769,2194108574,4079062812,856979699,1270058469,2858720366,2378012835,2278688587,435406673,3031118064,2063925420,3376753832,615148625,1285502018,346460119,2803604355,55085973,1669016372,164740250,896886403,1935551383,410153072,533441746,3541084098,3214426080,2675233103,1374411850,1552073989,4244110986,844343081,2356462440,3116133511,2129956651,299173332,1701379241,1306570996,2530644806,1122123979,1831591130,1116211970,1594837592,972591349,2479207924,1675376029,3960916618),knight:Array(1447259295,4021046128,3139524504,1173487682,2467266804,4284945151,2925674454,3710671816,2129465869,587093076,3373793513,2156648078,3737413652,468575139,1129551363,2861996892,2826449619,1704209531,3738359347,569410928,3021312909,2444777957,282063667,682545472,3318488457,1447622272,757420137,2613420942,4012836163,2938127093,1208226490,2935205706,430957978,1381578755,4109399782,288855589,3169178148,2644780093,107966643,1304747544,1359190711,3229237120,3027167685,3011615298,564135827,770797430,1983662611,4153656423,3609759233,3727911466,200708787,744508026,1213261630,3485747185,2958861301,2598470344,2767997908,3881113485,1773764017,4189435844,4234838742,2624081078,2395569449,1728307101),bishop:Array(2140891889,1482849818,751922730,3546542069,216179596,444615341,2424254530,1344234989,929188581,2507911009,980166547,3566535507,143525013,4181962471,1815842366,911175674,3591335374,1452686093,385158879,4011414929,1448477120,3971299641,3133647265,3007628400,1708345684,3031964479,3022128657,118850112,2048127371,3158349745,1505327237,2568424029,1866609495,844703982,3504617058,1448882679,821387540,3631471417,2077838877,3352949096,2491080787,3368630402,983299419,3651215291,265429091,3019003608,2955948456,903690197,3925215275,3959093811,2455088053,3115011301,1765081558,3324795129,3443871631,3152559950,3699649406,3129545774,2747044893,3925243406,164095314,2234471571,2164784335,159995093),rook:Array(3661248027,3705503008,914567990,3462935583,2878378006,1133857586,3023618742,282908558,3686955701,2604456805,3061545110,3218002352,2836503392,536836808,2886925079,2936593041,453815187,3042568989,3279635891,3282689058,4088968807,2680453086,1731693966,1842894553,2736377365,121205621,2324595870,3784465521,1958759409,1306150933,2636541290,1950415745,322077955,3602873262,1211684447,504701736,2407799203,1925743434,3617596327,2498480299,2680229135,3731399221,2756509305,2635957500,1372762539,802677945,1707760534,3714687192,1615679922,1940556374,445390489,2864974375,1984806574,513390958,744398315,982749166,652663695,1184061125,3363191899,1064069880,2138882964,2616926846,2298715513,2414381911),queen:Array(2065276,410498334,2726640512,2570984935,3008987264,623860175,3527183895,467272850,568376656,990477018,2366955227,4183621538,946958343,3395758993,1690887473,605184237,275515833,2142902612,2021972412,105373677,1666662384,1338566998,498685668,3101233780,2733370951,3656512268,4025308119,778896067,2846510368,3058428120,1892379383,2565895844,3213117192,2495816991,1040203361,3106252493,1639829808,3213709576,604681594,4236730699,4009938384,2701667332,2182473079,3550198211,657991062,1640976276,460041378,1972323596,2510248061,2959337826,1625877874,2070189957,4245163299,2358312347,275739390,2037777210,2766930226,1933485829,3034118011,2653025529,2641780289,3540781195,1569993599,441337890),king:Array(588133437,1139638106,982032635,562514827,467575086,1405117894,3813285157,3601878331,1586505598,738488098,2970334297,1068097019,235518094,283685722,2666392744,3569817788,2169728352,2444571896,3967907832,420376911,3046293305,2311278792,2885955184,3030078181,4212469731,1046900335,995380926,3892683234,615726237,3880203074,176180504,1474506861,1256707747,764236850,3521530334,2318567964,128167623,2220129756,2567608573,441446694,4143447316,817912603,2368091832,1187643061,3438021235,1318922279,434876457,1180291767,2520707785,1962430872,1510954061,57831539,3354831405,891783098,2555636406,2881342935,3473267445,1238029452,2051805420,3655936674,330209165,1929681327,1313566811,4283920930)},white:{pawn:Array(1398143232,133930885,1351827834,2076951437,435980918,1668970368,2185864314,2041407829,346864372,4047877822,3669961416,616810829,3144558884,216165387,2761740594,3919406634,669429112,2234904640,1421079802,1924213810,4002762044,2592451728,1890340057,4189625662,2276713138,2741429688,2924122950,421576781,2277442246,153237420,4278711886,2380848297,2618700582,3018992701,957243316,1543415220,504378001,2591337657,1333852064,1661259930,561112646,1536910315,1349168372,411152329,1694697476,3755185459,4019355068,2066937809,3120395808,94890149,3045629038,1249184265,3477490924,4114113436,1014604031,3991324799,2040431088,2253613964,2547464012,2722521980,71289574,2450408597,1894451515,1939968537),knight:Array(3309827454,2028172868,4271523049,146617804,2467685867,2483428231,3743260573,1002067894,3535252974,4154611160,3623154244,3646679180,862933752,2806008282,2734037942,1328176304,2278785213,381286368,2074232908,4087773386,967884669,4239349185,419231360,1275421624,1088456595,2365565249,1758083333,2048846183,2635948261,940630937,839474029,902477345,2836079689,2007115168,1363041891,1130479818,3644959908,1385135238,1386975934,2635987502,1915744629,487743653,2049219159,69242857,1511066720,215590039,1459430344,676103291,83799035,1949179493,2593534694,2283504289,1349412676,2954378677,249149717,1578231917,4135085182,461755528,3669622373,219487622,2825233742,2479105382,2582097898,1221328648),bishop:Array(599199451,3274759746,1192619331,2832721114,91404660,3044880024,3906596030,803516785,288455592,2143232492,388352703,2521731420,1043041227,3195290851,4166724431,1228226538,500177583,533367442,4236023256,413575568,3435884549,1004255532,2859513268,3914086821,3080761716,3571165255,773372954,769693293,3116440923,1687629160,2489486648,3686847158,3530767427,2121652637,1827477891,2549918411,2071415163,2236083679,2040110303,3489536313,2190878435,2465915458,1675766804,3329799896,1483966600,159505618,2674227354,2683539437,3833196123,3891433165,1455453349,1430583255,2067726741,303380021,2136024795,2054591852,1029141665,2317027384,2068461795,2499875684,1302894490,1002663431,1560941298,2141002286),rook:Array(2694745228,4202576185,3602305260,3756663274,3061587876,3390977925,486312941,3515712841,1322319486,3839619171,392296762,1401523788,1934485528,645968162,696971825,2038689491,1723966113,2652365974,3988018407,1354171594,1287854075,1723106141,563845090,639520332,534957223,3612364282,3109494688,500957989,3477030536,4109750364,951472732,922095147,3946156928,2622281253,2936811901,630086272,2340986210,4107355543,3560210278,3868847493,611513888,3265390517,2874106961,1668707698,2778598353,292356118,754567370,185141877,2884558258,1492107531,3336927864,782994598,346133860,2080909533,3612065399,2151962287,3957975594,52533817,1232633839,2716413964,1531307298,3030137657,3561556693,313061910),queen:Array(1878946792,3724105660,1691411102,148741087,142506469,3811107376,472209891,1913386482,2960608550,1145005292,1091751784,3625186042,1712140887,1504455800,3896940088,2478191531,3233871270,3404865229,1462204167,1349259705,3627860584,1244251718,3979211282,3043187861,581894202,1390895705,2599134010,2488233440,1816641224,1792034756,2779893723,2084952115,1351806869,2469979804,1163545420,1795352113,1796715044,3521170642,3725363621,1342594643,2618386938,2028859350,1841905045,4002935891,850071259,979915719,830889197,1744763229,522919199,3063822504,2861636095,4097602344,4215946617,894485042,924809191,1811585710,3439653887,3810997538,2677100683,77233985,4239834691,148802076,2409138150,3048474397),king:Array(1438004300,3093439067,3401620219,3673745794,3053321309,822915968,3900685126,553823814,4166295066,128359165,3300989119,4193552686,452189154,4122259632,2519387887,74333898,4032631446,2521268686,2620314688,1378755571,394133753,734399075,573292462,1214417373,2110224475,2331215665,531326186,3839443603,2644531398,616620850,590349237,3582377217,1582708616,2126148205,173450736,3616831144,2655785577,401600069,496349349,2479612086,1710903074,3589924952,3266682943,1496318498,3459221058,2091479615,663040899,3323704225,353318429,2674540957,1688550857,338551967,204689992,178008789,3871613304,1911672356,4055679954,3878217928,2533095482,2174833823,1604814460,1452830254,2441027029,3524103304)}},Cn=4174784170,Pe={black:Array(2776523577,519497435),white:Array(836181454,4049974663)},Mn=Array(1892447193,3793382197,3838936,479846099,3476112862,3504620154,2009473484,1738755500);var En=k("<div class=replay-single><div class=moves></div><div class=filler></div><div class=sharpness><span class=label>Sharpness:</span> "),An=k("<span class=index>"),Pn=k("<span><span class=san>"),Rn=k('<span class="word safe">Safe <small>(+5 moves maintains eval)'),Tn=k('<span class="word playable">Playable <small>(3-4 moves maintains eval)'),Ln=k('<span class="word sharp">Sharp <small>(2 moves maintains eval)'),qn=k('<span class="word critical">Critical <small>(Only 1 move maintains eval)'),ht=k("<span class=eval>"),gt=k("<span class=loading>."),Dn=k("<span class=judgement>");function he(e){return ve.fromSetup(ye(e).unwrap()).unwrap()}function jn(){let[e,t]=E([]),[i,f]=E([]);const a=S(()=>{let m=i();return m[m.length-1]});let[c,l]=E(a()?.ply??0);const n=S(()=>{let m=c();return i().find(M=>M.ply===m)});let s=S(Ge(i,m=>m.san)),g=S(Ge(i,m=>m.ply)),h=S(()=>{let m=s(),x=g();return m.map((M,A)=>`${x[A]} ${M}`)});const d=m=>{l(m)},r=()=>{let m=c()-1;return g().find(x=>x===m)},o=()=>{let m=c()+1;return g().find(x=>x===m)},_=S(()=>bn(e())),u=S(()=>{let m=a();return m?he(m.fen).isStalemate():!1}),v=S(()=>{let m=a();return m?he(m.fen).isCheckmate():!1}),y=S(()=>{let m=a();return m?he(m.fen).isInsufficientMaterial():!1});return{set_sans(m){f(pt(m)),l(m.length);let x=i();t(x.reduce((M,A)=>Oe([Be(he(A.fen))],M),[]))},get steps(){return i()},get steps_up_to_ply(){return i().slice(0,c())},get plies(){return g()},get sans(){return s()},get ply_sans(){return h()},get ply_step(){return n()},get last_step(){return a()},get ply(){return c()},goto_ply:d,get_prev_ply:r,get_next_ply:o,goto_prev_ply_if_can(){let m=r();m!==void 0&&d(m),c()===1&&l(0)},goto_next_ply_if_can(){let m=o();m!==void 0&&d(m)},play_san(m){let x=a();if(!x){f(pt([m]));let A=i();t(A.reduce((D,I)=>Oe([Be(he(I.fen))],D),[])),l(a().ply);return}let M=i();f(Ct(m,M)),x=a(),t(Oe([Be(he(x.fen))],e())),l(x.ply)},get is_on_last_ply(){return c()===(a()?.ply??0)},get is_threefold(){return _()},get is_checkmate(){return v()},get is_stalemate(){return u()},get is_insufficient(){return y()}}}function In(e){const t=S(Ge(()=>e.play_replay.ply_sans,l=>{let[n,s]=l.split(" ");return{ply:parseInt(n),san:s}})),i=l=>{e.play_replay.goto_ply(l)},f=S(()=>e.play_replay.ply_step?.ply);O(F(()=>e.play_replay.steps,l=>e.steps_stockfish.set_steps(l)));let a;const c=l=>{let n=e.steps_stockfish.steps_with_stockfish[l];if(!n)return"";let s=n.d20pv6[1](),g=n.d20pv1[1](),h=n.d8pv6[1](),d=n.d8pv1[1]();if(s)return(s.judgement??"")+" d20pv6";if(g)return(g.judgement??"")+" d20pv1";if(h)return(h.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return O(()=>{if(t().length<7)return;let n=a.parentElement,s;if(e.play_replay.ply<3)s=0;else if(e.play_replay.is_on_last_ply)s=99999;else{let g=n.querySelector(".active");g&&(s=g.offsetTop-a.offsetHeight/2+g.offsetHeight/2)}s!==void 0&&(a.scrollTop=s)}),(()=>{var l=En(),n=l.firstChild,s=n.nextSibling,g=s.nextSibling,h=g.firstChild;return h.nextSibling,ge(d=>a=d,n),$(n,b(kt,{get each(){return t()},children:(d,r)=>[b(z,{get when(){return d.ply%2===1},get children(){var o=An();return $(o,()=>Math.ceil(d.ply/2)),o}}),(()=>{var o=Pn(),_=o.firstChild;return o.$$click=()=>i(d.ply),o.$$contextmenu=u=>{u.preventDefault(),e.on_context_menu(u,d.ply)},$(_,()=>d.san),$(o,b(z,{get when(){return e.steps_stockfish.steps_with_stockfish[r()]},children:u=>b(On,{get ss(){return u()}})}),null),ce(()=>J(o,"move "+c(r())+(d.ply===f()?" active":""))),o})()]})),$(g,b(Nn,{get sharpness(){return e.last_step_sharpness}}),null),l})()}function Nn(e){return b(Qe,{get children(){return[b(H,{get when(){return e.sharpness===void 0},children:"..."}),b(H,{get when(){return e.sharpness&&e.sharpness>=5},get children(){return Rn()}}),b(H,{get when(){return e.sharpness===3||e.sharpness===4},get children(){return Tn()}}),b(H,{get when(){return e.sharpness===2},get children(){return Ln()}}),b(H,{get when(){return e.sharpness===1},get children(){return qn()}})]}})}function On(e){return b(Qe,{get fallback(){return b(ke,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[b(H,{get when(){return e.ss.d20pv6[1]()},children:t=>b(ke,{get step(){return t()}})}),b(H,{get when(){return e.ss.d20pv1[1]()},children:t=>b(ke,{get step(){return t()}})}),b(H,{get when(){return e.ss.d8pv6[1]()},children:t=>b(ke,{get step(){return t()}})}),b(H,{get when(){return e.ss.d8pv1[1]()},children:t=>b(ke,{get step(){return t()}})})]}})}const Mt=e=>e==="top"?"!":e==="ok"?"✓":e==="inaccuracy"?"?!":e==="mistake"?"?":"??";function ke(e){const t=()=>e.step.search?.cp,i=()=>e.step.judgement,f=()=>e.step.progress?.depth;return(()=>{var a=ht();return $(a,b(z,{get when(){return t()!==void 0},get fallback(){return(()=>{var c=gt();return c.firstChild,$(c,f,null),c})()},get children(){var c=ht();return $(c,()=>Bn(t())),c}}),null),$(a,b(z,{get when(){return i()},get fallback(){return gt()},children:c=>(()=>{var l=Dn();return $(l,()=>Mt(c())),l})()}),null),a})()}function Bn(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}Ke(["contextmenu","click"]);var Ue=Symbol("fallback");function mt(e){for(const t of e)t.dispose()}function Et(e,t,i,f={}){const a=new Map;return me(()=>mt(a.values())),()=>{const l=e()||[];return l[nn],rn(()=>{if(!l.length)return mt(a.values()),a.clear(),f.fallback?[ut(d=>(a.set(Ue,{dispose:d}),f.fallback()))]:[];const n=new Array(l.length),s=a.get(Ue);if(!a.size||s){s?.dispose(),a.delete(Ue);for(let h=0;h<l.length;h++){const d=l[h],r=t(d,h);c(n,d,h,r)}return n}const g=new Set(a.keys());for(let h=0;h<l.length;h++){const d=l[h],r=t(d,h);g.delete(r);const o=a.get(r);o?(n[h]=o.mapped,o.setIndex?.(h),o.setItem(()=>d)):c(n,d,h,r)}for(const h of g)a.get(h)?.dispose(),a.delete(h);return n})};function c(l,n,s,g){ut(h=>{const[d,r]=E(n),o={setItem:r,dispose:h};if(i.length>1){const[_,u]=E(s);o.setIndex=u,o.mapped=i(d,_)}else o.mapped=i(d);a.set(g,o),l[s]=o.mapped})}}function Un(e){const{by:t}=e;return S(Et(()=>e.each,typeof t=="function"?t:i=>i[t],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var Wn=k("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),At=k("<span class=index>"),Fn=k("<div class=fbt>"),Hn=k("<div class=lines>"),zn=k("<div class=line>"),Gn=k("<span class=collapsed>..<!> "),Vn=k("<div>");function Yn(e){return ln(e).map(t=>{let i=t.headers.get("Event"),f=t.headers.get("Site"),a=t.headers.get("White"),c=t.headers.get("Black"),l=t.headers.get("Chapter"),n=t.headers.get("Orientation"),s=t.headers.get("FEN"),g=s??te,h=ve.fromSetup(ye(g).unwrap()).unwrap(),d=Pt();t.moves.children.forEach(o=>{r(o,h,"")});function r(o,_,u){let v=o.data.san,y=wt(_,v),m=_.clone();m.play(y);let x=$t(y),M=o.data.nags;d.add_child_san(u,v).set_nags(M??[]);let A=u.length===0?x:`${u} ${x}`;o.children.forEach(D=>{r(D,m,A)})}return{event:i,site:f,white:a,black:c,chapter:l,fen:s,orientation:n,tree:d}})}function Pt(){let[e,t]=E([]);const i=l=>f(l)?.[1],f=l=>{if(l==="")return;let n=l.split(" "),s=0,g,h=e();for(;;){let d=n.slice(0,s+1).join(" "),r=h.find(o=>o.path===d);if(!r)return;if(s++,s===n.length)return[g,r];g=r,h=r.children}};function a(l,n=!1){let s=l.ply,g=s%2===1||n?Math.ceil(s/2)+(s%2===1?".":"..."):"",h=s%2===1?"":" ";return`${g} ${l.san}${l.comments?" { "+l.comments+" }":""}${h}`}function c(l,n=!1){let s="";return l.length===0||(l.length===1?(s+=a(l[0].step,n),s+=c(l[0].children,!1)):(s+=a(l[0].step,!1).trimEnd(),s+=" "+l.slice(1).map(g=>`(${c([g],!0).trimEnd()})`).join(" "),s+=" "+c(l[0].children,!0))),s}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(l){if(l.length===0)return[];let n=l[0],s=this.add_child_san("",n),g=[s];return l.slice(1).forEach(h=>{s=s.add_child_san(h),g.push(s)}),g},add_child_san(l,n){if(l===""){let g=e(),h=g.find(o=>o.san===n);if(h)return h;let d=ve.fromSetup(ye(te).unwrap()).unwrap(),r=Rt(0,d,n,"");return t([...g,r]),r}let s=i(l);if(s)return s.add_child_san(n)},remove_child_at_path(l){let n=f(l);if(n){if(!n[0]){let s=e(),g=s.indexOf(n[1]);return s.splice(g,1),t([...s]),n[1]}return n[0].remove_child(n[1]),n[1]}},find_at_path:i,find_parent_and_child_at_path:f,siblings_of(l){let n=f(l)?.[0];if(n)return n.children;if(l.split(" ").length===1)return e()},previous_branch_points(l){let n=[],s=e(),g=s.length>1;for(let h of l.split(" ")){let d=s.find(r=>r.step.uci===h);if(!d)return;g&&(n.push(d),g=!1),d.children.length>1&&(g=!0),s=d.children}return n}}}function Rt(e,t,i,f){let[a,c]=E([]),[l,n]=E([]);t=t.clone();let s=St(e,t,i,f),g=()=>h()?.length??0,h=()=>d()?.children,d=()=>{let o=a();if(o.length!==0)return o.length===1?o[0].first_node_with_variations:r},r={get nags(){return l()},set_nags:n,get path(){return s.path},get ply(){return s.ply},get san(){return s.san},step:s,get children(){return a()},remove_child(o){let _=a(),u=_.indexOf(o);if(u!==-1)return _.splice(u,1),c([..._]),o},add_child_san(o){let _=a(),u=_.find(y=>y.san===o);if(u)return u;let v=Rt(e+1,t,o,s.path);return c([..._,v]),v},remove_child_san(o){let _=a(),u=_.findIndex(y=>y.step.san!==o);if(u===-1)return;let v=_.splice(u,1)[0];return c([..._]),v},get nb_first_variations(){return g()},get first_node_with_variations(){return d()},get length(){let o=a();if(o.length>1)return 1;if(o.length===0)return 0;let _=1,u=o[0];for(;u?.children.length===1;)_++,u=u.children[0];return _}};return r}function Kn(e){let t=Pt();e&&(t=Yn(e)[0].tree);let[i,f]=E(""),a=[];O(F(i,r=>{t.previous_branch_points(r)?.map(o=>{a.includes(o.path)||(t.siblings_of(o.path)?.forEach(_=>{a=a.filter(u=>u!==_.path)}),a.push(o.path))})}));const c=r=>{f(r)},l=()=>{let r=i();if(r!=="")return r.split(" ").slice(0,-1).join(" ")},n=()=>{let r=i(),o=t.find_at_path(r)?.children??t.root;return o.length===1?o[0].path:o.find(_=>a.includes(_.path))?.path??o[0]?.path},s=()=>{let r=t.find_parent_and_child_at_path(i());if(!r)return;let o=r;if(!o[0])return"";if(o[0].children.length>1)return o[0].path;for(;!(!o[0]||o[0].children.length>1);){let _=t.find_parent_and_child_at_path(o[0].path);if(!_)break;o=_}return o[1].path},g=()=>{let r=t.find_at_path(i());if(!r)return t.root.find(_=>a.includes(_.path))?.path??t.root[0]?.path;let o=r;if(o.children.length>1)return o.children.find(_=>a.includes(_.path))?.path??o.children[0]?.path;for(;o.children.length===1;)o=o.children[0];return o.path},h=()=>{let r=t.find_parent_and_child_at_path(i());if(!r)return;let o=r[0]?.children??[];if(!r[0])o=t.root;else if(r[0].children.length===1)for(;;){if(r=t.find_parent_and_child_at_path(r[0].path),!r)return;if(!r[0]){o=t.root;break}if(r[0].children.length>1){o=r[0].children;break}}let _=o.indexOf(r[1]),u=o[_-1];if(u)return u.path},d=()=>{let r=t.find_parent_and_child_at_path(i());if(!r)return;let o=r[0]?.children??[];if(!r[0])o=t.root;else if(r[0].children.length===1)for(;;){if(r=t.find_parent_and_child_at_path(r[0].path),!r)return;if(!r[0]){o=t.root;break}if(r[0].children.length>1){o=r[0].children;break}}let _=o.indexOf(r[1]),u=o[_+1];if(u)return u.path};return{steps:t,get cursor_path(){return i()},set cursor_path(r){f(r)},get cursor_path_step(){return t.find_at_path(i())?.step},goto_path:c,get_prev_path:l,get_next_path:n,goto_prev_if_can(){let r=l();r!==void 0&&c(r)},goto_next_if_can(){let r=n();r!==void 0&&c(r)},get_first_path:s,get_last_path:g,get_up_path:h,get_down_path:d,goto_up_if_can(){let r=h();r!==void 0&&c(r)},goto_down_if_can(){let r=d();r!==void 0&&c(r)},goto_last_if_can(){let r=g();r!==void 0&&c(r)},goto_first_if_can(){let r=s();r!==void 0&&c(r)},get previous_branch_points_at_cursor_path(){return t.previous_branch_points(i())??[]}}}function Qn(e){const t=e.play_replay.steps;let i;O(()=>{let a=e.play_replay.cursor_path,c=i.parentElement;if(!c)return;const l=i.querySelector(".on-path-end");if(!l){c.scrollTop=a.length>0?99999:0;return}let n=l.offsetTop-c.offsetHeight/2+l.offsetHeight;c.scrollTo({behavior:"smooth",top:n})});const f=a=>{let c=!1;a.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),a.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),a.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),a.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&a.preventDefault()};return Re(()=>{document.addEventListener("keydown",f),me(()=>{document.removeEventListener("keydown",f)})}),(()=>{var a=Wn(),c=a.firstChild,l=c.firstChild,n=c.nextSibling,s=n.firstChild,g=s.nextSibling,h=n.nextSibling,d=h.firstChild,r=d.nextSibling,o=r.nextSibling,_=o.nextSibling;return ge(u=>i=u,l),$(l,b(Ve,{get nodes(){return t.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:u=>e.play_replay.cursor_path=u,on_context_menu:(u,v)=>e.on_context_menu?.(u,v)})),s.$$click=()=>e.play_replay.goto_up_if_can(),g.$$click=()=>e.play_replay.goto_down_if_can(),$(n,b(kt,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:u=>(()=>{var v=Fn();return v.$$click=()=>e.play_replay.cursor_path=u.path,$(v,b(z,{get when(){return u.ply&1},get children(){var y=At();return $(y,()=>Ye(u.ply)),y}}),null),$(v,()=>u.san,null),v})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),r.$$click=()=>e.play_replay.goto_prev_if_can(),o.$$click=()=>e.play_replay.goto_next_if_can(),_.$$click=()=>e.play_replay.goto_last_if_can(),ce(u=>{var v=e.play_replay.get_up_path()===void 0,y="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),m=e.play_replay.get_down_path()===void 0,x="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),M=e.play_replay.get_first_path()===void 0,A="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),D=e.play_replay.get_prev_path()===void 0,I="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),G=e.play_replay.get_next_path()===void 0,Q="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),ae=e.play_replay.get_last_path()===void 0,B="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return v!==u.e&&(s.disabled=u.e=v),y!==u.t&&J(s,u.t=y),m!==u.a&&(g.disabled=u.a=m),x!==u.o&&J(g,u.o=x),M!==u.i&&(d.disabled=u.i=M),A!==u.n&&J(d,u.n=A),D!==u.s&&(r.disabled=u.s=D),I!==u.h&&J(r,u.h=I),G!==u.r&&(o.disabled=u.r=G),Q!==u.d&&J(o,u.d=Q),ae!==u.l&&(_.disabled=u.l=ae),B!==u.u&&J(_,u.u=B),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),a})()}function Ve(e){return[b(z,{get when(){return e.nodes.length===1},get children(){return[b(We,$e(e,{get node(){return e.nodes[0]}})),b(Ve,$e(e,{get nodes(){return e.nodes[0].children}}))]}}),b(z,{get when(){return e.nodes.length>1},get children(){var t=Hn();return $(t,b(Un,{get each(){return e.nodes},by:"path",children:i=>(()=>{var f=zn();return $(f,b(z,{get when(){return e.cursor_path.startsWith(i().path)},get fallback(){return[b(We,$e(e,{get node(){return i()},show_index:!0,collapsed:!0})),(()=>{var a=Gn(),c=a.firstChild,l=c.nextSibling;return l.nextSibling,$(a,()=>i().length,l),$(a,()=>i().nb_first_variations,null),a})()]},get children(){return[b(We,$e(e,{get node(){return i()},show_index:!0})),b(Ve,$e(e,{get nodes(){return i().children}}))]}})),f})()})),t}})]}function We(e){let t=S(()=>e.node.ply%2===0||e.show_index),i=S(()=>e.node.ply%2===0?".":"...");const f=S(()=>e.node.path),a=S(()=>e.cursor_path.startsWith(f())),c=S(()=>f()===e.cursor_path),l=S(()=>{let n=["move"];return e.collapsed&&n.push("collapsed"),a()&&n.push("on-path"),c()&&n.push("on-path-end"),n.join(" ")});return(()=>{var n=Vn();return n.$$click=()=>{e.on_set_cursor(e.node.path)},n.$$contextmenu=s=>{s.preventDefault(),e.on_context_menu(s,e.node.path)},$(n,b(z,{get when(){return t()},get children(){var s=At();return $(s,()=>Math.floor(e.node.ply/2)+1,null),$(s,i,null),s}}),null),$(n,()=>e.node.san,null),ce(()=>J(n,l())),n})()}const Ye=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");Ke(["click","contextmenu"]);const Xn=(e,t)=>e==="white"?t:-t,Tt=e=>2/(1+Math.exp(-.00368208*e))-1,Jn=e=>Tt(Math.min(Math.max(-1e3,e),1e3)),Zn=e=>{const i=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return Tt(i)},er=e=>typeof e.mate<"u"?Zn(e.mate):Jn(e.cp),vt=(e,t)=>Xn(e,er(t)),tr=(e,t,i)=>(vt(e,t)-vt(e,i))/2,nr=(e,t,i)=>tr(e,t,i),rr=1200,ie=10;function lr(){let e=xt(Xe);function t(_,u,v,y,m,x,M){e.best_move_with_cache(s(),_,u,v,y,m,x,M)}let i,f=[];function a(_,u,v,y){let[m,x]=E(void 0),[M,A]=E(void 0),[D,I]=E(void 0),G={get loading(){return m()},get depth_eval(){return M()},get best_eval(){return D()},cancel:ae},Q={cancel:ae,fen:_,ply:u,depth:v,multi_pv:y,set_loading:x,set_depth_eval:A,set_best_eval:I};function ae(){let B=f.indexOf(Q);B!==-1&&f.splice(B,1),i===Q&&(console.trace("working cancel"),i=void 0,e.stop()),c()}return f.push(Q),c(),G}function c(){if(i||(i=f.pop(),!i))return;const _=u=>{i?.set_best_eval(u),i=void 0,c()};t(i.fen,i.ply,i.multi_pv,i.depth,i.set_loading,i.set_depth_eval,_)}function l(_,u,v){let y=a(_.before_fen,_.ply-1,u,v),m=a(_.fen,_.ply,u,v);function x(M,A,D){let I=nr(M,A,D);return I<.02?"top":I<.03?"ok":I<.05?"inaccuracy":I<.12?"mistake":"blunder"}return S(()=>(me(()=>{m.cancel(),y.cancel()}),{..._,get before_search(){return y.best_eval},get search(){return m.best_eval},get judgement(){let M=y.best_eval,A=m.best_eval;if(M&&A)return x(xe(_.before_fen),M,A)},get progress(){return m?.depth_eval}}))}function n(_){let[u,v]=E(se(()=>l(_,ie,6)())),[y,m]=E(se(()=>l(_,ie,1)())),[x,M]=E(se(()=>l(_,20,6)())),[A,D]=E(se(()=>l(_,20,1)()));return{step:_,get d8pv6(){return u()},get d8pv1(){return y()},get d20pv6(){return x()},get d20pv1(){return A()},clear(){v(se(()=>l(_,ie,6)())),M(se(()=>l(_,20,6)())),m(se(()=>l(_,ie,1)())),D(se(()=>l(_,20,1)()))}}}let[s,g]=E(""),[h,d]=E([]),r=Et(h,_=>[_.fen,_.uci].join("$$"),_=>n(_())),o=n({before_fen:te,fen:te,path:"",ply:0,san:"",uci:""});return{set_game_id:g,set_steps:d,get steps_with_stockfish(){return r()},get initial_step(){return o}}}function ir(e){const[t,i]=E(!1);let f=0;const a=n=>{f=requestAnimationFrame(a),e(n)},c=()=>{t()||(i(!0),f=requestAnimationFrame(a))},l=()=>{i(!1),cancelAnimationFrame(f)};return me(l),[t,c,l]}var ar=k('<div class=info><h2>Repertoire Builder</h2><p>Play against the engine. Select your difficulty with skill setting. Engine always selects among the top 6 moves.</p><p>Game ends when the evaluation drops below -2 for the player.</p><p>You will see the latest evaluation and the accuracy of the moves in the move replay.</p><p>You can save your played lines for building up your repertoire, and practice against later.</p><p>You can tell the engine to stick to playing a specific line you have already played.</p><p>Right click on the moves to open settings for that move. Switch between "Match" and "Repertoire" tabs.</p><p>The goal is to find the top moves only, and play as long as you can, and repeat as much as possible.</p><small> We recommend selecting the "Third" skill level for starters. Thus it will make some sub optimal moves, well suited for about 1800 lichess rated player. Later you can select "Top" option for GM level opening preparation.</small><p class=right>Have fun!'),sr=k("<div class=welcome>"),or=k(`<div class="start info"><button class=button>New Game</button><div class=hide-box><label for=hide>Don't show this again</label><input id=hide type=checkbox>`),cr=k("<p class=loading><span class=info>Loading Engine <!>%"),dr=k("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth </label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),Fe=k("<span class=result>Game Over"),ur=k("<small class=drop>Ran out of time"),_r=k("<small class=drop>Evaluation is High Above 5"),fr=k("<small class=drop>Evaluation Dropped Below -2"),pr=k("<span class=result>Checkmate"),hr=k("<small class=drop>Victory is <span class=victory>"),gr=k("<span class=result>Stalemate"),He=k("<small class=drop>Game is a draw"),mr=k("<span class=result>3 Fold Repetition"),vr=k("<span class=result>Insufficient Material"),yr=k("<div class=result-wrap>"),br=k("<div class=tools-wrap><button class=rematch>Rematch</button><button><i>"),wr=k("<div class=clock-wrap>"),$r=k("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=header><div class=tabs-wrap><div>Match</div><div>Repertoire</div></div><i data-icon=>"),kr=k("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=delete data-icon=>Delete move"),xr=k("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=save data-icon=>Save this line</a><a class=analyze data-icon=>Analyze on lichess"),Sr=k("<div class=clock><span>:");const jr=()=>b(gn,{get children(){return b(Mr,{})}});function Cr(){return ar()}function Mr(){let[e]=bt(()=>xt(Xe));const t=S(()=>{if(e()?.state==="idle")return;let l=e()?.download_nb;if(l)return Math.ceil(l.bytes/(l.total===0?70*1024*1024:l.total)*100)}),[i,f]=ue(!1,"builder.show_welcome_page"),[a,c]=E(!i());return b(z,{get when(){return e()},children:l=>b(z,{get when(){return l().state==="loading"||a()},get fallback(){return b(Er,{on_welcome_page:()=>c(!0)})},get children(){var n=sr();return $(n,b(Cr,{}),null),$(n,b(z,{get when(){return t()},get fallback(){return(()=>{var s=or(),g=s.firstChild,h=g.nextSibling,d=h.firstChild,r=d.nextSibling;return g.$$click=()=>c(!1),r.addEventListener("change",o=>f(o.currentTarget.checked)),ce(()=>r.checked=i()),s})()},children:s=>(()=>{var g=cr(),h=g.firstChild,d=h.firstChild,r=d.nextSibling;return r.nextSibling,$(h,s,r),g})()}),null),n}})})}function Er(e){const t=an();t.setVolume(.2);let[i,f]=ue([],"builder.current.sans");const[a,c]=E(ie);let l="";const n=lr(),s=jn();let g=vn();const[h,d]=ue("white","builder.player_color"),r=S(()=>_t(h())),o=S(()=>{let p=s.ply;return n.steps_with_stockfish.find(R=>R.step.ply===p)}),_=S(()=>{let p=n.steps_with_stockfish;return p[p.length-1]});function u(p){return a()===ie?p.d8pv6:p.d20pv6}function v(p){return a()===ie?p.d8pv6[0]():p.d20pv6[0]()}const[y,m]=E(1);oe(()=>{n.set_game_id(l),s.set_sans(i()),x()});function x(){clearTimeout(y()),m(setTimeout(()=>{m(void 0)},rr))}O(()=>{if(y()!==void 0||B()!==void 0)return;let w=_();if(!w)if(r()==="white")w=n.initial_step;else return;if(xe(w.step.fen)===r()){let T=Ut();if(T&&T.startsWith(w.step.path)){let L=T.slice(w.step.path.length).trim().split(" ")[0];if(L){g.play_uci(L);return}}let W=u(w)[0]();O(F(()=>W.search,L=>{if(!L)return;let Y=L.cp,ee=L.pvs,C=L.pvs.filter(j=>Math.abs(j.cp-Y)<=10),q=L.pvs.filter(j=>Math.abs(j.cp-Y)<=30),N=L.pvs.filter(j=>Math.abs(j.cp-Y)<=60),K=L.pvs.filter(j=>Math.abs(j.cp-Y)<=100),ne=L.pvs.filter(j=>Math.abs(j.cp-Y)<200),V=C.filter(j=>j.cp<150),X=q.filter(j=>j.cp<150),pe=N.filter(j=>j.cp<150),Me=K.filter(j=>j.cp<150),je=ne.filter(j=>j.cp<150);function de(j){return j.find(Ie=>Ie.length>0)}let le;switch(_e()){case"A":le=de([V,C,ee]);break;case"B":le=de([X,V,C,q,ee]);break;case"C":le=de([pe,X,V,C,q,N,ee]);break;case"D":le=de([Me,pe,X,V,C,q,N,K,ee]);break;case"E":le=de([je,Me,pe,X,V,C,q,N,K,ne,ee]);break}g.play_uci(cn(le).moves[0])}))}}),O(F(()=>g.on_last_move_added,p=>{p&&oe(()=>{x(),s.play_san(p[1])})})),O(F(()=>s.sans,f)),O(F(()=>s.ply_step,p=>{g.set_fen_and_last_move(p?.fen??te,p?.uci)})),O(F(()=>s.ply_step,(p,w)=>{p&&(!w||w.ply===p.ply-1)&&t.move(p)}));const M=on(p=>{const w=p.target;w.tagName!=="PIECE"&&w.tagName!=="SQUARE"&&w.tagName!=="CG-BOARD"||(p.preventDefault(),A(Math.sign(p.deltaY)))}),A=p=>{p>0?(re()==="match"&&s.goto_next_ply_if_can(),re()==="repertoire"&&P.goto_next_if_can()):(re()==="match"&&s.goto_prev_ply_if_can(),re()==="repertoire"&&P.goto_prev_if_can())},D=(p=h())=>{oe(()=>{d(p),f([]),s.set_sans(i()),g.set_fen_and_last_move(te),Z(void 0),x(),rt()})};O(F(a,()=>{n.steps_with_stockfish.forEach(w=>{oe(()=>{w.clear(),v(w)})});let p=_();p&&u(p)[0]()})),O(F(_,p=>{if(!p)return;let w=v(p);O(F(()=>w.search,R=>{let T=R?.cp;T&&((h()==="white"&&T<-200||h()==="black"&&T>200)&&Z("drop"),(h()==="white"&&T>500||h()==="black"&&T<-500)&&Z("highdrop"))}))})),O(()=>{let p=s.is_checkmate,w=s.is_stalemate,R=s.is_threefold,T=s.is_insufficient;p&&Z("checkmate"),w&&Z("stalemate"),R&&Z("threefold"),T&&Z("insufficient")});let[I,G]=ue("","builder.current.cursor_path"),[Q,ae]=ue(void 0,"builder.current.pgn");const[B,Z]=E(void 0),P=Kn(Q());P.cursor_path=I(),O(F(()=>P.cursor_path,p=>{G(p)})),O(F(()=>P.cursor_path_step,p=>{p?g.set_fen_and_last_move(p.fen,p.uci):g.set_fen_and_last_move(te)}));const Lt=p=>{oe(()=>{we(void 0),p&&s.goto_ply(p);let R=s.steps_up_to_ply.map(L=>L.san),T=P.steps.add_sans_at_root(R),W=T[T.length-1]?.path;W&&(Te("repertoire"),P.cursor_path=W,ae(P.steps.as_pgn))})},[re,Te]=E("match");O(F(re,p=>{let w=p==="repertoire"?P.cursor_path_step:s.ply_step;w?g.set_fen_and_last_move(w.fen,w.uci):g.set_fen_and_last_move(te)}));let Le,Se;const qt=(p,w)=>{P.cursor_path=w,be(P.steps.find_at_path(w));let R=p.clientX,T=p.clientY,W=Se.getBoundingClientRect(),L=Le.getBoundingClientRect();R-=L.left,T-=L.top,R=Math.min(R,document.body.clientWidth-W.width-L.left-20);let Y=`${T}px`,ee=`${R}px`;Se.style.top=Y,Se.style.left=ee};let Ce;const Dt=(p,w)=>{s.goto_ply(w),we(s.ply_step);let R=p.clientX,T=p.clientY,W=Ce.getBoundingClientRect(),L=Le.getBoundingClientRect();R-=L.left,T-=L.top,R=Math.min(R,document.body.clientWidth-W.width-L.left-20);let Y=`${T}px`,ee=`${R}px`;Ce.style.top=Y,Ce.style.left=ee};Re(()=>{const p=()=>{be(void 0),we(void 0)};document.addEventListener("click",p),me(()=>{document.removeEventListener("click",p)})});const[jt,be]=E(void 0),[It,we]=E(void 0),Nt=p=>{P.steps.remove_child_at_path(p),be(void 0)},Je=p=>{c(p)},Ot=S(()=>s.is_on_last_ply&&B()===void 0);Re(()=>{const p=w=>{w.key==="f"&&d(_t(h()))};document.addEventListener("keypress",p),me(()=>{document.removeEventListener("keypress",p)})});const[_e,Bt]=ue("C","builder.skill"),[Ut,Wt]=ue(void 0,"builder.stick-line"),Ze=p=>{Wt(p),be(void 0),we(void 0)},Ft=S(()=>{let p=o();if(!p)return;let w=u(p)[0]();return w?S(F(()=>w.search,T=>{if(!T)return;let W=T.cp;return T.pvs.filter(L=>Math.abs(W-L.cp)<45).length}))():void 0}),Ht=p=>{let w=p.fen;window.open(`https://lichess.org/analysis?fen=${w}`,"_blank"),we(void 0),be(void 0)},zt=S(()=>{let p=o();if(!p)return;if(xe(p.step.fen)===r()){let{uci:R,san:T}=p.step,W=u(p)[0]();return S(()=>{if(!W.judgement)return;let Y=Mt(W.judgement);return dn(R,T,Y)})()}}),[qe,Pr]=E(7*60*1e3),[et,De]=E(qe());let fe,[Gt,tt,nt]=ir(p=>{fe||(fe=p);let w=p-fe;fe=p;let R=Math.max(0,et()-w);De(R),R===0&&Z("flag")});function rt(){oe(()=>{nt(),fe=void 0,De(qe())})}return O(()=>{}),O(F(B,p=>{nt(),fe=void 0})),O(F(()=>s.last_step,p=>{if(!p){h()==="white"&&tt();return}xe(p.fen)===h()?(De(qe()),tt()):rt()})),(()=>{var p=$r(),w=p.firstChild,R=w.nextSibling,T=R.firstChild,W=T.firstChild,L=W.firstChild,Y=L.nextSibling,ee=W.nextSibling;return ft(p,"wheel",M),ge(C=>Le=C,p),$(w,b(yn,{get shapes(){return zt()},get orientation(){return h()},get color(){return h()},get movable(){return Ot()},play_uci:g})),L.$$click=()=>Te("match"),Y.$$click=()=>Te("repertoire"),ft(ee,"click",e.on_welcome_page,!0),$(R,b(z,{get when(){return re()==="match"},get children(){return[(()=>{var C=dr(),q=C.firstChild,N=q.firstChild,K=N.nextSibling,ne=K.firstChild,V=ne.nextSibling,X=V.nextSibling,pe=X.nextSibling,Me=pe.nextSibling,je=q.nextSibling,de=je.firstChild,le=de.firstChild,Ee=le.firstChild,j=Ee.nextSibling;j.firstChild;var Ie=le.nextSibling,Vt=Ie.firstChild;return K.addEventListener("change",U=>Bt(U.currentTarget.value)),Ee.addEventListener("change",U=>{U.target.checked&&Je(ie)}),Ee.checked=!0,$(j,ie,null),Vt.addEventListener("change",U=>{U.target.checked&&Je(20)}),ce(U=>{var lt=_e()==="A",it=_e()==="B",at=_e()==="C",st=_e()==="D",ot=_e()==="E";return lt!==U.e&&(ne.selected=U.e=lt),it!==U.t&&(V.selected=U.t=it),at!==U.a&&(X.selected=U.a=at),st!==U.o&&(pe.selected=U.o=st),ot!==U.i&&(Me.selected=U.i=ot),U},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),C})(),b(In,{play_replay:s,steps_stockfish:n,get last_step_sharpness(){return Ft()},on_context_menu:Dt}),(()=>{var C=yr();return $(C,b(Qe,{get children(){return[b(H,{get when(){return B()==="flag"},get children(){return[Fe(),ur()]}}),b(H,{get when(){return B()==="highdrop"},get children(){return[Fe(),_r()]}}),b(H,{get when(){return B()==="drop"},get children(){return[Fe(),fr()]}}),b(H,{get when(){return B()==="checkmate"},get children(){return[pr(),(()=>{var q=hr(),N=q.firstChild,K=N.nextSibling;return $(K,()=>xe(s.last_step.before_fen)),q})()]}}),b(H,{get when(){return B()==="stalemate"},get children(){return[gr(),He()]}}),b(H,{get when(){return B()==="threefold"},get children(){return[mr(),He()]}}),b(H,{get when(){return B()==="insufficient"},get children(){return[vr(),He()]}})]}})),C})(),(()=>{var C=br(),q=C.firstChild,N=q.nextSibling;return q.$$click=()=>D(),N.$$click=()=>D(r()),ce(()=>J(N,`color ${r()}`)),C})(),(()=>{var C=wr();return $(C,b(Ar,{get time(){return et()},get isRunning(){return Gt()}})),C})()]}}),null),$(R,b(z,{get when(){return re()==="repertoire"},get children(){return b(Qn,{play_replay:P,on_context_menu:qt})}}),null),$(p,b(z,{get when(){return jt()},children:C=>(()=>{var q=kr(),N=q.firstChild,K=N.nextSibling,ne=K.nextSibling;return ge(V=>Se=V,q),q.$$click=V=>{V.preventDefault(),V.stopImmediatePropagation()},$(N,()=>Ye(C().ply),null),$(N,()=>C().san,null),K.$$click=()=>Ze(C().path),ne.$$click=()=>Nt(C().path),q})()}),null),$(p,b(z,{get when(){return It()},children:C=>(()=>{var q=xr(),N=q.firstChild,K=N.nextSibling,ne=K.nextSibling,V=ne.nextSibling;return ge(X=>Ce=X,q),q.$$click=X=>{X.preventDefault(),X.stopImmediatePropagation()},$(N,()=>Ye(C().ply),null),$(N,()=>C().san,null),K.$$click=()=>Ze(C().path),ne.$$click=()=>Lt(C().ply),V.$$click=()=>Ht(C()),q})()}),null),ce(C=>{var q="tab"+(re()==="match"?" active":""),N="tab"+(re()==="repertoire"?" active":"");return q!==C.e&&J(L,C.e=q),N!==C.t&&J(Y,C.t=N),C},{e:void 0,t:void 0}),p})()}const yt=e=>(e<10?"0":"")+e;function Ar(e){const t=S(()=>new Date(e.time)),i=S(()=>t().getUTCMilliseconds()),f=S(()=>t().getUTCMinutes()),a=S(()=>t().getUTCSeconds()),c=S(()=>e.isRunning&&i()<500?" low":"");return(()=>{var l=Sr(),n=l.firstChild;return $(l,()=>yt(f()),n),$(l,()=>yt(a()),null),ce(()=>J(n,"sep"+c())),l})()}Ke(["click"]);export{jr as default};
