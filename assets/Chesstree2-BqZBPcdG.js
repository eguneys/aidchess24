var F=Object.defineProperty;var z=(r,t,e)=>t in r?F(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var o=(r,t,e)=>(z(r,typeof t!="symbol"?t+"":t,e),e);import{d as A,l as m,w as g,m as C,r as R,i as p,c as n,S as b,z as f,e as O,M as w,F as j,b as u,f as D,g as P,t as v}from"./index-BdVd2VeO.js";import"./Shalala-BM3Gydjq.js";import{I as M,f as B,a as G}from"./chess_pgn_logic-BlSCJ5a9.js";const J=(r=1)=>()=>{var t=Math.sin(r++)*1e4;return t-Math.floor(t)},K=J();function Q(r,t=K){return Math.floor(t()*r)}function W(r){return r[Q(r.length)]}var H=v("<div class=chesstree>"),I=v("<div class=lines>"),L=v("<div class=line>"),U=v("<span class=index>"),V=v("<div>"),X=v("<span class=collapsed> ..<!> ");const T=r=>{let t=[];for(let e of r)t.length===0?t.push([e]):t.push([...t[t.length-1],e]);return t};class ${constructor(){o(this,"_paths");this._paths=m([],{equals:!1})}static set_for_saving(t){let e=new $;return e.paths=t,e}get paths(){return this._paths[0]()}set paths(t){this._paths[1](t)}get_for_saving(){return this.paths}merge_dup(t){g(()=>{t.paths.forEach(e=>this.add_path(e))})}replace_all(t){this.paths=t.paths.slice(0)}add_path(t){let e=this.paths;e.find(a=>a.join("")===t.join(""))||(e.push(t),this.paths=e)}remove_path(t){this.paths=this.paths.filter(e=>e.join("")!==t.join(""))}clear(){this.paths=[]}}const x=class x{constructor(t,e){o(this,"_tree");o(this,"_cursor_path");o(this,"_hidden_paths");o(this,"_revealed_paths");o(this,"_failed_paths");o(this,"_solved_paths");o(this,"reveal_hidden_paths",()=>{g(()=>{this.hidden_paths.forEach(t=>{this.revealed_paths.push(t)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})});o(this,"reveal_one_random",()=>{var a,h;if(!this.tree)return!1;const t=((h=(a=this.tree)==null?void 0:a._traverse_path(this.cursor_path))==null?void 0:h.children)??[this.tree.root],e=Z(t);return e?(g(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(s=>this._hidden_paths.add_path(s.data.path)),this.cursor_path=e.data.path}),!0):!1});o(this,"try_next_uci_fail",t=>{var s,l,i;if(!this.tree)return!1;const e=((s=this.tree)==null?void 0:s._traverse_path(this.cursor_path))??this.tree.root,a=((i=(l=this.tree)==null?void 0:l._traverse_path(this.cursor_path))==null?void 0:i.children)??[this.tree.root],h=a.find(_=>_.data.uci===t)??a.find(_=>tt(_.data)===t);if(h)return this.failed_paths.find(c=>c.join("")===h.data.path.join(""))?(this.cursor_path=h.data.path,!1):(g(()=>{this._hidden_paths.remove_path(h.data.path),h.children.forEach(c=>this._hidden_paths.add_path(c.data.path)),this._solved_paths.add_path(h.data.path),this.cursor_path=h.data.path}),!0);if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.add_failed_path([...e.data.path,t]),!1});o(this,"on_wheel",t=>{var a;let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let h=this.tree;if(h){let s;e.length===0?s=[h.root]:s=(a=h._traverse_path(e))==null?void 0:a.children;let l=s==null?void 0:s.map(i=>i.data.path).find(i=>{var _;return!((_=this.hidden_paths)!=null&&_.some(c=>i.join("").startsWith(c.join(""))))});l&&this.try_set_cursor_path(l)}}});this.initial_fen=t,this._cursor_path=m([],{equals:!1}),this._tree=m(e),this._hidden_paths=new $,this._revealed_paths=m([],{equals:!1}),this._failed_paths=m([],{equals:!1}),this._solved_paths=new $}get cursor_after_color(){var e,a;let t=this.cursor_path;return B(((a=(e=this.tree)==null?void 0:e.get_at(t))==null?void 0:a.after_fen)??M)}get is_cursor_path_at_a_leaf(){var e,a;let t=this.cursor_path;return this.failed_paths.find(h=>h.join("")===t.join(""))?!1:((a=(e=this.tree)==null?void 0:e.get_children(t))==null?void 0:a.length)===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let a=e.after_fen,h=e.uci;return[a,h]}}try_set_cursor_path(t){return this.hidden_paths.find(a=>t.join("").startsWith(a.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let t=W(this.tree.all_leaves.map(h=>h.path)),e=W(T(t).slice(1,-1));this.cursor_path=e;let a=this.tree.get_children(e);this._hidden_paths.clear(),a==null||a.forEach(h=>this._hidden_paths.add_path(h.path))}add_and_reveal_uci(t){this.revealed_paths.push(this.add_uci(t)),this.revealed_paths=this.revealed_paths}add_failed_path(t){let e=this.failed_paths;e=e.filter(a=>a.join("")!==t.join("")),e.push(t),this.failed_paths=e}add_uci(t){let e=this.tree,a=this.cursor_path;return e?e.append_uci(t,a):e=G.make(this.initial_fen,[t]),a=[...a,t],g(()=>{this.tree=e,this.cursor_path=a}),a}drop_failed_paths(){return g(()=>{var a;let t=this.failed_paths;t.forEach(h=>{var s;return(s=this.tree)==null?void 0:s.delete_at(h)});let e=this.cursor_path;for(;e.length>0&&!((a=this.tree)!=null&&a.get_at(e));)e.pop();return this.cursor_path=e,this.failed_paths=[],t})}get can_navigate_next(){var a;let t=this.cursor_path,e=this.tree;if(e){let h;return t.length===0?h=[e.root]:h=(a=e._traverse_path(t))==null?void 0:a.children,(h==null?void 0:h.map(l=>l.data.path).find(l=>{var i;return!((i=this.hidden_paths)!=null&&i.some(_=>l.join("").startsWith(_.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_first(){let t=T(this.cursor_path).reverse().slice(1),e=(t.find(a=>{var h;return(((h=this.tree.get_children(a.slice(0,-1)))==null?void 0:h.length)??0)>1})||t[t.length-1])??[];this.try_set_cursor_path(e)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){var a;let t=this.cursor_path,e=this.tree;if(e){let h;t.length===0?h=[e.root]:h=(a=e._traverse_path(t))==null?void 0:a.children;let s=h==null?void 0:h.map(l=>l.data.path).find(l=>{var i;return!((i=this.hidden_paths)!=null&&i.some(_=>l.join("").startsWith(_.join(""))))});s&&this.try_set_cursor_path(s)}}navigate_last(){var a,h;let t=this.cursor_path,e=this.tree;if(e){let s;t.length===0?s=[e.root]:s=(a=e._traverse_path(t))==null?void 0:a.children;let l=s==null?void 0:s.map(i=>i.data.path).find(i=>{var _;return!((_=this.hidden_paths)!=null&&_.some(c=>i.join("").startsWith(c.join(""))))});if(l){let i=e._traverse_path(l);for(;i.children.length>0&&!((h=this.hidden_paths)!=null&&h.some(_=>i.children[0].data.path.join("").startsWith(_.join(""))));)i=i.children[0];l=i.data.path,this.try_set_cursor_path(l)}}}};o(x,"make",(t,e=(t==null?void 0:t.root.data.before_fen)||M)=>new x(e,t));let q=x;const st=r=>{let t;return C(()=>{let e=r.lala.cursor_path,a=t.parentElement;if(!a)return;const h=t.querySelector(".on_path_end");if(!h){a.scrollTop=e.length>0?99999:0;return}let s=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=H();return R(a=>t=a,e),p(e,n(b,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>n(S,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return[a().root]}})})),e})()},S=r=>n(j,{get each(){return r.lines},children:t=>[n(E,f({get data(){return t.data}},r)),n(O,{get children(){return[n(w,{get when(){return t.children.length===1},get children(){return n(S,f(r,{get lines(){return t.children}}))}}),n(w,{get when(){return t.children.length>1},get children(){var e=I();return p(e,n(j,{get each(){return t.children},children:a=>(()=>{var h=L();return p(h,n(S,f(r,{lines:[a],show_index:!0}))),h})()})),e}})]}})]}),E=r=>{let t=`${Math.ceil(r.data.ply/2)}.`;r.data.ply%2===0&&(t+="..");let e=u(()=>r.cursor_path.join("").startsWith(r.data.path.join(""))),a=u(()=>r.cursor_path.join("")===r.data.path.join("")),h=u(()=>r.data.path.join("")),s=u(()=>r.hidden_paths.find(d=>d.join("")===h())),l=u(()=>r.hidden_paths.find(d=>h().startsWith(d.join("")))),i=u(()=>r.revealed_paths.find(d=>d.join("")===h())),_=u(()=>r.failed_paths.find(d=>d.join("")===h())),c=u(()=>r.solved_paths.find(d=>d.join("")===h())),N=u(()=>["move",a()?"on_path_end":e()?"on_path":"",s()?"on_hidden_path_start":l()?"on_hidden_path":"",i()?"on_revealed_path":"",_()?"on_failed_path":"",c()?"on_solved_path":"",r.collapsed?"collapsed":""].join(" "));return(()=>{var d=V();return d.$$click=()=>r.on_set_path(r.data.path),p(d,n(b,{get when(){return r.show_index||r.data.ply&1},get children(){var k=U();return p(k,t),k}}),null),p(d,()=>r.data.san,null),D(()=>P(d,N())),d})()},nt=r=>{let t;return C(()=>{let e=r.lala.cursor_path,a=t.parentElement;if(!a)return;const h=t.querySelector(".on_path_end");if(!h){a.scrollTop=e.length>0?99999:0;return}let s=h.offsetTop-a.offsetHeight/2+h.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=H();return R(a=>t=a,e),p(e,n(b,{get when(){return r.lala.tree},get fallback(){return[]},children:a=>n(y,{on_set_path:h=>r.lala.try_set_cursor_path(h),get cursor_path(){return r.lala.cursor_path},get hidden_paths(){return r.lala.hidden_paths},get revealed_paths(){return r.lala.revealed_paths},get solved_paths(){return r.lala.solved_paths_expanded},get failed_paths(){return r.lala.failed_paths},get lines(){return[a().root]}})})),e})()},y=r=>n(j,{get each(){return r.lines},children:t=>[n(E,f({get data(){return t.data}},r)),n(O,{get children(){return[n(w,{get when(){return t.children.length===1},get children(){return n(y,f(r,{get lines(){return t.children},show_index:!1}))}}),n(w,{get when(){return t.children.length>1},get children(){var e=I();return p(e,n(j,{get each(){return t.children},children:a=>(()=>{var h=L();return p(h,n(b,{get when(){return r.cursor_path.join("").startsWith(a.data.path.join(""))},get fallback(){return n(Y,f(r,{lines:[a],show_index:!0}))},get children(){return n(y,f(r,{lines:[a],show_index:!0}))}})),h})()})),e}})]}})]}),Y=r=>n(j,{get each(){return r.lines},children:t=>[n(E,f({get data(){return t.data}},r,{collapsed:!0})),(()=>{var e=X(),a=e.firstChild,h=a.nextSibling;return h.nextSibling,p(e,()=>t.length,h),p(e,()=>t.nb_first_variations,null),e})()]});function Z(r){let t=r.length*(r.length+1)/2,e=Math.floor(Math.random()*t)+1,a=0;for(let h=0;h<r.length;h++)if(a+=r.length-h,e<=a)return r[h]}const tt=r=>{let t=r.uci.slice(0,2),e=r.uci[3];if(r.san==="O-O")return t+"g"+e;if(r.san==="O-O-O")return t+"c"+e};A(["click"]);export{nt as C,q as T,$ as a,st as b,W as c};
