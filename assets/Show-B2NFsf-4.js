import{m as pn,C as xt,P as Se,n as pt,o as Q,p as X,I as ee,q as k,r as pe,v as mn,R as mt,w as ze,x as Le,y as Ve,z as j,B as vt,D as Ye,E as vn,G as it,t as f,i as h,e as T,f as J,d as Me,H as Ze,J as Te,K as bn,L as kn,N as Je,O as P,Q as $n,b as E,T as wn,U as st,j as Ne,V as Et,c,W as $e,F as we,X as Lt,Y as ge,Z as yn,_ as Ie,$ as Ae,a0 as Re,a1 as Cn,a2 as Sn,a3 as xn,k as x,l as Ot,g as de,a4 as En,a5 as Xe,a6 as me,a7 as et,a8 as qt,a9 as Ln,u as On,aa as Bt,ab as Nt,ac as qn,ad as Bn,ae as We,af as Pt,ag as Tt,ah as Rt,ai as It,aj as Nn,ak as rt,al as Pn,am as Tn,s as Rn,an as bt,ao as In}from"./index-DEITIkSU.js";import{o as kt,C as An,e as $t,d as zn,a as At,P as zt,b as tt,n as Mt}from"./random-B7C0-ROH.js";const Mn=e=>pn(e);class Un extends Se{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=pt.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():pt.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?Q.err(new X(ee.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?Q.err(new X(ee.Variant)):Q.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,i;const r=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?k.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?k.backranks().complement():k.empty());if(t=t||this.ctx(),pe(t.king)&&t.checkers.nonEmpty()){const a=t.checkers.singleSquare();return pe(a)?r.intersect(mn(a,t.king)):k.empty()}else return r}}class Gn extends Se{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new X(ee.Empty));if(this.board.king.size()>2)return Q.err(new X(ee.Kings));const t=this.board.kingOf(j(this.turn));return pe(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Q.err(new X(ee.OppositeCheck)):k.backranks().intersects(this.board.pawn)?Q.err(new X(ee.PawnsOnBackrank)):Q.ok(void 0):Q.err(new X(ee.Kings))}kingAttackers(t,n,i){const r=this.board.pieces(n,"king");return r.isEmpty()||Ve(t).intersects(r)?k.empty():super.kingAttackers(t,n,i)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(const i of Ve(t).intersect(this.board.occupied).diff(this.board.pawn)){const r=this.board.take(i);r?.role==="rook"&&this.castles.discardRook(i),r?.role==="king"&&this.castles.discardColor(r.color)}}hasInsufficientMaterial(t){if(this.board.pieces(j(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[j(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(k.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(k.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let i=k.empty();for(const r of Ye(this,t,n)){const a=this.clone();a.play({from:t,to:r});const l=a.board.kingOf(this.turn);pe(l)&&(!pe(a.board.kingOf(a.turn))||a.kingAttackers(l,a.turn,a.board.occupied).isEmpty())&&(i=i.with(r))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").isEmpty())return{winner:j(n)}}}class Kn extends Se{constructor(){super("antichess")}reset(){super.reset(),this.castles=Le.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Q.err(new X(ee.Empty)):k.backranks().intersects(this.board.pawn)?Q.err(new X(ee.PawnsOnBackrank)):Q.ok(void 0)}kingAttackers(t,n,i){return k.empty()}ctx(){const t=super.ctx();if(pe(this.epSquare)&&vn(j(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const n=this.board[j(this.turn)];for(const i of this.board[this.turn])if(Ye(this,i,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();const i=Ye(this,t,n),r=this.board[j(this.turn)];return i.intersect(n.mustCapture?pe(this.epSquare)&&this.board.getRole(t)==="pawn"?r.with(this.epSquare):r:k.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[j(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[t].intersects(k.lightSquares()),i=this.board[t].intersects(k.darkSquares()),r=this.board[j(t)].isDisjoint(k.lightSquares()),a=this.board[j(t)].isDisjoint(k.darkSquares());return n&&r||i&&a}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(k.lightSquares())!==this.board.black.intersects(k.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Dn extends Se{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(k.center())}variantOutcome(t){for(const n of ze)if(this.board.pieces(n,"king").intersects(k.center()))return{winner:n}}}class Wn extends Se{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=mt.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||mt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const n of ze)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Qn=()=>{const e=it.empty();return e.occupied=new k(65535,0),e.promoted=k.empty(),e.white=new k(61680,0),e.black=new k(3855,0),e.pawn=k.empty(),e.knight=new k(6168,0),e.bishop=new k(9252,0),e.rook=new k(16962,0),e.queen=new k(129,0),e.king=new k(33024,0),e};class jn extends Se{constructor(){super("racingkings")}reset(){this.board=Qn(),this.pockets=void 0,this.turn="white",this.castles=Le.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=Le.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?Q.err(new X(ee.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let i=k.empty();for(const r of super.dests(t,n)){const a={from:t,to:r},l=this.clone();l.play(a),l.isCheck()||(i=i.with(r))}return i}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=k.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(pe(i)){const r=this.board.occupied.without(i);for(const a of Ve(i).intersect(t).diff(this.board.black))if(this.kingAttackers(a,"white",r).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const n=k.fromRank(7),i=this.board.pieces("black","king").intersects(n),r=this.board.pieces("white","king").intersects(n);return i&&!r?{winner:"black"}:r&&!i?{winner:"white"}:{winner:void 0}}}const Fn=()=>{const e=it.empty();return e.occupied=new k(4294967295,4294901862),e.promoted=k.empty(),e.white=new k(4294967295,102),e.black=new k(0,4294901760),e.pawn=new k(4294967295,16711782),e.knight=new k(0,1107296256),e.bishop=new k(0,603979776),e.rook=new k(0,2164260864),e.queen=new k(0,134217728),e.king=new k(0,268435456),e};class Hn extends Se{constructor(){super("horde")}reset(){this.board=Fn(),this.pockets=void 0,this.turn="white",this.castles=Le.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new X(ee.Empty));if(this.board.king.size()!==1)return Q.err(new X(ee.Kings));const t=this.board.kingOf(j(this.turn));if(pe(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return Q.err(new X(ee.OppositeCheck));for(const n of ze){const i=this.board.pieces(n,"king").isEmpty()?k.backrank(j(n)):k.backranks();if(this.board.pieces(n,"pawn").intersects(i))return Q.err(new X(ee.PawnsOnBackrank))}return Q.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const n=m=>m==="light"?"dark":"light",i=m=>m==="light"?k.lightSquares():k.darkSquares(),r=m=>{const p=this.board.pieces(m,"bishop");return p.intersects(k.darkSquares())&&p.intersects(k.lightSquares())},a=vt.fromBoard(this.board,t),l=m=>i(m).intersect(this.board.pieces(t,"bishop")).size(),d=l("light")>=1?"light":"dark",o=a.pawn+a.knight+a.rook+a.queen+Math.min(l("dark"),2)+Math.min(l("light"),2),s=vt.fromBoard(this.board,j(t)),u=m=>i(m).intersect(this.board.pieces(j(t),"bishop")).size(),g=s.size(),$=m=>g-m;if(o===0)return!0;if(o>=4||(a.pawn>=1||a.queen>=1)&&o>=2||a.rook>=1&&o>=2&&!(o===2&&a.rook===1&&a.bishop===1&&$(u(d))===1))return!1;if(o===1){if(g===1)return!0;if(a.queen===1)return!(s.pawn>=1||s.rook>=1||u("light")>=2||u("dark")>=2);if(a.pawn===1){const m=this.board.pieces(t,"pawn").last(),p=this.clone();p.board.set(m,{color:t,role:"queen"});const C=this.clone();return C.board.set(m,{color:t,role:"knight"}),p.hasInsufficientMaterial(t)&&C.hasInsufficientMaterial(t)}else{if(a.rook===1)return!(s.pawn>=2||s.rook>=1&&s.pawn>=1||s.rook>=1&&s.knight>=1||s.pawn>=1&&s.knight>=1);if(a.bishop===1)return!(u(n(d))>=2||u(n(d))>=1&&s.pawn>=1||s.pawn>=2);if(a.knight===1)return!(g>=4&&(s.knight>=2||s.pawn>=2||s.rook>=1&&s.knight>=1||s.rook>=1&&s.bishop>=1||s.knight>=1&&s.bishop>=1||s.rook>=1&&s.pawn>=1||s.knight>=1&&s.pawn>=1||s.bishop>=1&&s.pawn>=1||r(j(t))&&s.pawn>=1)&&(u("dark")<2||$(u("dark"))>=3)&&(u("light")<2||$(u("light"))>=3))}}else{if(o===2)return g===1?!0:a.knight===2?s.pawn+s.bishop+s.knight<1:r(t)?!(s.pawn>=1||s.bishop>=1||s.knight>=1&&s.rook+s.queen>=1):a.bishop>=1&&a.knight>=1?!(s.pawn>=1||u(n(d))>=1||$(u(d))>=3):!(s.pawn>=1&&u(n(d))>=1||s.pawn>=1&&s.knight>=1||u(n(d))>=1&&s.knight>=1||u(n(d))>=2||s.knight>=2||s.pawn>=2);if(o===3)return a.knight===2&&a.bishop===1||a.knight===3||r(t)?!1:g===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const Vn=(e,t)=>{switch(e){case"chess":return xt.fromSetup(t);case"antichess":return Kn.fromSetup(t);case"atomic":return Gn.fromSetup(t);case"horde":return Hn.fromSetup(t);case"racingkings":return jn.fromSetup(t);case"kingofthehill":return Dn.fromSetup(t);case"3check":return Wn.fromSetup(t);case"crazyhouse":return Un.fromSetup(t)}},Yn=(e=at)=>({headers:e(),moves:new Ut});class Ut{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const n=t.children[0];yield n,t=n}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class Zn extends Ut{constructor(t){super(),this.data=t}}const Jn=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Xn=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,at=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),wt="\uFEFF",Qe=e=>/^\s*$/.test(e),je=e=>e.startsWith("%");class ei extends Error{}class ti{constructor(t,n=at,i=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Yn(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new ei("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let i=0;for(;;){const r=t.indexOf(`
`,i);if(r===-1)break;const a=r>i&&t[r-1]==="\r"?r-1:r;this.consumeBudget(r-i),this.lineBuf.push(t.slice(i,a)),i=r+1,this.handleLine()}this.consumeBudget(t.length-i),this.lineBuf.push(t.slice(i)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(wt)&&(n=n.slice(wt.length)),this.state=1;case 1:if(Qe(n)||je(n))return;this.found=!0,this.state=2;case 2:{if(je(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(r,a,l)=>(this.consumeBudget(200),this.handleHeader(a,l.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,t=!1,""));if(Qe(n))return;this.state=3}case 3:{if(t){if(je(n))return;if(Qe(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let r;for(;r=i.exec(n);){const a=this.stack[this.stack.length-1];let l=r[0];if(l===";")return;if(l.startsWith("$"))this.handleNag(parseInt(l.slice(1),10));else if(l==="!")this.handleNag(1);else if(l==="?")this.handleNag(2);else if(l==="!!")this.handleNag(3);else if(l==="??")this.handleNag(4);else if(l==="!?")this.handleNag(5);else if(l==="?!")this.handleNag(6);else if(l==="1-0"||l==="1–0"||l==="1—0"||l==="0-1"||l==="0–1"||l==="0—1"||l==="1/2-1/2"||l==="1/2–1/2"||l==="1/2—1/2"||l==="*")this.stack.length===1&&l!=="*"&&this.handleHeader("Result",l);else if(l==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(l===")")this.stack.length>1&&this.stack.pop();else if(l==="{"){const d=i.lastIndex,o=n[d]===" "?d+1:d;n=n.slice(o),this.state=4;continue e}else this.consumeBudget(100),l.startsWith("O")||l.startsWith("0")||l.startsWith("o")?l=l.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(l==="Z0"||l==="0000"||l==="@@@@")&&(l="--"),a.node&&(a.parent=a.node),a.node=new Zn({san:l,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const r=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,r)),this.handleComment(),n=n.slice(i),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?Jn(Xn(n)):n)}handleNag(t){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],r=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((t=i.node.data).comments||(t.comments=[]),i.node.data.comments.push(r)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(r)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(r))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const ni=(e,t=at)=>{const n=[];return new ti(i=>n.push(i),t,NaN).parse(e),n};var ii=f("<div class=modal-mask><dialog open><div class=close-button-anchor><button class=close-button data-icon=></button></div><div class=scrollable><div>");function Fe(e){return(()=>{var t=ii(),n=t.firstChild,i=n.firstChild,r=i.firstChild,a=i.nextSibling,l=a.firstChild;return t.$$click=()=>e.on_close(),n.$$click=d=>{d.stopPropagation()},r.$$click=()=>e.on_close(),h(l,()=>e.children),T(()=>J(l,"dialog-content "+e.klass)),t})()}Me(["click"]);const nt="ABCDEFGHIJKLMNOP".split(""),yt=e=>nt[e];function Ct(e){return Je(e.toSetup())}function si(e){return ni(e).map(t=>{let n=t.headers.get("Event"),i=t.headers.get("Site"),r=t.headers.get("White"),a=t.headers.get("Black"),l=t.headers.get("Chapter"),d=t.headers.get("Orientation"),o=t.headers.get("FEN"),s=o??Te,u=xt.fromSetup(Ze(s).unwrap()).unwrap(),g={},$={},m={};t.moves.children.forEach(C=>{p(C,u,0,"")});function p(C,v,b,O){let w=C.data.san,A=bn(v,w),I=v.clone();I.play(A);let K=kn(A),M=C.data.nags,D=g[O];D||(D=[],g[O]=D);let B=O.length===0?K:`${O} ${K}`;D.push({path:B,ply:b+1,before_fen:Ct(v),fen:Ct(I),uci:K,san:w}),M&&(m[B]=M),C.children.forEach(y=>{p(y,I,b+1,B)})}return{event:n,site:i,white:r,black:a,chapter:l,fen:o,orientation:d,flat_steps:g,flat_nags:m,flat_comments:$}})}var ri=f(`<div class="editor is2d"><div class=board-wrap></div><div class=tools-wrap><div class=metadata><div class=color><select><option value=white>White's Turn</option><option value=black>Black's Turn</option></select></div><div class=castling><strong>Castling</strong><div><label><input type=checkbox>White O-O</label><label><input type=checkbox>O-O-O</label></div><div><label><input type=checkbox>Black O-O</label><label><input type=checkbox>O-O-O</label></div></div><div class=enpassant><label for=enpassant-select>En passant</label><select id=enpassant-select><option value selected></option></select></div></div><div class=actions><button>Starting Position</button><button>Clear Board`),ai=f("<option>"),li=f('<div class="is2d chessboard"> '),oi=f("<div>"),ci=f("<div><div><div>");function di(e){const t=u=>[...u].reduce((g,$)=>{const m=parseInt($);return g+(m>=1?"x".repeat(m):$)},""),n=(u,g,$,m)=>{let p;for(;(p=g.exec(u))!=null;)m.add(p.index+$)},i=new Set,[r,a]=e.split(" "),l=r.split("/"),d=t(l[a==="w"?3:4]);n(d,/pP/g,a==="w"?0:1,i),n(d,/Pp/g,a==="w"?1:0,i);const[o,s]=i.size>=1?[t(l[a==="w"?1:6]),t(l[a==="w"?2:5])]:[null,null];return Array.from(i).filter(u=>o[u]==="x"&&s[u]==="x").map(u=>String.fromCharCode(97+u)+(a==="w"?"6":"3"))}const ui=e=>{const t=()=>Te,[n,i]=P(Te),[r,a]=P("white"),[l,d]=P(),o=["K","Q","k","q"],[s,u]=$n({Q:!1,K:!1,k:!1,q:!1}),g=E(()=>{let y="",S=s;return o.forEach(W=>{S[W]&&(y+=W)}),y}),$=E(()=>{let y=t(),S=n()??y;const W=Ze(S).unwrap(oe=>oe.board,oe=>it.empty()),ae=r(),le=wn(W,g()).unwrap();let ve=l()?st(l()):void 0;return{board:W,turn:ae,castlingRights:le,epSquare:ve,pockets:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:0}}),m=E(()=>Je($())),p=E(()=>Vn("chess",$()).unwrap(y=>Je(y.toSetup()),y=>{})),C=E(()=>di(m()));Ne(()=>{e.on_change_fen(p())});const v=y=>{ge(()=>{a(y.turn),d(y.epSquare?Mn(y.epSquare):void 0);let S=Le.fromSetup(y);u("Q",S.rook.white.a!==void 0),u("K",S.rook.white.h!==void 0),u("q",S.rook.black.a!==void 0),u("k",S.rook.black.h!==void 0)})},b=y=>{Ze(y).unwrap(S=>(ge(()=>{i(y),v(S)}),!0),S=>!1)};b(e.initial_fen);const[O,w]=P("pointer"),A=Et(O),[I,K]=P(),M=(y,S)=>{if(w(y),y!=="pointer"){if(y!=="trash"){let[W,ae]=y.split(" ");K([W,ae,S])}}},D=E(()=>{let y,S;switch(O()){case"pointer":S="pointer";break;case"trash":y="/cursors/trash.cur";break;default:y=`/cursors/${O().split(" ").join("-")}.cur`}if(S)return{cursor:S};if(y)return{cursor:`url('${y}'), default`}}),B=()=>{let[y,S]=O().split(" ");w(`${kt(y)} ${S}`)};return(()=>{var y=ri(),S=y.firstChild,W=S.nextSibling,ae=W.firstChild,le=ae.firstChild,ve=le.firstChild,oe=ve.firstChild,q=oe.nextSibling,z=le.nextSibling,te=z.firstChild,Y=te.nextSibling,se=Y.firstChild,be=se.firstChild,ie=se.nextSibling,ue=ie.firstChild,ke=Y.nextSibling,he=ke.firstChild,ce=he.firstChild,xe=he.nextSibling,ye=xe.firstChild,Ue=z.nextSibling,Ge=Ue.firstChild,Oe=Ge.nextSibling;Oe.firstChild;var Ke=ae.nextSibling,qe=Ke.firstChild,De=qe.nextSibling;return h(y,c(St,{klass:"spare-top",get color(){return kt(e.orientation)},on_spare:M,is_selected:A}),S),h(S,c(hi,{on_set_spare:w,on_toggle_spare:B,get spare(){return O()},get orientation(){return e.orientation},on_change_fen:i,get drag_new_piece(){return I()},get fen(){return n()}})),h(y,c(St,{klass:"spare-bottom",get color(){return e.orientation},on_spare:M,is_selected:A}),W),$e(ve,"change",U=>a(U.target.value)),be.addEventListener("change",U=>u("K",U.target.checked)),ue.addEventListener("change",U=>u("Q",U.target.checked)),ce.addEventListener("change",U=>u("k",U.target.checked)),ye.addEventListener("change",U=>u("q",U.target.checked)),Oe.addEventListener("change",U=>d(U.target.value)),h(Oe,c(we,{get each(){return C()},children:U=>(()=>{var Ce=ai();return Ce.value=U,h(Ce,U),Ce})()}),null),qe.$$click=()=>b(Te),De.$$click=()=>b(Sn),T(U=>{var Ce=D(),Ee=r()==="white",Pe=r()==="black";return U.e=Lt(y,Ce,U.e),Ee!==U.t&&(oe.selected=U.t=Ee),Pe!==U.a&&(q.selected=U.a=Pe),U},{e:void 0,t:void 0,a:void 0}),T(()=>be.checked=s.K),T(()=>ue.checked=s.Q),T(()=>ce.checked=s.k),T(()=>ye.checked=s.q),y})()};function hi(e){const t=()=>{e.on_change_fen(i.getFen())};let n,i;return Ie(()=>{let r={fen:e.fen,orientation:e.orientation,autoCastle:!1,movable:{free:!0,color:"both"},draggable:{showGhost:!0,deleteOnDropOff:!0},premovable:{enabled:!1},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:t}};i=An(n,r);const a=o=>{let s=e.spare;s!=="pointer"&&o.preventDefault();const u=$t(o);if(!u)return;let g=i.getKeyAtDomPos(u);if(g){if(s==="trash")l(g);else if(s!=="pointer"){const $=i.state.pieces.get(g);let[m,p]=s.split(" "),C={color:m,role:p};$&&$.color===C.color&&$.role===C.role?l(g):(i.setPieces(new Map([[g,C]])),t())}}},l=o=>{i.setPieces(new Map([[o,void 0]])),t()},d=o=>{let s=e.spare;s!=="pointer"&&o.preventDefault(),s!=="pointer"&&(i.state.drawable.current=void 0,i.state.drawable.shapes=[],o.type==="contextmenu"&&s!=="trash"&&(i.cancelMove(),e.on_toggle_spare()))};n.addEventListener("mousedown",a),n.addEventListener("contextmenu",d),Ae(()=>{n.removeEventListener("mousedown",a),n.removeEventListener("contextmenu",d)})}),Ne(()=>{i.set({fen:e.fen})}),Ne(()=>{i.set({orientation:e.orientation})}),Ne(()=>{let r=e.drag_new_piece;r&&(zn(i.state,{color:r[0],role:r[1]},r[2],!0),document.addEventListener("mouseup",a=>{const l=$t(a);l&&i.getKeyAtDomPos(l)&&e.on_set_spare("pointer")},{once:!0}))}),(()=>{var r=li();return Re(a=>n=a,r),r})()}const St=e=>{const t=e.is_selected;return(()=>{var n=oi();return h(n,c(He,{onClick:i=>e.on_spare("pointer",i),klass:"pointer",spare:"pointer",get selected(){return t("pointer")},get color(){return e.color}}),null),h(n,c(we,{each:yn,children:i=>c(He,{onClick:r=>e.on_spare(`${e.color} ${i}`,r),klass:"",get spare(){return`${e.color} ${i}`},get selected(){return t(`${e.color} ${i}`)},get color(){return e.color}})}),null),h(n,c(He,{onClick:i=>e.on_spare("trash",i),klass:"trash",spare:"trash",get selected(){return t("trash")},get color(){return e.color}}),null),T(()=>J(n,"spare "+e.klass+" "+e.color)),n})()},He=e=>(()=>{var t=ci(),n=t.firstChild,i=n.firstChild;return $e(t,"mousedown",e.onClick,!0),T(r=>{var a="no-square "+e.klass,l=!!e.selected,d="piece "+e.spare,o={[e.color]:!0};return a!==r.e&&J(t,r.e=a),l!==r.t&&t.classList.toggle("selected",r.t=l),d!==r.a&&J(i,r.a=d),r.o=Cn(i,o,r.o),r},{e:void 0,t:void 0,a:void 0,o:void 0}),t})();Me(["click","mousedown"]);var _i=f("<h2>Edit Opening"),fi=f('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Opening Name"minlength=3>'),gi=f("<div class=section><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),lt=f("<div class=filler>"),Gt=f('<div class="group buttons"><span class=split></span><button class=delete>Delete <i data-icon=>'),pi=f("<h2>Edit Chapter"),Kt=f('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Section Name"minlength=3>'),mi=f("<div class=group><div class=editor-wrap>"),vi=f("<div class=tabs-wrap><div class=tabs><div class=tab>Empty</div><div class=tab>Editor</div></div><div class=content>"),Dt=f("<div class=section><div class=group><label for=order>Set Order</label><select name=order id=order></select></div><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),bi=f('<div class="group buttons"><button class=delete>Delete <i data-icon=></i></button><span class=split></span><button class=create>Save Changes'),Wt=f("<option>"),ki=f("<h2>Edit Section"),$i=f("<div class=tabs><div>Empty</div><div>Import Lichess Study"),wi=f('<div class=group><label for=name>Import a Study from Lichess</label><input name=name id=name type=text placeholder="Lichess Study URL">'),yi=f("<div class=content>"),Ci=f("<button class=import>Import<i data-icon=>"),Si=f("<button class=loading disabled>Loading ...");function xi(e){const t=(l,d)=>{l==="Escape"&&(d.value=e.study.name)},n=l=>{let d=l.value;d.length<3&&(d="New Chapter",l.value=d),e.on_update_study({id:e.study.id,name:d})},i=()=>{e.on_delete_study()},r=l=>{e.on_update_study({id:e.study.id,orientation:l})},a=E(()=>e.study.orientation);return[_i(),(()=>{var l=fi(),d=l.firstChild,o=d.nextSibling;return o.addEventListener("change",s=>n(s.currentTarget)),o.$$keydown=s=>t(s.key,s.currentTarget),T(()=>o.value=e.study.name),l})(),(()=>{var l=gi(),d=l.firstChild,o=d.firstChild,s=o.nextSibling,u=s.firstChild,g=u.nextSibling;return s.addEventListener("change",$=>r($.currentTarget.value)),T($=>{var m=a()==="white",p=a()==="black";return m!==$.e&&(u.selected=$.e=m),p!==$.t&&(g.selected=$.t=p),$},{e:void 0,t:void 0}),l})(),lt(),(()=>{var l=Gt(),d=l.firstChild,o=d.nextSibling;return o.$$click=i,l})()]}function Ei(e){const t=(p,C)=>{p==="Escape"&&(C.value=e.chapter.name)},n=p=>{let C=p.value;C.length<3&&(C="New Chapter",p.value=C),e.on_edit_chapter({id:e.chapter.id,name:C})},i=p=>{let C=parseInt(p);e.on_order_chapter(C)},r=()=>{e.on_delete_chapter()},a=()=>{let p=o();p&&e.fen!==p&&e.on_change_root_fen(p)},l=p=>{e.on_edit_chapter({id:e.chapter.id,orientation:p})},d=E(()=>e.chapter.orientation),[o,s]=P(),[u,g]=P("editor"),$=Et(u),m=E(()=>o()??e.fen);return[pi(),(()=>{var p=Kt(),C=p.firstChild,v=C.nextSibling;return v.addEventListener("change",b=>n(b.currentTarget)),v.$$keydown=b=>t(b.key,b.currentTarget),T(()=>v.value=e.chapter.name),p})(),(()=>{var p=vi(),C=p.firstChild,v=C.firstChild,b=v.nextSibling,O=C.nextSibling;return v.$$click=()=>g("empty"),b.$$click=()=>g("editor"),h(O,c(x,{get when(){return u()==="editor"},get children(){var w=mi(),A=w.firstChild;return h(A,c(ui,{get initial_fen(){return m()},on_change_fen:s,get orientation(){return e.chapter.orientation??"white"}})),w}}),null),h(O,c(x,{get when(){return u()==="empty"},get children(){return[]}}),null),T(w=>{var A=!!$("empty"),I=!!$("editor");return A!==w.e&&v.classList.toggle("active",w.e=A),I!==w.t&&b.classList.toggle("active",w.t=I),w},{e:void 0,t:void 0}),p})(),(()=>{var p=Dt(),C=p.firstChild,v=C.firstChild,b=v.nextSibling,O=C.nextSibling,w=O.firstChild,A=w.nextSibling,I=A.firstChild,K=I.nextSibling;return b.addEventListener("change",M=>i(M.currentTarget.value)),h(b,c(we,{get each(){return[...Array(e.nb_chapters).keys()]},children:(M,D)=>(()=>{var B=Wt();return h(B,()=>D()+1),T(()=>B.selected=e.i_chapter===D()),T(()=>B.value=D()),B})()})),A.addEventListener("change",M=>l(M.currentTarget.value)),T(M=>{var D=d()==="white",B=d()==="black";return D!==M.e&&(I.selected=M.e=D),B!==M.t&&(K.selected=M.t=B),M},{e:void 0,t:void 0}),p})(),lt(),(()=>{var p=bi(),C=p.firstChild,v=C.nextSibling,b=v.nextSibling;return C.$$click=r,b.$$click=a,T(()=>b.disabled=m()===void 0),p})()]}function Li(e){const t=(v,b)=>{v==="Escape"&&(b.value=e.section.name)},n=v=>{let b=v.value;b.length<3&&(b="New Section",v.value=b),e.on_edit_section({id:e.section.id,name:b})},i=v=>{let b=nt.indexOf(v);e.on_order_section(b)},r=()=>{e.on_delete_section()},[a,l]=P("lichess"),[d,o]=P(""),s=E(()=>{let v=d().match(/\/study\/([a-zA-Z0-9]{8})\/?$/);return v?`https://lichess.org/api/study/${v[1]}.pgn`:void 0}),u=async v=>await fetch(v).then(b=>b.text()).then(b=>si(b)),[g]=xn(s,u),$=async()=>{let v=g();v&&e.on_import_pgns(v,e.section.name)},m=E(()=>s()===void 0),p=v=>{e.on_edit_section({id:e.section.id,orientation:v})},C=E(()=>e.section.orientation);return[ki(),(()=>{var v=Kt(),b=v.firstChild,O=b.nextSibling;return O.addEventListener("change",w=>n(w.currentTarget)),O.$$keydown=w=>t(w.key,w.currentTarget),T(()=>O.value=e.section.name),v})(),(()=>{var v=$i(),b=v.firstChild,O=b.nextSibling;return b.$$click=()=>l("empty"),O.$$click=()=>l("lichess"),T(w=>{var A="tab "+(a()==="empty"?"active":""),I="tab "+(a()==="lichess"?"active":"");return A!==w.e&&J(b,w.e=A),I!==w.t&&J(O,w.t=I),w},{e:void 0,t:void 0}),v})(),(()=>{var v=yi();return h(v,c(x,{get when(){return a()==="lichess"},get children(){var b=wi(),O=b.firstChild,w=O.nextSibling;return w.addEventListener("change",A=>o(A.target.value)),w.$$keyup=A=>o(A.currentTarget.value),T(()=>J(w,m()?"error":"success")),b}}),null),h(v,c(x,{get when(){return a()==="empty"},get children(){return[]}}),null),v})(),(()=>{var v=Dt(),b=v.firstChild,O=b.firstChild,w=O.nextSibling,A=b.nextSibling,I=A.firstChild,K=I.nextSibling,M=K.firstChild,D=M.nextSibling;return w.addEventListener("change",B=>i(B.currentTarget.value)),h(w,c(we,{get each(){return nt.slice(0,e.nb_sections)},children:(B,y)=>(()=>{var S=Wt();return S.value=B,h(S,B),T(()=>S.selected=e.i_section===y()),S})()})),K.addEventListener("change",B=>p(B.currentTarget.value)),T(B=>{var y=C()==="white",S=C()==="black";return y!==B.e&&(M.selected=B.e=y),S!==B.t&&(D.selected=B.t=S),B},{e:void 0,t:void 0}),v})(),lt(),(()=>{var v=Gt(),b=v.firstChild,O=b.nextSibling;return h(v,c(x,{get when(){return a()==="lichess"},get children(){return c(Ot,{get fallback(){return Si()},get children(){var w=Ci();return w.$$click=$,T(()=>w.disabled=g()===void 0),w}})}}),O),O.$$click=r,v})()]}Me(["keydown","click","keyup"]);var Qt=f('<main class="openings-show study"><div class=details-wrap></div><div class=board-wrap></div><div class=replay-wrap><div class=header></div></div><div class=sections-wrap></div><div class=tools-wrap>'),jt=f('<button class="feature practice"><i data-icon=>'),Oi=f("<h4>Take Quiz"),qi=f("<h4>Play Deathmatch"),Bi=f("<h4>Practice with the Computer"),Ni=f("<div class=practice-feature><div class=tabs><div>Practice</div></div><div>"),Pi=f("<span>Your turn."),Ti=f("<div class=info-wrap><div class=status></div><div class=info><p>Computer will follow the lines in the opening.</p><p>Moves will be hidden."),Ri=f('<div class="rematch-buttons buttons"><button class=end>End</button><button class=rematch>Rematch</button><button><i>'),Ii=f("<span>..."),Ft=f("<span>1 of 15"),Ht=f("<button class=retake>Re-take"),Ai=f("<p>You are given 15 random positions from the opening. Play the correct moves."),Vt=f("<div class=info-wrap><div class=status></div><div class=info>"),zi=f("<div class=quiz-history>"),Yt=f("<button class=start>Start"),Zt=f('<div class="quiz-buttons buttons">'),Mi=f("<div class=quiz-item>"),Ui=f("<p>You will play the moves from the opening. If you go out of book, game ends."),Gi=f("<a class=analyze data-icon=>Analyze on lichess"),Ki=f("<a class=copy-line data-icon=>Copy variation PGN"),Di=f('<a class="annotate has-sub-menu"data-icon=><i class=glyph-icon></i>Annotate Glyph'),Wi=f("<a class=delete data-icon=>Delete after this move"),Qi=f("<div class=context-sub-menu>"),ji=f("<a><i>"),Fi=f("<i data-icon=>"),Hi=f("<button class=new><i data-icon=></i><span>New Section"),Vi=f("<div class=sections-list><div class=header><span class=title></span><div class=tools></div></div><div class=list><div class=tools>"),ot=f("<i data-icon=>"),Yi=f("<button class=new><i data-icon=></i><span>New Chapter"),Zi=f('<div class="section active"><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis></span></div></div><div class=chapters-list><div class=list></div><div class=tools>'),Ji=f("<div><div class=title><span class=nth>."),Xi=f("<div class=section><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis>"),es=f("<div class=no-sections>No Sections yet."),ts=f("<div class=no-chapters>No Chapters yet."),ns=f("<div class=loading-chapters>Loading Chapters."),is=f("<div class=tabs><div><i data-icon=></i></div><div><i data-icon=>"),ss=f("<div class=settings><div class=group><label for=editable>Disable Edits</label><input id=editable type=checkbox>"),rs=f("<div class=export><button>Copy PGN</button><button>Export as PGN</button><button>Export to Lichess Study"),as=f("<div class=fen><h4>FEN"),ls=f("<div class=content>"),os=f("<div class=copy-input-text><input type=text readonly>"),cs=f("<span class=copied><i data-icon=>"),ds=f("<span><i data-icon=>"),us=f("<div class=loading>Loading");const Bs=()=>{const[e,{load_study:t}]=de();let n=En();return Xe(()=>t(n.id)),c(_s,me(()=>hs(e,n.id)))};function hs(e,t){let n=E(()=>e.studies[t]),i=E(()=>{let d=n()?.sections;return n()?.section_ids.map(o=>d.find(s=>s.id===o))}),r=E(()=>{let d=n(),o=d?.selected_section_id;if(o)return d?.sections.find(s=>s.id===o)}),a=E(()=>{let d=r();if(d)return d.chapter_ids.map(o=>e.chapters.list.find(s=>s.id===o)).filter(Boolean)}),l=E(()=>{let o=r()?.selected_chapter_id;if(o)return a()?.find(s=>s.id===o)});return{get study(){return n()},get selected_section(){return r()},get selected_chapter(){return l()},get sections(){return i()},get chapters(){return a()}}}function _s(e){const[,{reset_replay_tree:t,load_replay_tree:n,load_chapter:i,load_chapters:r}]=de(),[a,l]=P("show"),[,d]=rt();Xe(et(E(()=>e.selected_section?.id),s=>s&&d(()=>r(s)))),Xe(et(E(()=>e.selected_chapter?.id),s=>{d(s?()=>{i(s),n(s)}:()=>{t()})}));const o=s=>({...e,study:s});return c(Ot,{get fallback(){return c(Es,{})},get children(){return c(x,{get when(){return e.study},children:s=>[c(x,{get when(){return a()==="show"},get children(){return c(bs,me(()=>o(s()),{on_feature_practice:()=>l("practice")}))}}),c(x,{get when(){return a()==="practice"},get children(){return c(fs,me(()=>o(s()),{on_feature_practice_off:()=>l("show")}))}})]})}})}function fs(e){const[t,{goto_path:n,goto_path_force:i,goto_path_if_can:r,set_hide_after_path:a,add_child_san_to_success_or_error_path_no_save:l,set_write_enabled_replay_tree:d}]=de();d(!1);let o=qt(t);const[s,u]=P("practice"),g=q=>{q>0?r(o.get_next_path):r(o.get_prev_path)},[$,m]=P(),p=E(()=>$()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),C=q=>{q.key==="f"&&ge(()=>{m(j(p())),M(void 0),oe()})};Ie(()=>{document.addEventListener("keydown",C),Ae(()=>{document.removeEventListener("keydown",C)})});let v=E(()=>{let q=o.step_at_cursor_path;if(!q)return[];let z=q.nags?.[0];return z?At(q.step.uci,q.step.san,It(z)):[]});const b=async(q,z)=>{let Y=Pt(o.fen),se=Y.turn,be=Y.board.get(st(q)),ie=q+z;be.role==="pawn"&&(z[1]==="8"&&se==="white"||z[1]==="1"&&se==="black")&&(ie+="q");let ue=Tt(ie),ke=Rt(Y,ue);ae(ke)},O=E(()=>e.selected_chapter?.name??"[detached]"),w=q=>{r(q)},[A,I]=P(),[K,M]=P(),[D,B]=P(!1),y=E(()=>A()===void 0&&D()),S=E(()=>K()??p()),W=E(()=>[]),ae=async q=>{s()==="practice"&&le(q)},le=async q=>{let z=await l(q);if(z)if(z[0]==="error")i(z[1].step.path),I(setTimeout(()=>{ge(()=>{n(In(z[1].step.path)),I(void 0)})},600));else{ge(()=>{i(z[1].step.path),a(z[1].step.path)});let te=bt(t.replay_tree.steps_tree,z[1].step.path).filter(se=>!t.replay_tree.error_paths.includes(se.step.path));if(!te)return;let Y=tt(te);I(setTimeout(()=>{ge(()=>{i(Y.step.path),a(Y.step.path),I(void 0)})},600))}},ve=q=>{q!==void 0&&(M(q),a(void 0),i(""),oe())},oe=()=>{if(S()!==o.turn){let q=bt(t.replay_tree.steps_tree,t.replay_tree.cursor_path);if(q=q.filter(te=>!t.replay_tree.error_paths.includes(te.step.path)),!q||q.length===0)return;let z=tt(q);I(setTimeout(()=>{ge(()=>{i(z.step.path),a(z.step.path),I(void 0)})},500))}};return(()=>{var q=Qt(),z=q.firstChild,te=z.nextSibling,Y=te.nextSibling,se=Y.firstChild,be=Y.nextSibling;return h(z,c(Xt,me(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),$e(te,"wheel",Mt(g)),h(te,c(zt,{get orientation(){return S()},get shapes(){return v()},get movable(){return y()},get color(){return Bt(o.fen)},get fen(){return o.fen},get last_move(){return o.last_move},play_orig_key:b})),h(se,O),h(Y,c(Nt,{handle_goto_path:w,get replay_tree(){return t.replay_tree},lose_focus:!1,on_context_menu:()=>{},get features(){return(()=>{var ie=jt();return $e(ie,"click",e.on_feature_practice_off,!0),ie})()},get feature_content(){return(()=>{var ie=Ni(),ue=ie.firstChild,ke=ue.firstChild,he=ue.nextSibling;return ke.$$click=()=>u("practice"),h(he,c(x,{get when(){return s()==="quiz"},get children(){return[Oi(),c(ms,{get nodes(){return W()}})]}}),null),h(he,c(x,{get when(){return s()==="deathmatch"},get children(){return[qi(),c(vs,{})]}}),null),h(he,c(x,{get when(){return s()==="practice"},get children(){return[Bi(),c(gs,{get movable(){return y()},on_rematch:ve,get color(){return S()},set_movable:B})]}}),null),T(ce=>{var xe="feature tab"+(s()==="practice"?" active":""),ye="content "+s();return xe!==ce.e&&J(ke,ce.e=xe),ye!==ce.t&&J(he,ce.t=ye),ce},{e:void 0,t:void 0}),ie})()}}),null),h(be,c(Jt,me(e,{is_edits_disabled:!0}))),q})()}function gs(e){const[t,{goto_path:n,reload_replay_tree_with_cursor_path:i}]=de(),[,r]=rt(),a=o=>{if(o===void 0){r(()=>{i(t.replay_tree.cursor_path)});return}ge(()=>{r(()=>{i(""),e.on_rematch(o)})})},l=E(()=>e.color),d=E(()=>j(l()));return e.set_movable(!0),n(""),[(()=>{var o=Ti(),s=o.firstChild;return h(s,c(x,{get when(){return e.movable},get fallback(){return Ii()},get children(){return Pi()}})),o})(),(()=>{var o=Ri(),s=o.firstChild,u=s.nextSibling,g=u.nextSibling;return s.$$click=()=>a(),u.$$click=()=>a(l()),g.$$click=()=>a(d()),T(()=>J(g,`color ${d()}`)),o})()]}function ps(e){let[t,n]=P(void 0);return{step:e,get is_solved(){return t()},set is_solved(i){n(i)}}}function ms(e){let[t,n]=P([...Array(15).keys()]);const[i,r]=P("info");let l=E(Tn(t,()=>ps(tt(e.nodes))));return[(()=>{var d=Vt(),o=d.firstChild,s=o.nextSibling;return h(o,c(x,{get when(){return i()==="info"},children:"Press start"}),null),h(o,c(x,{get when(){return i()==="in-progress"},get children(){return Ft()}}),null),h(o,c(x,{get when(){return i()==="end"},get children(){return Ht()}}),null),h(s,c(x,{get when(){return i()==="info"},get children(){return Ai()}})),d})(),(()=>{var d=zi();return h(d,c(we,{get each(){return l()},children:(o,s)=>(()=>{var u=Mi();return h(u,()=>s()+1),u})()})),d})(),(()=>{var d=Zt();return h(d,c(x,{get when(){return i()==="info"},get children(){return Yt()}})),d})()]}function vs(){const[e,t]=P("info");return[(()=>{var n=Vt(),i=n.firstChild,r=i.nextSibling;return h(i,c(x,{get when(){return e()==="info"},children:"Press start"}),null),h(i,c(x,{get when(){return e()==="in-progress"},get children(){return Ft()}}),null),h(i,c(x,{get when(){return e()==="end"},get children(){return Ht()}}),null),h(r,c(x,{get when(){return e()==="info"},get children(){return Ui()}})),n})(),(()=>{var n=Zt();return h(n,c(x,{get when(){return e()==="info"},get children(){return Yt()}})),n})()]}function bs(e){const[t,{goto_path:n,goto_path_if_can:i,delete_at_and_after_path:r,tree_step_node_set_nags:a,add_child_san_to_current_path:l,chapter_as_export_pgn:d,set_write_enabled_replay_tree:o}]=de();o(!e.study.is_edits_disabled);let s=qt(t),[u,g]=P(),[$,m]=P(!1),[p,C]=P(!1),[v,b]=P(!1),[O,w]=P(!1);const A=E(()=>{let _=u();if(_)return Ln(t.replay_tree.steps_tree,_)});Ie(()=>{const _=()=>{g(void 0)};document.addEventListener("click",_),Ae(()=>{document.removeEventListener("click",_)})});let I,K;const M=(_,L)=>{n(L),g(L);let R=_.clientX,F=_.clientY,H=K.getBoundingClientRect(),V=I.getBoundingClientRect();R-=V.left,F-=V.top,R=Math.min(R,document.body.clientWidth-H.width-V.left-20);let ne=`${F}px`,re=`${R}px`;K.style.top=ne,K.style.left=re},D=_=>{let L=_.fen;window.open(`https://lichess.org/analysis?fen=${L}`,"_blank"),g(void 0)},[,B]=rt(),y=async _=>{B(()=>{r(_)}),g(void 0)};let S;const W=_=>{clearTimeout(S),S=void 0,_===!1?S=setTimeout(()=>{m(!1)},150):S=setTimeout(()=>{m(!0)},100)},ae=async(_,L)=>{await a(_,[Pn(L)]),clearTimeout(S),m(!1)};let le,[ve,oe]=P(void 0);const q=E(()=>{let _=ve();if(K===void 0||_===void 0)return"";let L=le.getBoundingClientRect(),R=_.getBoundingClientRect(),F=K.getBoundingClientRect(),H=L.top,V=F.left-R.width,ne=I.getBoundingClientRect();return V-=ne.left,H-=ne.top,`top: ${H}px; left: ${V}px;`}),z=_=>{i(_)};let te=E(()=>{let _=s.step_at_cursor_path;if(!_)return[];let L=_.nags?.[0];return L?At(_.step.uci,_.step.san,It(L)):[]});const Y=E(()=>e.selected_chapter?.name??"[detached]"),se=E(()=>u()!==void 0||p()||v()!==void 0||O()!==void 0);let[,{create_section:be,create_chapter:ie}]=de();const ue=async(_,L)=>{let R=v()?e.selected_section:void 0;b(!1);let F=e.study.name,H={};Ee({id:e.study.id,is_edits_disabled:!0});for(let G of _){let N=G.event,[Z,_e,fe]=N.split(":");fe||(fe=_e,_e=L),H[_e]===void 0&&(H[_e]=[]),H[_e].push([fe,G]),F=Z}await dt({id:e.study.id,name:F});let V=Object.keys(H)[0];R&&await ct(e.study.id,{id:R.id,name:V});let ne,re=R;for(V of Object.keys(H)){R||(R=await be(e.study.id,V));let G=H[V];for(let[N,Z]of G)ne=await ie(e.study.id,R.id,N,Z);re=R,R=void 0}re&&ne&&(Ee({id:e.study.id,selected_section_id:re.id}),qe(e.study.id,{id:re.id,selected_chapter_id:ne.id}))},ke=()=>{};async function he(){return await Promise.all(e.sections.map(L=>Promise.all(L.chapter_ids.map(R=>t.chapters.list.find(F=>F.id===R)).map(R=>d(e.study.name,L.name,R))).then(R=>R.join(`

`)))).then(L=>L.join(`


`))}const ce=async()=>{let _=await he();Ls(_,`${e.study.name}.pgn`)},xe=async()=>{let _=await d(e.study.name,e.selected_section.name,e.selected_chapter);navigator.clipboard.writeText(_)},ye=_=>{let L=Nn(t.replay_tree.steps_tree,_);navigator.clipboard.writeText(L),g(void 0)},Ue=_=>{_>0?i(s.get_next_path):i(s.get_prev_path)},Ge=E(()=>!e.study.is_edits_disabled),Oe=_=>e.sections.indexOf(_),Ke=_=>e.chapters.indexOf(_),[,{update_section:qe,delete_section:De,update_chapter:U,delete_chapter:Ce,update_study:Ee,delete_study:Pe,order_sections:tn,order_chapters:nn,change_root_fen:sn}]=de(),ct=qe,rn=(_,L)=>{De(_,L),b(!1)},an=(_,L,R)=>{R.orientation&&ut(void 0),U(_,L,R)},ln=_=>{ge(()=>{Ce(e.study.id,e.selected_section.id,_),w(!1)})},dt=Ee,on=On(),cn=async _=>{await Pe(_),on("/openings")},dn=(_,L)=>{tn(_.study_id,_.id,L)},un=(_,L)=>{nn(e.study.id,_.section_id,_.id,L)},hn=async _=>{await sn(e.selected_chapter.id,_),w(!1)},_n=async(_,L)=>{let F=Pt(s.fen),H=F.turn,V=F.board.get(st(_)),ne=_+L;V.role==="pawn"&&(L[1]==="8"&&H==="white"||L[1]==="1"&&H==="black")&&(ne+="q");let re=Tt(ne),G=Rt(F,re),N=await l(G);n(N.step.path)},[fn,ut]=P(),ht=E(()=>fn()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),_t=_=>{_.key==="f"&&ut(j(ht()))};return Ie(()=>{document.addEventListener("keydown",_t),Ae(()=>{document.removeEventListener("keydown",_t)})}),(()=>{var _=Qt(),L=_.firstChild,R=L.nextSibling,F=R.nextSibling,H=F.firstChild,V=F.nextSibling,ne=V.nextSibling,re=I;return typeof re=="function"?Re(re,_):I=_,h(L,c(Xt,me(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),$e(R,"wheel",Mt(Ue)),h(R,c(zt,{get orientation(){return ht()},get shapes(){return te()},get movable(){return Ge()},get color(){return Bt(s.fen)},get fen(){return s.fen},get last_move(){return s.last_move},play_orig_key:_n})),h(H,Y),h(F,c(Nt,{handle_goto_path:z,get replay_tree(){return t.replay_tree},get lose_focus(){return se()},on_context_menu:M,get features(){return(()=>{var G=jt();return $e(G,"click",e.on_feature_practice,!0),G})()}}),null),h(V,c(Jt,me(e,{get is_edits_disabled(){return e.study.is_edits_disabled},on_edit_study:()=>C(!0),on_edit_section:()=>b(!0),on_edit_chapter:()=>w(!0)}))),h(ne,c(Ss,me(e,{get fen(){return s.fen},on_export_lichess:ke,on_export_pgn:ce,on_copy_pgn:xe}))),h(_,c(x,{get when(){return v()},get children(){return c(Fe,{klass:"edit-section",on_close:()=>b(!1),get children(){return c(Li,{get section(){return e.selected_section},get i_section(){return Oe(e.selected_section)},get nb_sections(){return e.sections.length},on_delete_section:()=>rn(e.study.id,e.selected_section.id),on_edit_section:G=>ct(e.study.id,G),on_order_section:G=>dn(e.selected_section,G),on_import_pgns:ue})}})}}),null),h(_,c(x,{get when(){return O()},get children(){return c(Fe,{klass:"edit-chapter",on_close:()=>w(!1),get children(){return c(Ei,{get fen(){return s.initial_fen},get nb_chapters(){return e.chapters.length},get chapter(){return e.selected_chapter},get i_chapter(){return Ke(e.selected_chapter)},on_edit_chapter:G=>an(e.study.id,e.selected_chapter.section_id,G),on_delete_chapter:()=>ln(e.selected_chapter.id),on_order_chapter:G=>un(e.selected_chapter,G),on_change_root_fen:hn})}})}}),null),h(_,c(x,{get when(){return p()},get children(){return c(Fe,{klass:"edit-study",on_close:()=>C(!1),get children(){return c(xi,{get study(){return e.study},on_delete_study:()=>cn(e.study.id),on_update_study:dt})}})}}),null),h(_,c(x,{get when(){return A()},children:G=>[c(qn,{get step(){return G().step},ref(N){var Z=K;typeof Z=="function"?Z(N):K=N},get children(){return[(()=>{var N=Gi();return N.$$click=()=>D(G().step),N})(),(()=>{var N=Ki();return N.$$click=()=>ye(G().step.path),N})(),c(x,{get when(){return!e.study.is_edits_disabled},get children(){return[(()=>{var N=Di();N.addEventListener("mouseenter",()=>W(!0)),N.addEventListener("mouseleave",()=>W(!1));var Z=le;return typeof Z=="function"?Re(Z,N):le=N,N})(),(()=>{var N=Wi();return N.$$click=()=>y(G().step.path),N})()]}})]}}),c(x,{get when(){return $()},get children(){var N=Qi();return Re(Z=>setTimeout(()=>oe(Z)),N),N.addEventListener("mouseenter",()=>W(!0)),N.addEventListener("mouseleave",()=>W(!1)),h(N,c(we,{each:Bn,children:(Z,_e)=>(()=>{var fe=ji(),gn=fe.firstChild;return fe.$$click=()=>ae(G(),Z),h(fe,()=>We[_e()],null),T(Be=>{var ft="annotate glyph "+We[_e()],gt=`glyph-icon ${We[_e()]}`;return ft!==Be.e&&J(fe,Be.e=ft),gt!==Be.t&&J(gn,Be.t=gt),Be},{e:void 0,t:void 0}),fe})()})),T(Z=>Lt(N,q(),Z)),N}})]}),null),_})()}function Jt(e){let[,{create_section:t,update_study:n}]=de();const i=async()=>{let a=await t(e.study.id);await r(a.id),e.on_edit_section?.()},r=a=>n({id:e.study.id,selected_section_id:a});return(()=>{var a=Vi(),l=a.firstChild,d=l.firstChild,o=d.nextSibling,s=l.nextSibling,u=s.firstChild;return h(d,()=>e.study.name),h(o,c(x,{get when(){return!e.is_edits_disabled},get children(){var g=Fi();return g.$$click=()=>e.on_edit_study?.(),g}})),h(s,c(we,{get each(){return e.sections},get fallback(){return c(ys,{})},children:(g,$)=>c(x,{get when(){return g===e.selected_section},get fallback(){return c(ws,{get is_edits_disabled(){return e.is_edits_disabled},section:g,get nth(){return yt($())},on_selected:()=>r(g.id),on_edit:()=>e.on_edit_section?.()})},get children(){return c(ks,me(e,{section:g,get is_edits_disabled(){return e.is_edits_disabled},get nth(){return yt($())},get on_edit(){return e.on_edit_section},get on_edit_chapter(){return e.on_edit_chapter}}))}})}),u),h(u,c(x,{get when(){return!e.is_edits_disabled},get children(){var g=Hi();return g.$$click=i,g}})),a})()}function ks(e){let[,{create_chapter:t,update_section:n}]=de();const i=async()=>{let a=await t(e.study.id,e.section.id);await r(a.id),e.on_edit_chapter?.()},r=async a=>n(e.study.id,{id:e.section.id,selected_chapter_id:a});return(()=>{var a=Zi(),l=a.firstChild,d=l.firstChild,o=d.firstChild,s=o.nextSibling,u=l.nextSibling,g=u.firstChild,$=g.nextSibling;return h(o,()=>e.nth),h(s,()=>e.section?.name),h(l,c(x,{get when(){return!e.is_edits_disabled},get children(){var m=ot();return m.$$click=()=>e.on_edit?.(),m}}),null),h(g,c(we,{get each(){return e.chapters},get fallback(){return c(Cs,{})},children:(m,p)=>c($s,{get is_edits_disabled(){return e.is_edits_disabled},chapter:m,get nth(){return`${e.nth}${p()+1}`},get selected(){return e.selected_chapter===m},on_selected:()=>r(m.id),on_edit:()=>e.on_edit_chapter?.()})})),h($,c(x,{get when(){return!e.is_edits_disabled},get children(){var m=Yi();return m.$$click=()=>i(),m}})),T(()=>Rn(s,"title",e.section?.name)),a})()}function $s(e){const t=E(()=>e.selected?" active":"");return(()=>{var n=Ji(),i=n.firstChild,r=i.firstChild,a=r.firstChild;return n.$$click=()=>e.on_selected(),h(r,()=>e.nth,a),h(i,()=>e.chapter.name,null),h(n,c(x,{get when(){return!e.is_edits_disabled},get children(){var l=ot();return l.$$click=()=>e.on_edit(),l}}),null),T(()=>J(n,"chapter"+t())),n})()}function ws(e){return(()=>{var t=Xi(),n=t.firstChild,i=n.firstChild,r=i.firstChild,a=r.nextSibling;return n.$$click=()=>e.on_selected(),h(r,()=>e.nth),h(a,()=>e.section.name),h(n,c(x,{get when(){return!e.is_edits_disabled},get children(){var l=ot();return l.$$click=()=>e.on_edit(),l}}),null),t})()}function ys(){return es()}function Cs(){return ts()}function Ns(){return ns()}function Xt(e){return[]}function Ss(e){const[,{update_study:t}]=de(),[n,i]=P("share"),[r,a]=P(!0,{equals:!1}),l=()=>{a(!0),e.on_copy_pgn()},d=e.study.is_edits_disabled,o=s=>t({id:e.study.id,is_edits_disabled:s});return[(()=>{var s=is(),u=s.firstChild,g=u.nextSibling;return u.$$click=()=>i("settings"),g.$$click=()=>i("share"),T($=>{var m="tab"+(n()==="settings"?" active":""),p="tab"+(n()==="share"?" active":"");return m!==$.e&&J(u,$.e=m),p!==$.t&&J(g,$.t=p),$},{e:void 0,t:void 0}),s})(),(()=>{var s=ls();return h(s,c(x,{get when(){return n()==="settings"},get children(){var u=ss(),g=u.firstChild,$=g.firstChild,m=$.nextSibling;return m.addEventListener("change",p=>o(p.currentTarget.checked)),m.checked=d,u}}),null),h(s,c(x,{get when(){return n()==="share"},get children(){return[(()=>{var u=rs(),g=u.firstChild,$=g.firstChild,m=g.nextSibling,p=m.nextSibling;return g.$$click=l,h(g,c(en,{get on_copy(){return r()}}),$),$e(m,"click",e.on_export_pgn,!0),$e(p,"click",e.on_export_lichess,!0),u})(),(()=>{var u=as();return u.firstChild,h(u,c(xs,{get value(){return e.fen}}),null),u})()]}}),null),s})()]}function xs(e){const[t,n]=P(!0,{equals:!1}),i=()=>{navigator.clipboard.writeText(e.value),n(!0)};return(()=>{var r=os(),a=r.firstChild;return r.$$click=i,h(r,c(en,{get on_copy(){return t()}}),null),T(()=>a.value=e.value),r})()}function en(e){Ne(et(()=>e.on_copy,()=>{n(!0),setTimeout(()=>n(!1),1e3)},{defer:!0}));const[t,n]=P(!1);return c(x,{get when(){return t()},get fallback(){return ds()},get children(){return cs()}})}function Es(){return us()}function Ls(e,t){const n=new Blob([e],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(n),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}Me(["click"]);export{$s as ChapterComponent,Ns as LoadingChapters,Cs as NoChapters,ys as NoSections,Bs as default};
