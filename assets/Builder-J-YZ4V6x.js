import{_ as Y,H as L,c as w,g as b,J as Z,a as M,m as H,K as ee,L as D,N as R,O,Q as te,T as re,x as B,r as ne,n as k,b as K,t as x,I as T,U as se,V as ae,W as le,v as ie,d as G,C as F,q as N,i as E,S as j,j as oe,k as ue,F as ce,X as de,Y as _e,Z as fe,D as J,o as pe,B as he,$ as ge,a0 as me,u as ye}from"./index-8svm6kxL.js";import{C as ve}from"./chessground-doaUGlzw.js";import{s as we}from"./scroll-DnAhRpRC.js";async function be(e){const n=await $e(e);function t(l){return n.transaction(e.store,l).objectStore(e.store)}function r(l){return new Promise((a,o)=>{const s=l();s.onsuccess=c=>a(c.target.result),s.onerror=c=>o(c.target.result)})}return{list:()=>r(()=>t("readonly").getAllKeys()),get:l=>r(()=>t("readonly").get(l)),getMany:l=>r(()=>t("readonly").getAll(l)),put:(l,a)=>r(()=>t("readwrite").put(a,l)),count:l=>r(()=>t("readonly").count(l)),remove:l=>r(()=>t("readwrite").delete(l)),clear:()=>r(()=>t("readwrite").clear()),cursor:(l,a)=>r(()=>t("readonly").openCursor(l,a)).then(o=>o??void 0),txn:l=>n.transaction(e.store,l)}}async function $e(e){const n=e?.db||`${e.store}--db`;return new Promise((t,r)=>{const l=window.indexedDB.open(n,e?.version??1);l.onsuccess=a=>t(a.target.result),l.onerror=a=>r(a.target.error??"IndexedDB Unavailable"),l.onupgradeneeded=a=>{const o=a.target.result,s=a.target.transaction,c=o.objectStoreNames.contains(e.store)?s.objectStore(e.store):o.createObjectStore(e.store);e.upgrade?.(a,c)}})}async function ke(e){let n;await Se({on_received:a,on_status(h){h&&(h.download&&e.on_downloaded_nb(h.download),h.error&&e.on_engine_failed(h.error))},on_connected(h){n=h}}),t("uci");function t(h){n?.(h)}function r(h){c=h,m(),p()}function l(){return!!s&&!s.stop_requested}function a(h){const u=h.trim().split(/\s+/g);if(u[0]==="uciok")t("ucinewgame"),t("isready");else if(u[0]==="readyok")p();else if(!(u[0]==="id"&&u[1]==="name"))if(u[0]==="bestmove"){s&&g&&s.emit(g),s=void 0,p();return}else if(s&&!s.stop_requested&&u[0]==="info"){let _=0,f,y=1,S,q,P=!1,A,I=[];for(let $=1;$<u.length;$++)switch(u[$]){case"depth":_=parseInt(u[++$]);break;case"nodes":f=parseInt(u[++$]);break;case"multipv":y=parseInt(u[++$]);break;case"time":S=parseInt(u[++$]);break;case"score":P=u[++$]==="mate",A=parseInt(u[++$]),(u[$+1]==="lowerbound"||u[$+1]==="upperbound")&&(q=u[++$]);break;case"pv":I=u.slice(++$),$=u.length;break}if(P&&!A||(o<y&&(o=y),!L(f)||!L(S)||!L(P)||!L(A)))return;const U=s.ply%2===1?-A:A;if(q&&y===1)return;const W={moves:I,cp:P?void 0:U,mate:P?U:void 0,depth:_};y===1?g={fen:s.current_fen,depth:_,nodes:f,millis:S,cp:P?void 0:U,mate:P?U:void 0,pvs:[W]}:g&&(g.pvs.push(W),g.depth=Math.min(g.depth,_)),y===o&&g&&(s.emit(g),_>=40&&m())}else h&&!["Stockfish","id","option","info"].includes(u[0])&&console.warn(`SF: ${h}`)}let o=0,s,c,g;function p(){if(!s&&(s=c,c=void 0,s)){g=void 0,o=1,d("Threads",s.threads),d("Hash",s.hash_size||16),d("MultiPV",Math.max(1,s.multi_pv)),v&&v!==s.game_id&&t("ucinewgame"),v=s.game_id,t(["position fen",s.initial_fen,"moves",s.moves].join(" "));const[h,u]=Object.entries(s.search)[0];t(`go ${h} ${u}`)}}let i=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function d(h,u){u=u.toString(),i.get(h)!==u&&(t(`setoption name ${h} value ${u}`),i.set(h,u))}function m(){s&&!s.stop_requested&&(s.stop_requested=!0,t("stop"))}let v;return{start(h){r(h)},stop(){r()},destroy(){t("quit")},get state(){return l()?"computing":"idle"}}}async function Se(e){const n=i=>{e.on_status(i)},t=i=>{e.on_received(i)},r=i=>{e.on_connected(i)};let l=await Y(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),a=await new Promise((i,d)=>{l.default({wasmMemory:Ce(2560),onError:m=>d(new Error(m)),locateFile:m=>`stockfish/${m}`}).then(i).catch(d)}),o=await be({store:".aidchess.nnue"}).catch(()=>{}),s=[];for(let i=0;;i++){let d=a.getRecommendedNnue(i);if(!d||s.includes(d))break;s.push(d)}(await g(s)).forEach((i,d)=>a.setNnueBuffer(i,d)),a.onError=p(),a.listen=i=>t(i),r(i=>a.uci(i));async function g(i){return Promise.all(i.map(async d=>{let m=await o?.get(d).catch(()=>{});if(m&&m.byteLength>128*1024)return m;const v=new XMLHttpRequest;v.open("get",`stockfish/nnue/${d}`,!0),v.responseType="arraybuffer",v.onprogress=u=>n({download:{bytes:u.loaded,total:u.total}});const h=await new Promise((u,_)=>{v.onerror=()=>_(new Error(`fetch '${d}' failed: ${v.status}`)),v.onload=()=>{v.status/100===2?u(new Uint8Array(v.response)):_(new Error(`fetch '${d}' failed: ${v.status}`))},v.send()});return n(),o?.put(d,h).catch(()=>console.warn("IDB store failed")),h}))}function p(){return i=>{if(i.startsWith("BAD_NNUE")&&o){const d=Math.max(0,Number(i.slice(9))),m=a.getRecommendedNnue(d);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${m} from IDB`),o.remove(m)},2e3)}else n({error:i})}}}const Ce=(e,n=32767)=>{let t=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:n})}catch(r){if(n<=e||!(r instanceof RangeError))throw r;n=Math.max(e,Math.ceil(n-n/t)),t=t===4?3:4}},Q=Z();function Ee(e){let n=async function(){let[t,r]=M(void 0),[l,a]=M(void 0),[o]=H(()=>ke({on_downloaded_nb(s){r(s)},on_engine_failed(s){a(s)}}));return{get download_nb(){return t()},get engine_failed(){return l()},get state(){let s=o();return o.loading||!s?"loading":s.state},async get_best_move(s,c,g,p,i){let d=u=>{},m=o();if(!m)return;let v=Math.max(1,navigator.hardwareConcurrency-2);return m.start({threads:v,hash_size:16,game_id:s,stop_requested:!1,path:[],search:{depth:i},multi_pv:p,ply:g,threatMode:!1,initial_fen:c,current_fen:c,moves:[],emit:ee(200,function(u){u.depth===i&&d(u)})}),new Promise(u=>{d=u})}}};return w(Q.Provider,{get value(){return n()},get children(){return b(()=>e.children)}})}var Me=x('<div class="is2d chessboard">');function xe(){let[e,n]=M(D.fromSetup(R(T).unwrap()).unwrap(),{equals:!1}),[t,r]=M(void 0),[l,a]=M(void 0),o=b(()=>O(e().toSetup())),s=b(()=>e().turn),c=b(()=>te(e()));const g=p=>{let i=e(),d=se(p),m=ae(i,d);i.play(d),B(()=>{r([p,m]),a([p,m]),n(i),p.length})};return{play_orig_key(p,i){let d=e(),m=s(),v=d.board.get(re(p)),h=p+i;v.role==="pawn"&&(i[1]==="8"&&m==="white"||i[1]==="1"&&m==="black")&&(h+="q"),g(h)},play_uci:g,set_fen_last_move(p,i){B(()=>{n(D.fromSetup(R(p).unwrap()).unwrap()),r(i)})},get dests(){return c()},get fen_last_move(){let p=o(),i=t();return i?[p,i]:void 0},get fen(){return o()},get last_move(){return t()},get add_last_move(){return l()},get check(){return e().isCheck()},get isEnd(){return e().isEnd()}}}function qe(e){let n,t;return ne(()=>{let r=e.color,l=e.play_uci.dests,a={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:r,free:!1,dests:l,events:{after:e.play_uci.play_orig_key}}};t=ve(n,a)}),k(()=>{let r,l;if(!e.play_uci.fen_last_move)r=T;else{let s;[r,[l,s]]=e.play_uci.fen_last_move}let a=[];l&&(a.push(l.slice(0,2)),a.push(l.slice(2,4)));let o=e.movable?e.color:void 0;t.set({fen:r,lastMove:a,turnColor:e.color,movable:{color:o,dests:e.play_uci.dests}})}),k(()=>{let r=e.orientation??"white";t.set({orientation:r})}),k(()=>{let r=e.play_uci.check;t.set({check:r})}),k(()=>{e.shapes?t.setAutoShapes(e.shapes):t.setAutoShapes([])}),(()=>{var r=Me();return K(l=>n=l,r),r})()}var Pe={equals:!1},Ne=Pe,z=class{#e;constructor(e=Map){this.#e=new e}dirty(e){this.#e.get(e)?.$$()}dirtyAll(){for(const e of this.#e.values())e.$$()}track(e){if(!le())return;let n=this.#e.get(e);if(n)n.n++;else{const[t,r]=M(void 0,Ne);this.#e.set(e,n={$:t,$$:r,n:1})}ie(()=>{n.n--===1&&queueMicrotask(()=>n.n===0&&this.#e.delete(e))}),n.$()}},C=Symbol("track-object"),je=class extends Map{#e=new z;#t=new z;[Symbol.iterator](){return this.entries()}constructor(e){if(super(),e)for(const n of e)super.set(...n)}get size(){return this.#e.track(C),super.size}*keys(){this.#e.track(C);for(const e of super.keys())yield e}*values(){this.#t.track(C);for(const e of super.values())yield e}*entries(){this.#e.track(C),this.#t.track(C);for(const e of super.entries())yield e}forEach(e,n){this.#e.track(C),this.#t.track(C),super.forEach(e,n)}has(e){return this.#e.track(e),super.has(e)}get(e){return this.#t.track(e),super.get(e)}set(e,n){const t=!super.has(e),r=super.get(e)!==n,l=super.set(e,n);return(r||t)&&B(()=>{t&&(this.#e.dirty(C),this.#e.dirty(e)),r&&(this.#t.dirty(C),this.#t.dirty(e))}),l}delete(e){const n=super.get(e)!==void 0,t=super.delete(e);return t&&B(()=>{this.#e.dirty(C),this.#t.dirty(C),this.#e.dirty(e),n&&this.#t.dirty(e)}),t}clear(){super.size&&(super.clear(),B(()=>{this.#e.dirtyAll(),this.#t.dirtyAll()}))}},Ae=x("<div class=replay-single><div class=moves>"),Be=x("<span class=index>"),De=x("<span><span class=san>"),Re=x("<span class=judgement>"),Te=x("<span class=eval>");const Ue=e=>D.fromSetup(R(e).unwrap()).unwrap().isEnd();function Le(e,n,t,r){let l=de(n,t),a=_e(l),o=O(n.toSetup());n.play(l);let s=O(n.toSetup());return{path:`${r} ${a}`,ply:e,before_fen:o,fen:s,uci:a,san:t}}function X(e,n,t){let r=n[n.length-1];return t||(t=D.fromSetup(R(r?.fen??T).unwrap()).unwrap()),[...n,Le((r?.ply??0)+1,t,e,r?.path??"")]}function V(e,n=T){let t=[],r=D.fromSetup(R(n).unwrap()).unwrap();for(let l of e)t=X(l,t,r);return t}function Fe(e,n){let t=ze({s:e,game_id:n}),[r,l]=M([]);const a=b(()=>{let _=r();return _[_.length-1]});let[o,s]=M(a()?.ply??0);const c=b(()=>{let _=o();return r().find(y=>y.ply===_)});let g=b(F(r,_=>_.san)),p=b(F(r,_=>_.ply)),i=b(()=>{let _=g(),f=p();return _.map((y,S)=>`${f[S]} ${y}`)});const d=_=>{s(_)},m=()=>{let _=o()-1;return p().find(f=>f===_)},v=()=>{let _=o()+1;return p().find(f=>f===_)},h=b(F(r,_=>t.request_step_with_search(_))),u=b(()=>{let _=h();return _[_.length-1]});return{set_sans(_){l(V(_)),s(_.length)},get sf_steps(){return h()},get last_sf_step(){return u()},get steps(){return r()},get plies(){return p()},get sans(){return g()},get ply_sans(){return i()},get ply_step(){return c()},get last_step(){return a()},get ply(){return o()},goto_ply:d,get_prev_ply:m,get_next_ply:v,goto_prev_ply_if_can(){let _=m();_!==void 0&&d(_),o()===1&&s(0)},goto_next_ply_if_can(){let _=v();_!==void 0&&d(_)},play_san(_){let f=a();if(!f){l(V([_]));return}let y=r();l(X(_,y)),s(f.ply+1)},get is_on_last_ply(){return o()===(a()?.ply??0)}}}function Oe(e){const n=b(F(()=>e.play_replay.ply_sans,o=>{let[s,c]=o.split(" ");return{ply:parseInt(s),san:c}})),t=o=>{e.play_replay.goto_ply(o)},r=b(()=>e.play_replay.ply_step?.ply);let l;k(N(n,o=>{if(o.length<7)return;let s=l.parentElement,c;if(e.play_replay.ply<3)c=0;else if(e.play_replay.is_on_last_ply)c=99999;else{let g=s.querySelector(".active");g&&(c=g.offsetTop-l.offsetHeight/2+g.offsetHeight/2)}c!==void 0&&s.scrollTo({behavior:"smooth",top:c})}));const a=o=>{let s=e.play_replay.sf_steps[o];return s?s.request_search()()?.judgement??"":""};return(()=>{var o=Ae(),s=o.firstChild;return K(c=>l=c,s),E(s,w(ce,{get each(){return n()},children:(c,g)=>[w(j,{get when(){return c.ply%2===1},get children(){var p=Be();return E(p,()=>Math.ceil(c.ply/2)),p}}),(()=>{var p=De(),i=p.firstChild;return p.$$click=()=>t(c.ply),E(i,()=>c.san),E(p,w(j,{get when(){return e.play_replay.sf_steps[g()]},children:d=>w(j,{get when(){return d().request_search()},children:m=>w(j,{get when(){return m()()},children:v=>w(He,{get ss(){return v()}})})})}),null),oe(()=>ue(p,"move "+a(g())+(c.ply===r()?" active":""))),p})()]})),o})()}const He=e=>{const n=()=>e.ss.search?.cp,t=()=>e.ss.judgement;return[w(j,{get when(){return n()},children:r=>(()=>{var l=Te();return E(l,()=>Ve(r())),l})()}),(()=>{var r=Re();return E(r,()=>We(t())),r})()]},Ie=(e,n,t)=>fe(J(e),n,t),We=e=>e==="good"?"✓":e==="inaccuracy"?"?!":e==="mistake"?"?":"??";function ze(e){let n=[];const t=(c,g,p,i,d)=>new Promise(m=>{n.push({fen:c,ply:g,game_id:p,multi_pv:i,depth:d,resolve_ev:m}),l()});let r;const l=async()=>{if(r||(r=n.pop(),!r))return;let{game_id:c,fen:g,ply:p,multi_pv:i,depth:d}=r,m=await e.s.get_best_move(c,g,p,i,d);r.resolve_ev(m),r=void 0,l()};let a={};const o=async(c,g,p,i,d)=>{let v=(h=>[c,g,i,h].join("$$"))(d);if(!a[v]){let h=Math.floor(Math.random()*3),u=await t(c,g,p,i,d+h);u&&(a[v]=u)}return a[v]};return{request_step_with_search:c=>{if(Ue(c.fen))return;let g=new je;function p(i){if(!i)return()=>{let u=[...g.values()];return u[u.length-1]?.()};let d=[i.depth,i.multi_pv,i.server].join("$$");if(g.get(d))return g.get(d);let{multi_pv:m,depth:v}=i,[h]=H(async()=>{let[u,_]=await Promise.all([o(c.before_fen,c.ply-1,e.game_id,m,v),o(c.fen,c.ply,e.game_id,m,v)]),f=Ie(c.before_fen,u,_),y=f<.03?"good":f<.05?"inaccuracy":f<.12?"mistake":"blunder";return{params:i,...c,before_search:u,search:_,judgement:y}});return g.set(d,h),h}return{request_search:p}}}}function Ve(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}G(["click"]);var Ke=x("<span class=info>Loading <!>%"),Ge=x("<span class=result>Game Over"),Je=x("<small class=drop>Evaluation Dropped Below -2"),Qe=x("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=result-wrap></div><div class=tools-wrap><button class=rematch>Rematch");const nt=()=>w(Ee,{get children(){return w(Xe,{})}});function Xe(){let[e]=H(()=>ye(Q));const n=b(()=>{let t=e()?.download_nb;if(t)return Math.ceil(t.bytes/(t.total===0?70*1024*1024:t.total)*100)});return w(j,{get when(){return e()},children:t=>w(j,{get when(){return t().state==="loading"},get fallback(){return w(Ye,{get s(){return t()}})},get children(){return[(()=>{var r=Ke(),l=r.firstChild,a=l.nextSibling;return a.nextSibling,E(r,()=>n()??"--",a),r})()," "]}})})}function Ye(e){const n=pe();n.setVolume(.2);let[t,r]=he([],"builder.current.sans");const a=Fe(e.s,"");let o=xe();const[s,c]=M("white"),g=b(()=>ge(s())),p={depth:8,multi_pv:1},i={depth:8,multi_pv:6};k(()=>{const f=a.last_sf_step;f&&k(N(f.request_search(i),y=>{if(!y||!y.search)return;if(J(y.fen)===g()){let q=y.search.pvs;o.play_uci(q[0].moves[0])}}))}),k(N(()=>o.add_last_move,f=>{f&&a.play_san(f[1])})),k(N(()=>a.sans,r)),k(N(()=>a.ply_step,f=>{f?o.set_fen_last_move(f.fen,[f.uci,f.san]):o.set_fen_last_move(T)})),k(N(()=>a.ply_step,(f,y)=>{f&&(!y||y.ply===f.ply-1)&&n.move(f)}));const d=we(f=>{const y=f.target;y.tagName!=="PIECE"&&y.tagName!=="SQUARE"&&y.tagName!=="CG-BOARD"||(f.preventDefault(),m(Math.sign(f.deltaY)))}),m=f=>{f>0?a.goto_next_ply_if_can():a.goto_prev_ply_if_can()},v=()=>!o.isEnd&&a.is_on_last_ply&&u()===void 0;a.set_sans(t()),a.sf_steps.forEach(f=>f?.request_search(p));const h=()=>{r([]),a.set_sans(t()),_(void 0)};k(N(()=>a.last_sf_step,f=>{f&&k(N(f.request_search(i),y=>{if(!y||!y.search)return;let S=y.search.cp??y.search.mate;S&&S<-200&&_("drop")}))}));const[u,_]=M(void 0);return(()=>{var f=Qe(),y=f.firstChild,S=y.nextSibling,q=S.firstChild,P=q.nextSibling,A=P.firstChild;return me(f,"wheel",d),E(y,w(qe,{get color(){return s()},get movable(){return v()},play_uci:o})),E(S,w(Oe,{play_replay:a}),q),E(q,w(j,{get when(){return u()==="drop"},get children(){return[Ge(),Je()]}})),A.$$click=h,f})()}G(["click"]);export{nt as default};
