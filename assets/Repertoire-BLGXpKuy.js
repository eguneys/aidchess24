var re=Object.defineProperty;var se=(o,t,e)=>t in o?re(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var M=(o,t,e)=>(se(o,typeof t!="symbol"?t+"":t,e),e);import{h as T,j as ae,k as le,i as _,c as h,S as oe,b as y,l as f,m as B,o as E,n as ie,f as R,g as ne,F as G,s as N,M as I,p as ce,e as _e,q as de,d as he,t as l}from"./index-B_QKkqnW.js";/* empty css                   */import{S as me}from"./studyrepo-DLuXUKtW.js";import{S as pe,C as ue}from"./Shalala-DpwkvLOr.js";import{T as ve,a as D,C as ge}from"./Chesstree2-BZ2kIyaZ.js";import{I as fe,M as $e}from"./chess_pgn_logic-BK7Cxuej.js";import{m as be}from"./index-DVgBeDVX.js";class H{constructor(t,e){M(this,"_solved_paths");this.study_name=t,this._solved_paths=be(T([[],[]]),{name:`.repertoire_stat.name.${t}.chapter.${e}`})}set solved_paths(t){this._solved_paths[1](t)}get solved_paths(){return this._solved_paths[0]()}}var we=l("<div class=progress><div class=bar></div><h3>"),ye=l("<div class=repertoire-wrap>"),Se=l("<small> Click on variations to expand. "),ke=l("<small> Your goal is to guess every move correctly to fill up the progress bar. "),Ce=l("<h2>Select a Practice Option"),xe=l("<button><span> Play all Moves "),Pe=l("<button><span> Play as Match "),Me=l("<h2>Play as Match"),Ee=l("<small> Try to guess the moves for <!>."),Re=l("<small> AI will play the next move, picking a random variation. "),Te=l("<small> Moves will be hidden once the game is started. "),Le=l("<div class=in_mode><button><span> Rematch </span></button><button class=end2><span> End Practice "),Ae=l("<h2>Play all moves"),Ie=l("<small>Try to guess the moves for both sides."),Ne=l("<small>Moves will be hidden once you start."),De=l("<div class=in_mode><button><span> Clear </span></button><button class=end2><span> End Practice "),Oe=l("<div class=repertoire><div class=list-wrap><h1 class=header>Repertoire</h1><div class=list><div><h3 class=title></h3></div><ul></ul></div></div><div class=board-wrap></div><div class=eval-gauge></div><div class=replay-wrap><div class=replay-header><div class=title><h5>Slav Defense</h5><h4></h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools></div></div></div><div class=under><br><br><br>"),je=l("<li><div><h3></h3> "),Fe=l("<div class=white><span class=fill>");const qe=["#afacc6","#0d2b45","#203c56","#544e68","#8d697a","#d08159","#ffaa5e","#ffd4a3","#ffecd6","#afacc6","#0d2b45","#203c56","#544e68","#8d697a","#d08159","#ffaa5e","#ffd4a3","#ffecd6","#afacc6","#0d2b45","#203c56","#544e68","#8d697a","#d08159","#ffaa5e","#ffd4a3","#ffecd6"],Ye=o=>qe[Math.floor((1-o)*23)]??"white";class Be{constructor(){M(this,"_mode");M(this,"_match_color");this._mode=T(void 0,{equals:!1}),this._match_color=T("white")}get mode(){return this._mode[0]()}set mode(t){this._mode[1](t)}get match_color(){return this._match_color[0]()}set match_color(t){this._match_color[1](t)}flip_match_color(){this.match_color=this.match_color==="white"?"black":"white"}}const K=o=>(()=>{var t=we(),e=t.firstChild,s=e.nextSibling;return _(s,()=>`%${o.width}`),R(d=>N(e,`width: ${o.width}%`,d)),t})();class Ge{constructor(t){this.chapters=t}get progress(){let t=this.chapters.length;return this.chapters.map(e=>Math.round(e.progress/t)).reduce((e,s)=>e+s)}}class S{constructor(t,e,s,d){this.study_name=t,this.i_chapter=e,this.score_tree=s,this.solved_paths=d}static load_from_store(t,e){let s=new H(t.name,e);return S.make(t.name,e,t.chapters[e].pgn.tree,D.set_for_saving(s.solved_paths))}static save_paths_to_store(t){let e=new H(t.study_name,t.i_chapter);e.solved_paths=t.solved_paths.get_for_saving()}static make(t,e,s,d=new D){return new S(t,e,$e.make(s),d)}get progress(){return Math.floor(this.solved_paths.expand_paths.map(t=>{var e;return((e=this.score_tree.get_at(t))==null?void 0:e.score)??0}).reduce((t,e)=>t+e,0)*100)}get progress_map(){let t=this.solved_paths.expand_paths,e=this.score_tree.progress_paths;const s=e.map(u=>u.map(m=>this.score_tree.get_at(m).score).reduce((m,w)=>m+w,0)),d=s.reduce((u,m)=>u+m,0);return e.map((u,m)=>{let w=u[u.length-1],$=s[m]/d,k=t.filter(g=>u.some(C=>C.join("")===g.join(""))).map(g=>this.score_tree.get_at(g).score).reduce((g,C)=>g+C,0);return{color:Ye($),total:$,done:k/$,path:w}}).reverse()}merge_and_save_stats(t){this.solved_paths.merge_dup(t.solved_paths),S.save_paths_to_store(this)}}const Ze=()=>{const o=ae(),[t]=le(o.id,me.read_study);return(()=>{var e=ye();return _(e,h(oe,{get when(){return!t.loading},fallback:"Loading...",get children(){return h(He,{get study(){return t()}})}})),e})()},He=o=>{const t=()=>o.study;let e=new Be,s=new pe;const[d,u]=T(0);let m=y(()=>{const r=t();return new Ge(r.chapters.map((i,b)=>S.load_from_store(r,b)))}),w=y(()=>m().chapters[d()]);const $=y(()=>t().chapters[d()]),p=y(()=>{e.mode;let r=$();return ve.make(r.pgn.tree.clone)});f(()=>{p().solved_paths.replace_all(w().solved_paths)});const k=y(()=>{let r=p().tree;return B(()=>S.make(t().name,d(),r,new D))});f(()=>{B(()=>k()).solved_paths.replace_all(p().solved_paths)}),f(E(()=>[k(),w()],(r,i)=>{if(i){let[b,L]=i;L.merge_and_save_stats(b)}})),f(()=>{let{mode:r,match_color:i}=e;r==="match"&&i==="black"&&setTimeout(()=>{p().reveal_one_random()},400)}),f(E(()=>s.add_uci,r=>{if(!r)return;p().try_next_uci_fail(r)&&e.mode==="match"&&setTimeout(()=>{p().reveal_one_random()},400)})),f(E(()=>p().fen_last_move,r=>{if(r){let[i,b]=r;s.on_set_fen_uci(i,b)}else s.on_set_fen_uci(fe)})),f(E(()=>s.on_wheel,r=>{r&&p().on_wheel(r)}));const g=r=>{r.key==="f"&&e.flip_match_color()};document.addEventListener("keypress",g),ie(()=>{document.removeEventListener("keypress",g)});const C=r=>{const i=r.target;i.tagName!=="PIECE"&&i.tagName!=="SQUARE"&&i.tagName!=="CG-BOARD"||(r.preventDefault(),s.set_on_wheel(Math.sign(r.deltaY)))};f(()=>{e.match_color=t().orientation??"white"});const Q=y(()=>k().progress_map);return(()=>{var r=Oe(),i=r.firstChild,b=i.firstChild,L=b.nextSibling,A=L.firstChild,U=A.firstChild,W=A.nextSibling,O=i.nextSibling,j=O.nextSibling,z=j.nextSibling,F=z.firstChild,q=F.firstChild,J=q.firstChild,V=J.nextSibling,X=q.nextSibling,Z=X.firstChild,ee=F.nextSibling,Y=ee.firstChild,te=Y.nextSibling;return r.addEventListener("wheel",C),_(U,()=>t().name),_(A,h(K,{get width(){return m().progress}}),null),_(W,h(G,{get each(){return t().chapters},children:(a,n)=>(()=>{var c=je(),v=c.firstChild,x=v.firstChild;return x.nextSibling,c.$$click=()=>u(n()),_(x,()=>a.name),_(v,h(K,{get width(){var P;return((P=m())==null?void 0:P.chapters[n()].progress)??0}}),null),R(()=>ne(c,n()===d()?"active":"")),c})()})),_(O,h(ue,{get orientation(){return e.match_color},get movable(){return e.mode!==void 0},get doPromotion(){return s.promotion},get onMoveAfter(){return s.on_move_after},get fen_uci(){return s.fen_uci},get color(){return s.turnColor},get dests(){return s.dests}})),_(j,h(G,{get each(){return Q()},children:a=>(()=>{var n=Fe(),c=n.firstChild;return n.$$click=v=>p().try_set_cursor_path(a.path),R(v=>{var x=`background: ${a.color}; height: ${a.total*100}%`,P=`background: ${a.color}; height: ${a.done*100}%`;return v.e=N(n,x,v.e),v.t=N(c,P,v.t),v},{e:void 0,t:void 0}),n})()})),_(V,()=>$().name),_(Y,h(ge,{get lala(){return p()}})),_(te,h(_e,{get children(){return[h(I,{get when(){return e.mode===void 0},get children(){return[Se(),ke(),Ce(),(()=>{var a=xe();return a.$$click=()=>e.mode="moves",a})(),(()=>{var a=Pe();return a.$$click=()=>e.mode="match",a})()]}}),h(I,{get when(){return e.mode==="match"},get children(){return[Me(),(()=>{var a=Ee(),n=a.firstChild,c=n.nextSibling;return c.nextSibling,_(a,()=>e.match_color,c),a})(),Re(),Te(),(()=>{var a=Le(),n=a.firstChild,c=n.nextSibling;return n.$$click=()=>{ce(()=>{e.mode="match",e.flip_match_color()})},c.$$click=()=>e.mode=void 0,a})()]}}),h(I,{get when(){return e.mode==="moves"},get children(){return[Ae(),Ie(),Ne(),(()=>{var a=De(),n=a.firstChild,c=n.nextSibling;return n.$$click=()=>{e.mode="moves"},c.$$click=()=>e.mode=void 0,a})()]}})]}})),R(()=>de(Z,"href",$().site)),r})()};he(["click"]);export{Ze as default};
