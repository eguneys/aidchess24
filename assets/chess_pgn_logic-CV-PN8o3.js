import{o as _t,a as jt}from"./index-CnSM4zMR.js";const tt=["a","b","c","d","e","f","g","h"],It=["1","2","3","4","5","6","7","8"],T=["white","black"],_=["pawn","knight","bishop","rook","queen","king"],Ht=["a","h"],V=s=>"role"in s,l=s=>s!==void 0,k=s=>s==="white"?"black":"white",z=s=>s>>3,w=s=>s&7,at=(s,t)=>0<=s&&s<8&&0<=t&&t<8?s+8*t:void 0,M=s=>{switch(s){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function S(s){switch(s.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function U(s){if(s.length===2)return at(s.charCodeAt(0)-97,s.charCodeAt(1)-49)}const N=s=>tt[w(s)]+It[z(s)],mt=s=>{if(s[1]==="@"&&s.length===4){const t=S(s[0]),e=U(s.slice(2));if(t&&l(e))return{role:t,to:e}}else if(s.length===4||s.length===5){const t=U(s.slice(0,2)),e=U(s.slice(2,4));let n;if(s.length===5&&(n=S(s[4]),!n))return;if(l(t)&&l(e))return{from:t,to:e,promotion:n}}},Ct=s=>V(s)?`${M(s.role).toUpperCase()}@${N(s.to)}`:N(s.from)+N(s.to)+(s.promotion?M(s.promotion):""),wt=(s,t)=>s==="white"?t==="a"?2:6:t==="a"?58:62,gt=(s,t)=>s==="white"?t==="a"?3:5:t==="a"?59:61,Rt=s=>(s=s-(s>>>1&1431655765),s=(s&858993459)+(s>>>2&858993459),Math.imul(s+(s>>>4)&252645135,16843009)>>24),ct=s=>(s=s>>>8&16711935|(s&16711935)<<8,s>>>16&65535|(s&65535)<<16),At=s=>(s=s>>>1&1431655765|(s&1431655765)<<1,s=s>>>2&858993459|(s&858993459)<<2,s=s>>>4&252645135|(s&252645135)<<4,ct(s));class o{constructor(t,e){this.lo=t|0,this.hi=e|0}static fromSquare(t){return t>=32?new o(0,1<<t-32):new o(1<<t,0)}static fromRank(t){return new o(255,0).shl64(8*t)}static fromFile(t){return new o(16843009<<t,16843009<<t)}static empty(){return new o(0,0)}static full(){return new o(4294967295,4294967295)}static corners(){return new o(129,2164260864)}static center(){return new o(402653184,24)}static backranks(){return new o(255,4278190080)}static backrank(t){return t==="white"?new o(255,0):new o(0,4278190080)}static lightSquares(){return new o(1437226410,1437226410)}static darkSquares(){return new o(2857740885,2857740885)}complement(){return new o(~this.lo,~this.hi)}xor(t){return new o(this.lo^t.lo,this.hi^t.hi)}union(t){return new o(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new o(this.lo&t.lo,this.hi&t.hi)}diff(t){return new o(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?o.empty():t>=32?new o(this.hi>>>t-32,0):t>0?new o(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?o.empty():t>=32?new o(0,this.lo<<t-32):t>0?new o(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new o(ct(this.hi),ct(this.lo))}rbit64(){return new o(At(this.hi),At(this.lo))}minus64(t){const e=this.lo-t.lo,n=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new o(e,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Rt(this.lo)+Rt(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new o(this.lo,this.hi|1<<t-32):new o(this.lo|1<<t,this.hi)}without(t){return t>=32?new o(this.lo,this.hi&~(1<<t-32)):new o(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new o(this.lo,this.hi^1<<t-32):new o(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new o(this.lo&this.lo-1,this.hi):new o(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;t!==0;){const n=31-Math.clz32(t&-t);t^=1<<n,yield n}for(;e!==0;){const n=31-Math.clz32(e&-e);e^=1<<n,yield 32+n}}*reversed(){let t=this.lo,e=this.hi;for(;e!==0;){const n=31-Math.clz32(e);e^=1<<n,yield 32+n}for(;t!==0;){const n=31-Math.clz32(t);t^=1<<n,yield n}}}const et=(s,t)=>{let e=o.empty();for(const n of t){const i=s+n;0<=i&&i<64&&Math.abs(w(s)-w(i))<=2&&(e=e.with(i))}return e},P=s=>{const t=[];for(let e=0;e<64;e++)t[e]=s(e);return t},Vt=P(s=>et(s,[-9,-8,-7,-1,1,7,8,9])),Zt=P(s=>et(s,[-17,-15,-10,-6,6,10,15,17])),Yt={white:P(s=>et(s,[7,9])),black:P(s=>et(s,[-7,-9]))},st=s=>Vt[s],nt=s=>Zt[s],J=(s,t)=>Yt[s][t],lt=P(s=>o.fromFile(w(s)).without(s)),ut=P(s=>o.fromRank(z(s)).without(s)),ft=P(s=>{const t=new o(134480385,2151686160),e=8*(z(s)-w(s));return(e>=0?t.shl64(e):t.shr64(-e)).without(s)}),dt=P(s=>{const t=new o(270549120,16909320),e=8*(z(s)+w(s)-7);return(e>=0?t.shl64(e):t.shr64(-e)).without(s)}),pt=(s,t,e)=>{let n=e.intersect(t),i=n.bswap64();return n=n.minus64(s),i=i.minus64(s.bswap64()),n.xor(i.bswap64()).intersect(t)},Jt=(s,t)=>pt(o.fromSquare(s),lt[s],t),Xt=(s,t)=>{const e=ut[s];let n=t.intersect(e),i=n.rbit64();return n=n.minus64(o.fromSquare(s)),i=i.minus64(o.fromSquare(63-s)),n.xor(i.rbit64()).intersect(e)},W=(s,t)=>{const e=o.fromSquare(s);return pt(e,ft[s],t).xor(pt(e,dt[s],t))},$=(s,t)=>Jt(s,t).xor(Xt(s,t)),bt=(s,t)=>W(s,t).xor($(s,t)),qt=(s,t,e)=>{switch(s.role){case"pawn":return J(s.color,t);case"knight":return nt(t);case"bishop":return W(t,e);case"rook":return $(t,e);case"queen":return bt(t,e);case"king":return st(t)}},Tt=(s,t)=>{const e=o.fromSquare(t);return ut[s].intersects(e)?ut[s].with(s):dt[s].intersects(e)?dt[s].with(s):ft[s].intersects(e)?ft[s].with(s):lt[s].intersects(e)?lt[s].with(s):o.empty()},Z=(s,t)=>Tt(s,t).intersect(o.full().shl64(s).xor(o.full().shl64(t))).withoutFirst();class Q{constructor(){}static default(){const t=new Q;return t.reset(),t}reset(){this.occupied=new o(65535,4294901760),this.promoted=o.empty(),this.white=new o(65535,0),this.black=new o(0,4294901760),this.pawn=new o(65280,16711680),this.knight=new o(66,1107296256),this.bishop=new o(36,603979776),this.rook=new o(129,2164260864),this.queen=new o(8,134217728),this.king=new o(16,268435456)}static empty(){const t=new Q;return t.clear(),t}clear(){this.occupied=o.empty(),this.promoted=o.empty();for(const t of T)this[t]=o.empty();for(const t of _)this[t]=o.empty()}clone(){const t=new Q;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of T)t[e]=this[e];for(const e of _)t[e]=this[e];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const e of _)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;const n=this.getRole(t),i=this.promoted.has(t);return{color:e,role:n,promoted:i}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const n=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class C{constructor(){}static empty(){const t=new C;for(const e of _)t[e]=0;return t}static fromBoard(t,e){const n=new C;for(const i of _)n[i]=t.pieces(e,i).size();return n}clone(){const t=new C;for(const e of _)t[e]=this[e];return t}equals(t){return _.every(e=>this[e]===t[e])}add(t){const e=new C;for(const n of _)e[n]=this[n]+t[n];return e}subtract(t){const e=new C;for(const n of _)e[n]=this[n]-t[n];return e}nonEmpty(){return _.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class v{constructor(t,e){this.white=t,this.black=e}static empty(){return new v(C.empty(),C.empty())}static fromBoard(t){return new v(C.fromBoard(t,"white"),C.fromBoard(t,"black"))}clone(){return new v(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new v(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new v(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class Y{constructor(t,e){this.white=t,this.black=e}static default(){return new Y(3,3)}clone(){return new Y(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}class zt{unwrap(t,e){const n=this._chain(i=>u.ok(t?t(i):i),i=>e?u.ok(e(i)):u.err(i));if(n.isErr)throw n.error;return n.value}map(t,e){return this._chain(n=>u.ok(t(n)),n=>u.err(e?e(n):n))}chain(t,e){return this._chain(t,e||(n=>u.err(n)))}}class te extends zt{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,e){return t(this.value)}}class ee extends zt{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,e){return e(this.error)}}var u;(function(s){s.ok=function(t){return new te(t)},s.err=function(t){return new ee(t||new Error)},s.all=function(t){if(Array.isArray(t)){const i=[];for(let r=0;r<t.length;r++){const h=t[r];if(h.isErr)return h;i.push(h.value)}return s.ok(i)}const e={},n=Object.keys(t);for(let i=0;i<n.length;i++){const r=t[n[i]];if(r.isErr)return r;e[n[i]]=r.value}return s.ok(e)}})(u||(u={}));var O;(function(s){s.Empty="ERR_EMPTY",s.OppositeCheck="ERR_OPPOSITE_CHECK",s.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",s.Kings="ERR_KINGS",s.Variant="ERR_VARIANT"})(O||(O={}));class F extends Error{}const se=(s,t,e,n)=>e[t].intersect($(s,n).intersect(e.rooksAndQueens()).union(W(s,n).intersect(e.bishopsAndQueens())).union(nt(s).intersect(e.knight)).union(st(s).intersect(e.king)).union(J(k(t),s).intersect(e.pawn)));class B{constructor(){}static default(){const t=new B;return t.castlingRights=o.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new o(14,0),h:new o(96,0)},black:{a:new o(0,234881024),h:new o(0,1610612736)}},t}static empty(){const t=new B;return t.castlingRights=o.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:o.empty(),h:o.empty()},black:{a:o.empty(),h:o.empty()}},t}clone(){const t=new B;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,n,i){const r=wt(t,e),h=gt(t,e);this.castlingRights=this.castlingRights.with(i),this.rook[t][e]=i,this.path[t][e]=Z(i,h).with(h).union(Z(n,r).with(r)).without(n).without(i)}static fromSetup(t){const e=B.empty(),n=t.castlingRights.intersect(t.board.rook);for(const i of T){const r=o.backrank(i),h=t.board.kingOf(i);if(!l(h)||!r.has(h))continue;const a=n.intersect(t.board[i]).intersect(r),c=a.first();l(c)&&c<h&&e.add(i,"a",h,c);const f=a.last();l(f)&&h<f&&e.add(i,"h",h,f)}return e}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const e of T)for(const n of Ht)this.rook[e][n]===t&&(this.rook[e][n]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(o.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class ne{constructor(t){this.rules=t}reset(){this.board=Q.default(),this.pockets=void 0,this.turn="white",this.castles=B.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=o.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=B.fromSetup(t),this.epSquare=ie(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,e,n){return se(t,e,this.board,n)}playCaptureAt(t,e){this.halfmoves=0,e.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[k(e.color)][e.promoted?"pawn":e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!l(e))return{king:e,blockers:o.empty(),checkers:o.empty(),variantEnd:t,mustCapture:!1};const n=$(e,o.empty()).intersect(this.board.rooksAndQueens()).union(W(e,o.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[k(this.turn)]);let i=o.empty();for(const h of n){const a=Z(e,h).intersect(this.board.occupied);a.moreThanOne()||(i=i.union(a))}const r=this.kingAttackers(e,k(this.turn),this.board.occupied);return{king:e,blockers:i,checkers:r,variantEnd:t,mustCapture:!1}}clone(){var t,e;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=(e=this.remainingChecks)===null||e===void 0?void 0:e.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(){if(this.board.occupied.isEmpty())return u.err(new F(O.Empty));if(this.board.king.size()!==2)return u.err(new F(O.Kings));if(!l(this.board.kingOf(this.turn)))return u.err(new F(O.Kings));const t=this.board.kingOf(k(this.turn));return l(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?u.err(new F(O.OppositeCheck)):o.backranks().intersects(this.board.pawn)?u.err(new F(O.PawnsOnBackrank)):u.ok(void 0):u.err(new F(O.Kings))}dropDests(t){return o.empty()}dests(t,e){if(e=e||this.ctx(),e.variantEnd)return o.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return o.empty();let i,r;if(n.role==="pawn"){i=J(this.turn,t).intersect(this.board[k(this.turn)]);const h=this.turn==="white"?8:-8,a=t+h;if(0<=a&&a<64&&!this.board.occupied.has(a)){i=i.with(a);const c=this.turn==="white"?t<16:t>=48,f=a+h;c&&!this.board.occupied.has(f)&&(i=i.with(f))}l(this.epSquare)&&oe(this,t,e)&&(r=o.fromSquare(this.epSquare))}else n.role==="bishop"?i=W(t,this.board.occupied):n.role==="knight"?i=nt(t):n.role==="rook"?i=$(t,this.board.occupied):n.role==="queen"?i=bt(t,this.board.occupied):i=st(t);if(i=i.diff(this.board[this.turn]),l(e.king)){if(n.role==="king"){const h=this.board.occupied.without(t);for(const a of i)this.kingAttackers(a,k(this.turn),h).nonEmpty()&&(i=i.without(a));return i.union(Ot(this,"a",e)).union(Ot(this,"h",e))}if(e.checkers.nonEmpty()){const h=e.checkers.singleSquare();if(!l(h))return o.empty();i=i.intersect(Z(h,e.king).with(h))}e.blockers.has(t)&&(i=i.intersect(Tt(t,e.king)))}return r&&(i=i.union(r)),i}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[k(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(o.darkSquares())||!this.board.bishop.intersects(o.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,e;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:re(this),remainingChecks:(e=this.remainingChecks)===null||e===void 0?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return T.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(V(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&o.backranks().has(t.to)?!1:this.dropDests(e).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&o.backranks().has(t.to)))return!1;const n=this.dests(t.from,e);return n.has(t.to)||n.has(he(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return l(t)&&this.kingAttackers(t,k(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:k(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const n of this.board[this.turn])e.set(n,this.dests(n,t));return e}play(t){const e=this.turn,n=this.epSquare,i=Kt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,e==="black"&&(this.fullmoves+=1),this.turn=k(e),V(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const r=this.board.take(t.from);if(!r)return;let h;if(r.role==="pawn"){this.halfmoves=0,t.to===n&&(h=this.board.take(t.to+(e==="white"?-8:8)));const a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(r.role=t.promotion,r.promoted=!!this.pockets)}else if(r.role==="rook")this.castles.discardRook(t.from);else if(r.role==="king"){if(i){const a=this.castles.rook[e][i];if(l(a)){const c=this.board.take(a);this.board.set(wt(e,i),r),c&&this.board.set(gt(e,i),c)}}this.castles.discardColor(e)}if(!i){const a=this.board.set(t.to,r)||h;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[e]=Math.max(this.remainingChecks[e]-1,0))}}class X extends ne{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(n=>e)}clone(){return super.clone()}}const ie=(s,t)=>{if(!l(t))return;const e=s.turn==="white"?5:2,n=s.turn==="white"?8:-8;if(z(t)!==e||s.board.occupied.has(t+n))return;const i=t-n;if(!(!s.board.pawn.has(i)||!s.board[k(s.turn)].has(i)))return t},re=s=>{if(!l(s.epSquare))return;const t=s.ctx(),n=s.board.pieces(s.turn,"pawn").intersect(J(k(s.turn),s.epSquare));for(const i of n)if(s.dests(i,t).has(s.epSquare))return s.epSquare},oe=(s,t,e)=>{if(!l(s.epSquare)||!J(s.turn,t).has(s.epSquare))return!1;if(!l(e.king))return!0;const n=s.turn==="white"?8:-8,i=s.epSquare-n;return s.kingAttackers(e.king,k(s.turn),s.board.occupied.toggle(t).toggle(i).with(s.epSquare)).without(i).isEmpty()},Ot=(s,t,e)=>{if(!l(e.king)||e.checkers.nonEmpty())return o.empty();const n=s.castles.rook[s.turn][t];if(!l(n)||s.castles.path[s.turn][t].intersects(s.board.occupied))return o.empty();const i=wt(s.turn,t),r=Z(e.king,i),h=s.board.occupied.without(e.king);for(const f of r)if(s.kingAttackers(f,k(s.turn),h).nonEmpty())return o.empty();const a=gt(s.turn,t),c=s.board.occupied.toggle(e.king).toggle(n).toggle(a);return s.kingAttackers(i,k(s.turn),c).nonEmpty()?o.empty():o.fromSquare(n)},Kt=(s,t)=>{if(V(t))return;const e=t.to-t.from;if(!(Math.abs(e)!==2&&!s.board[s.turn].has(t.to))&&s.board.king.has(t.from))return e>0?"h":"a"},he=(s,t)=>{const e=Kt(s,t);if(!e)return t;const n=s.castles.rook[s.turn][e];return{from:t.from,to:l(n)?n:t.to}},ae=(s,t)=>{const e=new Map,n=s.ctx();for(const[i,r]of s.allDests(n))if(r.nonEmpty()){const h=Array.from(r,N);i===n.king&&w(i)===4&&(r.has(0)?h.push("c1"):r.has(56)&&h.push("c8"),r.has(7)?h.push("g1"):r.has(63)&&h.push("g8")),e.set(N(i),h)}return e},ce="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",le=ce+" w KQkq -",Lt=le+" 0 1";var d;(function(s){s.Fen="ERR_FEN",s.Board="ERR_BOARD",s.Pockets="ERR_POCKETS",s.Turn="ERR_TURN",s.Castling="ERR_CASTLING",s.EpSquare="ERR_EP_SQUARE",s.RemainingChecks="ERR_REMAINING_CHECKS",s.Halfmoves="ERR_HALFMOVES",s.Fullmoves="ERR_FULLMOVES"})(d||(d={}));class m extends Error{}const ue=(s,t,e)=>{let n=s.indexOf(t);for(;e-- >0&&n!==-1;)n=s.indexOf(t,n+t.length);return n},D=s=>/^\d{1,4}$/.test(s)?parseInt(s,10):void 0,Ft=s=>{const t=S(s);return t&&{role:t,color:s.toLowerCase()===s?"black":"white"}},rt=s=>{const t=Q.empty();let e=7,n=0;for(let i=0;i<s.length;i++){const r=s[i];if(r==="/"&&n===8)n=0,e--;else{const h=parseInt(r,10);if(h>0)n+=h;else{if(n>=8||e<0)return u.err(new m(d.Board));const a=n+e*8,c=Ft(r);if(!c)return u.err(new m(d.Board));s[i+1]==="~"&&(c.promoted=!0,i++),t.set(a,c),n++}}}return e!==0||n!==8?u.err(new m(d.Board)):u.ok(t)},Nt=s=>{if(s.length>64)return u.err(new m(d.Pockets));const t=v.empty();for(const e of s){const n=Ft(e);if(!n)return u.err(new m(d.Pockets));t[n.color][n.role]++}return u.ok(t)},fe=(s,t)=>{let e=o.empty();if(t==="-")return u.ok(e);for(const n of t){const i=n.toLowerCase(),r=n===i?"black":"white",h=r==="white"?0:7;if("a"<=i&&i<="h")e=e.with(at(i.charCodeAt(0)-97,h));else if(i==="k"||i==="q"){const a=s[r].intersect(o.backrank(r)).intersect(s.rook.union(s.king)),c=i==="k"?a.last():a.first();e=e.with(l(c)&&s.rook.has(c)?c:at(i==="k"?7:0,h))}else return u.err(new m(d.Castling))}return T.some(n=>o.backrank(n).intersect(e).size()>2)?u.err(new m(d.Castling)):u.ok(e)},Pt=s=>{const t=s.split("+");if(t.length===3&&t[0]===""){const e=D(t[1]),n=D(t[2]);return!l(e)||e>3||!l(n)||n>3?u.err(new m(d.RemainingChecks)):u.ok(new Y(3-e,3-n))}else if(t.length===2){const e=D(t[0]),n=D(t[1]);return!l(e)||e>3||!l(n)||n>3?u.err(new m(d.RemainingChecks)):u.ok(new Y(e,n))}else return u.err(new m(d.RemainingChecks))},j=s=>{const t=s.split(/[\s_]+/),e=t.shift();let n,i=u.ok(void 0);if(e.endsWith("]")){const a=e.indexOf("[");if(a===-1)return u.err(new m(d.Fen));n=rt(e.slice(0,a)),i=Nt(e.slice(a+1,-1))}else{const a=ue(e,"/",7);a===-1?n=rt(e):(n=rt(e.slice(0,a)),i=Nt(e.slice(a+1)))}let r;const h=t.shift();if(!l(h)||h==="w")r="white";else if(h==="b")r="black";else return u.err(new m(d.Turn));return n.chain(a=>{const c=t.shift(),f=l(c)?fe(a,c):u.ok(o.empty()),p=t.shift();let b;if(l(p)&&p!=="-"&&(b=U(p),!l(b)))return u.err(new m(d.EpSquare));let g=t.shift(),E;l(g)&&g.includes("+")&&(E=Pt(g),g=t.shift());const A=l(g)?D(g):0;if(!l(A))return u.err(new m(d.Halfmoves));const x=t.shift(),H=l(x)?D(x):1;if(!l(H))return u.err(new m(d.Fullmoves));const y=t.shift();let R=u.ok(void 0);if(l(y)){if(l(E))return u.err(new m(d.RemainingChecks));R=Pt(y)}else l(E)&&(R=E);return t.length>0?u.err(new m(d.Fen)):i.chain(K=>f.chain(L=>R.map(q=>({board:a,pockets:K,turn:r,castlingRights:L,remainingChecks:q,epSquare:b,halfmoves:A,fullmoves:Math.max(1,H)}))))})},de=s=>{let t=M(s.role);return s.color==="white"&&(t=t.toUpperCase()),s.promoted&&(t+="~"),t},pe=s=>{let t="",e=0;for(let n=7;n>=0;n--)for(let i=0;i<8;i++){const r=i+n*8,h=s.get(r);h?(e>0&&(t+=e,e=0),t+=de(h)):e++,i===7&&(e>0&&(t+=e,e=0),n!==0&&(t+="/"))}return t},xt=s=>_.map(t=>M(t).repeat(s[t])).join(""),ke=s=>xt(s.white).toUpperCase()+xt(s.black),me=(s,t)=>{let e="";for(const n of T){const i=o.backrank(n);let r=s.kingOf(n);l(r)&&!i.has(r)&&(r=void 0);const h=s.pieces(n,"rook").intersect(i);for(const a of t.intersect(i).reversed())if(a===h.first()&&l(r)&&a<r)e+=n==="white"?"Q":"q";else if(a===h.last()&&l(r)&&r<a)e+=n==="white"?"K":"k";else{const c=tt[w(a)];e+=n==="white"?c.toUpperCase():c}}return e||"-"},we=s=>`${s.white}+${s.black}`,Dt=(s,t)=>[pe(s.board)+(s.pockets?`[${ke(s.pockets)}]`:""),s.turn[0],me(s.board,s.castlingRights),l(s.epSquare)?N(s.epSquare):"-",...s.remainingChecks?[we(s.remainingChecks)]:[],Math.max(0,Math.min(s.halfmoves,9999)),Math.max(1,Math.min(s.fullmoves,9999))].join(" "),ge=(s,t)=>{let e="";if(V(t))t.role!=="pawn"&&(e=M(t.role).toUpperCase()),e+="@"+N(t.to);else{const n=s.board.getRole(t.from);if(!n)return"--";if(n==="king"&&(s.board[s.turn].has(t.to)||Math.abs(t.to-t.from)===2))e=t.to>t.from?"O-O":"O-O-O";else{const i=s.board.occupied.has(t.to)||n==="pawn"&&w(t.from)!==w(t.to);if(n!=="pawn"){e=M(n).toUpperCase();let r;if(n==="king"?r=st(t.to).intersect(s.board.king):n==="queen"?r=bt(t.to,s.board.occupied).intersect(s.board.queen):n==="rook"?r=$(t.to,s.board.occupied).intersect(s.board.rook):n==="bishop"?r=W(t.to,s.board.occupied).intersect(s.board.bishop):r=nt(t.to).intersect(s.board.knight),r=r.intersect(s.board[s.turn]).without(t.from),r.nonEmpty()){const h=s.ctx();for(const a of r)s.dests(a,h).has(t.to)||(r=r.without(a));if(r.nonEmpty()){let a=!1,c=r.intersects(o.fromRank(z(t.from)));r.intersects(o.fromFile(w(t.from)))?a=!0:c=!0,c&&(e+=tt[w(t.from)]),a&&(e+=It[z(t.from)])}}}else i&&(e=tt[w(t.from)]);i&&(e+="x"),e+=N(t.to),t.promotion&&(e+="="+M(t.promotion).toUpperCase())}}return e},be=(s,t)=>{var e;const n=ge(s,t);return s.play(t),!((e=s.outcome())===null||e===void 0)&&e.winner?n+"#":s.isCheck()?n+"+":n},Gt=(s,t)=>be(s.clone(),t),vt=(s,t)=>{const e=s.ctx(),n=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let p;if(t==="O-O"||t==="O-O+"||t==="O-O#"?p="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(p="a"),p){const E=s.castles.rook[s.turn][p];return!l(e.king)||!l(E)||!s.dests(e.king,e).has(E)?void 0:{from:e.king,to:E}}const b=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!b)return;const g={role:b[1]?S(b[1]):"pawn",to:U(b[2])};return s.isLegal(g,e)?g:void 0}const i=n[1]?S(n[1]):"pawn",r=U(n[4]),h=n[5]?S(n[5]):void 0;if(!!h!==(i==="pawn"&&o.backranks().has(r))||h==="king"&&s.rules!=="antichess")return;let a=s.board.pieces(s.turn,i);i==="pawn"&&!n[2]?a=a.intersect(o.fromFile(w(r))):n[2]&&(a=a.intersect(o.fromFile(n[2].charCodeAt(0)-97))),n[3]&&(a=a.intersect(o.fromRank(n[3].charCodeAt(0)-49)));const c=i==="pawn"?o.fromFile(w(r)):o.empty();a=a.intersect(c.union(qt({color:k(s.turn),role:i},r,s.board.occupied)));let f;for(const p of a)if(s.dests(p,e).has(r)){if(l(f))return;f=p}if(l(f))return{from:f,to:r,promotion:h}},Ee=(s=Et)=>({headers:s(),moves:new St});class St{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const e=t.children[0];yield e,t=e}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class ye extends St{constructor(t){super(),this.data=t}}const Et=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Bt="\uFEFF",ot=s=>/^\s*$/.test(s),ht=s=>s.startsWith("%");class _e extends Error{}class Ce{constructor(t,e=Et,n=1e6){this.emitGame=t,this.initHeaders=e,this.maxBudget=n,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Ee(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new _e("ERR_PGN_BUDGET")}parse(t,e){if(!(this.budget<0))try{let n=0;for(;;){const i=t.indexOf(`
`,n);if(i===-1)break;const r=i>n&&t[i-1]==="\r"?i-1:i;this.consumeBudget(i-n),this.lineBuf.push(t.slice(n,r)),n=i+1,this.handleLine()}this.consumeBudget(t.length-n),this.lineBuf.push(t.slice(n)),e?.stream||(this.handleLine(),this.emit(void 0))}catch(n){this.emit(n)}}handleLine(){let t=!0,e=this.lineBuf.join("");this.lineBuf=[];t:for(;;)switch(this.state){case 0:e.startsWith(Bt)&&(e=e.slice(Bt.length)),this.state=1;case 1:if(ot(e)||ht(e))return;this.found=!0,this.state=2;case 2:{if(ht(e))return;let n=!0;for(;n;)n=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(i,r,h)=>(this.consumeBudget(200),this.game.headers.set(r,h.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),n=!0,t=!1,""));if(ot(e))return;this.state=3}case 3:{if(t){if(ht(e))return;if(ot(e))return this.emit(void 0)}const n=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let i;for(;i=n.exec(e);){const r=this.stack[this.stack.length-1];let h=i[0];if(h===";")return;if(h.startsWith("$"))this.handleNag(parseInt(h.slice(1),10));else if(h==="!")this.handleNag(1);else if(h==="?")this.handleNag(2);else if(h==="!!")this.handleNag(3);else if(h==="??")this.handleNag(4);else if(h==="!?")this.handleNag(5);else if(h==="?!")this.handleNag(6);else if(h==="1-0"||h==="0-1"||h==="1/2-1/2"||h==="*")this.stack.length===1&&h!=="*"&&this.game.headers.set("Result",h);else if(h==="(")this.consumeBudget(100),this.stack.push({parent:r.parent,root:!1});else if(h===")")this.stack.length>1&&this.stack.pop();else if(h==="{"){const a=n.lastIndex,c=e[a]===" "?a+1:a;e=e.slice(c),this.state=4;continue t}else this.consumeBudget(100),h==="Z0"||h==="0000"||h==="@@@@"?h="--":h.startsWith("0")&&(h=h.replace(/0/g,"O")),r.node&&(r.parent=r.node),r.node=new ye({san:h,startingComments:r.startingComments}),r.startingComments=void 0,r.root=!1,r.parent.children.push(r.node)}return}case 4:{const n=e.indexOf("}");if(n===-1){this.commentBuf.push(e);return}else{const i=n>0&&e[n-1]===" "?n-1:n;this.commentBuf.push(e.slice(0,i)),this.handleComment(),e=e.slice(n),this.state=3,t=!1}}}}handleNag(t){var e;this.consumeBudget(50);const n=this.stack[this.stack.length-1];n.node&&((e=n.node.data).nags||(e.nags=[]),n.node.data.nags.push(t))}handleComment(){var t,e;this.consumeBudget(100);const n=this.stack[this.stack.length-1],i=this.commentBuf.join(`
`);this.commentBuf=[],n.node?((t=n.node.data).comments||(t.comments=[]),n.node.data.comments.push(i)):n.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(i)):(n.startingComments||(n.startingComments=[]),n.startingComments.push(i))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Re=(s,t=Et)=>{const e=[];return new Ce(n=>e.push(n),t,NaN).parse(s),e},Ae=(s,t)=>s==="white"?t:-t,Ut=s=>2/(1+Math.exp(-.00368208*s))-1,Oe=s=>Ut(Math.min(Math.max(-1e3,s),1e3)),Ne=s=>{const e=(21-Math.min(10,Math.abs(s)))*100*(s>0?1:-1);return Ut(e)},Pe=s=>typeof s.mate<"u"?Ne(s.mate):Oe(s.cp),Mt=(s,t)=>Ae(s,Pe(t)),xe=(s,t,e)=>103.1668*Math.exp(-.04354*(Mt(s,t)*100-Mt(s,e)*100))-3.1669;class ve{async request_move_data(t,e){console.log(t,e);let n={cp:Math.random()*1e3},i={cp:n.cp-Math.random()*200},r=xe("white",n,i),h=Ie(e).slice(0,4);return{before_cp:n,after_cp:i,accuracy:r,multi_pvs4:h}}}const Be=new ve;function ze(s,t){let e=j(s).unwrap(),n=X.fromSetup(e).unwrap(),i=mt(t);return n.play(i),Dt(n.toSetup())}function Ke(s,t){let e=j(s).unwrap(),n=X.fromSetup(e).unwrap(),i=mt(t);return Gt(n,i)}const Me=s=>j(s).unwrap().turn;function Ie(s){let t=X.fromSetup(j(s).unwrap()).unwrap(),e=[];for(let[n,i]of ae(t))e.push(...i.map(r=>n+r));return e}class Qt{constructor(t,e){this.headers=t,this.tree=e}static make_many=t=>Re(t).flatMap(e=>{let n=e.headers.get("Event"),i=e.headers.get("Site"),r=e.headers.get("White"),h=e.headers.get("Black"),a=e.headers.get("Puzzle"),c=e.headers.get("Section"),f=e.headers.get("Chapter"),p=e.headers.get("FEN"),b=p??Lt,g=X.fromSetup(j(b).unwrap()).unwrap(),E=e.moves.children.map(y=>{let R=y.data.san,K=vt(g,R);return[Ct(K)]}),A=G.make(b,E);e.moves.children.forEach(y=>{x(A,y,g,[])});function x(y,R,K,L){let q=vt(K,R.data.san),yt=K.clone();yt.play(q);let it=Ct(q),Wt=R.data.nags;y.append_uci(it,L),y.set_nags([...L,it],Wt),R.children.forEach($t=>{x(y,$t,yt,[...L,it])})}return new Qt({event:n,site:i,white:r,black:h,puzzle:a,section:c,chapter:f,fen:p},A)});get event(){return this.headers.event}get site(){return this.headers.site}get white(){return this.headers.white}get black(){return this.headers.black}get puzzle(){return this.headers.puzzle}get section(){return this.headers.section}get chapter(){return this.headers.chapter}get fen(){return this.headers.fen}}class I{constructor(t){this.data=t,this._children=jt([])}static color_of(t){return Me(t.data.before_fen)}static make=t=>new I(t);get clone(){let t=new I({...this.data});return t.children=this.children.map(e=>e.clone),t}get all_leaves(){return this.children.length===0?[this]:this.children.flatMap(t=>t.all_leaves)}get length(){if(this.children.length>1)return 1;if(this.children.length===0)return 0;let t=1,e=this.children[0];for(;e?.children.length===1;)t++,e=e.children[0];return t}get nb_first_variations(){return this.children_first_variations?.length??0}get first_node_with_variations(){if(this.children.length!==0)return this.children.length===1?this.children[0].first_node_with_variations:this}get children_first_variations(){return this.first_node_with_variations?.children}get children(){return this._children[0]()}set children(t){this._children[1](t)}_children}class kt{constructor(t){this.root=t}static make=t=>{function e(a,c){let f=a.data.path.length,p=a.length,b=a.nb_first_variations,g=-c*100+1/(f/40)*10+p/20*10+(b+1)*100,E=I.make({path:a.data.path,uci:a.data.uci,score:g}),A=a.children.length+c,x=A*(A+1)/2;return E.children=a.children.map((H,y)=>e(H,(y+c)/x)),E}function n(a){return a.data.score+a.children.map(f=>n(f)).reduce((f,p)=>f+p,0)}function i(a,c){a.data.score/=c,a.children.forEach(f=>i(f,c))}let r=t.root.map(a=>e(a,1)),h=r.map(a=>n(a)).reduce((a,c)=>a+c,0);return r.forEach(a=>i(a,h)),new kt(r)};get clone(){return new kt(this.root.map(t=>t.clone))}get progress_paths(){function t(n,i,r){i.push(n.data.path),n.children.length===0?r.push(i):n.children.length===1?t(n.children[0],i,r):(r.push(i),n.children.forEach(h=>{t(h,[],r)}))}let e=[];return this.root.forEach(n=>t(n,[],e)),e}_traverse_path(t){let e,n=this.root;for(let i of t){if(e=n.find(r=>r.data.uci===i),!e)return;n=e.children}return e}get_children(t){return this._traverse_path(t)?.children.map(n=>n.data)}get_at(t){return this._traverse_path(t)?.data}delete_at(t){const e=this._traverse_path(t.slice(0,-1));e&&(e.children=e.children.filter(n=>n.data.path.join("")!==t.join("")))}}class G{constructor(t){this.root=t}static make=(t,e)=>{let n=e.map(r=>r[0]),i=new G(n.map(r=>I.make(G.make_data(t,r,1,[]))));return e.forEach(r=>i.append_ucis(r)),i};get before_fen(){return this.root[0]?.data.before_fen??Lt}get initial_color(){if(this.root[0])return I.color_of(this.root[0])}get clone(){return new G(this.root.map(t=>t.clone))}static make_data(t,e,n,i){let r=j(t).unwrap(),h=X.fromSetup(r).unwrap(),a=mt(e),c=Gt(h,a);return h.play(a),{path:[...i,e],ply:n,before_fen:t,san:c,after_fen:Dt(h.toSetup()),uci:e}}_traverse_path(t){let e,n=this.root;for(let i of t){if(e=n.find(r=>r.data.uci===i),!e)return;n=e.children}return e}_find_path(t){let e=[],n=[],i,r=this.root,h=!1;for(let a of t)if(h)n.push(a);else{let c=r?.find(f=>f.data.uci===a);c?(e.push(a),i=c,r=_t(()=>i?.children)):(h=!0,n.push(a))}return[e,i,n]}get all_leaves(){return this.root.flatMap(t=>t.all_leaves.map(e=>e.data))}get_children(t){return this._traverse_path(t)?.children.map(n=>n.data)}async request_ceval_and_get_at(t){let e=this.get_at(t);if(e)return e.eval_accuracy=await Be.request_move_data(e.before_fen,e.after_fen),e}collect_branch_sums(t){let e=[],n=this.root,i=this.root.length>1;for(let r of t){let h=n.find(a=>a.data.uci===r);if(!h)return;i&&(e.push(h.data),i=!1),h.children.length>1&&(i=!0),n=h.children}return e}get_at(t){return this._traverse_path(t)?.data}delete_at(t){const e=this._traverse_path(t.slice(0,-1));e&&(e.children=e.children.filter(n=>n.data.path.join("")!==t.join("")))}set_nags(t,e){let n=this._traverse_path(t);n&&(n.data.nags=e)}append_uci(t,e=[]){this.append_ucis([...e,t])}append_ucis(t){let[e,n,i]=this._find_path(t);if(n!==void 0)for(let r of i){let h=I.make(G.make_data(n.data.after_fen,r,n.data.ply+1,e)),a=_t(()=>n.children);n.children=[...a,h],n=h,e=[...e,r]}}}export{X as C,Lt as I,kt as M,Qt as P,ze as a,Ke as b,G as c,j as d,ae as e,Me as f,Dt as g,U as h,N as m,mt as p,z as s};
