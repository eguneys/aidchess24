import{m as fn,C as Ct,P as Ee,n as gt,o as Q,p as J,I as X,q as $,r as me,v as gn,R as pt,w as Ue,x as qe,y as Ve,z as F,B as mt,D as Ye,E as pn,G as nt,t as h,i as u,e as B,f as Z,d as Ge,H as Ze,J as Ie,K as mn,L as vn,N as Je,O as q,Q as bn,b as O,T as kn,U as it,j as Ne,V as St,c,W as xe,F as we,X as xt,Y as pe,Z as $n,_ as ze,$ as Me,a0 as Ae,a1 as wn,a2 as yn,a3 as Cn,k as E,l as Et,g as se,a4 as Sn,a5 as Xe,a6 as ve,a7 as et,a8 as Lt,a9 as Ot,aa as xn,u as En,ab as qt,ac as Bt,ad as Ln,ae as On,af as We,ag as qn,ah as Nt,ai as Pt,aj as Tt,ak as Rt,al as Bn,am as st,an as Nn,ao as Pn,s as Tn,ap as Rn}from"./index-Du8Yn6NK.js";import{o as vt,C as In,e as bt,d as An,a as It,P as At,b as zt,n as Mt}from"./random-DSbF4pHN.js";const zn=e=>fn(e);class Mn extends Ee{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=gt.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():gt.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?Q.err(new J(X.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?Q.err(new J(X.Variant)):Q.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,i;const s=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?$.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?$.backranks().complement():$.empty());if(t=t||this.ctx(),me(t.king)&&t.checkers.nonEmpty()){const a=t.checkers.singleSquare();return me(a)?s.intersect(gn(a,t.king)):$.empty()}else return s}}class Un extends Ee{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()>2)return Q.err(new J(X.Kings));const t=this.board.kingOf(F(this.turn));return me(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Q.err(new J(X.OppositeCheck)):$.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0):Q.err(new J(X.Kings))}kingAttackers(t,n,i){const s=this.board.pieces(n,"king");return s.isEmpty()||Ve(t).intersects(s)?$.empty():super.kingAttackers(t,n,i)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(const i of Ve(t).intersect(this.board.occupied).diff(this.board.pawn)){const s=this.board.take(i);s?.role==="rook"&&this.castles.discardRook(i),s?.role==="king"&&this.castles.discardColor(s.color)}}hasInsufficientMaterial(t){if(this.board.pieces(F(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[F(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects($.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects($.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects($.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects($.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let i=$.empty();for(const s of Ye(this,t,n)){const a=this.clone();a.play({from:t,to:s});const o=a.board.kingOf(this.turn);me(o)&&(!me(a.board.kingOf(a.turn))||a.kingAttackers(o,a.turn,a.board.occupied).isEmpty())&&(i=i.with(s))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const n of Ue)if(this.board.pieces(n,"king").isEmpty())return{winner:F(n)}}}class Gn extends Ee{constructor(){super("antichess")}reset(){super.reset(),this.castles=qe.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=qe.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Q.err(new J(X.Empty)):$.backranks().intersects(this.board.pawn)?Q.err(new J(X.PawnsOnBackrank)):Q.ok(void 0)}kingAttackers(t,n,i){return $.empty()}ctx(){const t=super.ctx();if(me(this.epSquare)&&pn(F(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const n=this.board[F(this.turn)];for(const i of this.board[this.turn])if(Ye(this,i,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();const i=Ye(this,t,n),s=this.board[F(this.turn)];return i.intersect(n.mustCapture?me(this.epSquare)&&this.board.getRole(t)==="pawn"?s.with(this.epSquare):s:$.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[F(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[t].intersects($.lightSquares()),i=this.board[t].intersects($.darkSquares()),s=this.board[F(t)].isDisjoint($.lightSquares()),a=this.board[F(t)].isDisjoint($.darkSquares());return n&&s||i&&a}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects($.lightSquares())!==this.board.black.intersects($.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Kn extends Ee{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects($.center())}variantOutcome(t){for(const n of Ue)if(this.board.pieces(n,"king").intersects($.center()))return{winner:n}}}class Dn extends Ee{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=pt.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||pt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const n of Ue)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Wn=()=>{const e=nt.empty();return e.occupied=new $(65535,0),e.promoted=$.empty(),e.white=new $(61680,0),e.black=new $(3855,0),e.pawn=$.empty(),e.knight=new $(6168,0),e.bishop=new $(9252,0),e.rook=new $(16962,0),e.queen=new $(129,0),e.king=new $(33024,0),e};class Qn extends Ee{constructor(){super("racingkings")}reset(){this.board=Wn(),this.pockets=void 0,this.turn="white",this.castles=qe.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=qe.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?Q.err(new J(X.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let i=$.empty();for(const s of super.dests(t,n)){const a={from:t,to:s},o=this.clone();o.play(a),o.isCheck()||(i=i.with(s))}return i}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=$.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(me(i)){const s=this.board.occupied.without(i);for(const a of Ve(i).intersect(t).diff(this.board.black))if(this.kingAttackers(a,"white",s).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const n=$.fromRank(7),i=this.board.pieces("black","king").intersects(n),s=this.board.pieces("white","king").intersects(n);return i&&!s?{winner:"black"}:s&&!i?{winner:"white"}:{winner:void 0}}}const Fn=()=>{const e=nt.empty();return e.occupied=new $(4294967295,4294901862),e.promoted=$.empty(),e.white=new $(4294967295,102),e.black=new $(0,4294901760),e.pawn=new $(4294967295,16711782),e.knight=new $(0,1107296256),e.bishop=new $(0,603979776),e.rook=new $(0,2164260864),e.queen=new $(0,134217728),e.king=new $(0,268435456),e};class Hn extends Ee{constructor(){super("horde")}reset(){this.board=Fn(),this.pockets=void 0,this.turn="white",this.castles=qe.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Q.err(new J(X.Empty));if(this.board.king.size()!==1)return Q.err(new J(X.Kings));const t=this.board.kingOf(F(this.turn));if(me(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return Q.err(new J(X.OppositeCheck));for(const n of Ue){const i=this.board.pieces(n,"king").isEmpty()?$.backrank(F(n)):$.backranks();if(this.board.pieces(n,"pawn").intersects(i))return Q.err(new J(X.PawnsOnBackrank))}return Q.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const n=v=>v==="light"?"dark":"light",i=v=>v==="light"?$.lightSquares():$.darkSquares(),s=v=>{const g=this.board.pieces(v,"bishop");return g.intersects($.darkSquares())&&g.intersects($.lightSquares())},a=mt.fromBoard(this.board,t),o=v=>i(v).intersect(this.board.pieces(t,"bishop")).size(),d=o("light")>=1?"light":"dark",l=a.pawn+a.knight+a.rook+a.queen+Math.min(o("dark"),2)+Math.min(o("light"),2),r=mt.fromBoard(this.board,F(t)),m=v=>i(v).intersect(this.board.pieces(F(t),"bishop")).size(),b=r.size(),C=v=>b-v;if(l===0)return!0;if(l>=4||(a.pawn>=1||a.queen>=1)&&l>=2||a.rook>=1&&l>=2&&!(l===2&&a.rook===1&&a.bishop===1&&C(m(d))===1))return!1;if(l===1){if(b===1)return!0;if(a.queen===1)return!(r.pawn>=1||r.rook>=1||m("light")>=2||m("dark")>=2);if(a.pawn===1){const v=this.board.pieces(t,"pawn").last(),g=this.clone();g.board.set(v,{color:t,role:"queen"});const k=this.clone();return k.board.set(v,{color:t,role:"knight"}),g.hasInsufficientMaterial(t)&&k.hasInsufficientMaterial(t)}else{if(a.rook===1)return!(r.pawn>=2||r.rook>=1&&r.pawn>=1||r.rook>=1&&r.knight>=1||r.pawn>=1&&r.knight>=1);if(a.bishop===1)return!(m(n(d))>=2||m(n(d))>=1&&r.pawn>=1||r.pawn>=2);if(a.knight===1)return!(b>=4&&(r.knight>=2||r.pawn>=2||r.rook>=1&&r.knight>=1||r.rook>=1&&r.bishop>=1||r.knight>=1&&r.bishop>=1||r.rook>=1&&r.pawn>=1||r.knight>=1&&r.pawn>=1||r.bishop>=1&&r.pawn>=1||s(F(t))&&r.pawn>=1)&&(m("dark")<2||C(m("dark"))>=3)&&(m("light")<2||C(m("light"))>=3))}}else{if(l===2)return b===1?!0:a.knight===2?r.pawn+r.bishop+r.knight<1:s(t)?!(r.pawn>=1||r.bishop>=1||r.knight>=1&&r.rook+r.queen>=1):a.bishop>=1&&a.knight>=1?!(r.pawn>=1||m(n(d))>=1||C(m(d))>=3):!(r.pawn>=1&&m(n(d))>=1||r.pawn>=1&&r.knight>=1||m(n(d))>=1&&r.knight>=1||m(n(d))>=2||r.knight>=2||r.pawn>=2);if(l===3)return a.knight===2&&a.bishop===1||a.knight===3||s(t)?!1:b===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const jn=(e,t)=>{switch(e){case"chess":return Ct.fromSetup(t);case"antichess":return Gn.fromSetup(t);case"atomic":return Un.fromSetup(t);case"horde":return Hn.fromSetup(t);case"racingkings":return Qn.fromSetup(t);case"kingofthehill":return Kn.fromSetup(t);case"3check":return Dn.fromSetup(t);case"crazyhouse":return Mn.fromSetup(t)}},Vn=(e=rt)=>({headers:e(),moves:new Ut});class Ut{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const n=t.children[0];yield n,t=n}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class Yn extends Ut{constructor(t){super(),this.data=t}}const Zn=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Jn=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,rt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),kt="\uFEFF",Qe=e=>/^\s*$/.test(e),Fe=e=>e.startsWith("%");class Xn extends Error{}class ei{constructor(t,n=rt,i=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Vn(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Xn("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let i=0;for(;;){const s=t.indexOf(`
`,i);if(s===-1)break;const a=s>i&&t[s-1]==="\r"?s-1:s;this.consumeBudget(s-i),this.lineBuf.push(t.slice(i,a)),i=s+1,this.handleLine()}this.consumeBudget(t.length-i),this.lineBuf.push(t.slice(i)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(kt)&&(n=n.slice(kt.length)),this.state=1;case 1:if(Qe(n)||Fe(n))return;this.found=!0,this.state=2;case 2:{if(Fe(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(s,a,o)=>(this.consumeBudget(200),this.handleHeader(a,o.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,t=!1,""));if(Qe(n))return;this.state=3}case 3:{if(t){if(Fe(n))return;if(Qe(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let s;for(;s=i.exec(n);){const a=this.stack[this.stack.length-1];let o=s[0];if(o===";")return;if(o.startsWith("$"))this.handleNag(parseInt(o.slice(1),10));else if(o==="!")this.handleNag(1);else if(o==="?")this.handleNag(2);else if(o==="!!")this.handleNag(3);else if(o==="??")this.handleNag(4);else if(o==="!?")this.handleNag(5);else if(o==="?!")this.handleNag(6);else if(o==="1-0"||o==="1–0"||o==="1—0"||o==="0-1"||o==="0–1"||o==="0—1"||o==="1/2-1/2"||o==="1/2–1/2"||o==="1/2—1/2"||o==="*")this.stack.length===1&&o!=="*"&&this.handleHeader("Result",o);else if(o==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(o===")")this.stack.length>1&&this.stack.pop();else if(o==="{"){const d=i.lastIndex,l=n[d]===" "?d+1:d;n=n.slice(l),this.state=4;continue e}else this.consumeBudget(100),o.startsWith("O")||o.startsWith("0")||o.startsWith("o")?o=o.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(o==="Z0"||o==="0000"||o==="@@@@")&&(o="--"),a.node&&(a.parent=a.node),a.node=new Yn({san:o,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const s=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,s)),this.handleComment(),n=n.slice(i),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?Zn(Jn(n)):n)}handleNag(t){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],s=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((t=i.node.data).comments||(t.comments=[]),i.node.data.comments.push(s)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(s)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(s))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const ti=(e,t=rt)=>{const n=[];return new ei(i=>n.push(i),t,NaN).parse(e),n};var ni=h("<div class=modal-mask><dialog open><div class=close-button-anchor><button class=close-button data-icon=></button></div><div class=scrollable><div>");function He(e){return(()=>{var t=ni(),n=t.firstChild,i=n.firstChild,s=i.firstChild,a=i.nextSibling,o=a.firstChild;return t.$$click=()=>e.on_close(),n.$$click=d=>{d.stopPropagation()},s.$$click=()=>e.on_close(),u(o,()=>e.children),B(()=>Z(o,"dialog-content "+e.klass)),t})()}Ge(["click"]);const tt="ABCDEFGHIJKLMNOP".split(""),$t=e=>tt[e];function wt(e){return Je(e.toSetup())}function ii(e){return ti(e).map(t=>{let n=t.headers.get("Event"),i=t.headers.get("Site"),s=t.headers.get("White"),a=t.headers.get("Black"),o=t.headers.get("Chapter"),d=t.headers.get("Orientation"),l=t.headers.get("FEN"),r=l??Ie,m=Ct.fromSetup(Ze(r).unwrap()).unwrap(),b={},C={},v={};t.moves.children.forEach(k=>{g(k,m,0,"")});function g(k,_,p,S){let w=k.data.san,R=mn(_,w),I=_.clone();I.play(R);let K=vn(R),M=k.data.nags,D=b[S];D||(D=[],b[S]=D);let N=S.length===0?K:`${S} ${K}`;D.push({path:N,ply:p+1,before_fen:wt(_),fen:wt(I),uci:K,san:w}),M&&(v[N]=M),k.children.forEach(y=>{g(y,I,p+1,N)})}return{event:n,site:i,white:s,black:a,chapter:o,fen:l,orientation:d,flat_steps:b,flat_nags:v,flat_comments:C}})}var si=h(`<div class="editor is2d"><div class=board-wrap></div><div class=tools-wrap><div class=metadata><div class=color><select><option value=white>White's Turn</option><option value=black>Black's Turn</option></select></div><div class=castling><strong>Castling</strong><div><label><input type=checkbox>White O-O</label><label><input type=checkbox>O-O-O</label></div><div><label><input type=checkbox>Black O-O</label><label><input type=checkbox>O-O-O</label></div></div><div class=enpassant><label for=enpassant-select>En passant</label><select id=enpassant-select><option value selected></option></select></div></div><div class=actions><button>Starting Position</button><button>Clear Board`),ri=h("<option>"),ai=h('<div class="is2d chessboard"> '),oi=h("<div>"),li=h("<div><div><div>");function ci(e){const t=m=>[...m].reduce((b,C)=>{const v=parseInt(C);return b+(v>=1?"x".repeat(v):C)},""),n=(m,b,C,v)=>{let g;for(;(g=b.exec(m))!=null;)v.add(g.index+C)},i=new Set,[s,a]=e.split(" "),o=s.split("/"),d=t(o[a==="w"?3:4]);n(d,/pP/g,a==="w"?0:1,i),n(d,/Pp/g,a==="w"?1:0,i);const[l,r]=i.size>=1?[t(o[a==="w"?1:6]),t(o[a==="w"?2:5])]:[null,null];return Array.from(i).filter(m=>l[m]==="x"&&r[m]==="x").map(m=>String.fromCharCode(97+m)+(a==="w"?"6":"3"))}const di=e=>{const t=()=>Ie,[n,i]=q(Ie),[s,a]=q("white"),[o,d]=q(),l=["K","Q","k","q"],[r,m]=bn({Q:!1,K:!1,k:!1,q:!1}),b=O(()=>{let y="",x=r;return l.forEach(W=>{x[W]&&(y+=W)}),y}),C=O(()=>{let y=t(),x=n()??y;const W=Ze(x).unwrap(oe=>oe.board,oe=>nt.empty()),re=s(),ae=kn(W,b()).unwrap();let be=o()?it(o()):void 0;return{board:W,turn:re,castlingRights:ae,epSquare:be,pockets:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:0}}),v=O(()=>Je(C())),g=O(()=>jn("chess",C()).unwrap(y=>Je(y.toSetup()),y=>{})),k=O(()=>ci(v()));Ne(()=>{e.on_change_fen(g())});const _=y=>{pe(()=>{a(y.turn),d(y.epSquare?zn(y.epSquare):void 0);let x=qe.fromSetup(y);m("Q",x.rook.white.a!==void 0),m("K",x.rook.white.h!==void 0),m("q",x.rook.black.a!==void 0),m("k",x.rook.black.h!==void 0)})},p=y=>{Ze(y).unwrap(x=>(pe(()=>{i(y),_(x)}),!0),x=>!1)};p(e.initial_fen);const[S,w]=q("pointer"),R=St(S),[I,K]=q(),M=(y,x)=>{if(w(y),y!=="pointer"){if(y!=="trash"){let[W,re]=y.split(" ");K([W,re,x])}}},D=O(()=>{let y,x;switch(S()){case"pointer":x="pointer";break;case"trash":y="/cursors/trash.cur";break;default:y=`/cursors/${S().split(" ").join("-")}.cur`}if(x)return{cursor:x};if(y)return{cursor:`url('${y}'), default`}}),N=()=>{let[y,x]=S().split(" ");w(`${vt(y)} ${x}`)};return(()=>{var y=si(),x=y.firstChild,W=x.nextSibling,re=W.firstChild,ae=re.firstChild,be=ae.firstChild,oe=be.firstChild,Le=oe.nextSibling,ke=ae.nextSibling,ye=ke.firstChild,L=ye.nextSibling,A=L.firstChild,le=A.firstChild,ne=A.nextSibling,ce=ne.firstChild,Ce=L.nextSibling,ee=Ce.firstChild,de=ee.firstChild,$e=ee.nextSibling,ue=$e.firstChild,he=ke.nextSibling,Oe=he.firstChild,_e=Oe.nextSibling;_e.firstChild;var Ke=re.nextSibling,Pe=Ke.firstChild,De=Pe.nextSibling;return u(y,c(yt,{klass:"spare-top",get color(){return vt(e.orientation)},on_spare:M,is_selected:R}),x),u(x,c(ui,{on_set_spare:w,on_toggle_spare:N,get spare(){return S()},get orientation(){return e.orientation},on_change_fen:i,get drag_new_piece(){return I()},get fen(){return n()}})),u(y,c(yt,{klass:"spare-bottom",get color(){return e.orientation},on_spare:M,is_selected:R}),W),xe(be,"change",z=>a(z.target.value)),le.addEventListener("change",z=>m("K",z.target.checked)),ce.addEventListener("change",z=>m("Q",z.target.checked)),de.addEventListener("change",z=>m("k",z.target.checked)),ue.addEventListener("change",z=>m("q",z.target.checked)),_e.addEventListener("change",z=>d(z.target.value)),u(_e,c(we,{get each(){return k()},children:z=>(()=>{var Se=ri();return Se.value=z,u(Se,z),Se})()}),null),Pe.$$click=()=>p(Ie),De.$$click=()=>p(yn),B(z=>{var Se=D(),Te=s()==="white",Re=s()==="black";return z.e=xt(y,Se,z.e),Te!==z.t&&(oe.selected=z.t=Te),Re!==z.a&&(Le.selected=z.a=Re),z},{e:void 0,t:void 0,a:void 0}),B(()=>le.checked=r.K),B(()=>ce.checked=r.Q),B(()=>de.checked=r.k),B(()=>ue.checked=r.q),y})()};function ui(e){const t=()=>{e.on_change_fen(i.getFen())};let n,i;return ze(()=>{let s={fen:e.fen,orientation:e.orientation,autoCastle:!1,movable:{free:!0,color:"both"},draggable:{showGhost:!0,deleteOnDropOff:!0},premovable:{enabled:!1},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:t}};i=In(n,s);const a=l=>{let r=e.spare;r!=="pointer"&&l.preventDefault();const m=bt(l);if(!m)return;let b=i.getKeyAtDomPos(m);if(b){if(r==="trash")o(b);else if(r!=="pointer"){const C=i.state.pieces.get(b);let[v,g]=r.split(" "),k={color:v,role:g};C&&C.color===k.color&&C.role===k.role?o(b):(i.setPieces(new Map([[b,k]])),t())}}},o=l=>{i.setPieces(new Map([[l,void 0]])),t()},d=l=>{let r=e.spare;r!=="pointer"&&l.preventDefault(),r!=="pointer"&&(i.state.drawable.current=void 0,i.state.drawable.shapes=[],l.type==="contextmenu"&&r!=="trash"&&(i.cancelMove(),e.on_toggle_spare()))};n.addEventListener("mousedown",a),n.addEventListener("contextmenu",d),Me(()=>{n.removeEventListener("mousedown",a),n.removeEventListener("contextmenu",d)})}),Ne(()=>{i.set({fen:e.fen})}),Ne(()=>{i.set({orientation:e.orientation})}),Ne(()=>{let s=e.drag_new_piece;s&&(An(i.state,{color:s[0],role:s[1]},s[2],!0),document.addEventListener("mouseup",a=>{const o=bt(a);o&&i.getKeyAtDomPos(o)&&e.on_set_spare("pointer")},{once:!0}))}),(()=>{var s=ai();return Ae(a=>n=a,s),s})()}const yt=e=>{const t=e.is_selected;return(()=>{var n=oi();return u(n,c(je,{onClick:i=>e.on_spare("pointer",i),klass:"pointer",spare:"pointer",get selected(){return t("pointer")},get color(){return e.color}}),null),u(n,c(we,{each:$n,children:i=>c(je,{onClick:s=>e.on_spare(`${e.color} ${i}`,s),klass:"",get spare(){return`${e.color} ${i}`},get selected(){return t(`${e.color} ${i}`)},get color(){return e.color}})}),null),u(n,c(je,{onClick:i=>e.on_spare("trash",i),klass:"trash",spare:"trash",get selected(){return t("trash")},get color(){return e.color}}),null),B(()=>Z(n,"spare "+e.klass+" "+e.color)),n})()},je=e=>(()=>{var t=li(),n=t.firstChild,i=n.firstChild;return xe(t,"mousedown",e.onClick,!0),B(s=>{var a="no-square "+e.klass,o=!!e.selected,d="piece "+e.spare,l={[e.color]:!0};return a!==s.e&&Z(t,s.e=a),o!==s.t&&t.classList.toggle("selected",s.t=o),d!==s.a&&Z(i,s.a=d),s.o=wn(i,l,s.o),s},{e:void 0,t:void 0,a:void 0,o:void 0}),t})();Ge(["click","mousedown"]);var hi=h("<h2>Edit Opening"),_i=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Opening Name"minlength=3>'),fi=h("<div class=section><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),at=h("<div class=filler>"),Gt=h('<div class="group buttons"><span class=split></span><button class=delete>Delete <i data-icon=>'),gi=h("<h2>Edit Chapter"),Kt=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Section Name"minlength=3>'),pi=h("<div class=group><div class=editor-wrap>"),mi=h("<div class=tabs-wrap><div class=tabs><div class=tab>Empty</div><div class=tab>Editor</div></div><div class=content>"),Dt=h("<div class=section><div class=group><label for=order>Set Order</label><select name=order id=order></select></div><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),vi=h('<div class="group buttons"><button class=delete>Delete <i data-icon=></i></button><span class=split></span><button class=create>Save Changes'),Wt=h("<option>"),bi=h("<h2>Edit Section"),ki=h("<div class=tabs><div>Empty</div><div>Import Lichess Study"),$i=h('<div class=group><label for=name>Import a Study from Lichess</label><input name=name id=name type=text placeholder="Lichess Study URL">'),wi=h("<div class=content>"),yi=h("<button class=import>Import<i data-icon=>"),Ci=h("<button class=loading disabled>Loading ...");function Si(e){const t=(o,d)=>{o==="Escape"&&(d.value=e.study.name)},n=o=>{let d=o.value;d.length<3&&(d="New Chapter",o.value=d),e.on_update_study({id:e.study.id,name:d})},i=()=>{e.on_delete_study()},s=o=>{e.on_update_study({id:e.study.id,orientation:o})},a=O(()=>e.study.orientation);return[hi(),(()=>{var o=_i(),d=o.firstChild,l=d.nextSibling;return l.addEventListener("change",r=>n(r.currentTarget)),l.$$keydown=r=>t(r.key,r.currentTarget),B(()=>l.value=e.study.name),o})(),(()=>{var o=fi(),d=o.firstChild,l=d.firstChild,r=l.nextSibling,m=r.firstChild,b=m.nextSibling;return r.addEventListener("change",C=>s(C.currentTarget.value)),B(C=>{var v=a()==="white",g=a()==="black";return v!==C.e&&(m.selected=C.e=v),g!==C.t&&(b.selected=C.t=g),C},{e:void 0,t:void 0}),o})(),at(),(()=>{var o=Gt(),d=o.firstChild,l=d.nextSibling;return l.$$click=i,o})()]}function xi(e){const t=(g,k)=>{g==="Escape"&&(k.value=e.chapter.name)},n=g=>{let k=g.value;k.length<3&&(k="New Chapter",g.value=k),e.on_edit_chapter({id:e.chapter.id,name:k})},i=g=>{let k=parseInt(g);e.on_order_chapter(k)},s=()=>{e.on_delete_chapter()},a=()=>{let g=l();g&&e.fen!==g&&e.on_change_root_fen(g)},o=g=>{e.on_edit_chapter({id:e.chapter.id,orientation:g})},d=O(()=>e.chapter.orientation),[l,r]=q(),[m,b]=q("editor"),C=St(m),v=O(()=>l()??e.fen);return[gi(),(()=>{var g=Kt(),k=g.firstChild,_=k.nextSibling;return _.addEventListener("change",p=>n(p.currentTarget)),_.$$keydown=p=>t(p.key,p.currentTarget),B(()=>_.value=e.chapter.name),g})(),(()=>{var g=mi(),k=g.firstChild,_=k.firstChild,p=_.nextSibling,S=k.nextSibling;return _.$$click=()=>b("empty"),p.$$click=()=>b("editor"),u(S,c(E,{get when(){return m()==="editor"},get children(){var w=pi(),R=w.firstChild;return u(R,c(di,{get initial_fen(){return v()},on_change_fen:r,get orientation(){return e.chapter.orientation??"white"}})),w}}),null),u(S,c(E,{get when(){return m()==="empty"},get children(){return[]}}),null),B(w=>{var R=!!C("empty"),I=!!C("editor");return R!==w.e&&_.classList.toggle("active",w.e=R),I!==w.t&&p.classList.toggle("active",w.t=I),w},{e:void 0,t:void 0}),g})(),(()=>{var g=Dt(),k=g.firstChild,_=k.firstChild,p=_.nextSibling,S=k.nextSibling,w=S.firstChild,R=w.nextSibling,I=R.firstChild,K=I.nextSibling;return p.addEventListener("change",M=>i(M.currentTarget.value)),u(p,c(we,{get each(){return[...Array(e.nb_chapters).keys()]},children:(M,D)=>(()=>{var N=Wt();return u(N,()=>D()+1),B(()=>N.selected=e.i_chapter===D()),B(()=>N.value=D()),N})()})),R.addEventListener("change",M=>o(M.currentTarget.value)),B(M=>{var D=d()==="white",N=d()==="black";return D!==M.e&&(I.selected=M.e=D),N!==M.t&&(K.selected=M.t=N),M},{e:void 0,t:void 0}),g})(),at(),(()=>{var g=vi(),k=g.firstChild,_=k.nextSibling,p=_.nextSibling;return k.$$click=s,p.$$click=a,B(()=>p.disabled=v()===void 0),g})()]}function Ei(e){const t=(_,p)=>{_==="Escape"&&(p.value=e.section.name)},n=_=>{let p=_.value;p.length<3&&(p="New Section",_.value=p),e.on_edit_section({id:e.section.id,name:p})},i=_=>{let p=tt.indexOf(_);e.on_order_section(p)},s=()=>{e.on_delete_section()},[a,o]=q("lichess"),[d,l]=q(""),r=O(()=>{let _=d().match(/\/study\/([a-zA-Z0-9]{8})\/?$/);return _?`https://lichess.org/api/study/${_[1]}.pgn`:void 0}),m=async _=>await fetch(_).then(p=>p.text()).then(p=>ii(p)),[b]=Cn(r,m),C=async()=>{let _=b();_&&e.on_import_pgns(_,e.section.name)},v=O(()=>r()===void 0),g=_=>{e.on_edit_section({id:e.section.id,orientation:_})},k=O(()=>e.section.orientation);return[bi(),(()=>{var _=Kt(),p=_.firstChild,S=p.nextSibling;return S.addEventListener("change",w=>n(w.currentTarget)),S.$$keydown=w=>t(w.key,w.currentTarget),B(()=>S.value=e.section.name),_})(),(()=>{var _=ki(),p=_.firstChild,S=p.nextSibling;return p.$$click=()=>o("empty"),S.$$click=()=>o("lichess"),B(w=>{var R="tab "+(a()==="empty"?"active":""),I="tab "+(a()==="lichess"?"active":"");return R!==w.e&&Z(p,w.e=R),I!==w.t&&Z(S,w.t=I),w},{e:void 0,t:void 0}),_})(),(()=>{var _=wi();return u(_,c(E,{get when(){return a()==="lichess"},get children(){var p=$i(),S=p.firstChild,w=S.nextSibling;return w.addEventListener("change",R=>l(R.target.value)),w.$$keyup=R=>l(R.currentTarget.value),B(()=>Z(w,v()?"error":"success")),p}}),null),u(_,c(E,{get when(){return a()==="empty"},get children(){return[]}}),null),_})(),(()=>{var _=Dt(),p=_.firstChild,S=p.firstChild,w=S.nextSibling,R=p.nextSibling,I=R.firstChild,K=I.nextSibling,M=K.firstChild,D=M.nextSibling;return w.addEventListener("change",N=>i(N.currentTarget.value)),u(w,c(we,{get each(){return tt.slice(0,e.nb_sections)},children:(N,y)=>(()=>{var x=Wt();return x.value=N,u(x,N),B(()=>x.selected=e.i_section===y()),x})()})),K.addEventListener("change",N=>g(N.currentTarget.value)),B(N=>{var y=k()==="white",x=k()==="black";return y!==N.e&&(M.selected=N.e=y),x!==N.t&&(D.selected=N.t=x),N},{e:void 0,t:void 0}),_})(),at(),(()=>{var _=Gt(),p=_.firstChild,S=p.nextSibling;return u(_,c(E,{get when(){return a()==="lichess"},get children(){return c(Et,{get fallback(){return Ci()},get children(){var w=yi();return w.$$click=C,B(()=>w.disabled=b()===void 0),w}})}}),S),S.$$click=s,_})()]}Ge(["keydown","click","keyup"]);var Qt=h('<main class="openings-show study"><div class=details-wrap></div><div class=board-wrap></div><div class=replay-wrap><div class=header></div></div><div class=sections-wrap></div><div class=tools-wrap>'),Ft=h('<button class="feature practice"><i data-icon=>'),Li=h("<a class=analyze data-icon=>Analyze on lichess"),Oi=h("<a class=copy-line data-icon=>Copy variation PGN"),qi=h('<a class="annotate has-sub-menu"data-icon=><i class=glyph-icon></i>Annotate Glyph'),Bi=h("<a class=delete data-icon=>Delete after this move"),Ni=h("<div class=context-sub-menu>"),Pi=h("<a><i>"),Ti=h("<h4>Take Quiz"),Ri=h("<h4>Play Deathmatch"),Ii=h("<h4>Practice with the Computer"),Ai=h("<div class=practice-feature><div class=tabs><div>Practice</div></div><div>"),zi=h("<span>End of line."),Mi=h("<div class=info-wrap><div class=status></div><div class=info><p>Computer will follow the lines in the opening.</p><p>Moves will be hidden."),Ui=h('<div class="rematch-buttons buttons"><button class=end>End</button><button class=rematch>Rematch</button><button><i>'),Gi=h("<span>Your turn."),Ki=h("<span>..."),Ht=h("<span>1 of 15"),jt=h("<button class=retake>Re-take"),Di=h("<p>You are given 15 random positions from the opening. Play the correct moves."),Vt=h("<div class=info-wrap><div class=status></div><div class=info>"),Wi=h("<div class=quiz-history>"),Yt=h("<button class=start>Start"),Zt=h('<div class="quiz-buttons buttons">'),Qi=h("<div class=quiz-item>"),Fi=h("<p>You will play the moves from the opening. If you go out of book, game ends."),Hi=h("<i data-icon=>"),ji=h("<button class=new><i data-icon=></i><span>New Section"),Vi=h("<div class=sections-list><div class=header><span class=title></span><div class=tools></div></div><div class=list><div class=tools>"),ot=h("<i data-icon=>"),Yi=h("<button class=new><i data-icon=></i><span>New Chapter"),Zi=h('<div class="section active"><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis></span></div></div><div class=chapters-list><div class=list></div><div class=tools>'),Ji=h("<div><div class=title><span class=nth>."),Xi=h("<div class=section><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis>"),es=h("<div class=no-sections>No Sections yet."),ts=h("<div class=no-chapters>No Chapters yet."),ns=h("<div class=loading-chapters>Loading Chapters."),is=h("<div class=tabs><div><i data-icon=></i></div><div><i data-icon=>"),ss=h("<div class=settings><div class=group><label for=editable>Disable Edits</label><input id=editable type=checkbox>"),rs=h("<div class=export><button>Copy PGN</button><button></button><button disabled>Export to Lichess Study"),as=h("<div class=fen><h4>FEN"),os=h("<div class=content>"),ls=h("<div class=copy-input-text><input type=text readonly>"),cs=h("<span class=copied><i data-icon=>"),ds=h("<span><i data-icon=>"),us=h("<div class=loading>Loading");const Bs=()=>{const[e,{load_study:t}]=se();let n=Sn();return Xe(()=>t(n.id)),c(_s,ve(()=>hs(e,n.id)))};function hs(e,t){let n=O(()=>e.studies[t]),i=O(()=>{let d=n()?.sections;return n()?.section_ids.map(l=>d.find(r=>r.id===l))}),s=O(()=>{let d=n(),l=d?.selected_section_id;if(l)return d?.sections.find(r=>r.id===l)}),a=O(()=>{let d=s();if(d)return d.chapter_ids.map(l=>e.chapters.list.find(r=>r.id===l)).filter(Boolean)}),o=O(()=>{let l=s()?.selected_chapter_id;if(l)return a()?.find(r=>r.id===l)});return{get study(){return n()},get selected_section(){return s()},get selected_chapter(){return o()},get sections(){return i()},get chapters(){return a()}}}function _s(e){const[,{reset_replay_tree:t,load_replay_tree:n,load_chapter:i,load_chapters:s}]=se(),[a,o]=q("show"),[,d]=st();Xe(et(O(()=>e.selected_section?.id),r=>r&&d(()=>s(r)))),Xe(et(O(()=>e.selected_chapter?.id),r=>{d(r?()=>{i(r),n(r)}:()=>{t()})}));const l=r=>({...e,study:r});return c(Et,{get fallback(){return c(Es,{})},get children(){return c(E,{get when(){return e.study},children:r=>[c(E,{get when(){return a()==="show"},get children(){return c(fs,ve(()=>l(r()),{on_feature_practice:()=>o("practice")}))}}),c(E,{get when(){return a()==="practice"},get children(){return c(gs,ve(()=>l(r()),{on_feature_practice_off:()=>o("show")}))}})]})}})}function fs(e){const[t,{goto_path:n,goto_path_if_can:i,delete_at_and_after_path:s,tree_step_node_set_nags:a,add_child_san_to_current_path:o,chapter_as_export_pgn:d,set_write_enabled_replay_tree:l}]=se();l(!e.study.is_edits_disabled);let r=Lt(t);Ot(r);let[m,b]=q(),[C,v]=q(!1),[g,k]=q(!1),[_,p]=q(!1),[S,w]=q(!1);const R=O(()=>{let f=m();if(f)return xn(t.replay_tree.steps_tree,f)});ze(()=>{const f=()=>{b(void 0)};document.addEventListener("click",f),Me(()=>{document.removeEventListener("click",f)})});let I,K;const M=(f,P)=>{n(P),b(P);let U=f.clientX,V=f.clientY,H=K.getBoundingClientRect(),j=I.getBoundingClientRect();U-=j.left,V-=j.top,U=Math.min(U,document.body.clientWidth-H.width-j.left-20);let te=`${V}px`,ie=`${U}px`;K.style.top=te,K.style.left=ie},D=f=>{let P=f.fen;window.open(`https://lichess.org/analysis?fen=${P}`,"_blank"),b(void 0)},[,N]=st(),y=async f=>{N(()=>{s(f)}),b(void 0)};let x;const W=f=>{clearTimeout(x),x=void 0,f===!1?x=setTimeout(()=>{v(!1)},150):x=setTimeout(()=>{v(!0)},100)},re=async(f,P)=>{await a(f,[Nn(P)]),clearTimeout(x),v(!1)};let ae,[be,oe]=q(void 0);const Le=O(()=>{let f=be();if(K===void 0||f===void 0)return"";let P=ae.getBoundingClientRect(),U=f.getBoundingClientRect(),V=K.getBoundingClientRect(),H=P.top,j=V.left-U.width,te=I.getBoundingClientRect();return j-=te.left,H-=te.top,`top: ${H}px; left: ${j}px;`}),ke=f=>{i(f)};let ye=O(()=>{let f=r.step_at_cursor_path;if(!f)return[];let P=f.nags?.[0];return P?It(f.step.uci,f.step.san,Rt(P)):[]});const L=O(()=>e.selected_chapter?.name??"[detached]"),A=O(()=>m()!==void 0||g()||_()!==void 0||S()!==void 0);let[,{create_section:le,create_chapter:ne}]=se();const ce=async(f,P)=>{let U=_()?e.selected_section:void 0;p(!1);let V=e.study.name,H={};z({id:e.study.id,is_edits_disabled:!0});for(let G of f){let T=G.event,[Y,fe,ge]=T.split(":");ge||(ge=fe,fe=P),H[fe]===void 0&&(H[fe]=[]),H[fe].push([ge,G]),V=Y}await ct({id:e.study.id,name:V});let j=Object.keys(H)[0];U&&await lt(e.study.id,{id:U.id,name:j});let te,ie=U;for(j of Object.keys(H)){U||(U=await le(e.study.id,j));let G=H[j];for(let[T,Y]of G)te=await ne(e.study.id,U.id,T,Y);ie=U,U=void 0}ie&&te&&(z({id:e.study.id,selected_section_id:ie.id}),_e(e.study.id,{id:ie.id,selected_chapter_id:te.id}))},Ce=()=>{},ee=async()=>{let f=await d(e.study.name,e.selected_section.name,e.selected_chapter);navigator.clipboard.writeText(f)},de=f=>{let P=Bn(t.replay_tree.steps_tree,f);navigator.clipboard.writeText(P),b(void 0)},$e=f=>{f>0?i(r.get_next_path):i(r.get_prev_path)},ue=O(()=>!e.study.is_edits_disabled),he=f=>e.sections.indexOf(f),Oe=f=>e.chapters.indexOf(f),[,{update_section:_e,delete_section:Ke,update_chapter:Pe,delete_chapter:De,update_study:z,delete_study:Se,order_sections:Te,order_chapters:Re,change_root_fen:tn}]=se(),lt=_e,nn=(f,P)=>{Ke(f,P),p(!1)},sn=(f,P,U)=>{U.orientation&&dt(void 0),Pe(f,P,U)},rn=f=>{pe(()=>{De(e.study.id,e.selected_section.id,f),w(!1)})},ct=z,an=En(),on=async f=>{await Se(f),an("/openings")},ln=(f,P)=>{Te(f.study_id,f.id,P)},cn=(f,P)=>{Re(e.study.id,f.section_id,f.id,P)},dn=async f=>{await tn(e.selected_chapter.id,f),w(!1)},un=async(f,P)=>{let V=Nt(r.fen),H=V.turn,j=V.board.get(it(f)),te=f+P;j.role==="pawn"&&(P[1]==="8"&&H==="white"||P[1]==="1"&&H==="black")&&(te+="q");let ie=Pt(te),G=Tt(V,ie),T=await o(G);n(T.step.path)},[hn,dt]=q(),ut=O(()=>hn()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),ht=f=>{f.key==="f"&&dt(F(ut()))};return ze(()=>{document.addEventListener("keydown",ht),Me(()=>{document.removeEventListener("keydown",ht)})}),(()=>{var f=Qt(),P=f.firstChild,U=P.nextSibling,V=U.nextSibling,H=V.firstChild,j=V.nextSibling,te=j.nextSibling,ie=I;return typeof ie=="function"?Ae(ie,f):I=f,u(P,c(Xt,ve(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),xe(U,"wheel",Mt($e)),u(U,c(At,{get orientation(){return ut()},get shapes(){return ye()},get movable(){return ue()},get color(){return qt(r.fen)},get fen(){return r.fen},get last_move(){return r.last_move},play_orig_key:un})),u(H,L),u(V,c(Bt,{handle_goto_path:ke,get replay_tree(){return t.replay_tree},get lose_focus(){return A()},on_context_menu:M,get features(){return(()=>{var G=Ft();return xe(G,"click",e.on_feature_practice,!0),G})()}}),null),u(j,c(Jt,ve(e,{get is_edits_disabled(){return e.study.is_edits_disabled},on_edit_study:()=>k(!0),on_edit_section:()=>p(!0),on_edit_chapter:()=>w(!0)}))),u(te,c(Ss,ve(e,{get fen(){return r.fen},on_export_lichess:Ce,on_copy_pgn:ee}))),u(f,c(E,{get when(){return _()},get children(){return c(He,{klass:"edit-section",on_close:()=>p(!1),get children(){return c(Ei,{get section(){return e.selected_section},get i_section(){return he(e.selected_section)},get nb_sections(){return e.sections.length},on_delete_section:()=>nn(e.study.id,e.selected_section.id),on_edit_section:G=>lt(e.study.id,G),on_order_section:G=>ln(e.selected_section,G),on_import_pgns:ce})}})}}),null),u(f,c(E,{get when(){return S()},get children(){return c(He,{klass:"edit-chapter",on_close:()=>w(!1),get children(){return c(xi,{get fen(){return r.initial_fen},get nb_chapters(){return e.chapters.length},get chapter(){return e.selected_chapter},get i_chapter(){return Oe(e.selected_chapter)},on_edit_chapter:G=>sn(e.study.id,e.selected_chapter.section_id,G),on_delete_chapter:()=>rn(e.selected_chapter.id),on_order_chapter:G=>cn(e.selected_chapter,G),on_change_root_fen:dn})}})}}),null),u(f,c(E,{get when(){return g()},get children(){return c(He,{klass:"edit-study",on_close:()=>k(!1),get children(){return c(Si,{get study(){return e.study},on_delete_study:()=>on(e.study.id),on_update_study:ct})}})}}),null),u(f,c(E,{get when(){return R()},children:G=>[c(Ln,{get step(){return G().step},ref(T){var Y=K;typeof Y=="function"?Y(T):K=T},get children(){return[(()=>{var T=Li();return T.$$click=()=>D(G().step),T})(),(()=>{var T=Oi();return T.$$click=()=>de(G().step.path),T})(),c(E,{get when(){return!e.study.is_edits_disabled},get children(){return[(()=>{var T=qi();T.addEventListener("mouseenter",()=>W(!0)),T.addEventListener("mouseleave",()=>W(!1));var Y=ae;return typeof Y=="function"?Ae(Y,T):ae=T,T})(),(()=>{var T=Bi();return T.$$click=()=>y(G().step.path),T})()]}})]}}),c(E,{get when(){return C()},get children(){var T=Ni();return Ae(Y=>setTimeout(()=>oe(Y)),T),T.addEventListener("mouseenter",()=>W(!0)),T.addEventListener("mouseleave",()=>W(!1)),u(T,c(we,{each:On,children:(Y,fe)=>(()=>{var ge=Pi(),_n=ge.firstChild;return ge.$$click=()=>re(G(),Y),u(ge,()=>We[fe()],null),B(Be=>{var _t="annotate glyph "+We[fe()],ft=`glyph-icon ${We[fe()]}`;return _t!==Be.e&&Z(ge,Be.e=_t),ft!==Be.t&&Z(_n,Be.t=ft),Be},{e:void 0,t:void 0}),ge})()})),B(Y=>xt(T,Le(),Y)),T}})]}),null),f})()}function gs(e){const[t,{goto_path:n,goto_path_force:i,goto_path_if_can:s,set_hide_after_path:a,add_child_san_to_success_or_error_path_no_save:o,set_write_enabled_replay_tree:d}]=se();d(!1);let l=Lt(t);Ot(l);const[r,m]=q("practice"),b=L=>{L>0?s(l.get_next_path):s(l.get_prev_path)},[C,v]=q(),g=O(()=>C()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),k=L=>{L.key==="f"&&pe(()=>{v(F(g())),M(void 0),ye()})};ze(()=>{document.addEventListener("keydown",k),Me(()=>{document.removeEventListener("keydown",k)})});let _=O(()=>{let L=l.step_at_cursor_path;if(!L)return[];let A=L.nags?.[0];return A?It(L.step.uci,L.step.san,Rt(A)):[]});const p=async(L,A)=>{let ne=Nt(l.fen),ce=ne.turn,Ce=ne.board.get(it(L)),ee=L+A;Ce.role==="pawn"&&(A[1]==="8"&&ce==="white"||A[1]==="1"&&ce==="black")&&(ee+="q");let de=Pt(ee),$e=Tt(ne,de);re($e)},S=O(()=>e.selected_chapter?.name??"[detached]"),w=L=>{s(L)},[R,I]=q(),[K,M]=q(),[D,N]=q(!1),y=O(()=>R()===void 0&&D()&&!Le()),x=O(()=>K()??g()),W=O(()=>[]),re=async L=>{r()==="practice"&&ae(L)},ae=async L=>{let A=await o(L);A&&(A[0]==="error"?(i(A[1].step.path),I(setTimeout(()=>{pe(()=>{n(Rn(A[1].step.path)),I(void 0)})},600))):(pe(()=>{i(A[1].step.path),a(A[1].step.path)}),ye()))},be=L=>{L!==void 0&&pe(()=>{ke(!1),M(L),a(void 0),i(""),ye()})},oe=O(()=>{let L=qn(t.replay_tree.steps_tree,t.replay_tree.cursor_path);if(L=L.filter(A=>!t.replay_tree.error_paths.includes(A.step.path)),!(!L||L.length===0))return L}),[Le,ke]=q(!1),ye=()=>{let L=oe();if(L===void 0){ke(!0);return}if(x()!==l.turn){let A=zt(L);I(setTimeout(()=>{pe(()=>{i(A.step.path),a(A.step.path),I(void 0),oe()===void 0&&ke(!0)})},500))}};return(()=>{var L=Qt(),A=L.firstChild,le=A.nextSibling,ne=le.nextSibling,ce=ne.firstChild,Ce=ne.nextSibling;return u(A,c(Xt,ve(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),xe(le,"wheel",Mt(b)),u(le,c(At,{get orientation(){return x()},get shapes(){return _()},get movable(){return y()},get color(){return qt(l.fen)},get fen(){return l.fen},get last_move(){return l.last_move},play_orig_key:p})),u(ce,S),u(ne,c(Bt,{handle_goto_path:w,get replay_tree(){return t.replay_tree},lose_focus:!1,on_context_menu:()=>{},get features(){return(()=>{var ee=Ft();return xe(ee,"click",e.on_feature_practice_off,!0),ee})()},get feature_content(){return(()=>{var ee=Ai(),de=ee.firstChild,$e=de.firstChild,ue=de.nextSibling;return $e.$$click=()=>m("practice"),u(ue,c(E,{get when(){return r()==="quiz"},get children(){return[Ti(),c(vs,{get nodes(){return W()}})]}}),null),u(ue,c(E,{get when(){return r()==="deathmatch"},get children(){return[Ri(),c(bs,{})]}}),null),u(ue,c(E,{get when(){return r()==="practice"},get children(){return[Ii(),c(ps,{get end_of_practice(){return Le()},get movable(){return y()},on_rematch:be,get color(){return x()},set_movable:N})]}}),null),B(he=>{var Oe="feature tab"+(r()==="practice"?" active":""),_e="content "+r();return Oe!==he.e&&Z($e,he.e=Oe),_e!==he.t&&Z(ue,he.t=_e),he},{e:void 0,t:void 0}),ee})()}}),null),u(Ce,c(Jt,ve(e,{is_edits_disabled:!0}))),L})()}function ps(e){const[t,{goto_path:n,reload_replay_tree_with_cursor_path:i}]=se(),[,s]=st(),a=l=>{if(l===void 0){s(()=>{i(t.replay_tree.cursor_path)});return}pe(()=>{s(()=>{i(""),e.on_rematch(l)})})},o=O(()=>e.color),d=O(()=>F(o()));return e.set_movable(!0),n(""),[(()=>{var l=Mi(),r=l.firstChild;return u(r,c(E,{get when(){return e.end_of_practice},get fallback(){return c(E,{get when(){return e.movable},get fallback(){return Ki()},get children(){return Gi()}})},get children(){return zi()}})),l})(),(()=>{var l=Ui(),r=l.firstChild,m=r.nextSibling,b=m.nextSibling;return r.$$click=()=>a(),m.$$click=()=>a(o()),b.$$click=()=>a(d()),B(()=>Z(b,`color ${d()}`)),l})()]}function ms(e){let[t,n]=q(void 0);return{step:e,get is_solved(){return t()},set is_solved(i){n(i)}}}function vs(e){let[t,n]=q([...Array(15).keys()]);const[i,s]=q("info");let o=O(Pn(t,()=>ms(zt(e.nodes))));return[(()=>{var d=Vt(),l=d.firstChild,r=l.nextSibling;return u(l,c(E,{get when(){return i()==="info"},children:"Press start"}),null),u(l,c(E,{get when(){return i()==="in-progress"},get children(){return Ht()}}),null),u(l,c(E,{get when(){return i()==="end"},get children(){return jt()}}),null),u(r,c(E,{get when(){return i()==="info"},get children(){return Di()}})),d})(),(()=>{var d=Wi();return u(d,c(we,{get each(){return o()},children:(l,r)=>(()=>{var m=Qi();return u(m,()=>r()+1),m})()})),d})(),(()=>{var d=Zt();return u(d,c(E,{get when(){return i()==="info"},get children(){return Yt()}})),d})()]}function bs(){const[e,t]=q("info");return[(()=>{var n=Vt(),i=n.firstChild,s=i.nextSibling;return u(i,c(E,{get when(){return e()==="info"},children:"Press start"}),null),u(i,c(E,{get when(){return e()==="in-progress"},get children(){return Ht()}}),null),u(i,c(E,{get when(){return e()==="end"},get children(){return jt()}}),null),u(s,c(E,{get when(){return e()==="info"},get children(){return Fi()}})),n})(),(()=>{var n=Zt();return u(n,c(E,{get when(){return e()==="info"},get children(){return Yt()}})),n})()]}function Jt(e){let[,{create_section:t,update_study:n}]=se();const i=async()=>{let a=await t(e.study.id);await s(a.id),e.on_edit_section?.()},s=a=>n({id:e.study.id,selected_section_id:a});return(()=>{var a=Vi(),o=a.firstChild,d=o.firstChild,l=d.nextSibling,r=o.nextSibling,m=r.firstChild;return u(d,()=>e.study.name),u(l,c(E,{get when(){return!e.is_edits_disabled},get children(){var b=Hi();return b.$$click=()=>e.on_edit_study?.(),b}})),u(r,c(we,{get each(){return e.sections},get fallback(){return c(ys,{})},children:(b,C)=>c(E,{get when(){return b===e.selected_section},get fallback(){return c(ws,{get is_edits_disabled(){return e.is_edits_disabled},section:b,get nth(){return $t(C())},on_selected:()=>s(b.id),on_edit:()=>e.on_edit_section?.()})},get children(){return c(ks,ve(e,{section:b,get is_edits_disabled(){return e.is_edits_disabled},get nth(){return $t(C())},get on_edit(){return e.on_edit_section},get on_edit_chapter(){return e.on_edit_chapter}}))}})}),m),u(m,c(E,{get when(){return!e.is_edits_disabled},get children(){var b=ji();return b.$$click=i,b}})),a})()}function ks(e){let[,{create_chapter:t,update_section:n}]=se();const i=async()=>{let a=await t(e.study.id,e.section.id);await s(a.id),e.on_edit_chapter?.()},s=async a=>n(e.study.id,{id:e.section.id,selected_chapter_id:a});return(()=>{var a=Zi(),o=a.firstChild,d=o.firstChild,l=d.firstChild,r=l.nextSibling,m=o.nextSibling,b=m.firstChild,C=b.nextSibling;return u(l,()=>e.nth),u(r,()=>e.section?.name),u(o,c(E,{get when(){return!e.is_edits_disabled},get children(){var v=ot();return v.$$click=()=>e.on_edit?.(),v}}),null),u(b,c(we,{get each(){return e.chapters},get fallback(){return c(Cs,{})},children:(v,g)=>c($s,{get is_edits_disabled(){return e.is_edits_disabled},chapter:v,get nth(){return`${e.nth}${g()+1}`},get selected(){return e.selected_chapter===v},on_selected:()=>s(v.id),on_edit:()=>e.on_edit_chapter?.()})})),u(C,c(E,{get when(){return!e.is_edits_disabled},get children(){var v=Yi();return v.$$click=()=>i(),v}})),B(()=>Tn(r,"title",e.section?.name)),a})()}function $s(e){const t=O(()=>e.selected?" active":"");return(()=>{var n=Ji(),i=n.firstChild,s=i.firstChild,a=s.firstChild;return n.$$click=()=>e.on_selected(),u(s,()=>e.nth,a),u(i,()=>e.chapter.name,null),u(n,c(E,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),B(()=>Z(n,"chapter"+t())),n})()}function ws(e){return(()=>{var t=Xi(),n=t.firstChild,i=n.firstChild,s=i.firstChild,a=s.nextSibling;return n.$$click=()=>e.on_selected(),u(s,()=>e.nth),u(a,()=>e.section.name),u(n,c(E,{get when(){return!e.is_edits_disabled},get children(){var o=ot();return o.$$click=()=>e.on_edit(),o}}),null),t})()}function ys(){return es()}function Cs(){return ts()}function Ns(){return ns()}function Xt(e){return[]}function Ss(e){const[,{update_study:t}]=se(),[n,i]=q("share"),[s,a]=q(!0,{equals:!1}),o=()=>{a(!0),e.on_copy_pgn()},d=e.study.is_edits_disabled,l=v=>t({id:e.study.id,is_edits_disabled:v}),[r,m]=q(!1),[,{study_as_export_pgn:b}]=se(),C=async()=>{m(!0);let v=await b(e.study.id);m(!1),Ls(v,`${e.study.name}.pgn`)};return[(()=>{var v=is(),g=v.firstChild,k=g.nextSibling;return g.$$click=()=>i("settings"),k.$$click=()=>i("share"),B(_=>{var p="tab"+(n()==="settings"?" active":""),S="tab"+(n()==="share"?" active":"");return p!==_.e&&Z(g,_.e=p),S!==_.t&&Z(k,_.t=S),_},{e:void 0,t:void 0}),v})(),(()=>{var v=os();return u(v,c(E,{get when(){return n()==="settings"},get children(){var g=ss(),k=g.firstChild,_=k.firstChild,p=_.nextSibling;return p.addEventListener("change",S=>l(S.currentTarget.checked)),p.checked=d,g}}),null),u(v,c(E,{get when(){return n()==="share"},get children(){return[(()=>{var g=rs(),k=g.firstChild,_=k.firstChild,p=k.nextSibling,S=p.nextSibling;return k.$$click=o,u(k,c(en,{get on_copy(){return s()}}),_),p.$$click=C,u(p,c(E,{get when(){return r()},get fallback(){return"Export as PGN"},children:"Loading..."})),xe(S,"click",e.on_export_lichess,!0),B(()=>p.disabled=r()),g})(),(()=>{var g=as();return g.firstChild,u(g,c(xs,{get value(){return e.fen}}),null),g})()]}}),null),v})()]}function xs(e){const[t,n]=q(!0,{equals:!1}),i=()=>{navigator.clipboard.writeText(e.value),n(!0)};return(()=>{var s=ls(),a=s.firstChild;return s.$$click=i,u(s,c(en,{get on_copy(){return t()}}),null),B(()=>a.value=e.value),s})()}function en(e){Ne(et(()=>e.on_copy,()=>{n(!0),setTimeout(()=>n(!1),1e3)},{defer:!0}));const[t,n]=q(!1);return c(E,{get when(){return t()},get fallback(){return ds()},get children(){return cs()}})}function Es(){return us()}function Ls(e,t){const n=new Blob([e],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(n),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}Ge(["click"]);export{$s as ChapterComponent,Ns as LoadingChapters,Cs as NoChapters,ys as NoSections,Bs as default};
