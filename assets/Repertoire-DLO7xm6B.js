var te=Object.defineProperty;var se=(i,t,e)=>t in i?te(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var f=(i,t,e)=>(se(i,typeof t!="symbol"?t+"":t,e),e);import{h as b,j as re,k as ae,i as _,c as d,S as le,b as g,l as v,o as $,m as oe,f as x,g as ie,F as ne,M as k,n as ce,e as _e,s as j,p as de,d as he,t as l}from"./index-BJpzf9IE.js";/* empty css                   */import{S as me}from"./studyrepo-DWUYRPbt.js";import{S as pe,C as ve}from"./Shalala-B8qAGfmd.js";import{T as ue,C as ge,a as F}from"./Chesstree2-JraKSid0.js";import{I as $e,M as fe}from"./chess_pgn_logic-3ui-LPsv.js";import{m as be}from"./index-BqYE8JOx.js";class O{constructor(t,e){f(this,"_solved_paths");this.study_name=t,this._solved_paths=be(b([[],[]]),{name:`.repertoire_stat.name.${t}.chapter.${e}`})}set solved_paths(t){this._solved_paths[1](t)}get solved_paths(){return this._solved_paths[0]()}}var we=l("<div class=progress><div class=bar></div><h3>"),Se=l("<div class=repertoire-wrap>"),ye=l("<small> Click on variations to expand. "),Ce=l("<small> Your goal is to guess every move correctly to fill up the progress bar. "),ke=l("<h2>Select a Practice Option"),xe=l("<button><span> Play all Moves "),Pe=l("<button><span> Play as Match "),Me=l("<h2>Play as Match"),Ee=l("<small> Try to guess the moves for <!>."),Re=l("<small> AI will play the next move, picking a random variation. "),Te=l("<small> Moves will be hidden once the game is started. "),Ae=l("<div class=in_mode><button><span> Rematch </span></button><button class=end2><span> End Practice "),Ie=l("<h2>Play all moves"),Le=l("<small>Try to guess the moves for both sides."),Ne=l("<small>Moves will be hidden once you start."),De=l("<div class=in_mode><button><span> Clear </span></button><button class=end2><span> End Practice "),Fe=l("<div class=repertoire><div class=list-wrap><h1 class=header>Repertoire</h1><div class=list><div><h3 class=title></h3></div><ul></ul></div></div><div class=board-wrap></div><div class=eval-gauge><div class=white style=height:100%> </div><div class=score></div></div><div class=replay-wrap><div class=replay-header><div class=title><h5>Slav Defense</h5><h4></h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools></div></div></div><div class=under><br><br><br>"),Oe=l("<li><div><h3></h3> ");class Ye{constructor(){f(this,"_mode");f(this,"_match_color");this._mode=b(void 0,{equals:!1}),this._match_color=b("white")}get mode(){return this._mode[0]()}set mode(t){this._mode[1](t)}get match_color(){return this._match_color[0]()}set match_color(t){this._match_color[1](t)}flip_match_color(){this.match_color=this.match_color==="white"?"black":"white"}}const Y=i=>(()=>{var t=we(),e=t.firstChild,a=e.nextSibling;return _(a,()=>`%${i.width}`),x(m=>j(e,`width: ${i.width}%`,m)),t})();class je{constructor(t){this.chapters=t}get progress(){let t=this.chapters.length;return this.chapters.map(e=>Math.round(e.progress/t)).reduce((e,a)=>e+a)}}class u{constructor(t,e){this.score_tree=t,this.solved_paths=e}static load_from_store(t,e){let a=new O(t.name,e);return u.make(t.chapters[e].pgn.tree,F.set_for_saving(a.solved_paths))}static save_paths_to_store(t,e,a){let m=new O(t.name,e);m.solved_paths=a.solved_paths.get_for_saving()}static make(t,e=new F){return new u(fe.make(t),e)}get progress(){return Math.floor(this.solved_paths.expand_paths.map(t=>{var e;return((e=this.score_tree.get_at(t))==null?void 0:e.score)??0}).reduce((t,e)=>t+e,0)*100)}merge_stats(t){this.solved_paths.merge_dup(t.solved_paths)}}const Je=()=>{const i=re(),[t]=ae(i.id,me.read_study);return(()=>{var e=Se();return _(e,d(le,{get when(){return!t.loading},fallback:"Loading...",get children(){return d(qe,{get study(){return t()}})}})),e})()},qe=i=>{const t=()=>i.study;let e=new Ye,a=new pe;const[m,q]=b(0);let w=g(()=>{const s=t();return new je(s.chapters.map((o,p)=>u.load_from_store(s,p)))}),P=g(()=>w().chapters[m()]);const S=g(()=>t().chapters[m()]),h=g(()=>{e.mode;let s=S();return ue.make(s.pgn.tree.clone)});v(()=>{h().solved_paths.replace_all(P().solved_paths)});const y=g($(()=>e.mode,()=>{let s=h().tree;return u.make(s)}));v(()=>{y().solved_paths.replace_all(h().solved_paths)}),v($(y,(s,o)=>{if(o){let p=P();p.merge_stats(o),u.save_paths_to_store(t(),m(),p)}})),v(()=>{let{mode:s,match_color:o}=e;s==="match"&&o==="black"&&setTimeout(()=>{h().reveal_one_random()},400)}),v($(()=>a.add_uci,s=>{if(!s)return;h().try_next_uci_fail(s)&&e.mode==="match"&&setTimeout(()=>{h().reveal_one_random()},400)})),v($(()=>h().fen_last_move,s=>{if(s){let[o,p]=s;a.on_set_fen_uci(o,p)}else a.on_set_fen_uci($e)})),v($(()=>a.on_wheel,s=>{s&&h().on_wheel(s)}));const M=s=>{s.key==="f"&&e.flip_match_color()};document.addEventListener("keypress",M),oe(()=>{document.removeEventListener("keypress",M)});const B=s=>{const o=s.target;o.tagName!=="PIECE"&&o.tagName!=="SQUARE"&&o.tagName!=="CG-BOARD"||(s.preventDefault(),a.set_on_wheel(Math.sign(s.deltaY)))};return v(()=>{e.match_color=t().orientation??"white"}),(()=>{var s=Fe(),o=s.firstChild,p=o.firstChild,G=p.nextSibling,C=G.firstChild,K=C.firstChild,Q=C.nextSibling,E=o.nextSibling,R=E.nextSibling,U=R.firstChild,W=U.nextSibling,z=R.nextSibling,T=z.firstChild,A=T.firstChild,H=A.firstChild,J=H.nextSibling,V=A.nextSibling,X=V.firstChild,Z=T.nextSibling,I=Z.firstChild,ee=I.nextSibling;return s.addEventListener("wheel",B),_(K,()=>t().name),_(C,d(Y,{get width(){return w().progress}}),null),_(Q,d(ne,{get each(){return t().chapters},children:(r,c)=>(()=>{var n=Oe(),L=n.firstChild,N=L.firstChild;return N.nextSibling,n.$$click=()=>q(c()),_(N,()=>r.name),_(L,d(Y,{get width(){var D;return((D=w())==null?void 0:D.chapters[c()].progress)??0}}),null),x(()=>ie(n,c()===m()?"active":"")),n})()})),_(E,d(ve,{get orientation(){return e.match_color},get movable(){return e.mode!==void 0},get doPromotion(){return a.promotion},get onMoveAfter(){return a.on_move_after},get fen_uci(){return a.fen_uci},get color(){return a.turnColor},get dests(){return a.dests}})),_(J,()=>S().name),_(I,d(ge,{get lala(){return h()}})),_(ee,d(_e,{get children(){return[d(k,{get when(){return e.mode===void 0},get children(){return[ye(),Ce(),ke(),(()=>{var r=xe();return r.$$click=()=>e.mode="moves",r})(),(()=>{var r=Pe();return r.$$click=()=>e.mode="match",r})()]}}),d(k,{get when(){return e.mode==="match"},get children(){return[Me(),(()=>{var r=Ee(),c=r.firstChild,n=c.nextSibling;return n.nextSibling,_(r,()=>e.match_color,n),r})(),Re(),Te(),(()=>{var r=Ae(),c=r.firstChild,n=c.nextSibling;return c.$$click=()=>{ce(()=>{e.mode="match",e.flip_match_color()})},n.$$click=()=>e.mode=void 0,r})()]}}),d(k,{get when(){return e.mode==="moves"},get children(){return[Ie(),Le(),Ne(),(()=>{var r=De(),c=r.firstChild,n=c.nextSibling;return c.$$click=()=>{e.mode="moves"},n.$$click=()=>e.mode=void 0,r})()]}})]}})),x(r=>{var c=`height: ${y().progress??0}%`,n=S().site;return r.e=j(W,c,r.e),n!==r.t&&de(X,"href",r.t=n),r},{e:void 0,t:void 0}),s})()};he(["click"]);export{Je as default};
