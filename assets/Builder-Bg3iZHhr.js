import{_ as pt,H as _e,a as b,m as He,c as y,g as M,J as ht,K as gt,I as Z,L as de,N as ce,O as vt,Q as mt,x as pe,r as he,n as D,b as ae,t as N,T as qe,U as Te,V as $e,W as ze,X as Ke,d as xe,C as we,q as F,i as $,S as O,j as se,k as X,F as Ve,M as fe,h as yt,v as oe,$ as bt,p as $t,Y as De,Z as le,a0 as wt,u as Ge,D as Qe,o as kt,B as ve,a1 as Ie,a2 as xt}from"./index-BZK0BI4d.js";import{C as St}from"./chessground-lU4YbH_i.js";import{s as Ct}from"./scroll-DnAhRpRC.js";import{a as Et}from"./random-BMCilaBQ.js";async function Mt(e){const i=await Pt(e);function a(s){return i.transaction(e.store,s).objectStore(e.store)}function u(s){return new Promise((c,l)=>{const r=s();r.onsuccess=o=>c(o.target.result),r.onerror=o=>l(o.target.result)})}return{list:()=>u(()=>a("readonly").getAllKeys()),get:s=>u(()=>a("readonly").get(s)),getMany:s=>u(()=>a("readonly").getAll(s)),put:(s,c)=>u(()=>a("readwrite").put(c,s)),count:s=>u(()=>a("readonly").count(s)),remove:s=>u(()=>a("readwrite").delete(s)),clear:()=>u(()=>a("readwrite").clear()),cursor:(s,c)=>u(()=>a("readonly").openCursor(s,c)).then(l=>l??void 0),txn:s=>i.transaction(e.store,s)}}async function Pt(e){const i=e?.db||`${e.store}--db`;return new Promise((a,u)=>{const s=window.indexedDB.open(i,e?.version??1);s.onsuccess=c=>a(c.target.result),s.onerror=c=>u(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const l=c.target.result,r=c.target.transaction,o=l.objectStoreNames.contains(e.store)?r.objectStore(e.store):l.createObjectStore(e.store);e.upgrade?.(c,o)}})}async function Lt(e){let i;await At({on_received:c,on_status(g){g&&(g.download&&e.on_downloaded_nb(g.download),g.error&&e.on_engine_failed(g.error))},on_connected(g){i=g}}),a("uci");function a(g){i?.(g)}function u(g){o=g,p()}function s(){return!!r&&!r.stop_requested&&!r.swap_requested}function c(g){const m=g.trim().split(/\s+/g);if(m[0]==="uciok")a("ucinewgame"),a("isready");else if(m[0]==="readyok")f();else if(!(m[0]==="id"&&m[1]==="name"))if(m[0]==="bestmove"){r&&h&&r.emit(h),r=void 0,f();return}else if(r&&!r.swap_requested&&!r.stop_requested&&m[0]==="info"){let x=0,E,S=1,j,P,T=!1,k,H=[];for(let R=1;R<m.length;R++)switch(m[R]){case"depth":x=parseInt(m[++R]);break;case"nodes":E=parseInt(m[++R]);break;case"multipv":S=parseInt(m[++R]);break;case"time":j=parseInt(m[++R]);break;case"score":T=m[++R]==="mate",k=parseInt(m[++R]),(m[R+1]==="lowerbound"||m[R+1]==="upperbound")&&(P=m[++R]);break;case"pv":H=m.slice(++R),R=m.length;break}if(T&&!k||(l<S&&(l=S),!_e(E)||!_e(j)||!_e(T)||!_e(k)))return;const V=r.ply%2===1?-k:k;if(P&&S===1)return;const re={moves:H,cp:T?void 0:V,mate:T?V:void 0,depth:x};S===1?h={fen:r.current_fen,depth:x,nodes:E,millis:j,cp:T?void 0:V,mate:T?V:void 0,pvs:[re]}:h&&(h.pvs.push(re),h.depth=Math.min(h.depth,x)),S===l&&h&&(r.on_pvs(h),x>=40&&n())}else g&&!["Stockfish","id","option","info"].includes(m[0])&&console.warn(`SF: ${g}`)}let l=0,r,o,h;function f(){if(!r&&(r=o,o=void 0,r)){h=void 0,l=1,t("Threads",r.threads),t("Hash",r.hash_size||16),t("MultiPV",Math.max(1,r.multi_pv)),_&&_!==r.game_id&&a("ucinewgame"),_=r.game_id,a(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[g,m]=Object.entries(r.search)[0];a(`go ${g} ${m}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function t(g,m){m=m.toString(),d.get(g)!==m&&(a(`setoption name ${g} value ${m}`),d.set(g,m))}function n(){r&&!r.stop_requested&&(r.stop_requested=!0,a("stop"))}function p(){r&&!r.swap_requested&&(r.swap_requested=!0,a("stop")),a("isready")}let _;return{start(g){u(g)},stop(){u()},destroy(){a("quit")},get state(){return s()?"computing":"idle"}}}async function At(e){const i=d=>{e.on_status(d)},a=d=>{e.on_received(d)},u=d=>{e.on_connected(d)};let s=await pt(()=>import("./sf17-79-Kk0KEig0.js"),[]),c=await new Promise((d,t)=>{s.default({wasmMemory:jt(2560),onError:n=>t(new Error(n)),locateFile:n=>`stockfish/${n}`}).then(d).catch(t)}),l=await Mt({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let d=0;;d++){let t=c.getRecommendedNnue(d);if(!t||r.includes(t))break;r.push(t)}(await h(r)).forEach((d,t)=>c.setNnueBuffer(d,t)),c.onError=f(),c.listen=d=>a(d),u(d=>c.uci(d));async function h(d){return Promise.all(d.map(async t=>{let n=await l?.get(t).catch(()=>{});if(n&&n.byteLength>128*1024)return n;const p=new XMLHttpRequest;p.open("get",`stockfish/nnue/${t}`,!0),p.responseType="arraybuffer",p.onprogress=g=>i({download:{bytes:g.loaded,total:g.total}});const _=await new Promise((g,m)=>{p.onerror=()=>m(new Error(`fetch '${t}' failed: ${p.status}`)),p.onload=()=>{p.status/100===2?g(new Uint8Array(p.response)):m(new Error(`fetch '${t}' failed: ${p.status}`))},p.send()});return i(),l?.put(t,_).catch(()=>console.warn("IDB store failed")),_}))}function f(){return d=>{if(d.startsWith("BAD_NNUE")&&l){const t=Math.max(0,Number(d.slice(9))),n=c.getRecommendedNnue(t);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${n} from IDB`),l.remove(n)},2e3)}else i({error:d})}}}const jt=(e,i=32767)=>{let a=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:i})}catch(u){if(i<=e||!(u instanceof RangeError))throw u;i=Math.max(e,Math.ceil(i-i/a)),a=a===4?3:4}},Se=ht();function Nt(e){let[i,a]=b(void 0),[u,s]=b(void 0),[c]=He(()=>Lt({on_downloaded_nb(f){a(f)},on_engine_failed(f){s(f)}}));function l(f,d,t,n,p,_,g,m){let x=c();if(!x)return _(),()=>{};let E=Math.max(1,navigator.hardwareConcurrency-2);x.start({threads:E,hash_size:256,game_id:f,stop_requested:!1,swap_requested:!1,path:[],search:{depth:p},multi_pv:n,ply:t,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(j){m(j)},on_pvs:gt(200,function(j){g(j)})})}let r={};function o(f,d,t,n,p,_,g,m){let x=[d,n,p].join("$$"),S=(()=>{let P=p===8?[20,8]:[20],T=n===1?[6,1]:[6];return P.flatMap(k=>T.map(H=>[d,H,k].join("$$")))})().find(P=>r[P]);S?m(r[S]):l(f,d,t,n,p,_,g,j);function j(P){r[x]=P,m(P)}}let h={get download_nb(){return i()},get engine_failed(){return u()},get state(){let f=c();return c.loading||!f?"loading":f.state},best_move_with_cache:o,stop(){c()?.stop()}};return y(Se.Provider,{value:h,get children(){return M(()=>e.children)}})}const me={equals:!1};function te(e,i,a){let u=!1,s=!0;const[c,l]=b(void 0,me),r=M(n=>u?e(n):(s=!c(),n),i,me);let[o,h]=b(void 0,me),f;return[()=>(u=!0,s&&(s=l()),f=r(),u=!1,h(),f),()=>{if(o(),f)return f}]}var Rt=N('<div class="is2d chessboard">');function qt(){let[e,i]=b(Z),[a,u]=b(void 0),[s,c]=b(void 0),l=M(()=>de.fromSetup(ce(e()).unwrap()).unwrap()),r=M(()=>l().turn),o=M(()=>vt(l()));const h=d=>{let t=l(),n=qe(d),p=Te(t,n);t.play(n),pe(()=>{u([d,p]),c([d,p]),i($e(t.toSetup())),d.length})},f=d=>{if(!d){u(void 0);return}let t=Te(l(),qe(d));u([d,t])};return{play_orig_key(d,t){let n=l(),p=r(),_=n.board.get(mt(d)),g=d+t;_.role==="pawn"&&(t[1]==="8"&&p==="white"||t[1]==="1"&&p==="black")&&(g+="q"),h(g)},play_uci:h,set_fen_and_last_move(d,t){pe(()=>{f(t),i(d)})},set_fen(d){i(d)},set_last_move(d){f(d)},get dests(){return o()},get fen(){return e()},get last_move(){return a()},get on_last_move_added(){return s()},get check(){return l().isCheck()},get isEnd(){return l().isEnd()}}}function Tt(e){let i,a;return he(()=>{let u=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:u,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};a=St(i,c)}),D(()=>{let u;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;u=[s.slice(0,2),s.slice(2,4)]}a.set({lastMove:u,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),D(()=>{a.setAutoShapes(e.shapes??[])}),(()=>{var u=Rt();return ae(s=>i=s,u),u})()}function Xe(e,i,a,u){let s=ze(i,a),c=Ke(s),l=$e(i.toSetup());i.play(s);let r=$e(i.toSetup());return{path:u.length===0?c:`${u} ${c}`,ply:e,before_fen:l,fen:r,uci:c,san:a}}function Ye(e,i,a){let u=i[i.length-1];return a||(a=de.fromSetup(ce(u?.fen??Z).unwrap()).unwrap()),[...i,Xe((u?.ply??0)+1,a,e,u?.path??"")]}function Be(e,i=Z){let a=[],u=de.fromSetup(ce(i).unwrap()).unwrap();for(let s of e)a=Ye(s,a,u);return a}var Dt=N("<div class=replay-single><div class=moves>"),It=N("<span class=index>"),Bt=N("<span><span class=san>"),Ue=N("<span class=eval>"),We=N("<span class=loading>."),Ut=N("<span class=judgement>");function Wt(){let[e,i]=b([]);const a=M(()=>{let t=e();return t[t.length-1]});let[u,s]=b(a()?.ply??0);const c=M(()=>{let t=u();return e().find(p=>p.ply===t)});let l=M(we(e,t=>t.san)),r=M(we(e,t=>t.ply)),o=M(()=>{let t=l(),n=r();return t.map((p,_)=>`${n[_]} ${p}`)});const h=t=>{s(t)},f=()=>{let t=u()-1;return r().find(n=>n===t)},d=()=>{let t=u()+1;return r().find(n=>n===t)};return{set_sans(t){i(Be(t)),s(t.length)},get steps(){return e()},get steps_up_to_ply(){return e().slice(0,u())},get plies(){return r()},get sans(){return l()},get ply_sans(){return o()},get ply_step(){return c()},get last_step(){return a()},get ply(){return u()},goto_ply:h,get_prev_ply:f,get_next_ply:d,goto_prev_ply_if_can(){let t=f();t!==void 0&&h(t),u()===1&&s(0)},goto_next_ply_if_can(){let t=d();t!==void 0&&h(t)},play_san(t){let n=a();if(!n){i(Be([t]));return}let p=e();i(Ye(t,p)),s(n.ply+1)},get is_on_last_ply(){return u()===(a()?.ply??0)}}}function Ot(e){const i=M(we(()=>e.play_replay.ply_sans,l=>{let[r,o]=l.split(" ");return{ply:parseInt(r),san:o}})),a=l=>{e.play_replay.goto_ply(l)},u=M(()=>e.play_replay.ply_step?.ply);D(F(()=>e.play_replay.steps,l=>e.steps_stockfish.set_steps(l)));let s;const c=l=>{let r=e.steps_stockfish.steps_with_stockfish[l];if(!r)return"";let o=r.d20pv6[1](),h=r.d20pv1[1](),f=r.d8pv6[1](),d=r.d8pv1[1]();if(o)return(o.judgement??"")+" d20pv6";if(h)return(h.judgement??"")+" d20pv1";if(f)return(f.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return D(()=>{if(i().length<7)return;let r=s.parentElement,o;if(e.play_replay.ply<3)o=0;else if(e.play_replay.is_on_last_ply)o=99999;else{let h=r.querySelector(".active");h&&(o=h.offsetTop-s.offsetHeight/2+h.offsetHeight/2)}o!==void 0&&r.scrollTo({top:o})}),(()=>{var l=Dt(),r=l.firstChild;return ae(o=>s=o,r),$(r,y(Ve,{get each(){return i()},children:(o,h)=>[y(O,{get when(){return o.ply%2===1},get children(){var f=It();return $(f,()=>Math.ceil(o.ply/2)),f}}),(()=>{var f=Bt(),d=f.firstChild;return f.$$click=()=>a(o.ply),$(d,()=>o.san),$(f,y(O,{get when(){return e.steps_stockfish.steps_with_stockfish[h()]},children:t=>y(Ft,{get ss(){return t()}})}),null),se(()=>X(f,"move "+c(h())+(o.ply===u()?" active":""))),f})()]})),l})()}function Ft(e){return y(yt,{get fallback(){return y(ie,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[y(fe,{get when(){return e.ss.d20pv6[1]()},children:i=>y(ie,{get step(){return i()}})}),y(fe,{get when(){return e.ss.d20pv1[1]()},children:i=>y(ie,{get step(){return i()}})}),y(fe,{get when(){return e.ss.d8pv6[1]()},children:i=>y(ie,{get step(){return i()}})}),y(fe,{get when(){return e.ss.d8pv1[1]()},children:i=>y(ie,{get step(){return i()}})})]}})}function ie(e){const i=()=>e.step.search?.cp,a=()=>e.step.judgement,u=c=>c==="good"?"✓":c==="inaccuracy"?"?!":c==="mistake"?"?":"??",s=()=>e.step.progress?.depth;return(()=>{var c=Ue();return $(c,y(O,{get when(){return i()!==void 0},get fallback(){return(()=>{var l=We();return l.firstChild,$(l,s,null),l})()},get children(){var l=Ue();return $(l,()=>Ht(i())),l}}),null),$(c,y(O,{get when(){return a()},get fallback(){return We()},children:l=>(()=>{var r=Ut();return $(r,()=>u(l())),r})()}),null),c})()}function Ht(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}xe(["click"]);var ye=Symbol("fallback");function Oe(e){for(const i of e)i.dispose()}function Je(e,i,a,u={}){const s=new Map;return oe(()=>Oe(s.values())),()=>{const l=e()||[];return l[bt],$t(()=>{if(!l.length)return Oe(s.values()),s.clear(),u.fallback?[De(d=>(s.set(ye,{dispose:d}),u.fallback()))]:[];const r=new Array(l.length),o=s.get(ye);if(!s.size||o){o?.dispose(),s.delete(ye);for(let f=0;f<l.length;f++){const d=l[f],t=i(d,f);c(r,d,f,t)}return r}const h=new Set(s.keys());for(let f=0;f<l.length;f++){const d=l[f],t=i(d,f);h.delete(t);const n=s.get(t);n?(r[f]=n.mapped,n.setIndex?.(f),n.setItem(()=>d)):c(r,d,f,t)}for(const f of h)s.get(f)?.dispose(),s.delete(f);return r})};function c(l,r,o,h){De(f=>{const[d,t]=b(r),n={setItem:t,dispose:f};if(a.length>1){const[p,_]=b(o);n.setIndex=_,n.mapped=a(d,p)}else n.mapped=a(d);s.set(h,n),l[o]=n.mapped})}}function zt(e){const{by:i}=e;return M(Je(()=>e.each,typeof i=="function"?i:a=>a[i],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var Kt=N("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),Ze=N("<span class=index>"),Vt=N("<div class=fbt>"),Gt=N("<div class=lines>"),Qt=N("<div class=line>"),Xt=N("<span class=collapsed>..<!> "),Yt=N("<div>");function Jt(e){return wt(e).map(i=>{let a=i.headers.get("Event"),u=i.headers.get("Site"),s=i.headers.get("White"),c=i.headers.get("Black"),l=i.headers.get("Chapter"),r=i.headers.get("Orientation"),o=i.headers.get("FEN"),h=o??Z,f=de.fromSetup(ce(h).unwrap()).unwrap(),d=et();i.moves.children.forEach(n=>{t(n,f,"")});function t(n,p,_){let g=n.data.san,m=ze(p,g),x=p.clone();x.play(m);let E=Ke(m),S=n.data.nags;d.add_child_san(_,g).set_nags(S??[]);let j=_.length===0?E:`${_} ${E}`;n.children.forEach(P=>{t(P,x,j)})}return{event:a,site:u,white:s,black:c,chapter:l,fen:o,orientation:r,tree:d}})}function et(){let[e,i]=b([]);const a=l=>u(l)?.[1],u=l=>{if(l==="")return;let r=l.split(" "),o=0,h,f=e();for(;;){let d=r.slice(0,o+1).join(" "),t=f.find(n=>n.path===d);if(!t)return;if(o++,o===r.length)return[h,t];h=t,f=t.children}};function s(l,r=!1){let o=l.ply,h=o%2===1||r?Math.ceil(o/2)+(o%2===1?".":"..."):"",f=o%2===1?"":" ";return`${h} ${l.san}${l.comments?" { "+l.comments+" }":""}${f}`}function c(l,r=!1){let o="";return l.length===0||(l.length===1?(o+=s(l[0].step,r),o+=c(l[0].children,!1)):(o+=s(l[0].step,!1).trimEnd(),o+=" "+l.slice(1).map(h=>`(${c([h],!0).trimEnd()})`).join(" "),o+=" "+c(l[0].children,!0))),o}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(l){if(l.length===0)return[];let r=l[0],o=this.add_child_san("",r),h=[o];return l.slice(1).forEach(f=>{o=o.add_child_san(f),h.push(o)}),h},add_child_san(l,r){if(l===""){let h=e(),f=h.find(n=>n.san===r);if(f)return f;let d=de.fromSetup(ce(Z).unwrap()).unwrap(),t=tt(0,d,r,"");return i([...h,t]),t}let o=a(l);if(o)return o.add_child_san(r)},remove_child_at_path(l){let r=u(l);if(r){if(!r[0]){let o=e(),h=o.indexOf(r[1]);return o.splice(h,1),i([...o]),r[1]}return r[0].remove_child(r[1]),r[1]}},find_at_path:a,find_parent_and_child_at_path:u,siblings_of(l){let r=u(l)?.[0];if(r)return r.children;if(l.split(" ").length===1)return e()},previous_branch_points(l){let r=[],o=e(),h=o.length>1;for(let f of l.split(" ")){let d=o.find(t=>t.step.uci===f);if(!d)return;h&&(r.push(d),h=!1),d.children.length>1&&(h=!0),o=d.children}return r}}}function tt(e,i,a,u){let[s,c]=b([]),[l,r]=b([]);i=i.clone();let o=Xe(e,i,a,u),h=()=>f()?.length??0,f=()=>d()?.children,d=()=>{let n=s();if(n.length!==0)return n.length===1?n[0].first_node_with_variations:t},t={get nags(){return l()},set_nags:r,get path(){return o.path},get ply(){return o.ply},get san(){return o.san},step:o,get children(){return s()},remove_child(n){let p=s(),_=p.indexOf(n);if(_!==-1)return p.splice(_,1),c([...p]),n},add_child_san(n){let p=s(),_=p.find(m=>m.san===n);if(_)return _;let g=tt(e+1,i,n,o.path);return c([...p,g]),g},remove_child_san(n){let p=s(),_=p.findIndex(m=>m.step.san!==n);if(_===-1)return;let g=p.splice(_,1)[0];return c([...p]),g},get nb_first_variations(){return h()},get first_node_with_variations(){return d()},get length(){let n=s();if(n.length>1)return 1;if(n.length===0)return 0;let p=1,_=n[0];for(;_?.children.length===1;)p++,_=_.children[0];return p}};return t}function Zt(e){let i=et();e&&(i=Jt(e)[0].tree);let[a,u]=b(""),s=[];D(F(a,t=>{i.previous_branch_points(t)?.map(n=>{s.includes(n.path)||(i.siblings_of(n.path)?.forEach(p=>{s=s.filter(_=>_!==p.path)}),s.push(n.path))})}));const c=t=>{u(t)},l=()=>{let t=a();if(t!=="")return t.split(" ").slice(0,-1).join(" ")},r=()=>{let t=a(),n=i.find_at_path(t)?.children??i.root;return n.length===1?n[0].path:n.find(p=>s.includes(p.path))?.path??n[0]?.path},o=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t;if(!n[0])return"";if(n[0].children.length>1)return n[0].path;for(;!(!n[0]||n[0].children.length>1);){let p=i.find_parent_and_child_at_path(n[0].path);if(!p)break;n=p}return n[1].path},h=()=>{let t=i.find_at_path(a());if(!t)return i.root.find(p=>s.includes(p.path))?.path??i.root[0]?.path;let n=t;if(n.children.length>1)return n.children.find(p=>s.includes(p.path))?.path??n.children[0]?.path;for(;n.children.length===1;)n=n.children[0];return n.path},f=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=i.root;else if(t[0].children.length===1)for(;;){if(t=i.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=i.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p-1];if(_)return _.path},d=()=>{let t=i.find_parent_and_child_at_path(a());if(!t)return;let n=t[0]?.children??[];if(!t[0])n=i.root;else if(t[0].children.length===1)for(;;){if(t=i.find_parent_and_child_at_path(t[0].path),!t)return;if(!t[0]){n=i.root;break}if(t[0].children.length>1){n=t[0].children;break}}let p=n.indexOf(t[1]),_=n[p+1];if(_)return _.path};return{steps:i,get cursor_path(){return a()},set cursor_path(t){u(t)},get cursor_path_step(){return i.find_at_path(a())?.step},goto_path:c,get_prev_path:l,get_next_path:r,goto_prev_if_can(){let t=l();t!==void 0&&c(t)},goto_next_if_can(){let t=r();t!==void 0&&c(t)},get_first_path:o,get_last_path:h,get_up_path:f,get_down_path:d,goto_up_if_can(){let t=f();t!==void 0&&c(t)},goto_down_if_can(){let t=d();t!==void 0&&c(t)},goto_last_if_can(){let t=h();t!==void 0&&c(t)},goto_first_if_can(){let t=o();t!==void 0&&c(t)},get previous_branch_points_at_cursor_path(){return i.previous_branch_points(a())??[]}}}function en(e){const i=e.play_replay.steps;let a;D(()=>{let s=e.play_replay.cursor_path,c=a.parentElement;if(!c)return;const l=a.querySelector(".on-path-end");if(!l){c.scrollTop=s.length>0?99999:0;return}let r=l.offsetTop-c.offsetHeight/2+l.offsetHeight;c.scrollTo({behavior:"smooth",top:r})});const u=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return he(()=>{document.addEventListener("keydown",u),oe(()=>{document.removeEventListener("keydown",u)})}),(()=>{var s=Kt(),c=s.firstChild,l=c.firstChild,r=c.nextSibling,o=r.firstChild,h=o.nextSibling,f=r.nextSibling,d=f.firstChild,t=d.nextSibling,n=t.nextSibling,p=n.nextSibling;return ae(_=>a=_,l),$(l,y(ke,{get nodes(){return i.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:_=>e.play_replay.cursor_path=_,on_context_menu:(_,g)=>e.on_context_menu?.(_,g)})),o.$$click=()=>e.play_replay.goto_up_if_can(),h.$$click=()=>e.play_replay.goto_down_if_can(),$(r,y(Ve,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:_=>(()=>{var g=Vt();return g.$$click=()=>e.play_replay.cursor_path=_.path,$(g,y(O,{get when(){return _.ply&1},get children(){var m=Ze();return $(m,()=>nt(_.ply)),m}}),null),$(g,()=>_.san,null),g})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),t.$$click=()=>e.play_replay.goto_prev_if_can(),n.$$click=()=>e.play_replay.goto_next_if_can(),p.$$click=()=>e.play_replay.goto_last_if_can(),se(_=>{var g=e.play_replay.get_up_path()===void 0,m="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),x=e.play_replay.get_down_path()===void 0,E="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),S=e.play_replay.get_first_path()===void 0,j="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),P=e.play_replay.get_prev_path()===void 0,T="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),k=e.play_replay.get_next_path()===void 0,H="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),W=e.play_replay.get_last_path()===void 0,V="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return g!==_.e&&(o.disabled=_.e=g),m!==_.t&&X(o,_.t=m),x!==_.a&&(h.disabled=_.a=x),E!==_.o&&X(h,_.o=E),S!==_.i&&(d.disabled=_.i=S),j!==_.n&&X(d,_.n=j),P!==_.s&&(t.disabled=_.s=P),T!==_.h&&X(t,_.h=T),k!==_.r&&(n.disabled=_.r=k),H!==_.d&&X(n,_.d=H),W!==_.l&&(p.disabled=_.l=W),V!==_.u&&X(p,_.u=V),_},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function ke(e){return[y(O,{get when(){return e.nodes.length===1},get children(){return[y(be,le(e,{get node(){return e.nodes[0]}})),y(ke,le(e,{get nodes(){return e.nodes[0].children}}))]}}),y(O,{get when(){return e.nodes.length>1},get children(){var i=Gt();return $(i,y(zt,{get each(){return e.nodes},by:"path",children:a=>(()=>{var u=Qt();return $(u,y(O,{get when(){return e.cursor_path.startsWith(a().path)},get fallback(){return[y(be,le(e,{get node(){return a()},show_index:!0,collapsed:!0})),(()=>{var s=Xt(),c=s.firstChild,l=c.nextSibling;return l.nextSibling,$(s,()=>a().length,l),$(s,()=>a().nb_first_variations,null),s})()]},get children(){return[y(be,le(e,{get node(){return a()},show_index:!0})),y(ke,le(e,{get nodes(){return a().children}}))]}})),u})()})),i}})]}function be(e){let i=M(()=>e.node.ply%2===0||e.show_index),a=M(()=>e.node.ply%2===0?".":"...");const u=M(()=>e.node.path),s=M(()=>e.cursor_path.startsWith(u())),c=M(()=>u()===e.cursor_path),l=M(()=>{let r=["move"];return e.collapsed&&r.push("collapsed"),s()&&r.push("on-path"),c()&&r.push("on-path-end"),r.join(" ")});return(()=>{var r=Yt();return r.$$click=()=>{e.on_set_cursor(e.node.path)},r.$$contextmenu=o=>{o.preventDefault(),e.on_context_menu(o,e.node.path)},$(r,y(O,{get when(){return i()},get children(){var o=Ze();return $(o,()=>Math.floor(e.node.ply/2)+1,null),$(o,a,null),o}}),null),$(r,()=>e.node.san,null),se(()=>X(r,l())),r})()}const nt=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");xe(["click","contextmenu"]);const tn=(e,i)=>e==="white"?i:-i,rt=e=>2/(1+Math.exp(-.00368208*e))-1,nn=e=>rt(Math.min(Math.max(-1e3,e),1e3)),rn=e=>{const a=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return rt(a)},ln=e=>typeof e.mate<"u"?rn(e.mate):nn(e.cp),Fe=(e,i)=>tn(e,ln(i)),an=(e,i,a)=>(Fe(e,i)-Fe(e,a))/2,sn=(e,i,a)=>an(e,i,a);function on(){let e=Ge(Se);function i(n,p,_,g,m,x,E){e.best_move_with_cache(o(),n,p,_,g,m,x,E)}let a,u=[];function s(n,p,_,g){let[m,x]=b(void 0),[E,S]=b(void 0),[j,P]=b(void 0),T={get loading(){return m()},get depth_eval(){return E()},get best_eval(){return j()},cancel:H},k={cancel:H,fen:n,ply:p,depth:_,multi_pv:g,set_loading:x,set_depth_eval:S,set_best_eval:P};function H(){let W=u.indexOf(k);W!==-1&&u.splice(W,1),a===k&&(console.trace("working cancel"),a=void 0,e.stop()),c()}return u.push(k),c(),T}function c(){if(a||(a=u.pop(),!a))return;const n=p=>{a?.set_best_eval(p),a=void 0,c()};i(a.fen,a.ply,a.multi_pv,a.depth,a.set_loading,a.set_depth_eval,n)}function l(n,p,_){let g=s(n.before_fen,n.ply-1,p,_),m=s(n.fen,n.ply,p,_);function x(E,S,j){let P=sn(E,S,j);return P<.03?"good":P<.05?"inaccuracy":P<.12?"mistake":"blunder"}return M(()=>(oe(()=>{m.cancel(),g.cancel()}),{...n,get before_search(){return g.best_eval},get search(){return n.fen,m.best_eval?.fen,m.best_eval},get judgement(){let E=g.best_eval,S=m.best_eval;if(E&&S)return x(Qe(n.before_fen),E,S)},get progress(){return m?.depth_eval}}))}function r(n){let[p,_]=b(te(()=>l(n,8,6)())),[g,m]=b(te(()=>l(n,8,1)())),[x,E]=b(te(()=>l(n,20,6)())),[S,j]=b(te(()=>l(n,20,1)()));return{step:n,get d8pv6(){return p()},get d8pv1(){return g()},get d20pv6(){return x()},get d20pv1(){return S()},clear(){_(te(()=>l(n,8,6)())),E(te(()=>l(n,20,6)())),m(te(()=>l(n,8,1)())),j(te(()=>l(n,20,1)()))}}}let[o,h]=b(""),[f,d]=b([]),t=Je(f,n=>[n.fen,n.uci].join("$$"),n=>r(n()));return{set_game_id:h,set_steps:d,get steps_with_stockfish(){return t()}}}var dn=N("<div class=loading><span class=info>Loading <!>%"),cn=N("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth 8</label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),un=N("<span class=result>Game Over"),_n=N("<small class=drop>Evaluation Dropped Below -2"),fn=N("<div class=result-wrap>"),pn=N("<div class=tools-wrap><button class=save>Save Line</button><button class=rematch>Rematch"),hn=N("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tabs-wrap><div>Match</div><div>Repertoire"),gn=N("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=delete data-icon=>Delete move");const kn=()=>y(Nt,{get children(){return y(vn,{})}});function vn(){let[e]=He(()=>Ge(Se));const i=M(()=>{let a=e()?.download_nb;if(a)return Math.ceil(a.bytes/(a.total===0?70*1024*1024:a.total)*100)});return y(O,{get when(){return e()},children:a=>y(O,{get when(){return a().state==="loading"},get fallback(){return y(mn,{})},get children(){var u=dn(),s=u.firstChild,c=s.firstChild,l=c.nextSibling;return l.nextSibling,$(s,()=>i()??"--",l),u}})})}function mn(){const e=kt();e.setVolume(.2);let[i,a]=ve([],"builder.current.sans");const[u,s]=b(8);let c="";const l=on(),r=Wt();let o=qt();const[h,f]=b("white"),d=M(()=>Ie(h())),t=M(()=>{let v=l.steps_with_stockfish;return v[v.length-1]});function n(v){return u()===8?v.d8pv6:v.d20pv6}function p(v){return u()===8?v.d8pv1[0]():v.d20pv1[0]()}D(F(t,v=>{if(!v)return;if(Qe(v.step.fen)===d()){let I=dt();if(I&&I.startsWith(v.step.path)){let q=I.slice(v.step.path.length).trim().split(" ")[0];if(q){o.play_uci(q);return}}let z=n(v)[0]();D(F(()=>z.search,q=>{if(!q)return;let K=q.cp,w=q.pvs,L=q.pvs.filter(A=>Math.abs(A.cp-K)<=10),B=q.pvs.filter(A=>Math.abs(A.cp-K)<=30),G=q.pvs.filter(A=>Math.abs(A.cp-K)<=60),Y=q.pvs.filter(A=>Math.abs(A.cp-K)<=100),Q=q.pvs.filter(A=>Math.abs(A.cp-K)<200);L=L.filter(A=>A.cp<150),B=B.filter(A=>A.cp<150),G=G.filter(A=>A.cp<150),Y=Y.filter(A=>A.cp<150),Q=Q.filter(A=>A.cp<150);function ee(A){return A.find(ge=>ge.length>0)}let J;switch(ne()){case"A":J=ee([L,w]);break;case"B":J=ee([B,L,w]);break;case"C":J=ee([G,B,L,w]);break;case"D":J=ee([Y,G,B,L,w]);break;case"E":J=ee([Q,Y,G,B,L,w]);break}o.play_uci(Et(J).moves[0])}))}})),D(F(()=>o.on_last_move_added,v=>{v&&r.play_san(v[1])})),D(F(()=>r.sans,a)),D(F(()=>r.ply_step,v=>{o.set_fen_and_last_move(v?.fen??Z,v?.uci)})),D(F(()=>r.ply_step,(v,C)=>{v&&(!C||C.ply===v.ply-1)&&e.move(v)}));const _=Ct(v=>{const C=v.target;C.tagName!=="PIECE"&&C.tagName!=="SQUARE"&&C.tagName!=="CG-BOARD"||(v.preventDefault(),g(Math.sign(v.deltaY)))}),g=v=>{v>0?(W()==="match"&&r.goto_next_ply_if_can(),W()==="repertoire"&&k.goto_next_if_can()):(W()==="match"&&r.goto_prev_ply_if_can(),W()==="repertoire"&&k.goto_prev_if_can())};l.set_game_id(c),r.set_sans(i());const m=()=>{a([]),r.set_sans(i()),o.set_fen_and_last_move(Z),T(void 0)};D(F(u,()=>{l.steps_with_stockfish.forEach(C=>{pe(()=>{C.clear(),p(C)})});let v=t();v&&n(v)[0]()})),D(F(t,v=>{if(!v)return;let C=p(v);D(F(()=>C.search,I=>{let z=I?.cp;z&&z<-200&&T("drop")}))}));let[x,E]=ve("","builder.current.cursor_path"),[S,j]=ve(void 0,"builder.current.pgn");const[P,T]=b(void 0),k=Zt(S());k.cursor_path=x(),D(F(()=>k.cursor_path,v=>{E(v)})),D(F(()=>k.cursor_path_step,v=>{v?o.set_fen_and_last_move(v.fen,v.uci):o.set_fen_and_last_move(Z)}));const H=()=>{pe(()=>{let C=r.steps_up_to_ply.map(q=>q.san),I=k.steps.add_sans_at_root(C),z=I[I.length-1]?.path;z&&(V("repertoire"),k.cursor_path=z,j(k.steps.as_pgn))})},[W,V]=b("match");D(F(W,v=>{let C=v==="repertoire"?k.cursor_path_step:r.ply_step;C?o.set_fen_and_last_move(C.fen,C.uci):o.set_fen_and_last_move(Z)}));let re,R;const lt=(v,C)=>{k.cursor_path=C,ue(k.steps.find_at_path(C));let I=v.clientX,z=v.clientY,q=R.getBoundingClientRect(),K=re.getBoundingClientRect();I-=K.left,z-=K.top,I=Math.min(I,document.body.clientWidth-q.width-K.left-20);let w=`${z}px`,L=`${I}px`;R.style.top=w,R.style.left=L};he(()=>{const v=()=>{ue(void 0)};document.addEventListener("click",v),oe(()=>{document.removeEventListener("click",v)})});const[it,ue]=b(void 0),at=v=>{k.steps.remove_child_at_path(v),ue(void 0)},Ce=v=>{s(v)},st=M(()=>!o.isEnd&&r.is_on_last_ply&&P()===void 0);he(()=>{const v=C=>{C.key==="f"&&f(Ie(h()))};document.addEventListener("keypress",v),oe(()=>{document.removeEventListener("keypress",v)})});const[ne,ot]=b("A"),[dt,ct]=b(void 0),ut=v=>{ct(v),ue(void 0)};return(()=>{var v=hn(),C=v.firstChild,I=C.nextSibling,z=I.firstChild,q=z.firstChild,K=q.nextSibling;return xt(v,"wheel",_),ae(w=>re=w,v),$(C,y(Tt,{get orientation(){return h()},get color(){return h()},get movable(){return st()},play_uci:o})),q.$$click=()=>V("match"),K.$$click=()=>V("repertoire"),$(I,y(O,{get when(){return W()==="match"},get children(){return[(()=>{var w=cn(),L=w.firstChild,B=L.firstChild,G=B.nextSibling,Y=G.firstChild,Q=Y.nextSibling,ee=Q.nextSibling,J=ee.nextSibling,Ee=J.nextSibling,A=L.nextSibling,ge=A.firstChild,Me=ge.firstChild,Pe=Me.firstChild,_t=Me.nextSibling,ft=_t.firstChild;return G.addEventListener("change",U=>ot(U.currentTarget.value)),Pe.addEventListener("change",U=>{U.target.checked&&Ce(8)}),Pe.checked=!0,ft.addEventListener("change",U=>{U.target.checked&&Ce(20)}),se(U=>{var Le=ne()==="A",Ae=ne()==="B",je=ne()==="C",Ne=ne()==="D",Re=ne()==="E";return Le!==U.e&&(Y.selected=U.e=Le),Ae!==U.t&&(Q.selected=U.t=Ae),je!==U.a&&(ee.selected=U.a=je),Ne!==U.o&&(J.selected=U.o=Ne),Re!==U.i&&(Ee.selected=U.i=Re),U},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),w})(),y(Ot,{play_replay:r,steps_stockfish:l}),(()=>{var w=fn();return $(w,y(O,{get when(){return P()==="drop"},get children(){return[un(),_n()]}})),w})(),(()=>{var w=pn(),L=w.firstChild,B=L.nextSibling;return L.$$click=H,B.$$click=m,w})()]}}),null),$(I,y(O,{get when(){return W()==="repertoire"},get children(){return y(en,{play_replay:k,on_context_menu:lt})}}),null),$(v,y(O,{get when(){return it()},children:w=>(()=>{var L=gn(),B=L.firstChild,G=B.nextSibling,Y=G.nextSibling;return ae(Q=>R=Q,L),L.$$click=Q=>{Q.preventDefault(),Q.stopImmediatePropagation()},$(B,()=>nt(w().ply),null),$(B,()=>w().san,null),G.$$click=()=>ut(w().path),Y.$$click=()=>at(w().path),L})()}),null),se(w=>{var L="tab"+(W()==="match"?" active":""),B="tab"+(W()==="repertoire"?" active":"");return L!==w.e&&X(q,w.e=L),B!==w.t&&X(K,w.t=B),w},{e:void 0,t:void 0}),v})()}xe(["click"]);export{kn as default};
