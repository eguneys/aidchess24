var oe=Object.defineProperty;var ie=(o,t,e)=>t in o?oe(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var R=(o,t,e)=>(ie(o,typeof t!="symbol"?t+"":t,e),e);import{h as I,j as ne,k as ce,i as d,c as p,S as _e,b as u,l as $,m as N,o as T,n as K,p as he,q as de,f as L,g as me,F as Q,s as A,M as j,r as pe,e as ue,v as ve,d as ge,t as i}from"./index-B6Rx-8TO.js";import{m as $e}from"./index-xcL6xpPf.js";import{S as fe}from"./studyrepo-CGVH7U5T.js";import{S as be,C as we}from"./Shalala-CuheF1JJ.js";import{T as ke,a as F,C as ye}from"./Chesstree2-DLgqv8hw.js";import{I as Se,M as Ce}from"./chess_pgn_logic-BkHG66ZY.js";class U{constructor(t,e){R(this,"_solved_paths");this.study_name=t,this._solved_paths=$e(I([[],[]]),{name:`.repertoire_stat.name.${t}.chapter.${e}`})}set solved_paths(t){this._solved_paths[1](t)}get solved_paths(){return this._solved_paths[0]()}}function xe(o){let t=0;return e=>{t+=e.deltaY*(e.deltaMode?40:1),Math.abs(t)>=4?(o(e,!0),t=0):o(e,!1)}}var Me=i("<div class=progress><div class=bar></div><h3>"),Pe=i("<div class=repertoire-wrap>"),Ee=i("<small> Click on variations to expand. "),Re=i("<small> Your goal is to guess every move correctly to fill up the progress bar. "),Te=i("<h2>Select a Practice Option"),Le=i("<button><span> Play all Moves "),Ae=i("<button><span> Play as Match "),Ie=i("<h2>Play as Match"),Ne=i("<small> Try to guess the moves for <!>."),De=i("<small> AI will play the next move, picking a random variation. "),Oe=i("<small> Moves will be hidden once the game is started. "),je=i("<div class=in_mode><button><span> Rematch </span></button><button class=end2><span> End Practice "),Fe=i("<h2>Play all moves"),Ye=i("<small>Try to guess the moves for both sides."),qe=i("<small>Moves will be hidden once you start."),Be=i("<div class=in_mode><button><span> Clear </span></button><button class=end2><span> End Practice "),Ge=i("<div class=repertoire><div class=list-wrap><h1 class=header>Repertoire</h1><div class=list><div><h3 class=title></h3></div><ul></ul></div></div><div class=board-wrap></div><div class=eval-gauge></div><div class=replay-wrap><div class=replay-header><div class=title><h5>Slav Defense</h5><h4></h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools></div></div></div><div class=under><br><br><br>"),He=i("<li><div><h3></h3> "),Ke=i('<div class=line><span class="fill white"></span><span class="fill black">');const Qe=["#afacc6","#0d2b45","#203c56","#544e68","#8d697a","#d08159"],Ue=o=>Qe[Math.floor((1-o/10)*6)];class We{constructor(){R(this,"_mode");R(this,"_match_color");this._mode=I(void 0,{equals:!1}),this._match_color=I("white")}get mode(){return this._mode[0]()}set mode(t){this._mode[1](t)}get match_color(){return this._match_color[0]()}set match_color(t){this._match_color[1](t)}flip_match_color(){this.match_color=this.match_color==="white"?"black":"white"}}const W=o=>(()=>{var t=Me(),e=t.firstChild,s=e.nextSibling;return d(s,()=>`%${o.width}`),L(a=>A(e,`width: ${o.width}%`,a)),t})();class ze{constructor(t){this.chapters=t}get progress(){let t=this.chapters.length;return this.chapters.map(e=>Math.round(e.progress/t)).reduce((e,s)=>e+s)}}class y{constructor(t,e,s,a){this.study_name=t,this.i_chapter=e,this.score_tree=s,this.solved_paths=a}static load_from_store(t,e){let s=new U(t.name,e);return y.make(t.name,e,t.chapters[e].pgn.tree,F.set_for_saving(s.solved_paths))}static save_paths_to_store(t){let e=new U(t.study_name,t.i_chapter);e.solved_paths=t.solved_paths.get_for_saving()}static make(t,e,s,a=new F){return new y(t,e,Ce.make(s),a)}get progress(){return Math.floor(this.solved_paths.expand_paths.map(t=>{var e;return((e=this.score_tree.get_at(t))==null?void 0:e.score)??0}).reduce((t,e)=>t+e,0)*100)}get progress_map(){let t=N(()=>this.score_tree.progress_paths);const e=N(()=>t.map(s=>[s.filter(a=>a.length%2===1).map(a=>this.score_tree.get_at(a).score).reduce((a,f)=>a+f,0),s.filter(a=>a.length%2===0).map(a=>this.score_tree.get_at(a).score).reduce((a,f)=>a+f,0)]));return t.map((s,a)=>{let f=s[0],w=s[s.length-1],S=e[a][0],C=e[a][1],m=u(()=>this.solved_paths.expand_paths),k=u(()=>m().filter(_=>s.some(g=>g.join("")===_.join("")))),x=u(()=>k().filter(_=>_.length%2===1).map(_=>this.score_tree.get_at(_).score).reduce((_,g)=>_+g,0)),M=u(()=>k().filter(_=>_.length%2===0).map(_=>this.score_tree.get_at(_).score).reduce((_,g)=>_+g,0));return{color:Ue(f.length/20+w.length/10),total:S*2,black:u(()=>M()/C),white:u(()=>x()/S),path:w}}).reverse()}merge_and_save_stats(t){this.solved_paths.merge_dup(t.solved_paths),y.save_paths_to_store(this)}}const at=()=>{const o=ne(),[t]=ce(o.id,fe.read_study);return(()=>{var e=Pe();return d(e,p(_e,{get when(){return!t.loading},fallback:"Loading...",get children(){return p(Je,{get study(){return t()}})}})),e})()},Je=o=>{const t=()=>o.study;let e=new We,s=new be;const[a,f]=I(0);let w=u(()=>{const r=t();return new ze(r.chapters.map((n,b)=>y.load_from_store(r,b)))}),S=u(()=>w().chapters[a()]);const C=u(()=>t().chapters[a()]),m=u(()=>{e.mode;let r=C();return ke.make(r.pgn.tree.clone)});$(()=>{m().solved_paths.replace_all(S().solved_paths)});const k=u(()=>{let r=m().tree;return N(()=>y.make(t().name,a(),r,new F))});$(()=>{N(()=>k()).solved_paths.replace_all(m().solved_paths)}),$(T(()=>[k(),S()],(r,n)=>{if(n){let[b,D]=n;D.merge_and_save_stats(b)}})),$(()=>{let{mode:r,match_color:n}=e;r==="match"&&n==="black"&&setTimeout(()=>{m().reveal_one_random()},400)}),$(T(()=>s.add_uci,r=>{if(!r)return;m().try_next_uci_fail(r)&&e.mode==="match"&&setTimeout(()=>{m().reveal_one_random()},400)})),$(T(()=>m().fen_last_move,r=>{if(r){let[n,b]=r;s.on_set_fen_uci(n,b)}else s.on_set_fen_uci(Se)})),$(T(()=>s.on_wheel,r=>{r&&m().on_wheel(r)}));const x=r=>{r.key==="f"&&e.flip_match_color()};document.addEventListener("keypress",x),K(()=>{document.removeEventListener("keypress",x)});const M=xe(r=>{const n=r.target;n.tagName!=="PIECE"&&n.tagName!=="SQUARE"&&n.tagName!=="CG-BOARD"||(r.preventDefault(),s.set_on_wheel(Math.sign(r.deltaY)))});$(()=>{e.match_color=t().orientation??"white"});const _=u(()=>k().progress_map);let g;return he(()=>{g.addEventListener("wheel",M,{passive:!1})}),K(()=>{g.removeEventListener("wheel",M)}),(()=>{var r=Ge(),n=r.firstChild,b=n.firstChild,D=b.nextSibling,O=D.firstChild,z=O.firstChild,J=O.nextSibling,Y=n.nextSibling,q=Y.nextSibling,V=q.nextSibling,B=V.firstChild,G=B.firstChild,X=G.firstChild,Z=X.nextSibling,ee=G.nextSibling,te=ee.firstChild,re=B.nextSibling,H=re.firstChild,se=H.nextSibling;return de(l=>g=l,r),d(z,()=>t().name),d(O,p(W,{get width(){return w().progress}}),null),d(J,p(Q,{get each(){return t().chapters},children:(l,c)=>(()=>{var h=He(),P=h.firstChild,v=P.firstChild;return v.nextSibling,h.$$click=()=>f(c()),d(v,()=>l.name),d(P,p(W,{get width(){var E;return((E=w())==null?void 0:E.chapters[c()].progress)??0}}),null),L(()=>me(h,c()===a()?"active":"")),h})()})),d(Y,p(we,{get orientation(){return e.match_color},get movable(){return e.mode!==void 0},get doPromotion(){return s.promotion},get onMoveAfter(){return s.on_move_after},get fen_uci(){return s.fen_uci},get color(){return s.turnColor},get dests(){return s.dests}})),d(q,p(Q,{get each(){return _()},children:l=>(()=>{var c=Ke(),h=c.firstChild,P=h.nextSibling;return c.$$click=v=>m().try_set_cursor_path(l.path),L(v=>{var E=`background: ${l.color}; height: ${Math.round(l.total*100)}%`,ae=`height: ${Math.round(l.white()*100)}%`,le=`height: ${Math.round(l.black()*100)}%`;return v.e=A(c,E,v.e),v.t=A(h,ae,v.t),v.a=A(P,le,v.a),v},{e:void 0,t:void 0,a:void 0}),c})()})),d(Z,()=>C().name),d(H,p(ye,{get lala(){return m()}})),d(se,p(ue,{get children(){return[p(j,{get when(){return e.mode===void 0},get children(){return[Ee(),Re(),Te(),(()=>{var l=Le();return l.$$click=()=>e.mode="moves",l})(),(()=>{var l=Ae();return l.$$click=()=>e.mode="match",l})()]}}),p(j,{get when(){return e.mode==="match"},get children(){return[Ie(),(()=>{var l=Ne(),c=l.firstChild,h=c.nextSibling;return h.nextSibling,d(l,()=>e.match_color,h),l})(),De(),Oe(),(()=>{var l=je(),c=l.firstChild,h=c.nextSibling;return c.$$click=()=>{pe(()=>{e.mode="match",e.flip_match_color()})},h.$$click=()=>e.mode=void 0,l})()]}}),p(j,{get when(){return e.mode==="moves"},get children(){return[Fe(),Ye(),qe(),(()=>{var l=Be(),c=l.firstChild,h=c.nextSibling;return c.$$click=()=>{e.mode="moves"},h.$$click=()=>e.mode=void 0,l})()]}})]}})),L(()=>ve(te,"href",C().site)),r})()};ge(["click"]);export{at as default};
