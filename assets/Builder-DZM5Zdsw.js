import{_ as bt,H as me,a as $,m as Je,c as y,g as A,J as kt,K as wt,I as Z,L as se,N as oe,O as $t,Q as xt,x as be,r as ke,n as B,b as fe,t as P,T as We,U as Fe,V as Ae,W as Ze,X as et,Y as St,Z as Ct,$ as Et,d as Re,C as Pe,q as W,i as x,S as F,j as he,k as X,F as tt,M as re,h as nt,v as pe,a0 as Mt,p as At,a1 as He,a2 as de,a3 as Pt,u as rt,D as Le,o as Lt,B as $e,a4 as ze,a5 as qt}from"./index-CLitgxI2.js";import{C as Rt}from"./chessground-lU4YbH_i.js";import{s as jt}from"./scroll-DnAhRpRC.js";import{a as Nt}from"./random-BMCilaBQ.js";async function Tt(e){const n=await Dt(e);function l(s){return n.transaction(e.store,s).objectStore(e.store)}function _(s){return new Promise((c,i)=>{const t=s();t.onsuccess=o=>c(o.target.result),t.onerror=o=>i(o.target.result)})}return{list:()=>_(()=>l("readonly").getAllKeys()),get:s=>_(()=>l("readonly").get(s)),getMany:s=>_(()=>l("readonly").getAll(s)),put:(s,c)=>_(()=>l("readwrite").put(c,s)),count:s=>_(()=>l("readonly").count(s)),remove:s=>_(()=>l("readwrite").delete(s)),clear:()=>_(()=>l("readwrite").clear()),cursor:(s,c)=>_(()=>l("readonly").openCursor(s,c)).then(i=>i??void 0),txn:s=>n.transaction(e.store,s)}}async function Dt(e){const n=e?.db||`${e.store}--db`;return new Promise((l,_)=>{const s=window.indexedDB.open(n,e?.version??1);s.onsuccess=c=>l(c.target.result),s.onerror=c=>_(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const i=c.target.result,t=c.target.transaction,o=i.objectStoreNames.contains(e.store)?t.objectStore(e.store):i.createObjectStore(e.store);e.upgrade?.(c,o)}})}async function It(e){let n;await Bt({on_received:c,on_status(m){m&&(m.download&&e.on_downloaded_nb(m.download),m.error&&e.on_engine_failed(m.error))},on_connected(m){n=m}}),l("uci");function l(m){n?.(m)}function _(m){o=m,p()}function s(){return!!t&&!t.stop_requested&&!t.swap_requested}function c(m){const u=m.trim().split(/\s+/g);if(u[0]==="uciok")l("ucinewgame"),l("isready");else if(u[0]==="readyok")h();else if(!(u[0]==="id"&&u[1]==="name"))if(u[0]==="bestmove"){t&&g&&t.emit(g),t=void 0,h();return}else if(t&&!t.swap_requested&&!t.stop_requested&&u[0]==="info"){let b=0,k,w=1,L,C,R=!1,E,H=[];for(let N=1;N<u.length;N++)switch(u[N]){case"depth":b=parseInt(u[++N]);break;case"nodes":k=parseInt(u[++N]);break;case"multipv":w=parseInt(u[++N]);break;case"time":L=parseInt(u[++N]);break;case"score":R=u[++N]==="mate",E=parseInt(u[++N]),(u[N+1]==="lowerbound"||u[N+1]==="upperbound")&&(C=u[++N]);break;case"pv":H=u.slice(++N),N=u.length;break}if(R&&!E||(i<w&&(i=w),!me(k)||!me(L)||!me(R)||!me(E)))return;const K=t.ply%2===1?-E:E;if(C&&w===1)return;const ce={moves:H,cp:R?void 0:K,mate:R?K:void 0,depth:b};w===1?g={fen:t.current_fen,depth:b,nodes:k,millis:L,cp:R?void 0:K,mate:R?K:void 0,pvs:[ce]}:g&&(g.pvs.push(ce),g.depth=Math.min(g.depth,b)),w===i&&g&&(t.on_pvs(g),b>=40&&r())}else m&&!["Stockfish","id","option","info"].includes(u[0])&&console.warn(`SF: ${m}`)}let i=0,t,o,g;function h(){if(!t&&(t=o,o=void 0,t)){g=void 0,i=1,a("Threads",t.threads),a("Hash",t.hash_size||16),a("MultiPV",Math.max(1,t.multi_pv)),f&&f!==t.game_id&&l("ucinewgame"),f=t.game_id,l(["position fen",t.initial_fen,"moves",t.moves].join(" "));const[m,u]=Object.entries(t.search)[0];l(`go ${m} ${u}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function a(m,u){u=u.toString(),d.get(m)!==u&&(l(`setoption name ${m} value ${u}`),d.set(m,u))}function r(){t&&!t.stop_requested&&(t.stop_requested=!0,l("stop"))}function p(){t&&!t.swap_requested&&(t.swap_requested=!0,l("stop")),l("isready")}let f;return{start(m){_(m)},stop(){_()},destroy(){l("quit")},get state(){return s()?"computing":"idle"}}}async function Bt(e){const n=d=>{e.on_status(d)},l=d=>{e.on_received(d)},_=d=>{e.on_connected(d)};let s=await bt(()=>import("./sf17-79-Kk0KEig0.js"),[]),c=await new Promise((d,a)=>{s.default({wasmMemory:Ot(2560),onError:r=>a(new Error(r)),locateFile:r=>`stockfish/${r}`}).then(d).catch(a)}),i=await Tt({store:".aidchess.nnue"}).catch(()=>{}),t=[];for(let d=0;;d++){let a=c.getRecommendedNnue(d);if(!a||t.includes(a))break;t.push(a)}(await g(t)).forEach((d,a)=>c.setNnueBuffer(d,a)),c.onError=h(),c.listen=d=>l(d),_(d=>c.uci(d));async function g(d){return Promise.all(d.map(async a=>{let r=await i?.get(a).catch(()=>{});if(r&&r.byteLength>128*1024)return r;const p=new XMLHttpRequest;p.open("get",`stockfish/nnue/${a}`,!0),p.responseType="arraybuffer",p.onprogress=m=>n({download:{bytes:m.loaded,total:m.total}});const f=await new Promise((m,u)=>{p.onerror=()=>u(new Error(`fetch '${a}' failed: ${p.status}`)),p.onload=()=>{p.status/100===2?m(new Uint8Array(p.response)):u(new Error(`fetch '${a}' failed: ${p.status}`))},p.send()});return n(),i?.put(a,f).catch(()=>console.warn("IDB store failed")),f}))}function h(){return d=>{if(d.startsWith("BAD_NNUE")&&i){const a=Math.max(0,Number(d.slice(9))),r=c.getRecommendedNnue(a);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${r} from IDB`),i.remove(r)},2e3)}else n({error:d})}}}const Ot=(e,n=32767)=>{let l=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:n})}catch(_){if(n<=e||!(_ instanceof RangeError))throw _;n=Math.max(e,Math.ceil(n-n/l)),l=l===4?3:4}},je=kt();function Ut(e){let[n,l]=$(void 0),[_,s]=$(void 0),[c]=Je(()=>It({on_downloaded_nb(h){l(h)},on_engine_failed(h){s(h)}}));function i(h,d,a,r,p,f,m,u){let b=c();if(!b)return f(),()=>{};let k=Math.max(1,navigator.hardwareConcurrency-2);b.start({threads:k,hash_size:256,game_id:h,stop_requested:!1,swap_requested:!1,path:[],search:{depth:p},multi_pv:r,ply:a,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(L){u(L)},on_pvs:wt(200,function(L){m(L)})})}let t={};function o(h,d,a,r,p,f,m,u){let b=[d,r,p].join("$$"),w=(()=>{let C=p===8?[20,8]:[20],R=r===1?[6,1]:[6];return C.flatMap(E=>R.map(H=>[d,H,E].join("$$")))})().find(C=>t[C]);w?u(t[w]):i(h,d,a,r,p,f,m,L);function L(C){t[b]=C,u(C)}}let g={get download_nb(){return n()},get engine_failed(){return _()},get state(){let h=c();return c.loading||!h?"loading":h.state},best_move_with_cache:o,stop(){c()?.stop()}};return y(je.Provider,{value:g,get children(){return A(()=>e.children)}})}const xe={equals:!1};function ne(e,n,l){let _=!1,s=!0;const[c,i]=$(void 0,xe),t=A(r=>_?e(r):(s=!c(),r),n,xe);let[o,g]=$(void 0,xe),h;return[()=>(_=!0,s&&(s=i()),h=t(),_=!1,g(),h),()=>{if(o(),h)return h}]}var Wt=P('<div class="is2d chessboard">');function Ft(){let[e,n]=$(Z),[l,_]=$(void 0),[s,c]=$(void 0),i=A(()=>se.fromSetup(oe(e()).unwrap()).unwrap()),t=A(()=>i().turn),o=A(()=>$t(i()));const g=d=>{let a=i(),r=We(d),p=Fe(a,r);a.play(r),be(()=>{_([d,p]),c([d,p]),n(Ae(a.toSetup())),d.length})},h=d=>{if(!d){_(void 0);return}let a=Fe(i(),We(d));_([d,a])};return{play_orig_key(d,a){let r=i(),p=t(),f=r.board.get(xt(d)),m=d+a;f.role==="pawn"&&(a[1]==="8"&&p==="white"||a[1]==="1"&&p==="black")&&(m+="q"),g(m)},play_uci:g,set_fen_and_last_move(d,a){be(()=>{h(a),n(d)})},set_fen(d){n(d)},set_last_move(d){h(d)},get dests(){return o()},get fen(){return e()},get last_move(){return l()},get on_last_move_added(){return s()},get check(){return i().isCheck()},get isEnd(){return i().isEnd()}}}function Ht(e){let n,l;return ke(()=>{let _=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:_,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};l=Rt(n,c)}),B(()=>{let _;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;_=[s.slice(0,2),s.slice(2,4)]}l.set({lastMove:_,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),B(()=>{l.setAutoShapes(e.shapes??[])}),(()=>{var _=Wt();return fe(s=>n=s,_),_})()}function lt(e,n,l,_){let s=Ze(n,l),c=et(s),i=Ae(n.toSetup());n.play(s);let t=Ae(n.toSetup());return{path:_.length===0?c:`${_} ${c}`,ply:e,before_fen:i,fen:t,uci:c,san:l}}function it(e,n,l){let _=n[n.length-1];return l||(l=se.fromSetup(oe(_?.fen??Z).unwrap()).unwrap()),[...n,lt((_?.ply??0)+1,l,e,_?.path??"")]}function Ve(e,n=Z){let l=[],_=se.fromSetup(oe(n).unwrap()).unwrap();for(let s of e)l=it(s,l,_);return l}function Se(e,n){return[...e,...n]}function zt(e){if(e.length<=2*4)return!1;let n=2,l=0,_=e[0];for(;n<=e.length-1&&l<2;)_===e[n]&&(l+=1),n+=2;return l===3}function Ce(e){return Vt(e)^Kt(e)^Gt(e)^Qt(e)}function Vt(e){let n=0;return St.forEach(l=>{let _=e.board[l],s=Xt[l];Ct.forEach(c=>{let i=e.board[c],t=s[c];for(let o of _.intersect(i))n^=t[o]})}),n}function Kt(e){return e.turn==="white"?Yt:0}function Gt(e){let n=0;return e.castles.rook.white.a!==void 0&&(n^=ye.white[0]),e.castles.rook.white.h!==void 0&&(n^=ye.white[1]),e.castles.rook.black.a!==void 0&&(n^=ye.black[0]),e.castles.rook.black.h!==void 0&&(n^=ye.black[1]),n}function Qt(e){return e.epSquare!==void 0?Jt[Et(e.epSquare)]:0}let Xt={black:{pawn:Array(2637767806,720845184,1155203408,2618685246,1971536997,848342074,263957791,3896152207,226391645,436746274,2516964848,3491888988,1086189917,18044180,1572111136,597658413,97624494,1738507407,1950989311,2098318769,2194108574,4079062812,856979699,1270058469,2858720366,2378012835,2278688587,435406673,3031118064,2063925420,3376753832,615148625,1285502018,346460119,2803604355,55085973,1669016372,164740250,896886403,1935551383,410153072,533441746,3541084098,3214426080,2675233103,1374411850,1552073989,4244110986,844343081,2356462440,3116133511,2129956651,299173332,1701379241,1306570996,2530644806,1122123979,1831591130,1116211970,1594837592,972591349,2479207924,1675376029,3960916618),knight:Array(1447259295,4021046128,3139524504,1173487682,2467266804,4284945151,2925674454,3710671816,2129465869,587093076,3373793513,2156648078,3737413652,468575139,1129551363,2861996892,2826449619,1704209531,3738359347,569410928,3021312909,2444777957,282063667,682545472,3318488457,1447622272,757420137,2613420942,4012836163,2938127093,1208226490,2935205706,430957978,1381578755,4109399782,288855589,3169178148,2644780093,107966643,1304747544,1359190711,3229237120,3027167685,3011615298,564135827,770797430,1983662611,4153656423,3609759233,3727911466,200708787,744508026,1213261630,3485747185,2958861301,2598470344,2767997908,3881113485,1773764017,4189435844,4234838742,2624081078,2395569449,1728307101),bishop:Array(2140891889,1482849818,751922730,3546542069,216179596,444615341,2424254530,1344234989,929188581,2507911009,980166547,3566535507,143525013,4181962471,1815842366,911175674,3591335374,1452686093,385158879,4011414929,1448477120,3971299641,3133647265,3007628400,1708345684,3031964479,3022128657,118850112,2048127371,3158349745,1505327237,2568424029,1866609495,844703982,3504617058,1448882679,821387540,3631471417,2077838877,3352949096,2491080787,3368630402,983299419,3651215291,265429091,3019003608,2955948456,903690197,3925215275,3959093811,2455088053,3115011301,1765081558,3324795129,3443871631,3152559950,3699649406,3129545774,2747044893,3925243406,164095314,2234471571,2164784335,159995093),rook:Array(3661248027,3705503008,914567990,3462935583,2878378006,1133857586,3023618742,282908558,3686955701,2604456805,3061545110,3218002352,2836503392,536836808,2886925079,2936593041,453815187,3042568989,3279635891,3282689058,4088968807,2680453086,1731693966,1842894553,2736377365,121205621,2324595870,3784465521,1958759409,1306150933,2636541290,1950415745,322077955,3602873262,1211684447,504701736,2407799203,1925743434,3617596327,2498480299,2680229135,3731399221,2756509305,2635957500,1372762539,802677945,1707760534,3714687192,1615679922,1940556374,445390489,2864974375,1984806574,513390958,744398315,982749166,652663695,1184061125,3363191899,1064069880,2138882964,2616926846,2298715513,2414381911),queen:Array(2065276,410498334,2726640512,2570984935,3008987264,623860175,3527183895,467272850,568376656,990477018,2366955227,4183621538,946958343,3395758993,1690887473,605184237,275515833,2142902612,2021972412,105373677,1666662384,1338566998,498685668,3101233780,2733370951,3656512268,4025308119,778896067,2846510368,3058428120,1892379383,2565895844,3213117192,2495816991,1040203361,3106252493,1639829808,3213709576,604681594,4236730699,4009938384,2701667332,2182473079,3550198211,657991062,1640976276,460041378,1972323596,2510248061,2959337826,1625877874,2070189957,4245163299,2358312347,275739390,2037777210,2766930226,1933485829,3034118011,2653025529,2641780289,3540781195,1569993599,441337890),king:Array(588133437,1139638106,982032635,562514827,467575086,1405117894,3813285157,3601878331,1586505598,738488098,2970334297,1068097019,235518094,283685722,2666392744,3569817788,2169728352,2444571896,3967907832,420376911,3046293305,2311278792,2885955184,3030078181,4212469731,1046900335,995380926,3892683234,615726237,3880203074,176180504,1474506861,1256707747,764236850,3521530334,2318567964,128167623,2220129756,2567608573,441446694,4143447316,817912603,2368091832,1187643061,3438021235,1318922279,434876457,1180291767,2520707785,1962430872,1510954061,57831539,3354831405,891783098,2555636406,2881342935,3473267445,1238029452,2051805420,3655936674,330209165,1929681327,1313566811,4283920930)},white:{pawn:Array(1398143232,133930885,1351827834,2076951437,435980918,1668970368,2185864314,2041407829,346864372,4047877822,3669961416,616810829,3144558884,216165387,2761740594,3919406634,669429112,2234904640,1421079802,1924213810,4002762044,2592451728,1890340057,4189625662,2276713138,2741429688,2924122950,421576781,2277442246,153237420,4278711886,2380848297,2618700582,3018992701,957243316,1543415220,504378001,2591337657,1333852064,1661259930,561112646,1536910315,1349168372,411152329,1694697476,3755185459,4019355068,2066937809,3120395808,94890149,3045629038,1249184265,3477490924,4114113436,1014604031,3991324799,2040431088,2253613964,2547464012,2722521980,71289574,2450408597,1894451515,1939968537),knight:Array(3309827454,2028172868,4271523049,146617804,2467685867,2483428231,3743260573,1002067894,3535252974,4154611160,3623154244,3646679180,862933752,2806008282,2734037942,1328176304,2278785213,381286368,2074232908,4087773386,967884669,4239349185,419231360,1275421624,1088456595,2365565249,1758083333,2048846183,2635948261,940630937,839474029,902477345,2836079689,2007115168,1363041891,1130479818,3644959908,1385135238,1386975934,2635987502,1915744629,487743653,2049219159,69242857,1511066720,215590039,1459430344,676103291,83799035,1949179493,2593534694,2283504289,1349412676,2954378677,249149717,1578231917,4135085182,461755528,3669622373,219487622,2825233742,2479105382,2582097898,1221328648),bishop:Array(599199451,3274759746,1192619331,2832721114,91404660,3044880024,3906596030,803516785,288455592,2143232492,388352703,2521731420,1043041227,3195290851,4166724431,1228226538,500177583,533367442,4236023256,413575568,3435884549,1004255532,2859513268,3914086821,3080761716,3571165255,773372954,769693293,3116440923,1687629160,2489486648,3686847158,3530767427,2121652637,1827477891,2549918411,2071415163,2236083679,2040110303,3489536313,2190878435,2465915458,1675766804,3329799896,1483966600,159505618,2674227354,2683539437,3833196123,3891433165,1455453349,1430583255,2067726741,303380021,2136024795,2054591852,1029141665,2317027384,2068461795,2499875684,1302894490,1002663431,1560941298,2141002286),rook:Array(2694745228,4202576185,3602305260,3756663274,3061587876,3390977925,486312941,3515712841,1322319486,3839619171,392296762,1401523788,1934485528,645968162,696971825,2038689491,1723966113,2652365974,3988018407,1354171594,1287854075,1723106141,563845090,639520332,534957223,3612364282,3109494688,500957989,3477030536,4109750364,951472732,922095147,3946156928,2622281253,2936811901,630086272,2340986210,4107355543,3560210278,3868847493,611513888,3265390517,2874106961,1668707698,2778598353,292356118,754567370,185141877,2884558258,1492107531,3336927864,782994598,346133860,2080909533,3612065399,2151962287,3957975594,52533817,1232633839,2716413964,1531307298,3030137657,3561556693,313061910),queen:Array(1878946792,3724105660,1691411102,148741087,142506469,3811107376,472209891,1913386482,2960608550,1145005292,1091751784,3625186042,1712140887,1504455800,3896940088,2478191531,3233871270,3404865229,1462204167,1349259705,3627860584,1244251718,3979211282,3043187861,581894202,1390895705,2599134010,2488233440,1816641224,1792034756,2779893723,2084952115,1351806869,2469979804,1163545420,1795352113,1796715044,3521170642,3725363621,1342594643,2618386938,2028859350,1841905045,4002935891,850071259,979915719,830889197,1744763229,522919199,3063822504,2861636095,4097602344,4215946617,894485042,924809191,1811585710,3439653887,3810997538,2677100683,77233985,4239834691,148802076,2409138150,3048474397),king:Array(1438004300,3093439067,3401620219,3673745794,3053321309,822915968,3900685126,553823814,4166295066,128359165,3300989119,4193552686,452189154,4122259632,2519387887,74333898,4032631446,2521268686,2620314688,1378755571,394133753,734399075,573292462,1214417373,2110224475,2331215665,531326186,3839443603,2644531398,616620850,590349237,3582377217,1582708616,2126148205,173450736,3616831144,2655785577,401600069,496349349,2479612086,1710903074,3589924952,3266682943,1496318498,3459221058,2091479615,663040899,3323704225,353318429,2674540957,1688550857,338551967,204689992,178008789,3871613304,1911672356,4055679954,3878217928,2533095482,2174833823,1604814460,1452830254,2441027029,3524103304)}},Yt=4174784170,ye={black:Array(2776523577,519497435),white:Array(836181454,4049974663)},Jt=Array(1892447193,3793382197,3838936,479846099,3476112862,3504620154,2009473484,1738755500);var Zt=P("<div class=replay-single><div class=moves>"),en=P("<span class=index>"),tn=P("<span><span class=san>"),Ke=P("<span class=eval>"),Ge=P("<span class=loading>."),nn=P("<span class=judgement>");function ue(e){return se.fromSetup(oe(e).unwrap()).unwrap()}function rn(){let[e,n]=$([]),[l,_]=$([]);const s=A(()=>{let u=l();return u[u.length-1]});let[c,i]=$(s()?.ply??0);const t=A(()=>{let u=c();return l().find(k=>k.ply===u)});let o=A(Pe(l,u=>u.san)),g=A(Pe(l,u=>u.ply)),h=A(()=>{let u=o(),b=g();return u.map((k,w)=>`${b[w]} ${k}`)});const d=u=>{i(u)},a=()=>{let u=c()-1;return g().find(b=>b===u)},r=()=>{let u=c()+1;return g().find(b=>b===u)},p=A(()=>zt(e())),f=A(()=>{let u=s();return u?ue(u.fen).isStalemate():!1}),m=A(()=>{let u=s();return u?ue(u.fen).isCheckmate():!1});return{set_sans(u){_(Ve(u)),i(u.length);let b=l();n(b.reduce((k,w)=>Se([Ce(ue(w.fen))],k),[]))},get steps(){return l()},get steps_up_to_ply(){return l().slice(0,c())},get plies(){return g()},get sans(){return o()},get ply_sans(){return h()},get ply_step(){return t()},get last_step(){return s()},get ply(){return c()},goto_ply:d,get_prev_ply:a,get_next_ply:r,goto_prev_ply_if_can(){let u=a();u!==void 0&&d(u),c()===1&&i(0)},goto_next_ply_if_can(){let u=r();u!==void 0&&d(u)},play_san(u){let b=s();if(!b){_(Ve([u]));let w=l();n(w.reduce((L,C)=>Se([Ce(ue(C.fen))],L),[]));return}let k=l();_(it(u,k)),b=s(),n(Se([Ce(ue(b.fen))],e())),i(b.ply)},get is_on_last_ply(){return c()===(s()?.ply??0)},get is_threefold(){return p()},get is_checkmate(){return m()},get is_stalemate(){return f()}}}function ln(e){const n=A(Pe(()=>e.play_replay.ply_sans,i=>{let[t,o]=i.split(" ");return{ply:parseInt(t),san:o}})),l=i=>{e.play_replay.goto_ply(i)},_=A(()=>e.play_replay.ply_step?.ply);B(W(()=>e.play_replay.steps,i=>e.steps_stockfish.set_steps(i)));let s;const c=i=>{let t=e.steps_stockfish.steps_with_stockfish[i];if(!t)return"";let o=t.d20pv6[1](),g=t.d20pv1[1](),h=t.d8pv6[1](),d=t.d8pv1[1]();if(o)return(o.judgement??"")+" d20pv6";if(g)return(g.judgement??"")+" d20pv1";if(h)return(h.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return B(()=>{if(n().length<7)return;let t=s.parentElement,o;if(e.play_replay.ply<3)o=0;else if(e.play_replay.is_on_last_ply)o=99999;else{let g=t.querySelector(".active");g&&(o=g.offsetTop-s.offsetHeight/2+g.offsetHeight/2)}o!==void 0&&(s.scrollTop=o)}),(()=>{var i=Zt(),t=i.firstChild;return fe(o=>s=o,t),x(t,y(tt,{get each(){return n()},children:(o,g)=>[y(F,{get when(){return o.ply%2===1},get children(){var h=en();return x(h,()=>Math.ceil(o.ply/2)),h}}),(()=>{var h=tn(),d=h.firstChild;return h.$$click=()=>l(o.ply),x(d,()=>o.san),x(h,y(F,{get when(){return e.steps_stockfish.steps_with_stockfish[g()]},children:a=>y(an,{get ss(){return a()}})}),null),he(()=>X(h,"move "+c(g())+(o.ply===_()?" active":""))),h})()]})),i})()}function an(e){return y(nt,{get fallback(){return y(_e,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[y(re,{get when(){return e.ss.d20pv6[1]()},children:n=>y(_e,{get step(){return n()}})}),y(re,{get when(){return e.ss.d20pv1[1]()},children:n=>y(_e,{get step(){return n()}})}),y(re,{get when(){return e.ss.d8pv6[1]()},children:n=>y(_e,{get step(){return n()}})}),y(re,{get when(){return e.ss.d8pv1[1]()},children:n=>y(_e,{get step(){return n()}})})]}})}function _e(e){const n=()=>e.step.search?.cp,l=()=>e.step.judgement,_=c=>c==="good"?"✓":c==="inaccuracy"?"?!":c==="mistake"?"?":"??",s=()=>e.step.progress?.depth;return(()=>{var c=Ke();return x(c,y(F,{get when(){return n()!==void 0},get fallback(){return(()=>{var i=Ge();return i.firstChild,x(i,s,null),i})()},get children(){var i=Ke();return x(i,()=>sn(n())),i}}),null),x(c,y(F,{get when(){return l()},get fallback(){return Ge()},children:i=>(()=>{var t=nn();return x(t,()=>_(i())),t})()}),null),c})()}function sn(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}Re(["click"]);var Ee=Symbol("fallback");function Qe(e){for(const n of e)n.dispose()}function at(e,n,l,_={}){const s=new Map;return pe(()=>Qe(s.values())),()=>{const i=e()||[];return i[Mt],At(()=>{if(!i.length)return Qe(s.values()),s.clear(),_.fallback?[He(d=>(s.set(Ee,{dispose:d}),_.fallback()))]:[];const t=new Array(i.length),o=s.get(Ee);if(!s.size||o){o?.dispose(),s.delete(Ee);for(let h=0;h<i.length;h++){const d=i[h],a=n(d,h);c(t,d,h,a)}return t}const g=new Set(s.keys());for(let h=0;h<i.length;h++){const d=i[h],a=n(d,h);g.delete(a);const r=s.get(a);r?(t[h]=r.mapped,r.setIndex?.(h),r.setItem(()=>d)):c(t,d,h,a)}for(const h of g)s.get(h)?.dispose(),s.delete(h);return t})};function c(i,t,o,g){He(h=>{const[d,a]=$(t),r={setItem:a,dispose:h};if(l.length>1){const[p,f]=$(o);r.setIndex=f,r.mapped=l(d,p)}else r.mapped=l(d);s.set(g,r),i[o]=r.mapped})}}function on(e){const{by:n}=e;return A(at(()=>e.each,typeof n=="function"?n:l=>l[n],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var cn=P("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),st=P("<span class=index>"),dn=P("<div class=fbt>"),un=P("<div class=lines>"),_n=P("<div class=line>"),fn=P("<span class=collapsed>..<!> "),hn=P("<div>");function pn(e){return Pt(e).map(n=>{let l=n.headers.get("Event"),_=n.headers.get("Site"),s=n.headers.get("White"),c=n.headers.get("Black"),i=n.headers.get("Chapter"),t=n.headers.get("Orientation"),o=n.headers.get("FEN"),g=o??Z,h=se.fromSetup(oe(g).unwrap()).unwrap(),d=ot();n.moves.children.forEach(r=>{a(r,h,"")});function a(r,p,f){let m=r.data.san,u=Ze(p,m),b=p.clone();b.play(u);let k=et(u),w=r.data.nags;d.add_child_san(f,m).set_nags(w??[]);let L=f.length===0?k:`${f} ${k}`;r.children.forEach(C=>{a(C,b,L)})}return{event:l,site:_,white:s,black:c,chapter:i,fen:o,orientation:t,tree:d}})}function ot(){let[e,n]=$([]);const l=i=>_(i)?.[1],_=i=>{if(i==="")return;let t=i.split(" "),o=0,g,h=e();for(;;){let d=t.slice(0,o+1).join(" "),a=h.find(r=>r.path===d);if(!a)return;if(o++,o===t.length)return[g,a];g=a,h=a.children}};function s(i,t=!1){let o=i.ply,g=o%2===1||t?Math.ceil(o/2)+(o%2===1?".":"..."):"",h=o%2===1?"":" ";return`${g} ${i.san}${i.comments?" { "+i.comments+" }":""}${h}`}function c(i,t=!1){let o="";return i.length===0||(i.length===1?(o+=s(i[0].step,t),o+=c(i[0].children,!1)):(o+=s(i[0].step,!1).trimEnd(),o+=" "+i.slice(1).map(g=>`(${c([g],!0).trimEnd()})`).join(" "),o+=" "+c(i[0].children,!0))),o}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(i){if(i.length===0)return[];let t=i[0],o=this.add_child_san("",t),g=[o];return i.slice(1).forEach(h=>{o=o.add_child_san(h),g.push(o)}),g},add_child_san(i,t){if(i===""){let g=e(),h=g.find(r=>r.san===t);if(h)return h;let d=se.fromSetup(oe(Z).unwrap()).unwrap(),a=ct(0,d,t,"");return n([...g,a]),a}let o=l(i);if(o)return o.add_child_san(t)},remove_child_at_path(i){let t=_(i);if(t){if(!t[0]){let o=e(),g=o.indexOf(t[1]);return o.splice(g,1),n([...o]),t[1]}return t[0].remove_child(t[1]),t[1]}},find_at_path:l,find_parent_and_child_at_path:_,siblings_of(i){let t=_(i)?.[0];if(t)return t.children;if(i.split(" ").length===1)return e()},previous_branch_points(i){let t=[],o=e(),g=o.length>1;for(let h of i.split(" ")){let d=o.find(a=>a.step.uci===h);if(!d)return;g&&(t.push(d),g=!1),d.children.length>1&&(g=!0),o=d.children}return t}}}function ct(e,n,l,_){let[s,c]=$([]),[i,t]=$([]);n=n.clone();let o=lt(e,n,l,_),g=()=>h()?.length??0,h=()=>d()?.children,d=()=>{let r=s();if(r.length!==0)return r.length===1?r[0].first_node_with_variations:a},a={get nags(){return i()},set_nags:t,get path(){return o.path},get ply(){return o.ply},get san(){return o.san},step:o,get children(){return s()},remove_child(r){let p=s(),f=p.indexOf(r);if(f!==-1)return p.splice(f,1),c([...p]),r},add_child_san(r){let p=s(),f=p.find(u=>u.san===r);if(f)return f;let m=ct(e+1,n,r,o.path);return c([...p,m]),m},remove_child_san(r){let p=s(),f=p.findIndex(u=>u.step.san!==r);if(f===-1)return;let m=p.splice(f,1)[0];return c([...p]),m},get nb_first_variations(){return g()},get first_node_with_variations(){return d()},get length(){let r=s();if(r.length>1)return 1;if(r.length===0)return 0;let p=1,f=r[0];for(;f?.children.length===1;)p++,f=f.children[0];return p}};return a}function gn(e){let n=ot();e&&(n=pn(e)[0].tree);let[l,_]=$(""),s=[];B(W(l,a=>{n.previous_branch_points(a)?.map(r=>{s.includes(r.path)||(n.siblings_of(r.path)?.forEach(p=>{s=s.filter(f=>f!==p.path)}),s.push(r.path))})}));const c=a=>{_(a)},i=()=>{let a=l();if(a!=="")return a.split(" ").slice(0,-1).join(" ")},t=()=>{let a=l(),r=n.find_at_path(a)?.children??n.root;return r.length===1?r[0].path:r.find(p=>s.includes(p.path))?.path??r[0]?.path},o=()=>{let a=n.find_parent_and_child_at_path(l());if(!a)return;let r=a;if(!r[0])return"";if(r[0].children.length>1)return r[0].path;for(;!(!r[0]||r[0].children.length>1);){let p=n.find_parent_and_child_at_path(r[0].path);if(!p)break;r=p}return r[1].path},g=()=>{let a=n.find_at_path(l());if(!a)return n.root.find(p=>s.includes(p.path))?.path??n.root[0]?.path;let r=a;if(r.children.length>1)return r.children.find(p=>s.includes(p.path))?.path??r.children[0]?.path;for(;r.children.length===1;)r=r.children[0];return r.path},h=()=>{let a=n.find_parent_and_child_at_path(l());if(!a)return;let r=a[0]?.children??[];if(!a[0])r=n.root;else if(a[0].children.length===1)for(;;){if(a=n.find_parent_and_child_at_path(a[0].path),!a)return;if(!a[0]){r=n.root;break}if(a[0].children.length>1){r=a[0].children;break}}let p=r.indexOf(a[1]),f=r[p-1];if(f)return f.path},d=()=>{let a=n.find_parent_and_child_at_path(l());if(!a)return;let r=a[0]?.children??[];if(!a[0])r=n.root;else if(a[0].children.length===1)for(;;){if(a=n.find_parent_and_child_at_path(a[0].path),!a)return;if(!a[0]){r=n.root;break}if(a[0].children.length>1){r=a[0].children;break}}let p=r.indexOf(a[1]),f=r[p+1];if(f)return f.path};return{steps:n,get cursor_path(){return l()},set cursor_path(a){_(a)},get cursor_path_step(){return n.find_at_path(l())?.step},goto_path:c,get_prev_path:i,get_next_path:t,goto_prev_if_can(){let a=i();a!==void 0&&c(a)},goto_next_if_can(){let a=t();a!==void 0&&c(a)},get_first_path:o,get_last_path:g,get_up_path:h,get_down_path:d,goto_up_if_can(){let a=h();a!==void 0&&c(a)},goto_down_if_can(){let a=d();a!==void 0&&c(a)},goto_last_if_can(){let a=g();a!==void 0&&c(a)},goto_first_if_can(){let a=o();a!==void 0&&c(a)},get previous_branch_points_at_cursor_path(){return n.previous_branch_points(l())??[]}}}function vn(e){const n=e.play_replay.steps;let l;B(()=>{let s=e.play_replay.cursor_path,c=l.parentElement;if(!c)return;const i=l.querySelector(".on-path-end");if(!i){c.scrollTop=s.length>0?99999:0;return}let t=i.offsetTop-c.offsetHeight/2+i.offsetHeight;c.scrollTo({behavior:"smooth",top:t})});const _=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return ke(()=>{document.addEventListener("keydown",_),pe(()=>{document.removeEventListener("keydown",_)})}),(()=>{var s=cn(),c=s.firstChild,i=c.firstChild,t=c.nextSibling,o=t.firstChild,g=o.nextSibling,h=t.nextSibling,d=h.firstChild,a=d.nextSibling,r=a.nextSibling,p=r.nextSibling;return fe(f=>l=f,i),x(i,y(qe,{get nodes(){return n.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:f=>e.play_replay.cursor_path=f,on_context_menu:(f,m)=>e.on_context_menu?.(f,m)})),o.$$click=()=>e.play_replay.goto_up_if_can(),g.$$click=()=>e.play_replay.goto_down_if_can(),x(t,y(tt,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:f=>(()=>{var m=dn();return m.$$click=()=>e.play_replay.cursor_path=f.path,x(m,y(F,{get when(){return f.ply&1},get children(){var u=st();return x(u,()=>dt(f.ply)),u}}),null),x(m,()=>f.san,null),m})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),a.$$click=()=>e.play_replay.goto_prev_if_can(),r.$$click=()=>e.play_replay.goto_next_if_can(),p.$$click=()=>e.play_replay.goto_last_if_can(),he(f=>{var m=e.play_replay.get_up_path()===void 0,u="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),b=e.play_replay.get_down_path()===void 0,k="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),w=e.play_replay.get_first_path()===void 0,L="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),C=e.play_replay.get_prev_path()===void 0,R="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),E=e.play_replay.get_next_path()===void 0,H="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),O=e.play_replay.get_last_path()===void 0,K="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return m!==f.e&&(o.disabled=f.e=m),u!==f.t&&X(o,f.t=u),b!==f.a&&(g.disabled=f.a=b),k!==f.o&&X(g,f.o=k),w!==f.i&&(d.disabled=f.i=w),L!==f.n&&X(d,f.n=L),C!==f.s&&(a.disabled=f.s=C),R!==f.h&&X(a,f.h=R),E!==f.r&&(r.disabled=f.r=E),H!==f.d&&X(r,f.d=H),O!==f.l&&(p.disabled=f.l=O),K!==f.u&&X(p,f.u=K),f},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function qe(e){return[y(F,{get when(){return e.nodes.length===1},get children(){return[y(Me,de(e,{get node(){return e.nodes[0]}})),y(qe,de(e,{get nodes(){return e.nodes[0].children}}))]}}),y(F,{get when(){return e.nodes.length>1},get children(){var n=un();return x(n,y(on,{get each(){return e.nodes},by:"path",children:l=>(()=>{var _=_n();return x(_,y(F,{get when(){return e.cursor_path.startsWith(l().path)},get fallback(){return[y(Me,de(e,{get node(){return l()},show_index:!0,collapsed:!0})),(()=>{var s=fn(),c=s.firstChild,i=c.nextSibling;return i.nextSibling,x(s,()=>l().length,i),x(s,()=>l().nb_first_variations,null),s})()]},get children(){return[y(Me,de(e,{get node(){return l()},show_index:!0})),y(qe,de(e,{get nodes(){return l().children}}))]}})),_})()})),n}})]}function Me(e){let n=A(()=>e.node.ply%2===0||e.show_index),l=A(()=>e.node.ply%2===0?".":"...");const _=A(()=>e.node.path),s=A(()=>e.cursor_path.startsWith(_())),c=A(()=>_()===e.cursor_path),i=A(()=>{let t=["move"];return e.collapsed&&t.push("collapsed"),s()&&t.push("on-path"),c()&&t.push("on-path-end"),t.join(" ")});return(()=>{var t=hn();return t.$$click=()=>{e.on_set_cursor(e.node.path)},t.$$contextmenu=o=>{o.preventDefault(),e.on_context_menu(o,e.node.path)},x(t,y(F,{get when(){return n()},get children(){var o=st();return x(o,()=>Math.floor(e.node.ply/2)+1,null),x(o,l,null),o}}),null),x(t,()=>e.node.san,null),he(()=>X(t,i())),t})()}const dt=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");Re(["click","contextmenu"]);const mn=(e,n)=>e==="white"?n:-n,ut=e=>2/(1+Math.exp(-.00368208*e))-1,yn=e=>ut(Math.min(Math.max(-1e3,e),1e3)),bn=e=>{const l=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return ut(l)},kn=e=>typeof e.mate<"u"?bn(e.mate):yn(e.cp),Xe=(e,n)=>mn(e,kn(n)),wn=(e,n,l)=>(Xe(e,n)-Xe(e,l))/2,$n=(e,n,l)=>wn(e,n,l);function xn(){let e=rt(je);function n(r,p,f,m,u,b,k){e.best_move_with_cache(o(),r,p,f,m,u,b,k)}let l,_=[];function s(r,p,f,m){let[u,b]=$(void 0),[k,w]=$(void 0),[L,C]=$(void 0),R={get loading(){return u()},get depth_eval(){return k()},get best_eval(){return L()},cancel:H},E={cancel:H,fen:r,ply:p,depth:f,multi_pv:m,set_loading:b,set_depth_eval:w,set_best_eval:C};function H(){let O=_.indexOf(E);O!==-1&&_.splice(O,1),l===E&&(console.trace("working cancel"),l=void 0,e.stop()),c()}return _.push(E),c(),R}function c(){if(l||(l=_.pop(),!l))return;const r=p=>{l?.set_best_eval(p),l=void 0,c()};n(l.fen,l.ply,l.multi_pv,l.depth,l.set_loading,l.set_depth_eval,r)}function i(r,p,f){let m=s(r.before_fen,r.ply-1,p,f),u=s(r.fen,r.ply,p,f);function b(k,w,L){let C=$n(k,w,L);return C<.03?"good":C<.05?"inaccuracy":C<.12?"mistake":"blunder"}return A(()=>(pe(()=>{u.cancel(),m.cancel()}),{...r,get before_search(){return m.best_eval},get search(){return r.fen,u.best_eval?.fen,u.best_eval},get judgement(){let k=m.best_eval,w=u.best_eval;if(k&&w)return b(Le(r.before_fen),k,w)},get progress(){return u?.depth_eval}}))}function t(r){let[p,f]=$(ne(()=>i(r,8,6)())),[m,u]=$(ne(()=>i(r,8,1)())),[b,k]=$(ne(()=>i(r,20,6)())),[w,L]=$(ne(()=>i(r,20,1)()));return{step:r,get d8pv6(){return p()},get d8pv1(){return m()},get d20pv6(){return b()},get d20pv1(){return w()},clear(){f(ne(()=>i(r,8,6)())),k(ne(()=>i(r,20,6)())),u(ne(()=>i(r,8,1)())),L(ne(()=>i(r,20,1)()))}}}let[o,g]=$(""),[h,d]=$([]),a=at(h,r=>[r.fen,r.uci].join("$$"),r=>t(r()));return{set_game_id:g,set_steps:d,get steps_with_stockfish(){return a()}}}var Sn=P("<div class=loading><span class=info>Loading <!>%"),Cn=P("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth 8</label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),En=P("<span class=result>Game Over"),Mn=P("<small class=drop>Evaluation Dropped Below -2"),An=P("<span class=result>Checkmate"),Pn=P("<small class=drop>Victory is <span class=victory>"),Ln=P("<span class=result>Stalemate"),Ye=P("<small class=drop>Game is a draw"),qn=P("<span class=result>3 Fold Repetition"),Rn=P("<div class=result-wrap>"),jn=P("<div class=tools-wrap><button class=save>Save Line</button><button class=rematch>Rematch"),Nn=P("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tabs-wrap><div>Match</div><div>Repertoire"),Tn=P("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=delete data-icon=>Delete move");const Fn=()=>y(Ut,{get children(){return y(Dn,{})}});function Dn(){let[e]=Je(()=>rt(je));const n=A(()=>{let l=e()?.download_nb;if(l)return Math.ceil(l.bytes/(l.total===0?70*1024*1024:l.total)*100)});return y(F,{get when(){return e()},children:l=>y(F,{get when(){return l().state==="loading"},get fallback(){return y(In,{})},get children(){var _=Sn(),s=_.firstChild,c=s.firstChild,i=c.nextSibling;return i.nextSibling,x(s,()=>n()??"--",i),_}})})}function In(){const e=Lt();e.setVolume(.2);let[n,l]=$e([],"builder.current.sans");const[_,s]=$(8);let c="";const i=xn(),t=rn();let o=Ft();const[g,h]=$("white"),d=A(()=>ze(g())),a=A(()=>{let v=i.steps_with_stockfish;return v[v.length-1]});function r(v){return _()===8?v.d8pv6:v.d20pv6}function p(v){return _()===8?v.d8pv1[0]():v.d20pv1[0]()}B(W(a,v=>{if(!v)return;if(Le(v.step.fen)===d()){let T=vt();if(T&&T.startsWith(v.step.path)){let D=T.slice(v.step.path.length).trim().split(" ")[0];if(D){o.play_uci(D);return}}let z=r(v)[0]();B(W(()=>z.search,D=>{if(!D)return;let V=D.cp,S=D.pvs,j=D.pvs.filter(q=>Math.abs(q.cp-V)<=10),U=D.pvs.filter(q=>Math.abs(q.cp-V)<=30),G=D.pvs.filter(q=>Math.abs(q.cp-V)<=60),le=D.pvs.filter(q=>Math.abs(q.cp-V)<=100),Q=D.pvs.filter(q=>Math.abs(q.cp-V)<200),Y=j.filter(q=>q.cp<150),ee=U.filter(q=>q.cp<150),ae=G.filter(q=>q.cp<150),ve=le.filter(q=>q.cp<150),we=Q.filter(q=>q.cp<150);function te(q){return q.find(I=>I.length>0)}console.log(ae,ee,Y,G,S);let J;switch(ie()){case"A":J=te([Y,j,S]);break;case"B":J=te([ee,Y,U,S]);break;case"C":J=te([ae,ee,Y,G,S]);break;case"D":J=te([ve,ae,ee,Y,le,S]);break;case"E":J=te([we,ve,ae,ee,Y,Q,S]);break}o.play_uci(Nt(J).moves[0])}))}})),B(W(()=>o.on_last_move_added,v=>{v&&t.play_san(v[1])})),B(W(()=>t.sans,l)),B(W(()=>t.ply_step,v=>{o.set_fen_and_last_move(v?.fen??Z,v?.uci)})),B(W(()=>t.ply_step,(v,M)=>{v&&(!M||M.ply===v.ply-1)&&e.move(v)}));const f=jt(v=>{const M=v.target;M.tagName!=="PIECE"&&M.tagName!=="SQUARE"&&M.tagName!=="CG-BOARD"||(v.preventDefault(),m(Math.sign(v.deltaY)))}),m=v=>{v>0?(O()==="match"&&t.goto_next_ply_if_can(),O()==="repertoire"&&E.goto_next_if_can()):(O()==="match"&&t.goto_prev_ply_if_can(),O()==="repertoire"&&E.goto_prev_if_can())};i.set_game_id(c),t.set_sans(n());const u=()=>{l([]),t.set_sans(n()),o.set_fen_and_last_move(Z),R(void 0)};B(W(_,()=>{i.steps_with_stockfish.forEach(M=>{be(()=>{M.clear(),p(M)})});let v=a();v&&r(v)[0]()})),B(W(a,v=>{if(!v)return;let M=p(v);B(W(()=>M.search,T=>{let z=T?.cp;z&&z<-200&&R("drop")}))})),B(()=>{let v=t.is_checkmate,M=t.is_stalemate,T=t.is_threefold;v&&R("checkmate"),M&&R("stalemate"),T&&R("threefold")});let[b,k]=$e("","builder.current.cursor_path"),[w,L]=$e(void 0,"builder.current.pgn");const[C,R]=$(void 0),E=gn(w());E.cursor_path=b(),B(W(()=>E.cursor_path,v=>{k(v)})),B(W(()=>E.cursor_path_step,v=>{v?o.set_fen_and_last_move(v.fen,v.uci):o.set_fen_and_last_move(Z)}));const H=()=>{be(()=>{let M=t.steps_up_to_ply.map(D=>D.san),T=E.steps.add_sans_at_root(M),z=T[T.length-1]?.path;z&&(K("repertoire"),E.cursor_path=z,L(E.steps.as_pgn))})},[O,K]=$("match");B(W(O,v=>{let M=v==="repertoire"?E.cursor_path_step:t.ply_step;M?o.set_fen_and_last_move(M.fen,M.uci):o.set_fen_and_last_move(Z)}));let ce,N;const _t=(v,M)=>{E.cursor_path=M,ge(E.steps.find_at_path(M));let T=v.clientX,z=v.clientY,D=N.getBoundingClientRect(),V=ce.getBoundingClientRect();T-=V.left,z-=V.top,T=Math.min(T,document.body.clientWidth-D.width-V.left-20);let S=`${z}px`,j=`${T}px`;N.style.top=S,N.style.left=j};ke(()=>{const v=()=>{ge(void 0)};document.addEventListener("click",v),pe(()=>{document.removeEventListener("click",v)})});const[ft,ge]=$(void 0),ht=v=>{E.steps.remove_child_at_path(v),ge(void 0)},Ne=v=>{s(v)},pt=A(()=>!o.isEnd&&t.is_on_last_ply&&C()===void 0);ke(()=>{const v=M=>{M.key==="f"&&h(ze(g()))};document.addEventListener("keypress",v),pe(()=>{document.removeEventListener("keypress",v)})});const[ie,gt]=$("A"),[vt,mt]=$(void 0),yt=v=>{mt(v),ge(void 0)};return(()=>{var v=Nn(),M=v.firstChild,T=M.nextSibling,z=T.firstChild,D=z.firstChild,V=D.nextSibling;return qt(v,"wheel",f),fe(S=>ce=S,v),x(M,y(Ht,{get orientation(){return g()},get color(){return g()},get movable(){return pt()},play_uci:o})),D.$$click=()=>K("match"),V.$$click=()=>K("repertoire"),x(T,y(F,{get when(){return O()==="match"},get children(){return[(()=>{var S=Cn(),j=S.firstChild,U=j.firstChild,G=U.nextSibling,le=G.firstChild,Q=le.nextSibling,Y=Q.nextSibling,ee=Y.nextSibling,ae=ee.nextSibling,ve=j.nextSibling,we=ve.firstChild,te=we.firstChild,J=te.firstChild,Te=te.nextSibling,q=Te.firstChild;return G.addEventListener("change",I=>gt(I.currentTarget.value)),J.addEventListener("change",I=>{I.target.checked&&Ne(8)}),J.checked=!0,q.addEventListener("change",I=>{I.target.checked&&Ne(20)}),he(I=>{var De=ie()==="A",Ie=ie()==="B",Be=ie()==="C",Oe=ie()==="D",Ue=ie()==="E";return De!==I.e&&(le.selected=I.e=De),Ie!==I.t&&(Q.selected=I.t=Ie),Be!==I.a&&(Y.selected=I.a=Be),Oe!==I.o&&(ee.selected=I.o=Oe),Ue!==I.i&&(ae.selected=I.i=Ue),I},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),S})(),y(ln,{play_replay:t,steps_stockfish:i}),(()=>{var S=Rn();return x(S,y(nt,{get children(){return[y(re,{get when(){return C()==="drop"},get children(){return[En(),Mn()]}}),y(re,{get when(){return C()==="checkmate"},get children(){return[An(),(()=>{var j=Pn(),U=j.firstChild,G=U.nextSibling;return x(G,()=>Le(t.last_step.before_fen)),j})()]}}),y(re,{get when(){return C()==="stalemate"},get children(){return[Ln(),Ye()]}}),y(re,{get when(){return C()==="threefold"},get children(){return[qn(),Ye()]}})]}})),S})(),(()=>{var S=jn(),j=S.firstChild,U=j.nextSibling;return j.$$click=H,U.$$click=u,S})()]}}),null),x(T,y(F,{get when(){return O()==="repertoire"},get children(){return y(vn,{play_replay:E,on_context_menu:_t})}}),null),x(v,y(F,{get when(){return ft()},children:S=>(()=>{var j=Tn(),U=j.firstChild,G=U.nextSibling,le=G.nextSibling;return fe(Q=>N=Q,j),j.$$click=Q=>{Q.preventDefault(),Q.stopImmediatePropagation()},x(U,()=>dt(S().ply),null),x(U,()=>S().san,null),G.$$click=()=>yt(S().path),le.$$click=()=>ht(S().path),j})()}),null),he(S=>{var j="tab"+(O()==="match"?" active":""),U="tab"+(O()==="repertoire"?" active":"");return j!==S.e&&X(D,S.e=j),U!==S.t&&X(V,S.t=U),S},{e:void 0,t:void 0}),v})()}Re(["click"]);export{Fn as default};
