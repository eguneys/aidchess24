import{_ as Tt,H as Me,a as M,m as ct,c as b,g as E,J as jt,K as Dt,I as ie,L as _e,N as fe,O as Nt,Q as It,x as be,r as Pe,n as B,b as ue,t as C,T as et,U as tt,V as Be,W as dt,X as ut,Y as Bt,Z as Ot,$ as Ut,d as Fe,C as Oe,q as G,i as x,S as H,j as $e,k as ee,F as _t,M as Q,h as ze,v as we,a0 as Wt,p as Ft,a1 as nt,a2 as me,a3 as zt,u as ft,D as Ae,o as Ht,B as ve,a4 as rt,a5 as Vt}from"./index-BLLm0Gca.js";import{C as Kt}from"./chessground-lU4YbH_i.js";import{s as Gt}from"./scroll-DnAhRpRC.js";import{a as Qt}from"./random-BMCilaBQ.js";import{a as Xt}from"./annotationShapes-p1VNqiZk.js";async function Yt(e){const n=await Jt(e);function i(s){return n.transaction(e.store,s).objectStore(e.store)}function u(s){return new Promise((c,a)=>{const t=s();t.onsuccess=o=>c(o.target.result),t.onerror=o=>a(o.target.result)})}return{list:()=>u(()=>i("readonly").getAllKeys()),get:s=>u(()=>i("readonly").get(s)),getMany:s=>u(()=>i("readonly").getAll(s)),put:(s,c)=>u(()=>i("readwrite").put(c,s)),count:s=>u(()=>i("readonly").count(s)),remove:s=>u(()=>i("readwrite").delete(s)),clear:()=>u(()=>i("readwrite").clear()),cursor:(s,c)=>u(()=>i("readonly").openCursor(s,c)).then(a=>a??void 0),txn:s=>n.transaction(e.store,s)}}async function Jt(e){const n=e?.db||`${e.store}--db`;return new Promise((i,u)=>{const s=window.indexedDB.open(n,e?.version??1);s.onsuccess=c=>i(c.target.result),s.onerror=c=>u(c.target.error??"IndexedDB Unavailable"),s.onupgradeneeded=c=>{const a=c.target.result,t=c.target.transaction,o=a.objectStoreNames.contains(e.store)?t.objectStore(e.store):a.createObjectStore(e.store);e.upgrade?.(c,o)}})}async function Zt(e){let n;await en({on_received:c,on_status(m){m&&(m.download&&e.on_downloaded_nb(m.download),m.error&&e.on_engine_failed(m.error))},on_connected(m){n=m}}),i("uci");function i(m){n?.(m)}function u(m){o=m,f()}function s(){return!!t&&!t.stop_requested&&!t.swap_requested}function c(m){const v=m.trim().split(/\s+/g);if(v[0]==="uciok")i("ucinewgame"),i("isready");else if(v[0]==="readyok")h();else if(!(v[0]==="id"&&v[1]==="name"))if(v[0]==="bestmove"){t&&g&&t.emit(g),t=void 0,h();return}else if(t&&!t.swap_requested&&!t.stop_requested&&v[0]==="info"){let y=0,w,S=1,P,R,N=!1,U,Y=[];for(let F=1;F<v.length;F++)switch(v[F]){case"depth":y=parseInt(v[++F]);break;case"nodes":w=parseInt(v[++F]);break;case"multipv":S=parseInt(v[++F]);break;case"time":P=parseInt(v[++F]);break;case"score":N=v[++F]==="mate",U=parseInt(v[++F]),(v[F+1]==="lowerbound"||v[F+1]==="upperbound")&&(R=v[++F]);break;case"pv":Y=v.slice(++F),F=v.length;break}if(N&&!U||(a<S&&(a=S),!Me(w)||!Me(P)||!Me(N)||!Me(U)))return;const K=t.ply%2===1?-U:U;if(R&&S===1)return;const W={moves:Y,cp:N?void 0:K,mate:N?K:void 0,depth:y};S===1?g={fen:t.current_fen,depth:y,nodes:w,millis:P,cp:N?void 0:K,mate:N?K:void 0,pvs:[W]}:g&&(g.pvs.push(W),g.depth=Math.min(g.depth,y)),S===a&&g&&(t.on_pvs(g),y>=40&&l())}else m&&!["Stockfish","id","option","info"].includes(v[0])&&console.warn(`SF: ${m}`)}let a=0,t,o,g;function h(){if(!t&&(t=o,o=void 0,t)){g=void 0,a=1,r("Threads",t.threads),r("Hash",t.hash_size||16),r("MultiPV",Math.max(1,t.multi_pv)),_&&_!==t.game_id&&i("ucinewgame"),_=t.game_id,i(["position fen",t.initial_fen,"moves",t.moves].join(" "));const[m,v]=Object.entries(t.search)[0];i(`go ${m} ${v}`)}}let d=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function r(m,v){v=v.toString(),d.get(m)!==v&&(i(`setoption name ${m} value ${v}`),d.set(m,v))}function l(){t&&!t.stop_requested&&(t.stop_requested=!0,i("stop"))}function f(){t&&!t.swap_requested&&(t.swap_requested=!0,i("stop")),i("isready")}let _;return{start(m){u(m)},stop(){u()},destroy(){i("quit")},get state(){return s()?"computing":"idle"}}}async function en(e){const n=d=>{e.on_status(d)},i=d=>{e.on_received(d)},u=d=>{e.on_connected(d)};let s=await Tt(()=>import("./sf17-79-Kk0KEig0.js"),[]),c=await new Promise((d,r)=>{s.default({wasmMemory:tn(2560),onError:l=>r(new Error(l)),locateFile:l=>`stockfish/${l}`}).then(d).catch(r)}),a=await Yt({store:".aidchess.nnue"}).catch(()=>{}),t=[];for(let d=0;;d++){let r=c.getRecommendedNnue(d);if(!r||t.includes(r))break;t.push(r)}(await g(t)).forEach((d,r)=>c.setNnueBuffer(d,r)),c.onError=h(),c.listen=d=>i(d),u(d=>c.uci(d));async function g(d){return Promise.all(d.map(async r=>{let l=await a?.get(r).catch(()=>{});if(l&&l.byteLength>128*1024)return l;const f=new XMLHttpRequest;f.open("get",`stockfish/nnue/${r}`,!0),f.responseType="arraybuffer",f.onprogress=m=>n({download:{bytes:m.loaded,total:m.total}});const _=await new Promise((m,v)=>{f.onerror=()=>v(new Error(`fetch '${r}' failed: ${f.status}`)),f.onload=()=>{f.status/100===2?m(new Uint8Array(f.response)):v(new Error(`fetch '${r}' failed: ${f.status}`))},f.send()});return n(),a?.put(r,_).catch(()=>console.warn("IDB store failed")),_}))}function h(){return d=>{if(d.startsWith("BAD_NNUE")&&a){const r=Math.max(0,Number(d.slice(9))),l=c.getRecommendedNnue(r);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${l} from IDB`),a.remove(l)},2e3)}else n({error:d})}}}const tn=(e,n=32767)=>{let i=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:n})}catch(u){if(n<=e||!(u instanceof RangeError))throw u;n=Math.max(e,Math.ceil(n-n/i)),i=i===4?3:4}},He=jt();function nn(e){let[n,i]=M(void 0),[u,s]=M(void 0),[c]=ct(()=>Zt({on_downloaded_nb(h){i(h)},on_engine_failed(h){s(h)}}));function a(h,d,r,l,f,_,m,v){let y=c();if(!y)return _(),()=>{};let w=Math.max(1,navigator.hardwareConcurrency-2);y.start({threads:w,hash_size:256,game_id:h,stop_requested:!1,swap_requested:!1,path:[],search:{depth:f},multi_pv:l,ply:r,threatMode:!1,initial_fen:d,current_fen:d,moves:[],emit:function(P){v(P)},on_pvs:Dt(200,function(P){m(P)})})}let t={};function o(h,d,r,l,f,_,m,v){let y=[d,l,f].join("$$"),S=(()=>{let R=f===8?[20,8]:[20],N=l===1?[6,1]:[6];return R.flatMap(U=>N.map(Y=>[d,Y,U].join("$$")))})().find(R=>t[R]);S?v(t[S]):a(h,d,r,l,f,_,m,P);function P(R){t[y]=R,v(R)}}let g={get download_nb(){return n()},get engine_failed(){return u()},get state(){let h=c();return c.loading||!h?"loading":h.state},best_move_with_cache:o,stop(){c()?.stop()}};return b(He.Provider,{value:g,get children(){return E(()=>e.children)}})}const qe={equals:!1};function se(e,n,i){let u=!1,s=!0;const[c,a]=M(void 0,qe),t=E(l=>u?e(l):(s=!c(),l),n,qe);let[o,g]=M(void 0,qe),h;return[()=>(u=!0,s&&(s=a()),h=t(),u=!1,g(),h),()=>{if(o(),h)return h}]}var rn=C('<div class="is2d chessboard">');function ln(){let[e,n]=M(ie),[i,u]=M(void 0),[s,c]=M(void 0),a=E(()=>_e.fromSetup(fe(e()).unwrap()).unwrap()),t=E(()=>a().turn),o=E(()=>Nt(a()));const g=d=>{let r=a(),l=et(d),f=tt(r,l);r.play(l),be(()=>{u([d,f]),c([d,f]),n(Be(r.toSetup())),d.length})},h=d=>{if(!d){u(void 0);return}let r=tt(a(),et(d));u([d,r])};return{play_orig_key(d,r){let l=a(),f=t(),_=l.board.get(It(d)),m=d+r;_.role==="pawn"&&(r[1]==="8"&&f==="white"||r[1]==="1"&&f==="black")&&(m+="q"),g(m)},play_uci:g,set_fen_and_last_move(d,r){be(()=>{h(r),n(d)})},set_fen(d){n(d)},set_last_move(d){h(d)},get dests(){return o()},get fen(){return e()},get last_move(){return i()},get on_last_move_added(){return s()},get check(){return a().isCheck()}}}function an(e){let n,i;return Pe(()=>{let u=e.color,s=e.play_uci.dests,c={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:u,free:!1,dests:s,events:{after:e.play_uci.play_orig_key}}};i=Kt(n,c)}),B(()=>{let u;if(e.play_uci.last_move){let[s]=e.play_uci.last_move;u=[s.slice(0,2),s.slice(2,4)]}i.set({lastMove:u,fen:e.play_uci.fen,turnColor:e.color,orientation:e.orientation??"white",check:e.play_uci.check,movable:{color:e.movable?e.color:void 0,dests:e.play_uci.dests}})}),B(()=>{i.setAutoShapes(e.shapes??[])}),(()=>{var u=rn();return ue(s=>n=s,u),u})()}function ht(e,n,i,u){let s=dt(n,i),c=ut(s),a=Be(n.toSetup());n.play(s);let t=Be(n.toSetup());return{path:u.length===0?c:`${u} ${c}`,ply:e,before_fen:a,fen:t,uci:c,san:i}}function pt(e,n,i){let u=n[n.length-1];return i||(i=_e.fromSetup(fe(u?.fen??ie).unwrap()).unwrap()),[...n,ht((u?.ply??0)+1,i,e,u?.path??"")]}function lt(e,n=ie){let i=[],u=_e.fromSetup(fe(n).unwrap()).unwrap();for(let s of e)i=pt(s,i,u);return i}function Te(e,n){return[...e,...n]}function sn(e){let n=2,i=0,u=e[0];for(;n<=e.length-1&&i<2;)u===e[n]&&(i+=1),n+=2;return i===2}function je(e){return on(e)^cn(e)^dn(e)^un(e)}function on(e){let n=0;return Bt.forEach(i=>{let u=e.board[i],s=_n[i];Ot.forEach(c=>{let a=e.board[c],t=s[c];for(let o of u.intersect(a))n^=t[o]})}),n}function cn(e){return e.turn==="white"?fn:0}function dn(e){let n=0;return e.castles.rook.white.a!==void 0&&(n^=Ee.white[0]),e.castles.rook.white.h!==void 0&&(n^=Ee.white[1]),e.castles.rook.black.a!==void 0&&(n^=Ee.black[0]),e.castles.rook.black.h!==void 0&&(n^=Ee.black[1]),n}function un(e){return e.epSquare!==void 0?hn[Ut(e.epSquare)]:0}let _n={black:{pawn:Array(2637767806,720845184,1155203408,2618685246,1971536997,848342074,263957791,3896152207,226391645,436746274,2516964848,3491888988,1086189917,18044180,1572111136,597658413,97624494,1738507407,1950989311,2098318769,2194108574,4079062812,856979699,1270058469,2858720366,2378012835,2278688587,435406673,3031118064,2063925420,3376753832,615148625,1285502018,346460119,2803604355,55085973,1669016372,164740250,896886403,1935551383,410153072,533441746,3541084098,3214426080,2675233103,1374411850,1552073989,4244110986,844343081,2356462440,3116133511,2129956651,299173332,1701379241,1306570996,2530644806,1122123979,1831591130,1116211970,1594837592,972591349,2479207924,1675376029,3960916618),knight:Array(1447259295,4021046128,3139524504,1173487682,2467266804,4284945151,2925674454,3710671816,2129465869,587093076,3373793513,2156648078,3737413652,468575139,1129551363,2861996892,2826449619,1704209531,3738359347,569410928,3021312909,2444777957,282063667,682545472,3318488457,1447622272,757420137,2613420942,4012836163,2938127093,1208226490,2935205706,430957978,1381578755,4109399782,288855589,3169178148,2644780093,107966643,1304747544,1359190711,3229237120,3027167685,3011615298,564135827,770797430,1983662611,4153656423,3609759233,3727911466,200708787,744508026,1213261630,3485747185,2958861301,2598470344,2767997908,3881113485,1773764017,4189435844,4234838742,2624081078,2395569449,1728307101),bishop:Array(2140891889,1482849818,751922730,3546542069,216179596,444615341,2424254530,1344234989,929188581,2507911009,980166547,3566535507,143525013,4181962471,1815842366,911175674,3591335374,1452686093,385158879,4011414929,1448477120,3971299641,3133647265,3007628400,1708345684,3031964479,3022128657,118850112,2048127371,3158349745,1505327237,2568424029,1866609495,844703982,3504617058,1448882679,821387540,3631471417,2077838877,3352949096,2491080787,3368630402,983299419,3651215291,265429091,3019003608,2955948456,903690197,3925215275,3959093811,2455088053,3115011301,1765081558,3324795129,3443871631,3152559950,3699649406,3129545774,2747044893,3925243406,164095314,2234471571,2164784335,159995093),rook:Array(3661248027,3705503008,914567990,3462935583,2878378006,1133857586,3023618742,282908558,3686955701,2604456805,3061545110,3218002352,2836503392,536836808,2886925079,2936593041,453815187,3042568989,3279635891,3282689058,4088968807,2680453086,1731693966,1842894553,2736377365,121205621,2324595870,3784465521,1958759409,1306150933,2636541290,1950415745,322077955,3602873262,1211684447,504701736,2407799203,1925743434,3617596327,2498480299,2680229135,3731399221,2756509305,2635957500,1372762539,802677945,1707760534,3714687192,1615679922,1940556374,445390489,2864974375,1984806574,513390958,744398315,982749166,652663695,1184061125,3363191899,1064069880,2138882964,2616926846,2298715513,2414381911),queen:Array(2065276,410498334,2726640512,2570984935,3008987264,623860175,3527183895,467272850,568376656,990477018,2366955227,4183621538,946958343,3395758993,1690887473,605184237,275515833,2142902612,2021972412,105373677,1666662384,1338566998,498685668,3101233780,2733370951,3656512268,4025308119,778896067,2846510368,3058428120,1892379383,2565895844,3213117192,2495816991,1040203361,3106252493,1639829808,3213709576,604681594,4236730699,4009938384,2701667332,2182473079,3550198211,657991062,1640976276,460041378,1972323596,2510248061,2959337826,1625877874,2070189957,4245163299,2358312347,275739390,2037777210,2766930226,1933485829,3034118011,2653025529,2641780289,3540781195,1569993599,441337890),king:Array(588133437,1139638106,982032635,562514827,467575086,1405117894,3813285157,3601878331,1586505598,738488098,2970334297,1068097019,235518094,283685722,2666392744,3569817788,2169728352,2444571896,3967907832,420376911,3046293305,2311278792,2885955184,3030078181,4212469731,1046900335,995380926,3892683234,615726237,3880203074,176180504,1474506861,1256707747,764236850,3521530334,2318567964,128167623,2220129756,2567608573,441446694,4143447316,817912603,2368091832,1187643061,3438021235,1318922279,434876457,1180291767,2520707785,1962430872,1510954061,57831539,3354831405,891783098,2555636406,2881342935,3473267445,1238029452,2051805420,3655936674,330209165,1929681327,1313566811,4283920930)},white:{pawn:Array(1398143232,133930885,1351827834,2076951437,435980918,1668970368,2185864314,2041407829,346864372,4047877822,3669961416,616810829,3144558884,216165387,2761740594,3919406634,669429112,2234904640,1421079802,1924213810,4002762044,2592451728,1890340057,4189625662,2276713138,2741429688,2924122950,421576781,2277442246,153237420,4278711886,2380848297,2618700582,3018992701,957243316,1543415220,504378001,2591337657,1333852064,1661259930,561112646,1536910315,1349168372,411152329,1694697476,3755185459,4019355068,2066937809,3120395808,94890149,3045629038,1249184265,3477490924,4114113436,1014604031,3991324799,2040431088,2253613964,2547464012,2722521980,71289574,2450408597,1894451515,1939968537),knight:Array(3309827454,2028172868,4271523049,146617804,2467685867,2483428231,3743260573,1002067894,3535252974,4154611160,3623154244,3646679180,862933752,2806008282,2734037942,1328176304,2278785213,381286368,2074232908,4087773386,967884669,4239349185,419231360,1275421624,1088456595,2365565249,1758083333,2048846183,2635948261,940630937,839474029,902477345,2836079689,2007115168,1363041891,1130479818,3644959908,1385135238,1386975934,2635987502,1915744629,487743653,2049219159,69242857,1511066720,215590039,1459430344,676103291,83799035,1949179493,2593534694,2283504289,1349412676,2954378677,249149717,1578231917,4135085182,461755528,3669622373,219487622,2825233742,2479105382,2582097898,1221328648),bishop:Array(599199451,3274759746,1192619331,2832721114,91404660,3044880024,3906596030,803516785,288455592,2143232492,388352703,2521731420,1043041227,3195290851,4166724431,1228226538,500177583,533367442,4236023256,413575568,3435884549,1004255532,2859513268,3914086821,3080761716,3571165255,773372954,769693293,3116440923,1687629160,2489486648,3686847158,3530767427,2121652637,1827477891,2549918411,2071415163,2236083679,2040110303,3489536313,2190878435,2465915458,1675766804,3329799896,1483966600,159505618,2674227354,2683539437,3833196123,3891433165,1455453349,1430583255,2067726741,303380021,2136024795,2054591852,1029141665,2317027384,2068461795,2499875684,1302894490,1002663431,1560941298,2141002286),rook:Array(2694745228,4202576185,3602305260,3756663274,3061587876,3390977925,486312941,3515712841,1322319486,3839619171,392296762,1401523788,1934485528,645968162,696971825,2038689491,1723966113,2652365974,3988018407,1354171594,1287854075,1723106141,563845090,639520332,534957223,3612364282,3109494688,500957989,3477030536,4109750364,951472732,922095147,3946156928,2622281253,2936811901,630086272,2340986210,4107355543,3560210278,3868847493,611513888,3265390517,2874106961,1668707698,2778598353,292356118,754567370,185141877,2884558258,1492107531,3336927864,782994598,346133860,2080909533,3612065399,2151962287,3957975594,52533817,1232633839,2716413964,1531307298,3030137657,3561556693,313061910),queen:Array(1878946792,3724105660,1691411102,148741087,142506469,3811107376,472209891,1913386482,2960608550,1145005292,1091751784,3625186042,1712140887,1504455800,3896940088,2478191531,3233871270,3404865229,1462204167,1349259705,3627860584,1244251718,3979211282,3043187861,581894202,1390895705,2599134010,2488233440,1816641224,1792034756,2779893723,2084952115,1351806869,2469979804,1163545420,1795352113,1796715044,3521170642,3725363621,1342594643,2618386938,2028859350,1841905045,4002935891,850071259,979915719,830889197,1744763229,522919199,3063822504,2861636095,4097602344,4215946617,894485042,924809191,1811585710,3439653887,3810997538,2677100683,77233985,4239834691,148802076,2409138150,3048474397),king:Array(1438004300,3093439067,3401620219,3673745794,3053321309,822915968,3900685126,553823814,4166295066,128359165,3300989119,4193552686,452189154,4122259632,2519387887,74333898,4032631446,2521268686,2620314688,1378755571,394133753,734399075,573292462,1214417373,2110224475,2331215665,531326186,3839443603,2644531398,616620850,590349237,3582377217,1582708616,2126148205,173450736,3616831144,2655785577,401600069,496349349,2479612086,1710903074,3589924952,3266682943,1496318498,3459221058,2091479615,663040899,3323704225,353318429,2674540957,1688550857,338551967,204689992,178008789,3871613304,1911672356,4055679954,3878217928,2533095482,2174833823,1604814460,1452830254,2441027029,3524103304)}},fn=4174784170,Ee={black:Array(2776523577,519497435),white:Array(836181454,4049974663)},hn=Array(1892447193,3793382197,3838936,479846099,3476112862,3504620154,2009473484,1738755500);var pn=C("<div class=replay-single><div class=moves></div><div class=sharpness><span class=label>Sharpness:</span> "),gn=C("<span class=index>"),mn=C("<span><span class=san>"),vn=C('<span class="word safe">Safe <small>(+5 moves maintains eval)'),yn=C('<span class="word playable">Playable <small>(3-4 moves maintains eval)'),bn=C('<span class="word sharp">Sharp <small>(2 moves maintains eval)'),$n=C('<span class="word critical">Critical <small>(Only 1 move maintains eval)'),it=C("<span class=eval>"),at=C("<span class=loading>."),wn=C("<span class=judgement>");function de(e){return _e.fromSetup(fe(e).unwrap()).unwrap()}function kn(){let[e,n]=M([]),[i,u]=M([]);const s=E(()=>{let y=i();return y[y.length-1]});let[c,a]=M(s()?.ply??0);const t=E(()=>{let y=c();return i().find(S=>S.ply===y)});let o=E(Oe(i,y=>y.san)),g=E(Oe(i,y=>y.ply)),h=E(()=>{let y=o(),w=g();return y.map((S,P)=>`${w[P]} ${S}`)});const d=y=>{a(y)},r=()=>{let y=c()-1;return g().find(w=>w===y)},l=()=>{let y=c()+1;return g().find(w=>w===y)},f=E(()=>sn(e())),_=E(()=>{let y=s();return y?de(y.fen).isStalemate():!1}),m=E(()=>{let y=s();return y?de(y.fen).isCheckmate():!1}),v=E(()=>{let y=s();return y?de(y.fen).isInsufficientMaterial():!1});return{set_sans(y){u(lt(y)),a(y.length);let w=i();n(w.reduce((S,P)=>Te([je(de(P.fen))],S),[]))},get steps(){return i()},get steps_up_to_ply(){return i().slice(0,c())},get plies(){return g()},get sans(){return o()},get ply_sans(){return h()},get ply_step(){return t()},get last_step(){return s()},get ply(){return c()},goto_ply:d,get_prev_ply:r,get_next_ply:l,goto_prev_ply_if_can(){let y=r();y!==void 0&&d(y),c()===1&&a(0)},goto_next_ply_if_can(){let y=l();y!==void 0&&d(y)},play_san(y){let w=s();if(!w){u(lt([y]));let P=i();n(P.reduce((R,N)=>Te([je(de(N.fen))],R),[])),a(s().ply);return}let S=i();u(pt(y,S)),w=s(),n(Te([je(de(w.fen))],e())),a(w.ply)},get is_on_last_ply(){return c()===(s()?.ply??0)},get is_threefold(){return f()},get is_checkmate(){return m()},get is_stalemate(){return _()},get is_insufficient(){return v()}}}function xn(e){const n=E(Oe(()=>e.play_replay.ply_sans,a=>{let[t,o]=a.split(" ");return{ply:parseInt(t),san:o}})),i=a=>{e.play_replay.goto_ply(a)},u=E(()=>e.play_replay.ply_step?.ply);B(G(()=>e.play_replay.steps,a=>e.steps_stockfish.set_steps(a)));let s;const c=a=>{let t=e.steps_stockfish.steps_with_stockfish[a];if(!t)return"";let o=t.d20pv6[1](),g=t.d20pv1[1](),h=t.d8pv6[1](),d=t.d8pv1[1]();if(o)return(o.judgement??"")+" d20pv6";if(g)return(g.judgement??"")+" d20pv1";if(h)return(h.judgement??"")+" d8pv6";if(d)return(d.judgement??"")+" d8pv1"};return B(()=>{if(n().length<7)return;let t=s.parentElement,o;if(e.play_replay.ply<3)o=0;else if(e.play_replay.is_on_last_ply)o=99999;else{let g=t.querySelector(".active");g&&(o=g.offsetTop-s.offsetHeight/2+g.offsetHeight/2)}o!==void 0&&(s.scrollTop=o)}),(()=>{var a=pn(),t=a.firstChild,o=t.nextSibling,g=o.firstChild;return g.nextSibling,ue(h=>s=h,t),x(t,b(_t,{get each(){return n()},children:(h,d)=>[b(H,{get when(){return h.ply%2===1},get children(){var r=gn();return x(r,()=>Math.ceil(h.ply/2)),r}}),(()=>{var r=mn(),l=r.firstChild;return r.$$click=()=>i(h.ply),r.$$contextmenu=f=>{f.preventDefault(),e.on_context_menu(f,h.ply)},x(l,()=>h.san),x(r,b(H,{get when(){return e.steps_stockfish.steps_with_stockfish[d()]},children:f=>b(Cn,{get ss(){return f()}})}),null),$e(()=>ee(r,"move "+c(d())+(h.ply===u()?" active":""))),r})()]})),x(o,b(Sn,{get sharpness(){return e.last_step_sharpness}}),null),a})()}function Sn(e){return b(ze,{get children(){return[b(Q,{get when(){return e.sharpness===void 0},children:"..."}),b(Q,{get when(){return e.sharpness&&e.sharpness>=5},get children(){return vn()}}),b(Q,{get when(){return e.sharpness===3||e.sharpness===4},get children(){return yn()}}),b(Q,{get when(){return e.sharpness===2},get children(){return bn()}}),b(Q,{get when(){return e.sharpness===1},get children(){return $n()}})]}})}function Cn(e){return b(ze,{get fallback(){return b(ye,{get step(){return e.ss.d8pv1[0]()}})},get children(){return[b(Q,{get when(){return e.ss.d20pv6[1]()},children:n=>b(ye,{get step(){return n()}})}),b(Q,{get when(){return e.ss.d20pv1[1]()},children:n=>b(ye,{get step(){return n()}})}),b(Q,{get when(){return e.ss.d8pv6[1]()},children:n=>b(ye,{get step(){return n()}})}),b(Q,{get when(){return e.ss.d8pv1[1]()},children:n=>b(ye,{get step(){return n()}})})]}})}const gt=e=>e==="top"?"!":e==="ok"?"✓":e==="inaccuracy"?"?!":e==="mistake"?"?":"??";function ye(e){const n=()=>e.step.search?.cp,i=()=>e.step.judgement,u=()=>e.step.progress?.depth;return(()=>{var s=it();return x(s,b(H,{get when(){return n()!==void 0},get fallback(){return(()=>{var c=at();return c.firstChild,x(c,u,null),c})()},get children(){var c=it();return x(c,()=>Mn(n())),c}}),null),x(s,b(H,{get when(){return i()},get fallback(){return at()},children:c=>(()=>{var a=wn();return x(a,()=>gt(c())),a})()}),null),s})()}function Mn(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}Fe(["contextmenu","click"]);var De=Symbol("fallback");function st(e){for(const n of e)n.dispose()}function mt(e,n,i,u={}){const s=new Map;return we(()=>st(s.values())),()=>{const a=e()||[];return a[Wt],Ft(()=>{if(!a.length)return st(s.values()),s.clear(),u.fallback?[nt(d=>(s.set(De,{dispose:d}),u.fallback()))]:[];const t=new Array(a.length),o=s.get(De);if(!s.size||o){o?.dispose(),s.delete(De);for(let h=0;h<a.length;h++){const d=a[h],r=n(d,h);c(t,d,h,r)}return t}const g=new Set(s.keys());for(let h=0;h<a.length;h++){const d=a[h],r=n(d,h);g.delete(r);const l=s.get(r);l?(t[h]=l.mapped,l.setIndex?.(h),l.setItem(()=>d)):c(t,d,h,r)}for(const h of g)s.get(h)?.dispose(),s.delete(h);return t})};function c(a,t,o,g){nt(h=>{const[d,r]=M(t),l={setItem:r,dispose:h};if(i.length>1){const[f,_]=M(o);l.setIndex=_,l.mapped=i(d,f)}else l.mapped=i(d);s.set(g,l),a[o]=l.mapped})}}function En(e){const{by:n}=e;return E(mt(()=>e.each,typeof n=="function"?n:i=>i[n],e.children,"fallback"in e?{fallback:()=>e.fallback}:void 0))}var An=C("<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=branch-sums><button data-icon=></button><button data-icon=></button></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=>"),vt=C("<span class=index>"),Pn=C("<div class=fbt>"),Ln=C("<div class=lines>"),Rn=C("<div class=line>"),qn=C("<span class=collapsed>..<!> "),Tn=C("<div>");function jn(e){return zt(e).map(n=>{let i=n.headers.get("Event"),u=n.headers.get("Site"),s=n.headers.get("White"),c=n.headers.get("Black"),a=n.headers.get("Chapter"),t=n.headers.get("Orientation"),o=n.headers.get("FEN"),g=o??ie,h=_e.fromSetup(fe(g).unwrap()).unwrap(),d=yt();n.moves.children.forEach(l=>{r(l,h,"")});function r(l,f,_){let m=l.data.san,v=dt(f,m),y=f.clone();y.play(v);let w=ut(v),S=l.data.nags;d.add_child_san(_,m).set_nags(S??[]);let P=_.length===0?w:`${_} ${w}`;l.children.forEach(R=>{r(R,y,P)})}return{event:i,site:u,white:s,black:c,chapter:a,fen:o,orientation:t,tree:d}})}function yt(){let[e,n]=M([]);const i=a=>u(a)?.[1],u=a=>{if(a==="")return;let t=a.split(" "),o=0,g,h=e();for(;;){let d=t.slice(0,o+1).join(" "),r=h.find(l=>l.path===d);if(!r)return;if(o++,o===t.length)return[g,r];g=r,h=r.children}};function s(a,t=!1){let o=a.ply,g=o%2===1||t?Math.ceil(o/2)+(o%2===1?".":"..."):"",h=o%2===1?"":" ";return`${g} ${a.san}${a.comments?" { "+a.comments+" }":""}${h}`}function c(a,t=!1){let o="";return a.length===0||(a.length===1?(o+=s(a[0].step,t),o+=c(a[0].children,!1)):(o+=s(a[0].step,!1).trimEnd(),o+=" "+a.slice(1).map(g=>`(${c([g],!0).trimEnd()})`).join(" "),o+=" "+c(a[0].children,!0))),o}return{get as_pgn(){return c(e(),!0)},get initial_fen(){if(e().length!==0)return e()[0].step.before_fen},get root(){return e()},add_sans_at_root(a){if(a.length===0)return[];let t=a[0],o=this.add_child_san("",t),g=[o];return a.slice(1).forEach(h=>{o=o.add_child_san(h),g.push(o)}),g},add_child_san(a,t){if(a===""){let g=e(),h=g.find(l=>l.san===t);if(h)return h;let d=_e.fromSetup(fe(ie).unwrap()).unwrap(),r=bt(0,d,t,"");return n([...g,r]),r}let o=i(a);if(o)return o.add_child_san(t)},remove_child_at_path(a){let t=u(a);if(t){if(!t[0]){let o=e(),g=o.indexOf(t[1]);return o.splice(g,1),n([...o]),t[1]}return t[0].remove_child(t[1]),t[1]}},find_at_path:i,find_parent_and_child_at_path:u,siblings_of(a){let t=u(a)?.[0];if(t)return t.children;if(a.split(" ").length===1)return e()},previous_branch_points(a){let t=[],o=e(),g=o.length>1;for(let h of a.split(" ")){let d=o.find(r=>r.step.uci===h);if(!d)return;g&&(t.push(d),g=!1),d.children.length>1&&(g=!0),o=d.children}return t}}}function bt(e,n,i,u){let[s,c]=M([]),[a,t]=M([]);n=n.clone();let o=ht(e,n,i,u),g=()=>h()?.length??0,h=()=>d()?.children,d=()=>{let l=s();if(l.length!==0)return l.length===1?l[0].first_node_with_variations:r},r={get nags(){return a()},set_nags:t,get path(){return o.path},get ply(){return o.ply},get san(){return o.san},step:o,get children(){return s()},remove_child(l){let f=s(),_=f.indexOf(l);if(_!==-1)return f.splice(_,1),c([...f]),l},add_child_san(l){let f=s(),_=f.find(v=>v.san===l);if(_)return _;let m=bt(e+1,n,l,o.path);return c([...f,m]),m},remove_child_san(l){let f=s(),_=f.findIndex(v=>v.step.san!==l);if(_===-1)return;let m=f.splice(_,1)[0];return c([...f]),m},get nb_first_variations(){return g()},get first_node_with_variations(){return d()},get length(){let l=s();if(l.length>1)return 1;if(l.length===0)return 0;let f=1,_=l[0];for(;_?.children.length===1;)f++,_=_.children[0];return f}};return r}function Dn(e){let n=yt();e&&(n=jn(e)[0].tree);let[i,u]=M(""),s=[];B(G(i,r=>{n.previous_branch_points(r)?.map(l=>{s.includes(l.path)||(n.siblings_of(l.path)?.forEach(f=>{s=s.filter(_=>_!==f.path)}),s.push(l.path))})}));const c=r=>{u(r)},a=()=>{let r=i();if(r!=="")return r.split(" ").slice(0,-1).join(" ")},t=()=>{let r=i(),l=n.find_at_path(r)?.children??n.root;return l.length===1?l[0].path:l.find(f=>s.includes(f.path))?.path??l[0]?.path},o=()=>{let r=n.find_parent_and_child_at_path(i());if(!r)return;let l=r;if(!l[0])return"";if(l[0].children.length>1)return l[0].path;for(;!(!l[0]||l[0].children.length>1);){let f=n.find_parent_and_child_at_path(l[0].path);if(!f)break;l=f}return l[1].path},g=()=>{let r=n.find_at_path(i());if(!r)return n.root.find(f=>s.includes(f.path))?.path??n.root[0]?.path;let l=r;if(l.children.length>1)return l.children.find(f=>s.includes(f.path))?.path??l.children[0]?.path;for(;l.children.length===1;)l=l.children[0];return l.path},h=()=>{let r=n.find_parent_and_child_at_path(i());if(!r)return;let l=r[0]?.children??[];if(!r[0])l=n.root;else if(r[0].children.length===1)for(;;){if(r=n.find_parent_and_child_at_path(r[0].path),!r)return;if(!r[0]){l=n.root;break}if(r[0].children.length>1){l=r[0].children;break}}let f=l.indexOf(r[1]),_=l[f-1];if(_)return _.path},d=()=>{let r=n.find_parent_and_child_at_path(i());if(!r)return;let l=r[0]?.children??[];if(!r[0])l=n.root;else if(r[0].children.length===1)for(;;){if(r=n.find_parent_and_child_at_path(r[0].path),!r)return;if(!r[0]){l=n.root;break}if(r[0].children.length>1){l=r[0].children;break}}let f=l.indexOf(r[1]),_=l[f+1];if(_)return _.path};return{steps:n,get cursor_path(){return i()},set cursor_path(r){u(r)},get cursor_path_step(){return n.find_at_path(i())?.step},goto_path:c,get_prev_path:a,get_next_path:t,goto_prev_if_can(){let r=a();r!==void 0&&c(r)},goto_next_if_can(){let r=t();r!==void 0&&c(r)},get_first_path:o,get_last_path:g,get_up_path:h,get_down_path:d,goto_up_if_can(){let r=h();r!==void 0&&c(r)},goto_down_if_can(){let r=d();r!==void 0&&c(r)},goto_last_if_can(){let r=g();r!==void 0&&c(r)},goto_first_if_can(){let r=o();r!==void 0&&c(r)},get previous_branch_points_at_cursor_path(){return n.previous_branch_points(i())??[]}}}function Nn(e){const n=e.play_replay.steps;let i;B(()=>{let s=e.play_replay.cursor_path,c=i.parentElement;if(!c)return;const a=i.querySelector(".on-path-end");if(!a){c.scrollTop=s.length>0?99999:0;return}let t=a.offsetTop-c.offsetHeight/2+a.offsetHeight;c.scrollTo({behavior:"smooth",top:t})});const u=s=>{let c=!1;s.key==="ArrowLeft"&&(e.play_replay.goto_prev_if_can(),c=!0),s.key==="ArrowRight"&&(e.play_replay.goto_next_if_can(),c=!0),s.key==="ArrowUp"&&(e.play_replay.goto_up_if_can(),c=!0),s.key==="ArrowDown"&&(e.play_replay.goto_down_if_can(),c=!0),c&&s.preventDefault()};return Pe(()=>{document.addEventListener("keydown",u),we(()=>{document.removeEventListener("keydown",u)})}),(()=>{var s=An(),c=s.firstChild,a=c.firstChild,t=c.nextSibling,o=t.firstChild,g=o.nextSibling,h=t.nextSibling,d=h.firstChild,r=d.nextSibling,l=r.nextSibling,f=l.nextSibling;return ue(_=>i=_,a),x(a,b(Ue,{get nodes(){return n.root},get cursor_path(){return e.play_replay.cursor_path},on_set_cursor:_=>e.play_replay.cursor_path=_,on_context_menu:(_,m)=>e.on_context_menu?.(_,m)})),o.$$click=()=>e.play_replay.goto_up_if_can(),g.$$click=()=>e.play_replay.goto_down_if_can(),x(t,b(_t,{get each(){return e.play_replay.previous_branch_points_at_cursor_path},children:_=>(()=>{var m=Pn();return m.$$click=()=>e.play_replay.cursor_path=_.path,x(m,b(H,{get when(){return _.ply&1},get children(){var v=vt();return x(v,()=>We(_.ply)),v}}),null),x(m,()=>_.san,null),m})()}),null),d.$$click=()=>e.play_replay.goto_first_if_can(),r.$$click=()=>e.play_replay.goto_prev_if_can(),l.$$click=()=>e.play_replay.goto_next_if_can(),f.$$click=()=>e.play_replay.goto_last_if_can(),$e(_=>{var m=e.play_replay.get_up_path()===void 0,v="fbt prev"+(e.play_replay.get_up_path()===void 0?" disabled":""),y=e.play_replay.get_down_path()===void 0,w="fbt prev"+(e.play_replay.get_down_path()===void 0?" disabled":""),S=e.play_replay.get_first_path()===void 0,P="fbt first"+(e.play_replay.get_first_path()===void 0?" disabled":""),R=e.play_replay.get_prev_path()===void 0,N="fbt prev"+(e.play_replay.get_prev_path()===void 0?" disabled":""),U=e.play_replay.get_next_path()===void 0,Y="fbt next"+(e.play_replay.get_next_path()===void 0?" disabled":""),V=e.play_replay.get_last_path()===void 0,K="fbt last"+(e.play_replay.get_last_path()===void 0?"disabled":"");return m!==_.e&&(o.disabled=_.e=m),v!==_.t&&ee(o,_.t=v),y!==_.a&&(g.disabled=_.a=y),w!==_.o&&ee(g,_.o=w),S!==_.i&&(d.disabled=_.i=S),P!==_.n&&ee(d,_.n=P),R!==_.s&&(r.disabled=_.s=R),N!==_.h&&ee(r,_.h=N),U!==_.r&&(l.disabled=_.r=U),Y!==_.d&&ee(l,_.d=Y),V!==_.l&&(f.disabled=_.l=V),K!==_.u&&ee(f,_.u=K),_},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),s})()}function Ue(e){return[b(H,{get when(){return e.nodes.length===1},get children(){return[b(Ne,me(e,{get node(){return e.nodes[0]}})),b(Ue,me(e,{get nodes(){return e.nodes[0].children}}))]}}),b(H,{get when(){return e.nodes.length>1},get children(){var n=Ln();return x(n,b(En,{get each(){return e.nodes},by:"path",children:i=>(()=>{var u=Rn();return x(u,b(H,{get when(){return e.cursor_path.startsWith(i().path)},get fallback(){return[b(Ne,me(e,{get node(){return i()},show_index:!0,collapsed:!0})),(()=>{var s=qn(),c=s.firstChild,a=c.nextSibling;return a.nextSibling,x(s,()=>i().length,a),x(s,()=>i().nb_first_variations,null),s})()]},get children(){return[b(Ne,me(e,{get node(){return i()},show_index:!0})),b(Ue,me(e,{get nodes(){return i().children}}))]}})),u})()})),n}})]}function Ne(e){let n=E(()=>e.node.ply%2===0||e.show_index),i=E(()=>e.node.ply%2===0?".":"...");const u=E(()=>e.node.path),s=E(()=>e.cursor_path.startsWith(u())),c=E(()=>u()===e.cursor_path),a=E(()=>{let t=["move"];return e.collapsed&&t.push("collapsed"),s()&&t.push("on-path"),c()&&t.push("on-path-end"),t.join(" ")});return(()=>{var t=Tn();return t.$$click=()=>{e.on_set_cursor(e.node.path)},t.$$contextmenu=o=>{o.preventDefault(),e.on_context_menu(o,e.node.path)},x(t,b(H,{get when(){return n()},get children(){var o=vt();return x(o,()=>Math.floor(e.node.ply/2)+1,null),x(o,i,null),o}}),null),x(t,()=>e.node.san,null),$e(()=>ee(t,a())),t})()}const We=e=>`${Math.floor(e/2)+1}.`+(e%2===1?"..":"");Fe(["click","contextmenu"]);const In=(e,n)=>e==="white"?n:-n,$t=e=>2/(1+Math.exp(-.00368208*e))-1,Bn=e=>$t(Math.min(Math.max(-1e3,e),1e3)),On=e=>{const i=(21-Math.min(10,Math.abs(e)))*100*(e>0?1:-1);return $t(i)},Un=e=>typeof e.mate<"u"?On(e.mate):Bn(e.cp),ot=(e,n)=>In(e,Un(n)),Wn=(e,n,i)=>(ot(e,n)-ot(e,i))/2,Fn=(e,n,i)=>Wn(e,n,i),le=8;function zn(){let e=ft(He);function n(l,f,_,m,v,y,w){e.best_move_with_cache(o(),l,f,_,m,v,y,w)}let i,u=[];function s(l,f,_,m){let[v,y]=M(void 0),[w,S]=M(void 0),[P,R]=M(void 0),N={get loading(){return v()},get depth_eval(){return w()},get best_eval(){return P()},cancel:Y},U={cancel:Y,fen:l,ply:f,depth:_,multi_pv:m,set_loading:y,set_depth_eval:S,set_best_eval:R};function Y(){let V=u.indexOf(U);V!==-1&&u.splice(V,1),i===U&&(console.trace("working cancel"),i=void 0,e.stop()),c()}return u.push(U),c(),N}function c(){if(i||(i=u.pop(),!i))return;const l=f=>{i?.set_best_eval(f),i=void 0,c()};n(i.fen,i.ply,i.multi_pv,i.depth,i.set_loading,i.set_depth_eval,l)}function a(l,f,_){let m=s(l.before_fen,l.ply-1,f,_),v=s(l.fen,l.ply,f,_);function y(w,S,P){let R=Fn(w,S,P);return R<.02?"top":R<.03?"ok":R<.05?"inaccuracy":R<.12?"mistake":"blunder"}return E(()=>(we(()=>{v.cancel(),m.cancel()}),{...l,get before_search(){return m.best_eval},get search(){return v.best_eval},get judgement(){let w=m.best_eval,S=v.best_eval;if(w&&S)return y(Ae(l.before_fen),w,S)},get progress(){return v?.depth_eval}}))}function t(l){let[f,_]=M(se(()=>a(l,le,6)())),[m,v]=M(se(()=>a(l,le,1)())),[y,w]=M(se(()=>a(l,20,6)())),[S,P]=M(se(()=>a(l,20,1)()));return{step:l,get d8pv6(){return f()},get d8pv1(){return m()},get d20pv6(){return y()},get d20pv1(){return S()},clear(){_(se(()=>a(l,le,6)())),w(se(()=>a(l,20,6)())),v(se(()=>a(l,le,1)())),P(se(()=>a(l,20,1)()))}}}let[o,g]=M(""),[h,d]=M([]),r=mt(h,l=>[l.fen,l.uci].join("$$"),l=>t(l()));return{set_game_id:g,set_steps:d,get steps_with_stockfish(){return r()}}}var Hn=C("<div class=loading><span class=info>Loading <!>%"),Vn=C("<div class=engine-wrap><div class=skill><label for=skill>Skill:</label><select name=skill id=skill><option value=A>Top</option><option value=B>Second</option><option value=C>Third</option><option value=D>Fourth</option><option value=E>Fifth</option></select></div><div class=depth><fieldset><div class=option><input type=radio name=depth id=level8><label for=level8>Depth </label></div><div class=option><input type=radio name=depth id=level20><label for=level20>Depth 20"),Kn=C("<span class=result>Game Over"),Gn=C("<small class=drop>Evaluation Dropped Below -2"),Qn=C("<span class=result>Checkmate"),Xn=C("<small class=drop>Victory is <span class=victory>"),Yn=C("<span class=result>Stalemate"),Ie=C("<small class=drop>Game is a draw"),Jn=C("<span class=result>3 Fold Repetition"),Zn=C("<span class=result>Insufficient Material"),er=C("<div class=result-wrap>"),tr=C("<div class=tools-wrap><button class=rematch>Rematch"),nr=C("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tabs-wrap><div>Match</div><div>Repertoire"),rr=C("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=delete data-icon=>Delete move"),lr=C("<div class=context-menu><div class=title></div><a class=stick data-icon=>Play only this line</a><a class=save data-icon=>Save this line</a><a class=analyze data-icon=>Analyze on lichess");const _r=()=>b(nn,{get children(){return b(ir,{})}});function ir(){let[e]=ct(()=>ft(He));const n=E(()=>{let i=e()?.download_nb;if(i)return Math.ceil(i.bytes/(i.total===0?70*1024*1024:i.total)*100)});return b(H,{get when(){return e()},children:i=>b(H,{get when(){return i().state==="loading"},get fallback(){return b(ar,{})},get children(){var u=Hn(),s=u.firstChild,c=s.firstChild,a=c.nextSibling;return a.nextSibling,x(s,()=>n()??"--",a),u}})})}function ar(){const e=Ht();e.setVolume(.2);let[n,i]=ve([],"builder.current.sans");const[u,s]=M(le);let c="";const a=zn(),t=kn();let o=ln();const[g,h]=M("white"),d=E(()=>rt(g())),r=E(()=>{let p=t.ply;return a.steps_with_stockfish.find(q=>q.step.ply===p)}),l=E(()=>{let p=a.steps_with_stockfish;return p[p.length-1]});function f(p){return u()===le?p.d8pv6:p.d20pv6}function _(p){return u()===le?p.d8pv1[0]():p.d20pv1[0]()}const[m,v]=M(void 0);function y(){clearTimeout(m()),v(setTimeout(()=>{v(void 0)},710))}B(()=>{if(m()!==void 0||V()!==void 0)return;let $=l();if(!$)return;if(Ae($.step.fen)===d()){let T=At();if(T&&T.startsWith($.step.path)){let L=T.slice($.step.path.length).trim().split(" ")[0];if(L){o.play_uci(L);return}}let O=f($)[0]();B(G(()=>O.search,L=>{if(!L)return;let k=L.cp,A=L.pvs,D=L.pvs.filter(j=>Math.abs(j.cp-k)<=10),z=L.pvs.filter(j=>Math.abs(j.cp-k)<=30),J=L.pvs.filter(j=>Math.abs(j.cp-k)<=60),X=L.pvs.filter(j=>Math.abs(j.cp-k)<=100),Z=L.pvs.filter(j=>Math.abs(j.cp-k)<200),ae=D.filter(j=>j.cp<150),ce=z.filter(j=>j.cp<150),ge=J.filter(j=>j.cp<150),Se=X.filter(j=>j.cp<150),Ce=Z.filter(j=>j.cp<150);function ne(j){return j.find(I=>I.length>0)}let re;switch(oe()){case"A":re=ne([ae,D,A]);break;case"B":re=ne([ce,ae,D,z,A]);break;case"C":re=ne([ge,ce,ae,D,z,J,A]);break;case"D":re=ne([Se,ge,ce,ae,D,z,J,X,A]);break;case"E":re=ne([Ce,Se,ge,ce,ae,D,z,J,X,Z,A]);break}o.play_uci(Qt(re).moves[0])}))}}),B(G(()=>o.on_last_move_added,p=>{p&&be(()=>{y(),t.play_san(p[1])})})),B(G(()=>t.sans,i)),B(G(()=>t.ply_step,p=>{o.set_fen_and_last_move(p?.fen??ie,p?.uci)})),B(G(()=>t.ply_step,(p,$)=>{p&&(!$||$.ply===p.ply-1)&&e.move(p)}));const w=Gt(p=>{const $=p.target;$.tagName!=="PIECE"&&$.tagName!=="SQUARE"&&$.tagName!=="CG-BOARD"||(p.preventDefault(),S(Math.sign(p.deltaY)))}),S=p=>{p>0?(te()==="match"&&t.goto_next_ply_if_can(),te()==="repertoire"&&W.goto_next_if_can()):(te()==="match"&&t.goto_prev_ply_if_can(),te()==="repertoire"&&W.goto_prev_if_can())};a.set_game_id(c),t.set_sans(n());const P=()=>{i([]),t.set_sans(n()),o.set_fen_and_last_move(ie),K(void 0)};B(G(u,()=>{a.steps_with_stockfish.forEach($=>{be(()=>{$.clear(),_($)})});let p=l();p&&f(p)[0]()})),B(G(l,p=>{if(!p)return;let $=_(p);B(G(()=>$.search,q=>{let T=q?.cp;T&&T<-200&&K("drop")}))})),B(()=>{let p=t.is_checkmate,$=t.is_stalemate,q=t.is_threefold,T=t.is_insufficient;p&&K("checkmate"),$&&K("stalemate"),q&&K("threefold"),T&&K("insufficient")});let[R,N]=ve("","builder.current.cursor_path"),[U,Y]=ve(void 0,"builder.current.pgn");const[V,K]=M(void 0),W=Dn(U());W.cursor_path=R(),B(G(()=>W.cursor_path,p=>{N(p)})),B(G(()=>W.cursor_path_step,p=>{p?o.set_fen_and_last_move(p.fen,p.uci):o.set_fen_and_last_move(ie)}));const F=p=>{be(()=>{pe(void 0),p&&t.goto_ply(p);let q=t.steps_up_to_ply.map(L=>L.san),T=W.steps.add_sans_at_root(q),O=T[T.length-1]?.path;O&&(Le("repertoire"),W.cursor_path=O,Y(W.steps.as_pgn))})},[te,Le]=M("match");B(G(te,p=>{let $=p==="repertoire"?W.cursor_path_step:t.ply_step;$?o.set_fen_and_last_move($.fen,$.uci):o.set_fen_and_last_move(ie)}));let Re,ke;const wt=(p,$)=>{W.cursor_path=$,he(W.steps.find_at_path($));let q=p.clientX,T=p.clientY,O=ke.getBoundingClientRect(),L=Re.getBoundingClientRect();q-=L.left,T-=L.top,q=Math.min(q,document.body.clientWidth-O.width-L.left-20);let k=`${T}px`,A=`${q}px`;ke.style.top=k,ke.style.left=A};let xe;const kt=(p,$)=>{t.goto_ply($),pe(t.ply_step);let q=p.clientX,T=p.clientY,O=xe.getBoundingClientRect(),L=Re.getBoundingClientRect();q-=L.left,T-=L.top,q=Math.min(q,document.body.clientWidth-O.width-L.left-20);let k=`${T}px`,A=`${q}px`;xe.style.top=k,xe.style.left=A};Pe(()=>{const p=()=>{he(void 0),pe(void 0)};document.addEventListener("click",p),we(()=>{document.removeEventListener("click",p)})});const[xt,he]=M(void 0),[St,pe]=M(void 0),Ct=p=>{W.steps.remove_child_at_path(p),he(void 0)},Ve=p=>{s(p)},Mt=E(()=>t.is_on_last_ply&&V()===void 0);Pe(()=>{const p=$=>{$.key==="f"&&h(rt(g()))};document.addEventListener("keypress",p),we(()=>{document.removeEventListener("keypress",p)})});const[oe,Et]=ve("A","builder.skill"),[At,Pt]=ve(void 0,"builder.stick-line"),Ke=p=>{Pt(p),he(void 0),pe(void 0)},Lt=E(()=>{let p=r();if(!p)return;let $=f(p)[0]();return $?E(G(()=>$.search,T=>{if(!T)return;let O=T.cp;return T.pvs.filter(L=>Math.abs(O-L.cp)<45).length}))():void 0}),Rt=p=>{let $=p.fen;window.open(`https://lichess.org/analysis?fen=${$}`,"_blank"),pe(void 0),he(void 0)},qt=E(()=>{let p=r();if(!p)return;if(Ae(p.step.fen)===d()){let{uci:q,san:T}=p.step,O=_(p);if(!O.judgement)return;let L=gt(O.judgement);return Xt(q,T,L)}});return(()=>{var p=nr(),$=p.firstChild,q=$.nextSibling,T=q.firstChild,O=T.firstChild,L=O.nextSibling;return Vt(p,"wheel",w),ue(k=>Re=k,p),x($,b(an,{get shapes(){return qt()},get orientation(){return g()},get color(){return g()},get movable(){return Mt()},play_uci:o})),O.$$click=()=>Le("match"),L.$$click=()=>Le("repertoire"),x(q,b(H,{get when(){return te()==="match"},get children(){return[(()=>{var k=Vn(),A=k.firstChild,D=A.firstChild,z=D.nextSibling,J=z.firstChild,X=J.nextSibling,Z=X.nextSibling,ae=Z.nextSibling,ce=ae.nextSibling,ge=A.nextSibling,Se=ge.firstChild,Ce=Se.firstChild,ne=Ce.firstChild,re=ne.nextSibling;re.firstChild;var Ge=Ce.nextSibling,j=Ge.firstChild;return z.addEventListener("change",I=>Et(I.currentTarget.value)),ne.addEventListener("change",I=>{I.target.checked&&Ve(le)}),ne.checked=!0,x(re,le,null),j.addEventListener("change",I=>{I.target.checked&&Ve(20)}),$e(I=>{var Qe=oe()==="A",Xe=oe()==="B",Ye=oe()==="C",Je=oe()==="D",Ze=oe()==="E";return Qe!==I.e&&(J.selected=I.e=Qe),Xe!==I.t&&(X.selected=I.t=Xe),Ye!==I.a&&(Z.selected=I.a=Ye),Je!==I.o&&(ae.selected=I.o=Je),Ze!==I.i&&(ce.selected=I.i=Ze),I},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),k})(),b(xn,{play_replay:t,steps_stockfish:a,get last_step_sharpness(){return Lt()},on_context_menu:kt}),(()=>{var k=er();return x(k,b(ze,{get children(){return[b(Q,{get when(){return V()==="drop"},get children(){return[Kn(),Gn()]}}),b(Q,{get when(){return V()==="checkmate"},get children(){return[Qn(),(()=>{var A=Xn(),D=A.firstChild,z=D.nextSibling;return x(z,()=>Ae(t.last_step.before_fen)),A})()]}}),b(Q,{get when(){return V()==="stalemate"},get children(){return[Yn(),Ie()]}}),b(Q,{get when(){return V()==="threefold"},get children(){return[Jn(),Ie()]}}),b(Q,{get when(){return V()==="insufficient"},get children(){return[Zn(),Ie()]}})]}})),k})(),(()=>{var k=tr(),A=k.firstChild;return A.$$click=P,k})()]}}),null),x(q,b(H,{get when(){return te()==="repertoire"},get children(){return b(Nn,{play_replay:W,on_context_menu:wt})}}),null),x(p,b(H,{get when(){return xt()},children:k=>(()=>{var A=rr(),D=A.firstChild,z=D.nextSibling,J=z.nextSibling;return ue(X=>ke=X,A),A.$$click=X=>{X.preventDefault(),X.stopImmediatePropagation()},x(D,()=>We(k().ply),null),x(D,()=>k().san,null),z.$$click=()=>Ke(k().path),J.$$click=()=>Ct(k().path),A})()}),null),x(p,b(H,{get when(){return St()},children:k=>(()=>{var A=lr(),D=A.firstChild,z=D.nextSibling,J=z.nextSibling,X=J.nextSibling;return ue(Z=>xe=Z,A),A.$$click=Z=>{Z.preventDefault(),Z.stopImmediatePropagation()},x(D,()=>We(k().ply),null),x(D,()=>k().san,null),z.$$click=()=>Ke(k().path),J.$$click=()=>F(k().ply),X.$$click=()=>Rt(k()),A})()}),null),$e(k=>{var A="tab"+(te()==="match"?" active":""),D="tab"+(te()==="repertoire"?" active":"");return A!==k.e&&ee(O,k.e=A),D!==k.t&&ee(L,k.t=D),k},{e:void 0,t:void 0}),p})()}Fe(["click"]);export{_r as default};
