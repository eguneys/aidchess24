var J=Object.defineProperty;var K=(a,e,t)=>e in a?J(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>(K(a,typeof e!="symbol"?e+"":e,t),t);import{d as V,l as j,n as X,i,c as _,S as b,o as W,e as Z,M as G,F as P,f as z,g as ee,t as u,k as g,p as te,h as re,j as ae,b as Q,q as y,s as se,m as ne}from"./index-B8cdpkBa.js";/* empty css                   */import{S as le}from"./studyrepo-BHnCgju4.js";import{S as ie,C as he}from"./Shalala-DZ-QRb1C.js";import{I as _e,M as de}from"./chess_pgn_logic-CrqMqGtU.js";var ce=u("<div class=chesstree>"),oe=u("<div class=lines>"),ue=u("<div class=line>"),pe=u("<span class=index>"),fe=u("<div>");const R=class R{constructor(e,t){o(this,"_tree");o(this,"_cursor_path");o(this,"_hidden_paths");o(this,"_revealed_paths");o(this,"_failed_paths");o(this,"_solved_paths");o(this,"reveal_hidden_paths",()=>{this.revealed_paths=this.hidden_paths,this.hidden_paths=[]});o(this,"try_next_uci_fail",e=>{var l,c;const t=(l=this.tree)==null?void 0:l._traverse_path(this.cursor_path);if(!t)return;const s=t.children;if(((c=s[0])==null?void 0:c.data.uci)===e){let d=this.hidden_paths;d=d.filter(m=>m.join("")!==s[0].data.path.join(""));let S=s[0].children.map(m=>m.data.path);d.push(...S),this.hidden_paths=d;let v=this.solved_paths;v.push(s[0].data.path),this.solved_paths=v,this.cursor_path=s[0].data.path}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}this.add_uci(e),this.failed_paths.push([...t.data.path,e]),setTimeout(()=>{this.on_wheel(-1)},100)}});o(this,"on_wheel",e=>{var s;let t=this.cursor_path;if(e<0)t.length>1&&this.try_set_cursor_path(t.slice(0,-1));else{let l=this.tree;if(l){let d=(s=l._traverse_path(t).children[0])==null?void 0:s.data.path;d&&this.try_set_cursor_path(d)}}});this.initial_fen=e,this._cursor_path=g([],{equals:!1}),this._tree=g(t),this._hidden_paths=g([],{equals:!1}),this._revealed_paths=g([],{equals:!1}),this._failed_paths=g([],{equals:!1}),this._solved_paths=g([],{equals:!1})}get solved_paths(){return this._solved_paths[0]()}set solved_paths(e){this._solved_paths[1](e)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(e){this._failed_paths[1](e)}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(e){this._revealed_paths[1](e)}get hidden_paths(){return this._hidden_paths[0]()}set hidden_paths(e){this._hidden_paths[1](e)}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(e){this._cursor_path[1](e)}set tree(e){this._tree[1](e)}try_set_cursor_path(e){return this.hidden_paths.find(s=>e.join("").startsWith(s.join("")))?!1:(this.cursor_path=e,!0)}get fen_last_move(){let e=this.tree;if(e){let t=e.get_at(this.cursor_path),s=t.after_fen,l=t.uci;return[s,l]}}get is_revealed(){return this.hidden_paths.length===0}add_uci(e){let t=this.tree,s=this.cursor_path;t?t.append_uci(e,s):t=de.make(this.initial_fen,[e]),s=[...s,e],te(()=>{this.tree=t,this.cursor_path=s})}};o(R,"make",(e,t=(e==null?void 0:e.root.data.before_fen)||_e)=>new R(t,e));let L=R;const ge=a=>{let e;return j(()=>{let t=a.lala.cursor_path,s=e.parentElement;if(!s)return;const l=e.querySelector(".on_path_end");if(!l){s.scrollTop=t.length>0?99999:0;return}let c=l.offsetTop-s.offsetHeight/2+l.offsetHeight;s.scrollTo({behavior:"smooth",top:c})}),(()=>{var t=ce();return X(s=>e=s,t),i(t,_(b,{get when(){return a.lala.tree},get fallback(){return[]},children:s=>_(D,{on_set_path:l=>a.lala.try_set_cursor_path(l),get cursor_path(){return a.lala.cursor_path},get hidden_paths(){return a.lala.hidden_paths},get revealed_paths(){return a.lala.revealed_paths},get solved_paths(){return a.lala.solved_paths},get failed_paths(){return a.lala.failed_paths},get lines(){return[s().root]}})})),t})()},D=a=>_(P,{get each(){return a.lines},children:e=>[_(ve,W({get data(){return e.data}},a)),_(Z,{get children(){return[_(G,{get when(){return e.children.length===1},get children(){return _(D,W(a,{get lines(){return e.children}}))}}),_(G,{get when(){return e.children.length>1},get children(){var t=oe();return i(t,_(P,{get each(){return e.children},children:s=>(()=>{var l=ue();return i(l,_(D,W(a,{lines:[s],show_index:!0}))),l})()})),t}})]}})]}),ve=a=>{let e=`${Math.ceil(a.data.ply/2)}.`;a.data.ply%2===0&&(e+="..");let t=()=>a.cursor_path.join("").startsWith(a.data.path.join("")),s=()=>a.cursor_path.join("")===a.data.path.join(""),l=a.data.path.join(""),c=()=>a.hidden_paths.find(h=>h.join("")===l),d=()=>a.hidden_paths.find(h=>l.startsWith(h.join(""))),S=()=>a.revealed_paths.find(h=>h.join("")===l),v=()=>a.revealed_paths.find(h=>l.startsWith(h.join(""))),m=()=>a.failed_paths.find(h=>h.join("")===l),N=()=>a.solved_paths.find(h=>h.join("")===l),T=()=>["move",s()?"on_path_end":t()?"on_path":"",c()?"on_hidden_path_start":d()?"on_hidden_path":"",S()?"on_revealed_path_start":v()?"on_revealed_path":"",m()?"on_failed_path":"",N()?"on_solved_path":""].join(" ");return(()=>{var h=fe();return h.$$click=()=>a.on_set_path(a.data.path),i(h,_(b,{get when(){return a.show_index||a.data.ply&1},get children(){var r=pe();return i(r,e),r}}),null),i(h,()=>a.data.san,null),z(()=>ee(h,T())),h})()};V(["click"]);var me=u("<div class=progress><div class=bar></div><h3>"),$e=u("<div class=list-wrap><h1 class=header>Tactics</h1><div class=list><div><h3 class=title></h3><span>Total Runs</span><p>Highscore: <!> </p></div><div><p>Current Run</p><p>Score: "),we=u("<div class=repertoire>"),be=u("<div class=board-wrap>"),Se=u("<h3>Puzzle solved. <span> Score +"),xe=u("<h3> Current Run Finished "),Ce=u("<button>New Run"),ke=u("<div class=replay-wrap><div class=replay-header><div class=title><h5></h5><h4></h4></div><h3 class=lichess><a target=_blank>lichess</a></h3></div><div class=replay><div class=replay-v></div><div class=tools>"),ye=u("<h3>Find the best line!"),je=u("<button>View Solution"),Me=u("<button>Next Puzzle");const E=class E{constructor(e){o(this,"_scores");o(this,"_current_run");this.id=e,this._scores=g([],{equals:!1}),this._current_run=[g(0),g(0)]}get current_score(){return this._current_run[0][0]()??0}get i_selected_chapter(){return this._current_run[1][0]()??0}set current_score(e){this._current_run[0][1](e)}set i_selected_chapter(e){this._current_run[1][1](e)}get scores(){return this._scores[0]()}new_current_run(){this.current_score=0,this.i_selected_chapter=0}add_current_run(){let e=this._scores[0]();e.push(this.current_score),e=e.slice(-10),this._scores[1](e)}get highscore(){return Math.max(0,...this._scores[0]())}};o(E,"make",e=>new E(e));let H=E;const q=class q{constructor(e,t){o(this,"attempt");this.puzzle=e,this.solution=t,this.attempt=L.make(t)}};o(q,"make",(e,t)=>new q(e,t));let O=q;const U=a=>(()=>{var e=me(),t=e.firstChild,s=t.nextSibling;return i(s,()=>`${a.width}/${a.nb}`),z(l=>ne(t,`width: ${a.width/a.nb*100}%`,l)),e})(),Fe=()=>{let e=re().id,t=H.make(e);const[s]=ae(e,le.read_study),l=Q(()=>{var r;return(r=s())==null?void 0:r.chapters[t.i_selected_chapter]});let c=new ie,d=Q(y(l,r=>{if(r){let n=O.make(r.pgn.puzzle,r.pgn.tree);return n.attempt.cursor_path=n.attempt.tree.root.data.path,n.attempt.hidden_paths=n.attempt.tree.root.children.map(f=>f.data.path),n}}));j(y(()=>c.add_uci,r=>{var n;r&&((n=d())==null||n.attempt.try_next_uci_fail(r))})),j(y(()=>{var r;return(r=d())==null?void 0:r.attempt.fen_last_move},r=>{if(r){let[n,f]=r;c.on_set_fen_uci(n,f)}})),j(y(()=>c.on_wheel,r=>{var n;r&&((n=d())==null||n.attempt.on_wheel(r))}));const S=()=>{let r=s();return r?`${t.i_selected_chapter+1} / ${r.chapters.length}  Score: ${t.current_score}`:"--"},v=()=>{var f,$;let r=((f=d())==null?void 0:f.attempt.solved_paths.length)??0,n=(($=d())==null?void 0:$.attempt.failed_paths.length)??0;return r%2===1?r=r+1+(r-1)/2:r=r+r/2,n%2===1?n=n+1+(n-1)/2:n=n+r/2,r-n},m=()=>{t.new_current_run()},N=()=>{t.current_score=Math.max(0,t.current_score+v()),t.i_selected_chapter=t.i_selected_chapter+1};j(y(()=>{var r;return(r=d())==null?void 0:r.attempt.is_revealed},(r,n)=>{r&&!n&&t.i_selected_chapter===s().chapters.length-1&&(t.current_score=Math.max(0,t.current_score+v()),t.add_current_run())}));const T=()=>{var r;(r=d())==null||r.attempt.reveal_hidden_paths()},h=r=>{const n=r.target;n.tagName!=="PIECE"&&n.tagName!=="SQUARE"&&n.tagName!=="CG-BOARD"||(r.preventDefault(),c.set_on_wheel(Math.sign(r.deltaY)))};return(()=>{var r=we();return r.addEventListener("wheel",h),i(r,_(b,{get when(){return!s.loading},fallback:"Loading...",get children(){var n=$e(),f=n.firstChild,$=f.nextSibling,w=$.firstChild,x=w.firstChild,A=x.nextSibling,C=A.nextSibling,F=C.firstChild,M=F.nextSibling;M.nextSibling;var k=w.nextSibling,I=k.firstChild,p=I.nextSibling;return p.firstChild,i(x,()=>s().name),i(w,_(U,{get width(){return t.scores.length},nb:10}),C),i(C,()=>t.highscore,M),i(k,_(U,{get width(){return t.i_selected_chapter+1},get nb(){return s().chapters.length}}),p),i(p,()=>t.current_score,null),n}}),null),i(r,_(b,{get when(){return d()},children:n=>[(()=>{var f=be();return i(f,_(he,{get movable(){return!n().attempt.is_revealed},get doPromotion(){return c.promotion},get onMoveAfter(){return c.on_move_after},get fen_uci(){return c.fen_uci},get color(){return c.turnColor},get dests(){return c.dests}})),f})(),(()=>{var f=ke(),$=f.firstChild,w=$.firstChild,x=w.firstChild,A=x.nextSibling,C=w.nextSibling,F=C.firstChild,M=$.nextSibling,k=M.firstChild,I=k.nextSibling;return i(x,()=>s().name),i(A,S),i(k,_(ge,{get lala(){return n().attempt}})),i(I,_(b,{get when(){return n().attempt.is_revealed},get fallback(){return[ye(),(()=>{var p=je();return p.$$click=T,p})()]},get children(){return[(()=>{var p=Se(),Y=p.firstChild,B=Y.nextSibling;return B.firstChild,i(B,v,null),p})(),_(b,{get when(){return t.i_selected_chapter===s().chapters.length-1},get fallback(){return(()=>{var p=Me();return p.$$click=N,p})()},get children(){return[xe(),(()=>{var p=Ce();return p.$$click=m,p})()]}})]}})),z(()=>se(F,"href",`https://lichess.org/training/${n().puzzle}`)),f})()]}),null),r})()};V(["click"]);export{Fe as default};
