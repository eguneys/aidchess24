import{_ as X,H as D,c as b,g as v,J as Y,a as M,m as I,K as G,L as j,N as A,O as F,Q as J,T as Z,x as W,r as ee,n as $,b as te,t as E,I as B,U as ne,V as re,d as O,C as L,i as x,S as N,j as se,k as ae,F as le,W as oe,X as ie,Y as ce,D as z,o as ue,B as de,Z as _e,$ as fe,q as U,u as pe}from"./index-Dq-dqWGa.js";import{C as me}from"./chessground-doaUGlzw.js";import{s as he}from"./scroll-DnAhRpRC.js";async function ge(e){const d=await ye(e);function n(i){return d.transaction(e.store,i).objectStore(e.store)}function s(i){return new Promise((t,_)=>{const r=i();r.onsuccess=f=>t(f.target.result),r.onerror=f=>_(f.target.result)})}return{list:()=>s(()=>n("readonly").getAllKeys()),get:i=>s(()=>n("readonly").get(i)),getMany:i=>s(()=>n("readonly").getAll(i)),put:(i,t)=>s(()=>n("readwrite").put(t,i)),count:i=>s(()=>n("readonly").count(i)),remove:i=>s(()=>n("readwrite").delete(i)),clear:()=>s(()=>n("readwrite").clear()),cursor:(i,t)=>s(()=>n("readonly").openCursor(i,t)).then(_=>_??void 0),txn:i=>d.transaction(e.store,i)}}async function ye(e){const d=e?.db||`${e.store}--db`;return new Promise((n,s)=>{const i=window.indexedDB.open(d,e?.version??1);i.onsuccess=t=>n(t.target.result),i.onerror=t=>s(t.target.error??"IndexedDB Unavailable"),i.onupgradeneeded=t=>{const _=t.target.result,r=t.target.transaction,f=_.objectStoreNames.contains(e.store)?r.objectStore(e.store):_.createObjectStore(e.store);e.upgrade?.(t,f)}})}async function ve(e){let d;await we({on_received:t,on_status(o){o&&(o.download&&e.on_downloaded_nb(o.download),o.error&&e.on_engine_failed(o.error))},on_connected(o){d=o}}),n("uci");function n(o){d?.(o)}function s(o){f=o,h(),g()}function i(){return!!r&&!r.stop_requested}function t(o){const c=o.trim().split(/\s+/g);if(c[0]==="uciok")n("ucinewgame"),n("isready");else if(c[0]==="readyok")g();else if(!(c[0]==="id"&&c[1]==="name"))if(c[0]==="bestmove"){r&&p&&r.emit(p),r=void 0,g();return}else if(r&&!r.stop_requested&&c[0]==="info"){let y=0,S,m=1,k,P,C=!1,q,T=[];for(let w=1;w<c.length;w++)switch(c[w]){case"depth":y=parseInt(c[++w]);break;case"nodes":S=parseInt(c[++w]);break;case"multipv":m=parseInt(c[++w]);break;case"time":k=parseInt(c[++w]);break;case"score":C=c[++w]==="mate",q=parseInt(c[++w]),(c[w+1]==="lowerbound"||c[w+1]==="upperbound")&&(P=c[++w]);break;case"pv":T=c.slice(++w),w=c.length;break}if(C&&!q||(_<m&&(_=m),!D(S)||!D(k)||!D(C)||!D(q)))return;const R=r.ply%2===1?-q:q;if(P&&m===1)return;const V={moves:T,cp:C?void 0:R,mate:C?R:void 0,depth:y};m===1?p={fen:r.current_fen,depth:y,nodes:S,millis:k,cp:C?void 0:R,mate:C?R:void 0,pvs:[V]}:p&&(p.pvs.push(V),p.depth=Math.min(p.depth,y)),m===_&&p&&(r.emit(p),y>=40&&h())}else o&&!["Stockfish","id","option","info"].includes(c[0])&&console.warn(`SF: ${o}`)}let _=0,r,f,p;function g(){if(!r&&(r=f,f=void 0,r)){p=void 0,_=1,u("Threads",r.threads),u("Hash",r.hash_size||16),u("MultiPV",Math.max(1,r.multi_pv)),l&&l!==r.game_id&&n("ucinewgame"),l=r.game_id,n(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[o,c]=Object.entries(r.search)[0];n(`go ${o} ${c}`)}}let a=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function u(o,c){c=c.toString(),a.get(o)!==c&&(n(`setoption name ${o} value ${c}`),a.set(o,c))}function h(){r&&!r.stop_requested&&(r.stop_requested=!0,n("stop"))}let l;return{start(o){s(o)},stop(){s()},destroy(){n("quit")},get state(){return i()?"computing":"idle"}}}async function we(e){const d=a=>{e.on_status(a)},n=a=>{e.on_received(a)},s=a=>{e.on_connected(a)};let i=await X(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),t=await new Promise((a,u)=>{i.default({wasmMemory:be(2560),onError:h=>u(new Error(h)),locateFile:h=>`stockfish/${h}`}).then(a).catch(u)}),_=await ge({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let a=0;;a++){let u=t.getRecommendedNnue(a);if(!u||r.includes(u))break;r.push(u)}(await p(r)).forEach((a,u)=>t.setNnueBuffer(a,u)),t.onError=g(),t.listen=a=>n(a),s(a=>t.uci(a));async function p(a){return Promise.all(a.map(async u=>{let h=await _?.get(u).catch(()=>{});if(h&&h.byteLength>128*1024)return h;const l=new XMLHttpRequest;l.open("get",`stockfish/nnue/${u}`,!0),l.responseType="arraybuffer",l.onprogress=c=>d({download:{bytes:c.loaded,total:c.total}});const o=await new Promise((c,y)=>{l.onerror=()=>y(new Error(`fetch '${u}' failed: ${l.status}`)),l.onload=()=>{l.status/100===2?c(new Uint8Array(l.response)):y(new Error(`fetch '${u}' failed: ${l.status}`))},l.send()});return d(),_?.put(u,o).catch(()=>console.warn("IDB store failed")),o}))}function g(){return a=>{if(a.startsWith("BAD_NNUE")&&_){const u=Math.max(0,Number(a.slice(9))),h=t.getRecommendedNnue(u);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${h} from IDB`),_.remove(h)},2e3)}else d({error:a})}}}const be=(e,d=32767)=>{let n=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:d})}catch(s){if(d<=e||!(s instanceof RangeError))throw s;d=Math.max(e,Math.ceil(d-d/n)),n=n===4?3:4}},K=Y();function ke(e){let d=async function(){let[n,s]=M(void 0),[i,t]=M(void 0),[_]=I(()=>ve({on_downloaded_nb(r){s(r)},on_engine_failed(r){t(r)}}));return{get download_nb(){return n()},get engine_failed(){return i()},get state(){let r=_();return _.loading||!r?"loading":r.state},async get_best_move(r,f,p,g,a){let u=c=>{},h=_();if(!h)return;let l=Math.max(1,navigator.hardwareConcurrency-2);return h.start({threads:l,hash_size:16,game_id:r,stop_requested:!1,path:[],search:{depth:a},multi_pv:g,ply:p,threatMode:!1,initial_fen:f,current_fen:f,moves:[],emit:G(200,function(c){c.depth===a&&u(c)})}),new Promise(c=>{u=c})}}};return b(K.Provider,{get value(){return d()},get children(){return v(()=>e.children)}})}var $e=E('<div class="is2d chessboard">');function Se(){let[e,d]=M(j.fromSetup(A(B).unwrap()).unwrap(),{equals:!1}),[n,s]=M(void 0),[i,t]=M(void 0),_=v(()=>F(e().toSetup())),r=v(()=>e().turn),f=v(()=>J(e()));const p=g=>{let a=e(),u=ne(g),h=re(a,u);a.play(u),W(()=>{s([g,h]),t([g,h]),d(a),g.length})};return{play_orig_key(g,a){let u=e(),h=r(),l=u.board.get(Z(g)),o=g+a;l.role==="pawn"&&(a[1]==="8"&&h==="white"||a[1]==="1"&&h==="black")&&(o+="q"),p(o)},play_uci:p,set_fen_last_move(g,a){W(()=>{d(j.fromSetup(A(g).unwrap()).unwrap()),s(a)})},get dests(){return f()},get fen_last_move(){let g=_(),a=n();return a?[g,a]:void 0},get fen(){return _()},get last_move(){return n()},get add_last_move(){return i()},get check(){return e().isCheck()},get isEnd(){return e().isEnd()}}}function Ce(e){let d,n;return ee(()=>{let s=e.color,i=e.play_uci.dests,t={fen:e.play_uci.fen,check:e.play_uci.check,premovable:{enabled:!1},movable:{color:s,free:!1,dests:i,events:{after:e.play_uci.play_orig_key}}};n=me(d,t)}),$(()=>{let s,i;if(!e.play_uci.fen_last_move)s=B;else{let r;[s,[i,r]]=e.play_uci.fen_last_move}let t=[];i&&(t.push(i.slice(0,2)),t.push(i.slice(2,4)));let _=e.movable?e.color:void 0;n.set({fen:s,lastMove:t,turnColor:e.color,movable:{color:_,dests:e.play_uci.dests}})}),$(()=>{let s=e.orientation??"white";n.set({orientation:s})}),$(()=>{let s=e.play_uci.check;n.set({check:s})}),$(()=>{e.shapes?n.setAutoShapes(e.shapes):n.setAutoShapes([])}),(()=>{var s=$e();return te(i=>d=i,s),s})()}var xe=E("<div class=replay-single><div class=moves>"),Me=E("<span class=index>"),Ee=E("<span><span class=san>"),Pe=E("<span class=judgement>"),Ne=E("<span class=eval>"),qe=E("<span class=loading>l");const Ue=e=>j.fromSetup(A(e).unwrap()).unwrap().isEnd();function je(e,d,n,s){let i=oe(d,n),t=ie(i),_=F(d.toSetup());d.play(i);let r=F(d.toSetup());return{path:`${s} ${t}`,ply:e,before_fen:_,fen:r,uci:t,san:n}}function Q(e,d,n){let s=d[d.length-1];return n||(n=j.fromSetup(A(s?.fen??B).unwrap()).unwrap()),[...d,je((s?.ply??0)+1,n,e,s?.path??"")]}function H(e,d=B){let n=[],s=j.fromSetup(A(d).unwrap()).unwrap();for(let i of e)n=Q(i,n,s);return n}function Ae(e,d){let[n,s]=M("level10"),i=Le({s:e,game_id:d,get skill(){return n()}}),[t,_]=M([]);const r=v(()=>{let m=t();return m[m.length-1]});let[f,p]=M(r()?.ply??0);const g=v(()=>{let m=f();return t().find(P=>P.ply===m)});let a=v(L(t,m=>m.san)),u=v(L(t,m=>m.ply)),h=v(()=>{let m=a(),k=u();return m.map((P,C)=>`${k[C]} ${P}`)});const l=m=>{p(m)},o=()=>{let m=f()-1;return u().find(k=>k===m)},c=()=>{let m=f()+1;return u().find(k=>k===m)},y=v(L(t,m=>i.res_with_search(m))),S=v(()=>{let m=y();return m[m.length-1]});return{set_skill:s,set_sans(m){_(H(m)),p(m.length)},get sf_steps(){return y()},get last_sf_step(){return S()},get steps(){return t()},get plies(){return u()},get sans(){return a()},get ply_sans(){return h()},get ply_step(){return g()},get last_step(){return r()},goto_ply:l,get_prev_ply:o,get_next_ply:c,goto_prev_ply_if_can(){let m=o();m!==void 0&&l(m),f()===1&&p(0)},goto_next_ply_if_can(){let m=c();m!==void 0&&l(m)},play_san(m){let k=r();if(!k){_(H([m]));return}let P=t();_(Q(m,P)),p(k.ply+1)},get is_on_last_ply(){return f()===(r()?.ply??0)}}}function Be(e){const d=v(L(()=>e.play_replay.ply_sans,t=>{let[_,r]=t.split(" ");return{ply:parseInt(_),san:r}})),n=t=>{e.play_replay.goto_ply(t)},s=v(()=>e.play_replay.ply_step?.ply),i=t=>{let _=e.play_replay.sf_steps[t];return _?_.state==="loading"||!_.search?" loading":_.search.judgement:"no-eval"};return(()=>{var t=xe(),_=t.firstChild;return x(_,b(le,{get each(){return d()},children:(r,f)=>[b(N,{get when(){return r.ply%2===1},get children(){var p=Me();return x(p,()=>Math.ceil(r.ply/2)),p}}),(()=>{var p=Ee(),g=p.firstChild;return p.$$click=()=>n(r.ply),x(g,()=>r.san),x(p,b(N,{get when(){return e.play_replay.sf_steps[f()]},children:a=>b(N,{get when(){return a().state==="loading"},get fallback(){return b(N,{get when(){return a().search},children:u=>[b(N,{get when(){return u().before_search.search.eval.cp},children:h=>(()=>{var l=Ne();return x(l,()=>Fe(h())),l})()}),(()=>{var h=Pe();return x(h,()=>De(u().judgement)),h})()]})},get children(){return qe()}})}),null),se(()=>ae(p,"move "+i(f())+(r.ply===s()?" active":""))),p})()]})),t})()}const Re=(e,d)=>ce(z(e.fen),e.search.eval,d.search.eval),De=e=>e==="good"?"âœ“":e==="inaccuracy"?"?!":e==="mistake"?"?":"??";function Le(e){let d=[];const n=(f,p,g,a,u)=>new Promise(h=>{d.push({fen:f,ply:p,game_id:g,multi_pv:a,depth:u,resolve_ev:h}),i()});let s;const i=async()=>{if(s||(s=d.pop(),!s))return;let{game_id:f,fen:p,ply:g,multi_pv:a,depth:u}=s,h=await e.s.get_best_move(f,p,g,a,u);s.resolve_ev(h),s=void 0,i()};let t={};const _=async(f,p,g,a,u)=>{let l=(o=>[f,p,a,o].join("$$"))(u);if(!t[l]){let o=Math.floor(Math.random()*3),c=await n(f,p,g,a,u+o);c&&(t[l]=c)}return t[l]};return{res_with_search:f=>{if(Ue(f.fen))return;let[p]=I(()=>e.skill,async g=>{let a=f.ply<10?6:f.ply<15?3:1,u=g==="level10"?10:g==="level16"?16:20,[h,l]=await Promise.all([_(f.before_fen,f.ply-1,e.game_id,a,u),_(f.fen,f.ply,e.game_id,a,u)]),o={fen:f.before_fen,search:{depth:u,multi_pv:a,eval:h}},c={fen:f.fen,search:{depth:u,multi_pv:a,eval:l}},y=Re(o,c),S=y<.03?"good":y<.05?"inaccuracy":y<.12?"mistake":"blunder";return{...f,before_search:o,search:c,judgement:S}});return{get state(){return p.loading?"loading":"success"},get search(){return p()}}}}}function Fe(e){return e=Math.max(Math.min(Math.round(e/10)/10,99),-99),(e>0?"+":"")+e.toFixed(1)}O(["click"]);var Ie=E("<span class=info>Loading <!>%"),Te=E("<div class=builder><div class=board-wrap></div><div class=replay-wrap><div class=tools-wrap><button class=rematch>Rematch");const Qe=()=>b(ke,{get children(){return b(Ve,{})}});function Ve(){let[e]=I(()=>pe(K));const d=v(()=>{let n=e()?.download_nb;if(n)return Math.ceil(n.bytes/(n.total===0?70*1024*1024:n.total)*100)});return b(N,{get when(){return e()},children:n=>b(N,{get when(){return n().state==="loading"},get fallback(){return b(We,{get s(){return n()}})},get children(){return[(()=>{var s=Ie(),i=s.firstChild,t=i.nextSibling;return t.nextSibling,x(s,()=>d()??"--",t),s})()," "]}})})}function We(e){const d=ue();d.setVolume(.2);let[n,s]=de([],"builder.current.sans");const t=Ae(e.s,"");let _=Se();const[r,f]=M("white"),p=v(()=>_e(r()));$(()=>{const l=t.last_sf_step;l&&$(U(()=>l.search,o=>{if(!o)return;if(z(o.fen)===p()){let y=o.search.search.eval.pvs;_.play_uci(y[0].moves[0])}}))}),$(U(()=>_.add_last_move,l=>{l&&t.play_san(l[1])})),$(U(()=>t.sans,s)),$(U(()=>t.ply_step,l=>{l?_.set_fen_last_move(l.fen,[l.uci,l.san]):_.set_fen_last_move(B)})),$(U(()=>t.ply_step,(l,o)=>{l&&(!o||o.ply===l.ply-1)&&d.move(l)}));const g=he(l=>{const o=l.target;o.tagName!=="PIECE"&&o.tagName!=="SQUARE"&&o.tagName!=="CG-BOARD"||(l.preventDefault(),a(Math.sign(l.deltaY)))}),a=l=>{l>0?t.goto_next_ply_if_can():t.goto_prev_ply_if_can()},u=()=>!_.isEnd&&t.is_on_last_ply;t.set_sans(n());const h=()=>{s([]),t.set_sans(n())};return(()=>{var l=Te(),o=l.firstChild,c=o.nextSibling,y=c.firstChild,S=y.firstChild;return fe(l,"wheel",g),x(o,b(Ce,{get color(){return r()},get movable(){return u()},play_uci:_})),x(c,b(Be,{play_replay:t}),y),S.$$click=h,l})()}O(["click"]);export{Qe as default};
