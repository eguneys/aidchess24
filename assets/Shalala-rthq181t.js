var Rn=Object.defineProperty;var xn=(e,t,n)=>t in e?Rn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var z=(e,t,n)=>(xn(e,typeof t!="symbol"?t+"":t,n),n);import{o as Sn,l as Qe,n as On,t as se,d as Nn,k as je,i as V,c as $,e as $n,M as Pt,F as Et,S as Dn,f as Tn,g as Bn,b as ze}from"./index-XE0ADuzN.js";import{p as Kn}from"./pgn-5WTPUHXP.js";const Re=["a","b","c","d","e","f","g","h"],Ht=["1","2","3","4","5","6","7","8"],re=["white","black"],F=["pawn","knight","bishop","rook","queen","king"],Ln=["a","h"],ve=e=>"role"in e,f=e=>e!==void 0,_=e=>e==="white"?"black":"white",ie=e=>e>>3,R=e=>e&7,qe=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,te=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function fe(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ne(e){if(e.length===2)return qe(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const G=e=>Re[R(e)]+Ht[ie(e)],Qt=e=>{if(e[1]==="@"&&e.length===4){const t=fe(e[0]),n=ne(e.slice(2));if(t&&f(n))return{role:t,to:n}}else if(e.length===4||e.length===5){const t=ne(e.slice(0,2)),n=ne(e.slice(2,4));let r;if(e.length===5&&(r=fe(e[4]),!r))return;if(f(t)&&f(n))return{from:t,to:n,promotion:r}}},_t=e=>ve(e)?`${te(e.role).toUpperCase()}@${G(e.to)}`:G(e.from)+G(e.to)+(e.promotion?te(e.promotion):""),ct=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,at=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61;class jt{unwrap(t,n){const r=this._chain(i=>g.ok(t?t(i):i),i=>n?g.ok(n(i)):g.err(i));if(r.isErr)throw r.error;return r.value}map(t,n){return this._chain(r=>g.ok(t(r)),r=>g.err(n?n(r):r))}chain(t,n){return this._chain(t,n||(r=>g.err(r)))}}class zn extends jt{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,n){return t(this.value)}}class In extends jt{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,n){return n(this.error)}}var g;(function(e){e.ok=function(t){return new zn(t)},e.err=function(t){return new In(t||new Error)},e.all=function(t){if(Array.isArray(t)){const i=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;i.push(s.value)}return e.ok(i)}const n={},r=Object.keys(t);for(let i=0;i<r.length;i++){const o=t[r[i]];if(o.isErr)return o;n[r[i]]=o.value}return e.ok(n)}})(g||(g={}));const Mt=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Ue=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),At=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,Ue(e));class a{constructor(t,n){this.lo=t|0,this.hi=n|0}static fromSquare(t){return t>=32?new a(0,1<<t-32):new a(1<<t,0)}static fromRank(t){return new a(255,0).shl64(8*t)}static fromFile(t){return new a(16843009<<t,16843009<<t)}static empty(){return new a(0,0)}static full(){return new a(4294967295,4294967295)}static corners(){return new a(129,2164260864)}static center(){return new a(402653184,24)}static backranks(){return new a(255,4278190080)}static backrank(t){return t==="white"?new a(255,0):new a(0,4278190080)}static lightSquares(){return new a(1437226410,1437226410)}static darkSquares(){return new a(2857740885,2857740885)}complement(){return new a(~this.lo,~this.hi)}xor(t){return new a(this.lo^t.lo,this.hi^t.hi)}union(t){return new a(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new a(this.lo&t.lo,this.hi&t.hi)}diff(t){return new a(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?a.empty():t>=32?new a(this.hi>>>t-32,0):t>0?new a(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?a.empty():t>=32?new a(0,this.lo<<t-32):t>0?new a(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new a(Ue(this.hi),Ue(this.lo))}rbit64(){return new a(At(this.hi),At(this.lo))}minus64(t){const n=this.lo-t.lo,r=(n&t.lo&1)+(t.lo>>>1)+(n>>>1)>>>31;return new a(n,this.hi-(t.hi+r))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Mt(this.lo)+Mt(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,n){return n?this.with(t):this.without(t)}with(t){return t>=32?new a(this.lo,this.hi|1<<t-32):new a(this.lo|1<<t,this.hi)}without(t){return t>=32?new a(this.lo,this.hi&~(1<<t-32)):new a(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new a(this.lo,this.hi^1<<t-32):new a(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new a(this.lo&this.lo-1,this.hi):new a(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,n=this.hi;for(;t!==0;){const r=31-Math.clz32(t&-t);t^=1<<r,yield r}for(;n!==0;){const r=31-Math.clz32(n&-n);n^=1<<r,yield 32+r}}*reversed(){let t=this.lo,n=this.hi;for(;n!==0;){const r=31-Math.clz32(n);n^=1<<r,yield 32+r}for(;t!==0;){const r=31-Math.clz32(t);t^=1<<r,yield r}}}class pe{constructor(){}static default(){const t=new pe;return t.reset(),t}reset(){this.occupied=new a(65535,4294901760),this.promoted=a.empty(),this.white=new a(65535,0),this.black=new a(0,4294901760),this.pawn=new a(65280,16711680),this.knight=new a(66,1107296256),this.bishop=new a(36,603979776),this.rook=new a(129,2164260864),this.queen=new a(8,134217728),this.king=new a(16,268435456)}static empty(){const t=new pe;return t.clear(),t}clear(){this.occupied=a.empty(),this.promoted=a.empty();for(const t of re)this[t]=a.empty();for(const t of F)this[t]=a.empty()}clone(){const t=new pe;t.occupied=this.occupied,t.promoted=this.promoted;for(const n of re)t[n]=this[n];for(const n of F)t[n]=this[n];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const n of F)if(this[n].has(t))return n}get(t){const n=this.getColor(t);if(!n)return;const r=this.getRole(t),i=this.promoted.has(t);return{color:n,role:r,promoted:i}}take(t){const n=this.get(t);return n&&(this.occupied=this.occupied.without(t),this[n.color]=this[n.color].without(t),this[n.role]=this[n.role].without(t),n.promoted&&(this.promoted=this.promoted.without(t))),n}set(t,n){const r=this.take(t);return this.occupied=this.occupied.with(t),this[n.color]=this[n.color].with(t),this[n.role]=this[n.role].with(t),n.promoted&&(this.promoted=this.promoted.with(t)),r}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,n){return this[t].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class H{constructor(){}static empty(){const t=new H;for(const n of F)t[n]=0;return t}static fromBoard(t,n){const r=new H;for(const i of F)r[i]=t.pieces(n,i).size();return r}clone(){const t=new H;for(const n of F)t[n]=this[n];return t}equals(t){return F.every(n=>this[n]===t[n])}add(t){const n=new H;for(const r of F)n[r]=this[r]+t[r];return n}nonEmpty(){return F.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class he{constructor(t,n){this.white=t,this.black=n}static empty(){return new he(H.empty(),H.empty())}static fromBoard(t){return new he(H.fromBoard(t,"white"),H.fromBoard(t,"black"))}clone(){return new he(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new he(this.white.add(t.white),this.black.add(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class ye{constructor(t,n){this.white=t,this.black=n}static default(){return new ye(3,3)}clone(){return new ye(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}const Fn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Wn=Fn+" w KQkq -",qt=Wn+" 0 1";var C;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(C||(C={}));class M extends Error{}const Hn=(e,t,n)=>{let r=e.indexOf(t);for(;n-- >0&&r!==-1;)r=e.indexOf(t,r+t.length);return r},ue=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,Ut=e=>{const t=fe(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},Ie=e=>{const t=pe.empty();let n=7,r=0;for(let i=0;i<e.length;i++){const o=e[i];if(o==="/"&&r===8)r=0,n--;else{const s=parseInt(o,10);if(s>0)r+=s;else{if(r>=8||n<0)return g.err(new M(C.Board));const c=r+n*8,h=Ut(o);if(!h)return g.err(new M(C.Board));e[i+1]==="~"&&(h.promoted=!0,i++),t.set(c,h),r++}}}return n!==0||r!==8?g.err(new M(C.Board)):g.ok(t)},Rt=e=>{if(e.length>64)return g.err(new M(C.Pockets));const t=he.empty();for(const n of e){const r=Ut(n);if(!r)return g.err(new M(C.Pockets));t[r.color][r.role]++}return g.ok(t)},Qn=(e,t)=>{let n=a.empty();if(t==="-")return g.ok(n);for(const r of t){const i=r.toLowerCase(),o=r===i?"black":"white",s=o==="white"?0:7;if("a"<=i&&i<="h")n=n.with(qe(i.charCodeAt(0)-97,s));else if(i==="k"||i==="q"){const c=e[o].intersect(a.backrank(o)).intersect(e.rook.union(e.king)),h=i==="k"?c.last():c.first();n=n.with(f(h)&&e.rook.has(h)?h:qe(i==="k"?7:0,s))}else return g.err(new M(C.Castling))}return re.some(r=>a.backrank(r).intersect(n).size()>2)?g.err(new M(C.Castling)):g.ok(n)},xt=e=>{const t=e.split("+");if(t.length===3&&t[0]===""){const n=ue(t[1]),r=ue(t[2]);return!f(n)||n>3||!f(r)||r>3?g.err(new M(C.RemainingChecks)):g.ok(new ye(3-n,3-r))}else if(t.length===2){const n=ue(t[0]),r=ue(t[1]);return!f(n)||n>3||!f(r)||r>3?g.err(new M(C.RemainingChecks)):g.ok(new ye(n,r))}else return g.err(new M(C.RemainingChecks))},lt=e=>{const t=e.split(/[\s_]+/),n=t.shift();let r,i=g.ok(void 0);if(n.endsWith("]")){const c=n.indexOf("[");if(c===-1)return g.err(new M(C.Fen));r=Ie(n.slice(0,c)),i=Rt(n.slice(c+1,-1))}else{const c=Hn(n,"/",7);c===-1?r=Ie(n):(r=Ie(n.slice(0,c)),i=Rt(n.slice(c+1)))}let o;const s=t.shift();if(!f(s)||s==="w")o="white";else if(s==="b")o="black";else return g.err(new M(C.Turn));return r.chain(c=>{const h=t.shift(),l=f(h)?Qn(c,h):g.ok(a.empty()),d=t.shift();let u;if(f(d)&&d!=="-"&&(u=ne(d),!f(u)))return g.err(new M(C.EpSquare));let w=t.shift(),m;f(w)&&w.includes("+")&&(m=xt(w),w=t.shift());const b=f(w)?ue(w):0;if(!f(b))return g.err(new M(C.Halfmoves));const p=t.shift(),A=f(p)?ue(p):1;if(!f(A))return g.err(new M(C.Fullmoves));const E=t.shift();let y=g.ok(void 0);if(f(E)){if(f(m))return g.err(new M(C.RemainingChecks));y=xt(E)}else f(m)&&(y=m);return t.length>0?g.err(new M(C.Fen)):i.chain(B=>l.chain(j=>y.map(S=>({board:c,pockets:B,turn:o,castlingRights:j,remainingChecks:S,epSquare:u,halfmoves:b,fullmoves:Math.max(1,A)}))))})},jn=e=>{let t=te(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},qn=e=>{let t="",n=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const o=i+r*8,s=e.get(o);s?(n>0&&(t+=n,n=0),t+=jn(s)):n++,i===7&&(n>0&&(t+=n,n=0),r!==0&&(t+="/"))}return t},St=e=>F.map(t=>te(t).repeat(e[t])).join(""),Un=e=>St(e.white).toUpperCase()+St(e.black),Vn=(e,t)=>{let n="";for(const r of re){const i=a.backrank(r);let o=e.kingOf(r);f(o)&&!i.has(o)&&(o=void 0);const s=e.pieces(r,"rook").intersect(i);for(const c of t.intersect(i).reversed())if(c===s.first()&&f(o)&&c<o)n+=r==="white"?"Q":"q";else if(c===s.last()&&f(o)&&o<c)n+=r==="white"?"K":"k";else{const h=Re[R(c)];n+=r==="white"?h.toUpperCase():h}}return n||"-"},Gn=e=>`${e.white}+${e.black}`,Vt=(e,t)=>[qn(e.board)+(e.pockets?`[${Un(e.pockets)}]`:""),e.turn[0],Vn(e.board,e.castlingRights),f(e.epSquare)?G(e.epSquare):"-",...e.remainingChecks?[Gn(e.remainingChecks)]:[],...t!=null&&t.epd?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" "),xe=(e,t)=>{let n=a.empty();for(const r of t){const i=e+r;0<=i&&i<64&&Math.abs(R(e)-R(i))<=2&&(n=n.with(i))}return n},Z=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},Zn=Z(e=>xe(e,[-9,-8,-7,-1,1,7,8,9])),Xn=Z(e=>xe(e,[-17,-15,-10,-6,6,10,15,17])),Yn={white:Z(e=>xe(e,[7,9])),black:Z(e=>xe(e,[-7,-9]))},Be=e=>Zn[e],Ke=e=>Xn[e],Ee=(e,t)=>Yn[e][t],Ve=Z(e=>a.fromFile(R(e)).without(e)),Ge=Z(e=>a.fromRank(ie(e)).without(e)),Ze=Z(e=>{const t=new a(134480385,2151686160),n=8*(ie(e)-R(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),Xe=Z(e=>{const t=new a(270549120,16909320),n=8*(ie(e)+R(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),Ye=(e,t,n)=>{let r=n.intersect(t),i=r.bswap64();return r=r.minus64(e),i=i.minus64(e.bswap64()),r.xor(i.bswap64()).intersect(t)},Jn=(e,t)=>Ye(a.fromSquare(e),Ve[e],t),er=(e,t)=>{const n=Ge[e];let r=t.intersect(n),i=r.rbit64();return r=r.minus64(a.fromSquare(e)),i=i.minus64(a.fromSquare(63-e)),r.xor(i.rbit64()).intersect(n)},ge=(e,t)=>{const n=a.fromSquare(e);return Ye(n,Ze[e],t).xor(Ye(n,Xe[e],t))},me=(e,t)=>Jn(e,t).xor(er(e,t)),ht=(e,t)=>ge(e,t).xor(me(e,t)),tr=(e,t,n)=>{switch(e.role){case"pawn":return Ee(e.color,t);case"knight":return Ke(t);case"bishop":return ge(t,n);case"rook":return me(t,n);case"queen":return ht(t,n);case"king":return Be(t)}},Gt=(e,t)=>{const n=a.fromSquare(t);return Ge[e].intersects(n)?Ge[e].with(e):Xe[e].intersects(n)?Xe[e].with(e):Ze[e].intersects(n)?Ze[e].with(e):Ve[e].intersects(n)?Ve[e].with(e):a.empty()},Ce=(e,t)=>Gt(e,t).intersect(a.full().shl64(e).xor(a.full().shl64(t))).withoutFirst();var U;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(U||(U={}));class le extends Error{}const nr=(e,t,n,r)=>n[t].intersect(me(e,r).intersect(n.rooksAndQueens()).union(ge(e,r).intersect(n.bishopsAndQueens())).union(Ke(e).intersect(n.knight)).union(Be(e).intersect(n.king)).union(Ee(_(t),e).intersect(n.pawn)));class ee{constructor(){}static default(){const t=new ee;return t.castlingRights=a.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new a(14,0),h:new a(96,0)},black:{a:new a(0,234881024),h:new a(0,1610612736)}},t}static empty(){const t=new ee;return t.castlingRights=a.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:a.empty(),h:a.empty()},black:{a:a.empty(),h:a.empty()}},t}clone(){const t=new ee;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,n,r,i){const o=ct(t,n),s=at(t,n);this.castlingRights=this.castlingRights.with(i),this.rook[t][n]=i,this.path[t][n]=Ce(i,s).with(s).union(Ce(r,o).with(o)).without(r).without(i)}static fromSetup(t){const n=ee.empty(),r=t.castlingRights.intersect(t.board.rook);for(const i of re){const o=a.backrank(i),s=t.board.kingOf(i);if(!f(s)||!o.has(s))continue;const c=r.intersect(t.board[i]).intersect(o),h=c.first();f(h)&&h<s&&n.add(i,"a",s,h);const l=c.last();f(l)&&s<l&&n.add(i,"h",s,l)}return n}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const n of re)for(const r of Ln)this.rook[n][r]===t&&(this.rook[n][r]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(a.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class rr{constructor(t){this.rules=t}reset(){this.board=pe.default(),this.pockets=void 0,this.turn="white",this.castles=ee.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=a.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=ee.fromSetup(t),this.epSquare=ir(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,n,r){return nr(t,n,this.board,r)}playCaptureAt(t,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[_(n.color)][n.promoted?"pawn":n.role]++}ctx(){const t=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!f(n))return{king:n,blockers:a.empty(),checkers:a.empty(),variantEnd:t,mustCapture:!1};const r=me(n,a.empty()).intersect(this.board.rooksAndQueens()).union(ge(n,a.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[_(this.turn)]);let i=a.empty();for(const s of r){const c=Ce(n,s).intersect(this.board.occupied);c.moreThanOne()||(i=i.union(c))}const o=this.kingAttackers(n,_(this.turn),this.board.occupied);return{king:n,blockers:i,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,n;const r=new this.constructor;return r.board=this.board.clone(),r.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),r.turn=this.turn,r.castles=this.castles.clone(),r.epSquare=this.epSquare,r.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),r.halfmoves=this.halfmoves,r.fullmoves=this.fullmoves,r}validate(){if(this.board.occupied.isEmpty())return g.err(new le(U.Empty));if(this.board.king.size()!==2)return g.err(new le(U.Kings));if(!f(this.board.kingOf(this.turn)))return g.err(new le(U.Kings));const t=this.board.kingOf(_(this.turn));return f(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?g.err(new le(U.OppositeCheck)):a.backranks().intersects(this.board.pawn)?g.err(new le(U.PawnsOnBackrank)):g.ok(void 0):g.err(new le(U.Kings))}dropDests(t){return a.empty()}dests(t,n){if(n=n||this.ctx(),n.variantEnd)return a.empty();const r=this.board.get(t);if(!r||r.color!==this.turn)return a.empty();let i,o;if(r.role==="pawn"){i=Ee(this.turn,t).intersect(this.board[_(this.turn)]);const s=this.turn==="white"?8:-8,c=t+s;if(0<=c&&c<64&&!this.board.occupied.has(c)){i=i.with(c);const h=this.turn==="white"?t<16:t>=48,l=c+s;h&&!this.board.occupied.has(l)&&(i=i.with(l))}f(this.epSquare)&&sr(this,t,n)&&(o=a.fromSquare(this.epSquare))}else r.role==="bishop"?i=ge(t,this.board.occupied):r.role==="knight"?i=Ke(t):r.role==="rook"?i=me(t,this.board.occupied):r.role==="queen"?i=ht(t,this.board.occupied):i=Be(t);if(i=i.diff(this.board[this.turn]),f(n.king)){if(r.role==="king"){const s=this.board.occupied.without(t);for(const c of i)this.kingAttackers(c,_(this.turn),s).nonEmpty()&&(i=i.without(c));return i.union(Ot(this,"a",n)).union(Ot(this,"h",n))}if(n.checkers.nonEmpty()){const s=n.checkers.singleSquare();if(!f(s))return a.empty();i=i.intersect(Ce(s,n.king).with(s))}n.blockers.has(t)&&(i=i.intersect(Gt(t,n.king)))}return o&&(i=i.union(o)),i}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[_(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(a.darkSquares())||!this.board.bishop.intersects(a.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,n;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:or(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return re.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,n){if(ve(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&a.backranks().has(t.to)?!1:this.dropDests(n).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&a.backranks().has(t.to)))return!1;const r=this.dests(t.from,n);return r.has(t.to)||r.has(cr(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return f(t)&&this.kingAttackers(t,_(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const n=this.variantOutcome(t);return n||(t=t||this.ctx(),this.isCheckmate(t)?{winner:_(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const n=new Map;if(t.variantEnd)return n;for(const r of this.board[this.turn])n.set(r,this.dests(r,t));return n}play(t){const n=this.turn,r=this.epSquare,i=Zt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=_(n),ve(t))this.board.set(t.to,{role:t.role,color:n}),this.pockets&&this.pockets[n][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===r&&(s=this.board.take(t.to+(n==="white"?-8:8)));const c=t.from-t.to;Math.abs(c)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(i){const c=this.castles.rook[n][i];if(f(c)){const h=this.board.take(c);this.board.set(ct(n,i),o),h&&this.board.set(at(n,i),h)}}this.castles.discardColor(n)}if(!i){const c=this.board.set(t.to,o)||s;c&&this.playCaptureAt(t.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class ut extends rr{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}}const ir=(e,t)=>{if(!f(t))return;const n=e.turn==="white"?5:2,r=e.turn==="white"?8:-8;if(ie(t)!==n||e.board.occupied.has(t+r))return;const i=t-r;if(!(!e.board.pawn.has(i)||!e.board[_(e.turn)].has(i)))return t},or=e=>{if(!f(e.epSquare))return;const t=e.ctx(),r=e.board.pieces(e.turn,"pawn").intersect(Ee(_(e.turn),e.epSquare));for(const i of r)if(e.dests(i,t).has(e.epSquare))return e.epSquare},sr=(e,t,n)=>{if(!f(e.epSquare)||!Ee(e.turn,t).has(e.epSquare))return!1;if(!f(n.king))return!0;const r=e.turn==="white"?8:-8,i=e.epSquare-r;return e.kingAttackers(n.king,_(e.turn),e.board.occupied.toggle(t).toggle(i).with(e.epSquare)).without(i).isEmpty()},Ot=(e,t,n)=>{if(!f(n.king)||n.checkers.nonEmpty())return a.empty();const r=e.castles.rook[e.turn][t];if(!f(r)||e.castles.path[e.turn][t].intersects(e.board.occupied))return a.empty();const i=ct(e.turn,t),o=Ce(n.king,i),s=e.board.occupied.without(n.king);for(const l of o)if(e.kingAttackers(l,_(e.turn),s).nonEmpty())return a.empty();const c=at(e.turn,t),h=e.board.occupied.toggle(n.king).toggle(r).toggle(c);return e.kingAttackers(i,_(e.turn),h).nonEmpty()?a.empty():a.fromSquare(r)},Zt=(e,t)=>{if(ve(t))return;const n=t.to-t.from;if(!(Math.abs(n)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return n>0?"h":"a"},cr=(e,t)=>{const n=Zt(e,t);if(!n)return t;const r=e.castles.rook[e.turn][n];return{from:t.from,to:f(r)?r:t.to}},ar=["white","black"],dt=["a","b","c","d","e","f","g","h"],ft=["1","2","3","4","5","6","7","8"],lr=[...ft].reverse(),pt=Array.prototype.concat(...dt.map(e=>ft.map(t=>e+t))),D=e=>pt[8*e[0]+e[1]],k=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Xt=pt.map(k);function hr(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const ur=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},gt=e=>e==="white"?"black":"white",Pe=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},Je=(e,t)=>e.role===t.role&&e.color===t.color,_e=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],I=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Yt=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},mt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ce=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Jt=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},Q=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function en(e,t,n){const r=k(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const oe=(e,t)=>Math.abs(e-t),dr=e=>(t,n,r,i)=>oe(t,r)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===r:i===n-1||n>=6&&i===n-2&&t===r),tn=(e,t,n,r)=>{const i=oe(e,n),o=oe(t,r);return i===1&&o===2||i===2&&o===1},nn=(e,t,n,r)=>oe(e,n)===oe(t,r),rn=(e,t,n,r)=>e===n||t===r,on=(e,t,n,r)=>nn(e,t,n,r)||rn(e,t,n,r),fr=(e,t,n)=>(r,i,o,s)=>oe(r,o)<2&&oe(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(r===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function pr(e,t){const n=t==="white"?"1":"8",r=[];for(const[i,o]of e)i[1]===n&&o.color===t&&o.role==="rook"&&r.push(k(i)[0]);return r}function sn(e,t,n){const r=e.get(t);if(!r)return[];const i=k(t),o=r.role,s=o==="pawn"?dr(r.color):o==="knight"?tn:o==="bishop"?nn:o==="rook"?rn:o==="queen"?on:fr(r.color,pr(e,r.color),n);return Xt.filter(c=>(i[0]!==c[0]||i[1]!==c[1])&&s(i[0],i[1],c[0],c[1])).map(D)}function O(e,...t){e&&setTimeout(()=>e(...t),1)}function gr(e){e.orientation=gt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function mr(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function wr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function br(e,t,n,r){Y(e),e.premovable.current=[t,n],O(e.premovable.events.set,t,n,r)}function X(e){e.premovable.current&&(e.premovable.current=void 0,O(e.premovable.events.unset))}function kr(e,t,n){X(e),e.predroppable.current={role:t,key:n},O(e.predroppable.events.set,t,n)}function Y(e){const t=e.predroppable;t.current&&(t.current=void 0,O(t.events.unset))}function vr(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const i=k(t),o=k(n);if(i[1]!==0&&i[1]!==7||i[1]!==o[1])return!1;i[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=D([7,o[1]]):o[0]===2&&(n=D([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<o[0]?(e.pieces.set(D([6,o[1]]),r),e.pieces.set(D([5,o[1]]),s)):(e.pieces.set(D([2,o[1]]),r),e.pieces.set(D([3,o[1]]),s)),!0)}function cn(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!r)return!1;const o=i&&i.color!==r.color?i:void 0;return n===e.selected&&T(e),O(e.events.move,t,n,o),vr(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,O(e.events.change),o||!0}function wt(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return O(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,O(e.events.change),e.movable.dests=void 0,e.turnColor=gt(e.turnColor),!0}function an(e,t,n){const r=cn(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=gt(e.turnColor),e.animation.current=void 0),r}function ln(e,t,n){if(bt(e,t,n)){const r=an(e,t,n);if(r){const i=e.hold.stop();T(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(o.captured=r),O(e.movable.events.after,t,n,o),!0}}else if(Cr(e,t,n))return br(e,t,n,{ctrlKey:e.stats.ctrlKey}),T(e),!0;return T(e),!1}function hn(e,t,n,r){const i=e.pieces.get(t);i&&(yr(e,t,n)||r)?(e.pieces.delete(t),wt(e,i,n,r),O(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&Pr(e,t,n)?kr(e,i.role,n):(X(e),Y(e)),e.pieces.delete(t),T(e)}function et(e,t,n){if(O(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){T(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&ln(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(dn(e,t)||kt(e,t))&&(un(e,t),e.hold.start())}function un(e,t){e.selected=t,kt(e,t)?e.premovable.customDests||(e.premovable.dests=sn(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function T(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function dn(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const bt=(e,t,n)=>{var r,i;return t!==n&&dn(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(n)))};function yr(e,t,n){const r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function kt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Cr(e,t,n){var r,i;const o=(i=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&i!==void 0?i:sn(e.pieces,t,e.premovable.castle);return t!==n&&kt(e,t)&&o.includes(n)}function Pr(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function Er(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function _r(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let i=!1;if(bt(e,n,r)){const o=an(e,n,r);if(o){const s={premove:!0};o!==!0&&(s.captured=o),O(e.movable.events.after,n,r,s),i=!0}}return X(e),i}function Mr(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(t(n)){const i={role:n.role,color:e.movable.color};wt(e,i,n.key)&&(O(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return Y(e),r}function vt(e){X(e),Y(e),T(e)}function Nt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,vt(e)}function ae(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?D([r,i]):void 0}function Ar(e,t,n,r){const i=k(e),o=Xt.filter(l=>on(i[0],i[1],l[0],l[1])||tn(i[0],i[1],l[0],l[1])),c=o.map(l=>en(D(l),n,r)).map(l=>Pe(t,l)),[,h]=c.reduce((l,d,u)=>l[0]<d?l:[d,u],[c[0],0]);return D(o[h])}const N=e=>e.orientation==="white",fn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Rr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},xr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function pn(e){e==="start"&&(e=fn);const t=new Map;let n=7,r=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const o=t.get(D([r-1,n]));o&&(o.promoted=!0);break}default:{const o=i.charCodeAt(0);if(o<57)r+=o-48;else{const s=i.toLowerCase();t.set(D([r,n]),{role:Rr[s],color:i===s?"black":"white"}),++r}}}return t}function Sr(e){return lr.map(t=>dt.map(n=>{const r=e.get(n+t);if(r){let i=xr[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function gn(e,t){t.animation&&(yt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function mn(e,t){var n,r,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),yt(e,t),t.fen&&(e.pieces=pn(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&wr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&un(e,e.selected),gn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,c=e.movable.dests.get(s),h=e.pieces.get(s);if(!c||!h||h.role!=="king")return;e.movable.dests.set(s,c.filter(l=>!(l==="a"+o&&c.includes("c"+o))&&!(l==="h"+o&&c.includes("g"+o))))}}function yt(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&$t(e[n])&&$t(t[n])?yt(e[n],t[n]):e[n]=t[n])}function $t(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const J=(e,t)=>t.animation.enabled?$r(e,t):q(e,t);function q(e,t){const n=e(t);return t.dom.redraw(),n}const Fe=(e,t)=>({key:e,pos:k(e),piece:t}),Or=(e,t)=>t.sort((n,r)=>Pe(e.pos,n.pos)-Pe(e.pos,r.pos))[0];function Nr(e,t){const n=new Map,r=[],i=new Map,o=[],s=[],c=new Map;let h,l,d;for(const[u,w]of e)c.set(u,Fe(u,w));for(const u of pt)h=t.pieces.get(u),l=c.get(u),h?l?Je(h,l.piece)||(o.push(l),s.push(Fe(u,h))):s.push(Fe(u,h)):l&&o.push(l);for(const u of s)l=Or(u,o.filter(w=>Je(u.piece,w.piece))),l&&(d=[l.pos[0]-u.pos[0],l.pos[1]-u.pos[1]],n.set(u.key,d.concat(d)),r.push(l.key));for(const u of o)r.includes(u.key)||i.set(u.key,u.piece);return{anims:n,fadings:i}}function wn(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=Dr(r);for(const o of n.plan.anims.values())o[2]=o[0]*i,o[3]=o[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>wn(e,o))}}function $r(e,t){const n=new Map(t.pieces),r=e(t),i=Nr(n,t);if(i.anims.size||i.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},o||wn(t,performance.now())}else t.dom.redraw();return r}const Dr=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Tr=["green","red","blue","yellow"];function Br(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?T(e):vt(e);const n=ce(t),r=ae(n,N(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Ir(t),snapToValidMove:e.drawable.defaultSnapToValidMove},bn(e))}function bn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=ae(t.pos,N(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?Ar(t.orig,t.pos,N(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),bn(e)}})}function Kr(e,t){e.drawable.current&&(e.drawable.current.pos=ce(t))}function Lr(e){const t=e.drawable.current;t&&(t.mouseSq&&Fr(e.drawable,t),kn(e))}function kn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function zr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),vn(e.drawable))}function Ir(e){var t;const n=(e.shiftKey||e.ctrlKey)&&Jt(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Tr[(n?1:0)+(r?2:0)]}function Fr(e,t){const n=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(i=>!n(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),vn(e)}function vn(e){e.onChange&&e.onChange(e.shapes)}function Wr(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=ce(t),i=ae(r,N(e),n);if(!i)return;const o=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&zr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Hr(e,r)))t.preventDefault();else if(t.touches)return;const c=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&bt(e,e.selected,i)?J(u=>et(u,i),e):et(e,i);const l=e.selected===i,d=Cn(e,i);if(o&&d&&l&&Er(e,i)){e.draggable.current={orig:i,piece:o,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:d,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},d.cgDragging=!0,d.classList.add("dragging");const u=e.dom.elements.ghost;u&&(u.className=`ghost ${o.color} ${o.role}`,I(u,_e(n)(k(i),N(e))),mt(u,!0)),Ct(e)}else c&&X(e),h&&Y(e);e.dom.redraw()}function Hr(e,t){const n=N(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(const o of e.pieces.keys()){const s=en(o,n,r);if(Pe(s,t)<=i)return!0}return!1}function Qr(e,t,n,r){const i="a0";e.pieces.set(i,t),e.dom.redraw();const o=ce(n);e.draggable.current={orig:i,piece:t,origPos:o,pos:o,started:!0,element:()=>Cn(e,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},Ct(e)}function Ct(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!Je(r,n.piece))Se(e);else if(!n.started&&Pe(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const i=e.dom.bounds();I(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ae(n.pos,N(e),i))}Ct(e)})}function jr(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ce(t))}function qr(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}X(e),Y(e);const r=ce(t)||n.pos,i=ae(r,N(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?hn(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,ln(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),O(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?T(e):e.selectable.enabled||T(e),yn(e),e.draggable.current=void 0,e.dom.redraw()}function Se(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,T(e),yn(e),e.dom.redraw())}function yn(e){const t=e.dom.elements;t.ghost&&mt(t.ghost,!1)}function Cn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Ur(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Dt(e,2),setTimeout(()=>Dt(e,void 0),120)},120)}function Dt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Vr(e,t){function n(){gr(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),gn(e,r),(r.fen?J:q)(i=>mn(i,r),e)},state:e,getFen:()=>Sr(e.pieces),toggleOrientation:n,setPieces(r){J(i=>mr(i,r),e)},selectSquare(r,i){r?J(o=>et(o,r,i),e):e.selected&&(T(e),e.dom.redraw())},move(r,i){J(o=>cn(o,r,i),e)},newPiece(r,i){J(o=>wt(o,r,i),e)},playPremove(){if(e.premovable.current){if(J(_r,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const i=Mr(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){q(X,e)},cancelPredrop(){q(Y,e)},cancelMove(){q(r=>{vt(r),Se(r)},e)},stop(){q(r=>{Nt(r),Se(r)},e)},explode(r){Ur(e,r)},setAutoShapes(r){q(i=>i.drawable.autoShapes=r,e)},setShapes(r){q(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return ae(r,N(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,o){Qr(e,r,i,o)},destroy(){Nt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Gr(){return{pieces:pn(fn),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:ur()}}const Tt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Zr(){const e=P("defs"),t=x(P("filter"),{id:"cg-filter-blur"});return t.appendChild(x(P("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Xr(e,t,n){var r;const i=e.drawable,o=i.current,s=o&&o.mouseSq?o:void 0,c=new Map,h=e.dom.bounds(),l=i.autoShapes.filter(m=>!m.piece);for(const m of i.shapes.concat(l).concat(s?[s]:[])){if(!m.dest)continue;const b=(r=c.get(m.dest))!==null&&r!==void 0?r:new Set,p=$e(Ne(k(m.orig),e.orientation),h),A=$e(Ne(k(m.dest),e.orientation),h);b.add(nt(p,A)),c.set(m.dest,b)}const d=i.shapes.concat(l).map(m=>({shape:m,current:!1,hash:Bt(m,tt(m.dest,c),!1,h)}));s&&d.push({shape:s,current:!0,hash:Bt(s,tt(s.dest,c),!0,h)});const u=d.map(m=>m.hash).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const w=t.querySelector("defs");Yr(i,d,w),Jr(d,t.querySelector("g"),n.querySelector("g"),m=>ni(e,m,i.brushes,c,h))}function Yr(e,t,n){var r;const i=new Map;let o;for(const h of t.filter(l=>l.shape.dest&&l.shape.brush))o=Pn(e.brushes[h.shape.brush],h.shape.modifiers),!((r=h.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(Oe(o).key,Oe(o)),i.set(o.key,o);const s=new Set;let c=n.firstElementChild;for(;c;)s.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(const[h,l]of i.entries())s.has(h)||n.appendChild(oi(l))}function Jr(e,t,n,r){const i=new Map;for(const o of e)i.set(o.hash,!1);for(const o of[t,n]){const s=[];let c=o.firstElementChild,h;for(;c;)h=c.getAttribute("cgHash"),i.has(h)?i.set(h,!0):s.push(c),c=c.nextElementSibling;for(const l of s)o.removeChild(l)}for(const o of e.filter(s=>!i.get(s.hash)))for(const s of r(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Bt({orig:e,dest:t,brush:n,piece:r,modifiers:i,customSvg:o,label:s},c,h,l){var d,u;return[l.width,l.height,h,e,t,n,c&&"-",r&&ei(r),i&&ti(i),o&&`custom-${Kt(o.html)},${(u=(d=o.center)===null||d===void 0?void 0:d[0])!==null&&u!==void 0?u:"o"}`,s&&`label-${Kt(s.text)}`].filter(w=>w).join(",")}function ei(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function ti(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Kt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function ni(e,{shape:t,current:n,hash:r},i,o,s){var c,h;const l=$e(Ne(k(t.orig),e.orientation),s),d=t.dest?$e(Ne(k(t.dest),e.orientation),s):l,u=t.brush&&Pn(i[t.brush],t.modifiers),w=o.get(t.dest),m=[];if(u){const b=x(P("g"),{cgHash:r});m.push({el:b}),l[0]!==d[0]||l[1]!==d[1]?b.appendChild(ii(t,u,l,d,n,tt(t.dest,o))):b.appendChild(ri(i[t.brush],l,n,s))}if(t.label){const b=t.label;(c=b.fill)!==null&&c!==void 0||(b.fill=t.brush&&i[t.brush].color);const p=t.brush?void 0:"tr";m.push({el:si(b,r,l,d,w,p),isCustom:!0})}if(t.customSvg){const b=(h=t.customSvg.center)!==null&&h!==void 0?h:"orig",[p,A]=b==="label"?_n(l,d,w).map(y=>y-.5):b==="dest"?d:l,E=x(P("g"),{transform:`translate(${p},${A})`,cgHash:r});E.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,m.push({el:E,isCustom:!0})}return m}function ri(e,t,n,r){const i=ci(),o=(r.width+r.height)/(4*Math.max(r.width,r.height));return x(P("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:En(e,n),cx:t[0],cy:t[1],r:o-i[1]/2})}function Oe(e){return["#ffffff","#fff","white"].includes(e.color)?Tt.hilitePrimary:Tt.hiliteWhite}function ii(e,t,n,r,i,o){var s;function c(d){var u;const w=li(o&&!i),m=r[0]-n[0],b=r[1]-n[1],p=Math.atan2(b,m),A=Math.cos(p)*w,E=Math.sin(p)*w;return x(P("line"),{stroke:d?Oe(t).color:t.color,"stroke-width":ai(t,i)+(d?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${d?Oe(t).key:t.key})`,opacity:!((u=e.modifiers)===null||u===void 0)&&u.hilite?1:En(t,i),x1:n[0],y1:n[1],x2:r[0]-A,y2:r[1]-E})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return c(!1);const h=P("g"),l=x(P("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(hi(n,r)),l.appendChild(c(!0)),h.appendChild(l),h.appendChild(c(!1)),h}function oi(e){const t=x(P("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(x(P("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function si(e,t,n,r,i,o){var s;const h=.4*.75**e.text.length,l=_n(n,r,i),d=o==="tr"?.4:0,u=x(P("g"),{transform:`translate(${l[0]+d},${l[1]-d})`,cgHash:t});u.appendChild(x(P("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const w=x(P("text"),{"font-size":h,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return w.innerHTML=e.text,u.appendChild(w),u}function Ne(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function tt(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function P(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function x(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function Pn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function ci(){return[3/64,4/64]}function ai(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function En(e,t){return(e.opacity||1)*(t?.9:1)}function li(e){return(e?20:10)/64}function $e(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function hi(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return x(P("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function nt(e,t,n=!0){const r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function ui(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function _n(e,t,n){let r=ui(e,t);const i=nt(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const o=nt(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(r-=.4)}return[e[0]-Math.cos(i)*r,e[1]-Math.sin(i)*r].map(o=>o+.5)}function di(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const h of ar)e.classList.toggle("orientation-"+h,t.orientation===h);e.classList.toggle("manipulable",!t.viewOnly);const n=Q("cg-container");e.appendChild(n);const r=Q("cg-board");n.appendChild(r);let i,o,s;if(t.drawable.visible&&(i=x(P("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(Zr()),i.appendChild(P("g")),o=x(P("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(P("g")),s=Q("cg-auto-pieces"),n.appendChild(i),n.appendChild(o),n.appendChild(s)),t.coordinates){const h=t.orientation==="black"?" black":"",l=t.ranksPosition==="left"?" left":"";n.appendChild(Lt(ft,"ranks"+h+l)),n.appendChild(Lt(dt,"files"+h))}let c;return t.draggable.enabled&&t.draggable.showGhost&&(c=Q("piece","ghost"),mt(c,!1),n.appendChild(c)),{board:r,container:n,wrap:e,ghost:c,svg:i,customSvg:o,autoPieces:s}}function Lt(e,t){const n=Q("coords",t);let r;for(const i of e)r=Q("coord"),r.textContent=i,n.appendChild(r);return n}function fi(e,t){if(!e.dropmode.active)return;X(e),Y(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=ce(t),i=r&&ae(r,N(e),e.dom.bounds());i&&hn(e,"a0",i)}e.dom.redraw()}function pi(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const r=mi(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function gi(e,t){const n=[];if("ResizeObserver"in window||n.push(be(document.body,"chessground.resize",t)),!e.viewOnly){const r=zt(e,jr,Kr),i=zt(e,qr,Lr);for(const s of["touchmove","mousemove"])n.push(be(document,s,r));for(const s of["touchend","mouseup"])n.push(be(document,s,i));const o=()=>e.dom.bounds.clear();n.push(be(document,"scroll",o,{capture:!0,passive:!0})),n.push(be(window,"resize",o,{passive:!0}))}return()=>n.forEach(r=>r())}function be(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}const mi=e=>t=>{e.draggable.current?Se(e):e.drawable.current?kn(e):t.shiftKey||Jt(t)?e.drawable.enabled&&Br(e,t):e.viewOnly||(e.dropmode.active?fi(e,t):Wr(e,t))},zt=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function wi(e){const t=N(e),n=_e(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,c=o?o.plan.fadings:new Map,h=e.draggable.current,l=ki(e),d=new Set,u=new Set,w=new Map,m=new Map;let b,p,A,E,y,B,j,S,Le,Me;for(p=r.firstChild;p;){if(b=p.cgKey,Mn(p))if(A=i.get(b),y=s.get(b),B=c.get(b),E=p.cgPiece,p.cgDragging&&(!h||h.orig!==b)&&(p.classList.remove("dragging"),I(p,n(k(b),t)),p.cgDragging=!1),!B&&p.cgFading&&(p.cgFading=!1,p.classList.remove("fading")),A){if(y&&p.cgAnimating&&E===ke(A)){const v=k(b);v[0]+=y[2],v[1]+=y[3],p.classList.add("anim"),I(p,n(v,t))}else p.cgAnimating&&(p.cgAnimating=!1,p.classList.remove("anim"),I(p,n(k(b),t)),e.addPieceZIndex&&(p.style.zIndex=We(k(b),t)));E===ke(A)&&(!B||!p.cgFading)?d.add(b):B&&E===ke(B)?(p.classList.add("fading"),p.cgFading=!0):He(w,E,p)}else He(w,E,p);else if(An(p)){const v=p.className;l.get(b)===v?u.add(b):He(m,v,p)}p=p.nextSibling}for(const[v,we]of l)if(!u.has(v)){Le=m.get(we),Me=Le&&Le.pop();const K=n(k(v),t);if(Me)Me.cgKey=v,I(Me,K);else{const L=Q("square",we);L.cgKey=v,I(L,K),r.insertBefore(L,r.firstChild)}}for(const[v,we]of i)if(y=s.get(v),!d.has(v))if(j=w.get(ke(we)),S=j&&j.pop(),S){S.cgKey=v,S.cgFading&&(S.classList.remove("fading"),S.cgFading=!1);const K=k(v);e.addPieceZIndex&&(S.style.zIndex=We(K,t)),y&&(S.cgAnimating=!0,S.classList.add("anim"),K[0]+=y[2],K[1]+=y[3]),I(S,n(K,t))}else{const K=ke(we),L=Q("piece",K),Ae=k(v);L.cgPiece=K,L.cgKey=v,y&&(L.cgAnimating=!0,Ae[0]+=y[2],Ae[1]+=y[3]),I(L,n(Ae,t)),e.addPieceZIndex&&(L.style.zIndex=We(Ae,t)),r.appendChild(L)}for(const v of w.values())Ft(e,v);for(const v of m.values())Ft(e,v)}function bi(e){const t=N(e),n=_e(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Mn(r)&&!r.cgAnimating||An(r))&&I(r,n(k(r.cgKey),t)),r=r.nextSibling}function It(e){var t,n;const r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,o=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=s*o;i.style.width=s+"px",i.style.height=c+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",c+"px")}const Mn=e=>e.tagName==="PIECE",An=e=>e.tagName==="SQUARE";function Ft(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function We(e,t){const r=e[1];return`${t?10-r:3+r}`}const ke=e=>`${e.color} ${e.role}`;function ki(e){var t,n,r;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const c of e.lastMove)W(i,c,"last-move");if(e.check&&e.highlight.check&&W(i,e.check,"check"),e.selected&&(W(i,e.selected,"selected"),e.movable.showDests)){const c=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(c)for(const l of c)W(i,l,"move-dest"+(e.pieces.has(l)?" oc":""));const h=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(h)for(const l of h)W(i,l,"premove-dest"+(e.pieces.has(l)?" oc":""))}const o=e.premovable.current;if(o)for(const c of o)W(i,c,"current-premove");else e.predroppable.current&&W(i,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const c of s.keys)W(i,c,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((c,h)=>{W(i,h,c)}),i}function W(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function He(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function vi(e,t,n){const r=new Map,i=[];for(const c of e)r.set(c.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),r.has(s)?r.set(s,!0):i.push(o),o=o.nextElementSibling;for(const c of i)t.removeChild(c);for(const c of e)r.get(c.hash)||t.appendChild(n(c))}function yi(e,t){const r=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Ei(i),current:!1}));vi(r,t,i=>Pi(e,i,e.dom.bounds()))}function Ci(e){var t;const n=N(e),r=_e(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)Yt(i,r(k(i.cgKey),n),i.cgScale),i=i.nextSibling}function Pi(e,{shape:t,hash:n},r){var i,o,s;const c=t.orig,h=(i=t.piece)===null||i===void 0?void 0:i.role,l=(o=t.piece)===null||o===void 0?void 0:o.color,d=(s=t.piece)===null||s===void 0?void 0:s.scale,u=Q("piece",`${h} ${l}`);return u.setAttribute("cgHash",n),u.cgKey=c,u.cgScale=d,Yt(u,_e(r)(k(c),N(e)),d),u}const Ei=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function _i(e,t){const n=Gr();mn(n,t||{});function r(){const i="dom"in n?n.dom.unbind:void 0,o=di(e,n),s=hr(()=>o.board.getBoundingClientRect()),c=d=>{wi(l),o.autoPieces&&yi(l,o.autoPieces),!d&&o.svg&&Xr(l,o.svg,o.customSvg)},h=()=>{It(l),bi(l),o.autoPieces&&Ci(l)},l=n;return l.dom={elements:o,bounds:s,redraw:Mi(c),redrawNow:c,unbind:i},l.drawable.prevSvgHash="",It(l),c(!1),pi(l,h),i||(l.dom.unbind=gi(l,h)),l.events.insert&&l.events.insert(o),l}return Vr(r(),r)}function Mi(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var Ai=se('<div class="is2d chessboard">');const Ri=e=>{let t,n;return Sn(()=>{let r=e.color,i=e.dests,o={premovable:{enabled:!1},movable:{color:r,free:!1,dests:i,events:{after:e.onMoveAfter}}};n=_i(t,o)}),Qe(()=>{n.set({movable:{color:e.color,dests:e.dests}})}),Qe(()=>{let r=e.doPromotion;if(r){let i=n.state.pieces.get(r);n.setPieces(new Map([[r,{color:i.color,role:"queen",promoted:!0}]]))}}),(()=>{var r=Ai();return On(i=>t=i,r),r})()},xi=(e,t)=>{const n=new Map,r=e.ctx();for(const[i,o]of e.allDests(r))if(o.nonEmpty()){const s=Array.from(o,G);!(t!=null&&t.chess960)&&i===r.king&&R(i)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(G(i),s)}return n},Si=(e,t)=>{let n="";if(ve(t))t.role!=="pawn"&&(n=te(t.role).toUpperCase()),n+="@"+G(t.to);else{const r=e.board.getRole(t.from);if(!r)return"--";if(r==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))n=t.to>t.from?"O-O":"O-O-O";else{const i=e.board.occupied.has(t.to)||r==="pawn"&&R(t.from)!==R(t.to);if(r!=="pawn"){n=te(r).toUpperCase();let o;if(r==="king"?o=Be(t.to).intersect(e.board.king):r==="queen"?o=ht(t.to,e.board.occupied).intersect(e.board.queen):r==="rook"?o=me(t.to,e.board.occupied).intersect(e.board.rook):r==="bishop"?o=ge(t.to,e.board.occupied).intersect(e.board.bishop):o=Ke(t.to).intersect(e.board.knight),o=o.intersect(e.board[e.turn]).without(t.from),o.nonEmpty()){const s=e.ctx();for(const c of o)e.dests(c,s).has(t.to)||(o=o.without(c));if(o.nonEmpty()){let c=!1,h=o.intersects(a.fromRank(ie(t.from)));o.intersects(a.fromFile(R(t.from)))?c=!0:h=!0,h&&(n+=Re[R(t.from)]),c&&(n+=Ht[ie(t.from)])}}}else i&&(n=Re[R(t.from)]);i&&(n+="x"),n+=G(t.to),t.promotion&&(n+="="+te(t.promotion).toUpperCase())}}return n},Oi=(e,t)=>{var n;const r=Si(e,t);return e.play(t),!((n=e.outcome())===null||n===void 0)&&n.winner?r+"#":e.isCheck()?r+"+":r},Ni=(e,t)=>Oi(e.clone(),t),Wt=(e,t)=>{const n=e.ctx(),r=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!r){let d;if(t==="O-O"||t==="O-O+"||t==="O-O#"?d="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(d="a"),d){const m=e.castles.rook[e.turn][d];return!f(n.king)||!f(m)||!e.dests(n.king,n).has(m)?void 0:{from:n.king,to:m}}const u=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!u)return;const w={role:u[1]?fe(u[1]):"pawn",to:ne(u[2])};return e.isLegal(w,n)?w:void 0}const i=r[1]?fe(r[1]):"pawn",o=ne(r[4]),s=r[5]?fe(r[5]):void 0;if(!!s!==(i==="pawn"&&a.backranks().has(o))||s==="king"&&e.rules!=="antichess")return;let c=e.board.pieces(e.turn,i);i==="pawn"&&!r[2]?c=c.intersect(a.fromFile(R(o))):r[2]&&(c=c.intersect(a.fromFile(r[2].charCodeAt(0)-97))),r[3]&&(c=c.intersect(a.fromRank(r[3].charCodeAt(0)-49)));const h=i==="pawn"?a.fromFile(R(o)):a.empty();c=c.intersect(h.union(tr({color:_(e.turn),role:i},o,e.board.occupied)));let l;for(const d of c)if(e.dests(d,n).has(o)){if(f(l))return;l=d}if(f(l))return{from:l,to:o,promotion:s}},De=class De{constructor(t,n,r){this.event=t,this.site=n,this.tree=r}};z(De,"make",t=>{let n=Kn(t)[0],r=n.headers.get("Event"),i=n.headers.get("Site"),o=n.moves.children[0],s=qt,c=o.data.san,h=ut.fromSetup(lt(s).unwrap()).unwrap(),l=Wt(h,c),d=_t(l),u=it.make(s,[d]);w(u,o,h,[]);function w(b,p,A,E){let y=Wt(A,p.data.san),B=A.clone();B.play(y);let j=_t(y);b.append_uci(j,E),p.children.forEach(S=>{w(b,S,B,[...E,j])})}return new De(r,i,u)});let rt=De;const de=class de{constructor(t){this.root=t}static make_data(t,n,r,i){let o=lt(t).unwrap(),s=ut.fromSetup(o).unwrap(),c=Qt(n),h=Ni(s,c);return s.play(c),{path:[...i,n],ply:r,before_fen:t,san:h,after_fen:Vt(s.toSetup()),uci:n}}_traverse_path(t){let n=this.root,r=[n];for(let i of t)n=r.find(o=>o.data.uci===i),r=n.children;return n}_find_path(t){let n=[],r=[],i=this.root,o=[i],s=!1;for(let c of t)if(s)r.push(c);else{let h=o.find(l=>l.data.uci===c);h?(n.push(c),i=h,o=i.children):(s=!0,r.push(c))}return[n,i,r]}get_children(t){return this._traverse_path(t).children.map(r=>r.data)}get_at(t){return this._traverse_path(t).data}append_uci(t,n=[]){this.append_ucis([...n,t])}append_ucis(t){let[n,r,i]=this._find_path(t);for(let o of i){let s={data:de.make_data(r.data.after_fen,o,r.data.ply+1,n),children:[]};r.children.push(s),r=s,n=[...n,o]}}delete_children(t){let n=this._traverse_path(t);n.children=[]}delete_path(t){let n=this._traverse_path(t.slice(0,-1)),r=t[t.length-1],i=n.children.findIndex(o=>o.data.uci===r);n.children.splice(i,1)}};z(de,"make",(t,n)=>{let r=n[0],i=n.slice(1),o=new de({data:de.make_data(t,r,1,[]),children:[]});return o.append_ucis(i),o});let it=de;var $i=se("<div class=chesstree>"),Di=se("<div class=lines>"),Ti=se("<div class=line>"),Bi=se("<span class=index>"),Ki=se("<div>");const Li=`
[Event "e4 vs Minor Defences: Alekhine"]
[Site "https://lichess.org/study/F8wyMEli/XtCmR5GS"]
[Result "*"]
[UTCDate "2023.04.06"]
[UTCTime "17:47:58"]
[Variant "Standard"]
[ECO "B04"]
[Opening "Alekhine Defense: Modern Variation, Larsen-Haakert Variation"]
[Annotator "https://lichess.org/@/heroku"]

1. e4 Nf6 2. e5 Nd5 3. d4 d6 4. Nf3 Nc6 (4... Nb6 5. a4 a5 6. Nc3 g6 (6... Bf5 7. d5 e6 8. dxe6 Bxe6 9. Bg5 Qd7 10. exd6 Bxd6 11. Nb5 Nd5 12. Nxd6+ Qxd6) 7. exd6 cxd6 (7... exd6 8. Bg5 f6 9. Bf4 d5 10. Bd3 Bd6 11. Bxd6 Qxd6 12. O-O O-O 13. Qd2) 8. d5 Bg7 9. Be3 O-O 10. Bd4 N8d7 11. Bxg7 Kxg7 12. Qd4+ Nf6 13. Nd2 Bd7 14. Nde4 Rc8 15. h4 h5 16. f3) (4... c6 5. Be2 g6 6. c4 Nc7 7. exd6 Qxd6 8. Nc3 Bg7 9. O-O O-O 10. h3 Ne6 11. Be3 Nf4 12. Re1) (4... Bf5 5. Bd3 Bxd3 6. Qxd3 e6 7. O-O Nc6 8. c4 Nb6 9. exd6 cxd6 10. Nc3 Be7 11. d5 Nb4 12. Qe4 e5 13. c5 dxc5 14. a3 Na6 15. Rd1 O-O) 5. c4 Nb6 6. e6 fxe6 7. Nc3 g6 8. h4 Bg7 9. Be3 e5 10. d5 Nd4 11. Nxd4 exd4 12. Bxd4 Bxd4 13. Qxd4 e5 14. Qe3 *
`,zi=()=>{let[e,t]=je(["e2e4","g8f6"]);const n=rt.make(Li);return Qe(()=>{console.log(e())}),(()=>{var r=$i();return V(r,$(ot,{on_set_path:t,get cursor_path(){return e()},get lines(){return[n.tree.root]}})),r})()},ot=e=>$(Et,{get each(){return e.lines},children:t=>[$(Ii,{get on_set_path(){return e.on_set_path},get cursor_path(){return e.cursor_path},get data(){return t.data},get show_index(){return e.show_index}}),$($n,{get children(){return[$(Pt,{get when(){return t.children.length===1},get children(){return $(ot,{get on_set_path(){return e.on_set_path},get cursor_path(){return e.cursor_path},get lines(){return t.children}})}}),$(Pt,{get when(){return t.children.length>1},get children(){var n=Di();return V(n,$(Et,{get each(){return t.children},children:r=>(()=>{var i=Ti();return V(i,$(ot,{get on_set_path(){return e.on_set_path},get cursor_path(){return e.cursor_path},lines:[r],show_index:!0})),i})()})),n}})]}})]}),Ii=e=>{let t=`${Math.ceil(e.data.ply/2)}.`;e.data.ply%2===0&&(t+="..");let n=()=>e.cursor_path.join("").startsWith(e.data.path.join("")),r=()=>e.cursor_path.join("")===e.data.path.join(""),i=()=>["move",r()?"on_path_end":n()?"on_path":""].join(" ");return(()=>{var o=Ki();return o.$$click=()=>e.on_set_path(e.data.path),V(o,$(Dn,{get when(){return e.show_index||e.data.ply&1},get children(){var s=Bi();return V(s,t),s}}),null),V(o,()=>e.data.san,null),Tn(()=>Bn(o,i())),o})()};Nn(["click"]);var Fi=se("<div class=shalala><div class=chessboard-wrap></div><div class=chesstree-wrap>");const Te=class Te{constructor(){z(this,"_promotion");z(this,"_position");z(this,"m_fen");z(this,"m_dests");z(this,"m_color");z(this,"on_move_after",(t,n)=>{let r=this.position.board.get(ne(t)),i=t+n;r.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(i+="q"),this.position.play(Qt(i)),this.position=this.position,i.length===5&&(this.promotion=n)});this._promotion=je(void 0,{equals:!1}),this._position=je(ut.fromSetup(lt(qt).unwrap()).unwrap(),{equals:!1}),this.m_dests=ze(()=>xi(this.position)),this.m_fen=ze(()=>Vt(this.position.toSetup())),this.m_color=ze(()=>this.position.turn)}get position(){return this._position[0]()}set position(t){this._position[1](t)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(t){this._promotion[1](t)}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};z(Te,"init",()=>new Te);let st=Te;const ji=()=>{let e=st.init();return(()=>{var t=Fi(),n=t.firstChild,r=n.nextSibling;return V(n,$(Ri,{get doPromotion(){return e.promotion},get onMoveAfter(){return e.on_move_after},get color(){return e.turnColor},get dests(){return e.dests}})),V(r,$(zi,{})),t})()};export{ji as default};
