const f=(h=c)=>({headers:h(),moves:new m});class m{constructor(){this.children=[]}*mainline(){let s=this;for(;s.children.length;){const e=s.children[0];yield e.data,s=e}}}class g extends m{constructor(s){super(),this.data=s}}const c=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),d="\uFEFF",o=h=>/^\s*$/.test(h),l=h=>h.startsWith("%");class p extends Error{}class B{constructor(s,e=c,t=1e6){this.emitGame=s,this.initHeaders=e,this.maxBudget=t,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=f(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(s){if(this.budget-=s,this.budget<0)throw new p("ERR_PGN_BUDGET")}parse(s,e){if(!(this.budget<0))try{let t=0;for(;;){const n=s.indexOf(`
`,t);if(n===-1)break;const a=n>t&&s[n-1]==="\r"?n-1:n;this.consumeBudget(n-t),this.lineBuf.push(s.slice(t,a)),t=n+1,this.handleLine()}this.consumeBudget(s.length-t),this.lineBuf.push(s.slice(t)),e!=null&&e.stream||(this.handleLine(),this.emit(void 0))}catch(t){this.emit(t)}}handleLine(){let s=!0,e=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:e.startsWith(d)&&(e=e.slice(d.length)),this.state=1;case 1:if(o(e)||l(e))return;this.found=!0,this.state=2;case 2:{if(l(e))return;let t=!0;for(;t;)t=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(n,a,i)=>(this.consumeBudget(200),this.game.headers.set(a,i.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),t=!0,s=!1,""));if(o(e))return;this.state=3}case 3:{if(s){if(l(e))return;if(o(e))return this.emit(void 0)}const t=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let n;for(;n=t.exec(e);){const a=this.stack[this.stack.length-1];let i=n[0];if(i===";")return;if(i.startsWith("$"))this.handleNag(parseInt(i.slice(1),10));else if(i==="!")this.handleNag(1);else if(i==="?")this.handleNag(2);else if(i==="!!")this.handleNag(3);else if(i==="??")this.handleNag(4);else if(i==="!?")this.handleNag(5);else if(i==="?!")this.handleNag(6);else if(i==="1-0"||i==="0-1"||i==="1/2-1/2"||i==="*")this.stack.length===1&&i!=="*"&&this.game.headers.set("Result",i);else if(i==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(i===")")this.stack.length>1&&this.stack.pop();else if(i==="{"){const r=t.lastIndex,u=e[r]===" "?r+1:r;e=e.slice(u),this.state=4;continue e}else this.consumeBudget(100),i==="Z0"||i==="0000"||i==="@@@@"?i="--":i.startsWith("0")&&(i=i.replace(/0/g,"O")),a.node&&(a.parent=a.node),a.node=new g({san:i,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const t=e.indexOf("}");if(t===-1){this.commentBuf.push(e);return}else{const n=t>0&&e[t-1]===" "?t-1:t;this.commentBuf.push(e.slice(0,n)),this.handleComment(),e=e.slice(t),this.state=3,s=!1}}}}handleNag(s){var e;this.consumeBudget(50);const t=this.stack[this.stack.length-1];t.node&&((e=t.node.data).nags||(e.nags=[]),t.node.data.nags.push(s))}handleComment(){var s,e;this.consumeBudget(100);const t=this.stack[this.stack.length-1],n=this.commentBuf.join(`
`);this.commentBuf=[],t.node?((s=t.node.data).comments||(s.comments=[]),t.node.data.comments.push(n)):t.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(n)):(t.startingComments||(t.startingComments=[]),t.startingComments.push(n))}emit(s){if(this.state===4&&this.handleComment(),s)return this.emitGame(this.game,s);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const x=(h,s=c)=>{const e=[];return new B(t=>e.push(t),s,NaN).parse(h),e};export{x as p};
