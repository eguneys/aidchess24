import{_ as G,H as U,c as k,g as v,J as K,a as w,m as H,K as Q,L as A,N as R,O as D,Q as X,T as Y,x as L,r as J,n as h,b as Z,t as M,I as P,U as ee,V as te,d as ne,C as j,i as E,S as F,j as re,k as se,F as ae,W as le,X as oe,o as ie,B as ue,Y as ce,Z as _e,q as C,D as de,u as fe}from"./index-DxQFnZx7.js";import{C as pe}from"./chessground-doaUGlzw.js";import{s as me}from"./scroll-DnAhRpRC.js";async function ge(t){const c=await ye(t);function s(n){return c.transaction(t.store,n).objectStore(t.store)}function o(n){return new Promise((a,_)=>{const r=n();r.onsuccess=g=>a(g.target.result),r.onerror=g=>_(g.target.result)})}return{list:()=>o(()=>s("readonly").getAllKeys()),get:n=>o(()=>s("readonly").get(n)),getMany:n=>o(()=>s("readonly").getAll(n)),put:(n,a)=>o(()=>s("readwrite").put(a,n)),count:n=>o(()=>s("readonly").count(n)),remove:n=>o(()=>s("readwrite").delete(n)),clear:()=>o(()=>s("readwrite").clear()),cursor:(n,a)=>o(()=>s("readonly").openCursor(n,a)).then(_=>_??void 0),txn:n=>c.transaction(t.store,n)}}async function ye(t){const c=t?.db||`${t.store}--db`;return new Promise((s,o)=>{const n=window.indexedDB.open(c,t?.version??1);n.onsuccess=a=>s(a.target.result),n.onerror=a=>o(a.target.error??"IndexedDB Unavailable"),n.onupgradeneeded=a=>{const _=a.target.result,r=a.target.transaction,g=_.objectStoreNames.contains(t.store)?r.objectStore(t.store):_.createObjectStore(t.store);t.upgrade?.(a,g)}})}async function he(t){let c;await ve({on_received:a,on_status(l){l&&(l.download&&t.on_downloaded_nb(l.download),l.error&&t.on_engine_failed(l.error))},on_connected(l){c=l}}),s("uci");function s(l){c?.(l)}function o(l){g=l,p(),m()}function n(){return!!r&&!r.stop_requested}function a(l){const u=l.trim().split(/\s+/g);if(u[0]==="uciok")s("ucinewgame"),s("isready");else if(u[0]==="readyok")m();else if(!(u[0]==="id"&&u[1]==="name"))if(u[0]==="bestmove"){r&&f&&r.emit(f),r=void 0,m();return}else if(r&&!r.stop_requested&&u[0]==="info"){let b=0,N,$=1,B,I,S=!1,x,T=[];for(let y=1;y<u.length;y++)switch(u[y]){case"depth":b=parseInt(u[++y]);break;case"nodes":N=parseInt(u[++y]);break;case"multipv":$=parseInt(u[++y]);break;case"time":B=parseInt(u[++y]);break;case"score":S=u[++y]==="mate",x=parseInt(u[++y]),(u[y+1]==="lowerbound"||u[y+1]==="upperbound")&&(I=u[++y]);break;case"pv":T=u.slice(++y),y=u.length;break}if(S&&!x||(_<$&&(_=$),!U(N)||!U(B)||!U(S)||!U(x)))return;const q=r.ply%2===1?-x:x;if(I&&$===1)return;const V={moves:T,cp:S?void 0:q,mate:S?q:void 0,depth:b};$===1?f={fen:r.current_fen,depth:b,nodes:N,millis:B,cp:S?void 0:q,mate:S?q:void 0,pvs:[V]}:f&&(f.pvs.push(V),f.depth=Math.min(f.depth,b)),$===_&&f&&(r.emit(f),b>=40&&p())}else l&&!["Stockfish","id","option","info"].includes(u[0])&&console.warn(`SF: ${l}`)}let _=0,r,g,f;function m(){if(!r&&(r=g,g=void 0,r)){f=void 0,_=1,d("Threads",r.threads),d("Hash",r.hash_size||16),d("MultiPV",Math.max(1,r.multi_pv)),e&&e!==r.game_id&&s("ucinewgame"),e=r.game_id,s(["position fen",r.initial_fen,"moves",r.moves].join(" "));const[l,u]=Object.entries(r.search)[0];s(`go ${l} ${u}`)}}let i=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function d(l,u){u=u.toString(),i.get(l)!==u&&(s(`setoption name ${l} value ${u}`),i.set(l,u))}function p(){r&&!r.stop_requested&&(r.stop_requested=!0,s("stop"))}let e;return{start(l){o(l)},stop(){o()},destroy(){s("quit")},get state(){return n()?"computing":"idle"}}}async function ve(t){const c=i=>{t.on_status(i)},s=i=>{t.on_received(i)},o=i=>{t.on_connected(i)};let n=await G(()=>import("./sf17-79-Dr-iJHKx.js"),[],import.meta.url),a=await new Promise((i,d)=>{n.default({wasmMemory:we(2560),onError:p=>d(new Error(p)),locateFile:p=>`stockfish/${p}`}).then(i).catch(d)}),_=await ge({store:".aidchess.nnue"}).catch(()=>{}),r=[];for(let i=0;;i++){let d=a.getRecommendedNnue(i);if(!d||r.includes(d))break;r.push(d)}(await f(r)).forEach((i,d)=>a.setNnueBuffer(i,d)),a.onError=m(),a.listen=i=>s(i),o(i=>a.uci(i));async function f(i){return Promise.all(i.map(async d=>{let p=await _?.get(d).catch(()=>{});if(p&&p.byteLength>128*1024)return p;const e=new XMLHttpRequest;e.open("get",`stockfish/nnue/${d}`,!0),e.responseType="arraybuffer",e.onprogress=u=>c({download:{bytes:u.loaded,total:u.total}});const l=await new Promise((u,b)=>{e.onerror=()=>b(new Error(`fetch '${d}' failed: ${e.status}`)),e.onload=()=>{e.status/100===2?u(new Uint8Array(e.response)):b(new Error(`fetch '${d}' failed: ${e.status}`))},e.send()});return c(),_?.put(d,l).catch(()=>console.warn("IDB store failed")),l}))}function m(){return i=>{if(i.startsWith("BAD_NNUE")&&_){const d=Math.max(0,Number(i.slice(9))),p=a.getRecommendedNnue(d);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${p} from IDB`),_.remove(p)},2e3)}else c({error:i})}}}const we=(t,c=32767)=>{let s=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:t,maximum:c})}catch(o){if(c<=t||!(o instanceof RangeError))throw o;c=Math.max(t,Math.ceil(c-c/s)),s=s===4?3:4}},O=K();function be(t){let c=async function(){let[s,o]=w(void 0),[n,a]=w(void 0),[_]=H(()=>he({on_downloaded_nb(r){o(r)},on_engine_failed(r){a(r)}}));return{get download_nb(){return s()},get engine_failed(){return n()},get state(){let r=_();return _.loading||!r?"loading":r.state},async get_best_move(r,g,f,m,i){let d=u=>{},p=_();if(!p)return;let e=Math.max(1,navigator.hardwareConcurrency-2);return p.start({threads:e,hash_size:16,game_id:r,stop_requested:!1,path:[],search:{depth:i},multi_pv:m,ply:f,threatMode:!1,initial_fen:g,current_fen:g,moves:[],emit:Q(200,function(u){u.depth===i&&d(u)})}),new Promise(u=>{d=u})}}};return k(O.Provider,{get value(){return c()},get children(){return v(()=>t.children)}})}var ke=M('<div class="is2d chessboard">');function Se(){let[t,c]=w(A.fromSetup(R(P).unwrap()).unwrap(),{equals:!1}),[s,o]=w(void 0),[n,a]=w(void 0),_=v(()=>D(t().toSetup())),r=v(()=>t().turn),g=v(()=>X(t()));const f=m=>{let i=t(),d=ee(m),p=te(i,d);i.play(d),L(()=>{o([m,p]),a([m,p]),c(i),m.length})};return{play_orig_key(m,i){let d=t(),p=r(),e=d.board.get(Y(m)),l=m+i;e.role==="pawn"&&(i[1]==="8"&&p==="white"||i[1]==="1"&&p==="black")&&(l+="q"),f(l)},play_uci:f,set_fen_last_move(m,i){L(()=>{c(A.fromSetup(R(m).unwrap()).unwrap()),o(i)})},get dests(){return g()},get fen_last_move(){let m=_(),i=s();return i?[m,i]:void 0},get fen(){return _()},get last_move(){return s()},get add_last_move(){return n()},get check(){return t().isCheck()},get isEnd(){return t().isEnd()}}}function $e(t){let c,s;return J(()=>{let o=t.color,n=t.play_uci.dests,a={fen:t.play_uci.fen,check:t.play_uci.check,premovable:{enabled:!1},movable:{color:o,free:!1,dests:n,events:{after:t.play_uci.play_orig_key}}};s=pe(c,a)}),h(()=>{let o,n;if(!t.play_uci.fen_last_move)o=P;else{let r;[o,[n,r]]=t.play_uci.fen_last_move}let a=[];n&&(a.push(n.slice(0,2)),a.push(n.slice(2,4)));let _=t.movable?t.color:void 0;s.set({fen:o,lastMove:a,turnColor:t.color,movable:{color:_,dests:t.play_uci.dests}})}),h(()=>{let o=t.orientation??"white";s.set({orientation:o})}),h(()=>{let o=t.play_uci.check;s.set({check:o})}),h(()=>{t.shapes?s.setAutoShapes(t.shapes):s.setAutoShapes([])}),(()=>{var o=ke();return Z(n=>c=n,o),o})()}var Ce=M("<div class=replay-single><div class=moves>"),xe=M("<span class=index>"),Ee=M("<span>");function z(t,c,s){let o=le(c,s),n=oe(o),a=D(c.toSetup());c.play(o);let _=D(c.toSetup());return{ply:t,before_fen:a,fen:_,uci:n,san:s}}function W(t,c=P,s=0){let o=[],n=A.fromSetup(R(c).unwrap()).unwrap();for(let a of t)o.push(z(++s,n,a));return o}function Me(t=P,c=[]){let[s,o]=w(W(c,t));const n=v(()=>{let e=s();return e[e.length-1]});let[a,_]=w(n()?.ply??0);const r=v(()=>{let e=a();return s().find(u=>u.ply===e)});let g=v(j(s,e=>e.san)),f=v(j(s,e=>e.ply)),m=v(()=>{let e=g(),l=f();return e.map((u,b)=>`${l[b]} ${u}`)});const i=e=>{_(e)},d=()=>{let e=a()-1;return f().find(l=>l===e)},p=()=>{let e=a()+1;return f().find(l=>l===e)};return{initial_fen:t,get plies(){return f()},get sans(){return g()},get ply_sans(){return m()},get ply_step(){return r()},get last_step(){return n()},goto_ply:i,get_prev_ply:d,get_next_ply:p,goto_prev_ply_if_can(){let e=d();e!==void 0&&i(e),a()===1&&_(0)},goto_next_ply_if_can(){let e=p();e!==void 0&&i(e)},play_san(e){let l=n();if(!l){o(W([e]));return}let u=A.fromSetup(R(l.fen).unwrap()).unwrap();o([...s(),z(l.ply+1,u,e)]),_(l.ply+1)},get is_on_last_ply(){return a()===(n()?.ply??0)}}}function Pe(t){const c=v(j(()=>t.play_replay.ply_sans,n=>{let[a,_]=n.split(" ");return{ply:parseInt(a),san:_}})),s=n=>{t.play_replay.goto_ply(n)},o=v(()=>t.play_replay.ply_step?.ply);return(()=>{var n=Ce(),a=n.firstChild;return E(a,k(ae,{get each(){return c()},children:_=>[k(F,{get when(){return _.ply%2===1},get children(){var r=xe();return E(r,()=>Math.ceil(_.ply/2)),r}}),(()=>{var r=Ee();return r.$$click=()=>s(_.ply),E(r,()=>_.san),re(()=>se(r,"move"+(_.ply===o()?" active":""))),r})()]})),n})()}ne(["click"]);var Ne=M("<div class=builder><div class=board-wrap></div><div class=replay-wrap>");const je=()=>k(be,{get children(){return k(qe,{})}});function qe(){let[t]=H(()=>fe(O));return k(F,{get when(){return t()},children:c=>k(F,{get when(){return c().state==="loading"},get fallback(){return k(Ae,{get s(){return c()}})},get children(){return['"Loading"'," "]}})})}function Ue(t){let c=`${Math.random()}`,[s,o]=w("white",{equals:!1}),n=6,a=8,[_,r]=w(!1);h(C(()=>t.get_fen_ply_and_play,f=>{if(!f)return;let[m,i]=f;if(de(m)===s()){if(_())return;r(!0),t.s.get_best_move(c,m,i,n,a).then(p=>{r(!1),p&&g(p)})}}));const g=f=>{let m=f.pvs[0].moves[0];t.on_play_uci(m)};return{get engine_color(){return s()},reset_game(f){L(()=>{o(f)})}}}function Ae(t){const c=ie();c.setVolume(.2);let[s,o]=ue([],"builder.current.sans");const n=Me(P,s());let a=Se(),[_,r]=w(void 0),g=Ue({on_play_uci(e){a.play_uci(e)},get get_fen_ply_and_play(){return _()},s:t.s});const[f,m]=w("white");g.reset_game(ce(f())),h(()=>{console.log(a.last_move)}),h(C(()=>a.add_last_move,e=>{e&&n.play_san(e[1])})),h(C(()=>n.sans,o)),h(C(()=>n.last_step,e=>{e&&r([e.fen,e.ply])})),h(C(()=>n.ply_step,e=>{e?a.set_fen_last_move(e.fen,[e.uci,e.san]):a.set_fen_last_move(n.initial_fen)})),h(C(()=>n.ply_step,(e,l)=>{e&&(!l||l.ply===e.ply-1)&&c.move(e)}));const i=me(e=>{const l=e.target;l.tagName!=="PIECE"&&l.tagName!=="SQUARE"&&l.tagName!=="CG-BOARD"||(e.preventDefault(),d(Math.sign(e.deltaY)))}),d=e=>{e>0?n.goto_next_ply_if_can():n.goto_prev_ply_if_can()},p=()=>!a.isEnd&&n.is_on_last_ply;return(()=>{var e=Ne(),l=e.firstChild,u=l.nextSibling;return _e(e,"wheel",i),E(l,k($e,{get color(){return f()},get movable(){return p()},play_uci:a})),E(u,k(Pe,{play_replay:n})),e})()}export{je as default};
