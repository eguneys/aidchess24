import{d as L,a as f,o as F,w as u,m as I,u as M,i as _,c as n,S as m,z as d,g as T,M as v,F as j,f as o,h as N,j as z,t as c}from"./index-Bgo53qU8.js";import"./Shalala-kUu5oICH.js";import{I as S,f as A,c as D}from"./chess_pgn_logic-C2oalU4H.js";const B=(h=1)=>()=>{var t=Math.sin(h++)*1e4;return t-Math.floor(t)},G=B();function J(h,t=G){return Math.floor(t()*h)}function k(h){return h[J(h.length)]}var q=c("<div class=chesstree>"),C=c("<div class=lines>"),R=c("<div class=line>"),K=c("<span class=index>"),P=c("<div>"),Q=c("<div class=inline>"),U=c("<span class=collapsed> ..<!> ");const y=h=>{let t=[];for(let e of h)t.length===0?t.push([e]):t.push([...t[t.length-1],e]);return t};class w{static set_for_saving(t){let e=new w;return e.paths=t,e}_paths;get paths(){return this._paths[0]()}set paths(t){this._paths[1](t)}constructor(){this._paths=f([],{equals:!1})}get clone(){let t=new w;return t.paths=this.paths.slice(0),t}get_for_saving(){return this.paths}merge_dup(t){t.paths.forEach(e=>F(()=>this.add_path(e)))}replace_all(t){this.paths=t.paths.slice(0)}add_path(t){let e=this.paths;e.find(a=>a.join("")===t.join(""))||(e.push(t),this.paths=e)}remove_path(t){this.paths=this.paths.filter(e=>e.join("")!==t.join(""))}clear(){this.paths=[]}}class O{constructor(t,e){this.initial_fen=t,this._cursor_path=f([],{equals:!1}),this._tree=f(e),this._hidden_paths=new w,this._revealed_paths=f([],{equals:!1}),this._failed_paths=f([],{equals:!1}),this._solved_paths=new w}static make=(t,e=t?.root.data.before_fen||S)=>new O(e,t);_tree;_cursor_path;_hidden_paths;_revealed_paths;_failed_paths;_solved_paths;get cursor_after_color(){let t=this.cursor_path;return A(this.tree?.get_at(t)?.after_fen??S)}get is_cursor_path_at_a_leaf(){let t=this.cursor_path;return this.failed_paths.find(e=>e.join("")===t.join(""))?!1:this.tree?.get_children(t)?.length===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.paths}get initial_color(){return this.tree?.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let a=e.after_fen,r=e.uci;return[a,r]}}collect_branch_sums(t){if(!this.tree)return[];let e=[],a=[this.tree.root],r=!1;for(let s of t){let i=a.find(p=>p.data.uci===s);if(!i)return;r&&(e.push(i.data),r=!1),i.children.filter(p=>!this.failed_paths.some(b=>b.join("")===p.data.path.join(""))).length>1&&(r=!0),a=i.children}return e}clear_failed_paths(){u(()=>{this.failed_paths.forEach(t=>{this.tree?.delete_at(t)}),this.failed_paths=[]})}try_set_cursor_path(t){return this.hidden_paths.find(a=>t.join("").startsWith(a.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let t=k(this.tree.all_leaves.map(r=>r.path)),e=k(y(t).slice(1,-1));this.solved_paths.paths.find(r=>r.join("")===e.join(""))&&(e=k(y(t).slice(1,-1))),this.cursor_path=e;let a=this.tree.get_children(e);this._hidden_paths.clear(),a?.forEach(r=>this._hidden_paths.add_path(r.path))}reveal_hidden_paths=()=>{u(()=>{this.hidden_paths.forEach(t=>{this.revealed_paths.push(t)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})};add_and_reveal_uci(t){this.revealed_paths.push(this.add_uci(t)),this.revealed_paths=this.revealed_paths}reveal_one_random=()=>{if(!this.tree)return!1;const t=this.tree?._traverse_path(this.cursor_path)?.children??[this.tree.root],e=Y(t);return e?(u(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this.cursor_path=e.data.path}),!0):!1};try_next_uci_fail=t=>{if(!this.tree)return!1;const e=this.tree?._traverse_path(this.cursor_path)??this.tree.root,a=this.tree?._traverse_path(this.cursor_path)?.children??[this.tree.root],r=a.find(s=>s.data.uci===t)??a.find(s=>Z(s.data)===t);if(r)return this.failed_paths.find(i=>i.join("")===r.data.path.join(""))?(this.cursor_path=r.data.path,!1):(u(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(i=>this._hidden_paths.add_path(i.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0);if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.add_failed_path([...e.data.path,t]),!1};add_failed_path(t){let e=this.failed_paths;e=e.filter(a=>a.join("")!==t.join("")),e.push(t),this.failed_paths=e}on_wheel=t=>{let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let a=this.tree;if(a){let r;e.length===0?r=[a.root]:r=a._traverse_path(e)?.children;let s=r?.map(i=>i.data.path).find(i=>!this.hidden_paths?.some(x=>i.join("").startsWith(x.join(""))));s&&this.try_set_cursor_path(s)}}};add_uci(t){let e=this.tree,a=this.cursor_path;return e?e.append_uci(t,a):e=D.make(this.initial_fen,[t]),a=[...a,t],u(()=>{this.tree=e,this.cursor_path=a}),a}drop_failed_paths(){return u(()=>{let t=this.failed_paths;t.forEach(a=>this.tree?.delete_at(a));let e=this.cursor_path;for(;e.length>0&&!this.tree?.get_at(e);)e.pop();return this.cursor_path=e,this.failed_paths=[],t})}get can_navigate_next(){let t=this.cursor_path,e=this.tree;if(e){let a;return t.length===0?a=[e.root]:a=e._traverse_path(t)?.children,a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_first(){let t=y(this.cursor_path).reverse().slice(1),e=(t.find(a=>(this.tree.get_children(a.slice(0,-1))?.length??0)>1)||t[t.length-1])??[];this.try_set_cursor_path(e)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){let t=this.cursor_path,e=this.tree;if(e){let a;t.length===0?a=[e.root]:a=e._traverse_path(t)?.children;let r=a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))));r&&this.try_set_cursor_path(r)}}navigate_last(){let t=this.cursor_path,e=this.tree;if(e){let a;t.length===0?a=[e.root]:a=e._traverse_path(t)?.children;let r=a?.map(s=>s.data.path).find(s=>!this.hidden_paths?.some(i=>s.join("").startsWith(i.join(""))));if(r){let s=e._traverse_path(r);for(;s.children.length===1&&!this.hidden_paths?.some(i=>s.children[0].data.path.join("").startsWith(i.join("")));)s=s.children[0];r=s.data.path,this.try_set_cursor_path(r)}}}get can_navigate_up(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const r=e._traverse_path(a.slice(0,-1))?.children;if(r&&r.length>1)return r?.findIndex(i=>i.data.path.join("")===a.join(""))-1>=0;a=a.slice(0,-1)}}return!1}get can_navigate_down(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const r=e._traverse_path(a.slice(0,-1))?.children;if(r&&r.length>1)return r?.findIndex(i=>i.data.path.join("")===a.join(""))+1<r.length;a=a.slice(0,-1)}}}navigate_up(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const r=e._traverse_path(a.slice(0,-1))?.children;if(r&&r.length>1){let s=r?.findIndex(i=>i.data.path.join("")===a.join(""))-1;this.cursor_path=r[s].data.path;break}a=a.slice(0,-1)}}}navigate_down(){let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const r=e._traverse_path(a.slice(0,-1))?.children;if(r&&r.length>1){let s=r?.findIndex(i=>i.data.path.join("")===a.join(""))+1;this.cursor_path=r[s].data.path;break}a=a.slice(0,-1)}}}}const rt=h=>{let t;return I(()=>{let e=h.lala.cursor_path,a=t.parentElement;if(!a)return;const r=t.querySelector(".on_path_end");if(!r){a.scrollTop=e.length>0?99999:0;return}let s=r.offsetTop-a.offsetHeight/2+r.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=q();return M(a=>t=a,e),_(e,n(m,{get when(){return h.lala.tree},get fallback(){return[]},children:a=>n(E,{on_set_path:r=>h.lala.try_set_cursor_path(r),get cursor_path(){return h.lala.cursor_path},get hidden_paths(){return h.lala.hidden_paths},get revealed_paths(){return h.lala.revealed_paths},get solved_paths(){return h.lala.solved_paths_expanded},get failed_paths(){return h.lala.failed_paths},get lines(){return[a().root]}})})),e})()},E=h=>n(j,{get each(){return h.lines},children:t=>[n($,d({get data(){return t.data}},h)),n(T,{get children(){return[n(v,{get when(){return t.children.length===1},get children(){return n(E,d(h,{get lines(){return t.children}}))}}),n(v,{get when(){return t.children.length>1},get children(){var e=C();return _(e,n(j,{get each(){return t.children},children:a=>(()=>{var r=R();return _(r,n(E,d(h,{lines:[a],show_index:!0}))),r})()})),e}})]}})]}),$=h=>{let t=`${Math.ceil(h.data.ply/2)}.`;h.data.ply%2===0&&(t+="..");let e=o(()=>h.cursor_path.join("").startsWith(h.data.path.join(""))),a=o(()=>h.cursor_path.join("")===h.data.path.join("")),r=o(()=>h.data.path.join("")),s=o(()=>h.hidden_paths.find(l=>l.join("")===r())),i=o(()=>h.hidden_paths.find(l=>r().startsWith(l.join("")))),x=o(()=>h.revealed_paths.find(l=>l.join("")===r())),p=o(()=>h.failed_paths.find(l=>l.join("")===r())),b=o(()=>h.solved_paths.find(l=>l.join("")===r())),H=o(()=>["move",a()?"on_path_end":e()?"on_path":"",s()?"on_hidden_path_start":i()?"on_hidden_path":"",x()?"on_revealed_path":"",p()?"on_failed_path":"",b()?"on_solved_path":"",h.collapsed?"collapsed":""].join(" "));return(()=>{var l=P();return l.$$click=()=>h.on_set_path(h.data.path),_(l,n(m,{get when(){return h.show_index||h.data.ply&1},get children(){var W=K();return _(W,t),W}}),null),_(l,()=>h.data.san,null),N(()=>z(l,H())),l})()},ht=h=>{let t;return I(()=>{let e=h.lala.cursor_path,a=t.parentElement;if(!a)return;const r=t.querySelector(".on_path_end");if(!r){a.scrollTop=e.length>0?99999:0;return}let s=r.offsetTop-a.offsetHeight/2+r.offsetHeight;a.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=q();return M(a=>t=a,e),_(e,n(m,{get when(){return h.lala.tree},get fallback(){return[]},children:a=>n(g,{on_set_path:r=>h.lala.try_set_cursor_path(r),get cursor_path(){return h.lala.cursor_path},get hidden_paths(){return h.lala.hidden_paths},get revealed_paths(){return h.lala.revealed_paths},get solved_paths(){return h.lala.solved_paths_expanded},get failed_paths(){return h.lala.failed_paths},get lines(){return[a().root]}})})),e})()},V=h=>{let t=0;for(;h!==void 0;)if(h.children.length>1||(h=h.children[0],t++>5))return!1;return!0},g=h=>{let t=h.hide_data;return h.hide_data=void 0,n(j,{get each(){return h.lines},children:e=>[n(m,{when:!t,get children(){return n($,d({get data(){return e.data}},h))}}),n(T,{get children(){return[n(v,{get when(){return e.children.length===1},get children(){return n(g,d(h,{get lines(){return e.children},show_index:!1}))}}),n(v,{get when(){return o(()=>e.children.length===2)()&&V(e.children[1])},get children(){return[n($,d({get data(){return e.children[0].data}},h,{show_index:!1})),(()=>{var a=Q();return _(a,n(g,d(h,{get lines(){return[e.children[1]]},show_index:!0}))),a})(),n(g,d(h,{get lines(){return[e.children[0]]},hide_data:!0}))]}}),n(v,{get when(){return e.children.length>1},get children(){var a=C();return _(a,n(j,{get each(){return e.children},children:r=>(()=>{var s=R();return _(s,n(m,{get when(){return h.cursor_path.join("").startsWith(r.data.path.join(""))},get fallback(){return n(X,d(h,{lines:[r],show_index:!0}))},get children(){return n(g,d(h,{lines:[r],show_index:!0}))}})),s})()})),a}})]}})]})},X=h=>n(j,{get each(){return h.lines},children:t=>[n($,d({get data(){return t.data}},h,{collapsed:!0})),(()=>{var e=U(),a=e.firstChild,r=a.nextSibling;return r.nextSibling,_(e,()=>t.length,r),_(e,()=>t.nb_first_variations,null),e})()]});function Y(h){const t=h.map((s,i)=>1/(i+h.length)),e=t.reduce((s,i)=>s+i,0),a=Math.random()*e;let r=0;for(let s=0;s<h.length;s++)if(r+=t[s],a<r)return h[s]}const Z=h=>{let t=h.uci.slice(0,2),e=h.uci[3];if(h.san==="O-O")return t+"g"+e;if(h.san==="O-O-O")return t+"c"+e};L(["click"]);export{ht as C,O as T,w as a,rt as b,k as c};
