var F=Object.defineProperty;var z=(h,t,e)=>t in h?F(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var o=(h,t,e)=>(z(h,typeof t!="symbol"?t+"":t,e),e);import{d as A,l as m,n as D,v as g,m as q,r as C,i as p,c as l,S as x,z as u,e as R,M as w,F as $,b as f,f as B,g as G,t as v}from"./index-Bc3TZFCc.js";import"./Shalala-3uGAPdAg.js";import{I,f as J,a as K}from"./chess_pgn_logic-CRDi3fUE.js";const P=(h=1)=>()=>{var t=Math.sin(h++)*1e4;return t-Math.floor(t)},Q=P();function U(h,t=Q){return Math.floor(t()*h)}function S(h){return h[U(h.length)]}var O=v("<div class=chesstree>"),H=v("<div class=lines>"),L=v("<div class=line>"),V=v("<span class=index>"),X=v("<div>"),Y=v("<span class=collapsed> ..<!> ");const y=h=>{let t=[];for(let e of h)t.length===0?t.push([e]):t.push([...t[t.length-1],e]);return t};class b{constructor(){o(this,"_paths");this._paths=m([],{equals:!1})}static set_for_saving(t){let e=new b;return e.paths=t,e}get paths(){return this._paths[0]()}set paths(t){this._paths[1](t)}get clone(){let t=new b;return t.paths=this.paths.slice(0),t}get_for_saving(){return this.paths}merge_dup(t){t.paths.forEach(e=>D(()=>this.add_path(e)))}replace_all(t){this.paths=t.paths.slice(0)}add_path(t){let e=this.paths;e.find(r=>r.join("")===t.join(""))||(e.push(t),this.paths=e)}remove_path(t){this.paths=this.paths.filter(e=>e.join("")!==t.join(""))}clear(){this.paths=[]}}const E=class E{constructor(t,e){o(this,"_tree");o(this,"_cursor_path");o(this,"_hidden_paths");o(this,"_revealed_paths");o(this,"_failed_paths");o(this,"_solved_paths");o(this,"reveal_hidden_paths",()=>{g(()=>{this.hidden_paths.forEach(t=>{this.revealed_paths.push(t)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})});o(this,"reveal_one_random",()=>{var r,a;if(!this.tree)return!1;const t=((a=(r=this.tree)==null?void 0:r._traverse_path(this.cursor_path))==null?void 0:a.children)??[this.tree.root],e=et(t);return e?(g(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(s=>this._hidden_paths.add_path(s.data.path)),this.cursor_path=e.data.path}),!0):!1});o(this,"try_next_uci_fail",t=>{var s,n,i;if(!this.tree)return!1;const e=((s=this.tree)==null?void 0:s._traverse_path(this.cursor_path))??this.tree.root,r=((i=(n=this.tree)==null?void 0:n._traverse_path(this.cursor_path))==null?void 0:i.children)??[this.tree.root],a=r.find(_=>_.data.uci===t)??r.find(_=>at(_.data)===t);if(a)return this.failed_paths.find(c=>c.join("")===a.data.path.join(""))?(this.cursor_path=a.data.path,!1):(g(()=>{this._hidden_paths.remove_path(a.data.path),a.children.forEach(c=>this._hidden_paths.add_path(c.data.path)),this._solved_paths.add_path(a.data.path),this.cursor_path=a.data.path}),!0);if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.add_failed_path([...e.data.path,t]),!1});o(this,"on_wheel",t=>{var r;let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let a=this.tree;if(a){let s;e.length===0?s=[a.root]:s=(r=a._traverse_path(e))==null?void 0:r.children;let n=s==null?void 0:s.map(i=>i.data.path).find(i=>{var _;return!((_=this.hidden_paths)!=null&&_.some(c=>i.join("").startsWith(c.join(""))))});n&&this.try_set_cursor_path(n)}}});this.initial_fen=t,this._cursor_path=m([],{equals:!1}),this._tree=m(e),this._hidden_paths=new b,this._revealed_paths=m([],{equals:!1}),this._failed_paths=m([],{equals:!1}),this._solved_paths=new b}get cursor_after_color(){var e,r;let t=this.cursor_path;return J(((r=(e=this.tree)==null?void 0:e.get_at(t))==null?void 0:r.after_fen)??I)}get is_cursor_path_at_a_leaf(){var e,r;let t=this.cursor_path;return this.failed_paths.find(a=>a.join("")===t.join(""))?!1:((r=(e=this.tree)==null?void 0:e.get_children(t))==null?void 0:r.length)===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let r=e.after_fen,a=e.uci;return[r,a]}}collect_branch_sums(t){if(!this.tree)return[];let e=[],r=[this.tree.root],a=!1;for(let s of t){let n=r.find(_=>_.data.uci===s);if(!n)return;a&&(e.push(n.data),a=!1),n.children.filter(_=>!this.failed_paths.some(c=>c.join("")===_.data.path.join(""))).length>1&&(a=!0),r=n.children}return e}clear_failed_paths(){g(()=>{this.failed_paths.forEach(t=>{var e;(e=this.tree)==null||e.delete_at(t)}),this.failed_paths=[]})}try_set_cursor_path(t){return this.hidden_paths.find(r=>t.join("").startsWith(r.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let t=S(this.tree.all_leaves.map(a=>a.path)),e=S(y(t).slice(1,-1));this.solved_paths.paths.find(a=>a.join("")===e.join(""))&&(e=S(y(t).slice(1,-1))),this.cursor_path=e;let r=this.tree.get_children(e);this._hidden_paths.clear(),r==null||r.forEach(a=>this._hidden_paths.add_path(a.path))}add_and_reveal_uci(t){this.revealed_paths.push(this.add_uci(t)),this.revealed_paths=this.revealed_paths}add_failed_path(t){let e=this.failed_paths;e=e.filter(r=>r.join("")!==t.join("")),e.push(t),this.failed_paths=e}add_uci(t){let e=this.tree,r=this.cursor_path;return e?e.append_uci(t,r):e=K.make(this.initial_fen,[t]),r=[...r,t],g(()=>{this.tree=e,this.cursor_path=r}),r}drop_failed_paths(){return g(()=>{var r;let t=this.failed_paths;t.forEach(a=>{var s;return(s=this.tree)==null?void 0:s.delete_at(a)});let e=this.cursor_path;for(;e.length>0&&!((r=this.tree)!=null&&r.get_at(e));)e.pop();return this.cursor_path=e,this.failed_paths=[],t})}get can_navigate_next(){var r;let t=this.cursor_path,e=this.tree;if(e){let a;return t.length===0?a=[e.root]:a=(r=e._traverse_path(t))==null?void 0:r.children,(a==null?void 0:a.map(n=>n.data.path).find(n=>{var i;return!((i=this.hidden_paths)!=null&&i.some(_=>n.join("").startsWith(_.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_first(){let t=y(this.cursor_path).reverse().slice(1),e=(t.find(r=>{var a;return(((a=this.tree.get_children(r.slice(0,-1)))==null?void 0:a.length)??0)>1})||t[t.length-1])??[];this.try_set_cursor_path(e)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){var r;let t=this.cursor_path,e=this.tree;if(e){let a;t.length===0?a=[e.root]:a=(r=e._traverse_path(t))==null?void 0:r.children;let s=a==null?void 0:a.map(n=>n.data.path).find(n=>{var i;return!((i=this.hidden_paths)!=null&&i.some(_=>n.join("").startsWith(_.join(""))))});s&&this.try_set_cursor_path(s)}}navigate_last(){var r,a;let t=this.cursor_path,e=this.tree;if(e){let s;t.length===0?s=[e.root]:s=(r=e._traverse_path(t))==null?void 0:r.children;let n=s==null?void 0:s.map(i=>i.data.path).find(i=>{var _;return!((_=this.hidden_paths)!=null&&_.some(c=>i.join("").startsWith(c.join(""))))});if(n){let i=e._traverse_path(n);for(;i.children.length===1&&!((a=this.hidden_paths)!=null&&a.some(_=>i.children[0].data.path.join("").startsWith(_.join(""))));)i=i.children[0];n=i.data.path,this.try_set_cursor_path(n)}}}get can_navigate_up(){var r;let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const s=(r=e._traverse_path(a.slice(0,-1)))==null?void 0:r.children;if(s&&s.length>1)return(s==null?void 0:s.findIndex(i=>i.data.path.join("")===a.join("")))-1>=0;a=a.slice(0,-1)}}return!1}get can_navigate_down(){var r;let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const s=(r=e._traverse_path(a.slice(0,-1)))==null?void 0:r.children;if(s&&s.length>1)return(s==null?void 0:s.findIndex(i=>i.data.path.join("")===a.join("")))+1<s.length;a=a.slice(0,-1)}}}navigate_up(){var r;let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const s=(r=e._traverse_path(a.slice(0,-1)))==null?void 0:r.children;if(s&&s.length>1){let n=(s==null?void 0:s.findIndex(i=>i.data.path.join("")===a.join("")))-1;this.cursor_path=s[n].data.path;break}a=a.slice(0,-1)}}}navigate_down(){var r;let t=this.cursor_path,e=this.tree;if(e){let a=t;for(;a.length>0;){const s=(r=e._traverse_path(a.slice(0,-1)))==null?void 0:r.children;if(s&&s.length>1){let n=(s==null?void 0:s.findIndex(i=>i.data.path.join("")===a.join("")))+1;this.cursor_path=s[n].data.path;break}a=a.slice(0,-1)}}}};o(E,"make",(t,e=(t==null?void 0:t.root.data.before_fen)||I)=>new E(e,t));let T=E;const nt=h=>{let t;return q(()=>{let e=h.lala.cursor_path,r=t.parentElement;if(!r)return;const a=t.querySelector(".on_path_end");if(!a){r.scrollTop=e.length>0?99999:0;return}let s=a.offsetTop-r.offsetHeight/2+a.offsetHeight;r.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=O();return C(r=>t=r,e),p(e,l(x,{get when(){return h.lala.tree},get fallback(){return[]},children:r=>l(M,{on_set_path:a=>h.lala.try_set_cursor_path(a),get cursor_path(){return h.lala.cursor_path},get hidden_paths(){return h.lala.hidden_paths},get revealed_paths(){return h.lala.revealed_paths},get solved_paths(){return h.lala.solved_paths_expanded},get failed_paths(){return h.lala.failed_paths},get lines(){return[r().root]}})})),e})()},M=h=>l($,{get each(){return h.lines},children:t=>[l(k,u({get data(){return t.data}},h)),l(R,{get children(){return[l(w,{get when(){return t.children.length===1},get children(){return l(M,u(h,{get lines(){return t.children}}))}}),l(w,{get when(){return t.children.length>1},get children(){var e=H();return p(e,l($,{get each(){return t.children},children:r=>(()=>{var a=L();return p(a,l(M,u(h,{lines:[r],show_index:!0}))),a})()})),e}})]}})]}),k=h=>{let t=`${Math.ceil(h.data.ply/2)}.`;h.data.ply%2===0&&(t+="..");let e=f(()=>h.cursor_path.join("").startsWith(h.data.path.join(""))),r=f(()=>h.cursor_path.join("")===h.data.path.join("")),a=f(()=>h.data.path.join("")),s=f(()=>h.hidden_paths.find(d=>d.join("")===a())),n=f(()=>h.hidden_paths.find(d=>a().startsWith(d.join("")))),i=f(()=>h.revealed_paths.find(d=>d.join("")===a())),_=f(()=>h.failed_paths.find(d=>d.join("")===a())),c=f(()=>h.solved_paths.find(d=>d.join("")===a())),N=f(()=>["move",r()?"on_path_end":e()?"on_path":"",s()?"on_hidden_path_start":n()?"on_hidden_path":"",i()?"on_revealed_path":"",_()?"on_failed_path":"",c()?"on_solved_path":"",h.collapsed?"collapsed":""].join(" "));return(()=>{var d=X();return d.$$click=()=>h.on_set_path(h.data.path),p(d,l(x,{get when(){return h.show_index||h.data.ply&1},get children(){var W=V();return p(W,t),W}}),null),p(d,()=>h.data.san,null),B(()=>G(d,N())),d})()},lt=h=>{let t;return q(()=>{let e=h.lala.cursor_path,r=t.parentElement;if(!r)return;const a=t.querySelector(".on_path_end");if(!a){r.scrollTop=e.length>0?99999:0;return}let s=a.offsetTop-r.offsetHeight/2+a.offsetHeight;r.scrollTo({behavior:"smooth",top:s})}),(()=>{var e=O();return C(r=>t=r,e),p(e,l(x,{get when(){return h.lala.tree},get fallback(){return[]},children:r=>l(j,{on_set_path:a=>h.lala.try_set_cursor_path(a),get cursor_path(){return h.lala.cursor_path},get hidden_paths(){return h.lala.hidden_paths},get revealed_paths(){return h.lala.revealed_paths},get solved_paths(){return h.lala.solved_paths_expanded},get failed_paths(){return h.lala.failed_paths},get lines(){return[r().root]}})})),e})()},Z=h=>{let t=0;for(;h!==void 0;)if(h.children.length>1||(h=h.children[0],t++>5))return!1;return!0},j=h=>{let t=h.hide_data;return h.hide_data=void 0,l($,{get each(){return h.lines},children:e=>[l(x,{when:!t,get children(){return l(k,u({get data(){return e.data}},h))}}),l(R,{get children(){return[l(w,{get when(){return e.children.length===1},get children(){return l(j,u(h,{get lines(){return e.children},show_index:!1}))}}),l(w,{get when(){return f(()=>e.children.length===2)()&&Z(e.children[1])},get children(){return[l(k,u({get data(){return e.children[0].data}},h,{show_index:!1})),"(",l(j,u(h,{get lines(){return[e.children[1]]},show_index:!0})),")",l(j,u(h,{get lines(){return[e.children[0]]},hide_data:!0}))]}}),l(w,{get when(){return e.children.length>1},get children(){var r=H();return p(r,l($,{get each(){return e.children},children:a=>(()=>{var s=L();return p(s,l(x,{get when(){return h.cursor_path.join("").startsWith(a.data.path.join(""))},get fallback(){return l(tt,u(h,{lines:[a],show_index:!0}))},get children(){return l(j,u(h,{lines:[a],show_index:!0}))}})),s})()})),r}})]}})]})},tt=h=>l($,{get each(){return h.lines},children:t=>[l(k,u({get data(){return t.data}},h,{collapsed:!0})),(()=>{var e=Y(),r=e.firstChild,a=r.nextSibling;return a.nextSibling,p(e,()=>t.length,a),p(e,()=>t.nb_first_variations,null),e})()]});function et(h){let t=h.length*(h.length+1)/2,e=Math.floor(Math.random()*t)+1,r=0;for(let a=0;a<h.length;a++)if(r+=h.length-a,e<=r)return h[a]}const at=h=>{let t=h.uci.slice(0,2),e=h.uci[3];if(h.san==="O-O")return t+"g"+e;if(h.san==="O-O-O")return t+"c"+e};A(["click"]);export{lt as C,T,b as a,nt as b,S as c};
