var A=Object.defineProperty;var D=(s,t,e)=>t in s?A(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var o=(s,t,e)=>(D(s,typeof t!="symbol"?t+"":t,e),e);import{d as P,w as g,l as v,n as S,m as I,r as R,i as c,c as i,S as x,y as f,e as O,M as j,F as w,b as p,f as z,g as B,t as m}from"./index-x5czFUjk.js";import"./Shalala-CrmUKgKt.js";import{I as M,f as G,a as J}from"./chess_pgn_logic-B1pMWR9p.js";const K=(s=1)=>()=>{var t=Math.sin(s++)*1e4;return t-Math.floor(t)},Q=K();function U(s,t=Q){return Math.floor(t()*s)}function T(s){return s[U(s.length)]}var H=m("<div class=chesstree>"),L=m("<div class=lines>"),N=m("<div class=line>"),V=m("<span class=index>"),X=m("<div>"),Y=m("<span class=collapsed> ..<!> ");const q=s=>{let t=[];for(let e of s)t.length===0?t.push([e]):t.push([...t[t.length-1],e]);return t};class b{constructor(){o(this,"_blacks");o(this,"_whites");this._blacks=v([],{equals:!1}),this._whites=v([],{equals:!1})}replace_all(t){this.blacks=t.blacks.slice(0),this.whites=t.whites.slice(0)}merge_dup(t){g(()=>{t.paths.forEach(e=>this.add_path(e))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(t){let e=new b;return e.blacks=t[0],e.whites=t[1],e}set blacks(t){this._blacks[1](t)}set whites(t){this._whites[1](t)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let t=[];return this.whites.forEach(e=>{for(let a=0;a<=e.length-1;a+=2){let r=e.slice(0,a+1);t=t.filter(h=>h.join("")!==r.join("")),t.push(r)}}),this.blacks.forEach(e=>{for(let a=1;a<=e.length-1;a+=2){let r=e.slice(0,a+1);t=t.filter(h=>h.join("")!==r.join("")),t.push(r)}}),t}clear(){this.blacks=[],this.whites=[]}remove_path(t){S(()=>{if(t.length%2===0){let e=this.blacks;e=e.filter(a=>a.join("")!==t.join("")),this.blacks=e}else{let e=this.whites;e=e.filter(a=>a.join("")!==t.join("")),this.whites=e}})}add_path(t){S(()=>{if(t.length%2===0){let e=this.blacks;if(e.find(r=>r.join("").startsWith(t.join(""))))return;let a=e.findIndex(r=>t.join("").startsWith(r.join("")));a!==-1?e.splice(a,1,t):e.push(t),this.blacks=e}else{let e=this.whites;if(e.find(r=>r.join("").startsWith(t.join(""))))return;let a=e.findIndex(r=>t.join("").startsWith(r.join("")));a!==-1?e.splice(a,1,t):e.push(t),this.whites=e}})}}const k=class k{constructor(t,e){o(this,"_tree");o(this,"_cursor_path");o(this,"_hidden_paths");o(this,"_revealed_paths");o(this,"_failed_paths");o(this,"_solved_paths");o(this,"reveal_hidden_paths",()=>{g(()=>{this.hidden_paths.forEach(t=>{this.revealed_paths.push(t)}),this._hidden_paths.clear(),this.revealed_paths=this.revealed_paths})});o(this,"reveal_one_random",()=>{var a,r;if(!this.tree)return!1;const t=((r=(a=this.tree)==null?void 0:a._traverse_path(this.cursor_path))==null?void 0:r.children)??[this.tree.root],e=tt(t);return e?(g(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(h=>this._hidden_paths.add_path(h.data.path)),this.cursor_path=e.data.path}),!0):!1});o(this,"try_next_uci_fail",t=>{var h,l,n;if(!this.tree)return!1;const e=((h=this.tree)==null?void 0:h._traverse_path(this.cursor_path))??this.tree.root,a=((n=(l=this.tree)==null?void 0:l._traverse_path(this.cursor_path))==null?void 0:n.children)??[this.tree.root],r=a.find(_=>_.data.uci===t)??a.find(_=>et(_.data)===t);if(r){if(this.failed_paths.find(u=>u.join("")===r.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return g(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(u=>this._hidden_paths.add_path(u.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this.add_failed_path([...e.data.path,t]),!1}});o(this,"on_wheel",t=>{var a;let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let r=this.tree;if(r){let h;e.length===0?h=[r.root]:h=(a=r._traverse_path(e))==null?void 0:a.children;let l=h==null?void 0:h.map(n=>n.data.path).find(n=>{var _;return!((_=this.hidden_paths)!=null&&_.some(u=>n.join("").startsWith(u.join(""))))});l&&this.try_set_cursor_path(l)}}});this.initial_fen=t,this._cursor_path=v([],{equals:!1}),this._tree=v(e),this._hidden_paths=new b,this._revealed_paths=v([],{equals:!1}),this._failed_paths=v([],{equals:!1}),this._solved_paths=new b}get cursor_after_color(){var e,a;let t=this.cursor_path;return G(((a=(e=this.tree)==null?void 0:e.get_at(t))==null?void 0:a.after_fen)??M)}get is_cursor_path_at_a_leaf(){var e,a;let t=this.cursor_path;return((a=(e=this.tree)==null?void 0:e.get_children(t))==null?void 0:a.length)===0}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths[0]()}set revealed_paths(t){this._revealed_paths[1](t)}get failed_paths(){return this._failed_paths[0]()}set failed_paths(t){this._failed_paths[1](t)}get solved_paths(){return this._solved_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let a=e.after_fen,r=e.uci;return[a,r]}}try_set_cursor_path(t){return this.hidden_paths.find(a=>t.join("").startsWith(a.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}set_random_cursor_hide_rest(){let t=T(this.tree.all_leaves.map(r=>r.path)),e=T(q(t).slice(1,-1));this.cursor_path=e;let a=this.tree.get_children(e);this._hidden_paths.clear(),a==null||a.forEach(r=>this._hidden_paths.add_path(r.path))}add_and_reveal_uci(t){this.revealed_paths.push(this.add_uci(t)),this.revealed_paths=this.revealed_paths}add_failed_path(t){let e=this.failed_paths;e=e.filter(a=>a.join("")!==t.join("")),e.push(t),this.failed_paths=e}add_uci(t){let e=this.tree,a=this.cursor_path;return e?e.append_uci(t,a):e=J.make(this.initial_fen,[t]),a=[...a,t],g(()=>{this.tree=e,this.cursor_path=a}),a}drop_failed_paths(){return g(()=>{var a;let t=this.failed_paths;t.forEach(r=>{var h;return(h=this.tree)==null?void 0:h.delete_at(r)});let e=this.cursor_path;for(;e.length>0&&!((a=this.tree)!=null&&a.get_at(e));)e.pop();return this.cursor_path=e,this.failed_paths=[],t})}get can_navigate_next(){var a;let t=this.cursor_path,e=this.tree;if(e){let r;return t.length===0?r=[e.root]:r=(a=e._traverse_path(t))==null?void 0:a.children,(r==null?void 0:r.map(l=>l.data.path).find(l=>{var n;return!((n=this.hidden_paths)!=null&&n.some(_=>l.join("").startsWith(_.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_first(){let t=q(this.cursor_path).reverse().slice(1),e=(t.find(a=>{var r;return(((r=this.tree.get_children(a.slice(0,-1)))==null?void 0:r.length)??0)>1})||t[t.length-1])??[];this.try_set_cursor_path(e)}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_next(){var a;let t=this.cursor_path,e=this.tree;if(e){let r;t.length===0?r=[e.root]:r=(a=e._traverse_path(t))==null?void 0:a.children;let h=r==null?void 0:r.map(l=>l.data.path).find(l=>{var n;return!((n=this.hidden_paths)!=null&&n.some(_=>l.join("").startsWith(_.join(""))))});h&&this.try_set_cursor_path(h)}}navigate_last(){var a,r;let t=this.cursor_path,e=this.tree;if(e){let h;t.length===0?h=[e.root]:h=(a=e._traverse_path(t))==null?void 0:a.children;let l=h==null?void 0:h.map(n=>n.data.path).find(n=>{var _;return!((_=this.hidden_paths)!=null&&_.some(u=>n.join("").startsWith(u.join(""))))});if(l){let n=e._traverse_path(l);for(;n.children.length>0&&!((r=this.hidden_paths)!=null&&r.some(_=>n.children[0].data.path.join("").startsWith(_.join(""))));)n=n.children[0];l=n.data.path,this.try_set_cursor_path(l)}}}};o(k,"make",(t,e=(t==null?void 0:t.root.data.before_fen)||M)=>new k(e,t));let C=k;const it=s=>{let t;return I(()=>{let e=s.lala.cursor_path,a=t.parentElement;if(!a)return;const r=t.querySelector(".on_path_end");if(!r){a.scrollTop=e.length>0?99999:0;return}let h=r.offsetTop-a.offsetHeight/2+r.offsetHeight;a.scrollTo({behavior:"smooth",top:h})}),(()=>{var e=H();return R(a=>t=a,e),c(e,i(x,{get when(){return s.lala.tree},get fallback(){return[]},children:a=>i($,{on_set_path:r=>s.lala.try_set_cursor_path(r),get cursor_path(){return s.lala.cursor_path},get hidden_paths(){return s.lala.hidden_paths},get revealed_paths(){return s.lala.revealed_paths},get solved_paths(){return s.lala.solved_paths_expanded},get failed_paths(){return s.lala.failed_paths},get lines(){return[a().root]}})})),e})()},$=s=>i(w,{get each(){return s.lines},children:t=>[i(W,f({get data(){return t.data}},s)),i(O,{get children(){return[i(j,{get when(){return t.children.length===1},get children(){return i($,f(s,{get lines(){return t.children}}))}}),i(j,{get when(){return t.children.length>1},get children(){var e=L();return c(e,i(w,{get each(){return t.children},children:a=>(()=>{var r=N();return c(r,i($,f(s,{lines:[a],show_index:!0}))),r})()})),e}})]}})]}),W=s=>{let t=`${Math.ceil(s.data.ply/2)}.`;s.data.ply%2===0&&(t+="..");let e=p(()=>s.cursor_path.join("").startsWith(s.data.path.join(""))),a=p(()=>s.cursor_path.join("")===s.data.path.join("")),r=p(()=>s.data.path.join("")),h=p(()=>s.hidden_paths.find(d=>d.join("")===r())),l=p(()=>s.hidden_paths.find(d=>r().startsWith(d.join("")))),n=p(()=>s.revealed_paths.find(d=>d.join("")===r())),_=p(()=>s.failed_paths.find(d=>d.join("")===r())),u=p(()=>s.solved_paths.find(d=>d.join("")===r())),F=p(()=>["move",a()?"on_path_end":e()?"on_path":"",h()?"on_hidden_path_start":l()?"on_hidden_path":"",n()?"on_revealed_path":"",_()?"on_failed_path":"",u()?"on_solved_path":"",s.collapsed?"collapsed":""].join(" "));return(()=>{var d=X();return d.$$click=()=>s.on_set_path(s.data.path),c(d,i(x,{get when(){return s.show_index||s.data.ply&1},get children(){var y=V();return c(y,t),y}}),null),c(d,()=>s.data.san,null),z(()=>B(d,F())),d})()},nt=s=>{let t;return I(()=>{let e=s.lala.cursor_path,a=t.parentElement;if(!a)return;const r=t.querySelector(".on_path_end");if(!r){a.scrollTop=e.length>0?99999:0;return}let h=r.offsetTop-a.offsetHeight/2+r.offsetHeight;a.scrollTo({behavior:"smooth",top:h})}),(()=>{var e=H();return R(a=>t=a,e),c(e,i(x,{get when(){return s.lala.tree},get fallback(){return[]},children:a=>i(E,{on_set_path:r=>s.lala.try_set_cursor_path(r),get cursor_path(){return s.lala.cursor_path},get hidden_paths(){return s.lala.hidden_paths},get revealed_paths(){return s.lala.revealed_paths},get solved_paths(){return s.lala.solved_paths_expanded},get failed_paths(){return s.lala.failed_paths},get lines(){return[a().root]}})})),e})()},E=s=>i(w,{get each(){return s.lines},children:t=>[i(W,f({get data(){return t.data}},s)),i(O,{get children(){return[i(j,{get when(){return t.children.length===1},get children(){return i(E,f(s,{get lines(){return t.children},show_index:!1}))}}),i(j,{get when(){return t.children.length>1},get children(){var e=L();return c(e,i(w,{get each(){return t.children},children:a=>(()=>{var r=N();return c(r,i(x,{get when(){return s.cursor_path.join("").startsWith(a.data.path.join(""))},get fallback(){return i(Z,f(s,{lines:[a],show_index:!0}))},get children(){return i(E,f(s,{lines:[a],show_index:!0}))}})),r})()})),e}})]}})]}),Z=s=>i(w,{get each(){return s.lines},children:t=>[i(W,f({get data(){return t.data}},s,{collapsed:!0})),(()=>{var e=Y(),a=e.firstChild,r=a.nextSibling;return r.nextSibling,c(e,()=>t.length,r),c(e,()=>t.nb_first_variations,null),e})()]});function tt(s){let t=s.length*(s.length+1)/2,e=Math.floor(Math.random()*t)+1,a=0;for(let r=0;r<s.length;r++)if(a+=s.length-r,e<=a)return s[r]}const et=s=>{let t=s.uci.slice(0,2),e=s.uci[3];if(s.san==="O-O")return t+"g"+e;if(s.san==="O-O-O")return t+"c"+e};P(["click"]);export{nt as C,C as T,b as a,it as b,T as c};
