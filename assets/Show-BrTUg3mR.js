import{m as mn,C as Ot,P as Ee,n as mt,o as H,p as X,I as ee,q as k,r as ve,v as vn,R as vt,w as Ge,x as qe,y as Ve,z as j,B as bt,D as Ye,E as bn,G as it,t as h,i as u,e as T,f as se,d as Ue,H as Ze,J as Ie,K as kn,L as $n,N as Je,O as P,Q as wn,b as O,T as yn,U as st,j as Ne,V as rt,c as o,W as xe,F as we,X as qt,Y as me,Z as Cn,_ as ze,$ as Me,a0 as Ae,a1 as Sn,a2 as xn,a3 as En,k as S,l as Xe,g as oe,a4 as Ln,a5 as et,a6 as be,a7 as tt,a8 as Bt,a9 as Nt,aa as On,u as qn,ab as Pt,ac as Tt,ad as Bn,ae as Nn,af as We,ag as Pn,ah as Rt,ai as It,aj as At,ak as zt,al as Tn,am as at,an as Rn,ao as In,s as An,ap as zn}from"./index-DUzDHyUA.js";import{o as kt,C as Mn,e as $t,d as Gn,a as Mt,P as Gt,b as Ut,n as Kt}from"./random-CLip93Xk.js";const Un=e=>mn(e);class Kn extends Ee{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=mt.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():mt.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?H.err(new X(ee.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?H.err(new X(ee.Variant)):H.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,i;const s=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?k.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?k.backranks().complement():k.empty());if(t=t||this.ctx(),ve(t.king)&&t.checkers.nonEmpty()){const a=t.checkers.singleSquare();return ve(a)?s.intersect(vn(a,t.king)):k.empty()}else return s}}class Dn extends Ee{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return H.err(new X(ee.Empty));if(this.board.king.size()>2)return H.err(new X(ee.Kings));const t=this.board.kingOf(j(this.turn));return ve(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?H.err(new X(ee.OppositeCheck)):k.backranks().intersects(this.board.pawn)?H.err(new X(ee.PawnsOnBackrank)):H.ok(void 0):H.err(new X(ee.Kings))}kingAttackers(t,n,i){const s=this.board.pieces(n,"king");return s.isEmpty()||Ve(t).intersects(s)?k.empty():super.kingAttackers(t,n,i)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(const i of Ve(t).intersect(this.board.occupied).diff(this.board.pawn)){const s=this.board.take(i);s?.role==="rook"&&this.castles.discardRook(i),s?.role==="king"&&this.castles.discardColor(s.color)}}hasInsufficientMaterial(t){if(this.board.pieces(j(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[j(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(k.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(k.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(k.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let i=k.empty();for(const s of Ye(this,t,n)){const a=this.clone();a.play({from:t,to:s});const l=a.board.kingOf(this.turn);ve(l)&&(!ve(a.board.kingOf(a.turn))||a.kingAttackers(l,a.turn,a.board.occupied).isEmpty())&&(i=i.with(s))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const n of Ge)if(this.board.pieces(n,"king").isEmpty())return{winner:j(n)}}}class Wn extends Ee{constructor(){super("antichess")}reset(){super.reset(),this.castles=qe.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=qe.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?H.err(new X(ee.Empty)):k.backranks().intersects(this.board.pawn)?H.err(new X(ee.PawnsOnBackrank)):H.ok(void 0)}kingAttackers(t,n,i){return k.empty()}ctx(){const t=super.ctx();if(ve(this.epSquare)&&bn(j(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const n=this.board[j(this.turn)];for(const i of this.board[this.turn])if(Ye(this,i,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();const i=Ye(this,t,n),s=this.board[j(this.turn)];return i.intersect(n.mustCapture?ve(this.epSquare)&&this.board.getRole(t)==="pawn"?s.with(this.epSquare):s:k.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[j(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[t].intersects(k.lightSquares()),i=this.board[t].intersects(k.darkSquares()),s=this.board[j(t)].isDisjoint(k.lightSquares()),a=this.board[j(t)].isDisjoint(k.darkSquares());return n&&s||i&&a}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(k.lightSquares())!==this.board.black.intersects(k.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Qn extends Ee{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(k.center())}variantOutcome(t){for(const n of Ge)if(this.board.pieces(n,"king").intersects(k.center()))return{winner:n}}}class Fn extends Ee{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=vt.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||vt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const n of Ge)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Hn=()=>{const e=it.empty();return e.occupied=new k(65535,0),e.promoted=k.empty(),e.white=new k(61680,0),e.black=new k(3855,0),e.pawn=k.empty(),e.knight=new k(6168,0),e.bishop=new k(9252,0),e.rook=new k(16962,0),e.queen=new k(129,0),e.king=new k(33024,0),e};class jn extends Ee{constructor(){super("racingkings")}reset(){this.board=Hn(),this.pockets=void 0,this.turn="white",this.castles=qe.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=qe.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?H.err(new X(ee.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let i=k.empty();for(const s of super.dests(t,n)){const a={from:t,to:s},l=this.clone();l.play(a),l.isCheck()||(i=i.with(s))}return i}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=k.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(ve(i)){const s=this.board.occupied.without(i);for(const a of Ve(i).intersect(t).diff(this.board.black))if(this.kingAttackers(a,"white",s).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const n=k.fromRank(7),i=this.board.pieces("black","king").intersects(n),s=this.board.pieces("white","king").intersects(n);return i&&!s?{winner:"black"}:s&&!i?{winner:"white"}:{winner:void 0}}}const Vn=()=>{const e=it.empty();return e.occupied=new k(4294967295,4294901862),e.promoted=k.empty(),e.white=new k(4294967295,102),e.black=new k(0,4294901760),e.pawn=new k(4294967295,16711782),e.knight=new k(0,1107296256),e.bishop=new k(0,603979776),e.rook=new k(0,2164260864),e.queen=new k(0,134217728),e.king=new k(0,268435456),e};class Yn extends Ee{constructor(){super("horde")}reset(){this.board=Vn(),this.pockets=void 0,this.turn="white",this.castles=qe.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return H.err(new X(ee.Empty));if(this.board.king.size()!==1)return H.err(new X(ee.Kings));const t=this.board.kingOf(j(this.turn));if(ve(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return H.err(new X(ee.OppositeCheck));for(const n of Ge){const i=this.board.pieces(n,"king").isEmpty()?k.backrank(j(n)):k.backranks();if(this.board.pieces(n,"pawn").intersects(i))return H.err(new X(ee.PawnsOnBackrank))}return H.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const n=p=>p==="light"?"dark":"light",i=p=>p==="light"?k.lightSquares():k.darkSquares(),s=p=>{const f=this.board.pieces(p,"bishop");return f.intersects(k.darkSquares())&&f.intersects(k.lightSquares())},a=bt.fromBoard(this.board,t),l=p=>i(p).intersect(this.board.pieces(t,"bishop")).size(),d=l("light")>=1?"light":"dark",c=a.pawn+a.knight+a.rook+a.queen+Math.min(l("dark"),2)+Math.min(l("light"),2),r=bt.fromBoard(this.board,j(t)),g=p=>i(p).intersect(this.board.pieces(j(t),"bishop")).size(),v=r.size(),y=p=>v-p;if(c===0)return!0;if(c>=4||(a.pawn>=1||a.queen>=1)&&c>=2||a.rook>=1&&c>=2&&!(c===2&&a.rook===1&&a.bishop===1&&y(g(d))===1))return!1;if(c===1){if(v===1)return!0;if(a.queen===1)return!(r.pawn>=1||r.rook>=1||g("light")>=2||g("dark")>=2);if(a.pawn===1){const p=this.board.pieces(t,"pawn").last(),f=this.clone();f.board.set(p,{color:t,role:"queen"});const b=this.clone();return b.board.set(p,{color:t,role:"knight"}),f.hasInsufficientMaterial(t)&&b.hasInsufficientMaterial(t)}else{if(a.rook===1)return!(r.pawn>=2||r.rook>=1&&r.pawn>=1||r.rook>=1&&r.knight>=1||r.pawn>=1&&r.knight>=1);if(a.bishop===1)return!(g(n(d))>=2||g(n(d))>=1&&r.pawn>=1||r.pawn>=2);if(a.knight===1)return!(v>=4&&(r.knight>=2||r.pawn>=2||r.rook>=1&&r.knight>=1||r.rook>=1&&r.bishop>=1||r.knight>=1&&r.bishop>=1||r.rook>=1&&r.pawn>=1||r.knight>=1&&r.pawn>=1||r.bishop>=1&&r.pawn>=1||s(j(t))&&r.pawn>=1)&&(g("dark")<2||y(g("dark"))>=3)&&(g("light")<2||y(g("light"))>=3))}}else{if(c===2)return v===1?!0:a.knight===2?r.pawn+r.bishop+r.knight<1:s(t)?!(r.pawn>=1||r.bishop>=1||r.knight>=1&&r.rook+r.queen>=1):a.bishop>=1&&a.knight>=1?!(r.pawn>=1||g(n(d))>=1||y(g(d))>=3):!(r.pawn>=1&&g(n(d))>=1||r.pawn>=1&&r.knight>=1||g(n(d))>=1&&r.knight>=1||g(n(d))>=2||r.knight>=2||r.pawn>=2);if(c===3)return a.knight===2&&a.bishop===1||a.knight===3||s(t)?!1:v===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const Zn=(e,t)=>{switch(e){case"chess":return Ot.fromSetup(t);case"antichess":return Wn.fromSetup(t);case"atomic":return Dn.fromSetup(t);case"horde":return Yn.fromSetup(t);case"racingkings":return jn.fromSetup(t);case"kingofthehill":return Qn.fromSetup(t);case"3check":return Fn.fromSetup(t);case"crazyhouse":return Kn.fromSetup(t)}},Jn=(e=lt)=>({headers:e(),moves:new Dt});class Dt{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const n=t.children[0];yield n,t=n}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class Xn extends Dt{constructor(t){super(),this.data=t}}const ei=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",ti=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,lt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),wt="\uFEFF",Qe=e=>/^\s*$/.test(e),Fe=e=>e.startsWith("%");class ni extends Error{}class ii{constructor(t,n=lt,i=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Jn(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new ni("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let i=0;for(;;){const s=t.indexOf(`
`,i);if(s===-1)break;const a=s>i&&t[s-1]==="\r"?s-1:s;this.consumeBudget(s-i),this.lineBuf.push(t.slice(i,a)),i=s+1,this.handleLine()}this.consumeBudget(t.length-i),this.lineBuf.push(t.slice(i)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(wt)&&(n=n.slice(wt.length)),this.state=1;case 1:if(Qe(n)||Fe(n))return;this.found=!0,this.state=2;case 2:{if(Fe(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(s,a,l)=>(this.consumeBudget(200),this.handleHeader(a,l.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,t=!1,""));if(Qe(n))return;this.state=3}case 3:{if(t){if(Fe(n))return;if(Qe(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let s;for(;s=i.exec(n);){const a=this.stack[this.stack.length-1];let l=s[0];if(l===";")return;if(l.startsWith("$"))this.handleNag(parseInt(l.slice(1),10));else if(l==="!")this.handleNag(1);else if(l==="?")this.handleNag(2);else if(l==="!!")this.handleNag(3);else if(l==="??")this.handleNag(4);else if(l==="!?")this.handleNag(5);else if(l==="?!")this.handleNag(6);else if(l==="1-0"||l==="1–0"||l==="1—0"||l==="0-1"||l==="0–1"||l==="0—1"||l==="1/2-1/2"||l==="1/2–1/2"||l==="1/2—1/2"||l==="*")this.stack.length===1&&l!=="*"&&this.handleHeader("Result",l);else if(l==="(")this.consumeBudget(100),this.stack.push({parent:a.parent,root:!1});else if(l===")")this.stack.length>1&&this.stack.pop();else if(l==="{"){const d=i.lastIndex,c=n[d]===" "?d+1:d;n=n.slice(c),this.state=4;continue e}else this.consumeBudget(100),l.startsWith("O")||l.startsWith("0")||l.startsWith("o")?l=l.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(l==="Z0"||l==="0000"||l==="@@@@")&&(l="--"),a.node&&(a.parent=a.node),a.node=new Xn({san:l,startingComments:a.startingComments}),a.startingComments=void 0,a.root=!1,a.parent.children.push(a.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const s=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,s)),this.handleComment(),n=n.slice(i),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?ei(ti(n)):n)}handleNag(t){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],s=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((t=i.node.data).comments||(t.comments=[]),i.node.data.comments.push(s)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(s)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(s))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const si=(e,t=lt)=>{const n=[];return new ii(i=>n.push(i),t,NaN).parse(e),n};var ri=h("<div class=modal-mask><dialog open><div class=close-button-anchor><button class=close-button data-icon=></button></div><div class=scrollable><div>");function He(e){return(()=>{var t=ri(),n=t.firstChild,i=n.firstChild,s=i.firstChild,a=i.nextSibling,l=a.firstChild;return t.$$click=()=>e.on_close(),n.$$click=d=>{d.stopPropagation()},s.$$click=()=>e.on_close(),u(l,()=>e.children),T(()=>se(l,"dialog-content "+e.klass)),t})()}Ue(["click"]);const nt="ABCDEFGHIJKLMNOP".split(""),yt=e=>nt[e];function Ct(e){return Je(e.toSetup())}function St(e){return si(e).map(t=>{let n=t.headers.get("Event"),i=t.headers.get("Site"),s=t.headers.get("White"),a=t.headers.get("Black"),l=t.headers.get("Chapter"),d=t.headers.get("Orientation"),c=t.headers.get("FEN"),r=c??Ie,g=Ot.fromSetup(Ze(r).unwrap()).unwrap(),v={},y={},p={};t.moves.children.forEach(b=>{f(b,g,0,"")});function f(b,B,x,A){let z=b.data.san,U=kn(B,z),m=B.clone();m.play(U);let $=$n(U),E=b.data.nags,C=v[A];C||(C=[],v[A]=C);let N=A.length===0?$:`${A} ${$}`;C.push({path:N,ply:x+1,before_fen:Ct(B),fen:Ct(m),uci:$,san:z}),E&&(p[N]=E),b.children.forEach(w=>{f(w,m,x+1,N)})}return{event:n,site:i,white:s,black:a,chapter:l,fen:c,orientation:d,flat_steps:v,flat_nags:p,flat_comments:y}})}var ai=h(`<div class="editor is2d"><div class=board-wrap></div><div class=tools-wrap><div class=metadata><div class=color><select><option value=white>White's Turn</option><option value=black>Black's Turn</option></select></div><div class=castling><strong>Castling</strong><div><label><input type=checkbox>White O-O</label><label><input type=checkbox>O-O-O</label></div><div><label><input type=checkbox>Black O-O</label><label><input type=checkbox>O-O-O</label></div></div><div class=enpassant><label for=enpassant-select>En passant</label><select id=enpassant-select><option value selected></option></select></div></div><div class=actions><button>Starting Position</button><button>Clear Board`),li=h("<option>"),oi=h('<div class="is2d chessboard"> '),ci=h("<div>"),di=h("<div><div><div>");function ui(e){const t=g=>[...g].reduce((v,y)=>{const p=parseInt(y);return v+(p>=1?"x".repeat(p):y)},""),n=(g,v,y,p)=>{let f;for(;(f=v.exec(g))!=null;)p.add(f.index+y)},i=new Set,[s,a]=e.split(" "),l=s.split("/"),d=t(l[a==="w"?3:4]);n(d,/pP/g,a==="w"?0:1,i),n(d,/Pp/g,a==="w"?1:0,i);const[c,r]=i.size>=1?[t(l[a==="w"?1:6]),t(l[a==="w"?2:5])]:[null,null];return Array.from(i).filter(g=>c[g]==="x"&&r[g]==="x").map(g=>String.fromCharCode(97+g)+(a==="w"?"6":"3"))}const hi=e=>{const t=()=>Ie,[n,i]=P(Ie),[s,a]=P("white"),[l,d]=P(),c=["K","Q","k","q"],[r,g]=wn({Q:!1,K:!1,k:!1,q:!1}),v=O(()=>{let w="",L=r;return c.forEach(K=>{L[K]&&(w+=K)}),w}),y=O(()=>{let w=t(),L=n()??w;const K=Ze(L).unwrap(F=>F.board,F=>it.empty()),re=s(),D=yn(K,v()).unwrap();let te=l()?st(l()):void 0;return{board:K,turn:re,castlingRights:D,epSquare:te,pockets:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:0}}),p=O(()=>Je(y())),f=O(()=>Zn("chess",y()).unwrap(w=>Je(w.toSetup()),w=>{})),b=O(()=>ui(p()));Ne(()=>{e.on_change_fen(f())});const B=w=>{me(()=>{a(w.turn),d(w.epSquare?Un(w.epSquare):void 0);let L=qe.fromSetup(w);g("Q",L.rook.white.a!==void 0),g("K",L.rook.white.h!==void 0),g("q",L.rook.black.a!==void 0),g("k",L.rook.black.h!==void 0)})},x=w=>{Ze(w).unwrap(L=>(me(()=>{i(w),B(L)}),!0),L=>!1)};x(e.initial_fen);const[A,z]=P("pointer"),U=rt(A),[m,$]=P(),E=(w,L)=>{if(z(w),w!=="pointer"){if(w!=="trash"){let[K,re]=w.split(" ");$([K,re,L])}}},C=O(()=>{let w,L;switch(A()){case"pointer":L="pointer";break;case"trash":w="/cursors/trash.cur";break;default:w=`/cursors/${A().split(" ").join("-")}.cur`}if(L)return{cursor:L};if(w)return{cursor:`url('${w}'), default`}}),N=()=>{let[w,L]=A().split(" ");z(`${kt(w)} ${L}`)};return(()=>{var w=ai(),L=w.firstChild,K=L.nextSibling,re=K.firstChild,D=re.firstChild,te=D.firstChild,F=te.firstChild,Le=F.nextSibling,ke=D.nextSibling,ye=ke.firstChild,q=ye.nextSibling,M=q.firstChild,ce=M.firstChild,ae=M.nextSibling,de=ae.firstChild,Ce=q.nextSibling,ne=Ce.firstChild,ue=ne.firstChild,$e=ne.nextSibling,he=$e.firstChild,_e=ke.nextSibling,Oe=_e.firstChild,fe=Oe.nextSibling;fe.firstChild;var Ke=re.nextSibling,Pe=Ke.firstChild,De=Pe.nextSibling;return u(w,o(xt,{klass:"spare-top",get color(){return kt(e.orientation)},on_spare:E,is_selected:U}),L),u(L,o(_i,{on_set_spare:z,on_toggle_spare:N,get spare(){return A()},get orientation(){return e.orientation},on_change_fen:i,get drag_new_piece(){return m()},get fen(){return n()}})),u(w,o(xt,{klass:"spare-bottom",get color(){return e.orientation},on_spare:E,is_selected:U}),K),xe(te,"change",G=>a(G.target.value)),ce.addEventListener("change",G=>g("K",G.target.checked)),de.addEventListener("change",G=>g("Q",G.target.checked)),ue.addEventListener("change",G=>g("k",G.target.checked)),he.addEventListener("change",G=>g("q",G.target.checked)),fe.addEventListener("change",G=>d(G.target.value)),u(fe,o(we,{get each(){return b()},children:G=>(()=>{var Se=li();return Se.value=G,u(Se,G),Se})()}),null),Pe.$$click=()=>x(Ie),De.$$click=()=>x(xn),T(G=>{var Se=C(),Te=s()==="white",Re=s()==="black";return G.e=qt(w,Se,G.e),Te!==G.t&&(F.selected=G.t=Te),Re!==G.a&&(Le.selected=G.a=Re),G},{e:void 0,t:void 0,a:void 0}),T(()=>ce.checked=r.K),T(()=>de.checked=r.Q),T(()=>ue.checked=r.k),T(()=>he.checked=r.q),w})()};function _i(e){const t=()=>{e.on_change_fen(i.getFen())};let n,i;return ze(()=>{let s={fen:e.fen,orientation:e.orientation,autoCastle:!1,movable:{free:!0,color:"both"},draggable:{showGhost:!0,deleteOnDropOff:!0},premovable:{enabled:!1},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:t}};i=Mn(n,s);const a=c=>{let r=e.spare;r!=="pointer"&&c.preventDefault();const g=$t(c);if(!g)return;let v=i.getKeyAtDomPos(g);if(v){if(r==="trash")l(v);else if(r!=="pointer"){const y=i.state.pieces.get(v);let[p,f]=r.split(" "),b={color:p,role:f};y&&y.color===b.color&&y.role===b.role?l(v):(i.setPieces(new Map([[v,b]])),t())}}},l=c=>{i.setPieces(new Map([[c,void 0]])),t()},d=c=>{let r=e.spare;r!=="pointer"&&c.preventDefault(),r!=="pointer"&&(i.state.drawable.current=void 0,i.state.drawable.shapes=[],c.type==="contextmenu"&&r!=="trash"&&(i.cancelMove(),e.on_toggle_spare()))};n.addEventListener("mousedown",a),n.addEventListener("contextmenu",d),Me(()=>{n.removeEventListener("mousedown",a),n.removeEventListener("contextmenu",d)})}),Ne(()=>{i.set({fen:e.fen})}),Ne(()=>{i.set({orientation:e.orientation})}),Ne(()=>{let s=e.drag_new_piece;s&&(Gn(i.state,{color:s[0],role:s[1]},s[2],!0),document.addEventListener("mouseup",a=>{const l=$t(a);l&&i.getKeyAtDomPos(l)&&e.on_set_spare("pointer")},{once:!0}))}),(()=>{var s=oi();return Ae(a=>n=a,s),s})()}const xt=e=>{const t=e.is_selected;return(()=>{var n=ci();return u(n,o(je,{onClick:i=>e.on_spare("pointer",i),klass:"pointer",spare:"pointer",get selected(){return t("pointer")},get color(){return e.color}}),null),u(n,o(we,{each:Cn,children:i=>o(je,{onClick:s=>e.on_spare(`${e.color} ${i}`,s),klass:"",get spare(){return`${e.color} ${i}`},get selected(){return t(`${e.color} ${i}`)},get color(){return e.color}})}),null),u(n,o(je,{onClick:i=>e.on_spare("trash",i),klass:"trash",spare:"trash",get selected(){return t("trash")},get color(){return e.color}}),null),T(()=>se(n,"spare "+e.klass+" "+e.color)),n})()},je=e=>(()=>{var t=di(),n=t.firstChild,i=n.firstChild;return xe(t,"mousedown",e.onClick,!0),T(s=>{var a="no-square "+e.klass,l=!!e.selected,d="piece "+e.spare,c={[e.color]:!0};return a!==s.e&&se(t,s.e=a),l!==s.t&&t.classList.toggle("selected",s.t=l),d!==s.a&&se(i,s.a=d),s.o=Sn(i,c,s.o),s},{e:void 0,t:void 0,a:void 0,o:void 0}),t})();Ue(["click","mousedown"]);var fi=h("<h2>Edit Opening"),gi=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Opening Name"minlength=3>'),pi=h("<div class=section><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),ot=h("<div class=filler>"),Wt=h('<div class="group buttons"><span class=split></span><button class=delete>Delete <i data-icon=>'),mi=h("<h2>Edit Chapter"),Qt=h('<div class=group><label for=name>Name</label><input name=name id=name type=text placeholder="Section Name"minlength=3>'),vi=h("<div class=group><div class=editor-wrap>"),bi=h("<div class=tabs-wrap><div class=tabs><div class=tab>Empty</div><div class=tab>Editor</div></div><div class=content>"),Ft=h("<div class=section><div class=group><label for=order>Set Order</label><select name=order id=order></select></div><div class=group><label for=orientation>Set Orientation</label><select name=orientation id=orientation><option value=white>White</option><option value=black>Black"),ki=h('<div class="group buttons"><button class=delete>Delete <i data-icon=></i></button><span class=split></span><button class=create>Save Changes'),Ht=h("<option>"),$i=h("<h2>Edit Section"),wi=h("<div class=tabs><div class=tab>Empty</div><div class=tab>Import Lichess Study</div><div class=tab>Import PGN"),yi=h('<div class=group><label for=name>Import a Study from Lichess</label><input name=name id=name type=text placeholder="Lichess Study URL">'),Ci=h('<div class=group><label for=name>Import from PGN</label><textarea rows=10 name=name id=name placeholder="Paste PGN here.">'),Si=h("<div class=content>"),Et=h("<button class=import>Import<i data-icon=>"),Lt=h("<button class=loading disabled>Loading ...");function xi(e){const t=(l,d)=>{l==="Escape"&&(d.value=e.study.name)},n=l=>{let d=l.value;d.length<3&&(d="New Chapter",l.value=d),e.on_update_study({id:e.study.id,name:d})},i=()=>{e.on_delete_study()},s=l=>{e.on_update_study({id:e.study.id,orientation:l})},a=O(()=>e.study.orientation);return[fi(),(()=>{var l=gi(),d=l.firstChild,c=d.nextSibling;return c.addEventListener("change",r=>n(r.currentTarget)),c.$$keydown=r=>t(r.key,r.currentTarget),T(()=>c.value=e.study.name),l})(),(()=>{var l=pi(),d=l.firstChild,c=d.firstChild,r=c.nextSibling,g=r.firstChild,v=g.nextSibling;return r.addEventListener("change",y=>s(y.currentTarget.value)),T(y=>{var p=a()==="white",f=a()==="black";return p!==y.e&&(g.selected=y.e=p),f!==y.t&&(v.selected=y.t=f),y},{e:void 0,t:void 0}),l})(),ot(),(()=>{var l=Wt(),d=l.firstChild,c=d.nextSibling;return c.$$click=i,l})()]}function Ei(e){const t=(f,b)=>{f==="Escape"&&(b.value=e.chapter.name)},n=f=>{let b=f.value;b.length<3&&(b="New Chapter",f.value=b),e.on_edit_chapter({id:e.chapter.id,name:b})},i=f=>{let b=parseInt(f);e.on_order_chapter(b)},s=()=>{e.on_delete_chapter()},a=()=>{let f=c();f&&e.fen!==f&&e.on_change_root_fen(f)},l=f=>{e.on_edit_chapter({id:e.chapter.id,orientation:f})},d=O(()=>e.chapter.orientation),[c,r]=P(),[g,v]=P("editor"),y=rt(g),p=O(()=>c()??e.fen);return[mi(),(()=>{var f=Qt(),b=f.firstChild,B=b.nextSibling;return B.addEventListener("change",x=>n(x.currentTarget)),B.$$keydown=x=>t(x.key,x.currentTarget),T(()=>B.value=e.chapter.name),f})(),(()=>{var f=bi(),b=f.firstChild,B=b.firstChild,x=B.nextSibling,A=b.nextSibling;return B.$$click=()=>v("empty"),x.$$click=()=>v("editor"),u(A,o(S,{get when(){return g()==="editor"},get children(){var z=vi(),U=z.firstChild;return u(U,o(hi,{get initial_fen(){return p()},on_change_fen:r,get orientation(){return e.chapter.orientation??"white"}})),z}}),null),u(A,o(S,{get when(){return g()==="empty"},get children(){return[]}}),null),T(z=>{var U=!!y("empty"),m=!!y("editor");return U!==z.e&&B.classList.toggle("active",z.e=U),m!==z.t&&x.classList.toggle("active",z.t=m),z},{e:void 0,t:void 0}),f})(),(()=>{var f=Ft(),b=f.firstChild,B=b.firstChild,x=B.nextSibling,A=b.nextSibling,z=A.firstChild,U=z.nextSibling,m=U.firstChild,$=m.nextSibling;return x.addEventListener("change",E=>i(E.currentTarget.value)),u(x,o(we,{get each(){return[...Array(e.nb_chapters).keys()]},children:(E,C)=>(()=>{var N=Ht();return u(N,()=>C()+1),T(()=>N.selected=e.i_chapter===C()),T(()=>N.value=C()),N})()})),U.addEventListener("change",E=>l(E.currentTarget.value)),T(E=>{var C=d()==="white",N=d()==="black";return C!==E.e&&(m.selected=E.e=C),N!==E.t&&($.selected=E.t=N),E},{e:void 0,t:void 0}),f})(),ot(),(()=>{var f=ki(),b=f.firstChild,B=b.nextSibling,x=B.nextSibling;return b.$$click=s,x.$$click=a,T(()=>x.disabled=p()===void 0),f})()]}function Li(e){const t=(m,$)=>{m==="Escape"&&($.value=e.section.name)},n=m=>{let $=m.value;$.length<3&&($="New Section",m.value=$),e.on_edit_section({id:e.section.id,name:$})},i=m=>{let $=nt.indexOf(m);e.on_order_section($)},s=()=>{e.on_delete_section()},[a,l]=P("lichess"),[d,c]=P(""),r=O(()=>St(d())),g=async()=>{let m=r();m&&e.on_import_pgns(m,e.section.name)},[v,y]=P(""),p=O(()=>{let m=v().match(/\/study\/([a-zA-Z0-9]{8})\/?$/);return m?`https://lichess.org/api/study/${m[1]}.pgn`:void 0}),f=async m=>await fetch(m).then($=>$.text()).then($=>St($)),[b]=En(p,f),B=async()=>{let m=b();m&&e.on_import_pgns(m,e.section.name)},x=O(()=>p()===void 0),A=m=>{e.on_edit_section({id:e.section.id,orientation:m})},z=O(()=>e.section.orientation),U=rt(a);return[$i(),(()=>{var m=Qt(),$=m.firstChild,E=$.nextSibling;return E.addEventListener("change",C=>n(C.currentTarget)),E.$$keydown=C=>t(C.key,C.currentTarget),T(()=>E.value=e.section.name),m})(),(()=>{var m=wi(),$=m.firstChild,E=$.nextSibling,C=E.nextSibling;return $.$$click=()=>l("empty"),E.$$click=()=>l("lichess"),C.$$click=()=>l("pgn"),T(N=>{var w=!!U("empty"),L=!!U("lichess"),K=!!U("pgn");return w!==N.e&&$.classList.toggle("active",N.e=w),L!==N.t&&E.classList.toggle("active",N.t=L),K!==N.a&&C.classList.toggle("active",N.a=K),N},{e:void 0,t:void 0,a:void 0}),m})(),(()=>{var m=Si();return u(m,o(S,{get when(){return U("lichess")},get children(){var $=yi(),E=$.firstChild,C=E.nextSibling;return C.addEventListener("change",N=>y(N.target.value)),C.$$keyup=N=>y(N.currentTarget.value),T(()=>se(C,x()?"error":"success")),$}}),null),u(m,o(S,{get when(){return U("pgn")},get children(){var $=Ci(),E=$.firstChild,C=E.nextSibling;return C.addEventListener("change",N=>c(N.target.value)),$}}),null),u(m,o(S,{get when(){return U("empty")},get children(){return[]}}),null),m})(),(()=>{var m=Ft(),$=m.firstChild,E=$.firstChild,C=E.nextSibling,N=$.nextSibling,w=N.firstChild,L=w.nextSibling,K=L.firstChild,re=K.nextSibling;return C.addEventListener("change",D=>i(D.currentTarget.value)),u(C,o(we,{get each(){return nt.slice(0,e.nb_sections)},children:(D,te)=>(()=>{var F=Ht();return F.value=D,u(F,D),T(()=>F.selected=e.i_section===te()),F})()})),L.addEventListener("change",D=>A(D.currentTarget.value)),T(D=>{var te=z()==="white",F=z()==="black";return te!==D.e&&(K.selected=D.e=te),F!==D.t&&(re.selected=D.t=F),D},{e:void 0,t:void 0}),m})(),ot(),(()=>{var m=Wt(),$=m.firstChild,E=$.nextSibling;return u(m,o(S,{get when(){return a()==="pgn"},get children(){return o(Xe,{get fallback(){return Lt()},get children(){var C=Et();return C.$$click=g,T(()=>C.disabled=r()===void 0),C}})}}),E),u(m,o(S,{get when(){return a()==="lichess"},get children(){return o(Xe,{get fallback(){return Lt()},get children(){var C=Et();return C.$$click=B,T(()=>C.disabled=b()===void 0),C}})}}),E),E.$$click=s,m})()]}Ue(["keydown","click","keyup"]);var jt=h('<main class="openings-show study"><div class=details-wrap></div><div class=board-wrap></div><div class=replay-wrap><div class=header></div></div><div class=sections-wrap></div><div class=tools-wrap>'),Vt=h('<button class="feature practice"><i data-icon=>'),Oi=h("<a class=analyze data-icon=>Analyze on lichess"),qi=h("<a class=copy-line data-icon=>Copy variation PGN"),Bi=h('<a class="annotate has-sub-menu"data-icon=><i class=glyph-icon></i>Annotate Glyph'),Ni=h("<a class=delete data-icon=>Delete after this move"),Pi=h("<div class=context-sub-menu>"),Ti=h("<a><i>"),Ri=h("<h4>Take Quiz"),Ii=h("<h4>Play Deathmatch"),Ai=h("<h4>Practice with the Computer"),zi=h("<div class=practice-feature><div class=tabs><div>Practice</div></div><div>"),Mi=h("<span>End of line."),Gi=h("<div class=info-wrap><div class=status></div><div class=info><p>Computer will follow the lines in the opening.</p><p>Moves will be hidden."),Ui=h('<div class="rematch-buttons buttons"><button class=end>End</button><button class=rematch>Rematch</button><button><i>'),Ki=h("<span>Your turn."),Di=h("<span>..."),Yt=h("<span>1 of 15"),Zt=h("<button class=retake>Re-take"),Wi=h("<p>You are given 15 random positions from the opening. Play the correct moves."),Jt=h("<div class=info-wrap><div class=status></div><div class=info>"),Qi=h("<div class=quiz-history>"),Xt=h("<button class=start>Start"),en=h('<div class="quiz-buttons buttons">'),Fi=h("<div class=quiz-item>"),Hi=h("<p>You will play the moves from the opening. If you go out of book, game ends."),ji=h("<i data-icon=>"),Vi=h("<button class=new><i data-icon=></i><span>New Section"),Yi=h("<div class=sections-list><div class=header><span class=title></span><div class=tools></div></div><div class=list><div class=tools>"),ct=h("<i data-icon=>"),Zi=h("<button class=new><i data-icon=></i><span>New Chapter"),Ji=h('<div class="section active"><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis></span></div></div><div class=chapters-list><div class=list></div><div class=tools>'),Xi=h("<div><div class=title><span class=nth>."),es=h("<div class=section><div class=header><div class=title><span class=nth></span><span class=fit-ellipsis>"),ts=h("<div class=no-sections>No Sections yet."),ns=h("<div class=no-chapters>No Chapters yet."),is=h("<div class=loading-chapters>Loading Chapters."),ss=h("<div class=tabs><div><i data-icon=></i></div><div><i data-icon=>"),rs=h("<div class=settings><div class=group><label for=editable>Disable Edits</label><input id=editable type=checkbox>"),as=h("<div class=export><button>Copy PGN</button><button></button><button disabled>Export to Lichess Study"),ls=h("<div class=fen><h4>FEN"),os=h("<div class=content>"),cs=h("<div class=copy-input-text><input type=text readonly>"),ds=h("<span class=copied><i data-icon=>"),us=h("<span><i data-icon=>"),hs=h("<div class=loading>Loading");const Ns=()=>{const[e,{load_study:t}]=oe();let n=Ln();return et(()=>t(n.id)),o(fs,be(()=>_s(e,n.id)))};function _s(e,t){let n=O(()=>e.studies[t]),i=O(()=>{let d=n()?.sections;return n()?.section_ids.map(c=>d.find(r=>r.id===c))}),s=O(()=>{let d=n(),c=d?.selected_section_id;if(c)return d?.sections.find(r=>r.id===c)}),a=O(()=>{let d=s();if(d)return d.chapter_ids.map(c=>e.chapters.list.find(r=>r.id===c)).filter(Boolean)}),l=O(()=>{let c=s()?.selected_chapter_id;if(c)return a()?.find(r=>r.id===c)});return{get study(){return n()},get selected_section(){return s()},get selected_chapter(){return l()},get sections(){return i()},get chapters(){return a()}}}function fs(e){const[,{reset_replay_tree:t,load_replay_tree:n,load_chapter:i,load_chapters:s}]=oe(),[a,l]=P("show"),[,d]=at();et(tt(O(()=>e.selected_section?.id),r=>r&&d(()=>s(r)))),et(tt(O(()=>e.selected_chapter?.id),r=>{d(r?()=>{i(r),n(r)}:()=>{t()})}));const c=r=>({...e,study:r});return o(Xe,{get fallback(){return o(Ls,{})},get children(){return o(S,{get when(){return e.study},children:r=>[o(S,{get when(){return a()==="show"},get children(){return o(gs,be(()=>c(r()),{on_feature_practice:()=>l("practice")}))}}),o(S,{get when(){return a()==="practice"},get children(){return o(ps,be(()=>c(r()),{on_feature_practice_off:()=>l("show")}))}})]})}})}function gs(e){const[t,{goto_path:n,goto_path_if_can:i,delete_at_and_after_path:s,tree_step_node_set_nags:a,add_child_san_to_current_path:l,chapter_as_export_pgn:d,set_write_enabled_replay_tree:c}]=oe();c(!e.study.is_edits_disabled);let r=Bt(t);Nt(r);let[g,v]=P(),[y,p]=P(!1),[f,b]=P(!1),[B,x]=P(!1),[A,z]=P(!1);const U=O(()=>{let _=g();if(_)return On(t.replay_tree.steps_tree,_)});ze(()=>{const _=()=>{v(void 0)};document.addEventListener("click",_),Me(()=>{document.removeEventListener("click",_)})});let m,$;const E=(_,R)=>{n(R),v(R);let W=_.clientX,Z=_.clientY,V=$.getBoundingClientRect(),Y=m.getBoundingClientRect();W-=Y.left,Z-=Y.top,W=Math.min(W,document.body.clientWidth-V.width-Y.left-20);let ie=`${Z}px`,le=`${W}px`;$.style.top=ie,$.style.left=le},C=_=>{let R=_.fen;window.open(`https://lichess.org/analysis?fen=${R}`,"_blank"),v(void 0)},[,N]=at(),w=async _=>{N(()=>{s(_)}),v(void 0)};let L;const K=_=>{clearTimeout(L),L=void 0,_===!1?L=setTimeout(()=>{p(!1)},150):L=setTimeout(()=>{p(!0)},100)},re=async(_,R)=>{await a(_,[Rn(R)]),clearTimeout(L),p(!1)};let D,[te,F]=P(void 0);const Le=O(()=>{let _=te();if($===void 0||_===void 0)return"";let R=D.getBoundingClientRect(),W=_.getBoundingClientRect(),Z=$.getBoundingClientRect(),V=R.top,Y=Z.left-W.width,ie=m.getBoundingClientRect();return Y-=ie.left,V-=ie.top,`top: ${V}px; left: ${Y}px;`}),ke=_=>{i(_)};let ye=O(()=>{let _=r.step_at_cursor_path;if(!_)return[];let R=_.nags?.[0];return R?Mt(_.step.uci,_.step.san,zt(R)):[]});const q=O(()=>e.selected_chapter?.name??"[detached]"),M=O(()=>g()!==void 0||f()||B()!==void 0||A()!==void 0);let[,{create_section:ce,create_chapter:ae}]=oe();const de=async(_,R)=>{let W=B()?e.selected_section:void 0;x(!1);let Z=e.study.name,V={};G({id:e.study.id,is_edits_disabled:!0});for(let Q of _){let I=Q.event,[J,ge,pe]=I.split(":");pe||(pe=ge,ge=R),V[ge]===void 0&&(V[ge]=[]),V[ge].push([pe,Q]),Z=J}await ut({id:e.study.id,name:Z});let Y=Object.keys(V)[0];W&&await dt(e.study.id,{id:W.id,name:Y});let ie,le=W;for(Y of Object.keys(V)){W||(W=await ce(e.study.id,Y));let Q=V[Y];for(let[I,J]of Q)ie=await ae(e.study.id,W.id,I,J);le=W,W=void 0}le&&ie&&(G({id:e.study.id,selected_section_id:le.id}),fe(e.study.id,{id:le.id,selected_chapter_id:ie.id}))},Ce=()=>{},ne=async()=>{let _=await d(e.study.name,e.selected_section.name,e.selected_chapter);navigator.clipboard.writeText(_)},ue=_=>{let R=Tn(t.replay_tree.steps_tree,_);navigator.clipboard.writeText(R),v(void 0)},$e=_=>{_>0?i(r.get_next_path):i(r.get_prev_path)},he=O(()=>!e.study.is_edits_disabled),_e=_=>e.sections.indexOf(_),Oe=_=>e.chapters.indexOf(_),[,{update_section:fe,delete_section:Ke,update_chapter:Pe,delete_chapter:De,update_study:G,delete_study:Se,order_sections:Te,order_chapters:Re,change_root_fen:rn}]=oe(),dt=fe,an=(_,R)=>{Ke(_,R),x(!1)},ln=(_,R,W)=>{W.orientation&&ht(void 0),Pe(_,R,W)},on=_=>{me(()=>{De(e.study.id,e.selected_section.id,_),z(!1)})},ut=G,cn=qn(),dn=async _=>{await Se(_),cn("/openings")},un=(_,R)=>{Te(_.study_id,_.id,R)},hn=(_,R)=>{Re(e.study.id,_.section_id,_.id,R)},_n=async _=>{await rn(e.selected_chapter.id,_),z(!1)},fn=async(_,R)=>{let Z=Rt(r.fen),V=Z.turn,Y=Z.board.get(st(_)),ie=_+R;Y.role==="pawn"&&(R[1]==="8"&&V==="white"||R[1]==="1"&&V==="black")&&(ie+="q");let le=It(ie),Q=At(Z,le),I=await l(Q);n(I.step.path)},[gn,ht]=P(),_t=O(()=>gn()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),ft=_=>{_.key==="f"&&ht(j(_t()))};return ze(()=>{document.addEventListener("keydown",ft),Me(()=>{document.removeEventListener("keydown",ft)})}),(()=>{var _=jt(),R=_.firstChild,W=R.nextSibling,Z=W.nextSibling,V=Z.firstChild,Y=Z.nextSibling,ie=Y.nextSibling,le=m;return typeof le=="function"?Ae(le,_):m=_,u(R,o(nn,be(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),xe(W,"wheel",Kt($e)),u(W,o(Gt,{get orientation(){return _t()},get shapes(){return ye()},get movable(){return he()},get color(){return Pt(r.fen)},get fen(){return r.fen},get last_move(){return r.last_move},play_orig_key:fn})),u(V,q),u(Z,o(Tt,{handle_goto_path:ke,get replay_tree(){return t.replay_tree},get lose_focus(){return M()},on_context_menu:E,get features(){return(()=>{var Q=Vt();return xe(Q,"click",e.on_feature_practice,!0),Q})()}}),null),u(Y,o(tn,be(e,{get is_edits_disabled(){return e.study.is_edits_disabled},on_edit_study:()=>b(!0),on_edit_section:()=>x(!0),on_edit_chapter:()=>z(!0)}))),u(ie,o(xs,be(e,{get fen(){return r.fen},on_export_lichess:Ce,on_copy_pgn:ne}))),u(_,o(S,{get when(){return B()},get children(){return o(He,{klass:"edit-section",on_close:()=>x(!1),get children(){return o(Li,{get section(){return e.selected_section},get i_section(){return _e(e.selected_section)},get nb_sections(){return e.sections.length},on_delete_section:()=>an(e.study.id,e.selected_section.id),on_edit_section:Q=>dt(e.study.id,Q),on_order_section:Q=>un(e.selected_section,Q),on_import_pgns:de})}})}}),null),u(_,o(S,{get when(){return A()},get children(){return o(He,{klass:"edit-chapter",on_close:()=>z(!1),get children(){return o(Ei,{get fen(){return r.initial_fen},get nb_chapters(){return e.chapters.length},get chapter(){return e.selected_chapter},get i_chapter(){return Oe(e.selected_chapter)},on_edit_chapter:Q=>ln(e.study.id,e.selected_chapter.section_id,Q),on_delete_chapter:()=>on(e.selected_chapter.id),on_order_chapter:Q=>hn(e.selected_chapter,Q),on_change_root_fen:_n})}})}}),null),u(_,o(S,{get when(){return f()},get children(){return o(He,{klass:"edit-study",on_close:()=>b(!1),get children(){return o(xi,{get study(){return e.study},on_delete_study:()=>dn(e.study.id),on_update_study:ut})}})}}),null),u(_,o(S,{get when(){return U()},children:Q=>[o(Bn,{get step(){return Q().step},ref(I){var J=$;typeof J=="function"?J(I):$=I},get children(){return[(()=>{var I=Oi();return I.$$click=()=>C(Q().step),I})(),(()=>{var I=qi();return I.$$click=()=>ue(Q().step.path),I})(),o(S,{get when(){return!e.study.is_edits_disabled},get children(){return[(()=>{var I=Bi();I.addEventListener("mouseenter",()=>K(!0)),I.addEventListener("mouseleave",()=>K(!1));var J=D;return typeof J=="function"?Ae(J,I):D=I,I})(),(()=>{var I=Ni();return I.$$click=()=>w(Q().step.path),I})()]}})]}}),o(S,{get when(){return y()},get children(){var I=Pi();return Ae(J=>setTimeout(()=>F(J)),I),I.addEventListener("mouseenter",()=>K(!0)),I.addEventListener("mouseleave",()=>K(!1)),u(I,o(we,{each:Nn,children:(J,ge)=>(()=>{var pe=Ti(),pn=pe.firstChild;return pe.$$click=()=>re(Q(),J),u(pe,()=>We[ge()],null),T(Be=>{var gt="annotate glyph "+We[ge()],pt=`glyph-icon ${We[ge()]}`;return gt!==Be.e&&se(pe,Be.e=gt),pt!==Be.t&&se(pn,Be.t=pt),Be},{e:void 0,t:void 0}),pe})()})),T(J=>qt(I,Le(),J)),I}})]}),null),_})()}function ps(e){const[t,{goto_path:n,goto_path_force:i,goto_path_if_can:s,set_hide_after_path:a,add_child_san_to_success_or_error_path_no_save:l,set_write_enabled_replay_tree:d}]=oe();d(!1);let c=Bt(t);Nt(c);const[r,g]=P("practice"),v=q=>{q>0?s(c.get_next_path):s(c.get_prev_path)},[y,p]=P(),f=O(()=>y()??e.selected_chapter?.orientation??e.selected_section?.orientation??e.study.orientation??"white"),b=q=>{q.key==="f"&&me(()=>{p(j(f())),E(void 0),ye()})};ze(()=>{document.addEventListener("keydown",b),Me(()=>{document.removeEventListener("keydown",b)})});let B=O(()=>{let q=c.step_at_cursor_path;if(!q)return[];let M=q.nags?.[0];return M?Mt(q.step.uci,q.step.san,zt(M)):[]});const x=async(q,M)=>{let ae=Rt(c.fen),de=ae.turn,Ce=ae.board.get(st(q)),ne=q+M;Ce.role==="pawn"&&(M[1]==="8"&&de==="white"||M[1]==="1"&&de==="black")&&(ne+="q");let ue=It(ne),$e=At(ae,ue);re($e)},A=O(()=>e.selected_chapter?.name??"[detached]"),z=q=>{s(q)},[U,m]=P(),[$,E]=P(),[C,N]=P(!1),w=O(()=>U()===void 0&&C()&&!Le()),L=O(()=>$()??f()),K=O(()=>[]),re=async q=>{r()==="practice"&&D(q)},D=async q=>{let M=await l(q);M&&(M[0]==="error"?(i(M[1].step.path),m(setTimeout(()=>{me(()=>{n(zn(M[1].step.path)),m(void 0)})},600))):(me(()=>{i(M[1].step.path),a(M[1].step.path)}),ye()))},te=q=>{q!==void 0&&me(()=>{ke(!1),E(q),a(void 0),i(""),ye()})},F=O(()=>{let q=Pn(t.replay_tree.steps_tree,t.replay_tree.cursor_path);if(q=q.filter(M=>!t.replay_tree.error_paths.includes(M.step.path)),!(!q||q.length===0))return q}),[Le,ke]=P(!1),ye=()=>{let q=F();if(q===void 0){ke(!0);return}if(L()!==c.turn){let M=Ut(q);m(setTimeout(()=>{me(()=>{i(M.step.path),a(M.step.path),m(void 0),F()===void 0&&ke(!0)})},500))}};return(()=>{var q=jt(),M=q.firstChild,ce=M.nextSibling,ae=ce.nextSibling,de=ae.firstChild,Ce=ae.nextSibling;return u(M,o(nn,be(e,{get section(){return e.selected_section},get chapter(){return e.selected_chapter}}))),xe(ce,"wheel",Kt(v)),u(ce,o(Gt,{get orientation(){return L()},get shapes(){return B()},get movable(){return w()},get color(){return Pt(c.fen)},get fen(){return c.fen},get last_move(){return c.last_move},play_orig_key:x})),u(de,A),u(ae,o(Tt,{handle_goto_path:z,get replay_tree(){return t.replay_tree},lose_focus:!1,on_context_menu:()=>{},get features(){return(()=>{var ne=Vt();return xe(ne,"click",e.on_feature_practice_off,!0),ne})()},get feature_content(){return(()=>{var ne=zi(),ue=ne.firstChild,$e=ue.firstChild,he=ue.nextSibling;return $e.$$click=()=>g("practice"),u(he,o(S,{get when(){return r()==="quiz"},get children(){return[Ri(),o(bs,{get nodes(){return K()}})]}}),null),u(he,o(S,{get when(){return r()==="deathmatch"},get children(){return[Ii(),o(ks,{})]}}),null),u(he,o(S,{get when(){return r()==="practice"},get children(){return[Ai(),o(ms,{get end_of_practice(){return Le()},get movable(){return w()},on_rematch:te,get color(){return L()},set_movable:N})]}}),null),T(_e=>{var Oe="feature tab"+(r()==="practice"?" active":""),fe="content "+r();return Oe!==_e.e&&se($e,_e.e=Oe),fe!==_e.t&&se(he,_e.t=fe),_e},{e:void 0,t:void 0}),ne})()}}),null),u(Ce,o(tn,be(e,{is_edits_disabled:!0}))),q})()}function ms(e){const[t,{goto_path:n,reload_replay_tree_with_cursor_path:i}]=oe(),[,s]=at(),a=c=>{if(c===void 0){s(()=>{i(t.replay_tree.cursor_path)});return}me(()=>{s(()=>{i(""),e.on_rematch(c)})})},l=O(()=>e.color),d=O(()=>j(l()));return e.set_movable(!0),n(""),[(()=>{var c=Gi(),r=c.firstChild;return u(r,o(S,{get when(){return e.end_of_practice},get fallback(){return o(S,{get when(){return e.movable},get fallback(){return Di()},get children(){return Ki()}})},get children(){return Mi()}})),c})(),(()=>{var c=Ui(),r=c.firstChild,g=r.nextSibling,v=g.nextSibling;return r.$$click=()=>a(),g.$$click=()=>a(l()),v.$$click=()=>a(d()),T(()=>se(v,`color ${d()}`)),c})()]}function vs(e){let[t,n]=P(void 0);return{step:e,get is_solved(){return t()},set is_solved(i){n(i)}}}function bs(e){let[t,n]=P([...Array(15).keys()]);const[i,s]=P("info");let l=O(In(t,()=>vs(Ut(e.nodes))));return[(()=>{var d=Jt(),c=d.firstChild,r=c.nextSibling;return u(c,o(S,{get when(){return i()==="info"},children:"Press start"}),null),u(c,o(S,{get when(){return i()==="in-progress"},get children(){return Yt()}}),null),u(c,o(S,{get when(){return i()==="end"},get children(){return Zt()}}),null),u(r,o(S,{get when(){return i()==="info"},get children(){return Wi()}})),d})(),(()=>{var d=Qi();return u(d,o(we,{get each(){return l()},children:(c,r)=>(()=>{var g=Fi();return u(g,()=>r()+1),g})()})),d})(),(()=>{var d=en();return u(d,o(S,{get when(){return i()==="info"},get children(){return Xt()}})),d})()]}function ks(){const[e,t]=P("info");return[(()=>{var n=Jt(),i=n.firstChild,s=i.nextSibling;return u(i,o(S,{get when(){return e()==="info"},children:"Press start"}),null),u(i,o(S,{get when(){return e()==="in-progress"},get children(){return Yt()}}),null),u(i,o(S,{get when(){return e()==="end"},get children(){return Zt()}}),null),u(s,o(S,{get when(){return e()==="info"},get children(){return Hi()}})),n})(),(()=>{var n=en();return u(n,o(S,{get when(){return e()==="info"},get children(){return Xt()}})),n})()]}function tn(e){let[,{create_section:t,update_study:n}]=oe();const i=async()=>{let a=await t(e.study.id);await s(a.id),e.on_edit_section?.()},s=a=>n({id:e.study.id,selected_section_id:a});return(()=>{var a=Yi(),l=a.firstChild,d=l.firstChild,c=d.nextSibling,r=l.nextSibling,g=r.firstChild;return u(d,()=>e.study.name),u(c,o(S,{get when(){return!e.is_edits_disabled},get children(){var v=ji();return v.$$click=()=>e.on_edit_study?.(),v}})),u(r,o(we,{get each(){return e.sections},get fallback(){return o(Cs,{})},children:(v,y)=>o(S,{get when(){return v===e.selected_section},get fallback(){return o(ys,{get is_edits_disabled(){return e.is_edits_disabled},section:v,get nth(){return yt(y())},on_selected:()=>s(v.id),on_edit:()=>e.on_edit_section?.()})},get children(){return o($s,be(e,{section:v,get is_edits_disabled(){return e.is_edits_disabled},get nth(){return yt(y())},get on_edit(){return e.on_edit_section},get on_edit_chapter(){return e.on_edit_chapter}}))}})}),g),u(g,o(S,{get when(){return!e.is_edits_disabled},get children(){var v=Vi();return v.$$click=i,v}})),a})()}function $s(e){let[,{create_chapter:t,update_section:n}]=oe();const i=async()=>{let a=await t(e.study.id,e.section.id);await s(a.id),e.on_edit_chapter?.()},s=async a=>n(e.study.id,{id:e.section.id,selected_chapter_id:a});return(()=>{var a=Ji(),l=a.firstChild,d=l.firstChild,c=d.firstChild,r=c.nextSibling,g=l.nextSibling,v=g.firstChild,y=v.nextSibling;return u(c,()=>e.nth),u(r,()=>e.section?.name),u(l,o(S,{get when(){return!e.is_edits_disabled},get children(){var p=ct();return p.$$click=()=>e.on_edit?.(),p}}),null),u(v,o(we,{get each(){return e.chapters},get fallback(){return o(Ss,{})},children:(p,f)=>o(ws,{get is_edits_disabled(){return e.is_edits_disabled},chapter:p,get nth(){return`${e.nth}${f()+1}`},get selected(){return e.selected_chapter===p},on_selected:()=>s(p.id),on_edit:()=>e.on_edit_chapter?.()})})),u(y,o(S,{get when(){return!e.is_edits_disabled},get children(){var p=Zi();return p.$$click=()=>i(),p}})),T(()=>An(r,"title",e.section?.name)),a})()}function ws(e){const t=O(()=>e.selected?" active":"");return(()=>{var n=Xi(),i=n.firstChild,s=i.firstChild,a=s.firstChild;return n.$$click=()=>e.on_selected(),u(s,()=>e.nth,a),u(i,()=>e.chapter.name,null),u(n,o(S,{get when(){return!e.is_edits_disabled},get children(){var l=ct();return l.$$click=()=>e.on_edit(),l}}),null),T(()=>se(n,"chapter"+t())),n})()}function ys(e){const t=async()=>{await e.on_selected(),e.on_edit()};return(()=>{var n=es(),i=n.firstChild,s=i.firstChild,a=s.firstChild,l=a.nextSibling;return i.$$click=()=>e.on_selected(),u(a,()=>e.nth),u(l,()=>e.section.name),u(i,o(S,{get when(){return!e.is_edits_disabled},get children(){var d=ct();return d.$$click=t,d}}),null),n})()}function Cs(){return ts()}function Ss(){return ns()}function Ps(){return is()}function nn(e){return[]}function xs(e){const[,{update_study:t}]=oe(),[n,i]=P("share"),[s,a]=P(!0,{equals:!1}),l=()=>{a(!0),e.on_copy_pgn()},d=e.study.is_edits_disabled,c=p=>t({id:e.study.id,is_edits_disabled:p}),[r,g]=P(!1),[,{study_as_export_pgn:v}]=oe(),y=async()=>{g(!0);let p=await v(e.study.id);g(!1),Os(p,`${e.study.name}.pgn`)};return[(()=>{var p=ss(),f=p.firstChild,b=f.nextSibling;return f.$$click=()=>i("settings"),b.$$click=()=>i("share"),T(B=>{var x="tab"+(n()==="settings"?" active":""),A="tab"+(n()==="share"?" active":"");return x!==B.e&&se(f,B.e=x),A!==B.t&&se(b,B.t=A),B},{e:void 0,t:void 0}),p})(),(()=>{var p=os();return u(p,o(S,{get when(){return n()==="settings"},get children(){var f=rs(),b=f.firstChild,B=b.firstChild,x=B.nextSibling;return x.addEventListener("change",A=>c(A.currentTarget.checked)),x.checked=d,f}}),null),u(p,o(S,{get when(){return n()==="share"},get children(){return[(()=>{var f=as(),b=f.firstChild,B=b.firstChild,x=b.nextSibling,A=x.nextSibling;return b.$$click=l,u(b,o(sn,{get on_copy(){return s()}}),B),x.$$click=y,u(x,o(S,{get when(){return r()},get fallback(){return"Export as PGN"},children:"Loading..."})),xe(A,"click",e.on_export_lichess,!0),T(()=>x.disabled=r()),f})(),(()=>{var f=ls();return f.firstChild,u(f,o(Es,{get value(){return e.fen}}),null),f})()]}}),null),p})()]}function Es(e){const[t,n]=P(!0,{equals:!1}),i=()=>{navigator.clipboard.writeText(e.value),n(!0)};return(()=>{var s=cs(),a=s.firstChild;return s.$$click=i,u(s,o(sn,{get on_copy(){return t()}}),null),T(()=>a.value=e.value),s})()}function sn(e){Ne(tt(()=>e.on_copy,()=>{n(!0),setTimeout(()=>n(!1),1e3)},{defer:!0}));const[t,n]=P(!1);return o(S,{get when(){return t()},get fallback(){return us()},get children(){return ds()}})}function Ls(){return hs()}function Os(e,t){const n=new Blob([e],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(n),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}Ue(["click"]);export{ws as ChapterComponent,Ps as LoadingChapters,Ss as NoChapters,Cs as NoSections,Ns as default};
