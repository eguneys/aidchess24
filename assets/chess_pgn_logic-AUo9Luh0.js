var Ut=Object.defineProperty;var Wt=(i,t,e)=>t in i?Ut(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var v=(i,t,e)=>(Wt(i,typeof t!="symbol"?t+"":t,e),e);import{w as Ct,k as $t}from"./index-DigfKJAO.js";const X=["a","b","c","d","e","f","g","h"],Kt=["1","2","3","4","5","6","7","8"],x=["white","black"],y=["pawn","knight","bishop","rook","queen","king"],Ht=["a","h"],W=i=>"role"in i,c=i=>i!==void 0,k=i=>i==="white"?"black":"white",B=i=>i>>3,w=i=>i&7,at=(i,t)=>0<=i&&i<8&&0<=t&&t<8?i+8*t:void 0,P=i=>{switch(i){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function K(i){switch(i.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function _(i){if(i.length===2)return at(i.charCodeAt(0)-97,i.charCodeAt(1)-49)}const F=i=>X[w(i)]+Kt[B(i)],Vt=i=>{if(i[1]==="@"&&i.length===4){const t=K(i[0]),e=_(i.slice(2));if(t&&c(e))return{role:t,to:e}}else if(i.length===4||i.length===5){const t=_(i.slice(0,2)),e=_(i.slice(2,4));let s;if(i.length===5&&(s=K(i[4]),!s))return;if(c(t)&&c(e))return{from:t,to:e,promotion:s}}},At=i=>W(i)?`${P(i.role).toUpperCase()}@${F(i.to)}`:F(i.from)+F(i.to)+(i.promotion?P(i.promotion):""),mt=(i,t)=>i==="white"?t==="a"?2:6:t==="a"?58:62,wt=(i,t)=>i==="white"?t==="a"?3:5:t==="a"?59:61,Ot=i=>(i=i-(i>>>1&1431655765),i=(i&858993459)+(i>>>2&858993459),Math.imul(i+(i>>>4)&252645135,16843009)>>24),ct=i=>(i=i>>>8&16711935|(i&16711935)<<8,i>>>16&65535|(i&65535)<<16),Nt=i=>(i=i>>>1&1431655765|(i&1431655765)<<1,i=i>>>2&858993459|(i&858993459)<<2,i=i>>>4&252645135|(i&252645135)<<4,ct(i));class r{constructor(t,e){this.lo=t|0,this.hi=e|0}static fromSquare(t){return t>=32?new r(0,1<<t-32):new r(1<<t,0)}static fromRank(t){return new r(255,0).shl64(8*t)}static fromFile(t){return new r(16843009<<t,16843009<<t)}static empty(){return new r(0,0)}static full(){return new r(4294967295,4294967295)}static corners(){return new r(129,2164260864)}static center(){return new r(402653184,24)}static backranks(){return new r(255,4278190080)}static backrank(t){return t==="white"?new r(255,0):new r(0,4278190080)}static lightSquares(){return new r(1437226410,1437226410)}static darkSquares(){return new r(2857740885,2857740885)}complement(){return new r(~this.lo,~this.hi)}xor(t){return new r(this.lo^t.lo,this.hi^t.hi)}union(t){return new r(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new r(this.lo&t.lo,this.hi&t.hi)}diff(t){return new r(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?r.empty():t>=32?new r(this.hi>>>t-32,0):t>0?new r(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?r.empty():t>=32?new r(0,this.lo<<t-32):t>0?new r(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new r(ct(this.hi),ct(this.lo))}rbit64(){return new r(Nt(this.hi),Nt(this.lo))}minus64(t){const e=this.lo-t.lo,s=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new r(e,this.hi-(t.hi+s))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Ot(this.lo)+Ot(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new r(this.lo,this.hi|1<<t-32):new r(this.lo|1<<t,this.hi)}without(t){return t>=32?new r(this.lo,this.hi&~(1<<t-32)):new r(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new r(this.lo,this.hi^1<<t-32):new r(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new r(this.lo&this.lo-1,this.hi):new r(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;t!==0;){const s=31-Math.clz32(t&-t);t^=1<<s,yield s}for(;e!==0;){const s=31-Math.clz32(e&-e);e^=1<<s,yield 32+s}}*reversed(){let t=this.lo,e=this.hi;for(;e!==0;){const s=31-Math.clz32(e);e^=1<<s,yield 32+s}for(;t!==0;){const s=31-Math.clz32(t);t^=1<<s,yield s}}}const q=(i,t)=>{let e=r.empty();for(const s of t){const n=i+s;0<=n&&n<64&&Math.abs(w(i)-w(n))<=2&&(e=e.with(n))}return e},A=i=>{const t=[];for(let e=0;e<64;e++)t[e]=i(e);return t},jt=A(i=>q(i,[-9,-8,-7,-1,1,7,8,9])),Zt=A(i=>q(i,[-17,-15,-10,-6,6,10,15,17])),Yt={white:A(i=>q(i,[7,9])),black:A(i=>q(i,[-7,-9]))},it=i=>jt[i],st=i=>Zt[i],V=(i,t)=>Yt[i][t],lt=A(i=>r.fromFile(w(i)).without(i)),ut=A(i=>r.fromRank(B(i)).without(i)),ft=A(i=>{const t=new r(134480385,2151686160),e=8*(B(i)-w(i));return(e>=0?t.shl64(e):t.shr64(-e)).without(i)}),dt=A(i=>{const t=new r(270549120,16909320),e=8*(B(i)+w(i)-7);return(e>=0?t.shl64(e):t.shr64(-e)).without(i)}),kt=(i,t,e)=>{let s=e.intersect(t),n=s.bswap64();return s=s.minus64(i),n=n.minus64(i.bswap64()),s.xor(n.bswap64()).intersect(t)},Jt=(i,t)=>kt(r.fromSquare(i),lt[i],t),Xt=(i,t)=>{const e=ut[i];let s=t.intersect(e),n=s.rbit64();return s=s.minus64(r.fromSquare(i)),n=n.minus64(r.fromSquare(63-i)),s.xor(n.rbit64()).intersect(e)},G=(i,t)=>{const e=r.fromSquare(i);return kt(e,ft[i],t).xor(kt(e,dt[i],t))},D=(i,t)=>Jt(i,t).xor(Xt(i,t)),gt=(i,t)=>G(i,t).xor(D(i,t)),qt=(i,t,e)=>{switch(i.role){case"pawn":return V(i.color,t);case"knight":return st(t);case"bishop":return G(t,e);case"rook":return D(t,e);case"queen":return gt(t,e);case"king":return it(t)}},_t=(i,t)=>{const e=r.fromSquare(t);return ut[i].intersects(e)?ut[i].with(i):dt[i].intersects(e)?dt[i].with(i):ft[i].intersects(e)?ft[i].with(i):lt[i].intersects(e)?lt[i].with(i):r.empty()},$=(i,t)=>_t(i,t).intersect(r.full().shl64(i).xor(r.full().shl64(t))).withoutFirst();class L{constructor(){}static default(){const t=new L;return t.reset(),t}reset(){this.occupied=new r(65535,4294901760),this.promoted=r.empty(),this.white=new r(65535,0),this.black=new r(0,4294901760),this.pawn=new r(65280,16711680),this.knight=new r(66,1107296256),this.bishop=new r(36,603979776),this.rook=new r(129,2164260864),this.queen=new r(8,134217728),this.king=new r(16,268435456)}static empty(){const t=new L;return t.clear(),t}clear(){this.occupied=r.empty(),this.promoted=r.empty();for(const t of x)this[t]=r.empty();for(const t of y)this[t]=r.empty()}clone(){const t=new L;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of x)t[e]=this[e];for(const e of y)t[e]=this[e];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const e of y)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;const s=this.getRole(t),n=this.promoted.has(t);return{color:e,role:s,promoted:n}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const s=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),s}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class R{constructor(){}static empty(){const t=new R;for(const e of y)t[e]=0;return t}static fromBoard(t,e){const s=new R;for(const n of y)s[n]=t.pieces(e,n).size();return s}clone(){const t=new R;for(const e of y)t[e]=this[e];return t}equals(t){return y.every(e=>this[e]===t[e])}add(t){const e=new R;for(const s of y)e[s]=this[s]+t[s];return e}nonEmpty(){return y.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class T{constructor(t,e){this.white=t,this.black=e}static empty(){return new T(R.empty(),R.empty())}static fromBoard(t){return new T(R.fromBoard(t,"white"),R.fromBoard(t,"black"))}clone(){return new T(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new T(this.white.add(t.white),this.black.add(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class H{constructor(t,e){this.white=t,this.black=e}static default(){return new H(3,3)}clone(){return new H(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}class Ft{unwrap(t,e){const s=this._chain(n=>l.ok(t?t(n):n),n=>e?l.ok(e(n)):l.err(n));if(s.isErr)throw s.error;return s.value}map(t,e){return this._chain(s=>l.ok(t(s)),s=>l.err(e?e(s):s))}chain(t,e){return this._chain(t,e||(s=>l.err(s)))}}class te extends Ft{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,e){return t(this.value)}}class ee extends Ft{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,e){return e(this.error)}}var l;(function(i){i.ok=function(t){return new te(t)},i.err=function(t){return new ee(t||new Error)},i.all=function(t){if(Array.isArray(t)){const n=[];for(let o=0;o<t.length;o++){const h=t[o];if(h.isErr)return h;n.push(h.value)}return i.ok(n)}const e={},s=Object.keys(t);for(let n=0;n<s.length;n++){const o=t[s[n]];if(o.isErr)return o;e[s[n]]=o.value}return i.ok(e)}})(l||(l={}));var C;(function(i){i.Empty="ERR_EMPTY",i.OppositeCheck="ERR_OPPOSITE_CHECK",i.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",i.Kings="ERR_KINGS",i.Variant="ERR_VARIANT"})(C||(C={}));class M extends Error{}const ie=(i,t,e,s)=>e[t].intersect(D(i,s).intersect(e.rooksAndQueens()).union(G(i,s).intersect(e.bishopsAndQueens())).union(st(i).intersect(e.knight)).union(it(i).intersect(e.king)).union(V(k(t),i).intersect(e.pawn)));class N{constructor(){}static default(){const t=new N;return t.castlingRights=r.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new r(14,0),h:new r(96,0)},black:{a:new r(0,234881024),h:new r(0,1610612736)}},t}static empty(){const t=new N;return t.castlingRights=r.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:r.empty(),h:r.empty()},black:{a:r.empty(),h:r.empty()}},t}clone(){const t=new N;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,s,n){const o=mt(t,e),h=wt(t,e);this.castlingRights=this.castlingRights.with(n),this.rook[t][e]=n,this.path[t][e]=$(n,h).with(h).union($(s,o).with(o)).without(s).without(n)}static fromSetup(t){const e=N.empty(),s=t.castlingRights.intersect(t.board.rook);for(const n of x){const o=r.backrank(n),h=t.board.kingOf(n);if(!c(h)||!o.has(h))continue;const a=s.intersect(t.board[n]).intersect(o),u=a.first();c(u)&&u<h&&e.add(n,"a",h,u);const f=a.last();c(f)&&h<f&&e.add(n,"h",h,f)}return e}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const e of x)for(const s of Ht)this.rook[e][s]===t&&(this.rook[e][s]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(r.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class se{constructor(t){this.rules=t}reset(){this.board=L.default(),this.pockets=void 0,this.turn="white",this.castles=N.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=r.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=N.fromSetup(t),this.epSquare=ne(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,e,s){return ie(t,e,this.board,s)}playCaptureAt(t,e){this.halfmoves=0,e.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[k(e.color)][e.promoted?"pawn":e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!c(e))return{king:e,blockers:r.empty(),checkers:r.empty(),variantEnd:t,mustCapture:!1};const s=D(e,r.empty()).intersect(this.board.rooksAndQueens()).union(G(e,r.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[k(this.turn)]);let n=r.empty();for(const h of s){const a=$(e,h).intersect(this.board.occupied);a.moreThanOne()||(n=n.union(a))}const o=this.kingAttackers(e,k(this.turn),this.board.occupied);return{king:e,blockers:n,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,e;const s=new this.constructor;return s.board=this.board.clone(),s.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),s.turn=this.turn,s.castles=this.castles.clone(),s.epSquare=this.epSquare,s.remainingChecks=(e=this.remainingChecks)===null||e===void 0?void 0:e.clone(),s.halfmoves=this.halfmoves,s.fullmoves=this.fullmoves,s}validate(){if(this.board.occupied.isEmpty())return l.err(new M(C.Empty));if(this.board.king.size()!==2)return l.err(new M(C.Kings));if(!c(this.board.kingOf(this.turn)))return l.err(new M(C.Kings));const t=this.board.kingOf(k(this.turn));return c(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?l.err(new M(C.OppositeCheck)):r.backranks().intersects(this.board.pawn)?l.err(new M(C.PawnsOnBackrank)):l.ok(void 0):l.err(new M(C.Kings))}dropDests(t){return r.empty()}dests(t,e){if(e=e||this.ctx(),e.variantEnd)return r.empty();const s=this.board.get(t);if(!s||s.color!==this.turn)return r.empty();let n,o;if(s.role==="pawn"){n=V(this.turn,t).intersect(this.board[k(this.turn)]);const h=this.turn==="white"?8:-8,a=t+h;if(0<=a&&a<64&&!this.board.occupied.has(a)){n=n.with(a);const u=this.turn==="white"?t<16:t>=48,f=a+h;u&&!this.board.occupied.has(f)&&(n=n.with(f))}c(this.epSquare)&&oe(this,t,e)&&(o=r.fromSquare(this.epSquare))}else s.role==="bishop"?n=G(t,this.board.occupied):s.role==="knight"?n=st(t):s.role==="rook"?n=D(t,this.board.occupied):s.role==="queen"?n=gt(t,this.board.occupied):n=it(t);if(n=n.diff(this.board[this.turn]),c(e.king)){if(s.role==="king"){const h=this.board.occupied.without(t);for(const a of n)this.kingAttackers(a,k(this.turn),h).nonEmpty()&&(n=n.without(a));return n.union(Pt(this,"a",e)).union(Pt(this,"h",e))}if(e.checkers.nonEmpty()){const h=e.checkers.singleSquare();if(!c(h))return r.empty();n=n.intersect($(h,e.king).with(h))}e.blockers.has(t)&&(n=n.intersect(_t(t,e.king)))}return o&&(n=n.union(o)),n}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[k(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(r.darkSquares())||!this.board.bishop.intersects(r.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,e;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:re(this),remainingChecks:(e=this.remainingChecks)===null||e===void 0?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return x.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(W(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&r.backranks().has(t.to)?!1:this.dropDests(e).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&r.backranks().has(t.to)))return!1;const s=this.dests(t.from,e);return s.has(t.to)||s.has(he(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return c(t)&&this.kingAttackers(t,k(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:k(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const s of this.board[this.turn])e.set(s,this.dests(s,t));return e}play(t){const e=this.turn,s=this.epSquare,n=Gt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,e==="black"&&(this.fullmoves+=1),this.turn=k(e),W(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let h;if(o.role==="pawn"){this.halfmoves=0,t.to===s&&(h=this.board.take(t.to+(e==="white"?-8:8)));const a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(n){const a=this.castles.rook[e][n];if(c(a)){const u=this.board.take(a);this.board.set(mt(e,n),o),u&&this.board.set(wt(e,n),u)}}this.castles.discardColor(e)}if(!n){const a=this.board.set(t.to,o)||h;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[e]=Math.max(this.remainingChecks[e]-1,0))}}class Lt extends se{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(s=>e)}clone(){return super.clone()}}const ne=(i,t)=>{if(!c(t))return;const e=i.turn==="white"?5:2,s=i.turn==="white"?8:-8;if(B(t)!==e||i.board.occupied.has(t+s))return;const n=t-s;if(!(!i.board.pawn.has(n)||!i.board[k(i.turn)].has(n)))return t},re=i=>{if(!c(i.epSquare))return;const t=i.ctx(),s=i.board.pieces(i.turn,"pawn").intersect(V(k(i.turn),i.epSquare));for(const n of s)if(i.dests(n,t).has(i.epSquare))return i.epSquare},oe=(i,t,e)=>{if(!c(i.epSquare)||!V(i.turn,t).has(i.epSquare))return!1;if(!c(e.king))return!0;const s=i.turn==="white"?8:-8,n=i.epSquare-s;return i.kingAttackers(e.king,k(i.turn),i.board.occupied.toggle(t).toggle(n).with(i.epSquare)).without(n).isEmpty()},Pt=(i,t,e)=>{if(!c(e.king)||e.checkers.nonEmpty())return r.empty();const s=i.castles.rook[i.turn][t];if(!c(s)||i.castles.path[i.turn][t].intersects(i.board.occupied))return r.empty();const n=mt(i.turn,t),o=$(e.king,n),h=i.board.occupied.without(e.king);for(const f of o)if(i.kingAttackers(f,k(i.turn),h).nonEmpty())return r.empty();const a=wt(i.turn,t),u=i.board.occupied.toggle(e.king).toggle(s).toggle(a);return i.kingAttackers(n,k(i.turn),u).nonEmpty()?r.empty():r.fromSquare(s)},Gt=(i,t)=>{if(W(t))return;const e=t.to-t.from;if(!(Math.abs(e)!==2&&!i.board[i.turn].has(t.to))&&i.board.king.has(t.from))return e>0?"h":"a"},he=(i,t)=>{const e=Gt(i,t);if(!e)return t;const s=i.castles.rook[i.turn][e];return{from:t.from,to:c(s)?s:t.to}},ae="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ce=ae+" w KQkq -",le=ce+" 0 1";var d;(function(i){i.Fen="ERR_FEN",i.Board="ERR_BOARD",i.Pockets="ERR_POCKETS",i.Turn="ERR_TURN",i.Castling="ERR_CASTLING",i.EpSquare="ERR_EP_SQUARE",i.RemainingChecks="ERR_REMAINING_CHECKS",i.Halfmoves="ERR_HALFMOVES",i.Fullmoves="ERR_FULLMOVES"})(d||(d={}));class p extends Error{}const ue=(i,t,e)=>{let s=i.indexOf(t);for(;e-- >0&&s!==-1;)s=i.indexOf(t,s+t.length);return s},z=i=>/^\d{1,4}$/.test(i)?parseInt(i,10):void 0,Dt=i=>{const t=K(i);return t&&{role:t,color:i.toLowerCase()===i?"black":"white"}},rt=i=>{const t=L.empty();let e=7,s=0;for(let n=0;n<i.length;n++){const o=i[n];if(o==="/"&&s===8)s=0,e--;else{const h=parseInt(o,10);if(h>0)s+=h;else{if(s>=8||e<0)return l.err(new p(d.Board));const a=s+e*8,u=Dt(o);if(!u)return l.err(new p(d.Board));i[n+1]==="~"&&(u.promoted=!0,n++),t.set(a,u),s++}}}return e!==0||s!==8?l.err(new p(d.Board)):l.ok(t)},xt=i=>{if(i.length>64)return l.err(new p(d.Pockets));const t=T.empty();for(const e of i){const s=Dt(e);if(!s)return l.err(new p(d.Pockets));t[s.color][s.role]++}return l.ok(t)},fe=(i,t)=>{let e=r.empty();if(t==="-")return l.ok(e);for(const s of t){const n=s.toLowerCase(),o=s===n?"black":"white",h=o==="white"?0:7;if("a"<=n&&n<="h")e=e.with(at(n.charCodeAt(0)-97,h));else if(n==="k"||n==="q"){const a=i[o].intersect(r.backrank(o)).intersect(i.rook.union(i.king)),u=n==="k"?a.last():a.first();e=e.with(c(u)&&i.rook.has(u)?u:at(n==="k"?7:0,h))}else return l.err(new p(d.Castling))}return x.some(s=>r.backrank(s).intersect(e).size()>2)?l.err(new p(d.Castling)):l.ok(e)},Bt=i=>{const t=i.split("+");if(t.length===3&&t[0]===""){const e=z(t[1]),s=z(t[2]);return!c(e)||e>3||!c(s)||s>3?l.err(new p(d.RemainingChecks)):l.ok(new H(3-e,3-s))}else if(t.length===2){const e=z(t[0]),s=z(t[1]);return!c(e)||e>3||!c(s)||s>3?l.err(new p(d.RemainingChecks)):l.ok(new H(e,s))}else return l.err(new p(d.RemainingChecks))},Qt=i=>{const t=i.split(/[\s_]+/),e=t.shift();let s,n=l.ok(void 0);if(e.endsWith("]")){const a=e.indexOf("[");if(a===-1)return l.err(new p(d.Fen));s=rt(e.slice(0,a)),n=xt(e.slice(a+1,-1))}else{const a=ue(e,"/",7);a===-1?s=rt(e):(s=rt(e.slice(0,a)),n=xt(e.slice(a+1)))}let o;const h=t.shift();if(!c(h)||h==="w")o="white";else if(h==="b")o="black";else return l.err(new p(d.Turn));return s.chain(a=>{const u=t.shift(),f=c(u)?fe(a,u):l.ok(r.empty()),m=t.shift();let b;if(c(m)&&m!=="-"&&(b=_(m),!c(b)))return l.err(new p(d.EpSquare));let g=t.shift(),E;c(g)&&g.includes("+")&&(E=Bt(g),g=t.shift());const j=c(g)?z(g):0;if(!c(j))return l.err(new p(d.Halfmoves));const Q=t.shift(),S=c(Q)?z(Q):1;if(!c(S))return l.err(new p(d.Fullmoves));const nt=t.shift();let I=l.ok(void 0);if(c(nt)){if(c(E))return l.err(new p(d.RemainingChecks));I=Bt(nt)}else c(E)&&(I=E);return t.length>0?l.err(new p(d.Fen)):n.chain(Z=>f.chain(Y=>I.map(J=>({board:a,pockets:Z,turn:o,castlingRights:Y,remainingChecks:J,epSquare:b,halfmoves:j,fullmoves:Math.max(1,S)}))))})},de=i=>{let t=P(i.role);return i.color==="white"&&(t=t.toUpperCase()),i.promoted&&(t+="~"),t},ke=i=>{let t="",e=0;for(let s=7;s>=0;s--)for(let n=0;n<8;n++){const o=n+s*8,h=i.get(o);h?(e>0&&(t+=e,e=0),t+=de(h)):e++,n===7&&(e>0&&(t+=e,e=0),s!==0&&(t+="/"))}return t},It=i=>y.map(t=>P(t).repeat(i[t])).join(""),pe=i=>It(i.white).toUpperCase()+It(i.black),me=(i,t)=>{let e="";for(const s of x){const n=r.backrank(s);let o=i.kingOf(s);c(o)&&!n.has(o)&&(o=void 0);const h=i.pieces(s,"rook").intersect(n);for(const a of t.intersect(n).reversed())if(a===h.first()&&c(o)&&a<o)e+=s==="white"?"Q":"q";else if(a===h.last()&&c(o)&&o<a)e+=s==="white"?"K":"k";else{const u=X[w(a)];e+=s==="white"?u.toUpperCase():u}}return e||"-"},we=i=>`${i.white}+${i.black}`,ge=(i,t)=>[ke(i.board)+(i.pockets?`[${pe(i.pockets)}]`:""),i.turn[0],me(i.board,i.castlingRights),c(i.epSquare)?F(i.epSquare):"-",...i.remainingChecks?[we(i.remainingChecks)]:[],...t!=null&&t.epd?[]:[Math.max(0,Math.min(i.halfmoves,9999)),Math.max(1,Math.min(i.fullmoves,9999))]].join(" "),be=(i,t)=>{let e="";if(W(t))t.role!=="pawn"&&(e=P(t.role).toUpperCase()),e+="@"+F(t.to);else{const s=i.board.getRole(t.from);if(!s)return"--";if(s==="king"&&(i.board[i.turn].has(t.to)||Math.abs(t.to-t.from)===2))e=t.to>t.from?"O-O":"O-O-O";else{const n=i.board.occupied.has(t.to)||s==="pawn"&&w(t.from)!==w(t.to);if(s!=="pawn"){e=P(s).toUpperCase();let o;if(s==="king"?o=it(t.to).intersect(i.board.king):s==="queen"?o=gt(t.to,i.board.occupied).intersect(i.board.queen):s==="rook"?o=D(t.to,i.board.occupied).intersect(i.board.rook):s==="bishop"?o=G(t.to,i.board.occupied).intersect(i.board.bishop):o=st(t.to).intersect(i.board.knight),o=o.intersect(i.board[i.turn]).without(t.from),o.nonEmpty()){const h=i.ctx();for(const a of o)i.dests(a,h).has(t.to)||(o=o.without(a));if(o.nonEmpty()){let a=!1,u=o.intersects(r.fromRank(B(t.from)));o.intersects(r.fromFile(w(t.from)))?a=!0:u=!0,u&&(e+=X[w(t.from)]),a&&(e+=Kt[B(t.from)])}}}else n&&(e=X[w(t.from)]);n&&(e+="x"),e+=F(t.to),t.promotion&&(e+="="+P(t.promotion).toUpperCase())}}return e},Ee=(i,t)=>{var e;const s=be(i,t);return i.play(t),!((e=i.outcome())===null||e===void 0)&&e.winner?s+"#":i.isCheck()?s+"+":s},ye=(i,t)=>Ee(i.clone(),t),Mt=(i,t)=>{const e=i.ctx(),s=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!s){let m;if(t==="O-O"||t==="O-O+"||t==="O-O#"?m="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(m="a"),m){const E=i.castles.rook[i.turn][m];return!c(e.king)||!c(E)||!i.dests(e.king,e).has(E)?void 0:{from:e.king,to:E}}const b=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!b)return;const g={role:b[1]?K(b[1]):"pawn",to:_(b[2])};return i.isLegal(g,e)?g:void 0}const n=s[1]?K(s[1]):"pawn",o=_(s[4]),h=s[5]?K(s[5]):void 0;if(!!h!==(n==="pawn"&&r.backranks().has(o))||h==="king"&&i.rules!=="antichess")return;let a=i.board.pieces(i.turn,n);n==="pawn"&&!s[2]?a=a.intersect(r.fromFile(w(o))):s[2]&&(a=a.intersect(r.fromFile(s[2].charCodeAt(0)-97))),s[3]&&(a=a.intersect(r.fromRank(s[3].charCodeAt(0)-49)));const u=n==="pawn"?r.fromFile(w(o)):r.empty();a=a.intersect(u.union(qt({color:k(i.turn),role:n},o,i.board.occupied)));let f;for(const m of a)if(i.dests(m,e).has(o)){if(c(f))return;f=m}if(c(f))return{from:f,to:o,promotion:h}},Re=(i=bt)=>({headers:i(),moves:new St});class St{constructor(){this.children=[]}*mainline(){let t=this;for(;t.children.length;){const e=t.children[0];yield e.data,t=e}}}class Ce extends St{constructor(t){super(),this.data=t}}const bt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Tt="\uFEFF",ot=i=>/^\s*$/.test(i),ht=i=>i.startsWith("%");class Ae extends Error{}class Oe{constructor(t,e=bt,s=1e6){this.emitGame=t,this.initHeaders=e,this.maxBudget=s,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Re(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Ae("ERR_PGN_BUDGET")}parse(t,e){if(!(this.budget<0))try{let s=0;for(;;){const n=t.indexOf(`
`,s);if(n===-1)break;const o=n>s&&t[n-1]==="\r"?n-1:n;this.consumeBudget(n-s),this.lineBuf.push(t.slice(s,o)),s=n+1,this.handleLine()}this.consumeBudget(t.length-s),this.lineBuf.push(t.slice(s)),e!=null&&e.stream||(this.handleLine(),this.emit(void 0))}catch(s){this.emit(s)}}handleLine(){let t=!0,e=this.lineBuf.join("");this.lineBuf=[];t:for(;;)switch(this.state){case 0:e.startsWith(Tt)&&(e=e.slice(Tt.length)),this.state=1;case 1:if(ot(e)||ht(e))return;this.found=!0,this.state=2;case 2:{if(ht(e))return;let s=!0;for(;s;)s=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(n,o,h)=>(this.consumeBudget(200),this.game.headers.set(o,h.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),s=!0,t=!1,""));if(ot(e))return;this.state=3}case 3:{if(t){if(ht(e))return;if(ot(e))return this.emit(void 0)}const s=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let n;for(;n=s.exec(e);){const o=this.stack[this.stack.length-1];let h=n[0];if(h===";")return;if(h.startsWith("$"))this.handleNag(parseInt(h.slice(1),10));else if(h==="!")this.handleNag(1);else if(h==="?")this.handleNag(2);else if(h==="!!")this.handleNag(3);else if(h==="??")this.handleNag(4);else if(h==="!?")this.handleNag(5);else if(h==="?!")this.handleNag(6);else if(h==="1-0"||h==="0-1"||h==="1/2-1/2"||h==="*")this.stack.length===1&&h!=="*"&&this.game.headers.set("Result",h);else if(h==="(")this.consumeBudget(100),this.stack.push({parent:o.parent,root:!1});else if(h===")")this.stack.length>1&&this.stack.pop();else if(h==="{"){const a=s.lastIndex,u=e[a]===" "?a+1:a;e=e.slice(u),this.state=4;continue t}else this.consumeBudget(100),h==="Z0"||h==="0000"||h==="@@@@"?h="--":h.startsWith("0")&&(h=h.replace(/0/g,"O")),o.node&&(o.parent=o.node),o.node=new Ce({san:h,startingComments:o.startingComments}),o.startingComments=void 0,o.root=!1,o.parent.children.push(o.node)}return}case 4:{const s=e.indexOf("}");if(s===-1){this.commentBuf.push(e);return}else{const n=s>0&&e[s-1]===" "?s-1:s;this.commentBuf.push(e.slice(0,n)),this.handleComment(),e=e.slice(s),this.state=3,t=!1}}}}handleNag(t){var e;this.consumeBudget(50);const s=this.stack[this.stack.length-1];s.node&&((e=s.node.data).nags||(e.nags=[]),s.node.data.nags.push(t))}handleComment(){var t,e;this.consumeBudget(100);const s=this.stack[this.stack.length-1],n=this.commentBuf.join(`
`);this.commentBuf=[],s.node?((t=s.node.data).comments||(t.comments=[]),s.node.data.comments.push(n)):s.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(n)):(s.startingComments||(s.startingComments=[]),s.startingComments.push(n))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Ne=(i,t=bt)=>{const e=[];return new Oe(s=>e.push(s),t,NaN).parse(i),e},et=class et{constructor(t,e){this.headers=t,this.tree=e}get event(){return this.headers.event}get site(){return this.headers.site}get white(){return this.headers.white}get black(){return this.headers.black}get puzzle(){return this.headers.puzzle}};v(et,"make_many",t=>Ne(t).map(e=>{let s=e.headers.get("Event"),n=e.headers.get("Site"),o=e.headers.get("White"),h=e.headers.get("Black"),a=e.headers.get("Puzzle"),u=e.headers.get("FEN"),f=e.moves.children[0],m=u??le,b=f.data.san,g=Lt.fromSetup(Qt(m).unwrap()).unwrap(),E=Mt(g,b),j=At(E),Q=pt.make(m,[j]);S(Q,f,g,[]);function S(I,Z,Y,J){let Et=Mt(Y,Z.data.san),yt=Y.clone();yt.play(Et);let Rt=At(Et);I.append_uci(Rt,J),Z.children.forEach(vt=>{S(I,vt,yt,[...J,Rt])})}return new et({event:s,site:n,white:o,black:h,puzzle:a},Q)}));let zt=et;const U=class U{constructor(t){v(this,"_children");this.data=t,this._children=$t([])}get clone(){let t=new U({...this.data});return t.children=this.children.map(e=>e.clone),t}get length(){if(this.children.length>1)return 1;let t=2,e=this.children[0];for(;(e==null?void 0:e.children.length)===1;)t++,e=e.children[0];return t}get nb_first_variations(){if(this.children.length>1)return this.children.length;let t=this.children[0];for(;(t==null?void 0:t.children.length)===1;)t=t.children[0];return(t==null?void 0:t.children.length)??0}get children(){return this._children[0]()}set children(t){this._children[1](t)}};v(U,"make",t=>new U(t));let tt=U;const O=class O{constructor(t){this.root=t}get clone(){return new O(this.root.clone)}static make_data(t,e,s,n){let o=Qt(t).unwrap(),h=Lt.fromSetup(o).unwrap(),a=Vt(e),u=ye(h,a);return h.play(a),{path:[...n,e],ply:s,before_fen:t,san:u,after_fen:ge(h.toSetup()),uci:e}}_traverse_path(t){let e,s=[this.root];for(let n of t)e=s.find(o=>o.data.uci===n),s=(e==null?void 0:e.children)||this.root;return e}_find_path(t){let e=[],s=[],n=this.root,o=[n],h=!1;for(let a of t)if(h)s.push(a);else{let u=o.find(f=>f.data.uci===a);u?(e.push(a),n=u,o=Ct(()=>n.children)):(h=!0,s.push(a))}return[e,n,s]}get_children(t){let e=this._traverse_path(t);return e==null?void 0:e.children.map(s=>s.data)}get_at(t){let e=this._traverse_path(t);return e==null?void 0:e.data}append_uci(t,e=[]){this.append_ucis([...e,t])}append_ucis(t){let[e,s,n]=this._find_path(t);for(let o of n){let h=tt.make(O.make_data(s.data.after_fen,o,s.data.ply+1,e)),a=Ct(()=>s.children);s.children=[...a,h],s=h,e=[...e,o]}}};v(O,"make",(t,e)=>{let s=e[0],n=e.slice(1),o=new O(tt.make(O.make_data(t,s,1,[])));return o.append_ucis(n),o});let pt=O;export{Lt as C,le as I,pt as M,zt as P,ge as a,_ as b,Vt as c,F as m,Qt as p,w as s};
