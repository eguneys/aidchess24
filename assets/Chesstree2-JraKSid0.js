var L=Object.defineProperty;var N=(a,t,e)=>t in a?L(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var l=(a,t,e)=>(N(a,typeof t!="symbol"?t+"":t,e),e);import{d as F,h as w,n as v,l as y,v as C,i as _,c as h,S as k,w as c,e as I,M as b,F as m,f as A,g as D,t as g,r as W}from"./index-BJpzf9IE.js";import"./Shalala-B8qAGfmd.js";import{I as P,a as z}from"./chess_pgn_logic-3ui-LPsv.js";var M=g("<div class=chesstree>"),R=g("<div class=lines>"),q=g("<div class=line>"),B=g("<span class=index>"),G=g("<div>"),J=g("<span class=collapsed> ..<!> ");class p{constructor(){l(this,"_blacks");l(this,"_whites");this._blacks=w([],{equals:!1}),this._whites=w([],{equals:!1})}replace_all(t){this.blacks=t.blacks.slice(0),this.whites=t.whites.slice(0)}merge_dup(t){v(()=>{t.paths.forEach(e=>this.add_path(e))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(t){let e=new p;return e.blacks=t[0],e.whites=t[1],e}set blacks(t){this._blacks[1](t)}set whites(t){this._whites[1](t)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let t=[];return this.whites.forEach(e=>{for(let r=0;r<=e.length-1;r+=2)t.push(e.slice(0,r+1))}),this.blacks.forEach(e=>{for(let r=1;r<=e.length-1;r+=2)t.push(e.slice(0,r+1))}),t}clear(){this.blacks=[],this.whites=[]}remove_path(t){W(()=>{if(t.length%2===0){let e=this.blacks;e=e.filter(r=>r.join("")!==t.join("")),this.blacks=e}else{let e=this.whites;e=e.filter(r=>r.join("")!==t.join("")),this.whites=e}})}add_path(t){W(()=>{if(t.length%2===0){let e=this.blacks;if(e.find(s=>s.join("").startsWith(t.join(""))))return;let r=e.findIndex(s=>t.join("").startsWith(s.join("")));r!==-1?e.splice(r,1,t):e.push(t),this.blacks=e}else{let e=this.whites;if(e.find(s=>s.join("").startsWith(t.join(""))))return;let r=e.findIndex(s=>t.join("").startsWith(s.join("")));r!==-1?e.splice(r,1,t):e.push(t),this.whites=e}})}}const j=class j{constructor(t,e){l(this,"_tree");l(this,"_cursor_path");l(this,"_hidden_paths");l(this,"_revealed_paths");l(this,"_failed_paths");l(this,"_solved_paths");l(this,"reveal_hidden_paths",()=>{v(()=>{this.hidden_paths.forEach(t=>{this._revealed_paths.add_path(t)}),this._hidden_paths.clear()})});l(this,"reveal_one_random",()=>{var r,s;if(!this.tree)return!1;const t=((s=(r=this.tree)==null?void 0:r._traverse_path(this.cursor_path))==null?void 0:s.children)??[this.tree.root],e=Q(t);return e?(v(()=>{this._hidden_paths.remove_path(e.data.path),e.children.forEach(i=>this._hidden_paths.add_path(i.data.path)),this.cursor_path=e.data.path}),!0):!1});l(this,"try_next_uci_fail",t=>{var i,u,o;if(!this.tree)return!1;const e=((i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))??this.tree.root,r=((o=(u=this.tree)==null?void 0:u._traverse_path(this.cursor_path))==null?void 0:o.children)??[this.tree.root],s=r.find(d=>d.data.uci===t)??r.find(d=>U(d.data)===t);if(s){if(this.failed_paths_expanded.find(f=>f.join("")===s.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return v(()=>{this._hidden_paths.remove_path(s.data.path),s.children.forEach(f=>this._hidden_paths.add_path(f.data.path)),this._solved_paths.add_path(s.data.path),this.cursor_path=s.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this._failed_paths.add_path([...e.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});l(this,"on_wheel",t=>{var r;let e=this.cursor_path;if(t<0)e.length>0&&this.try_set_cursor_path(e.slice(0,-1));else{let s=this.tree;if(s){let i;e.length===0?i=[s.root]:i=(r=s._traverse_path(e))==null?void 0:r.children;let u=i==null?void 0:i.map(o=>o.data.path).find(o=>{var d;return!((d=this.hidden_paths)!=null&&d.some(f=>o.join("").startsWith(f.join(""))))});u&&this.try_set_cursor_path(u)}}});this.initial_fen=t,this._cursor_path=w([],{equals:!1}),this._tree=w(e),this._hidden_paths=new p,this._revealed_paths=new p,this._failed_paths=new p,this._solved_paths=new p}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths.paths}get failed_paths(){return this._failed_paths.paths}get solved_paths(){return this._solved_paths}get failed_paths_expanded(){return this._failed_paths.expand_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let e=t.get_at(this.cursor_path);if(!e)return;let r=e.after_fen,s=e.uci;return[r,s]}}try_set_cursor_path(t){return this.hidden_paths.find(r=>t.join("").startsWith(r.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let e=this.tree,r=this.cursor_path;return e?e.append_uci(t,r):e=z.make(this.initial_fen,[t]),r=[...r,t],v(()=>{this.tree=e,this.cursor_path=r}),r}drop_failed_paths(){}};l(j,"make",(t,e=(t==null?void 0:t.root.data.before_fen)||P)=>new j(e,t));let T=j;const tt=a=>{let t;return y(()=>{let e=a.lala.cursor_path,r=t.parentElement;if(!r)return;const s=t.querySelector(".on_path_end");if(!s){r.scrollTop=e.length>0?99999:0;return}let i=s.offsetTop-r.offsetHeight/2+s.offsetHeight;r.scrollTo({behavior:"smooth",top:i})}),(()=>{var e=M();return C(r=>t=r,e),_(e,h(k,{get when(){return a.lala.tree},get fallback(){return[]},children:r=>h(x,{on_set_path:s=>a.lala.try_set_cursor_path(s),get cursor_path(){return a.lala.cursor_path},get hidden_paths(){return a.lala.hidden_paths},get revealed_paths(){return a.lala.revealed_paths},get solved_paths(){return a.lala.solved_paths_expanded},get failed_paths(){return a.lala.failed_paths_expanded},get lines(){return[r().root]}})})),e})()},x=a=>h(m,{get each(){return a.lines},children:t=>[h(S,c({get data(){return t.data}},a)),h(I,{get children(){return[h(b,{get when(){return t.children.length===1},get children(){return h(x,c(a,{get lines(){return t.children}}))}}),h(b,{get when(){return t.children.length>1},get children(){var e=R();return _(e,h(m,{get each(){return t.children},children:r=>(()=>{var s=q();return _(s,h(x,c(a,{lines:[r],show_index:!0}))),s})()})),e}})]}})]}),S=a=>{let t=`${Math.ceil(a.data.ply/2)}.`;a.data.ply%2===0&&(t+="..");let e=()=>a.cursor_path.join("").startsWith(a.data.path.join("")),r=()=>a.cursor_path.join("")===a.data.path.join(""),s=a.data.path.join(""),i=()=>a.hidden_paths.find(n=>n.join("")===s),u=()=>a.hidden_paths.find(n=>s.startsWith(n.join(""))),o=()=>a.revealed_paths.find(n=>n.join("")===s),d=()=>a.revealed_paths.find(n=>s.startsWith(n.join(""))),f=()=>a.failed_paths.find(n=>n.join("")===s),O=()=>a.solved_paths.find(n=>n.join("")===s),H=()=>["move",r()?"on_path_end":e()?"on_path":"",i()?"on_hidden_path_start":u()?"on_hidden_path":"",o()?"on_revealed_path_start":d()?"on_revealed_path":"",f()?"on_failed_path":"",O()?"on_solved_path":"",a.collapsed?"collapsed":""].join(" ");return(()=>{var n=G();return n.$$click=()=>a.on_set_path(a.data.path),_(n,h(k,{get when(){return a.show_index||a.data.ply&1},get children(){var E=B();return _(E,t),E}}),null),_(n,()=>a.data.san,null),A(()=>D(n,H())),n})()},et=a=>{let t;return y(()=>{let e=a.lala.cursor_path,r=t.parentElement;if(!r)return;const s=t.querySelector(".on_path_end");if(!s){r.scrollTop=e.length>0?99999:0;return}let i=s.offsetTop-r.offsetHeight/2+s.offsetHeight;r.scrollTo({behavior:"smooth",top:i})}),(()=>{var e=M();return C(r=>t=r,e),_(e,h(k,{get when(){return a.lala.tree},get fallback(){return[]},children:r=>h($,{on_set_path:s=>a.lala.try_set_cursor_path(s),get cursor_path(){return a.lala.cursor_path},get hidden_paths(){return a.lala.hidden_paths},get revealed_paths(){return a.lala.revealed_paths},get solved_paths(){return a.lala.solved_paths_expanded},get failed_paths(){return a.lala.failed_paths_expanded},get lines(){return[r().root]}})})),e})()},$=a=>h(m,{get each(){return a.lines},children:t=>[h(S,c({get data(){return t.data}},a)),h(I,{get children(){return[h(b,{get when(){return t.children.length===1},get children(){return h($,c(a,{get lines(){return t.children},show_index:!1}))}}),h(b,{get when(){return t.children.length>1},get children(){var e=R();return _(e,h(m,{get each(){return t.children},children:r=>(()=>{var s=q();return _(s,h(k,{get when(){return a.cursor_path.join("").startsWith(r.data.path.join(""))},get fallback(){return h(K,c(a,{lines:[r],show_index:!0}))},get children(){return h($,c(a,{lines:[r],show_index:!0}))}})),s})()})),e}})]}})]}),K=a=>h(m,{get each(){return a.lines},children:t=>[h(S,c({get data(){return t.data}},a,{collapsed:!0})),(()=>{var e=J(),r=e.firstChild,s=r.nextSibling;return s.nextSibling,_(e,()=>t.length,s),_(e,()=>t.nb_first_variations,null),e})()]});function Q(a){let t=a.length*(a.length+1)/2,e=Math.floor(Math.random()*t)+1,r=0;for(let s=0;s<a.length;s++)if(r+=a.length-s,e<=r)return a[s]}const U=a=>{let t=a.uci.slice(0,2),e=a.uci[3];if(a.san==="O-O")return t+"g"+e;if(a.san==="O-O-O")return t+"c"+e};F(["click"]);export{et as C,T,p as a,tt as b};
